{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/转生系统/schema.ts","src://tavern_helper_template/src/转生系统/脚本/变量结构.ts","src://tavern_helper_template/src/转生系统/脚本/更新角色卡.ts","src://tavern_helper_template/util/common.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { z } from 'zod';\n\nexport const Schema = z.object({\n  世界: z.object({\n    当前时间: z.string(),\n    当前地点: z.string(),\n  }),\n\n  主角: z.object({\n    姓名: z.string(),\n    性别: z.string(),\n    年龄: z.coerce\n      .number()\n      .or(z.templateLiteral([z.coerce.number(), z.literal('岁')]).transform(value => parseInt(value)))\n      .or(z.literal('待初始化')),\n    外貌: z.object({\n      描述: z.string(),\n      主角评价: z.string(),\n    }),\n    能力面板: z.record(\n      z.enum(['力量', '敏捷', '体质', '感知', '意志', '魅力']),\n      z.object({\n        数值: z.coerce.number().or(z.literal('待初始化')),\n        主角评价: z.string(),\n      }),\n    ),\n    装备栏: z.record(\n      z.enum(['主手', '副手', '防具', '饰品']),\n      z.object({\n        装备: z.string(),\n        主角评价: z.string(),\n      }),\n    ),\n    物品栏: z.record(\n      z.string(),\n      z.object({\n        描述: z.string(),\n        主角评价: z.string(),\n      }),\n    ),\n    持有能力: z.record(\n      z.string(),\n      z.object({\n        描述: z.string(),\n        主角评价: z.string(),\n      }),\n    ),\n    当前状态: z.record(\n      z.string(),\n      z.object({\n        类型: z.enum(['增益', '减益']),\n        持续时间: z.string(),\n        触发条件: z.string(),\n        描述: z.string(),\n        主角评价: z.string(),\n      }),\n    ),\n  }),\n\n  系统状态: z.object({\n    可用积分: z.coerce.number().or(z.literal('待初始化')),\n    对主角可见形象: z.string(),\n    玩家ID: z.string(),\n    玩家本轮操作日志: z.array(z.string()),\n  }),\n\n  商品列表: z.record(\n    z.string(),\n    z.object({\n      描述: z.string(),\n      主角评价: z.string(),\n      积分价格: z.coerce.number().or(z.literal('待初始化')),\n    }),\n  ),\n\n  任务列表: z.record(\n    z.string(),\n    z.object({\n      类型: z.enum(['主线', '支线', '每日', '临危受命']),\n      说明: z.string(),\n      目标: z.string(),\n      奖励: z.string(),\n      惩罚: z.string(),\n    }),\n  ),\n});\nexport type Schema = z.output<typeof Schema>;\nexport const TASK_TYPES = ['主线', '支线', '每日', '临危受命'] as const;\n","import { registerMvuSchema } from 'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js';\nimport { Schema } from '../schema';\n\n$(() => {\n  registerMvuSchema(Schema);\n});\n","import { checkAndUpdateCharacter } from '@util/common';\n\n$(async () => {\n  await checkAndUpdateCharacter(\n    '作为异世界的系统',\n    await fetch('https://testingcf.jsdelivr.net/gh/lolo-desu/lolocard/src/转生系统/index.yaml')\n      .then(response => response.text())\n      .then(text => _.get(YAML.parse(text), '版本', '0.0.0'))\n      .catch(() => '0.0.0'),\n    'https://testingcf.jsdelivr.net/gh/lolo-desu/lolocard/src/转生系统/作为异世界的系统.png',\n  );\n});\n","import { compare } from 'compare-versions';\nimport JSON5 from 'json5';\nimport { jsonrepair } from 'jsonrepair';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string, replace_macros?: boolean): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  const makeRegex = (pattern: string, flags: string) => {\n    if (replace_macros) {\n      pattern = substitudeMacros(pattern);\n    }\n    return new RegExp(pattern, flags);\n  };\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return makeRegex(_.escapeRegExp(input), 'i');\n    }\n    if (match[2] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return makeRegex(input, 'i');\n    }\n    let flags = match[2] ?? '';\n    _.pull(flags, 'g');\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return makeRegex(match[1], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n\nexport function literalYamlify(value: any) {\n  return YAML.stringify(value, { blockQuote: 'literal' });\n}\n\nexport function parseString(content: string): any {\n  let parsed: unknown;\n  try {\n    parsed = YAML.parseDocument(content, { merge: true }).toJS();\n  } catch (yaml_error) {\n    try {\n      // eslint-disable-next-line import-x/no-named-as-default-member\n      parsed = JSON5.parse(content);\n    } catch (json5_error) {\n      try {\n        parsed = JSON.parse(jsonrepair(content));\n      } catch (json_error) {\n        const toError = (error: unknown) => (error instanceof Error ? error.message : String(error));\n        throw new Error(\n          literalYamlify({\n            ['要解析的字符串不是有效的 YAML/JSON 格式']: {\n              字符串内容: content,\n              YAML错误信息: toError(yaml_error),\n              JSON5错误信息: toError(json5_error),\n              尝试修复JSON时的错误信息: toError(json_error),\n            },\n          }),\n        );\n      }\n    }\n  }\n  return parsed;\n}\n\nexport async function checkAndUpdateCharacter(name: string, latest_version: string, png_url: string): Promise<void> {\n  const current_version = (await getCharacter(name)).version.trim() || '0.0.0';\n  if (compare(current_version, latest_version, '>=')) {\n    return;\n  }\n  await importRawCharacter(name, await fetch(png_url).then(response => response.blob()));\n  replaceCharacter(name, { version: latest_version });\n  toastr.success(\n    `角色卡已自动更新到 '${latest_version.startsWith('v') ? latest_version : `v${latest_version}`}'`,\n    name,\n  );\n}\n"],"names":["z","Schema","object","string","coerce","number","or","templateLiteral","literal","transform","value","parseInt","record","enum","array","$","async","name","latest_version","png_url","current_version","getCharacter","version","trim","importRawCharacter","fetch","then","response","blob","replaceCharacter","toastr","success","startsWith","checkAndUpdateCharacter","text","_","get","YAML","parse","catch"],"ignoreList":[],"sourceRoot":""}