<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/><meta name="theme-color" content="#2a2a2a"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/><title>修道院箱庭 - 百合恋爱文字冒险</title><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/><link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/><script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script><style>:root{--color-primary: #8a6d3b;--color-secondary: #a85832;--color-tertiary: #5d6e41;--color-bg-dark: #2a2a2a;--color-bg-light: #333333;--color-bg-lighter: #3c3c3c;--color-text-primary: #d1d1d1;--color-text-secondary: #888888;--color-text-whisper: #a8c5e9;--color-text-shocked: #e9a8a8;--color-text-special: #d6c8a4;--color-memory-primary: #c99e51;--color-memory-secondary: #9c7f46;--color-memory-highlight: #e4c987;--color-memory-bg: #2e2a25;--color-save-primary: #9e8148;--color-save-secondary: #b29656;--color-save-highlight: #d5b978;--color-save-bg: #2d2a24;--color-save-delete: #a85832;--font-heading: "Cinzel", serif;--font-body: "Lato", sans-serif;--header-height: 60px;--tab-height: 40px;--dialogue-height: 200px;--border-radius: 6px;--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 16px;--spacing-lg: 24px;--spacing-xl: 32px;--transition-fast: 0.2s;--transition-normal: 0.3s;--transition-slow: 0.5s;--z-background: 1;--z-characters: 2;--z-dialogue: 3;--z-choices: 4;--z-header: 5;--z-sidebar: 10;--z-modal: 20;--font-size-base: 1rem;--font-size-small: 0.9rem;--font-size-large: 1.1rem}*{margin:0;padding:0;box-sizing:border-box}html{height:100%}button{cursor:pointer;font-family:inherit;background:none;border:none;color:inherit}button:focus{outline:none}ul{list-style:none}.hidden{display:none !important}.game-container{position:relative;width:100%;display:flex;flex-direction:column;overflow:hidden;background-color:var(--color-bg-dark);z-index:1}.game-header{height:var(--header-height);min-height:var(--header-height);background-color:rgba(20,20,20,.9);border-bottom:1px solid var(--color-primary);display:flex;justify-content:space-between;align-items:center;padding:0 var(--spacing-md);z-index:var(--z-header)}.header-left,.header-right{display:flex;align-items:center;gap:var(--spacing-md)}.game-title{font-family:var(--font-heading);font-size:1.5rem;color:var(--color-primary);margin-left:var(--spacing-md)}.game-date{font-family:var(--font-heading);font-size:.9rem;color:var(--color-text-secondary)}.game-controls{display:flex;align-items:center;gap:var(--spacing-sm)}.icon-button{background:none;border:none;font-size:1.5rem;color:var(--color-text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;transition:background-color var(--transition-fast),color var(--transition-fast)}.icon-button:hover{background-color:hsla(0,0%,100%,.1)}.icon-button.small{font-size:1rem;width:28px;height:28px}.icon-button.gold{color:var(--color-primary)}.icon-button.gold:hover{background-color:rgba(138,109,59,.2)}.content-wrapper{display:flex;flex-direction:column;position:relative;flex:1;overflow:hidden}.tab-navigation{display:flex;height:var(--tab-height);min-height:var(--tab-height);background-color:rgba(20,20,20,.9);border-bottom:1px solid var(--color-primary)}.tab-button{padding:0 var(--spacing-lg);height:100%;display:flex;align-items:center;gap:var(--spacing-sm);color:var(--color-text-secondary);font-family:var(--font-heading);border-bottom:3px solid rgba(0,0,0,0);transition:all var(--transition-fast)}.tab-button i{font-size:1rem}.tab-button:hover{color:var(--color-text-primary);background-color:hsla(0,0%,100%,.05)}.tab-button.active{color:var(--color-primary);border-bottom-color:var(--color-primary)}.tab-content{position:relative;aspect-ratio:16/9;overflow:hidden}.tab-pane{position:absolute;top:0;left:0;width:100%;height:100%;display:none;overflow:hidden;z-index:1}.tab-pane.active{display:flex;flex-direction:column;z-index:2}#story-tab{position:relative;overflow:hidden;display:flex;flex-direction:column}.background-container{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;z-index:var(--z-background);transition:opacity var(--transition-slow)}.characters-container{position:absolute;bottom:0;left:0;width:100%;height:100%;z-index:var(--z-characters);display:flex;justify-content:space-between}.character-left,.character-right{height:100%;width:40%;background-size:contain;background-position:bottom;background-repeat:no-repeat;transition:transform var(--transition-normal),opacity var(--transition-normal)}.character-left{transform-origin:bottom left}.character-right{transform-origin:bottom right}.dialogue-container{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:900px;height:var(--dialogue-height);background-color:rgba(20,20,20,.85);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid var(--color-primary);border-radius:var(--border-radius);z-index:var(--z-dialogue);display:flex;flex-direction:column;box-shadow:0 5px 15px rgba(0,0,0,.3);cursor:pointer}.dialogue-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-sm) var(--spacing-md);border-bottom:1px solid rgba(138,109,59,.3);background-color:rgba(0,0,0,.2)}.speaker-name{font-family:var(--font-heading);font-size:1.125rem;color:var(--color-primary);text-shadow:0 1px 2px rgba(0,0,0,.5)}.dialogue-controls{display:flex;gap:var(--spacing-sm)}.dialogue-content{flex:1;padding:var(--spacing-md);overflow-y:auto;font-size:1rem;line-height:1.6}.dialogue-text{margin-bottom:var(--spacing-md)}.dialogue-text.style-normal{color:var(--color-text-primary)}.dialogue-text.style-whisper{color:var(--color-text-whisper);font-style:italic}.dialogue-text.style-shocked{color:var(--color-text-shocked)}.dialogue-text.style-special{color:var(--color-text-special);font-weight:500}.choices-container{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:70%;max-width:650px;background-color:rgba(20,20,20,.85);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid var(--color-primary);border-radius:var(--border-radius);z-index:var(--z-choices);padding:var(--spacing-sm);display:flex;flex-direction:column;gap:var(--spacing-sm);box-shadow:0 5px 15px rgba(0,0,0,.5)}.choices-container.compact-choices{width:60%;max-width:500px;padding:var(--spacing-xs)}.choices-header{padding-bottom:var(--spacing-xs);margin-bottom:var(--spacing-xs);border-bottom:1px solid rgba(138,109,59,.3);display:flex;justify-content:space-between;align-items:center}.choices-header h3{font-family:var(--font-heading);font-size:1rem;color:var(--color-primary);margin:0;text-align:left}.compact-choices .choices-header{margin-bottom:0;padding-bottom:var(--spacing-xs)}.compact-choices .choices-header h3{font-size:.9rem}.preset-choices{display:flex;flex-direction:column;gap:0}.choice-button{background-color:rgba(0,0,0,0);border:none;border-radius:0;padding:var(--spacing-sm) var(--spacing-md);text-align:left;color:var(--color-text-primary);font-size:.95rem;transition:background-color var(--transition-fast),color var(--transition-fast);position:relative;overflow:hidden}.choice-button::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);height:0;width:3px;background-color:var(--color-primary);transition:height var(--transition-fast)}.choice-button:hover{background-color:hsla(0,0%,100%,.05);color:var(--color-primary)}.choice-button:hover::before{height:70%}.compact-choices .choice-button{padding:var(--spacing-xs) var(--spacing-md)}.custom-choice{display:flex;gap:var(--spacing-xs);margin-top:var(--spacing-xs);align-items:center;height:32px;border-top:1px solid rgba(138,109,59,.2);padding-top:var(--spacing-xs)}.custom-choice input{flex:1;background-color:hsla(0,0%,100%,.03);border:none;border-bottom:1px solid rgba(138,109,59,.3);border-radius:0;padding:4px var(--spacing-sm);color:var(--color-text-primary);font-size:.95rem;height:100%;box-sizing:border-box;transition:all var(--transition-fast);position:relative}.custom-choice input:focus{outline:none;border-bottom-color:var(--color-primary);background-color:hsla(0,0%,100%,.05);color:var(--color-primary)}.custom-choice input::placeholder{color:var(--color-text-secondary);opacity:.7}.compact-choices .custom-choice input{padding:2px var(--spacing-sm)}.custom-choice button{background-color:rgba(0,0,0,0);color:var(--color-text-secondary);padding:0 var(--spacing-md);border:none;border-radius:0;border-bottom:1px solid rgba(138,109,59,.3);transition:all var(--transition-fast);font-size:.95rem;height:100%;white-space:nowrap;position:relative}.custom-choice button::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);height:0;width:2px;background-color:var(--color-primary);transition:height var(--transition-fast)}.custom-choice button:hover{background-color:hsla(0,0%,100%,.05);color:var(--color-primary);border-bottom-color:var(--color-primary)}.custom-choice button:hover::before{height:70%}.compact-choices .custom-choice button{padding:0 var(--spacing-sm)}.choices-header .icon-button.small{width:24px;height:24px;border-radius:50%;display:flex;justify-content:center;align-items:center;color:var(--color-text-secondary);transition:background-color var(--transition-fast),color var(--transition-fast)}.choices-header .icon-button.small:hover{background-color:hsla(0,0%,100%,.1);color:var(--color-text-primary)}.journal-container{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--color-bg-light)}.journal-nav{display:flex;gap:var(--spacing-md);padding:var(--spacing-md);background-color:rgba(20,20,20,.8);border-bottom:1px solid var(--color-tertiary)}.journal-nav-item{padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius);color:var(--color-text-secondary);transition:all var(--transition-fast);display:flex;align-items:center;gap:var(--spacing-sm)}.journal-nav-item i{font-size:1rem}.journal-nav-item:hover{color:var(--color-text-primary);background-color:hsla(0,0%,100%,.05)}.journal-nav-item.active{color:var(--color-tertiary);background-color:rgba(93,110,65,.2)}.journal-content{flex:1;padding:var(--spacing-md);overflow-y:auto}.journal-section{display:none;height:100%}.journal-section.active{display:flex}#characters-section{display:flex;gap:var(--spacing-lg)}.character-cards{width:30%;display:flex;flex-direction:column;gap:var(--spacing-md);overflow-y:auto}.character-card{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-md);background-color:var(--color-bg-lighter);border-radius:var(--border-radius);cursor:pointer;transition:all var(--transition-fast)}.character-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.2)}.character-card.active{border-left:3px solid var(--color-tertiary)}.character-avatar{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--color-tertiary)}.character-info{flex:1}.character-name{font-size:1.1rem;font-weight:bold;margin-bottom:var(--spacing-xs)}.character-role{font-size:.9rem;color:var(--color-text-secondary)}.character-details{flex:1;padding:var(--spacing-lg);background-color:var(--color-bg-lighter);border-radius:var(--border-radius);display:flex;flex-direction:column;gap:var(--spacing-lg)}.monastery-info{padding:var(--spacing-lg);background-color:var(--color-bg-lighter);border-radius:var(--border-radius)}#knowledge-section{display:flex;gap:var(--spacing-lg)}.knowledge-categories{width:30%;display:flex;flex-direction:column;gap:var(--spacing-sm);overflow-y:auto}.knowledge-category{padding:var(--spacing-md);background-color:var(--color-bg-lighter);border-radius:var(--border-radius);cursor:pointer;transition:all var(--transition-fast)}.knowledge-category:hover{background-color:rgba(93,110,65,.2)}.knowledge-category.active{background-color:rgba(93,110,65,.3);border-left:3px solid var(--color-tertiary)}.knowledge-entries{flex:1;display:flex;flex-direction:column;gap:var(--spacing-md);overflow-y:auto}.knowledge-entry{padding:var(--spacing-lg);background-color:var(--color-bg-lighter);border-radius:var(--border-radius)}.knowledge-title{font-size:1.2rem;font-family:var(--font-heading);color:var(--color-tertiary);margin-bottom:var(--spacing-md);border-bottom:1px solid rgba(93,110,65,.3);padding-bottom:var(--spacing-sm)}.knowledge-content{line-height:1.6}.memory-container{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--color-memory-bg)}.memory-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-md);border-bottom:1px solid var(--color-memory-secondary);background-color:rgba(0,0,0,.2)}.memory-header h2{color:var(--color-memory-primary);font-family:var(--font-heading);display:flex;align-items:center;gap:var(--spacing-sm)}.memory-button{background-color:var(--color-memory-secondary);color:#fff;padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius);display:flex;align-items:center;gap:var(--spacing-sm);transition:background-color var(--transition-fast)}.memory-button:hover{background-color:var(--color-memory-primary)}.memory-button:disabled{cursor:not-allowed}.memory-timeline-container{padding:var(--spacing-md);background-color:rgba(0,0,0,.15);border-bottom:1px solid rgba(158,129,72,.3)}.memory-timeline{position:relative;display:flex;align-items:center;justify-content:center;padding:var(--spacing-sm) 0;overflow-x:auto;scrollbar-width:thin;scrollbar-color:var(--color-memory-secondary) rgba(0,0,0,.2);gap:var(--spacing-md);height:60px}.memory-timeline::-webkit-scrollbar{height:4px}.memory-timeline::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}.memory-timeline::-webkit-scrollbar-thumb{background-color:var(--color-memory-secondary);border-radius:2px}.memory-timeline::before{content:"";position:absolute;top:50%;left:0;right:0;height:2px;background-color:var(--color-memory-secondary);z-index:1}.memory-node-simple{position:relative;width:24px;height:24px;border-radius:50%;background-color:var(--color-memory-secondary);z-index:2;cursor:pointer;box-shadow:0 0 0 0 rgba(201,158,81,0);transition:all .3s ease-in-out}.memory-node-simple::before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:2px;height:16px;background-color:var(--color-memory-secondary);z-index:1}.memory-node-simple:hover{background-color:var(--color-memory-primary);transform:scale(1.2);box-shadow:0 0 10px 2px rgba(201,158,81,.3)}.memory-node-simple.selected{background-color:var(--color-memory-highlight);transform:scale(1.3);box-shadow:0 0 15px 5px rgba(201,158,81,.5);animation:memory-pulse 2s infinite}@keyframes memory-pulse{0%{box-shadow:0 0 0 0 rgba(201,158,81,.7)}70%{box-shadow:0 0 0 10px rgba(201,158,81,0)}100%{box-shadow:0 0 0 0 rgba(201,158,81,0)}}.memory-node{display:none}.memory-detail-container{flex:1;display:flex;flex-direction:column;padding:var(--spacing-md);gap:var(--spacing-md);overflow-y:auto}.memory-content{flex:1;padding:var(--spacing-lg);background-color:rgba(0,0,0,.2);border:1px solid var(--color-memory-secondary);border-radius:var(--border-radius);line-height:1.6;overflow-y:auto}.memory-content-image{width:100%;height:200px;background-size:cover;background-position:center;border-radius:var(--border-radius);margin-bottom:var(--spacing-md)}.memory-content-text{color:var(--color-text-primary)}.memory-actions{display:flex;justify-content:center;gap:var(--spacing-md)}.memory-travel-button{background-color:var(--color-memory-primary);color:#000;padding:var(--spacing-md) var(--spacing-xl);border-radius:var(--border-radius);font-family:var(--font-heading);font-weight:bold;display:flex;align-items:center;gap:var(--spacing-md);transition:all var(--transition-fast)}.memory-travel-button i{font-size:1.25rem}.memory-travel-button:hover{background-color:var(--color-memory-highlight);transform:translateY(-2px);box-shadow:0 4px 12px rgba(201,158,81,.3)}.memory-travel-button:disabled{opacity:.5;background-color:var(--color-memory-secondary);transform:none;box-shadow:none;cursor:not-allowed}.memory-empty-message{text-align:center;color:var(--color-text-secondary);font-style:italic;margin-top:var(--spacing-xl)}.memory-empty-timeline{padding:var(--spacing-md);text-align:center;color:var(--color-text-secondary);font-style:italic;width:100%}.loading-indicator{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:var(--z-modal);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:var(--spacing-lg)}.loading-spinner{width:50px;height:50px;border:4px solid rgba(138,109,59,.3);border-radius:50%;border-top-color:var(--color-primary);animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{color:var(--color-text-primary);font-size:1.125rem}.confirm-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;display:flex;justify-content:center;align-items:center;pointer-events:none}.modal-backdrop{display:none}.confirm-dialog{position:relative;background-color:var(--color-bg-light);border:1px solid var(--color-primary);border-radius:var(--border-radius);padding:var(--spacing-lg);width:400px;max-width:90%;z-index:2;box-shadow:0 8px 24px rgba(0,0,0,.7);pointer-events:auto;animation:dialogPop .2s ease-out forwards}@keyframes dialogPop{0%{opacity:0;transform:scale(0.9)}100%{opacity:1;transform:scale(1)}}.confirm-message{margin-bottom:var(--spacing-lg);text-align:center;font-size:1.1rem;line-height:1.5;color:#fff}.confirm-buttons{display:flex;justify-content:center;gap:var(--spacing-md);margin-top:var(--spacing-lg)}.confirm-button{padding:10px 20px;border-radius:var(--border-radius);min-width:100px;font-weight:bold;font-size:1rem;transition:all var(--transition-fast);border:1px solid rgba(0,0,0,0);cursor:pointer;margin:0 10px;pointer-events:auto !important}.confirm-button:active{transform:scale(0.95)}.confirm-yes{background-color:var(--color-primary);color:#fff;border:1px solid var(--color-memory-highlight)}.confirm-yes:hover{background-color:var(--color-memory-highlight);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.3)}.confirm-no{background-color:rgba(80,80,80,.5);color:var(--color-text-primary);border:1px solid hsla(0,0%,100%,.1)}.confirm-no:hover{background-color:rgba(100,100,100,.7);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.3)}#notification-container{position:fixed;top:var(--spacing-md);right:var(--spacing-md);z-index:var(--z-modal);display:flex;flex-direction:column;gap:var(--spacing-sm);max-width:300px}.notification{padding:var(--spacing-md);border-radius:var(--border-radius);background-color:var(--color-bg-light);box-shadow:0 4px 8px rgba(0,0,0,.3);opacity:0;transform:translateX(20px);transition:all var(--transition-normal)}.notification-show{opacity:1;transform:translateX(0)}.notification-hide{opacity:0;transform:translateX(20px)}.notification-info{border-left:4px solid #3498db}.notification-success{border-left:4px solid #2ecc71}.notification-warning{border-left:4px solid #f39c12}.notification-error{border-left:4px solid #e74c3c}@media(max-width: 768px){html:not(.mobile-ui):not(.desktop-ui) :root{--header-height: 50px}html:not(.mobile-ui):not(.desktop-ui) .game-container{display:flex;flex-direction:column;height:auto;overflow-y:hidden}html:not(.mobile-ui):not(.desktop-ui) .game-header{height:auto;min-height:auto;padding:var(--spacing-sm);flex-shrink:0;z-index:10}html:not(.mobile-ui):not(.desktop-ui) .header-left,html:not(.mobile-ui):not(.desktop-ui) .header-right{gap:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .game-title{font-size:1.2rem;margin-left:0}html:not(.mobile-ui):not(.desktop-ui) .game-date{font-size:.8rem}html:not(.mobile-ui):not(.desktop-ui) .icon-button{width:32px;height:32px;font-size:1.2rem}html:not(.mobile-ui):not(.desktop-ui) .content-wrapper{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) .tab-navigation{height:36px;min-height:36px;flex-shrink:0;z-index:9}html:not(.mobile-ui):not(.desktop-ui) .tab-button{padding:0 var(--spacing-sm);font-size:.9rem}html:not(.mobile-ui):not(.desktop-ui) .tab-button i{font-size:.9rem}html:not(.mobile-ui):not(.desktop-ui) .tab-content{flex:1;position:relative;display:flex;flex-direction:column;overflow:hidden}html:not(.mobile-ui):not(.desktop-ui) .tab-pane.active{position:relative;height:100%;display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) #story-tab{display:flex;flex-direction:column;position:relative;height:100%}html:not(.mobile-ui):not(.desktop-ui) .background-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:1}html:not(.mobile-ui):not(.desktop-ui) .characters-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:2}html:not(.mobile-ui):not(.desktop-ui) .dialogue-container{position:fixed;top:calc(var(--header-height) + 36px + 56.25vw);left:0;right:0;width:100%;height:calc(100vh - (var(--header-height) + 36px + 56.25vw));bottom:0;max-width:none;max-height:none;transform:none;border-radius:0;border-left:none;border-right:none;border-bottom:none;border-top:1px solid var(--color-primary);z-index:3;background-color:rgba(20,20,20,.95);box-shadow:none;cursor:default}html:not(.mobile-ui):not(.desktop-ui) .dialogue-header{padding:var(--spacing-xs) var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content{padding:var(--spacing-sm);height:calc(100% - 35px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--color-primary) rgba(20,20,20,.3)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content::-webkit-scrollbar{width:4px}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content::-webkit-scrollbar-track{background:rgba(20,20,20,.3)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content::-webkit-scrollbar-thumb{background-color:var(--color-primary);border-radius:2px}html:not(.mobile-ui):not(.desktop-ui) .speaker-name{font-size:1rem}html:not(.mobile-ui):not(.desktop-ui) .choices-container{width:90%;max-width:90%;padding:var(--spacing-xs);z-index:4}html:not(.mobile-ui):not(.desktop-ui) .character-left,html:not(.mobile-ui):not(.desktop-ui) .character-right{height:100%;transform-origin:center bottom}html:not(.mobile-ui):not(.desktop-ui) #journal-tab,html:not(.mobile-ui):not(.desktop-ui) #memory-tab{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:calc(100vh - (var(--header-height) + 36px));bottom:0;z-index:3}html:not(.mobile-ui):not(.desktop-ui) .journal-container,html:not(.mobile-ui):not(.desktop-ui) .memory-container{padding:0;height:100%;width:100%;overflow-y:auto;display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) .memory-container{background-color:var(--color-memory-bg)}html:not(.mobile-ui):not(.desktop-ui) .memory-header{padding:var(--spacing-sm);border-bottom:1px solid var(--color-memory-secondary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html:not(.mobile-ui):not(.desktop-ui) .memory-header h2{font-size:1.2rem;margin-bottom:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .memory-button{background-color:var(--color-memory-primary);padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--border-radius);font-size:.9rem;display:flex;align-items:center;justify-content:center;width:100%}html:not(.mobile-ui):not(.desktop-ui) .memory-timeline-container{padding:var(--spacing-sm);border-bottom:1px solid rgba(158,129,72,.3);background-color:rgba(0,0,0,.15)}html:not(.mobile-ui):not(.desktop-ui) .memory-timeline{padding:var(--spacing-sm) 0;height:50px;gap:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .memory-node-simple{width:20px;height:20px}html:not(.mobile-ui):not(.desktop-ui) .memory-node-simple::before{height:12px}html:not(.mobile-ui):not(.desktop-ui) .memory-node-simple.selected{transform:scale(1.25);box-shadow:0 0 10px 3px rgba(201,158,81,.5)}html:not(.mobile-ui):not(.desktop-ui) .memory-node{display:none}html:not(.mobile-ui):not(.desktop-ui) .memory-node-content,html:not(.mobile-ui):not(.desktop-ui) .memory-timestamp{display:none}html:not(.mobile-ui):not(.desktop-ui) .memory-detail-container{flex:1;padding:var(--spacing-sm);display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) .memory-content{flex:1;padding:var(--spacing-md);background-color:rgba(0,0,0,.2);border:1px solid var(--color-memory-secondary);overflow-y:auto;font-size:.95rem;line-height:1.5}html:not(.mobile-ui):not(.desktop-ui) .memory-actions{padding:var(--spacing-sm) 0}html:not(.mobile-ui):not(.desktop-ui) .memory-travel-button{width:100%;justify-content:center;padding:var(--spacing-sm);background-color:var(--color-memory-primary);font-size:1rem}html:not(.mobile-ui):not(.desktop-ui) .memory-empty-timeline{padding:var(--spacing-md);font-size:.9rem}html:not(.mobile-ui):not(.desktop-ui) .journal-container{background-color:var(--color-bg-light)}html:not(.mobile-ui):not(.desktop-ui) .journal-nav{flex-wrap:wrap;padding:var(--spacing-sm);border-bottom:1px solid var(--color-tertiary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html:not(.mobile-ui):not(.desktop-ui) .journal-nav-item{font-size:.9rem;padding:var(--spacing-xs) var(--spacing-sm);margin-right:var(--spacing-xs);margin-bottom:var(--spacing-xs);border-radius:var(--border-radius)}html:not(.mobile-ui):not(.desktop-ui) .journal-content{flex:1;padding:var(--spacing-sm);overflow-y:auto}html:not(.mobile-ui):not(.desktop-ui) .journal-section{background-color:var(--color-bg-lighter);border-radius:var(--border-radius);padding:var(--spacing-sm);margin-bottom:var(--spacing-sm)}}@media(max-width: 768px)and (orientation: portrait){html:not(.mobile-ui):not(.desktop-ui) .game-header{--header-height: 50px}html:not(.mobile-ui):not(.desktop-ui) .character-left,html:not(.mobile-ui):not(.desktop-ui) .character-right{transform:scale(0.9)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-container{-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}}@media(max-width: 768px)and (orientation: landscape){html:not(.mobile-ui):not(.desktop-ui) .game-header{--header-height: 40px}html:not(.mobile-ui):not(.desktop-ui) .background-container,html:not(.mobile-ui):not(.desktop-ui) .characters-container{height:40vh;top:calc(var(--header-height) + 36px)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-container{top:calc(var(--header-height) + 36px + 40vh);height:calc(100vh - (var(--header-height) + 36px + 40vh));min-height:0}html:not(.mobile-ui):not(.desktop-ui) #journal-tab,html:not(.mobile-ui):not(.desktop-ui) #memory-tab{top:calc(var(--header-height) + 36px);height:calc(100vh - (var(--header-height) + 36px))}html:not(.mobile-ui):not(.desktop-ui) .memory-detail-container,html:not(.mobile-ui):not(.desktop-ui) .journal-content{padding:var(--spacing-xs)}html:not(.mobile-ui):not(.desktop-ui) .memory-content,html:not(.mobile-ui):not(.desktop-ui) .journal-section{padding:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .memory-header h2,html:not(.mobile-ui):not(.desktop-ui) .journal-nav-item{font-size:.85rem}}.modal{z-index:9999}.modal-dialog:not(.monastery-dialog){max-width:90%;width:800px}.modal-content:not(.monastery-dialog .modal-content){background-color:var(--color-bg-light);color:var(--color-text-primary);border:1px solid var(--color-primary);border-radius:var(--border-radius);box-shadow:0 5px 15px rgba(0,0,0,.5)}.modal-header:not(.monastery-dialog .modal-header),.modal-footer:not(.monastery-dialog .modal-footer){border-color:rgba(138,109,59,.3);padding:var(--spacing-sm) var(--spacing-md)}.modal-header .close{color:var(--color-text-primary);opacity:.7;transition:opacity var(--transition-fast)}.modal-header .close:hover{opacity:1}.btn-secondary:not(.monastery-btn){background-color:var(--color-bg-lighter);border-color:var(--color-bg-lighter);color:var(--color-text-primary);transition:all var(--transition-fast)}.btn-secondary:not(.monastery-btn):hover{background-color:var(--color-bg-light);border-color:var(--color-primary)}.modal-backdrop{z-index:9998}.modal-open{overflow:hidden;padding-right:0 !important}.modal.fade .modal-dialog{transform:translate(0, -50px);transition:transform var(--transition-normal) ease}.modal.show .modal-dialog{transform:none}#load-game-modal .modal-dialog{max-width:700px}#load-game-modal .modal-content{background-color:var(--color-save-bg);border:1px solid var(--color-save-primary);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px)}#load-game-modal .modal-header{background-color:rgba(0,0,0,.2);border-bottom:1px solid var(--color-save-primary)}#load-game-modal .modal-header .modal-title{color:var(--color-save-highlight);font-family:var(--font-heading);font-size:1.3rem}#load-game-modal .modal-header .close{color:var(--color-save-highlight);text-shadow:none;opacity:.7}#load-game-modal .modal-header .close:hover{opacity:1}#load-game-modal .modal-body{padding:var(--spacing-md);max-height:70vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--color-save-primary) rgba(0,0,0,.2)}#load-game-modal .modal-body::-webkit-scrollbar{width:8px}#load-game-modal .modal-body::-webkit-scrollbar-track{background:rgba(0,0,0,.2);border-radius:var(--border-radius)}#load-game-modal .modal-body::-webkit-scrollbar-thumb{background:var(--color-save-primary);border-radius:var(--border-radius)}#load-game-modal .modal-body::-webkit-scrollbar-thumb:hover{background:var(--color-save-highlight)}#load-game-modal .modal-footer{background-color:rgba(0,0,0,.2);border-top:1px solid var(--color-save-primary)}.save-tabs{display:flex;margin-bottom:var(--spacing-md);background-color:rgba(0,0,0,.15);border-radius:var(--border-radius);padding:0;overflow:hidden}.save-tab-btn{flex:1;padding:var(--spacing-sm) 0;background:none;border:none;color:var(--color-text-secondary);cursor:pointer;font-family:var(--font-heading);font-size:1rem;transition:all var(--transition-fast);position:relative}.save-tab-btn::after{content:"";position:absolute;bottom:0;left:0;width:100%;height:3px;background-color:rgba(0,0,0,0);transition:background-color var(--transition-fast)}.save-tab-btn:hover{color:var(--color-text-primary)}.save-tab-btn.active{color:var(--color-save-highlight);background-color:rgba(158,129,72,.1)}.save-tab-btn.active::after{background-color:var(--color-save-primary)}.save-tab-content{position:relative}.save-tab-pane{display:none;animation:fadeIn .3s ease}.save-tab-pane.active{display:block}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.save-list{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:var(--spacing-md)}.save-item{background-color:hsla(0,0%,100%,.05);border:1px solid rgba(158,129,72,.3);border-radius:var(--border-radius);overflow:hidden;transition:border-color var(--transition-fast),box-shadow var(--transition-fast);position:relative;cursor:pointer}.save-item:hover{border-color:var(--color-save-highlight);box-shadow:0 3px 10px rgba(0,0,0,.2)}.save-item.empty{grid-column:1/-1;padding:var(--spacing-lg);text-align:center;color:var(--color-text-secondary);cursor:default}.save-item.empty:hover{box-shadow:none;border-color:rgba(158,129,72,.3)}.save-item-thumbnail{height:120px;background-size:cover;background-position:center;border-bottom:1px solid rgba(158,129,72,.2);position:relative;transition:filter var(--transition-fast)}.save-item-thumbnail::after{content:"";position:absolute;bottom:0;left:0;right:0;height:40px;background:linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent)}.save-item:hover .save-item-thumbnail{filter:brightness(1.1)}.save-item-header{padding:var(--spacing-sm) var(--spacing-md);display:flex;justify-content:space-between;align-items:center;background-color:rgba(0,0,0,.2);border-bottom:1px solid rgba(158,129,72,.2);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px)}.save-item-title{font-weight:bold;font-family:var(--font-heading);font-size:1rem;color:var(--color-save-highlight);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%;transition:color var(--transition-fast)}.save-item:hover .save-item-title{color:var(--color-save-highlight)}.save-item-date{font-size:.8rem;color:var(--color-text-secondary)}.save-item-content{padding:var(--spacing-sm) var(--spacing-md);font-size:.9rem;color:var(--color-text-primary);max-height:60px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}.save-item-actions{padding:var(--spacing-xs) var(--spacing-md);display:flex;justify-content:flex-end;background-color:rgba(0,0,0,.2);border-top:1px solid rgba(158,129,72,.2);opacity:0;transition:opacity var(--transition-fast)}.save-item-actions button{background-color:rgba(0,0,0,0);color:var(--color-text-secondary);border:1px solid rgba(158,129,72,.3);border-radius:4px;padding:var(--spacing-xs) var(--spacing-sm);font-size:.8rem;transition:all var(--transition-fast)}.save-item-actions button:hover{background-color:var(--color-save-delete);color:#fff;border-color:var(--color-save-delete)}.save-item:hover .save-item-actions{opacity:1}#btn-create-manual-save{background-color:var(--color-save-primary);color:#fff;border:none;font-family:var(--font-heading);padding:var(--spacing-sm) var(--spacing-lg);border-radius:var(--border-radius);transition:background-color var(--transition-fast),box-shadow var(--transition-fast);display:flex;align-items:center}#btn-create-manual-save i{margin-right:var(--spacing-sm)}#btn-create-manual-save:hover{background-color:var(--color-save-highlight);color:#000;box-shadow:0 2px 5px rgba(0,0,0,.2)}#load-game-modal .btn-secondary{background-color:hsla(0,0%,100%,.1);border:1px solid rgba(158,129,72,.3);color:var(--color-text-primary)}#load-game-modal .btn-secondary:hover{background-color:hsla(0,0%,100%,.15);border-color:var(--color-save-secondary)}.input-dialog-container input{background-color:hsla(0,0%,100%,.1);border:1px solid var(--color-save-secondary);color:var(--color-text-primary);border-radius:var(--border-radius);padding:var(--spacing-sm);width:100%;margin-bottom:var(--spacing-md)}.input-dialog-container input:focus{outline:none;border-color:var(--color-save-highlight);box-shadow:0 0 0 2px rgba(213,185,120,.25)}html.font-small .dialogue-content,html.font-small .choice-button,html.font-small .custom-choice input,html.font-small .memory-content-text,html.font-small .journal-content,html.font-small .knowledge-content{font-size:var(--font-size-small)}html.font-small .speaker-name,html.font-small .memory-header h2,html.font-small .journal-nav-item,html.font-small .tab-button{font-size:.95rem}html.font-small .dialogue-container{--dialogue-height: 180px}html.font-large .dialogue-content,html.font-large .choice-button,html.font-large .custom-choice input,html.font-large .memory-content-text,html.font-large .journal-content,html.font-large .knowledge-content{font-size:var(--font-size-large);line-height:1.7}html.font-large .speaker-name,html.font-large .memory-header h2,html.font-large .journal-nav-item,html.font-large .tab-button{font-size:1.15rem}html.font-large .dialogue-container{--dialogue-height: 230px}html.mobile-ui :root{--header-height: 50px}html.mobile-ui .game-container{display:flex;flex-direction:column;height:100vh;overflow-y:hidden}html.mobile-ui .game-header{height:auto;min-height:auto;padding:var(--spacing-sm);flex-shrink:0;z-index:10}html.mobile-ui .header-left,html.mobile-ui .header-right{gap:var(--spacing-sm)}html.mobile-ui .game-title{font-size:1.2rem;margin-left:0}html.mobile-ui .game-date{font-size:.8rem}html.mobile-ui .icon-button{width:32px;height:32px;font-size:1.2rem}html.mobile-ui .content-wrapper{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}html.mobile-ui .tab-navigation{height:36px;min-height:36px;flex-shrink:0;z-index:9}html.mobile-ui .tab-button{padding:0 var(--spacing-sm);font-size:.9rem}html.mobile-ui .tab-button i{font-size:.9rem}html.mobile-ui .tab-content{flex:1;position:relative;display:flex;flex-direction:column;overflow:hidden}html.mobile-ui .tab-pane.active{position:relative;height:100%;display:flex;flex-direction:column}html.mobile-ui #story-tab{display:flex;flex-direction:column;position:relative;height:100%}html.mobile-ui .background-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:1}html.mobile-ui .characters-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:2}html.mobile-ui .dialogue-container{position:fixed;top:calc(var(--header-height) + 36px + 56.25vw);left:0;right:0;width:100%;height:calc(100vh - (var(--header-height) + 36px + 56.25vw));bottom:0;max-width:none;max-height:none;transform:none;border-radius:0;border-left:none;border-right:none;border-bottom:none;border-top:1px solid var(--color-primary);z-index:3;background-color:rgba(20,20,20,.95);box-shadow:none;cursor:default}html.mobile-ui .dialogue-header{padding:var(--spacing-xs) var(--spacing-sm)}html.mobile-ui .dialogue-content{padding:var(--spacing-sm);height:calc(100% - 35px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--color-primary) rgba(20,20,20,.3)}html.mobile-ui .dialogue-content::-webkit-scrollbar{width:4px}html.mobile-ui .dialogue-content::-webkit-scrollbar-track{background:rgba(20,20,20,.3)}html.mobile-ui .dialogue-content::-webkit-scrollbar-thumb{background-color:var(--color-primary);border-radius:2px}html.mobile-ui .speaker-name{font-size:1rem}html.mobile-ui .choices-container{width:90%;max-width:90%;padding:var(--spacing-xs);z-index:4}html.mobile-ui .character-left,html.mobile-ui .character-right{height:100%;transform-origin:center bottom}html.mobile-ui #journal-tab,html.mobile-ui #memory-tab{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:calc(100vh - (var(--header-height) + 36px));bottom:0;z-index:3}html.mobile-ui .journal-container,html.mobile-ui .memory-container{padding:0;height:100%;width:100%;overflow-y:auto;display:flex;flex-direction:column}html.mobile-ui .memory-container{background-color:var(--color-memory-bg)}html.mobile-ui .memory-header{padding:var(--spacing-sm);border-bottom:1px solid var(--color-memory-secondary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html.mobile-ui .memory-header h2{font-size:1.2rem;margin-bottom:var(--spacing-sm)}html.mobile-ui .memory-button{padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--border-radius);font-size:.9rem}html.mobile-ui .memory-timeline-container{padding:var(--spacing-sm);border-bottom:1px solid rgba(158,129,72,.3);background-color:rgba(0,0,0,.15)}html.mobile-ui .memory-timeline{padding:var(--spacing-sm) 0;height:50px;gap:var(--spacing-sm)}html.mobile-ui .memory-node-simple{width:20px;height:20px}html.mobile-ui .memory-node-simple::before{height:12px}html.mobile-ui .memory-node-simple.selected{transform:scale(1.25);box-shadow:0 0 10px 3px rgba(201,158,81,.5)}html.mobile-ui .memory-detail-container{flex:1;padding:var(--spacing-sm);display:flex;flex-direction:column}html.mobile-ui .memory-content{flex:1;padding:var(--spacing-md);background-color:rgba(0,0,0,.2);border:1px solid var(--color-memory-secondary);overflow-y:auto;font-size:.95rem;line-height:1.5}html.mobile-ui .memory-actions{padding:var(--spacing-sm) 0}html.mobile-ui .memory-travel-button{width:100%;justify-content:center;padding:var(--spacing-sm);background-color:var(--color-memory-primary);font-size:1rem}html.mobile-ui .journal-container{background-color:var(--color-bg-light)}html.mobile-ui .journal-nav{flex-wrap:wrap;padding:var(--spacing-sm);border-bottom:1px solid var(--color-tertiary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html.mobile-ui .journal-nav-item{font-size:.9rem;padding:var(--spacing-xs) var(--spacing-sm);margin-right:var(--spacing-xs);margin-bottom:var(--spacing-xs);border-radius:var(--border-radius)}html.mobile-ui .journal-content{flex:1;padding:var(--spacing-sm);overflow-y:auto}html.mobile-ui .journal-section{background-color:var(--color-bg-lighter);border-radius:var(--border-radius);padding:var(--spacing-sm);margin-bottom:var(--spacing-sm)}.monastery-dialog{max-width:500px;width:90%;margin:auto}.modal-content{background-color:var(--color-bg-light);color:var(--color-text-primary);border:1px solid var(--color-primary);border-radius:var(--border-radius);box-shadow:0 5px 25px rgba(0,0,0,.7)}.modal-header{background-color:rgba(0,0,0,.2);border-bottom:1px solid var(--color-primary);padding:var(--spacing-sm) var(--spacing-md)}.modal-title{color:var(--color-primary);font-family:var(--font-heading);display:flex;align-items:center;gap:var(--spacing-sm)}.modal-title i{font-size:1.1em}.modal-body{padding:var(--spacing-md);background-color:rgba(0,0,0,.1)}.modal-footer{background-color:rgba(0,0,0,.2);border-top:1px solid var(--color-primary);padding:var(--spacing-sm) var(--spacing-md)}.monastery-btn{padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius);font-family:var(--font-heading);font-size:.95rem;transition:all var(--transition-fast);display:flex;align-items:center;gap:var(--spacing-sm)}.monastery-btn i{font-size:1em}.monastery-btn-primary{background-color:var(--color-primary);border-color:var(--color-primary);color:#fff}.monastery-btn-primary:hover{background-color:rgb(102.2741116751,80.7817258883,43.7258883249);border-color:rgb(102.2741116751,80.7817258883,43.7258883249);transform:translateY(-2px);box-shadow:0 3px 8px rgba(0,0,0,.3)}.monastery-btn-secondary{background-color:var(--color-tertiary);border-color:var(--color-tertiary);color:#fff}.monastery-btn-secondary:hover{background-color:rgb(65.8971428571,77.9428571429,46.0571428571);border-color:rgb(65.8971428571,77.9428571429,46.0571428571);transform:translateY(-2px);box-shadow:0 3px 8px rgba(0,0,0,.3)}.monastery-btn-cancel{background-color:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.2);color:var(--color-text-primary)}.monastery-btn-cancel:hover{background-color:hsla(0,0%,100%,.15);border-color:hsla(0,0%,100%,.25)}.monastery-form-group{margin-bottom:var(--spacing-md)}.monastery-label{color:var(--color-primary);font-family:var(--font-heading);margin-bottom:var(--spacing-xs);display:flex;align-items:center;gap:var(--spacing-sm)}.monastery-label i{color:var(--color-primary);font-size:1.1em}.monastery-input,.monastery-select{background-color:hsla(0,0%,100%,.05);border:1px solid rgba(138,109,59,.4);color:var(--color-text-primary);border-radius:var(--border-radius);padding:var(--spacing-sm);transition:all var(--transition-fast)}.monastery-input:focus,.monastery-select:focus{background-color:hsla(0,0%,100%,.1);border-color:var(--color-primary);box-shadow:0 0 0 2px rgba(138,109,59,.2)}.monastery-help-text{margin-top:var(--spacing-xs);font-style:italic;opacity:.8}.monastery-switch .custom-control-input:checked~.custom-control-label::before{background-color:var(--color-primary);border-color:var(--color-primary)}.monastery-switch .custom-control-label{cursor:pointer}.monastery-switch .custom-control-label::before{background-color:hsla(0,0%,100%,.1);border-color:rgba(138,109,59,.4)}.input-dialog-container{display:flex;flex-direction:column;gap:var(--spacing-sm)}#load-game-modal .modal-dialog{max-width:700px;width:95%;margin:auto}@media(max-width: 768px){#load-game-modal .save-list{grid-template-columns:1fr}#load-game-modal .save-item{margin-bottom:var(--spacing-sm)}#load-game-modal .save-item-thumbnail{height:80px}#load-game-modal .save-item-actions{opacity:1}#load-game-modal .modal-dialog{margin:.5rem auto}#load-game-modal .modal-body{padding:var(--spacing-sm);max-height:70vh}#load-game-modal .save-tabs{margin-bottom:var(--spacing-sm)}#load-game-modal .save-tab-btn{font-size:.9rem;padding:var(--spacing-xs) 0}#load-game-modal #btn-create-manual-save{width:100%;justify-content:center;margin-bottom:var(--spacing-sm)}#load-game-modal .modal-footer{padding:var(--spacing-xs) var(--spacing-sm);flex-wrap:wrap;justify-content:center}#load-game-modal .modal-footer .btn{margin:var(--spacing-xs);flex:1;min-width:80px}}html.desktop-ui .game-container{display:flex;flex-direction:column;height:100vh}html.desktop-ui .game-header{height:var(--header-height);min-height:var(--header-height);padding:0 var(--spacing-md)}html.desktop-ui .content-wrapper{flex:1;display:flex;flex-direction:column}html.desktop-ui .tab-navigation{height:var(--tab-height);min-height:var(--tab-height)}html.desktop-ui .tab-button{padding:0 var(--spacing-lg);height:100%;font-size:1rem}html.desktop-ui .tab-content{position:relative;aspect-ratio:16/9;overflow:hidden;flex:none}html.desktop-ui .tab-pane{position:absolute;top:0;left:0;width:100%;height:100%}html.desktop-ui .background-container,html.desktop-ui .characters-container{position:absolute;top:0;left:0;width:100%;height:100%}html.desktop-ui .dialogue-container{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:900px;height:var(--dialogue-height);border:1px solid var(--color-primary);border-radius:var(--border-radius);cursor:pointer}html.desktop-ui .dialogue-header{padding:var(--spacing-sm) var(--spacing-md)}html.desktop-ui .dialogue-content{padding:var(--spacing-md);overflow-y:auto;height:auto}html.desktop-ui .choices-container{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:70%;max-width:650px;padding:var(--spacing-sm)}html.desktop-ui #journal-tab,html.desktop-ui #memory-tab{position:absolute;top:0;left:0;width:100%;height:100%}html.desktop-ui .journal-container,html.desktop-ui .memory-container{display:flex;flex-direction:column;height:100%;width:100%;padding:0}html.desktop-ui .memory-header,html.desktop-ui .journal-nav{position:static;padding:var(--spacing-md)}html.desktop-ui .journal-nav{display:flex;gap:var(--spacing-md);flex-wrap:nowrap}html.desktop-ui .journal-nav-item{padding:var(--spacing-sm) var(--spacing-md);margin:0;font-size:1rem}html.desktop-ui .memory-detail-container,html.desktop-ui .journal-content{flex:1;padding:var(--spacing-md)}html.desktop-ui .character-left,html.desktop-ui .character-right{height:100%;width:40%;transform-origin:bottom center;transform:none}html.desktop-ui .character-left{transform-origin:bottom left}html.desktop-ui .character-right{transform-origin:bottom right}
</style></head><body><div class="game-container"><header class="game-header"><div class="header-left"><h1 class="game-title">Saint Aurelia</h1></div><div class="header-right"><span class="game-date" id="game-date">Anno Domini 1250, Martius XII</span><div class="game-controls"><button id="save-game" class="icon-button gold" title="记录典籍"><i class="fas fa-feather-alt"></i></button> <button id="load-game" class="icon-button gold" title="查看典籍"><i class="fas fa-book-open"></i></button> <button id="settings-button" class="icon-button" title="设置"><i class="fas fa-cog"></i></button></div></div></header><div class="content-wrapper"><div class="tab-navigation"><button id="tab-story" class="tab-button active" data-tab="story-tab"><i class="fas fa-book-open"></i> 正文</button> <button id="tab-journal" class="tab-button" data-tab="journal-tab"><i class="fas fa-journal-whills"></i> 日记</button> <button id="tab-memory" class="tab-button" data-tab="memory-tab"><i class="fas fa-clock-rotate-left"></i> 记忆</button></div><div class="tab-content"><div id="story-tab" class="tab-pane active"><div class="game-core"><div class="background-container" id="background-container"></div><div class="characters-container" id="characters-container"><div class="character-left" id="character-left"></div><div class="character-right" id="character-right"></div></div><div class="dialogue-container" id="dialogue-container"><div class="dialogue-header"><span class="speaker-name" id="speaker-name">Sister Cecilia</span><div class="dialogue-controls"><button id="auto-play" class="icon-button small" title="自动播放"><i class="fas fa-play"></i></button> <button id="dialogue-history" class="icon-button small" title="历史记录"><i class="fas fa-history"></i></button></div></div><div class="dialogue-content" id="dialogue-content"></div></div><div class="choices-container hidden" id="choices-container"><div class="choices-header"><h3>接下来的行动</h3><button id="hide-choices-btn" class="icon-button small" title="隐藏选项"><i class="fas fa-times"></i></button></div><div class="preset-choices" id="preset-choices"></div><div class="custom-choice"><input id="custom-choice-input" placeholder="自定义回应..."/> <button id="custom-choice-button" type="button">确定</button></div></div></div></div><div id="journal-tab" class="tab-pane"><div class="journal-container"><div class="journal-nav"><button class="journal-nav-item active" data-section="characters"><i class="fas fa-users"></i> 角色信息</button> <button class="journal-nav-item" data-section="monastery"><i class="fas fa-church"></i> 修道院状态</button> <button class="journal-nav-item" data-section="knowledge"><i class="fas fa-book"></i> 知识库</button></div><div class="journal-content"><div id="characters-section" class="journal-section active"><div class="character-cards" id="character-cards"></div><div class="character-details" id="character-details"></div></div><div id="monastery-section" class="journal-section"><div class="monastery-info" id="monastery-info"></div></div><div id="knowledge-section" class="journal-section"><div class="knowledge-categories" id="knowledge-categories"></div><div class="knowledge-entries" id="knowledge-entries"></div></div></div></div></div><div id="memory-tab" class="tab-pane"><div class="memory-container"><div class="memory-header"><h2><i class="fas fa-hourglass-half"></i> 穿越记忆点</h2><button id="save-memory" class="memory-button"><i class="fas fa-bookmark"></i> 保存此刻</button></div><div class="memory-timeline-container"><div class="memory-timeline" id="memory-timeline"></div></div><div class="memory-detail-container"><div class="memory-content" id="memory-content"></div><div class="memory-actions"><button id="travel-to-memory" class="memory-travel-button"><i class="fas fa-clock-rotate-left"></i> 穿越到此刻</button></div></div></div></div></div><div class="loading-indicator hidden" id="loading-indicator"><div class="loading-spinner"></div><div class="loading-text">加载中...</div></div><div id="notification-container"></div></div></div><div class="confirm-container hidden" id="confirm-container"><div class="modal-backdrop" id="modal-backdrop"></div><div class="confirm-dialog" id="confirm-dialog"><div class="confirm-message" id="confirm-message">确定要执行此操作吗？</div><div class="confirm-buttons"><button class="confirm-button confirm-yes" id="confirm-yes">确认</button> <button class="confirm-button confirm-no" id="confirm-no">取消</button></div></div></div><script>class e{backgroundMap={};constructor(){this.initBackgroundMap(),console.log('背景管理器初始化完成')}initBackgroundMap(){this.backgroundMap={公园_白天:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E7%99%BD%E5%A4%A9.jpg?ref_type=heads',公园_黄昏:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E9%BB%84%E6%98%8F.jpg?ref_type=heads',书店_内部:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E4%B9%A6%E5%BA%97%E5%86%85/%E4%B9%A6%E5%BA%97.jpg?ref_type=heads',修道院_图书室:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E4%B9%A6%E5%BA%97%E5%86%85/%E4%B9%A6%E5%BA%97.jpg?ref_type=heads',修道院_办公室:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E9%BB%84%E6%98%8F.jpg?ref_type=heads',修道院_花园:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E7%99%BD%E5%A4%A9.jpg?ref_type=heads'}}setBackground(e,t){const o=`${e}_${t}`;let a=this.backgroundMap[o];a||(a=this.backgroundMap[`${e}_默认`]),a||_.isEmpty(this.backgroundMap)||(a=_.values(this.backgroundMap)[0]),a?($('.background-container').css('backgroundImage',`url('${a}')`),console.log(`已设置背景: ${o}`)):(console.warn(`未找到背景: ${o}`),$('.background-container').css({backgroundImage:'none',backgroundColor:'#2a2a2a'}))}addBackground(e,t){this.backgroundMap[e]=t}applyBackgroundEffect(e){if($('.background-container').removeClass('effect-fade effect-slide effect-zoom'),e){const t=$('.background-container');switch(e){case'fade':t.addClass('effect-fade'),t.hide().fadeIn(1e3);break;case'slide':t.addClass('effect-slide'),t.hide().slideDown(1e3);break;case'zoom':t.addClass('effect-zoom'),t.hide().show('scale',{},1e3)}setTimeout(()=>{t.removeClass(`effect-${e}`)},1e3)}}getAllBackgroundKeys(){return _.keys(this.backgroundMap)}}class t{characterResourceService;currentCharacters={};constructor(e){this.characterResourceService=e,console.log('角色管理器初始化完成')}setCharacter(e,t='default',o){const a=$(`.character-${o}`);if(0===a.length)return void console.error(`未找到${o}侧角色容器元素`);const s=this.characterResourceService.getCharacter(e);if(!s)return console.error(`未找到ID为${e}的角色资源`),void this.hideCharacter(o);const i=this.characterResourceService.getCharacterEmotionUrl(e,t);if(i)this.setCharacterImage(a,s,i,o,t);else{console.error(`角色${e}没有${t}表情差分`);const i=this.characterResourceService.getCharacterEmotionUrl(e);if(!i)return void this.hideCharacter(o);this.setCharacterImage(a,s,i,o,'default')}}setCharacterImage(e,t,o,a,s){e.css({backgroundImage:`url('${o}')`,opacity:1}).data({characterId:t.id,characterName:t.name}),this.currentCharacters[a]={id:t.id,emotion:s},console.log(`已设置${t.name}的${s}表情立绘在${a}侧`)}updateEmotion(e,t='default'){let o=null;this.currentCharacters.left?.id===e?o='left':this.currentCharacters.right?.id===e&&(o='right'),o?this.setCharacter(e,t,o):console.warn(`未找到ID为${e}的角色在场景中`)}hideCharacter(e){'left'!==e&&'all'!==e||($('.character-left').css({backgroundImage:'none',opacity:0}),delete this.currentCharacters.left),'right'!==e&&'all'!==e||($('.character-right').css({backgroundImage:'none',opacity:0}),delete this.currentCharacters.right)}setCharacterEffect(e,t){const o=$(`.character-${e}`);if(0!==o.length){if(o.removeClass('effect-shake effect-focus effect-blur'),t)switch(o.addClass(`effect-${t}`),t){case'shake':o.effect('shake',{times:3,distance:5},500);break;case'focus':$('.characters-container .character').not(o).animate({opacity:.5},500),o.animate({opacity:1},500);break;case'blur':o.fadeOut(250).fadeIn(250)}}else console.error(`未找到${e}侧角色容器元素`)}swapCharacters(){const e=$('.character-left'),t=$('.character-right');if(0===e.length||0===t.length)return;const o=this.currentCharacters.left,a=this.currentCharacters.right;o&&a&&(this.setCharacter(a.id,a.emotion,'left'),this.setCharacter(o.id,o.emotion,'right'),e.add(t).css('transition','all 0.5s ease-in-out'))}updateCharactersByDialogue(e,t='default'){if('narrator'===e)return;const o=this.characterResourceService.getCharacter(e);if(!o)return void console.log(`未找到ID为${e}的角色资源，跳过立绘更新`);let a='right';if(this.currentCharacters.left?.id===e)a='left';else{if(this.currentCharacters.right?.id!==e)return'left'!==o.position&&'right'!==o.position||(a=o.position),void this.setCharacter(e,t,a);a='right'}this.updateEmotion(e,t)}}class o{choices=[];choicesShown=!1;choicesHidden=!1;onChoiceSelectedCallback=null;constructor(){$('#custom-choice-button').on('click',()=>{const e=$('#custom-choice-input').val();e&&e.trim()&&(this.selectChoice(e.trim()),$('#custom-choice-input').val(''))}),$('#custom-choice-input').on('keypress',e=>{if('Enter'===e.key){const e=$('#custom-choice-input').val();e&&e.trim()&&(this.selectChoice(e.trim()),$('#custom-choice-input').val(''))}}),$(document).on('click','#hide-choices-btn',e=>{e.stopPropagation(),this.hideChoices()}),console.log('选项管理器初始化完成')}setChoices(e){this.choices=e,this.choicesShown=!1,this.choicesHidden=!1}renderChoices(){const e=$('.preset-choices');if(0===e.length)return;e.empty(),_.forEach(this.choices,(t,o)=>{$('<button>',{class:'choice-button',text:t,'data-index':o,'data-choice':t,click:()=>this.selectChoice(t)}).appendTo(e)});const t=$('.choices-container');this.choices.length<=2?t.addClass('compact-choices'):t.removeClass('compact-choices')}showChoices(){const e=$('.choices-container'),t=$('.preset-choices');0!==e.length&&0!==t.length&&(this.renderChoices(),e.removeClass('hidden').hide().fadeIn(300),this.choicesShown=!0,this.choicesHidden=!1,setTimeout(()=>{$('#custom-choice-input').focus()},300))}hideChoices(){const e=this;$('.choices-container').fadeOut(300,function(){$(this).addClass('hidden').show(),e.choicesHidden=!0})}canReshowChoices(){return this.choicesShown&&this.choicesHidden&&this.choices.length>0}reshowChoices(){this.canReshowChoices()&&this.showChoices()}selectChoice(e){this.onChoiceSelectedCallback&&this.onChoiceSelectedCallback(e),this.hideChoices()}setOnChoiceSelected(e){this.onChoiceSelectedCallback=e}addChoice(e){_.includes(this.choices,e)||(this.choices.push(e),$('.choices-container').hasClass('hidden')||this.renderChoices())}removeChoice(e){_.pull(this.choices,e),$('.choices-container').hasClass('hidden')||this.renderChoices()}clearChoices(){this.choices=[],$('.choices-container').hasClass('hidden')||this.renderChoices()}getAllChoices(){return _.clone(this.choices)}areChoicesVisible(){return this.choicesShown&&!this.choicesHidden}}class a{dialogues=[];currentDialogueIndex=0;characterResourceService;characterManager;backgroundManager;isAutoPlaying=!1;autoPlayInterval=null;autoPlaySpeed=3e3;constructor(e,t,o){this.characterResourceService=e,this.characterManager=t,this.backgroundManager=o,$('#auto-play').on('click',()=>{this.toggleAutoPlay()}),console.log('对话管理器初始化完成')}setDialogues(e){this.dialogues=e,this.currentDialogueIndex=0}showDialogue(e){if(e<0||e>=this.dialogues.length)return void console.error('无效的对话索引');this.currentDialogueIndex=e;const t=this.dialogues[e],o=t.speaker;$('.speaker-name').text(o);const a=$('<div>',{class:`dialogue-text style-${t.style||'normal'}`,text:t.content});$('.dialogue-content').empty().append(a),$('.dialogue-content').scrollTop($('.dialogue-content')[0].scrollHeight),this.updateCharacterDisplay(t),this.updateBackground(t)}updateCharacterDisplay(e){if(!e.portrait){return void(this.characterResourceService.getCharacter(e.speaker)?this.characterManager.updateCharactersByDialogue(e.speaker,'default'):this.characterManager.hideCharacter('all'))}const{character:t,emotion:o}=e.portrait;let a='right';const s=this.characterResourceService.getCharacter(t);s&&s.position&&(a=s.position),this.characterManager.setCharacter(t,o,a)}updateBackground(e){if(e.background){const{location:t,scene:o}=e.background;this.backgroundManager.setBackground(t,o)}}showNextDialogue(){return this.currentDialogueIndex<this.dialogues.length-1&&(this.showDialogue(this.currentDialogueIndex+1),!0)}showPreviousDialogue(){return this.currentDialogueIndex>0&&(this.showDialogue(this.currentDialogueIndex-1),!0)}renderDialogue(e=this.currentDialogueIndex){this.showDialogue(e)}addDialogue(e){this.dialogues.push(e),1===this.dialogues.length&&this.renderDialogue(0)}clearDialogues(){this.dialogues=[],this.currentDialogueIndex=0,$('.dialogue-content').empty(),$('.speaker-name').text(''),this.characterManager.hideCharacter('all')}toggleAutoPlay(){this.isAutoPlaying=!this.isAutoPlaying;const e=$('#auto-play');this.isAutoPlaying?(this.autoPlayInterval=window.setInterval(()=>{this.showNextDialogue()||this.stopAutoPlay()},this.autoPlaySpeed),e.addClass('active').html('<i class="fas fa-pause"></i>')):(this.stopAutoPlay(),e.removeClass('active').html('<i class="fas fa-play"></i>'))}stopAutoPlay(){null!==this.autoPlayInterval&&(clearInterval(this.autoPlayInterval),this.autoPlayInterval=null),this.isAutoPlaying=!1,$('#auto-play').removeClass('active').html('<i class="fas fa-play"></i>')}setAutoPlaySpeed(e){this.autoPlaySpeed=e,this.isAutoPlaying&&(this.stopAutoPlay(),this.toggleAutoPlay())}getCurrentDialogue(){return this.currentDialogueIndex>=0&&this.currentDialogueIndex<this.dialogues.length?this.dialogues[this.currentDialogueIndex]:null}getAllDialogues(){return _.cloneDeep(this.dialogues)}showDialogueHistory(e){const t=this.currentDialogueIndex,o=$('.dialogue-content');o.empty();const a=e||this.dialogues;_.forEach(a,(e,t)=>{const a=$('<div>',{class:'dialogue-history-item','data-index':t}),s=$('<div>',{class:'speaker-name-history',text:e.speaker}),i=$('<div>',{class:`dialogue-text-history style-${e.style||'normal'}`,text:e.content});a.append(s).append(i),o.append(a)}),$('#dialogue-history-notice').show();const s=$('<button>',{id:'return-from-history',class:'btn btn-primary',text:'返回对话',click:()=>{$('#dialogue-history-notice').hide(),o.removeClass('history-mode'),this.renderDialogue(t)}});o.append(s),o.addClass('history-mode')}getCurrentDialogueIndex(){return this.currentDialogueIndex}isDialogueFinished(){return this.currentDialogueIndex>=this.dialogues.length-1}}class s{gameData=null;constructor(){console.log('日记管理器初始化完成')}setGameData(e){this.gameData=e}switchJournalSection(e){$('.journal-nav-item').removeClass('active'),$('.journal-section').removeClass('active'),$(`[data-section="${e}"]`).addClass('active'),$(`#${e}-section`).addClass('active'),this.showPlaceholder(e)}refreshJournalContent(){this.showPlaceholder('characters')}showPlaceholder(e){const t=$(`#${e}-section`);if(!t.length)return;t.empty();let o='日记';switch(e){case'characters':o='角色信息';break;case'monastery':o='修道院';break;case'knowledge':o='知识库'}$('<div>',{class:'journal-placeholder',css:{padding:'20px',textAlign:'center'}}).append($('<h3>',{text:o,css:{marginBottom:'15px'}})).append($('<p>',{text:'内容暂未实现',css:{color:'#888',fontStyle:'italic'}})).appendTo(t),console.log(`日记${o}部分已清空，仅保留占位符`)}selectCharacter(e){console.log(`尝试选择角色: ${e}，但该功能已简化为占位符`)}}class i{memories=[];selectedMemoryId=null;hasCreatedMemory=!1;alreadySavedKey='memory_already_saved';isTabSwitching=!1;onMemorySelectedCallback=null;onMemorySavedCallback=null;onMemoryTravelCallback=null;constructor(){$('#travel-to-memory').on('click',()=>{this.travelToSelectedMemory()}),this.checkIfAlreadySaved(),$('a[data-bs-toggle="tab"]').on('hide.bs.tab',e=>{'#memory-tab'===$(e.target).attr('href')&&(this.isTabSwitching=!0)}),$('a[data-bs-toggle="tab"]').on('shown.bs.tab',e=>{'#memory-tab'===$(e.target).attr('href')&&setTimeout(()=>{$('#memory-timeline').empty(),this.renderMemories(),this.isTabSwitching=!1},50)}),console.log('记忆管理器初始化完成')}checkIfAlreadySaved(){'true'===sessionStorage.getItem(this.alreadySavedKey)&&(this.hasCreatedMemory=!0,this.updateSaveButtonState())}updateSaveButtonState(){this.hasCreatedMemory&&$('.memory-button').prop('disabled',!0).css('opacity','0.5').attr('title','此场景已保存，每个场景只能保存一次').text('已保存')}setMemories(e){const t={};e.forEach(e=>{t[e.id]=e}),this.memories=Object.values(t),console.log(`设置了${this.memories.length}个记忆点（去重后）`)}renderMemories(){const e=$('#memory-timeline');if(0===e.length)return;if(this.isTabSwitching)return;e.empty();const t={};this.memories.forEach(e=>{t[e.id]=e});const o=_.sortBy(Object.values(t),'id');this.memories=o,0!==o.length?(_.forEach(o,(t,o)=>{$('<div>',{class:'memory-node-simple '+(this.selectedMemoryId===t.id?'selected':''),'data-id':t.id,title:this.formatTimestamp(t.timestamp||''),click:()=>this.selectMemory(t.id)}).appendTo(e)}),console.log(`已渲染${o.length}个记忆点`),this.updateSaveButtonState()):e.html('<div class="memory-empty-timeline">尚未创建记忆点。保存当前场景来创建一个新的记忆点。</div>')}formatTimestamp(e){try{const t=new Date(e);return isNaN(t.getTime())?e:`${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${t.getMinutes().toString().padStart(2,'0')}`}catch(t){return e}}selectMemory(e){const t=_.find(this.memories,{id:e});if(!t)return void console.error(`未找到ID为${e}的记忆`);this.selectedMemoryId=e;const o=$('#memory-content');o.length>0&&(o.empty(),t.image&&$('<div>',{class:'memory-content-image',css:{backgroundImage:`url('${t.image}')`}}).appendTo(o),$('<div>',{class:'memory-content-text',text:t.content}).appendTo(o),t.timestamp&&$('<div>',{class:'memory-timestamp',text:t.timestamp}).appendTo(o)),$('.memory-node-simple').removeClass('selected'),$(`.memory-node-simple[data-id="${e}"]`).addClass('selected'),$('#travel-to-memory').prop('disabled',!1),this.onMemorySelectedCallback&&this.onMemorySelectedCallback(e)}travelToSelectedMemory(){null!==this.selectedMemoryId?this.onMemoryTravelCallback&&this.onMemoryTravelCallback(this.selectedMemoryId):console.error('没有选中的记忆点')}addMemory(e,t){if(this.hasCreatedMemory)return console.warn('此场景已保存过，每个场景只能保存一次'),this.showOneTimeOnlyMessage(),null;const o=_.map(this.memories,'id'),a=this.memories.length>0?(_.max(o)||0)+1:1,s={id:a,content:e,timestamp:(new Date).toLocaleString(),image:t};return this.memories.push(s),this.hasCreatedMemory=!0,sessionStorage.setItem(this.alreadySavedKey,'true'),this.renderMemories(),this.selectMemory(a),this.onMemorySavedCallback&&this.onMemorySavedCallback(s),s}showOneTimeOnlyMessage(){const e=$('<div>',{class:'notification notification-warning',text:'此场景已保存过，每个场景只能保存一次'}).appendTo('#notification-container');setTimeout(()=>{e.addClass('notification-show')},10),setTimeout(()=>{e.addClass('notification-hide').removeClass('notification-show'),setTimeout(()=>{e.remove()},300)},3e3)}deleteMemory(e){const t=_.findIndex(this.memories,{id:e});-1!==t?(this.memories.splice(t,1),this.renderMemories(),this.selectedMemoryId===e&&(this.selectedMemoryId=null,this.setEmptyMemoryContent(),$('#travel-to-memory').prop('disabled',!0))):console.error(`未找到ID为${e}的记忆`)}getSelectedMemory(){return null===this.selectedMemoryId?null:_.find(this.memories,{id:this.selectedMemoryId})||null}getAllMemories(){const e={};return this.memories.forEach(t=>{e[t.id]=t}),_.cloneDeep(Object.values(e))}setEmptyMemoryContent(e='选择一个记忆点或保存当前场景'){$('#memory-content').html(`<div class="memory-empty-message">${e}</div>`),$('#travel-to-memory').prop('disabled',!0)}setOnMemorySelected(e){this.onMemorySelectedCallback=e}setOnMemorySaved(e){this.onMemorySavedCallback=e}setOnMemoryTravel(e){this.onMemoryTravelCallback=e}clearMemories(){this.memories=[],this.selectedMemoryId=null,this.hasCreatedMemory=!1,sessionStorage.removeItem(this.alreadySavedKey),this.renderMemories(),this.setEmptyMemoryContent()}initializeDisplay(){const e={};this.memories.forEach(t=>{e[t.id]=t}),this.memories=Object.values(e),this.memories.length>0?this.renderMemories():this.setEmptyMemoryContent(),this.checkIfAlreadySaved()}}class n{gameData=null;memoryManager;saveManager;uiManager;gameStateGenerationService;constructor(e,t,o,a){this.memoryManager=e,this.saveManager=t,this.uiManager=o,this.gameStateGenerationService=a,console.log('记忆UI管理器初始化完成')}setGameData(e){this.gameData=e}refreshMemoryTimeline(){this.gameData&&(this.memoryManager.setMemories(this.gameData.storySummary),this.memoryManager.renderMemories())}saveMemory(){if(!this.gameData)return null;const e=this.memoryManager.addMemory(`${this.gameData.story.currentChapter} - 在${this.gameData.story.location}`);return this.uiManager.showNotification('记忆点已保存','success'),e}async travelToMemory(e){const t=this.memoryManager.getSelectedMemory();t?this.uiManager.showConfirmDialog(`确定要穿越到"${t.content}"吗？`,async()=>{this.uiManager.showLoading('正在穿越时间...');try{let o=null;const a=await this.saveManager.loadGameStateByID(t.id);if(a)o=a,console.log('从世界书中加载了游戏状态');else{const e=await this.gameStateGenerationService.generateMemoryState(t);if(!e)throw new Error('无法生成记忆点游戏状态');o=e,console.log('生成了新的记忆点游戏状态')}this.gameData=o,e(),this.uiManager.showNotification('时间旅行成功','success')}catch(e){console.error('穿越时间失败:',e),this.uiManager.showNotification('穿越失败: '+(e instanceof Error?e.message:'未知错误'),'error')}finally{this.uiManager.hideLoading()}}):this.uiManager.showNotification('请先选择一个记忆点','warning')}getGameData(){return this.gameData}}class r{uiManager;worldBookName='修女的追忆记录';modalId='load-game-modal';DIALOGUE_HISTORY_KEY='persistent_dialogue_history';COMPLETE_HISTORY_KEY='complete_game_history';SAVE_TYPE={AUTO:'auto_save_',MANUAL:'save_'};currentMaxSaveId={auto:0,manual:0};cachedCompleteHistory=null;constructor(e){this.uiManager=e,this.initializeLoadGameModal(),this.initializeChatLorebook(),this.ensureBootstrapLoaded(),this.loadCompleteHistory()}ensureBootstrapLoaded(){if('undefined'!=typeof $){if('function'!=typeof $.fn.modal){if(console.warn('Bootstrap modal未检测到，尝试加载'),!document.getElementById('bootstrap-css')){const e=document.createElement('link');e.id='bootstrap-css',e.rel='stylesheet',e.href='https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css',document.head.appendChild(e)}if(!document.getElementById('bootstrap-js')){const e=document.createElement('script');e.id='bootstrap-js',e.src='https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js',e.onload=()=>{console.log('Bootstrap已成功加载'),this.initializeLoadGameModal()},document.body.appendChild(e)}}}else console.error('jQuery未加载，这可能导致modal功能失效')}async initializeChatLorebook(){try{if(console.log(`正在初始化固定世界书: ${this.worldBookName}`),'function'!=typeof window.getLorebooks||'function'!=typeof window.createLorebook)return void console.error('世界书API不可用，无法初始化聊天世界书');const e=await window.getLorebooks();e.includes(this.worldBookName)?(console.log(`找到现有的固定世界书: ${this.worldBookName}`),'function'==typeof window.setChatLorebook&&await window.setChatLorebook(this.worldBookName)):(console.log(`创建新的固定世界书: ${this.worldBookName}`),await window.createLorebook(this.worldBookName),'function'==typeof window.setChatLorebook&&await window.setChatLorebook(this.worldBookName)),await this.initializeMaxSaveIds()}catch(e){console.error('初始化聊天世界书失败:',e)}}async initializeMaxSaveIds(){try{const e=await this.getAllWorldBookEntries();if(!e||!e.length)return;const t=e.filter(e=>this.checkEntryKeyStartsWith(e,this.SAVE_TYPE.AUTO));t.length>0&&(this.currentMaxSaveId.auto=Math.max(...t.map(e=>{const t=this.getEntryKey(e).match(/(\d+)$/);return t?parseInt(t[1],10):0})));const o=e.filter(e=>this.checkEntryKeyStartsWith(e,this.SAVE_TYPE.MANUAL));o.length>0&&(this.currentMaxSaveId.manual=Math.max(...o.map(e=>{const t=this.getEntryKey(e).match(/(\d+)$/);return t?parseInt(t[1],10):0}))),console.log(`初始化存档ID: 自动存档=${this.currentMaxSaveId.auto}, 手动存档=${this.currentMaxSaveId.manual}`)}catch(e){console.error('初始化最大存档ID失败:',e)}}getEntryKey(e){return Array.isArray(e.key)&&e.key.length>0?e.key[0]:'string'==typeof e.key?e.key:''}async getAllWorldBookEntries(){try{if(!this.worldBookName&&(console.warn('无法获取世界书条目：世界书名为空'),await this.initializeChatLorebook(),!this.worldBookName))return[];if('function'!=typeof window.getLorebookEntries)return console.error('世界书API不可用：getLorebookEntries函数未定义'),[];let e;console.log(`正在获取世界书 ${this.worldBookName} 的所有条目...`);try{e=await window.getLorebookEntries(this.worldBookName)}catch(t){if(console.error('调用getLorebookEntries API出错:',t),'function'==typeof window.triggerSlash)try{console.log('尝试使用triggerSlash作为后备方案获取条目');const t=await window.triggerSlash(`/getlbentries ${this.worldBookName}`);if(t)try{e=JSON.parse(t)}catch(e){console.error('解析triggerSlash返回结果失败:',e)}}catch(e){console.error('使用triggerSlash获取条目失败:',e)}}if(!e)return console.log(`没有从世界书 ${this.worldBookName} 获取到条目`),[];if(!Array.isArray(e))return console.error('获取的条目不是数组类型:',e),[];if(console.log(`成功获取世界书条目，共 ${e.length} 个`),e.length>0){const t=e.filter(e=>!e||!e.uid||'number'!=typeof e.uid);t.length>0&&console.warn(`发现 ${t.length} 个无效条目（缺少UID或UID类型错误）`)}else console.log('世界书条目为空，可能是新创建的世界书');return e}catch(e){return console.error('获取世界书条目失败:',e),[]}}checkEntryKeyStartsWith(e,t){return!(!e||!e.key)&&(Array.isArray(e.key)?e.key.some(e=>e&&'string'==typeof e&&e.startsWith(t)):'string'==typeof e.key&&e.key.startsWith(t))}findEntryByKey(e,t){if(!e||!Array.isArray(e))return console.warn('查找条目时传入的条目列表无效'),null;if(!t)return console.warn('查找条目时传入的键名为空'),null;const o=e.find(e=>!!e&&(Array.isArray(e.key)?e.key.includes(t):e.key===t));return o?!o.uid||'number'!=typeof o.uid||isNaN(o.uid)?console.warn(`找到键名为 ${t} 的条目，但其UID无效: ${o.uid}`):console.log(`找到键名为 ${t} 的条目，UID: ${o.uid}`):console.log(`未找到键名为 ${t} 的条目`),o}initializeLoadGameModal(){if(0===$(`#${this.modalId}`).length){const e=`\n      <div id="${this.modalId}" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="loadGameModalTitle" aria-hidden="true">\n        <div class="modal-dialog modal-lg" role="document">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title" id="loadGameModalTitle"><i class="fas fa-book-open"></i> 修道院典籍记录</h5>\n              <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                <span aria-hidden="true">&times;</span>\n              </button>\n            </div>\n            <div class="modal-body">\n              <div class="save-tabs">\n                <button class="save-tab-btn active" data-tab="auto"><i class="fas fa-clock"></i> 时间记忆</button>\n                <button class="save-tab-btn" data-tab="manual"><i class="fas fa-bookmark"></i> 永久典籍</button>\n              </div>\n              <div class="save-tab-content">\n                <div id="auto-saves-container" class="save-tab-pane active">\n                  <ul id="auto-save-list" class="save-list">\n                    <li class="save-item empty">暂无自动记录点</li>\n                  </ul>\n                </div>\n                <div id="manual-saves-container" class="save-tab-pane">\n                  <ul id="manual-save-list" class="save-list">\n                    <li class="save-item empty">暂无手动保存的典籍</li>\n                  </ul>\n                </div>\n              </div>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-primary" id="btn-create-manual-save">\n                <i class="fas fa-feather-alt"></i> 记录当前典籍\n              </button>\n              <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>\n            </div>\n          </div>\n        </div>\n      </div>`;$('body').append(e);const t=`\n        <style>\n          #${this.modalId} {\n            background-color: rgba(0, 0, 0, 0.5);\n          }\n          #${this.modalId}.show {\n            display: block !important;\n          }\n          .save-tabs {\n            display: flex;\n            border-bottom: 1px solid #dee2e6;\n            margin-bottom: 15px;\n          }\n          .save-tab-btn {\n            background: none;\n            border: none;\n            padding: 10px 15px;\n            cursor: pointer;\n            outline: none;\n          }\n          .save-tab-btn.active {\n            border-bottom: 2px solid #5d6e41;\n          }\n          .save-tab-pane {\n            display: none;\n          }\n          .save-tab-pane.active {\n            display: block;\n          }\n          .save-list {\n            list-style: none;\n            padding: 0;\n          }\n          .save-item {\n            margin-bottom: 10px;\n            border: 1px solid #dee2e6;\n            border-radius: 4px;\n            padding: 10px;\n            display: flex;\n            flex-direction: column;\n            cursor: pointer;\n            transition: box-shadow 0.3s;\n          }\n          .save-item:hover {\n            box-shadow: 0 0 10px rgba(0,0,0,0.1);\n          }\n          .save-item.empty {\n            color: #6c757d;\n            cursor: default;\n            text-align: center;\n          }\n          .save-item-thumbnail {\n            height: 120px;\n            background-size: cover;\n            background-position: center;\n            border-radius: 4px;\n          }\n          .save-item-header {\n            display: flex;\n            justify-content: space-between;\n            margin: 10px 0 5px;\n          }\n          .save-item-title {\n            font-weight: bold;\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n          }\n          .save-item-date {\n            font-size: 0.8em;\n            color: #6c757d;\n          }\n          .save-item-content {\n            font-size: 0.9em;\n            color: #333;\n            margin-bottom: 10px;\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n          }\n          .save-item-actions {\n            display: flex;\n            justify-content: space-between;\n          }\n          .btn-load, .btn-delete {\n            border: none;\n            padding: 5px 10px;\n            border-radius: 4px;\n            cursor: pointer;\n          }\n          .btn-load {\n            background-color: #5d6e41;\n            color: white;\n          }\n          .btn-delete {\n            background-color: #dc3545;\n            color: white;\n          }\n        </style>\n      `;$('head').append(t),$(document).off('click',`#${this.modalId} .save-tab-btn`),$(document).off('click','#btn-create-manual-save'),$(document).on('click',`#${this.modalId} .save-tab-btn`,e=>{const t=$(e.currentTarget).data('tab');$(`#${this.modalId} .save-tab-btn`).removeClass('active'),$(`#${this.modalId} .save-tab-pane`).removeClass('active'),$(e.currentTarget).addClass('active'),'auto'===t?$('#auto-saves-container').addClass('active'):$('#manual-saves-container').addClass('active')}),$(document).on('click','#btn-create-manual-save',()=>{console.log('创建手动存档按钮被点击'),this.createManualSave()}),$(document).on('click',`#${this.modalId} .close, #${this.modalId} .btn-secondary`,()=>{this.closeLoadGameModal()}),$(document).on('click',`#${this.modalId}`,e=>{$(e.target).attr('id')===this.modalId&&this.closeLoadGameModal()}),console.log(`加载游戏弹窗已初始化，ID: ${this.modalId}`)}}closeLoadGameModal(){'function'==typeof $.fn.modal?$(`#${this.modalId}`).modal('hide'):$(`#${this.modalId}`).css('display','none').removeClass('show')}async createManualSave(){try{console.log('开始创建手动存档流程'),this.uiManager.showInputDialog('请输入典籍标题','手动存档',async e=>{console.log('用户输入的存档名称:',e),e||(e='手动存档',console.log('使用默认存档名称:',e)),this.uiManager.showLoading('正在记录典籍...');try{console.log('获取当前游戏状态');const t=await this.getCurrentGameData();if(!t)return console.error('无法获取当前游戏状态'),void this.uiManager.showNotification('无法获取当前游戏状态','error');console.log('成功获取当前游戏状态，准备保存');await this.saveGameState(t,!0,e)?(console.log('手动存档成功保存'),this.uiManager.showNotification(`典籍"${e}"已成功记录`,'success'),console.log('刷新存档列表'),this.refreshSaveList()):(console.error('保存游戏状态失败'),this.uiManager.showNotification('记录典籍失败','error'))}catch(e){console.error('创建手动存档失败:',e),this.uiManager.showNotification('记录典籍失败','error')}finally{this.uiManager.hideLoading()}})}catch(e){console.error('创建手动存档流程出错:',e),this.uiManager.showNotification('记录典籍失败','error')}}async getCurrentGameData(){return new Promise(e=>{const t=new CustomEvent('request_game_data',{detail:{callback:t=>e(t)}});window.dispatchEvent(t),setTimeout(()=>e(null),5e3)})}async showLoadGameModal(){try{if(this.uiManager.showLoading('正在获取存档列表...'),await this.refreshSaveList(),this.ensureBootstrapLoaded(),'function'!=typeof $.fn.modal){console.log('Bootstrap modal方法不可用，使用替代方法显示弹窗');$(`#${this.modalId}`).css({display:'block','padding-right':'17px'}).addClass('show'),$('body').addClass('modal-open').css('overflow','hidden')}else{console.log('使用Bootstrap modal方法显示弹窗');try{$(`#${this.modalId}`).modal('show')}catch(e){console.error('显示modal出错:',e),$(`#${this.modalId}`).css({display:'block','padding-right':'17px'}).addClass('show'),$('body').addClass('modal-open').css('overflow','hidden')}}this.uiManager.hideLoading()}catch(e){console.error('显示加载游戏弹窗失败:',e),this.uiManager.showNotification('获取存档列表失败','error'),this.uiManager.hideLoading()}}async refreshSaveList(){try{const{autoSaves:e,manualSaves:t}=await this.getAllSaves(),o=$('#auto-save-list');if(o.empty(),0===e.length)o.append('<li class="save-item empty">暂无自动存档</li>');else{const t=e.sort((e,t)=>t.saveId-e.saveId);for(const e of t)this.appendSaveItem(o,e)}const a=$('#manual-save-list');if(a.empty(),0===t.length)a.append('<li class="save-item empty">暂无手动存档</li>');else{const e=t.sort((e,t)=>t.saveId-e.saveId);for(const t of e)this.appendSaveItem(a,t)}}catch(e){throw console.error('刷新存档列表失败:',e),e}}appendSaveItem(e,t){let o='';o=t.thumbnail?t.thumbnail:t.isAuto?'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E4%B9%A6%E5%BA%97%E5%86%85/%E4%B9%A6%E5%BA%97.jpg?ref_type=heads':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E7%99%BD%E5%A4%A9.jpg?ref_type=heads';const a=$('<li>',{class:'save-item','data-key':t.key});$('<div>',{class:'save-item-thumbnail',style:`background-image: url(${o})`}).appendTo(a);const s=$('<div>',{class:'save-item-header'});$('<div>',{class:'save-item-title',text:t.title}).appendTo(s),$('<div>',{class:'save-item-date',text:t.date}).appendTo(s),s.appendTo(a),$('<div>',{class:'save-item-content',text:t.content||'无可用内容'}).appendTo(a);const i=$('<div>',{class:'save-item-actions'}),n=$('<button>',{class:'btn-load',html:'<i class="fas fa-book-reader"></i> 阅读','data-key':t.key}),r=$('<button>',{class:'btn-delete',html:'<i class="fas fa-trash-alt"></i> 销毁','data-key':t.key,'data-title':t.title});i.append(n).append(r),i.appendTo(a),e.append(a),n.on('click',e=>(e.preventDefault(),e.stopPropagation(),console.log('点击加载按钮，key:',t.key),this.loadGameFromKey(t.key),!1)),r.on('click',e=>(e.preventDefault(),e.stopPropagation(),console.log('点击删除按钮，key:',t.key,'title:',t.title),this.deleteSave(t.key,t.title),!1)),a.on('click',e=>{$(e.target).closest('.save-item-actions').length>0||(console.log('点击存档项，key:',t.key),this.loadGameFromKey(t.key))})}async deleteSave(e,t){try{console.log('准备删除存档，key:',e,'title:',t),this.uiManager.showConfirmDialog(`确定要销毁典籍"${t}"吗？此操作不可逆。`,async()=>{console.log('用户确认删除存档，开始删除过程'),this.uiManager.showLoading('正在销毁典籍...');try{const o=await window.getLorebookEntries(this.worldBookName),a=this.findEntryByKey(o,e);a&&a.uid?(console.log(`找到存档条目，准备删除 UID=${a.uid}`),await window.deleteLorebookEntry(this.worldBookName,a.uid),await this.refreshSaveList(),this.uiManager.showNotification(`典籍"${t}"已成功销毁`,'success')):(console.error('找不到要删除的存档条目'),this.uiManager.showNotification('找不到指定的典籍记录','error'))}catch(e){console.error('删除存档过程中出错:',e),this.uiManager.showNotification('销毁典籍失败: '+(e instanceof Error?e.message:'未知错误'),'error')}finally{this.uiManager.hideLoading()}})}catch(e){console.error('删除存档过程出错:',e),this.uiManager.showNotification('销毁典籍失败','error')}}async getAllSaves(){try{if(this.worldBookName||await this.initializeChatLorebook(),!this.worldBookName||'function'!=typeof window.getLorebookEntries)return console.warn('世界书API不可用，无法获取存档'),{autoSaves:[],manualSaves:[]};const e=await this.getAllWorldBookEntries();if(!e||!Array.isArray(e)||0===e.length)return{autoSaves:[],manualSaves:[]};const t=e.filter(e=>this.checkEntryKeyStartsWith(e,this.SAVE_TYPE.AUTO)),o=e.filter(e=>this.checkEntryKeyStartsWith(e,this.SAVE_TYPE.MANUAL));console.log(`找到 ${t.length} 个自动存档和 ${o.length} 个手动存档`);const a=await Promise.all(t.map(e=>this.processSaveEntry(e,!0))),s=await Promise.all(o.map(e=>this.processSaveEntry(e,!1)));return{autoSaves:a.filter(e=>null!==e).sort((e,t)=>t.saveId-e.saveId),manualSaves:s.filter(e=>null!==e).sort((e,t)=>t.saveId-e.saveId)}}catch(e){return console.error('获取存档列表失败:',e),{autoSaves:[],manualSaves:[]}}}async processSaveEntry(e,t){try{if(!e||!e.key)return console.warn('无效的存档条目:',e),null;let o='';if(Array.isArray(e.key)&&e.key.length>0){const a=t?this.SAVE_TYPE.AUTO:this.SAVE_TYPE.MANUAL,s=e.key.find(e=>e&&'string'==typeof e&&e.startsWith(a));o=s||e.key[0]}else{if('string'!=typeof e.key)return console.warn('无效的键值类型:',e.key),null;o=e.key}const a=o.match(/(\d+)$/),s=a?parseInt(a[1],10):0,i={key:o,uid:e.uid,title:e.comment||(t?`自动记录点 #${s}`:`永久典籍 #${s}`),saveId:s,date:new Date(e.created_at||Date.now()).toLocaleString(),content:'',thumbnail:'',isAuto:t};try{let t='';if(e.content?t=e.content:'function'==typeof window.triggerSlash&&(t=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${o}`)),t)try{const e=JSON.parse(t);if(e.storySummary&&e.storySummary.length>0){const t=e.storySummary[e.storySummary.length-1];i.content=t.content,t.image&&(i.thumbnail=t.image)}}catch(e){console.warn('解析存档内容失败:',e)}}catch(e){console.warn('无法获取存档内容摘要:',e)}return i}catch(e){return console.error('处理存档数据出错:',e),null}}async loadGameFromKey(e){try{console.log('准备加载存档，key:',e),this.uiManager.showConfirmDialog('确定要加载此存档吗？当前游戏进度将丢失。',async()=>{console.log('用户确认加载存档，开始加载过程'),this.uiManager.showLoading('正在加载存档...');try{const t=await this.loadGameState(e);if(t){console.log('存档加载成功，准备关闭弹窗并更新游戏状态'),this.closeLoadGameModal(),console.log('触发gameloaded事件');const e=new CustomEvent('gameloaded',{detail:{gameData:t}});window.dispatchEvent(e),this.uiManager.showNotification('加载存档成功','success')}else console.error('加载游戏状态失败，gameData为null'),this.uiManager.showNotification('加载存档失败','error')}catch(e){console.error('加载存档处理过程中出错:',e),this.uiManager.showNotification('加载存档失败: '+(e instanceof Error?e.message:'未知错误'),'error')}finally{this.uiManager.hideLoading()}})}catch(e){console.error('加载存档过程出错:',e),this.uiManager.showNotification('加载存档失败','error')}}async saveGameState(e,t=!1,o){if(!e||!e.storySummary||0===e.storySummary.length)return console.warn('没有可保存的游戏状态'),!1;try{if(!this.worldBookName&&(console.log('世界书名称为空，重新初始化'),await this.initializeChatLorebook(),!this.worldBookName))return console.error('初始化世界书失败，无法保存游戏状态'),this.uiManager.showNotification('无法初始化世界书，保存失败','error'),!1;if('function'!=typeof window.getLorebookEntries)return console.error('世界书API不可用'),this.uiManager.showNotification('世界书API不可用，无法保存游戏状态','error'),!1;const a=t?this.SAVE_TYPE.MANUAL:this.SAVE_TYPE.AUTO,s=t?++this.currentMaxSaveId.manual:++this.currentMaxSaveId.auto,i=`${a}${s}`;let n='',r=e.story.dialogue.length,l=e.storySummary.length;if(t&&o)n=`${o} #${s} [对话:${r}条|记忆:${l}条]`;else if(t)n=`手动存档 #${s} [对话:${r}条|记忆:${l}条]`;else{const t=e.storySummary[e.storySummary.length-1];n=`自动存档 #${s}-${t.content.substring(0,30)+(t.content.length>30?'...':'')} [对话:${r}条|记忆:${l}条]`}await this.saveDialogueHistory(e);const c=JSON.stringify(e),h=(Date.now(),3),d=1e4;for(let e=0;e<h;e++)try{console.log(`获取世界书条目，尝试 ${e+1}/${h}`);const t=await window.getLorebookEntries(this.worldBookName),o=this.findEntryByKey(t,i),a=async e=>{const t=new Promise((e,t)=>{setTimeout(()=>t(new Error('操作超时')),d)});return Promise.race([e,t])};if(o){if(console.log(`存档 ${i} 已存在，将更新条目 uid=${o.uid}`),'number'!=typeof o.uid||isNaN(o.uid))throw new Error(`无效的UID: ${o.uid}`);const t={uid:o.uid,comment:n,content:c};try{if('function'==typeof window.setLorebookEntries){await a(window.setLorebookEntries(this.worldBookName,[t])),console.log(`成功更新条目 UID=${o.uid}`);break}if('function'==typeof window.editLorebookEntry){await a(window.editLorebookEntry(this.worldBookName,o.uid,{comment:n,content:c})),console.log(`成功更新条目 UID=${o.uid} (使用editLorebookEntry)`);break}{await a(window.deleteLorebookEntry(this.worldBookName,o.uid));const e=await a(window.createLorebookEntry(this.worldBookName,{key:[i],comment:n,content:c}));if(e>0){console.log(`成功删除旧条目并创建新条目 UID=${e}`);break}throw new Error(`创建新条目失败，返回的UID无效: ${e}`)}}catch(t){if(console.error(`更新条目尝试 ${e+1} 失败:`,t),!(e<h-1))throw t;console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500))}}else{console.log(`存档 ${i} 不存在，将创建新条目`);const t={key:[i],comment:n,content:c};try{let e=!1;if('function'==typeof window.createLorebookEntries){const o=await a(window.createLorebookEntries(this.worldBookName,[t]));o&&o.new_uids&&o.new_uids.length>0?(console.log(`成功创建新条目，UID=${o.new_uids[0]}`),e=!0):console.warn('createLorebookEntries返回结果无效，将尝试旧API')}if(!e&&'function'==typeof window.createLorebookEntry){const o=await a(window.createLorebookEntry(this.worldBookName,t));if(!(o>0))throw new Error(`创建条目失败，返回的UID无效: ${o}`);console.log(`成功创建新条目，UID=${o}`),e=!0}if(e)break;throw new Error('没有可用的API创建条目')}catch(t){if(console.error(`创建条目尝试 ${e+1} 失败:`,t),!(e<h-1))throw t;console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500))}}}catch(t){if(e===h-1)throw t}return t?this.currentMaxSaveId.manual=s:this.currentMaxSaveId.auto=s,console.log(`已成功保存游戏状态到世界书，包含 ${r} 条对话和 ${l} 条记忆`),!0}catch(e){return console.error('保存游戏状态到世界书失败:',e),this.uiManager.showNotification('保存游戏状态失败: '+(e instanceof Error?e.message:'未知错误'),'error'),!1}}async loadCompleteHistory(){try{if(this.cachedCompleteHistory)return this.cachedCompleteHistory;if(this.worldBookName||await this.initializeChatLorebook(),'function'!=typeof window.getLorebookEntries)return console.warn('世界书API不可用，无法加载完整历史记录'),null;const e=await window.getLorebookEntries(this.worldBookName);if(!e||!Array.isArray(e))return console.warn('未找到世界书条目'),null;const t=this.findEntryByKey(e,this.COMPLETE_HISTORY_KEY);if(!t){console.log('未找到完整历史记录条目，将创建新记录');const e={id:`history_${Date.now()}`,dialogues:[],memories:[]};return this.cachedCompleteHistory=e,e}let o='';if(t.content?o=t.content:'function'==typeof window.triggerSlash&&(o=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${this.COMPLETE_HISTORY_KEY}`)),!o){console.log('完整历史记录内容为空，将创建新记录');const e={id:`history_${Date.now()}`,dialogues:[],memories:[]};return this.cachedCompleteHistory=e,e}try{const e=JSON.parse(o);if(!e.id||!Array.isArray(e.dialogues)||!Array.isArray(e.memories))throw new Error('历史记录格式不正确');return console.log(`成功加载完整历史记录，包含 ${e.dialogues.length} 条对话和 ${e.memories.length} 条记忆`),this.cachedCompleteHistory=e,e}catch(e){console.error('解析完整历史记录失败:',e);const t={id:`history_${Date.now()}`,dialogues:[],memories:[]};return this.cachedCompleteHistory=t,t}}catch(e){return console.error('加载完整历史记录失败:',e),null}}async saveCompleteHistory(e){try{if(this.worldBookName||await this.initializeChatLorebook(),!this.worldBookName||'function'!=typeof window.getLorebookEntries)return console.warn('世界书API不可用，无法保存完整历史记录'),!1;const t=await window.getLorebookEntries(this.worldBookName),o=this.findEntryByKey(t,this.COMPLETE_HISTORY_KEY),a=`完整游戏历史记录 - 最后更新: ${(new Date).toLocaleString()}`,s=JSON.stringify(e);return o?('function'==typeof window.editLorebookEntry?await window.editLorebookEntry(this.worldBookName,o.uid,{comment:a,content:s}):(await window.deleteLorebookEntry(this.worldBookName,o.uid),await window.createLorebookEntry(this.worldBookName,{keys:[this.COMPLETE_HISTORY_KEY],comment:a,content:s})),console.log('更新了完整历史记录')):(await window.createLorebookEntry(this.worldBookName,{keys:[this.COMPLETE_HISTORY_KEY],comment:a,content:s}),console.log('创建了新的完整历史记录条目')),this.cachedCompleteHistory=e,!0}catch(e){return console.error('保存完整历史记录失败:',e),!1}}async saveDialogueHistory(e){if(!e.story||!e.story.dialogue)return console.warn('没有可保存的对话历史'),!1;try{let t=await this.loadCompleteHistory();t||(t={id:`history_${Date.now()}`,dialogues:[],memories:[]});const o=t.dialogues.length,a=e.story.dialogue.map(e=>({speaker:e.speaker,content:e.content,style:e.style}));if(o<a.length&&(t.dialogues=a,console.log(`更新对话历史：从 ${o} 条增加到 ${a.length} 条`)),e.storySummary&&e.storySummary.length>0){const o=new Set(t.memories.map(e=>e.id));for(const a of e.storySummary)o.has(a.id)||(t.memories.push({id:a.id,content:a.content}),o.add(a.id));console.log(`更新记忆历史：当前共有 ${t.memories.length} 条记忆`)}const s=await this.saveCompleteHistory(t);return await this.saveLegacyDialogueHistory(e,t),s}catch(e){return console.error('保存对话历史到世界书失败:',e),!1}}async saveLegacyDialogueHistory(e,t){try{if(this.worldBookName||await this.initializeChatLorebook(),!this.worldBookName||'function'!=typeof window.getLorebookEntries)return console.warn('世界书API不可用，无法保存旧版对话历史'),!1;const e=await window.getLorebookEntries(this.worldBookName),o=this.findEntryByKey(e,this.DIALOGUE_HISTORY_KEY);let a='';for(const e of t.dialogues)'玩家'===e.speaker?a+=`选择:${e.content};`:a+=`${e.speaker}:${e.content};`;for(const e of t.memories)(e.content.includes('穿越')||e.content.includes('回到'))&&(a+=`回到过去:${e.content};`);const s=`对话历史记录 - ${(new Date).toLocaleString()}`,i=`<log>${a}</log>`;try{return o?('function'==typeof window.editLorebookEntry?await window.editLorebookEntry(this.worldBookName,o.uid,{comment:s,content:i}):(await window.deleteLorebookEntry(this.worldBookName,o.uid),await window.createLorebookEntry(this.worldBookName,{keys:[this.DIALOGUE_HISTORY_KEY],comment:s,content:i})),console.log('更新了旧版对话历史记录')):(await window.createLorebookEntry(this.worldBookName,{keys:[this.DIALOGUE_HISTORY_KEY],comment:s,content:i}),console.log('创建了新的旧版对话历史记录条目')),!0}catch(e){return console.error('保存旧版对话历史失败:',e),!1}}catch(e){return console.error('保存旧版对话历史到世界书失败:',e),!1}}async getDialogueHistory(){try{const e=await this.loadCompleteHistory();if(e&&e.dialogues&&e.dialogues.length>0){console.log(`从完整历史记录中获取 ${e.dialogues.length} 条对话历史`);return e.dialogues.map(e=>({speaker:e.speaker,content:e.content,style:e.style||'normal'}))}if(console.log('未找到完整历史记录，尝试旧版格式'),this.worldBookName||await this.initializeChatLorebook(),'function'!=typeof window.getLorebookEntries)return console.warn('世界书API不可用，无法获取对话历史'),null;const t=await window.getLorebookEntries(this.worldBookName);if(!t||!Array.isArray(t)||0===t.length)return console.warn('没有找到世界书条目'),null;const o=this.findEntryByKey(t,this.DIALOGUE_HISTORY_KEY);if(!o)return console.warn('没有找到对话历史条目'),null;let a='';if(o.content)a=o.content;else if('function'==typeof window.triggerSlash){let e=this.DIALOGUE_HISTORY_KEY;Array.isArray(o.key)&&o.key.length>0?e=o.key[0]:'string'==typeof o.key&&(e=o.key),a=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${e}`)}if(!a)return console.warn('对话历史内容为空'),null;try{if(a.includes('<log>')&&a.includes('</log>')){const e=a.match(/<log>([\s\S]*?)<\/log>/);if(e&&e[1]){const t=e[1].split(';').filter(e=>e.trim().length>0),o=[];for(const e of t)if(e.includes(':')){const[t,a]=e.split(':',2);'选择'===t?o.push({speaker:'玩家',content:a,style:'normal'}):'回到过去'===t?o.push({speaker:'旁白',content:`【时间穿越：${a}】`,style:'special'}):o.push({speaker:t,content:a,style:'normal'})}return console.log(`从旧版格式读取了 ${o.length} 条对话历史`),o}}else try{const e=JSON.parse(a);if(Array.isArray(e))return console.log(`从JSON格式读取了 ${e.length} 条对话历史`),e}catch(e){console.warn('无法解析对话历史为JSON格式:',e)}}catch(e){console.error('解析对话历史内容失败:',e)}return null}catch(e){return console.error('获取对话历史失败:',e),null}}async loadGameState(e){for(let t=0;t<3;t++)try{if(!this.worldBookName&&(console.log('世界书名称为空，重新初始化'),await this.initializeChatLorebook(),!this.worldBookName))return console.error('初始化世界书失败，无法加载游戏状态'),this.uiManager.showNotification('无法初始化世界书，加载失败','error'),null;if('function'!=typeof window.getLorebookEntries)return console.error('世界书读取API不可用'),this.uiManager.showNotification('世界书API不可用，无法加载存档','error'),null;console.log(`获取世界书条目，尝试 ${t+1}/3`);const o=await window.getLorebookEntries(this.worldBookName),a=this.findEntryByKey(o,e);if(!a){if(console.warn(`找不到存档键 ${e}`),t<2){console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500));continue}return this.uiManager.showNotification('找不到指定存档','warning'),null}let s='';try{if(a.content)s=a.content,console.log('直接从条目获取到内容');else if('function'==typeof window.triggerSlash){let t=e;Array.isArray(a.key)&&a.key.length>0?t=a.key[0]:'string'==typeof a.key&&(t=a.key),console.log(`通过triggerSlash获取条目内容，key=${t}`),s=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${t}`),s&&console.log('通过triggerSlash成功获取内容')}if(!s){if(console.warn(`存档键 ${e} 对应的内容为空`),t<2){console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500));continue}return this.uiManager.showNotification('存档内容为空','warning'),null}try{console.log('解析存档内容...');const e=JSON.parse(s);if(e&&e.story)return e.story.currentDialogueIndex=0,console.log('成功解析存档内容，重置对话索引'),e;if(console.warn('解析的存档缺少必要数据'),t<2){console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500));continue}return this.uiManager.showNotification('存档数据不完整或格式错误','error'),null}catch(e){if(console.error('解析存档内容失败:',e),t<2){console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500));continue}return this.uiManager.showNotification('存档内容格式错误','error'),null}}catch(o){if(console.error(`获取存档 ${e} 内容失败:`,o),t<2){console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500));continue}return this.uiManager.showNotification('获取存档内容失败','error'),null}}catch(e){if(console.error(`加载游戏存档尝试 ${t+1} 失败:`,e),!(t<2))return this.uiManager.showNotification('加载存档失败: '+(e instanceof Error?e.message:'未知错误'),'error'),null;console.log('等待500ms后重试...'),await new Promise(e=>setTimeout(e,500))}return null}async loadGameStateByID(e,t=!1){const o=t?`${this.SAVE_TYPE.MANUAL}${e}`:`${this.SAVE_TYPE.AUTO}${e}`;return this.loadGameState(o)}async getCompleteHistory(){return this.loadCompleteHistory()}loadGame(){this.showLoadGameModal()}}const l=_;class c{defaultSettings={fontSize:'medium',uiMode:'adaptive',gameHeight:'auto'};currentSettings;onSettingsChangedCallback=null;SETTINGS_STORAGE_KEY='monastery_game_settings';constructor(){this.currentSettings=this.loadSettings(),this.applySettings(),console.log('设置管理器初始化完成')}loadSettings(){try{const e=localStorage.getItem(this.SETTINGS_STORAGE_KEY);if(e){const t=JSON.parse(e);return t.hasOwnProperty('useMobileUI')&&(t.uiMode=t.useMobileUI?'mobile':'desktop',delete t.useMobileUI),{...this.defaultSettings,...t}}}catch(e){console.error('加载设置失败:',e)}return{...this.defaultSettings}}saveSettings(){try{localStorage.setItem(this.SETTINGS_STORAGE_KEY,JSON.stringify(this.currentSettings))}catch(e){console.error('保存设置失败:',e)}}applySettings(){switch(document.documentElement.classList.remove('font-small','font-medium','font-large'),document.documentElement.classList.add(`font-${this.currentSettings.fontSize}`),document.documentElement.classList.remove('mobile-ui','desktop-ui'),this.currentSettings.uiMode){case'mobile':document.documentElement.classList.add('mobile-ui');break;case'desktop':document.documentElement.classList.add('desktop-ui')}const e=document.querySelector('.game-container');e&&('auto'===this.currentSettings.gameHeight?e.style.height='':e.style.height=`${this.currentSettings.gameHeight}px`),console.log('已应用设置:',this.currentSettings)}updateSettings(e){this.currentSettings={...this.currentSettings,...e},this.saveSettings(),this.applySettings(),this.onSettingsChangedCallback&&this.onSettingsChangedCallback(this.currentSettings)}setFontSize(e){this.updateSettings({fontSize:e})}setUIMode(e){this.updateSettings({uiMode:e})}setGameHeight(e){this.updateSettings({gameHeight:e})}getSettings(){return{...this.currentSettings}}resetSettings(){this.currentSettings={...this.defaultSettings},this.saveSettings(),this.applySettings(),this.onSettingsChangedCallback&&this.onSettingsChangedCallback(this.currentSettings)}setOnSettingsChanged(e){this.onSettingsChangedCallback=e}showSettingsDialog(){const e=`\n      <div id="settings-dialog" class="modal fade">\n        <div class="modal-dialog modal-dialog-centered monastery-dialog">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title"><i class="fas fa-cog"></i> 游戏设置</h5>\n              <button type="button" class="close" data-dismiss="modal">&times;</button>\n            </div>\n            <div class="modal-body">\n              <div class="form-group monastery-form-group">\n                <label for="font-size-select" class="monastery-label">\n                  <i class="fas fa-font"></i> 字体大小\n                </label>\n                <select id="font-size-select" class="form-control monastery-select">\n                  <option value="small" ${'small'===this.currentSettings.fontSize?'selected':''}>小</option>\n                  <option value="medium" ${'medium'===this.currentSettings.fontSize?'selected':''}>中</option>\n                  <option value="large" ${'large'===this.currentSettings.fontSize?'selected':''}>大</option>\n                </select>\n              </div>\n              <div class="form-group monastery-form-group">\n                <label for="ui-mode-select" class="monastery-label">\n                  <i class="fas fa-mobile-alt"></i> 界面模式\n                </label>\n                <select id="ui-mode-select" class="form-control monastery-select">\n                  <option value="adaptive" ${'adaptive'===this.currentSettings.uiMode?'selected':''}>自适应</option>\n                  <option value="mobile" ${'mobile'===this.currentSettings.uiMode?'selected':''}>手机</option>\n                  <option value="desktop" ${'desktop'===this.currentSettings.uiMode?'selected':''}>电脑</option>\n                </select>\n                <small class="form-text text-muted monastery-help-text">自适应: 根据屏幕大小自动调整; 手机/电脑: 强制使用对应界面</small>\n              </div>\n              <div class="form-group monastery-form-group">\n                <label for="game-height-mode" class="monastery-label">\n                  <i class="fas fa-arrows-alt-v"></i> 游戏界面高度\n                </label>\n                <div class="custom-control custom-switch mb-2">\n                  <input type="checkbox" class="custom-control-input" id="height-custom-switch" ${'auto'!==this.currentSettings.gameHeight?'checked':''}>\n                  <label class="custom-control-label" for="height-custom-switch">自定义高度</label>\n                </div>\n                <div id="custom-height-container" class="mt-2 ${'auto'===this.currentSettings.gameHeight?'d-none':''}">\n                  <div class="input-group">\n                    <input \n                      type="number" \n                      id="game-height-input" \n                      class="form-control monastery-input" \n                      value="${'auto'===this.currentSettings.gameHeight?1e3:this.currentSettings.gameHeight}" \n                      min="500" \n                      max="2000" \n                      step="50" \n                    />\n                    <div class="input-group-append">\n                      <span class="input-group-text">px</span>\n                    </div>\n                  </div>\n                  <small class="form-text text-muted monastery-help-text">推荐值: 1000px（可根据屏幕大小调整）</small>\n                </div>\n              </div>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-secondary monastery-btn monastery-btn-secondary" id="reset-settings-btn">\n                <i class="fas fa-undo"></i> 恢复默认\n              </button>\n              <button type="button" class="btn btn-primary monastery-btn monastery-btn-primary" id="save-settings-btn">\n                <i class="fas fa-check"></i> 保存设置\n              </button>\n              <button type="button" class="btn btn-secondary monastery-btn monastery-btn-cancel" data-dismiss="modal">\n                <i class="fas fa-times"></i> 取消\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;$('body').append(e),$('#height-custom-switch').on('change',function(){$(this).is(':checked')?$('#custom-height-container').removeClass('d-none'):$('#custom-height-container').addClass('d-none')}),$('#save-settings-btn').on('click',()=>{const e=$('#font-size-select').val(),t=$('#ui-mode-select').val();let o='auto';if($('#height-custom-switch').is(':checked')){const e=$('#game-height-input').val();o=l.clamp(l.parseInt(e)||1e3,500,2e3)}this.updateSettings({fontSize:e,uiMode:t,gameHeight:o}),$('#settings-dialog').modal('hide')}),$('#reset-settings-btn').on('click',()=>{confirm('确定要恢复默认设置吗？')&&(this.resetSettings(),$('#font-size-select').val(this.defaultSettings.fontSize),$('#ui-mode-select').val(this.defaultSettings.uiMode),$('#height-custom-switch').prop('checked','auto'!==this.defaultSettings.gameHeight),'auto'===this.defaultSettings.gameHeight?$('#custom-height-container').addClass('d-none'):($('#custom-height-container').removeClass('d-none'),$('#game-height-input').val(this.defaultSettings.gameHeight)))}),$('#settings-dialog').modal('show').data('backdrop','static').data('keyboard',!1),$('#settings-dialog').on('hidden.bs.modal',function(){$(this).remove()})}}class h{currentConfirmCallback=null;constructor(){toastr.options={closeButton:!0,progressBar:!0,positionClass:'toast-top-right',preventDuplicates:!1,timeOut:3e3},console.log('UI管理器初始化完成')}showLoading(e='加载中...'){$('.loading-text').text(e),$('.loading-indicator').removeClass('hidden')}hideLoading(){$('.loading-indicator').addClass('hidden')}showConfirmDialog(e,t){this.currentConfirmCallback=t,console.log('显示确认对话框:',e),$('#confirm-message').text(e),$('#confirm-container').removeClass('hidden'),$('#confirm-yes').off('click').on('click',()=>this.handleConfirmYes()),$('#confirm-no').off('click').on('click',()=>this.hideConfirmDialog()),$(document).on('click.confirm-outside',e=>{0!==$(e.target).closest('.confirm-dialog').length||$('#confirm-container').hasClass('hidden')||this.hideConfirmDialog()})}hideConfirmDialog(){$('#confirm-container').addClass('hidden'),$(document).off('click.confirm-outside'),this.currentConfirmCallback=null}handleConfirmYes(){this.currentConfirmCallback&&this.currentConfirmCallback(),this.hideConfirmDialog()}showNotification(e,t='info',o=3e3){switch(toastr.options.timeOut=o,t){case'success':toastr.success(e);break;case'warning':toastr.warning(e);break;case'error':toastr.error(e);break;default:toastr.info(e)}}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}showTooltip(e,t){$(e).attr('title',t).tooltip({content:t,position:{my:'center bottom',at:'center top-5'},show:{effect:'fadeIn',duration:200},hide:{effect:'fadeOut',duration:200}}).tooltip('open'),setTimeout(()=>{$(e).tooltip('close')},2e3)}showInputDialog(e,t,o){$('#input-dialog').length>0&&$('#input-dialog').remove();const a=`\n      <div id="input-dialog" class="modal fade">\n        <div class="modal-dialog modal-dialog-centered monastery-dialog">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title"><i class="fas fa-feather-alt"></i> ${e}</h5>\n              <button type="button" class="close" data-dismiss="modal">&times;</button>\n            </div>\n            <div class="modal-body">\n              <div class="input-dialog-container">\n                <label for="input-dialog-value" class="monastery-label">为您的记录命名：</label>\n                <input type="text" id="input-dialog-value" class="form-control monastery-input" value="${t}">\n              </div>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-primary monastery-btn monastery-btn-primary" id="input-dialog-confirm">\n                <i class="fas fa-save"></i> 确定\n              </button>\n              <button type="button" class="btn btn-secondary monastery-btn monastery-btn-secondary" data-dismiss="modal">\n                <i class="fas fa-times"></i> 取消\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;$('body').append(a),$('#input-dialog-confirm').on('click',()=>{const e=$('#input-dialog-value').val();$('#input-dialog').modal('hide'),o(e)}),$('#input-dialog-value').on('keypress',e=>{13===e.which&&$('#input-dialog-confirm').click()}),$('#input-dialog').modal('show'),$('#input-dialog-value').focus()}}class d{characters=new Map;constructor(){console.log('角色资源服务已初始化'),this.initializeCharacters()}initializeCharacters(){this.characters.set('cecilia',{id:'cecilia',name:'Cecilia修女',fullName:'Sister Cecilia',position:'right',emotions:{default:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%BE%AE%E7%AC%91.png?ref_type=heads',smile:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%BE%AE%E7%AC%91.png?ref_type=heads',sad:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%93%AD%E6%B3%A3.png?ref_type=heads',shocked:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E6%83%8A%E8%AE%B6.png?ref_type=heads',blush:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%AE%B3%E7%BE%9E.png?ref_type=heads'},bio:'一位年轻的见习修女，专注于抄写工作，对草药学有浓厚兴趣。'}),this.characters.set('player',{id:'player',name:'{{user}}',fullName:'The Visitor',position:'left',emotions:{default:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E9%BB%98%E8%AE%A4.png?ref_type=heads',smile:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%BE%AE%E7%AC%91.png?ref_type=heads',sad:'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%93%AD%E6%B3%A3.png?ref_type=heads'},bio:'一位到访修道院的神秘人物，对修道院的历史和草药学表示了浓厚兴趣。'})}getCharacter(e){return this.characters.get(e)}getAllCharacterIds(){return Array.from(this.characters.keys())}getCharacterEmotionUrl(e,t='default'){const o=this.characters.get(e);if(o)return o.emotions[t]||o.emotions.default}getCharacterName(e){const t=this.characters.get(e);return t?t.name:'未知角色'}addCharacter(e){return this.characters.has(e.id)?(console.warn(`角色ID: ${e.id} 已存在，无法添加`),!1):(this.characters.set(e.id,e),!0)}updateCharacter(e,t){const o=this.characters.get(e);if(!o)return console.warn(`角色ID: ${e} 不存在，无法更新`),!1;const a=_.merge({},o,t);return this.characters.set(e,a),!0}}class u{defaultGameData={story:{date:'1243年 夏',location:'修道院',scene:'图书室',dialogue:[{speaker:'Cecilia修女',content:'欢迎来到修道院，这里是我们的图书室。',style:'normal',portrait:{character:'cecilia',emotion:'smile'},background:{location:'修道院',scene:'图书室'}},{speaker:'玩家',content:'谢谢你的接待，这里的藏书真是令人惊叹。',style:'normal',portrait:{character:'player',emotion:'default'}},{speaker:'旁白',content:'Cecilia修女微笑着拿起一本古老的书籍。',style:'special'},{speaker:'Cecilia修女',content:'这本是我们修道院最珍贵的草药学手稿，记载了很多珍贵的药方。',style:'normal',portrait:{character:'cecilia',emotion:'thoughtful'}},{speaker:'图书管理员',content:'午餐时间到了，请各位移步餐厅。',style:'normal'},{speaker:'Cecilia修女',content:'不如我们去花园里继续聊吧？',style:'normal',portrait:{character:'cecilia',emotion:'smile'},background:{location:'修道院',scene:'花园'}}],options:['好的，我很乐意。','我想先了解更多关于那本草药手稿的内容。','我需要先休息一下，稍后再聊。'],currentDialogueIndex:0,currentChapter:'第一章：修道院的秘密',currentFunds:50},storySummary:[{id:1,content:'玩家来到修道院，与Cecilia修女在图书室相遇，得知了一本珍贵的草药学手稿。',timestamp:(new Date).toISOString()}]};constructor(){console.log('游戏数据服务已初始化')}async loadGameData(){return this.defaultGameData}async saveGameData(e){console.log('游戏数据已保存')}}class g{lastRawResponse='';constructor(){console.log('游戏状态生成服务已初始化')}getLastRawResponse(){return this.lastRawResponse}async generateNextGameState(e){if('function'!=typeof window.generate)return console.warn('generate API不可用'),null;try{const t={user_input:e,should_stream:!1,injects:[{role:'system',content:`<选择>${e}</选择>`,position:'before_prompt',depth:0,should_scan:!1}]},o=await window.generate(t);this.lastRawResponse=o,console.log('%c[LLM完整响应]','color: #ff5722; font-weight: bold;'),console.log(o);const a=/<gametext>([\s\S]*?)<\/gametext>/,s=o.match(a);if(!s||!s[1])return console.error('未找到<gametext>标签或内容为空'),null;try{const e=s[1].trim();console.log('%c[找到游戏状态JSON]','color: #4caf50; font-weight: bold;'),console.log(e);return JSON.parse(e)}catch(e){console.error('解析游戏数据JSON失败:',e);const t=s[1].trim();return console.log('%c[解析JSON失败]','color: #f44336; font-weight: bold;',t),null}}catch(e){return console.error('生成游戏状态失败:',e),null}}async generateMemoryState(e){if('function'!=typeof window.generate)return console.warn('generate API不可用'),null;try{const t=`<时间跳跃>${e.content}</时间跳跃>`,o=await window.generate({user_input:`穿越到记忆点"${e.content}"`,should_stream:!1,injects:[{role:'system',content:t,position:'before_prompt',depth:0,should_scan:!1}]});this.lastRawResponse=o,console.log('%c[LLM记忆点响应]','color: #ff9800; font-weight: bold;'),console.log(o);const a=/<gametext>([\s\S]*?)<\/gametext>/,s=o.match(a);if(s&&s[1])try{const e=s[1].trim();console.log('%c[找到记忆点游戏状态JSON]','color: #4caf50; font-weight: bold;'),console.log(e);return JSON.parse(e)}catch(e){console.error('解析记忆点游戏数据JSON失败:',e);const t=s[1].trim();return console.log('%c[解析记忆点JSON失败]','color: #f44336; font-weight: bold;',t),null}}catch(e){console.error('生成记忆点游戏状态失败:',e)}return null}async handleCustomAction(e){if('function'!=typeof window.generate)return console.warn('generate API不可用'),null;try{const t=`<自定义行动>${e}</自定义行动>`,o=await window.generate({user_input:e,should_stream:!1,injects:[{role:'system',content:t,position:'before_prompt',depth:0,should_scan:!1}]});this.lastRawResponse=o,console.log('%c[LLM自定义行动响应]','color: #2196f3; font-weight: bold;'),console.log(o);const a=/<gametext>([\s\S]*?)<\/gametext>/,s=o.match(a);if(s&&s[1])try{const e=s[1].trim();console.log('%c[找到自定义行动游戏状态JSON]','color: #4caf50; font-weight: bold;'),console.log(e);return JSON.parse(e)}catch(e){console.error('解析自定义行动游戏数据JSON失败:',e);const t=s[1].trim();return console.log('%c[解析自定义行动JSON失败]','color: #f44336; font-weight: bold;',t),null}}catch(e){console.error('处理自定义行动失败:',e)}return null}initDebugHelpers(){window.debugLLMResponse=()=>{console.log('%c[Debug] 最后一次LLM响应','background: #222; color: #bada55'),console.log(this.lastRawResponse);const e=this.lastRawResponse.match(/<gametext>([\s\S]*?)<\/gametext>/);if(e&&e[1]){console.log('%c[Debug] 提取的gametext内容','background: #222; color: #ffa500'),console.log(e[1]);try{const t=JSON.parse(e[1]);console.log('%c[Debug] 解析后的JSON对象','background: #222; color: #4caf50'),console.log(t)}catch(e){console.log('%c[Debug] JSON解析失败','background: #222; color: #f44336'),console.log(e)}}else console.log('%c[Debug] 未找到gametext标签','background: #222; color: #f44336');return'调试信息已输出到控制台'}}}class m{gameData=null;gameDataService;gameStateGenerationService;characterResourceService;dialogueManager;characterManager;backgroundManager;choiceManager;memoryManager;memoryUIManager;uiManager;saveManager;journalManager;settingsManager;constructor(){this.gameDataService=new u,this.gameStateGenerationService=new g,this.characterResourceService=new d,this.uiManager=new h,this.saveManager=new r(this.uiManager),this.backgroundManager=new e,this.characterManager=new t(this.characterResourceService),this.dialogueManager=new a(this.characterResourceService,this.characterManager,this.backgroundManager),this.choiceManager=new o,this.memoryManager=new i,this.journalManager=new s,this.memoryUIManager=new n(this.memoryManager,this.saveManager,this.uiManager,this.gameStateGenerationService),this.settingsManager=new c,this.gameStateGenerationService.initDebugHelpers(),console.log('调试辅助功能已初始化，请在控制台使用 window.debugLLMResponse() 查看最近一次LLM响应'),this.init()}async init(){console.log('初始化游戏界面...'),this.registerEventListeners(),await this.loadGameData(),this.updateUI(),this.initDebugFunctions(),console.log('游戏界面初始化完成!')}initDebugFunctions(){window.testConfirmDialog=()=>{console.log('测试确认对话框'),window.confirmTestCount||(window.confirmTestCount=0),window.confirmTestCount++,this.uiManager.showConfirmDialog(`这是一个测试确认对话框 #${window.confirmTestCount}，用于检查位置和点击功能。请点击"确认"按钮测试是否可点击。`,()=>{console.log('确认对话框被确认'),this.uiManager.showNotification(`确认对话框 #${window.confirmTestCount} 测试成功!`,'success')})},console.log('调试功能已初始化，可在控制台使用 window.testConfirmDialog() 测试确认对话框')}registerEventListeners(){$('.tab-button').on('click',e=>{const t=$(e.currentTarget).data('tab');t&&this.switchTab(t)}),$('.journal-nav-item').on('click',e=>{const t=$(e.currentTarget).data('section');t&&this.journalManager.switchJournalSection(t)}),$('#save-game').on('click',()=>{this.saveGame()}),$('#load-game').on('click',()=>{this.loadGame()}),$('#settings-button').on('click',()=>{this.showSettings()}),$('#save-memory').on('click',()=>{const e=this.memoryUIManager.saveMemory();e&&this.gameData&&this.gameData.storySummary.push(e)}),$('#travel-memory').on('click',()=>{this.memoryUIManager.travelToMemory(()=>{this.gameData=this.memoryUIManager.getGameData(),this.updateUI(),this.switchTab('story-tab')})}),$('#dialogue-history').on('click',()=>{this.showDialogueHistory()}),$(document).on('click','.choice-button',e=>{const t=$(e.currentTarget).data('choice');this.makeChoice(t)}),window.addEventListener('request_game_data',e=>{if(e.detail&&'function'==typeof e.detail.callback){const t={story:this.gameData?.story||{date:'未知日期',location:'未知位置',scene:'未知场景',dialogue:[],options:[],currentDialogueIndex:0,currentChapter:'第1章',currentFunds:0},storySummary:this.gameData?.storySummary||[]};e.detail.callback(t)}}),window.addEventListener('gameloaded',e=>{e.detail&&e.detail.gameData&&(this.gameData=e.detail.gameData,this.updateUI(),this.switchTab('story-tab'),this.uiManager.showNotification('游戏已加载','success'))}),$('#dialogue-container').on('click',e=>{$(e.target).closest('.dialogue-controls').length||(this.choiceManager.canReshowChoices()?this.choiceManager.reshowChoices():this.nextDialogue())}),this.choiceManager.setOnChoiceSelected(e=>{this.makeChoice(e)})}async loadGameData(){try{this.gameData=await this.gameDataService.loadGameData(),this.journalManager.setGameData(this.gameData),this.memoryUIManager.setGameData(this.gameData)}catch(e){console.error('加载游戏数据失败:',e)}}switchTab(e){$('.tab-button').removeClass('active'),$('.tab-pane').removeClass('active'),$(`[data-tab="${e}"]`).addClass('active'),$(`#${e}`).addClass('active'),'memory-tab'===e&&this.memoryUIManager.refreshMemoryTimeline(),'journal-tab'===e&&this.journalManager.refreshJournalContent()}async showDialogueHistory(){const e=await this.saveManager.getDialogueHistory();e&&this.dialogueManager.showDialogueHistory(e)}showSettings(){console.log('显示设置'),this.settingsManager.showSettingsDialog()}saveGame(){console.log('保存游戏...'),this.uiManager.showInputDialog('请输入典籍标题','当前进度记录',async e=>{try{this.uiManager.showLoading('正在记录典籍...');await this.saveManager.saveGameState(this.gameData,!0,e)&&this.uiManager.showNotification('典籍记录成功','success')}catch(e){console.error('保存游戏失败:',e),this.uiManager.showNotification('典籍记录失败','error')}finally{this.uiManager.hideLoading()}})}loadGame(){console.log('加载游戏...'),this.saveManager.loadGame()}updateUI(){if(this.gameData)try{$('#game-date').text(this.gameData.story.date),this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.dialogueManager.renderDialogue(this.gameData.story.currentDialogueIndex),this.backgroundManager.setBackground(this.gameData.story.location,this.gameData.story.scene),this.choiceManager.setChoices(this.gameData.story.options),$('#memory-tab').hasClass('active')&&this.memoryUIManager.refreshMemoryTimeline(),$('#journal-tab').hasClass('active')&&this.journalManager.refreshJournalContent(),console.log('UI已更新')}catch(e){console.error('更新UI时发生错误:',e)}else console.error('无法更新UI：游戏数据不存在')}nextDialogue(){if(!this.gameData)return;if(this.dialogueManager.showNextDialogue())this.gameData.story.currentDialogueIndex=this.dialogueManager.getCurrentDialogueIndex();else if(this.gameData.story.options.length>0){const e=this.dialogueManager.isDialogueFinished(),t=this.choiceManager.areChoicesVisible();e&&!t?(console.log('对话已结束，显示选项'),this.choiceManager.showChoices()):t&&console.log('选项已显示，不再重复显示')}else console.log('对话结束，且没有可用选项')}async makeChoice(e){if(!this.gameData)return;console.log(`玩家选择了: ${e}`);const t=!this.gameData.story.options.includes(e);this.choiceManager.hideChoices(),this.uiManager.showLoading('正在生成回应...');const o=this.gameData.story.dialogue.length,a=this.gameData.story.currentDialogueIndex,s={speaker:'玩家',content:e,style:'normal'};this.gameData.story.dialogue.push(s),this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.gameData.story.currentDialogueIndex=this.gameData.story.dialogue.length-1,this.dialogueManager.showDialogue(this.gameData.story.currentDialogueIndex);try{const s=t?await this.gameStateGenerationService.handleCustomAction(e):await this.gameStateGenerationService.generateNextGameState(e);s?(this.gameData=s,this.updateUI(),await this.saveManager.saveGameState(this.gameData)):this.gameData&&(this.gameData.story.dialogue=this.gameData.story.dialogue.slice(0,o),this.gameData.story.currentDialogueIndex=a,this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.dialogueManager.showDialogue(this.gameData.story.currentDialogueIndex),this.choiceManager.showChoices(),this.uiManager.showNotification('生成游戏状态失败，请重新选择','warning'))}catch(e){console.error('处理玩家选择时出错:',e),this.gameData&&(this.gameData.story.dialogue=this.gameData.story.dialogue.slice(0,o),this.gameData.story.currentDialogueIndex=a,this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.dialogueManager.showDialogue(this.gameData.story.currentDialogueIndex),this.choiceManager.showChoices(),this.uiManager.showNotification('生成响应时出错，请重新选择','error'))}finally{this.uiManager.hideLoading()}}}$(document).ready(()=>{new m});</script></body></html>