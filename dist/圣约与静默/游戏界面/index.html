<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/><meta name="theme-color" content="#2a2a2a"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/><title>修道院箱庭 - 百合恋爱文字冒险</title><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/><link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/><script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script><style>:root{--color-primary: #8a6d3b;--color-secondary: #a85832;--color-tertiary: #5d6e41;--color-bg-dark: #2a2a2a;--color-bg-light: #333333;--color-bg-lighter: #3c3c3c;--color-text-primary: #d1d1d1;--color-text-secondary: #888888;--color-text-whisper: #a8c5e9;--color-text-shocked: #e9a8a8;--color-text-special: #d6c8a4;--color-memory-primary: #c99e51;--color-memory-secondary: #9c7f46;--color-memory-highlight: #e4c987;--color-memory-bg: #2e2a25;--color-save-primary: #9e8148;--color-save-secondary: #b29656;--color-save-highlight: #d5b978;--color-save-bg: #2d2a24;--color-save-delete: #a85832;--font-heading: "Cinzel", serif;--font-body: "Lato", sans-serif;--header-height: 60px;--tab-height: 40px;--dialogue-height: 200px;--border-radius: 6px;--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 16px;--spacing-lg: 24px;--spacing-xl: 32px;--transition-fast: 0.2s;--transition-normal: 0.3s;--transition-slow: 0.5s;--z-background: 1;--z-characters: 2;--z-dialogue: 3;--z-choices: 4;--z-header: 5;--z-sidebar: 10;--z-modal: 20;--font-size-base: 1rem;--font-size-small: 0.9rem;--font-size-large: 1.1rem}*{margin:0;padding:0;box-sizing:border-box}html{height:100%}button{cursor:pointer;font-family:inherit;background:none;border:none;color:inherit}button:focus{outline:none}ul{list-style:none}.hidden{display:none !important}.game-container{position:relative;width:100%;display:flex;flex-direction:column;overflow:hidden;background-color:var(--color-bg-dark);z-index:1}.game-header{height:var(--header-height);min-height:var(--header-height);background-color:rgba(20,20,20,.9);border-bottom:1px solid var(--color-primary);display:flex;justify-content:space-between;align-items:center;padding:0 var(--spacing-md);z-index:var(--z-header)}.header-left,.header-right{display:flex;align-items:center;gap:var(--spacing-md)}.game-title{font-family:var(--font-heading);font-size:1.5rem;color:var(--color-primary);margin-left:var(--spacing-md)}.game-date{font-family:var(--font-heading);font-size:.9rem;color:var(--color-text-secondary)}.game-controls{display:flex;align-items:center;gap:var(--spacing-sm)}.icon-button{background:none;border:none;font-size:1.5rem;color:var(--color-text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;transition:background-color var(--transition-fast),color var(--transition-fast)}.icon-button:hover{background-color:hsla(0,0%,100%,.1)}.icon-button.small{font-size:1rem;width:28px;height:28px}.icon-button.gold{color:var(--color-primary)}.icon-button.gold:hover{background-color:rgba(138,109,59,.2)}.content-wrapper{display:flex;flex-direction:column;position:relative;flex:1;overflow:hidden}.tab-navigation{display:flex;height:var(--tab-height);min-height:var(--tab-height);background-color:rgba(20,20,20,.9);border-bottom:1px solid var(--color-primary)}.tab-button{padding:0 var(--spacing-lg);height:100%;display:flex;align-items:center;gap:var(--spacing-sm);color:var(--color-text-secondary);font-family:var(--font-heading);border-bottom:3px solid rgba(0,0,0,0);transition:all var(--transition-fast)}.tab-button i{font-size:1rem}.tab-button:hover{color:var(--color-text-primary);background-color:hsla(0,0%,100%,.05)}.tab-button.active{color:var(--color-primary);border-bottom-color:var(--color-primary)}.tab-content{position:relative;aspect-ratio:16/9;overflow:hidden}.tab-pane{position:absolute;top:0;left:0;width:100%;height:100%;display:none;overflow:hidden;z-index:1}.tab-pane.active{display:flex;flex-direction:column;z-index:2}#story-tab{position:relative;overflow:hidden;display:flex;flex-direction:column}.background-container{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;z-index:var(--z-background);transition:opacity var(--transition-slow)}.characters-container{position:absolute;bottom:0;left:0;width:100%;height:100%;z-index:var(--z-characters);display:flex;justify-content:space-between}.character-left,.character-right{height:100%;width:40%;background-size:contain;background-position:bottom;background-repeat:no-repeat;transition:transform var(--transition-normal),opacity var(--transition-normal)}.character-left{transform-origin:bottom left}.character-right{transform-origin:bottom right}.dialogue-container{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:900px;height:var(--dialogue-height);background-color:rgba(20,20,20,.85);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid var(--color-primary);border-radius:var(--border-radius);z-index:var(--z-dialogue);display:flex;flex-direction:column;box-shadow:0 5px 15px rgba(0,0,0,.3);cursor:pointer}.dialogue-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-sm) var(--spacing-md);border-bottom:1px solid rgba(138,109,59,.3);background-color:rgba(0,0,0,.2)}.speaker-name{font-family:var(--font-heading);font-size:1.125rem;color:var(--color-primary);text-shadow:0 1px 2px rgba(0,0,0,.5)}.dialogue-controls{display:flex;gap:var(--spacing-sm)}.dialogue-content{flex:1;padding:var(--spacing-md);overflow-y:auto;font-size:1rem;line-height:1.6}.dialogue-text{margin-bottom:var(--spacing-md)}.dialogue-text.style-normal{color:var(--color-text-primary)}.dialogue-text.style-whisper{color:var(--color-text-whisper);font-style:italic}.dialogue-text.style-shocked{color:var(--color-text-shocked)}.dialogue-text.style-special{color:var(--color-text-special);font-weight:500}.choices-container{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:70%;max-width:650px;background-color:rgba(20,20,20,.85);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid var(--color-primary);border-radius:var(--border-radius);z-index:var(--z-choices);padding:var(--spacing-sm);display:flex;flex-direction:column;gap:var(--spacing-sm);box-shadow:0 5px 15px rgba(0,0,0,.5)}.choices-container.compact-choices{width:60%;max-width:500px;padding:var(--spacing-xs)}.choices-header{padding-bottom:var(--spacing-xs);margin-bottom:var(--spacing-xs);border-bottom:1px solid rgba(138,109,59,.3);display:flex;justify-content:space-between;align-items:center}.choices-header h3{font-family:var(--font-heading);font-size:1rem;color:var(--color-primary);margin:0;text-align:left}.compact-choices .choices-header{margin-bottom:0;padding-bottom:var(--spacing-xs)}.compact-choices .choices-header h3{font-size:.9rem}.preset-choices{display:flex;flex-direction:column;gap:0}.choice-button{background-color:rgba(0,0,0,0);border:none;border-radius:0;padding:var(--spacing-sm) var(--spacing-md);text-align:left;color:var(--color-text-primary);font-size:.95rem;transition:background-color var(--transition-fast),color var(--transition-fast);position:relative;overflow:hidden}.choice-button::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);height:0;width:3px;background-color:var(--color-primary);transition:height var(--transition-fast)}.choice-button:hover{background-color:hsla(0,0%,100%,.05);color:var(--color-primary)}.choice-button:hover::before{height:70%}.compact-choices .choice-button{padding:var(--spacing-xs) var(--spacing-md)}.custom-choice{display:flex;gap:var(--spacing-xs);margin-top:var(--spacing-xs);align-items:center;height:32px;border-top:1px solid rgba(138,109,59,.2);padding-top:var(--spacing-xs)}.custom-choice input{flex:1;background-color:hsla(0,0%,100%,.03);border:none;border-bottom:1px solid rgba(138,109,59,.3);border-radius:0;padding:4px var(--spacing-sm);color:var(--color-text-primary);font-size:.95rem;height:100%;box-sizing:border-box;transition:all var(--transition-fast);position:relative}.custom-choice input:focus{outline:none;border-bottom-color:var(--color-primary);background-color:hsla(0,0%,100%,.05);color:var(--color-primary)}.custom-choice input::placeholder{color:var(--color-text-secondary);opacity:.7}.compact-choices .custom-choice input{padding:2px var(--spacing-sm)}.custom-choice button{background-color:rgba(0,0,0,0);color:var(--color-text-secondary);padding:0 var(--spacing-md);border:none;border-radius:0;border-bottom:1px solid rgba(138,109,59,.3);transition:all var(--transition-fast);font-size:.95rem;height:100%;white-space:nowrap;position:relative}.custom-choice button::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);height:0;width:2px;background-color:var(--color-primary);transition:height var(--transition-fast)}.custom-choice button:hover{background-color:hsla(0,0%,100%,.05);color:var(--color-primary);border-bottom-color:var(--color-primary)}.custom-choice button:hover::before{height:70%}.compact-choices .custom-choice button{padding:0 var(--spacing-sm)}.choices-header .icon-button.small{width:24px;height:24px;border-radius:50%;display:flex;justify-content:center;align-items:center;color:var(--color-text-secondary);transition:background-color var(--transition-fast),color var(--transition-fast)}.choices-header .icon-button.small:hover{background-color:hsla(0,0%,100%,.1);color:var(--color-text-primary)}.journal-container{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--color-bg-light)}.journal-nav{display:flex;gap:var(--spacing-md);padding:var(--spacing-md);background-color:rgba(20,20,20,.8);border-bottom:1px solid var(--color-tertiary)}.journal-nav-item{padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius);color:var(--color-text-secondary);transition:all var(--transition-fast);display:flex;align-items:center;gap:var(--spacing-sm)}.journal-nav-item i{font-size:1rem}.journal-nav-item:hover{color:var(--color-text-primary);background-color:hsla(0,0%,100%,.05)}.journal-nav-item.active{color:var(--color-tertiary);background-color:rgba(93,110,65,.2)}.journal-content{flex:1;padding:var(--spacing-md);overflow-y:auto}.journal-section{display:none;height:100%}.journal-section.active{display:flex}#characters-section{display:flex;gap:var(--spacing-lg)}.character-cards{width:30%;display:flex;flex-direction:column;gap:var(--spacing-md);overflow-y:auto}.character-card{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-md);background-color:var(--color-bg-lighter);border-radius:var(--border-radius);cursor:pointer;transition:all var(--transition-fast)}.character-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.2)}.character-card.active{border-left:3px solid var(--color-tertiary)}.character-avatar{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--color-tertiary)}.character-info{flex:1}.character-name{font-size:1.1rem;font-weight:bold;margin-bottom:var(--spacing-xs)}.character-role{font-size:.9rem;color:var(--color-text-secondary)}.character-details{flex:1;padding:var(--spacing-lg);background-color:var(--color-bg-lighter);border-radius:var(--border-radius);display:flex;flex-direction:column;gap:var(--spacing-lg)}.monastery-info{padding:var(--spacing-lg);background-color:var(--color-bg-lighter);border-radius:var(--border-radius)}#knowledge-section{display:flex;gap:var(--spacing-lg)}.knowledge-categories{width:30%;display:flex;flex-direction:column;gap:var(--spacing-sm);overflow-y:auto}.knowledge-category{padding:var(--spacing-md);background-color:var(--color-bg-lighter);border-radius:var(--border-radius);cursor:pointer;transition:all var(--transition-fast)}.knowledge-category:hover{background-color:rgba(93,110,65,.2)}.knowledge-category.active{background-color:rgba(93,110,65,.3);border-left:3px solid var(--color-tertiary)}.knowledge-entries{flex:1;display:flex;flex-direction:column;gap:var(--spacing-md);overflow-y:auto}.knowledge-entry{padding:var(--spacing-lg);background-color:var(--color-bg-lighter);border-radius:var(--border-radius)}.knowledge-title{font-size:1.2rem;font-family:var(--font-heading);color:var(--color-tertiary);margin-bottom:var(--spacing-md);border-bottom:1px solid rgba(93,110,65,.3);padding-bottom:var(--spacing-sm)}.knowledge-content{line-height:1.6}.memory-container{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--color-memory-bg)}.memory-header{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-md);border-bottom:1px solid var(--color-memory-secondary);background-color:rgba(0,0,0,.2)}.memory-header h2{color:var(--color-memory-primary);font-family:var(--font-heading);display:flex;align-items:center;gap:var(--spacing-sm)}.memory-button{background-color:var(--color-memory-secondary);color:#fff;padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius);display:flex;align-items:center;gap:var(--spacing-sm);transition:background-color var(--transition-fast)}.memory-button:hover{background-color:var(--color-memory-primary)}.memory-button:disabled{cursor:not-allowed}.memory-timeline-container{padding:var(--spacing-md);background-color:rgba(0,0,0,.15);border-bottom:1px solid rgba(158,129,72,.3)}.memory-timeline{position:relative;display:flex;align-items:center;justify-content:center;padding:var(--spacing-sm) 0;overflow-x:auto;scrollbar-width:thin;scrollbar-color:var(--color-memory-secondary) rgba(0,0,0,.2);gap:var(--spacing-md);height:60px}.memory-timeline::-webkit-scrollbar{height:4px}.memory-timeline::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}.memory-timeline::-webkit-scrollbar-thumb{background-color:var(--color-memory-secondary);border-radius:2px}.memory-timeline::before{content:"";position:absolute;top:50%;left:0;right:0;height:2px;background-color:var(--color-memory-secondary);z-index:1}.memory-node-simple{position:relative;width:24px;height:24px;border-radius:50%;background-color:var(--color-memory-secondary);z-index:2;cursor:pointer;box-shadow:0 0 0 0 rgba(201,158,81,0);transition:all .3s ease-in-out}.memory-node-simple::before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:2px;height:16px;background-color:var(--color-memory-secondary);z-index:1}.memory-node-simple:hover{background-color:var(--color-memory-primary);transform:scale(1.2);box-shadow:0 0 10px 2px rgba(201,158,81,.3)}.memory-node-simple.selected{background-color:var(--color-memory-highlight);transform:scale(1.3);box-shadow:0 0 15px 5px rgba(201,158,81,.5);animation:memory-pulse 2s infinite}@keyframes memory-pulse{0%{box-shadow:0 0 0 0 rgba(201,158,81,.7)}70%{box-shadow:0 0 0 10px rgba(201,158,81,0)}100%{box-shadow:0 0 0 0 rgba(201,158,81,0)}}.memory-node{display:none}.memory-detail-container{flex:1;display:flex;flex-direction:column;padding:var(--spacing-md);gap:var(--spacing-md);overflow-y:auto}.memory-content{flex:1;padding:var(--spacing-lg);background-color:rgba(0,0,0,.2);border:1px solid var(--color-memory-secondary);border-radius:var(--border-radius);line-height:1.6;overflow-y:auto}.memory-content-image{width:100%;height:200px;background-size:cover;background-position:center;border-radius:var(--border-radius);margin-bottom:var(--spacing-md)}.memory-content-text{color:var(--color-text-primary)}.memory-actions{display:flex;justify-content:center;gap:var(--spacing-md)}.memory-travel-button{background-color:var(--color-memory-primary);color:#000;padding:var(--spacing-md) var(--spacing-xl);border-radius:var(--border-radius);font-family:var(--font-heading);font-weight:bold;display:flex;align-items:center;gap:var(--spacing-md);transition:all var(--transition-fast)}.memory-travel-button i{font-size:1.25rem}.memory-travel-button:hover{background-color:var(--color-memory-highlight);transform:translateY(-2px);box-shadow:0 4px 12px rgba(201,158,81,.3)}.memory-travel-button:disabled{opacity:.5;background-color:var(--color-memory-secondary);transform:none;box-shadow:none;cursor:not-allowed}.memory-empty-message{text-align:center;color:var(--color-text-secondary);font-style:italic;margin-top:var(--spacing-xl)}.memory-empty-timeline{padding:var(--spacing-md);text-align:center;color:var(--color-text-secondary);font-style:italic;width:100%}.loading-indicator{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:var(--z-modal);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:var(--spacing-lg)}.loading-spinner{width:50px;height:50px;border:4px solid rgba(138,109,59,.3);border-radius:50%;border-top-color:var(--color-primary);animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{color:var(--color-text-primary);font-size:1.125rem}.confirm-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;display:flex;justify-content:center;align-items:center;pointer-events:none}.modal-backdrop{display:none}.confirm-dialog{position:relative;background-color:var(--color-bg-light);border:1px solid var(--color-primary);border-radius:var(--border-radius);padding:var(--spacing-lg);width:400px;max-width:90%;z-index:2;box-shadow:0 8px 24px rgba(0,0,0,.7);pointer-events:auto;animation:dialogPop .2s ease-out forwards}@keyframes dialogPop{0%{opacity:0;transform:scale(0.9)}100%{opacity:1;transform:scale(1)}}.confirm-message{margin-bottom:var(--spacing-lg);text-align:center;font-size:1.1rem;line-height:1.5;color:#fff}.confirm-buttons{display:flex;justify-content:center;gap:var(--spacing-md);margin-top:var(--spacing-lg)}.confirm-button{padding:10px 20px;border-radius:var(--border-radius);min-width:100px;font-weight:bold;font-size:1rem;transition:all var(--transition-fast);border:1px solid rgba(0,0,0,0);cursor:pointer;margin:0 10px;pointer-events:auto !important}.confirm-button:active{transform:scale(0.95)}.confirm-yes{background-color:var(--color-primary);color:#fff;border:1px solid var(--color-memory-highlight)}.confirm-yes:hover{background-color:var(--color-memory-highlight);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.3)}.confirm-no{background-color:rgba(80,80,80,.5);color:var(--color-text-primary);border:1px solid hsla(0,0%,100%,.1)}.confirm-no:hover{background-color:rgba(100,100,100,.7);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.3)}#notification-container{position:fixed;top:var(--spacing-md);right:var(--spacing-md);z-index:var(--z-modal);display:flex;flex-direction:column;gap:var(--spacing-sm);max-width:300px}.notification{padding:var(--spacing-md);border-radius:var(--border-radius);background-color:var(--color-bg-light);box-shadow:0 4px 8px rgba(0,0,0,.3);opacity:0;transform:translateX(20px);transition:all var(--transition-normal)}.notification-show{opacity:1;transform:translateX(0)}.notification-hide{opacity:0;transform:translateX(20px)}.notification-info{border-left:4px solid #3498db}.notification-success{border-left:4px solid #2ecc71}.notification-warning{border-left:4px solid #f39c12}.notification-error{border-left:4px solid #e74c3c}@media(max-width: 768px){html:not(.mobile-ui):not(.desktop-ui) :root{--header-height: 50px}html:not(.mobile-ui):not(.desktop-ui) .game-container{display:flex;flex-direction:column;height:auto;overflow-y:hidden}html:not(.mobile-ui):not(.desktop-ui) .game-header{height:auto;min-height:auto;padding:var(--spacing-sm);flex-shrink:0;z-index:10}html:not(.mobile-ui):not(.desktop-ui) .header-left,html:not(.mobile-ui):not(.desktop-ui) .header-right{gap:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .game-title{font-size:1.2rem;margin-left:0}html:not(.mobile-ui):not(.desktop-ui) .game-date{font-size:.8rem}html:not(.mobile-ui):not(.desktop-ui) .icon-button{width:32px;height:32px;font-size:1.2rem}html:not(.mobile-ui):not(.desktop-ui) .content-wrapper{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) .tab-navigation{height:36px;min-height:36px;flex-shrink:0;z-index:9}html:not(.mobile-ui):not(.desktop-ui) .tab-button{padding:0 var(--spacing-sm);font-size:.9rem}html:not(.mobile-ui):not(.desktop-ui) .tab-button i{font-size:.9rem}html:not(.mobile-ui):not(.desktop-ui) .tab-content{flex:1;position:relative;display:flex;flex-direction:column;overflow:hidden}html:not(.mobile-ui):not(.desktop-ui) .tab-pane.active{position:relative;height:100%;display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) #story-tab{display:flex;flex-direction:column;position:relative;height:100%}html:not(.mobile-ui):not(.desktop-ui) .background-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:1}html:not(.mobile-ui):not(.desktop-ui) .characters-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:2}html:not(.mobile-ui):not(.desktop-ui) .dialogue-container{position:fixed;top:calc(var(--header-height) + 36px + 56.25vw);left:0;right:0;width:100%;height:calc(100vh - (var(--header-height) + 36px + 56.25vw));bottom:0;max-width:none;max-height:none;transform:none;border-radius:0;border-left:none;border-right:none;border-bottom:none;border-top:1px solid var(--color-primary);z-index:3;background-color:rgba(20,20,20,.95);box-shadow:none;cursor:default}html:not(.mobile-ui):not(.desktop-ui) .dialogue-header{padding:var(--spacing-xs) var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content{padding:var(--spacing-sm);height:calc(100% - 35px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--color-primary) rgba(20,20,20,.3)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content::-webkit-scrollbar{width:4px}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content::-webkit-scrollbar-track{background:rgba(20,20,20,.3)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-content::-webkit-scrollbar-thumb{background-color:var(--color-primary);border-radius:2px}html:not(.mobile-ui):not(.desktop-ui) .speaker-name{font-size:1rem}html:not(.mobile-ui):not(.desktop-ui) .choices-container{width:90%;max-width:90%;padding:var(--spacing-xs);z-index:4}html:not(.mobile-ui):not(.desktop-ui) .character-left,html:not(.mobile-ui):not(.desktop-ui) .character-right{height:100%;transform-origin:center bottom}html:not(.mobile-ui):not(.desktop-ui) #journal-tab,html:not(.mobile-ui):not(.desktop-ui) #memory-tab{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:calc(100vh - (var(--header-height) + 36px));bottom:0;z-index:3}html:not(.mobile-ui):not(.desktop-ui) .journal-container,html:not(.mobile-ui):not(.desktop-ui) .memory-container{padding:0;height:100%;width:100%;overflow-y:auto;display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) .memory-container{background-color:var(--color-memory-bg)}html:not(.mobile-ui):not(.desktop-ui) .memory-header{padding:var(--spacing-sm);border-bottom:1px solid var(--color-memory-secondary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html:not(.mobile-ui):not(.desktop-ui) .memory-header h2{font-size:1.2rem;margin-bottom:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .memory-button{background-color:var(--color-memory-primary);padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--border-radius);font-size:.9rem;display:flex;align-items:center;justify-content:center;width:100%}html:not(.mobile-ui):not(.desktop-ui) .memory-timeline-container{padding:var(--spacing-sm);border-bottom:1px solid rgba(158,129,72,.3);background-color:rgba(0,0,0,.15)}html:not(.mobile-ui):not(.desktop-ui) .memory-timeline{padding:var(--spacing-sm) 0;height:50px;gap:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .memory-node-simple{width:20px;height:20px}html:not(.mobile-ui):not(.desktop-ui) .memory-node-simple::before{height:12px}html:not(.mobile-ui):not(.desktop-ui) .memory-node-simple.selected{transform:scale(1.25);box-shadow:0 0 10px 3px rgba(201,158,81,.5)}html:not(.mobile-ui):not(.desktop-ui) .memory-node{display:none}html:not(.mobile-ui):not(.desktop-ui) .memory-node-content,html:not(.mobile-ui):not(.desktop-ui) .memory-timestamp{display:none}html:not(.mobile-ui):not(.desktop-ui) .memory-detail-container{flex:1;padding:var(--spacing-sm);display:flex;flex-direction:column}html:not(.mobile-ui):not(.desktop-ui) .memory-content{flex:1;padding:var(--spacing-md);background-color:rgba(0,0,0,.2);border:1px solid var(--color-memory-secondary);overflow-y:auto;font-size:.95rem;line-height:1.5}html:not(.mobile-ui):not(.desktop-ui) .memory-actions{padding:var(--spacing-sm) 0}html:not(.mobile-ui):not(.desktop-ui) .memory-travel-button{width:100%;justify-content:center;padding:var(--spacing-sm);background-color:var(--color-memory-primary);font-size:1rem}html:not(.mobile-ui):not(.desktop-ui) .memory-empty-timeline{padding:var(--spacing-md);font-size:.9rem}html:not(.mobile-ui):not(.desktop-ui) .journal-container{background-color:var(--color-bg-light)}html:not(.mobile-ui):not(.desktop-ui) .journal-nav{flex-wrap:wrap;padding:var(--spacing-sm);border-bottom:1px solid var(--color-tertiary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html:not(.mobile-ui):not(.desktop-ui) .journal-nav-item{font-size:.9rem;padding:var(--spacing-xs) var(--spacing-sm);margin-right:var(--spacing-xs);margin-bottom:var(--spacing-xs);border-radius:var(--border-radius)}html:not(.mobile-ui):not(.desktop-ui) .journal-content{flex:1;padding:var(--spacing-sm);overflow-y:auto}html:not(.mobile-ui):not(.desktop-ui) .journal-section{background-color:var(--color-bg-lighter);border-radius:var(--border-radius);padding:var(--spacing-sm);margin-bottom:var(--spacing-sm)}}@media(max-width: 768px)and (orientation: portrait){html:not(.mobile-ui):not(.desktop-ui) .game-header{--header-height: 50px}html:not(.mobile-ui):not(.desktop-ui) .character-left,html:not(.mobile-ui):not(.desktop-ui) .character-right{transform:scale(0.9)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-container{-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}}@media(max-width: 768px)and (orientation: landscape){html:not(.mobile-ui):not(.desktop-ui) .game-header{--header-height: 40px}html:not(.mobile-ui):not(.desktop-ui) .background-container,html:not(.mobile-ui):not(.desktop-ui) .characters-container{height:40vh;top:calc(var(--header-height) + 36px)}html:not(.mobile-ui):not(.desktop-ui) .dialogue-container{top:calc(var(--header-height) + 36px + 40vh);height:calc(100vh - (var(--header-height) + 36px + 40vh));min-height:0}html:not(.mobile-ui):not(.desktop-ui) #journal-tab,html:not(.mobile-ui):not(.desktop-ui) #memory-tab{top:calc(var(--header-height) + 36px);height:calc(100vh - (var(--header-height) + 36px))}html:not(.mobile-ui):not(.desktop-ui) .memory-detail-container,html:not(.mobile-ui):not(.desktop-ui) .journal-content{padding:var(--spacing-xs)}html:not(.mobile-ui):not(.desktop-ui) .memory-content,html:not(.mobile-ui):not(.desktop-ui) .journal-section{padding:var(--spacing-sm)}html:not(.mobile-ui):not(.desktop-ui) .memory-header h2,html:not(.mobile-ui):not(.desktop-ui) .journal-nav-item{font-size:.85rem}}.modal{z-index:9999}.modal-dialog:not(.monastery-dialog){max-width:90%;width:800px}.modal-content:not(.monastery-dialog .modal-content){background-color:var(--color-bg-light);color:var(--color-text-primary);border:1px solid var(--color-primary);border-radius:var(--border-radius);box-shadow:0 5px 15px rgba(0,0,0,.5)}.modal-header:not(.monastery-dialog .modal-header),.modal-footer:not(.monastery-dialog .modal-footer){border-color:rgba(138,109,59,.3);padding:var(--spacing-sm) var(--spacing-md)}.modal-header .close{color:var(--color-text-primary);opacity:.7;transition:opacity var(--transition-fast)}.modal-header .close:hover{opacity:1}.btn-secondary:not(.monastery-btn){background-color:var(--color-bg-lighter);border-color:var(--color-bg-lighter);color:var(--color-text-primary);transition:all var(--transition-fast)}.btn-secondary:not(.monastery-btn):hover{background-color:var(--color-bg-light);border-color:var(--color-primary)}.modal-backdrop{z-index:9998}.modal-open{overflow:hidden;padding-right:0 !important}.modal.fade .modal-dialog{transform:translate(0, -50px);transition:transform var(--transition-normal) ease}.modal.show .modal-dialog{transform:none}#load-game-modal .modal-dialog{max-width:700px}#load-game-modal .modal-content{background-color:var(--color-save-bg);border:1px solid var(--color-save-primary);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px)}#load-game-modal .modal-header{background-color:rgba(0,0,0,.2);border-bottom:1px solid var(--color-save-primary)}#load-game-modal .modal-header .modal-title{color:var(--color-save-highlight);font-family:var(--font-heading);font-size:1.3rem}#load-game-modal .modal-header .close{color:var(--color-save-highlight);text-shadow:none;opacity:.7}#load-game-modal .modal-header .close:hover{opacity:1}#load-game-modal .modal-body{padding:var(--spacing-md);max-height:70vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--color-save-primary) rgba(0,0,0,.2)}#load-game-modal .modal-body::-webkit-scrollbar{width:8px}#load-game-modal .modal-body::-webkit-scrollbar-track{background:rgba(0,0,0,.2);border-radius:var(--border-radius)}#load-game-modal .modal-body::-webkit-scrollbar-thumb{background:var(--color-save-primary);border-radius:var(--border-radius)}#load-game-modal .modal-body::-webkit-scrollbar-thumb:hover{background:var(--color-save-highlight)}#load-game-modal .modal-footer{background-color:rgba(0,0,0,.2);border-top:1px solid var(--color-save-primary)}.save-tabs{display:flex;margin-bottom:var(--spacing-md);background-color:rgba(0,0,0,.15);border-radius:var(--border-radius);padding:0;overflow:hidden}.save-tab-btn{flex:1;padding:var(--spacing-sm) 0;background:none;border:none;color:var(--color-text-secondary);cursor:pointer;font-family:var(--font-heading);font-size:1rem;transition:all var(--transition-fast);position:relative}.save-tab-btn::after{content:"";position:absolute;bottom:0;left:0;width:100%;height:3px;background-color:rgba(0,0,0,0);transition:background-color var(--transition-fast)}.save-tab-btn:hover{color:var(--color-text-primary)}.save-tab-btn.active{color:var(--color-save-highlight);background-color:rgba(158,129,72,.1)}.save-tab-btn.active::after{background-color:var(--color-save-primary)}.save-tab-content{position:relative}.save-tab-pane{display:none;animation:fadeIn .3s ease}.save-tab-pane.active{display:block}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.save-list{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:var(--spacing-md)}.save-item{background-color:hsla(0,0%,100%,.05);border:1px solid rgba(158,129,72,.3);border-radius:var(--border-radius);overflow:hidden;transition:border-color var(--transition-fast),box-shadow var(--transition-fast);position:relative;cursor:pointer}.save-item:hover{border-color:var(--color-save-highlight);box-shadow:0 3px 10px rgba(0,0,0,.2)}.save-item.empty{grid-column:1/-1;padding:var(--spacing-lg);text-align:center;color:var(--color-text-secondary);cursor:default}.save-item.empty:hover{box-shadow:none;border-color:rgba(158,129,72,.3)}.save-item-thumbnail{height:120px;background-size:cover;background-position:center;border-bottom:1px solid rgba(158,129,72,.2);position:relative;transition:filter var(--transition-fast)}.save-item-thumbnail::after{content:"";position:absolute;bottom:0;left:0;right:0;height:40px;background:linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent)}.save-item:hover .save-item-thumbnail{filter:brightness(1.1)}.save-item-header{padding:var(--spacing-sm) var(--spacing-md);display:flex;justify-content:space-between;align-items:center;background-color:rgba(0,0,0,.2);border-bottom:1px solid rgba(158,129,72,.2);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px)}.save-item-title{font-weight:bold;font-family:var(--font-heading);font-size:1rem;color:var(--color-save-highlight);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%;transition:color var(--transition-fast)}.save-item:hover .save-item-title{color:var(--color-save-highlight)}.save-item-date{font-size:.8rem;color:var(--color-text-secondary)}.save-item-content{padding:var(--spacing-sm) var(--spacing-md);font-size:.9rem;color:var(--color-text-primary);max-height:60px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}.save-item-actions{padding:var(--spacing-xs) var(--spacing-md);display:flex;justify-content:flex-end;background-color:rgba(0,0,0,.2);border-top:1px solid rgba(158,129,72,.2);opacity:0;transition:opacity var(--transition-fast)}.save-item-actions button{background-color:rgba(0,0,0,0);color:var(--color-text-secondary);border:1px solid rgba(158,129,72,.3);border-radius:4px;padding:var(--spacing-xs) var(--spacing-sm);font-size:.8rem;transition:all var(--transition-fast)}.save-item-actions button:hover{background-color:var(--color-save-delete);color:#fff;border-color:var(--color-save-delete)}.save-item:hover .save-item-actions{opacity:1}#btn-create-manual-save{background-color:var(--color-save-primary);color:#fff;border:none;font-family:var(--font-heading);padding:var(--spacing-sm) var(--spacing-lg);border-radius:var(--border-radius);transition:background-color var(--transition-fast),box-shadow var(--transition-fast);display:flex;align-items:center}#btn-create-manual-save i{margin-right:var(--spacing-sm)}#btn-create-manual-save:hover{background-color:var(--color-save-highlight);color:#000;box-shadow:0 2px 5px rgba(0,0,0,.2)}#load-game-modal .btn-secondary{background-color:hsla(0,0%,100%,.1);border:1px solid rgba(158,129,72,.3);color:var(--color-text-primary)}#load-game-modal .btn-secondary:hover{background-color:hsla(0,0%,100%,.15);border-color:var(--color-save-secondary)}.input-dialog-container input{background-color:hsla(0,0%,100%,.1);border:1px solid var(--color-save-secondary);color:var(--color-text-primary);border-radius:var(--border-radius);padding:var(--spacing-sm);width:100%;margin-bottom:var(--spacing-md)}.input-dialog-container input:focus{outline:none;border-color:var(--color-save-highlight);box-shadow:0 0 0 2px rgba(213,185,120,.25)}html.font-small .dialogue-content,html.font-small .choice-button,html.font-small .custom-choice input,html.font-small .memory-content-text,html.font-small .journal-content,html.font-small .knowledge-content{font-size:var(--font-size-small)}html.font-small .speaker-name,html.font-small .memory-header h2,html.font-small .journal-nav-item,html.font-small .tab-button{font-size:.95rem}html.font-small .dialogue-container{--dialogue-height: 180px}html.font-large .dialogue-content,html.font-large .choice-button,html.font-large .custom-choice input,html.font-large .memory-content-text,html.font-large .journal-content,html.font-large .knowledge-content{font-size:var(--font-size-large);line-height:1.7}html.font-large .speaker-name,html.font-large .memory-header h2,html.font-large .journal-nav-item,html.font-large .tab-button{font-size:1.15rem}html.font-large .dialogue-container{--dialogue-height: 230px}html.mobile-ui :root{--header-height: 50px}html.mobile-ui .game-container{display:flex;flex-direction:column;height:100vh;overflow-y:hidden}html.mobile-ui .game-header{height:auto;min-height:auto;padding:var(--spacing-sm);flex-shrink:0;z-index:10}html.mobile-ui .header-left,html.mobile-ui .header-right{gap:var(--spacing-sm)}html.mobile-ui .game-title{font-size:1.2rem;margin-left:0}html.mobile-ui .game-date{font-size:.8rem}html.mobile-ui .icon-button{width:32px;height:32px;font-size:1.2rem}html.mobile-ui .content-wrapper{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}html.mobile-ui .tab-navigation{height:36px;min-height:36px;flex-shrink:0;z-index:9}html.mobile-ui .tab-button{padding:0 var(--spacing-sm);font-size:.9rem}html.mobile-ui .tab-button i{font-size:.9rem}html.mobile-ui .tab-content{flex:1;position:relative;display:flex;flex-direction:column;overflow:hidden}html.mobile-ui .tab-pane.active{position:relative;height:100%;display:flex;flex-direction:column}html.mobile-ui #story-tab{display:flex;flex-direction:column;position:relative;height:100%}html.mobile-ui .background-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:1}html.mobile-ui .characters-container{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:56.25vw;z-index:2}html.mobile-ui .dialogue-container{position:fixed;top:calc(var(--header-height) + 36px + 56.25vw);left:0;right:0;width:100%;height:calc(100vh - (var(--header-height) + 36px + 56.25vw));bottom:0;max-width:none;max-height:none;transform:none;border-radius:0;border-left:none;border-right:none;border-bottom:none;border-top:1px solid var(--color-primary);z-index:3;background-color:rgba(20,20,20,.95);box-shadow:none;cursor:default}html.mobile-ui .dialogue-header{padding:var(--spacing-xs) var(--spacing-sm)}html.mobile-ui .dialogue-content{padding:var(--spacing-sm);height:calc(100% - 35px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--color-primary) rgba(20,20,20,.3)}html.mobile-ui .dialogue-content::-webkit-scrollbar{width:4px}html.mobile-ui .dialogue-content::-webkit-scrollbar-track{background:rgba(20,20,20,.3)}html.mobile-ui .dialogue-content::-webkit-scrollbar-thumb{background-color:var(--color-primary);border-radius:2px}html.mobile-ui .speaker-name{font-size:1rem}html.mobile-ui .choices-container{width:90%;max-width:90%;padding:var(--spacing-xs);z-index:4}html.mobile-ui .character-left,html.mobile-ui .character-right{height:100%;transform-origin:center bottom}html.mobile-ui #journal-tab,html.mobile-ui #memory-tab{position:fixed;top:calc(var(--header-height) + 36px);left:0;width:100%;height:calc(100vh - (var(--header-height) + 36px));bottom:0;z-index:3}html.mobile-ui .journal-container,html.mobile-ui .memory-container{padding:0;height:100%;width:100%;overflow-y:auto;display:flex;flex-direction:column}html.mobile-ui .memory-container{background-color:var(--color-memory-bg)}html.mobile-ui .memory-header{padding:var(--spacing-sm);border-bottom:1px solid var(--color-memory-secondary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html.mobile-ui .memory-header h2{font-size:1.2rem;margin-bottom:var(--spacing-sm)}html.mobile-ui .memory-button{padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--border-radius);font-size:.9rem}html.mobile-ui .memory-timeline-container{padding:var(--spacing-sm);border-bottom:1px solid rgba(158,129,72,.3);background-color:rgba(0,0,0,.15)}html.mobile-ui .memory-timeline{padding:var(--spacing-sm) 0;height:50px;gap:var(--spacing-sm)}html.mobile-ui .memory-node-simple{width:20px;height:20px}html.mobile-ui .memory-node-simple::before{height:12px}html.mobile-ui .memory-node-simple.selected{transform:scale(1.25);box-shadow:0 0 10px 3px rgba(201,158,81,.5)}html.mobile-ui .memory-detail-container{flex:1;padding:var(--spacing-sm);display:flex;flex-direction:column}html.mobile-ui .memory-content{flex:1;padding:var(--spacing-md);background-color:rgba(0,0,0,.2);border:1px solid var(--color-memory-secondary);overflow-y:auto;font-size:.95rem;line-height:1.5}html.mobile-ui .memory-actions{padding:var(--spacing-sm) 0}html.mobile-ui .memory-travel-button{width:100%;justify-content:center;padding:var(--spacing-sm);background-color:var(--color-memory-primary);font-size:1rem}html.mobile-ui .journal-container{background-color:var(--color-bg-light)}html.mobile-ui .journal-nav{flex-wrap:wrap;padding:var(--spacing-sm);border-bottom:1px solid var(--color-tertiary);background-color:rgba(0,0,0,.2);position:sticky;top:0;z-index:1}html.mobile-ui .journal-nav-item{font-size:.9rem;padding:var(--spacing-xs) var(--spacing-sm);margin-right:var(--spacing-xs);margin-bottom:var(--spacing-xs);border-radius:var(--border-radius)}html.mobile-ui .journal-content{flex:1;padding:var(--spacing-sm);overflow-y:auto}html.mobile-ui .journal-section{background-color:var(--color-bg-lighter);border-radius:var(--border-radius);padding:var(--spacing-sm);margin-bottom:var(--spacing-sm)}.monastery-dialog{max-width:500px;width:90%;margin:auto}.modal-content{background-color:var(--color-bg-light);color:var(--color-text-primary);border:1px solid var(--color-primary);border-radius:var(--border-radius);box-shadow:0 5px 25px rgba(0,0,0,.7)}.modal-header{background-color:rgba(0,0,0,.2);border-bottom:1px solid var(--color-primary);padding:var(--spacing-sm) var(--spacing-md)}.modal-title{color:var(--color-primary);font-family:var(--font-heading);display:flex;align-items:center;gap:var(--spacing-sm)}.modal-title i{font-size:1.1em}.modal-body{padding:var(--spacing-md);background-color:rgba(0,0,0,.1)}.modal-footer{background-color:rgba(0,0,0,.2);border-top:1px solid var(--color-primary);padding:var(--spacing-sm) var(--spacing-md)}.monastery-btn{padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius);font-family:var(--font-heading);font-size:.95rem;transition:all var(--transition-fast);display:flex;align-items:center;gap:var(--spacing-sm)}.monastery-btn i{font-size:1em}.monastery-btn-primary{background-color:var(--color-primary);border-color:var(--color-primary);color:#fff}.monastery-btn-primary:hover{background-color:rgb(102.2741116751,80.7817258883,43.7258883249);border-color:rgb(102.2741116751,80.7817258883,43.7258883249);transform:translateY(-2px);box-shadow:0 3px 8px rgba(0,0,0,.3)}.monastery-btn-secondary{background-color:var(--color-tertiary);border-color:var(--color-tertiary);color:#fff}.monastery-btn-secondary:hover{background-color:rgb(65.8971428571,77.9428571429,46.0571428571);border-color:rgb(65.8971428571,77.9428571429,46.0571428571);transform:translateY(-2px);box-shadow:0 3px 8px rgba(0,0,0,.3)}.monastery-btn-cancel{background-color:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.2);color:var(--color-text-primary)}.monastery-btn-cancel:hover{background-color:hsla(0,0%,100%,.15);border-color:hsla(0,0%,100%,.25)}.monastery-form-group{margin-bottom:var(--spacing-md)}.monastery-label{color:var(--color-primary);font-family:var(--font-heading);margin-bottom:var(--spacing-xs);display:flex;align-items:center;gap:var(--spacing-sm)}.monastery-label i{color:var(--color-primary);font-size:1.1em}.monastery-input,.monastery-select{background-color:hsla(0,0%,100%,.05);border:1px solid rgba(138,109,59,.4);color:var(--color-text-primary);border-radius:var(--border-radius);padding:var(--spacing-sm);transition:all var(--transition-fast)}.monastery-input:focus,.monastery-select:focus{background-color:hsla(0,0%,100%,.1);border-color:var(--color-primary);box-shadow:0 0 0 2px rgba(138,109,59,.2)}.monastery-help-text{margin-top:var(--spacing-xs);font-style:italic;opacity:.8}.monastery-switch .custom-control-input:checked~.custom-control-label::before{background-color:var(--color-primary);border-color:var(--color-primary)}.monastery-switch .custom-control-label{cursor:pointer}.monastery-switch .custom-control-label::before{background-color:hsla(0,0%,100%,.1);border-color:rgba(138,109,59,.4)}.input-dialog-container{display:flex;flex-direction:column;gap:var(--spacing-sm)}#load-game-modal .modal-dialog{max-width:700px;width:95%;margin:auto}@media(max-width: 768px){#load-game-modal .save-list{grid-template-columns:1fr}#load-game-modal .save-item{margin-bottom:var(--spacing-sm)}#load-game-modal .save-item-thumbnail{height:80px}#load-game-modal .save-item-actions{opacity:1}#load-game-modal .modal-dialog{margin:.5rem auto}#load-game-modal .modal-body{padding:var(--spacing-sm);max-height:70vh}#load-game-modal .save-tabs{margin-bottom:var(--spacing-sm)}#load-game-modal .save-tab-btn{font-size:.9rem;padding:var(--spacing-xs) 0}#load-game-modal #btn-create-manual-save{width:100%;justify-content:center;margin-bottom:var(--spacing-sm)}#load-game-modal .modal-footer{padding:var(--spacing-xs) var(--spacing-sm);flex-wrap:wrap;justify-content:center}#load-game-modal .modal-footer .btn{margin:var(--spacing-xs);flex:1;min-width:80px}}html.desktop-ui .game-container{display:flex;flex-direction:column;height:100vh}html.desktop-ui .game-header{height:var(--header-height);min-height:var(--header-height);padding:0 var(--spacing-md)}html.desktop-ui .content-wrapper{flex:1;display:flex;flex-direction:column}html.desktop-ui .tab-navigation{height:var(--tab-height);min-height:var(--tab-height)}html.desktop-ui .tab-button{padding:0 var(--spacing-lg);height:100%;font-size:1rem}html.desktop-ui .tab-content{position:relative;aspect-ratio:16/9;overflow:hidden;flex:none}html.desktop-ui .tab-pane{position:absolute;top:0;left:0;width:100%;height:100%}html.desktop-ui .background-container,html.desktop-ui .characters-container{position:absolute;top:0;left:0;width:100%;height:100%}html.desktop-ui .dialogue-container{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:900px;height:var(--dialogue-height);border:1px solid var(--color-primary);border-radius:var(--border-radius);cursor:pointer}html.desktop-ui .dialogue-header{padding:var(--spacing-sm) var(--spacing-md)}html.desktop-ui .dialogue-content{padding:var(--spacing-md);overflow-y:auto;height:auto}html.desktop-ui .choices-container{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:70%;max-width:650px;padding:var(--spacing-sm)}html.desktop-ui #journal-tab,html.desktop-ui #memory-tab{position:absolute;top:0;left:0;width:100%;height:100%}html.desktop-ui .journal-container,html.desktop-ui .memory-container{display:flex;flex-direction:column;height:100%;width:100%;padding:0}html.desktop-ui .memory-header,html.desktop-ui .journal-nav{position:static;padding:var(--spacing-md)}html.desktop-ui .journal-nav{display:flex;gap:var(--spacing-md);flex-wrap:nowrap}html.desktop-ui .journal-nav-item{padding:var(--spacing-sm) var(--spacing-md);margin:0;font-size:1rem}html.desktop-ui .memory-detail-container,html.desktop-ui .journal-content{flex:1;padding:var(--spacing-md)}html.desktop-ui .character-left,html.desktop-ui .character-right{height:100%;width:40%;transform-origin:bottom center;transform:none}html.desktop-ui .character-left{transform-origin:bottom left}html.desktop-ui .character-right{transform-origin:bottom right}
</style></head><body><div class="game-container"><header class="game-header"><div class="header-left"><h1 class="game-title">Saint Aurelia</h1></div><div class="header-right"><span class="game-date" id="game-date">Anno Domini 1250, Martius XII</span><div class="game-controls"><button id="save-game" class="icon-button gold" title="记录典籍"><i class="fas fa-feather-alt"></i></button> <button id="load-game" class="icon-button gold" title="查看典籍"><i class="fas fa-book-open"></i></button> <button id="settings-button" class="icon-button" title="设置"><i class="fas fa-cog"></i></button></div></div></header><div class="content-wrapper"><div class="tab-navigation"><button id="tab-story" class="tab-button active" data-tab="story-tab"><i class="fas fa-book-open"></i> 正文</button> <button id="tab-journal" class="tab-button" data-tab="journal-tab"><i class="fas fa-journal-whills"></i> 日记</button> <button id="tab-memory" class="tab-button" data-tab="memory-tab"><i class="fas fa-clock-rotate-left"></i> 记忆</button></div><div class="tab-content"><div id="story-tab" class="tab-pane active"><div class="game-core"><div class="background-container" id="background-container"></div><div class="characters-container" id="characters-container"><div class="character-left" id="character-left"></div><div class="character-right" id="character-right"></div></div><div class="dialogue-container" id="dialogue-container"><div class="dialogue-header"><span class="speaker-name" id="speaker-name">Sister Cecilia</span><div class="dialogue-controls"><button id="auto-play" class="icon-button small" title="自动播放"><i class="fas fa-play"></i></button> <button id="dialogue-history" class="icon-button small" title="历史记录"><i class="fas fa-history"></i></button></div></div><div class="dialogue-content" id="dialogue-content"></div></div><div class="choices-container hidden" id="choices-container"><div class="choices-header"><h3>接下来的行动</h3><button id="hide-choices-btn" class="icon-button small" title="隐藏选项"><i class="fas fa-times"></i></button></div><div class="preset-choices" id="preset-choices"></div><div class="custom-choice"><input id="custom-choice-input" placeholder="自定义回应..."/> <button id="custom-choice-button" type="button">确定</button></div></div></div></div><div id="journal-tab" class="tab-pane"><div class="journal-container"><div class="journal-nav"><button class="journal-nav-item active" data-section="characters"><i class="fas fa-users"></i> 角色信息</button> <button class="journal-nav-item" data-section="monastery"><i class="fas fa-church"></i> 修道院状态</button> <button class="journal-nav-item" data-section="knowledge"><i class="fas fa-book"></i> 知识库</button></div><div class="journal-content"><div id="characters-section" class="journal-section active"><div class="character-cards" id="character-cards"></div><div class="character-details" id="character-details"></div></div><div id="monastery-section" class="journal-section"><div class="monastery-info" id="monastery-info"></div></div><div id="knowledge-section" class="journal-section"><div class="knowledge-categories" id="knowledge-categories"></div><div class="knowledge-entries" id="knowledge-entries"></div></div></div></div></div><div id="memory-tab" class="tab-pane"><div class="memory-container"><div class="memory-header"><h2><i class="fas fa-hourglass-half"></i> 穿越记忆点</h2><button id="save-memory" class="memory-button"><i class="fas fa-bookmark"></i> 保存此刻</button></div><div class="memory-timeline-container"><div class="memory-timeline" id="memory-timeline"></div></div><div class="memory-detail-container"><div class="memory-content" id="memory-content"></div><div class="memory-actions"><button id="travel-to-memory" class="memory-travel-button"><i class="fas fa-clock-rotate-left"></i> 穿越到此刻</button></div></div></div></div></div><div class="loading-indicator hidden" id="loading-indicator"><div class="loading-spinner"></div><div class="loading-text">加载中...</div></div><div id="notification-container"></div></div></div><div class="confirm-container hidden" id="confirm-container"><div class="modal-backdrop" id="modal-backdrop"></div><div class="confirm-dialog" id="confirm-dialog"><div class="confirm-message" id="confirm-message">确定要执行此操作吗？</div><div class="confirm-buttons"><button class="confirm-button confirm-yes" id="confirm-yes">确认</button> <button class="confirm-button confirm-no" id="confirm-no">取消</button></div></div></div><script>/*! For license information please see index.js.LICENSE.txt */
var t={935:function(t,e,n){var r;t=n.nmd(t),function(){var o,i="Expected a function",a="__lodash_hash_undefined__",s="__lodash_placeholder__",c=16,u=32,l=64,h=128,f=256,d=1/0,g=9007199254740991,m=NaN,p=4294967295,y=[["ary",h],["bind",1],["bindKey",2],["curry",8],["curryRight",c],["flip",512],["partial",u],["partialRight",l],["rearg",f]],v="[object Arguments]",w="[object Array]",_="[object Boolean]",b="[object Date]",k="[object Error]",$="[object Function]",S="[object GeneratorFunction]",E="[object Map]",C="[object Number]",M="[object Object]",D="[object Promise]",I="[object RegExp]",A="[object Set]",x="[object String]",B="[object Symbol]",L="[object WeakMap]",N="[object ArrayBuffer]",T="[object DataView]",O="[object Float32Array]",j="[object Float64Array]",R="[object Int8Array]",P="[object Int16Array]",U="[object Int32Array]",z="[object Uint8Array]",G="[object Uint8ClampedArray]",H="[object Uint16Array]",W="[object Uint32Array]",K=/\b__p \+= '';/g,F=/\b(__p \+=) '' \+/g,Y=/(__e\(.*?\)|\b__t\)) \+\n'';/g,J=/&(?:amp|lt|gt|quot|#39);/g,q=/[&<>"']/g,V=RegExp(J.source),Z=RegExp(q.source),Q=/<%-([\s\S]+?)%>/g,X=/<%([\s\S]+?)%>/g,tt=/<%=([\s\S]+?)%>/g,et=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,nt=/^\w*$/,rt=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ot=/[\\^$.*+?()[\]{}|]/g,it=RegExp(ot.source),at=/^\s+/,st=/\s/,ct=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,ut=/\{\n\/\* \[wrapped with (.+)\] \*/,lt=/,? & /,ht=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,ft=/[()=,{}\[\]\/\s]/,dt=/\\(\\)?/g,gt=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,mt=/\w*$/,pt=/^[-+]0x[0-9a-f]+$/i,yt=/^0b[01]+$/i,vt=/^\[object .+?Constructor\]$/,wt=/^0o[0-7]+$/i,_t=/^(?:0|[1-9]\d*)$/,bt=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,kt=/($^)/,$t=/['\n\r\u2028\u2029\\]/g,St="\\ud800-\\udfff",Et="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",Ct="\\u2700-\\u27bf",Mt="a-z\\xdf-\\xf6\\xf8-\\xff",Dt="A-Z\\xc0-\\xd6\\xd8-\\xde",It="\\ufe0e\\ufe0f",At="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",xt="['’]",Bt="["+St+"]",Lt="["+At+"]",Nt="["+Et+"]",Tt="\\d+",Ot="["+Ct+"]",jt="["+Mt+"]",Rt="[^"+St+At+Tt+Ct+Mt+Dt+"]",Pt="\\ud83c[\\udffb-\\udfff]",Ut="[^"+St+"]",zt="(?:\\ud83c[\\udde6-\\uddff]){2}",Gt="[\\ud800-\\udbff][\\udc00-\\udfff]",Ht="["+Dt+"]",Wt="\\u200d",Kt="(?:"+jt+"|"+Rt+")",Ft="(?:"+Ht+"|"+Rt+")",Yt="(?:['’](?:d|ll|m|re|s|t|ve))?",Jt="(?:['’](?:D|LL|M|RE|S|T|VE))?",qt="(?:"+Nt+"|"+Pt+")"+"?",Vt="["+It+"]?",Zt=Vt+qt+("(?:"+Wt+"(?:"+[Ut,zt,Gt].join("|")+")"+Vt+qt+")*"),Qt="(?:"+[Ot,zt,Gt].join("|")+")"+Zt,Xt="(?:"+[Ut+Nt+"?",Nt,zt,Gt,Bt].join("|")+")",te=RegExp(xt,"g"),ee=RegExp(Nt,"g"),ne=RegExp(Pt+"(?="+Pt+")|"+Xt+Zt,"g"),re=RegExp([Ht+"?"+jt+"+"+Yt+"(?="+[Lt,Ht,"$"].join("|")+")",Ft+"+"+Jt+"(?="+[Lt,Ht+Kt,"$"].join("|")+")",Ht+"?"+Kt+"+"+Yt,Ht+"+"+Jt,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",Tt,Qt].join("|"),"g"),oe=RegExp("["+Wt+St+Et+It+"]"),ie=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,ae=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],se=-1,ce={};ce[O]=ce[j]=ce[R]=ce[P]=ce[U]=ce[z]=ce[G]=ce[H]=ce[W]=!0,ce[v]=ce[w]=ce[N]=ce[_]=ce[T]=ce[b]=ce[k]=ce[$]=ce[E]=ce[C]=ce[M]=ce[I]=ce[A]=ce[x]=ce[L]=!1;var ue={};ue[v]=ue[w]=ue[N]=ue[T]=ue[_]=ue[b]=ue[O]=ue[j]=ue[R]=ue[P]=ue[U]=ue[E]=ue[C]=ue[M]=ue[I]=ue[A]=ue[x]=ue[B]=ue[z]=ue[G]=ue[H]=ue[W]=!0,ue[k]=ue[$]=ue[L]=!1;var le={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},he=parseFloat,fe=parseInt,de="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,ge="object"==typeof self&&self&&self.Object===Object&&self,me=de||ge||Function("return this")(),pe=e&&!e.nodeType&&e,ye=pe&&t&&!t.nodeType&&t,ve=ye&&ye.exports===pe,we=ve&&de.process,_e=function(){try{var t=ye&&ye.require&&ye.require("util").types;return t||we&&we.binding&&we.binding("util")}catch(t){}}(),be=_e&&_e.isArrayBuffer,ke=_e&&_e.isDate,$e=_e&&_e.isMap,Se=_e&&_e.isRegExp,Ee=_e&&_e.isSet,Ce=_e&&_e.isTypedArray;function Me(t,e,n){switch(n.length){case 0:return t.call(e);case 1:return t.call(e,n[0]);case 2:return t.call(e,n[0],n[1]);case 3:return t.call(e,n[0],n[1],n[2])}return t.apply(e,n)}function De(t,e,n,r){for(var o=-1,i=null==t?0:t.length;++o<i;){var a=t[o];e(r,a,n(a),t)}return r}function Ie(t,e){for(var n=-1,r=null==t?0:t.length;++n<r&&!1!==e(t[n],n,t););return t}function Ae(t,e){for(var n=null==t?0:t.length;n--&&!1!==e(t[n],n,t););return t}function xe(t,e){for(var n=-1,r=null==t?0:t.length;++n<r;)if(!e(t[n],n,t))return!1;return!0}function Be(t,e){for(var n=-1,r=null==t?0:t.length,o=0,i=[];++n<r;){var a=t[n];e(a,n,t)&&(i[o++]=a)}return i}function Le(t,e){return!!(null==t?0:t.length)&&He(t,e,0)>-1}function Ne(t,e,n){for(var r=-1,o=null==t?0:t.length;++r<o;)if(n(e,t[r]))return!0;return!1}function Te(t,e){for(var n=-1,r=null==t?0:t.length,o=Array(r);++n<r;)o[n]=e(t[n],n,t);return o}function Oe(t,e){for(var n=-1,r=e.length,o=t.length;++n<r;)t[o+n]=e[n];return t}function je(t,e,n,r){var o=-1,i=null==t?0:t.length;for(r&&i&&(n=t[++o]);++o<i;)n=e(n,t[o],o,t);return n}function Re(t,e,n,r){var o=null==t?0:t.length;for(r&&o&&(n=t[--o]);o--;)n=e(n,t[o],o,t);return n}function Pe(t,e){for(var n=-1,r=null==t?0:t.length;++n<r;)if(e(t[n],n,t))return!0;return!1}var Ue=Ye("length");function ze(t,e,n){var r;return n(t,(function(t,n,o){if(e(t,n,o))return r=n,!1})),r}function Ge(t,e,n,r){for(var o=t.length,i=n+(r?1:-1);r?i--:++i<o;)if(e(t[i],i,t))return i;return-1}function He(t,e,n){return e==e?function(t,e,n){var r=n-1,o=t.length;for(;++r<o;)if(t[r]===e)return r;return-1}(t,e,n):Ge(t,Ke,n)}function We(t,e,n,r){for(var o=n-1,i=t.length;++o<i;)if(r(t[o],e))return o;return-1}function Ke(t){return t!=t}function Fe(t,e){var n=null==t?0:t.length;return n?Ve(t,e)/n:m}function Ye(t){return function(e){return null==e?o:e[t]}}function Je(t){return function(e){return null==t?o:t[e]}}function qe(t,e,n,r,o){return o(t,(function(t,o,i){n=r?(r=!1,t):e(n,t,o,i)})),n}function Ve(t,e){for(var n,r=-1,i=t.length;++r<i;){var a=e(t[r]);a!==o&&(n=n===o?a:n+a)}return n}function Ze(t,e){for(var n=-1,r=Array(t);++n<t;)r[n]=e(n);return r}function Qe(t){return t?t.slice(0,pn(t)+1).replace(at,""):t}function Xe(t){return function(e){return t(e)}}function tn(t,e){return Te(e,(function(e){return t[e]}))}function en(t,e){return t.has(e)}function nn(t,e){for(var n=-1,r=t.length;++n<r&&He(e,t[n],0)>-1;);return n}function rn(t,e){for(var n=t.length;n--&&He(e,t[n],0)>-1;);return n}var on=Je({À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"}),an=Je({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function sn(t){return"\\"+le[t]}function cn(t){return oe.test(t)}function un(t){var e=-1,n=Array(t.size);return t.forEach((function(t,r){n[++e]=[r,t]})),n}function ln(t,e){return function(n){return t(e(n))}}function hn(t,e){for(var n=-1,r=t.length,o=0,i=[];++n<r;){var a=t[n];a!==e&&a!==s||(t[n]=s,i[o++]=n)}return i}function fn(t){var e=-1,n=Array(t.size);return t.forEach((function(t){n[++e]=t})),n}function dn(t){var e=-1,n=Array(t.size);return t.forEach((function(t){n[++e]=[t,t]})),n}function gn(t){return cn(t)?function(t){var e=ne.lastIndex=0;for(;ne.test(t);)++e;return e}(t):Ue(t)}function mn(t){return cn(t)?function(t){return t.match(ne)||[]}(t):function(t){return t.split("")}(t)}function pn(t){for(var e=t.length;e--&&st.test(t.charAt(e)););return e}var yn=Je({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"});var vn=function t(e){var n,r=(e=null==e?me:vn.defaults(me.Object(),e,vn.pick(me,ae))).Array,st=e.Date,St=e.Error,Et=e.Function,Ct=e.Math,Mt=e.Object,Dt=e.RegExp,It=e.String,At=e.TypeError,xt=r.prototype,Bt=Et.prototype,Lt=Mt.prototype,Nt=e["__core-js_shared__"],Tt=Bt.toString,Ot=Lt.hasOwnProperty,jt=0,Rt=(n=/[^.]+$/.exec(Nt&&Nt.keys&&Nt.keys.IE_PROTO||""))?"Symbol(src)_1."+n:"",Pt=Lt.toString,Ut=Tt.call(Mt),zt=me._,Gt=Dt("^"+Tt.call(Ot).replace(ot,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ht=ve?e.Buffer:o,Wt=e.Symbol,Kt=e.Uint8Array,Ft=Ht?Ht.allocUnsafe:o,Yt=ln(Mt.getPrototypeOf,Mt),Jt=Mt.create,qt=Lt.propertyIsEnumerable,Vt=xt.splice,Zt=Wt?Wt.isConcatSpreadable:o,Qt=Wt?Wt.iterator:o,Xt=Wt?Wt.toStringTag:o,ne=function(){try{var t=di(Mt,"defineProperty");return t({},"",{}),t}catch(t){}}(),oe=e.clearTimeout!==me.clearTimeout&&e.clearTimeout,le=st&&st.now!==me.Date.now&&st.now,de=e.setTimeout!==me.setTimeout&&e.setTimeout,ge=Ct.ceil,pe=Ct.floor,ye=Mt.getOwnPropertySymbols,we=Ht?Ht.isBuffer:o,_e=e.isFinite,Ue=xt.join,Je=ln(Mt.keys,Mt),wn=Ct.max,_n=Ct.min,bn=st.now,kn=e.parseInt,$n=Ct.random,Sn=xt.reverse,En=di(e,"DataView"),Cn=di(e,"Map"),Mn=di(e,"Promise"),Dn=di(e,"Set"),In=di(e,"WeakMap"),An=di(Mt,"create"),xn=In&&new In,Bn={},Ln=Pi(En),Nn=Pi(Cn),Tn=Pi(Mn),On=Pi(Dn),jn=Pi(In),Rn=Wt?Wt.prototype:o,Pn=Rn?Rn.valueOf:o,Un=Rn?Rn.toString:o;function zn(t){if(ns(t)&&!Ka(t)&&!(t instanceof Kn)){if(t instanceof Wn)return t;if(Ot.call(t,"__wrapped__"))return Ui(t)}return new Wn(t)}var Gn=function(){function t(){}return function(e){if(!es(e))return{};if(Jt)return Jt(e);t.prototype=e;var n=new t;return t.prototype=o,n}}();function Hn(){}function Wn(t,e){this.__wrapped__=t,this.__actions__=[],this.__chain__=!!e,this.__index__=0,this.__values__=o}function Kn(t){this.__wrapped__=t,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=p,this.__views__=[]}function Fn(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function Yn(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function Jn(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function qn(t){var e=-1,n=null==t?0:t.length;for(this.__data__=new Jn;++e<n;)this.add(t[e])}function Vn(t){var e=this.__data__=new Yn(t);this.size=e.size}function Zn(t,e){var n=Ka(t),r=!n&&Wa(t),o=!n&&!r&&qa(t),i=!n&&!r&&!o&&ls(t),a=n||r||o||i,s=a?Ze(t.length,It):[],c=s.length;for(var u in t)!e&&!Ot.call(t,u)||a&&("length"==u||o&&("offset"==u||"parent"==u)||i&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||_i(u,c))||s.push(u);return s}function Qn(t){var e=t.length;return e?t[qr(0,e-1)]:o}function Xn(t,e){return Oi(xo(t),cr(e,0,t.length))}function tr(t){return Oi(xo(t))}function er(t,e,n){(n!==o&&!za(t[e],n)||n===o&&!(e in t))&&ar(t,e,n)}function nr(t,e,n){var r=t[e];Ot.call(t,e)&&za(r,n)&&(n!==o||e in t)||ar(t,e,n)}function rr(t,e){for(var n=t.length;n--;)if(za(t[n][0],e))return n;return-1}function or(t,e,n,r){return dr(t,(function(t,o,i){e(r,t,n(t),i)})),r}function ir(t,e){return t&&Bo(e,Bs(e),t)}function ar(t,e,n){"__proto__"==e&&ne?ne(t,e,{configurable:!0,enumerable:!0,value:n,writable:!0}):t[e]=n}function sr(t,e){for(var n=-1,i=e.length,a=r(i),s=null==t;++n<i;)a[n]=s?o:Ms(t,e[n]);return a}function cr(t,e,n){return t==t&&(n!==o&&(t=t<=n?t:n),e!==o&&(t=t>=e?t:e)),t}function ur(t,e,n,r,i,a){var s,c=1&e,u=2&e,l=4&e;if(n&&(s=i?n(t,r,i,a):n(t)),s!==o)return s;if(!es(t))return t;var h=Ka(t);if(h){if(s=function(t){var e=t.length,n=new t.constructor(e);e&&"string"==typeof t[0]&&Ot.call(t,"index")&&(n.index=t.index,n.input=t.input);return n}(t),!c)return xo(t,s)}else{var f=pi(t),d=f==$||f==S;if(qa(t))return Eo(t,c);if(f==M||f==v||d&&!i){if(s=u||d?{}:vi(t),!c)return u?function(t,e){return Bo(t,mi(t),e)}(t,function(t,e){return t&&Bo(e,Ls(e),t)}(s,t)):function(t,e){return Bo(t,gi(t),e)}(t,ir(s,t))}else{if(!ue[f])return i?t:{};s=function(t,e,n){var r=t.constructor;switch(e){case N:return Co(t);case _:case b:return new r(+t);case T:return function(t,e){var n=e?Co(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.byteLength)}(t,n);case O:case j:case R:case P:case U:case z:case G:case H:case W:return Mo(t,n);case E:return new r;case C:case x:return new r(t);case I:return function(t){var e=new t.constructor(t.source,mt.exec(t));return e.lastIndex=t.lastIndex,e}(t);case A:return new r;case B:return o=t,Pn?Mt(Pn.call(o)):{}}var o}(t,f,c)}}a||(a=new Vn);var g=a.get(t);if(g)return g;a.set(t,s),ss(t)?t.forEach((function(r){s.add(ur(r,e,n,r,t,a))})):rs(t)&&t.forEach((function(r,o){s.set(o,ur(r,e,n,o,t,a))}));var m=h?o:(l?u?ai:ii:u?Ls:Bs)(t);return Ie(m||t,(function(r,o){m&&(r=t[o=r]),nr(s,o,ur(r,e,n,o,t,a))})),s}function lr(t,e,n){var r=n.length;if(null==t)return!r;for(t=Mt(t);r--;){var i=n[r],a=e[i],s=t[i];if(s===o&&!(i in t)||!a(s))return!1}return!0}function hr(t,e,n){if("function"!=typeof t)throw new At(i);return Bi((function(){t.apply(o,n)}),e)}function fr(t,e,n,r){var o=-1,i=Le,a=!0,s=t.length,c=[],u=e.length;if(!s)return c;n&&(e=Te(e,Xe(n))),r?(i=Ne,a=!1):e.length>=200&&(i=en,a=!1,e=new qn(e));t:for(;++o<s;){var l=t[o],h=null==n?l:n(l);if(l=r||0!==l?l:0,a&&h==h){for(var f=u;f--;)if(e[f]===h)continue t;c.push(l)}else i(e,h,r)||c.push(l)}return c}zn.templateSettings={escape:Q,evaluate:X,interpolate:tt,variable:"",imports:{_:zn}},zn.prototype=Hn.prototype,zn.prototype.constructor=zn,Wn.prototype=Gn(Hn.prototype),Wn.prototype.constructor=Wn,Kn.prototype=Gn(Hn.prototype),Kn.prototype.constructor=Kn,Fn.prototype.clear=function(){this.__data__=An?An(null):{},this.size=0},Fn.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},Fn.prototype.get=function(t){var e=this.__data__;if(An){var n=e[t];return n===a?o:n}return Ot.call(e,t)?e[t]:o},Fn.prototype.has=function(t){var e=this.__data__;return An?e[t]!==o:Ot.call(e,t)},Fn.prototype.set=function(t,e){var n=this.__data__;return this.size+=this.has(t)?0:1,n[t]=An&&e===o?a:e,this},Yn.prototype.clear=function(){this.__data__=[],this.size=0},Yn.prototype.delete=function(t){var e=this.__data__,n=rr(e,t);return!(n<0)&&(n==e.length-1?e.pop():Vt.call(e,n,1),--this.size,!0)},Yn.prototype.get=function(t){var e=this.__data__,n=rr(e,t);return n<0?o:e[n][1]},Yn.prototype.has=function(t){return rr(this.__data__,t)>-1},Yn.prototype.set=function(t,e){var n=this.__data__,r=rr(n,t);return r<0?(++this.size,n.push([t,e])):n[r][1]=e,this},Jn.prototype.clear=function(){this.size=0,this.__data__={hash:new Fn,map:new(Cn||Yn),string:new Fn}},Jn.prototype.delete=function(t){var e=hi(this,t).delete(t);return this.size-=e?1:0,e},Jn.prototype.get=function(t){return hi(this,t).get(t)},Jn.prototype.has=function(t){return hi(this,t).has(t)},Jn.prototype.set=function(t,e){var n=hi(this,t),r=n.size;return n.set(t,e),this.size+=n.size==r?0:1,this},qn.prototype.add=qn.prototype.push=function(t){return this.__data__.set(t,a),this},qn.prototype.has=function(t){return this.__data__.has(t)},Vn.prototype.clear=function(){this.__data__=new Yn,this.size=0},Vn.prototype.delete=function(t){var e=this.__data__,n=e.delete(t);return this.size=e.size,n},Vn.prototype.get=function(t){return this.__data__.get(t)},Vn.prototype.has=function(t){return this.__data__.has(t)},Vn.prototype.set=function(t,e){var n=this.__data__;if(n instanceof Yn){var r=n.__data__;if(!Cn||r.length<199)return r.push([t,e]),this.size=++n.size,this;n=this.__data__=new Jn(r)}return n.set(t,e),this.size=n.size,this};var dr=To(br),gr=To(kr,!0);function mr(t,e){var n=!0;return dr(t,(function(t,r,o){return n=!!e(t,r,o)})),n}function pr(t,e,n){for(var r=-1,i=t.length;++r<i;){var a=t[r],s=e(a);if(null!=s&&(c===o?s==s&&!us(s):n(s,c)))var c=s,u=a}return u}function yr(t,e){var n=[];return dr(t,(function(t,r,o){e(t,r,o)&&n.push(t)})),n}function vr(t,e,n,r,o){var i=-1,a=t.length;for(n||(n=wi),o||(o=[]);++i<a;){var s=t[i];e>0&&n(s)?e>1?vr(s,e-1,n,r,o):Oe(o,s):r||(o[o.length]=s)}return o}var wr=Oo(),_r=Oo(!0);function br(t,e){return t&&wr(t,e,Bs)}function kr(t,e){return t&&_r(t,e,Bs)}function $r(t,e){return Be(e,(function(e){return Qa(t[e])}))}function Sr(t,e){for(var n=0,r=(e=bo(e,t)).length;null!=t&&n<r;)t=t[Ri(e[n++])];return n&&n==r?t:o}function Er(t,e,n){var r=e(t);return Ka(t)?r:Oe(r,n(t))}function Cr(t){return null==t?t===o?"[object Undefined]":"[object Null]":Xt&&Xt in Mt(t)?function(t){var e=Ot.call(t,Xt),n=t[Xt];try{t[Xt]=o;var r=!0}catch(t){}var i=Pt.call(t);r&&(e?t[Xt]=n:delete t[Xt]);return i}(t):function(t){return Pt.call(t)}(t)}function Mr(t,e){return t>e}function Dr(t,e){return null!=t&&Ot.call(t,e)}function Ir(t,e){return null!=t&&e in Mt(t)}function Ar(t,e,n){for(var i=n?Ne:Le,a=t[0].length,s=t.length,c=s,u=r(s),l=1/0,h=[];c--;){var f=t[c];c&&e&&(f=Te(f,Xe(e))),l=_n(f.length,l),u[c]=!n&&(e||a>=120&&f.length>=120)?new qn(c&&f):o}f=t[0];var d=-1,g=u[0];t:for(;++d<a&&h.length<l;){var m=f[d],p=e?e(m):m;if(m=n||0!==m?m:0,!(g?en(g,p):i(h,p,n))){for(c=s;--c;){var y=u[c];if(!(y?en(y,p):i(t[c],p,n)))continue t}g&&g.push(p),h.push(m)}}return h}function xr(t,e,n){var r=null==(t=Ii(t,e=bo(e,t)))?t:t[Ri(Zi(e))];return null==r?o:Me(r,t,n)}function Br(t){return ns(t)&&Cr(t)==v}function Lr(t,e,n,r,i){return t===e||(null==t||null==e||!ns(t)&&!ns(e)?t!=t&&e!=e:function(t,e,n,r,i,a){var s=Ka(t),c=Ka(e),u=s?w:pi(t),l=c?w:pi(e),h=(u=u==v?M:u)==M,f=(l=l==v?M:l)==M,d=u==l;if(d&&qa(t)){if(!qa(e))return!1;s=!0,h=!1}if(d&&!h)return a||(a=new Vn),s||ls(t)?ri(t,e,n,r,i,a):function(t,e,n,r,o,i,a){switch(n){case T:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case N:return!(t.byteLength!=e.byteLength||!i(new Kt(t),new Kt(e)));case _:case b:case C:return za(+t,+e);case k:return t.name==e.name&&t.message==e.message;case I:case x:return t==e+"";case E:var s=un;case A:var c=1&r;if(s||(s=fn),t.size!=e.size&&!c)return!1;var u=a.get(t);if(u)return u==e;r|=2,a.set(t,e);var l=ri(s(t),s(e),r,o,i,a);return a.delete(t),l;case B:if(Pn)return Pn.call(t)==Pn.call(e)}return!1}(t,e,u,n,r,i,a);if(!(1&n)){var g=h&&Ot.call(t,"__wrapped__"),m=f&&Ot.call(e,"__wrapped__");if(g||m){var p=g?t.value():t,y=m?e.value():e;return a||(a=new Vn),i(p,y,n,r,a)}}if(!d)return!1;return a||(a=new Vn),function(t,e,n,r,i,a){var s=1&n,c=ii(t),u=c.length,l=ii(e),h=l.length;if(u!=h&&!s)return!1;var f=u;for(;f--;){var d=c[f];if(!(s?d in e:Ot.call(e,d)))return!1}var g=a.get(t),m=a.get(e);if(g&&m)return g==e&&m==t;var p=!0;a.set(t,e),a.set(e,t);var y=s;for(;++f<u;){var v=t[d=c[f]],w=e[d];if(r)var _=s?r(w,v,d,e,t,a):r(v,w,d,t,e,a);if(!(_===o?v===w||i(v,w,n,r,a):_)){p=!1;break}y||(y="constructor"==d)}if(p&&!y){var b=t.constructor,k=e.constructor;b==k||!("constructor"in t)||!("constructor"in e)||"function"==typeof b&&b instanceof b&&"function"==typeof k&&k instanceof k||(p=!1)}return a.delete(t),a.delete(e),p}(t,e,n,r,i,a)}(t,e,n,r,Lr,i))}function Nr(t,e,n,r){var i=n.length,a=i,s=!r;if(null==t)return!a;for(t=Mt(t);i--;){var c=n[i];if(s&&c[2]?c[1]!==t[c[0]]:!(c[0]in t))return!1}for(;++i<a;){var u=(c=n[i])[0],l=t[u],h=c[1];if(s&&c[2]){if(l===o&&!(u in t))return!1}else{var f=new Vn;if(r)var d=r(l,h,u,t,e,f);if(!(d===o?Lr(h,l,3,r,f):d))return!1}}return!0}function Tr(t){return!(!es(t)||(e=t,Rt&&Rt in e))&&(Qa(t)?Gt:vt).test(Pi(t));var e}function Or(t){return"function"==typeof t?t:null==t?oc:"object"==typeof t?Ka(t)?Gr(t[0],t[1]):zr(t):dc(t)}function jr(t){if(!Ei(t))return Je(t);var e=[];for(var n in Mt(t))Ot.call(t,n)&&"constructor"!=n&&e.push(n);return e}function Rr(t){if(!es(t))return function(t){var e=[];if(null!=t)for(var n in Mt(t))e.push(n);return e}(t);var e=Ei(t),n=[];for(var r in t)("constructor"!=r||!e&&Ot.call(t,r))&&n.push(r);return n}function Pr(t,e){return t<e}function Ur(t,e){var n=-1,o=Ya(t)?r(t.length):[];return dr(t,(function(t,r,i){o[++n]=e(t,r,i)})),o}function zr(t){var e=fi(t);return 1==e.length&&e[0][2]?Mi(e[0][0],e[0][1]):function(n){return n===t||Nr(n,t,e)}}function Gr(t,e){return ki(t)&&Ci(e)?Mi(Ri(t),e):function(n){var r=Ms(n,t);return r===o&&r===e?Ds(n,t):Lr(e,r,3)}}function Hr(t,e,n,r,i){t!==e&&wr(e,(function(a,s){if(i||(i=new Vn),es(a))!function(t,e,n,r,i,a,s){var c=Ai(t,n),u=Ai(e,n),l=s.get(u);if(l)return void er(t,n,l);var h=a?a(c,u,n+"",t,e,s):o,f=h===o;if(f){var d=Ka(u),g=!d&&qa(u),m=!d&&!g&&ls(u);h=u,d||g||m?Ka(c)?h=c:Ja(c)?h=xo(c):g?(f=!1,h=Eo(u,!0)):m?(f=!1,h=Mo(u,!0)):h=[]:is(u)||Wa(u)?(h=c,Wa(c)?h=vs(c):es(c)&&!Qa(c)||(h=vi(u))):f=!1}f&&(s.set(u,h),i(h,u,r,a,s),s.delete(u));er(t,n,h)}(t,e,s,n,Hr,r,i);else{var c=r?r(Ai(t,s),a,s+"",t,e,i):o;c===o&&(c=a),er(t,s,c)}}),Ls)}function Wr(t,e){var n=t.length;if(n)return _i(e+=e<0?n:0,n)?t[e]:o}function Kr(t,e,n){e=e.length?Te(e,(function(t){return Ka(t)?function(e){return Sr(e,1===t.length?t[0]:t)}:t})):[oc];var r=-1;e=Te(e,Xe(li()));var o=Ur(t,(function(t,n,o){var i=Te(e,(function(e){return e(t)}));return{criteria:i,index:++r,value:t}}));return function(t,e){var n=t.length;for(t.sort(e);n--;)t[n]=t[n].value;return t}(o,(function(t,e){return function(t,e,n){var r=-1,o=t.criteria,i=e.criteria,a=o.length,s=n.length;for(;++r<a;){var c=Do(o[r],i[r]);if(c)return r>=s?c:c*("desc"==n[r]?-1:1)}return t.index-e.index}(t,e,n)}))}function Fr(t,e,n){for(var r=-1,o=e.length,i={};++r<o;){var a=e[r],s=Sr(t,a);n(s,a)&&to(i,bo(a,t),s)}return i}function Yr(t,e,n,r){var o=r?We:He,i=-1,a=e.length,s=t;for(t===e&&(e=xo(e)),n&&(s=Te(t,Xe(n)));++i<a;)for(var c=0,u=e[i],l=n?n(u):u;(c=o(s,l,c,r))>-1;)s!==t&&Vt.call(s,c,1),Vt.call(t,c,1);return t}function Jr(t,e){for(var n=t?e.length:0,r=n-1;n--;){var o=e[n];if(n==r||o!==i){var i=o;_i(o)?Vt.call(t,o,1):fo(t,o)}}return t}function qr(t,e){return t+pe($n()*(e-t+1))}function Vr(t,e){var n="";if(!t||e<1||e>g)return n;do{e%2&&(n+=t),(e=pe(e/2))&&(t+=t)}while(e);return n}function Zr(t,e){return Li(Di(t,e,oc),t+"")}function Qr(t){return Qn(zs(t))}function Xr(t,e){var n=zs(t);return Oi(n,cr(e,0,n.length))}function to(t,e,n,r){if(!es(t))return t;for(var i=-1,a=(e=bo(e,t)).length,s=a-1,c=t;null!=c&&++i<a;){var u=Ri(e[i]),l=n;if("__proto__"===u||"constructor"===u||"prototype"===u)return t;if(i!=s){var h=c[u];(l=r?r(h,u,c):o)===o&&(l=es(h)?h:_i(e[i+1])?[]:{})}nr(c,u,l),c=c[u]}return t}var eo=xn?function(t,e){return xn.set(t,e),t}:oc,no=ne?function(t,e){return ne(t,"toString",{configurable:!0,enumerable:!1,value:ec(e),writable:!0})}:oc;function ro(t){return Oi(zs(t))}function oo(t,e,n){var o=-1,i=t.length;e<0&&(e=-e>i?0:i+e),(n=n>i?i:n)<0&&(n+=i),i=e>n?0:n-e>>>0,e>>>=0;for(var a=r(i);++o<i;)a[o]=t[o+e];return a}function io(t,e){var n;return dr(t,(function(t,r,o){return!(n=e(t,r,o))})),!!n}function ao(t,e,n){var r=0,o=null==t?r:t.length;if("number"==typeof e&&e==e&&o<=2147483647){for(;r<o;){var i=r+o>>>1,a=t[i];null!==a&&!us(a)&&(n?a<=e:a<e)?r=i+1:o=i}return o}return so(t,e,oc,n)}function so(t,e,n,r){var i=0,a=null==t?0:t.length;if(0===a)return 0;for(var s=(e=n(e))!=e,c=null===e,u=us(e),l=e===o;i<a;){var h=pe((i+a)/2),f=n(t[h]),d=f!==o,g=null===f,m=f==f,p=us(f);if(s)var y=r||m;else y=l?m&&(r||d):c?m&&d&&(r||!g):u?m&&d&&!g&&(r||!p):!g&&!p&&(r?f<=e:f<e);y?i=h+1:a=h}return _n(a,4294967294)}function co(t,e){for(var n=-1,r=t.length,o=0,i=[];++n<r;){var a=t[n],s=e?e(a):a;if(!n||!za(s,c)){var c=s;i[o++]=0===a?0:a}}return i}function uo(t){return"number"==typeof t?t:us(t)?m:+t}function lo(t){if("string"==typeof t)return t;if(Ka(t))return Te(t,lo)+"";if(us(t))return Un?Un.call(t):"";var e=t+"";return"0"==e&&1/t==-1/0?"-0":e}function ho(t,e,n){var r=-1,o=Le,i=t.length,a=!0,s=[],c=s;if(n)a=!1,o=Ne;else if(i>=200){var u=e?null:Zo(t);if(u)return fn(u);a=!1,o=en,c=new qn}else c=e?[]:s;t:for(;++r<i;){var l=t[r],h=e?e(l):l;if(l=n||0!==l?l:0,a&&h==h){for(var f=c.length;f--;)if(c[f]===h)continue t;e&&c.push(h),s.push(l)}else o(c,h,n)||(c!==s&&c.push(h),s.push(l))}return s}function fo(t,e){return null==(t=Ii(t,e=bo(e,t)))||delete t[Ri(Zi(e))]}function go(t,e,n,r){return to(t,e,n(Sr(t,e)),r)}function mo(t,e,n,r){for(var o=t.length,i=r?o:-1;(r?i--:++i<o)&&e(t[i],i,t););return n?oo(t,r?0:i,r?i+1:o):oo(t,r?i+1:0,r?o:i)}function po(t,e){var n=t;return n instanceof Kn&&(n=n.value()),je(e,(function(t,e){return e.func.apply(e.thisArg,Oe([t],e.args))}),n)}function yo(t,e,n){var o=t.length;if(o<2)return o?ho(t[0]):[];for(var i=-1,a=r(o);++i<o;)for(var s=t[i],c=-1;++c<o;)c!=i&&(a[i]=fr(a[i]||s,t[c],e,n));return ho(vr(a,1),e,n)}function vo(t,e,n){for(var r=-1,i=t.length,a=e.length,s={};++r<i;){var c=r<a?e[r]:o;n(s,t[r],c)}return s}function wo(t){return Ja(t)?t:[]}function _o(t){return"function"==typeof t?t:oc}function bo(t,e){return Ka(t)?t:ki(t,e)?[t]:ji(ws(t))}var ko=Zr;function $o(t,e,n){var r=t.length;return n=n===o?r:n,!e&&n>=r?t:oo(t,e,n)}var So=oe||function(t){return me.clearTimeout(t)};function Eo(t,e){if(e)return t.slice();var n=t.length,r=Ft?Ft(n):new t.constructor(n);return t.copy(r),r}function Co(t){var e=new t.constructor(t.byteLength);return new Kt(e).set(new Kt(t)),e}function Mo(t,e){var n=e?Co(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.length)}function Do(t,e){if(t!==e){var n=t!==o,r=null===t,i=t==t,a=us(t),s=e!==o,c=null===e,u=e==e,l=us(e);if(!c&&!l&&!a&&t>e||a&&s&&u&&!c&&!l||r&&s&&u||!n&&u||!i)return 1;if(!r&&!a&&!l&&t<e||l&&n&&i&&!r&&!a||c&&n&&i||!s&&i||!u)return-1}return 0}function Io(t,e,n,o){for(var i=-1,a=t.length,s=n.length,c=-1,u=e.length,l=wn(a-s,0),h=r(u+l),f=!o;++c<u;)h[c]=e[c];for(;++i<s;)(f||i<a)&&(h[n[i]]=t[i]);for(;l--;)h[c++]=t[i++];return h}function Ao(t,e,n,o){for(var i=-1,a=t.length,s=-1,c=n.length,u=-1,l=e.length,h=wn(a-c,0),f=r(h+l),d=!o;++i<h;)f[i]=t[i];for(var g=i;++u<l;)f[g+u]=e[u];for(;++s<c;)(d||i<a)&&(f[g+n[s]]=t[i++]);return f}function xo(t,e){var n=-1,o=t.length;for(e||(e=r(o));++n<o;)e[n]=t[n];return e}function Bo(t,e,n,r){var i=!n;n||(n={});for(var a=-1,s=e.length;++a<s;){var c=e[a],u=r?r(n[c],t[c],c,n,t):o;u===o&&(u=t[c]),i?ar(n,c,u):nr(n,c,u)}return n}function Lo(t,e){return function(n,r){var o=Ka(n)?De:or,i=e?e():{};return o(n,t,li(r,2),i)}}function No(t){return Zr((function(e,n){var r=-1,i=n.length,a=i>1?n[i-1]:o,s=i>2?n[2]:o;for(a=t.length>3&&"function"==typeof a?(i--,a):o,s&&bi(n[0],n[1],s)&&(a=i<3?o:a,i=1),e=Mt(e);++r<i;){var c=n[r];c&&t(e,c,r,a)}return e}))}function To(t,e){return function(n,r){if(null==n)return n;if(!Ya(n))return t(n,r);for(var o=n.length,i=e?o:-1,a=Mt(n);(e?i--:++i<o)&&!1!==r(a[i],i,a););return n}}function Oo(t){return function(e,n,r){for(var o=-1,i=Mt(e),a=r(e),s=a.length;s--;){var c=a[t?s:++o];if(!1===n(i[c],c,i))break}return e}}function jo(t){return function(e){var n=cn(e=ws(e))?mn(e):o,r=n?n[0]:e.charAt(0),i=n?$o(n,1).join(""):e.slice(1);return r[t]()+i}}function Ro(t){return function(e){return je(Qs(Ws(e).replace(te,"")),t,"")}}function Po(t){return function(){var e=arguments;switch(e.length){case 0:return new t;case 1:return new t(e[0]);case 2:return new t(e[0],e[1]);case 3:return new t(e[0],e[1],e[2]);case 4:return new t(e[0],e[1],e[2],e[3]);case 5:return new t(e[0],e[1],e[2],e[3],e[4]);case 6:return new t(e[0],e[1],e[2],e[3],e[4],e[5]);case 7:return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6])}var n=Gn(t.prototype),r=t.apply(n,e);return es(r)?r:n}}function Uo(t){return function(e,n,r){var i=Mt(e);if(!Ya(e)){var a=li(n,3);e=Bs(e),n=function(t){return a(i[t],t,i)}}var s=t(e,n,r);return s>-1?i[a?e[s]:s]:o}}function zo(t){return oi((function(e){var n=e.length,r=n,a=Wn.prototype.thru;for(t&&e.reverse();r--;){var s=e[r];if("function"!=typeof s)throw new At(i);if(a&&!c&&"wrapper"==ci(s))var c=new Wn([],!0)}for(r=c?r:n;++r<n;){var u=ci(s=e[r]),l="wrapper"==u?si(s):o;c=l&&$i(l[0])&&424==l[1]&&!l[4].length&&1==l[9]?c[ci(l[0])].apply(c,l[3]):1==s.length&&$i(s)?c[u]():c.thru(s)}return function(){var t=arguments,r=t[0];if(c&&1==t.length&&Ka(r))return c.plant(r).value();for(var o=0,i=n?e[o].apply(this,t):r;++o<n;)i=e[o].call(this,i);return i}}))}function Go(t,e,n,i,a,s,c,u,l,f){var d=e&h,g=1&e,m=2&e,p=24&e,y=512&e,v=m?o:Po(t);return function h(){for(var w=arguments.length,_=r(w),b=w;b--;)_[b]=arguments[b];if(p)var k=ui(h),$=function(t,e){for(var n=t.length,r=0;n--;)t[n]===e&&++r;return r}(_,k);if(i&&(_=Io(_,i,a,p)),s&&(_=Ao(_,s,c,p)),w-=$,p&&w<f){var S=hn(_,k);return qo(t,e,Go,h.placeholder,n,_,S,u,l,f-w)}var E=g?n:this,C=m?E[t]:t;return w=_.length,u?_=function(t,e){var n=t.length,r=_n(e.length,n),i=xo(t);for(;r--;){var a=e[r];t[r]=_i(a,n)?i[a]:o}return t}(_,u):y&&w>1&&_.reverse(),d&&l<w&&(_.length=l),this&&this!==me&&this instanceof h&&(C=v||Po(C)),C.apply(E,_)}}function Ho(t,e){return function(n,r){return function(t,e,n,r){return br(t,(function(t,o,i){e(r,n(t),o,i)})),r}(n,t,e(r),{})}}function Wo(t,e){return function(n,r){var i;if(n===o&&r===o)return e;if(n!==o&&(i=n),r!==o){if(i===o)return r;"string"==typeof n||"string"==typeof r?(n=lo(n),r=lo(r)):(n=uo(n),r=uo(r)),i=t(n,r)}return i}}function Ko(t){return oi((function(e){return e=Te(e,Xe(li())),Zr((function(n){var r=this;return t(e,(function(t){return Me(t,r,n)}))}))}))}function Fo(t,e){var n=(e=e===o?" ":lo(e)).length;if(n<2)return n?Vr(e,t):e;var r=Vr(e,ge(t/gn(e)));return cn(e)?$o(mn(r),0,t).join(""):r.slice(0,t)}function Yo(t){return function(e,n,i){return i&&"number"!=typeof i&&bi(e,n,i)&&(n=i=o),e=gs(e),n===o?(n=e,e=0):n=gs(n),function(t,e,n,o){for(var i=-1,a=wn(ge((e-t)/(n||1)),0),s=r(a);a--;)s[o?a:++i]=t,t+=n;return s}(e,n,i=i===o?e<n?1:-1:gs(i),t)}}function Jo(t){return function(e,n){return"string"==typeof e&&"string"==typeof n||(e=ys(e),n=ys(n)),t(e,n)}}function qo(t,e,n,r,i,a,s,c,h,f){var d=8&e;e|=d?u:l,4&(e&=~(d?l:u))||(e&=-4);var g=[t,e,i,d?a:o,d?s:o,d?o:a,d?o:s,c,h,f],m=n.apply(o,g);return $i(t)&&xi(m,g),m.placeholder=r,Ni(m,t,e)}function Vo(t){var e=Ct[t];return function(t,n){if(t=ys(t),(n=null==n?0:_n(ms(n),292))&&_e(t)){var r=(ws(t)+"e").split("e");return+((r=(ws(e(r[0]+"e"+(+r[1]+n)))+"e").split("e"))[0]+"e"+(+r[1]-n))}return e(t)}}var Zo=Dn&&1/fn(new Dn([,-0]))[1]==d?function(t){return new Dn(t)}:uc;function Qo(t){return function(e){var n=pi(e);return n==E?un(e):n==A?dn(e):function(t,e){return Te(e,(function(e){return[e,t[e]]}))}(e,t(e))}}function Xo(t,e,n,a,d,g,m,p){var y=2&e;if(!y&&"function"!=typeof t)throw new At(i);var v=a?a.length:0;if(v||(e&=-97,a=d=o),m=m===o?m:wn(ms(m),0),p=p===o?p:ms(p),v-=d?d.length:0,e&l){var w=a,_=d;a=d=o}var b=y?o:si(t),k=[t,e,n,a,d,w,_,g,m,p];if(b&&function(t,e){var n=t[1],r=e[1],o=n|r,i=o<131,a=r==h&&8==n||r==h&&n==f&&t[7].length<=e[8]||384==r&&e[7].length<=e[8]&&8==n;if(!i&&!a)return t;1&r&&(t[2]=e[2],o|=1&n?0:4);var c=e[3];if(c){var u=t[3];t[3]=u?Io(u,c,e[4]):c,t[4]=u?hn(t[3],s):e[4]}(c=e[5])&&(u=t[5],t[5]=u?Ao(u,c,e[6]):c,t[6]=u?hn(t[5],s):e[6]);(c=e[7])&&(t[7]=c);r&h&&(t[8]=null==t[8]?e[8]:_n(t[8],e[8]));null==t[9]&&(t[9]=e[9]);t[0]=e[0],t[1]=o}(k,b),t=k[0],e=k[1],n=k[2],a=k[3],d=k[4],!(p=k[9]=k[9]===o?y?0:t.length:wn(k[9]-v,0))&&24&e&&(e&=-25),e&&1!=e)$=8==e||e==c?function(t,e,n){var i=Po(t);return function a(){for(var s=arguments.length,c=r(s),u=s,l=ui(a);u--;)c[u]=arguments[u];var h=s<3&&c[0]!==l&&c[s-1]!==l?[]:hn(c,l);return(s-=h.length)<n?qo(t,e,Go,a.placeholder,o,c,h,o,o,n-s):Me(this&&this!==me&&this instanceof a?i:t,this,c)}}(t,e,p):e!=u&&33!=e||d.length?Go.apply(o,k):function(t,e,n,o){var i=1&e,a=Po(t);return function e(){for(var s=-1,c=arguments.length,u=-1,l=o.length,h=r(l+c),f=this&&this!==me&&this instanceof e?a:t;++u<l;)h[u]=o[u];for(;c--;)h[u++]=arguments[++s];return Me(f,i?n:this,h)}}(t,e,n,a);else var $=function(t,e,n){var r=1&e,o=Po(t);return function e(){return(this&&this!==me&&this instanceof e?o:t).apply(r?n:this,arguments)}}(t,e,n);return Ni((b?eo:xi)($,k),t,e)}function ti(t,e,n,r){return t===o||za(t,Lt[n])&&!Ot.call(r,n)?e:t}function ei(t,e,n,r,i,a){return es(t)&&es(e)&&(a.set(e,t),Hr(t,e,o,ei,a),a.delete(e)),t}function ni(t){return is(t)?o:t}function ri(t,e,n,r,i,a){var s=1&n,c=t.length,u=e.length;if(c!=u&&!(s&&u>c))return!1;var l=a.get(t),h=a.get(e);if(l&&h)return l==e&&h==t;var f=-1,d=!0,g=2&n?new qn:o;for(a.set(t,e),a.set(e,t);++f<c;){var m=t[f],p=e[f];if(r)var y=s?r(p,m,f,e,t,a):r(m,p,f,t,e,a);if(y!==o){if(y)continue;d=!1;break}if(g){if(!Pe(e,(function(t,e){if(!en(g,e)&&(m===t||i(m,t,n,r,a)))return g.push(e)}))){d=!1;break}}else if(m!==p&&!i(m,p,n,r,a)){d=!1;break}}return a.delete(t),a.delete(e),d}function oi(t){return Li(Di(t,o,Fi),t+"")}function ii(t){return Er(t,Bs,gi)}function ai(t){return Er(t,Ls,mi)}var si=xn?function(t){return xn.get(t)}:uc;function ci(t){for(var e=t.name+"",n=Bn[e],r=Ot.call(Bn,e)?n.length:0;r--;){var o=n[r],i=o.func;if(null==i||i==t)return o.name}return e}function ui(t){return(Ot.call(zn,"placeholder")?zn:t).placeholder}function li(){var t=zn.iteratee||ic;return t=t===ic?Or:t,arguments.length?t(arguments[0],arguments[1]):t}function hi(t,e){var n,r,o=t.__data__;return("string"==(r=typeof(n=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof e?"string":"hash"]:o.map}function fi(t){for(var e=Bs(t),n=e.length;n--;){var r=e[n],o=t[r];e[n]=[r,o,Ci(o)]}return e}function di(t,e){var n=function(t,e){return null==t?o:t[e]}(t,e);return Tr(n)?n:o}var gi=ye?function(t){return null==t?[]:(t=Mt(t),Be(ye(t),(function(e){return qt.call(t,e)})))}:pc,mi=ye?function(t){for(var e=[];t;)Oe(e,gi(t)),t=Yt(t);return e}:pc,pi=Cr;function yi(t,e,n){for(var r=-1,o=(e=bo(e,t)).length,i=!1;++r<o;){var a=Ri(e[r]);if(!(i=null!=t&&n(t,a)))break;t=t[a]}return i||++r!=o?i:!!(o=null==t?0:t.length)&&ts(o)&&_i(a,o)&&(Ka(t)||Wa(t))}function vi(t){return"function"!=typeof t.constructor||Ei(t)?{}:Gn(Yt(t))}function wi(t){return Ka(t)||Wa(t)||!!(Zt&&t&&t[Zt])}function _i(t,e){var n=typeof t;return!!(e=null==e?g:e)&&("number"==n||"symbol"!=n&&_t.test(t))&&t>-1&&t%1==0&&t<e}function bi(t,e,n){if(!es(n))return!1;var r=typeof e;return!!("number"==r?Ya(n)&&_i(e,n.length):"string"==r&&e in n)&&za(n[e],t)}function ki(t,e){if(Ka(t))return!1;var n=typeof t;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=t&&!us(t))||(nt.test(t)||!et.test(t)||null!=e&&t in Mt(e))}function $i(t){var e=ci(t),n=zn[e];if("function"!=typeof n||!(e in Kn.prototype))return!1;if(t===n)return!0;var r=si(n);return!!r&&t===r[0]}(En&&pi(new En(new ArrayBuffer(1)))!=T||Cn&&pi(new Cn)!=E||Mn&&pi(Mn.resolve())!=D||Dn&&pi(new Dn)!=A||In&&pi(new In)!=L)&&(pi=function(t){var e=Cr(t),n=e==M?t.constructor:o,r=n?Pi(n):"";if(r)switch(r){case Ln:return T;case Nn:return E;case Tn:return D;case On:return A;case jn:return L}return e});var Si=Nt?Qa:yc;function Ei(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||Lt)}function Ci(t){return t==t&&!es(t)}function Mi(t,e){return function(n){return null!=n&&(n[t]===e&&(e!==o||t in Mt(n)))}}function Di(t,e,n){return e=wn(e===o?t.length-1:e,0),function(){for(var o=arguments,i=-1,a=wn(o.length-e,0),s=r(a);++i<a;)s[i]=o[e+i];i=-1;for(var c=r(e+1);++i<e;)c[i]=o[i];return c[e]=n(s),Me(t,this,c)}}function Ii(t,e){return e.length<2?t:Sr(t,oo(e,0,-1))}function Ai(t,e){if(("constructor"!==e||"function"!=typeof t[e])&&"__proto__"!=e)return t[e]}var xi=Ti(eo),Bi=de||function(t,e){return me.setTimeout(t,e)},Li=Ti(no);function Ni(t,e,n){var r=e+"";return Li(t,function(t,e){var n=e.length;if(!n)return t;var r=n-1;return e[r]=(n>1?"& ":"")+e[r],e=e.join(n>2?", ":" "),t.replace(ct,"{\n/* [wrapped with "+e+"] */\n")}(r,function(t,e){return Ie(y,(function(n){var r="_."+n[0];e&n[1]&&!Le(t,r)&&t.push(r)})),t.sort()}(function(t){var e=t.match(ut);return e?e[1].split(lt):[]}(r),n)))}function Ti(t){var e=0,n=0;return function(){var r=bn(),i=16-(r-n);if(n=r,i>0){if(++e>=800)return arguments[0]}else e=0;return t.apply(o,arguments)}}function Oi(t,e){var n=-1,r=t.length,i=r-1;for(e=e===o?r:e;++n<e;){var a=qr(n,i),s=t[a];t[a]=t[n],t[n]=s}return t.length=e,t}var ji=function(t){var e=Ta(t,(function(t){return 500===n.size&&n.clear(),t})),n=e.cache;return e}((function(t){var e=[];return 46===t.charCodeAt(0)&&e.push(""),t.replace(rt,(function(t,n,r,o){e.push(r?o.replace(dt,"$1"):n||t)})),e}));function Ri(t){if("string"==typeof t||us(t))return t;var e=t+"";return"0"==e&&1/t==-1/0?"-0":e}function Pi(t){if(null!=t){try{return Tt.call(t)}catch(t){}try{return t+""}catch(t){}}return""}function Ui(t){if(t instanceof Kn)return t.clone();var e=new Wn(t.__wrapped__,t.__chain__);return e.__actions__=xo(t.__actions__),e.__index__=t.__index__,e.__values__=t.__values__,e}var zi=Zr((function(t,e){return Ja(t)?fr(t,vr(e,1,Ja,!0)):[]})),Gi=Zr((function(t,e){var n=Zi(e);return Ja(n)&&(n=o),Ja(t)?fr(t,vr(e,1,Ja,!0),li(n,2)):[]})),Hi=Zr((function(t,e){var n=Zi(e);return Ja(n)&&(n=o),Ja(t)?fr(t,vr(e,1,Ja,!0),o,n):[]}));function Wi(t,e,n){var r=null==t?0:t.length;if(!r)return-1;var o=null==n?0:ms(n);return o<0&&(o=wn(r+o,0)),Ge(t,li(e,3),o)}function Ki(t,e,n){var r=null==t?0:t.length;if(!r)return-1;var i=r-1;return n!==o&&(i=ms(n),i=n<0?wn(r+i,0):_n(i,r-1)),Ge(t,li(e,3),i,!0)}function Fi(t){return(null==t?0:t.length)?vr(t,1):[]}function Yi(t){return t&&t.length?t[0]:o}var Ji=Zr((function(t){var e=Te(t,wo);return e.length&&e[0]===t[0]?Ar(e):[]})),qi=Zr((function(t){var e=Zi(t),n=Te(t,wo);return e===Zi(n)?e=o:n.pop(),n.length&&n[0]===t[0]?Ar(n,li(e,2)):[]})),Vi=Zr((function(t){var e=Zi(t),n=Te(t,wo);return(e="function"==typeof e?e:o)&&n.pop(),n.length&&n[0]===t[0]?Ar(n,o,e):[]}));function Zi(t){var e=null==t?0:t.length;return e?t[e-1]:o}var Qi=Zr(Xi);function Xi(t,e){return t&&t.length&&e&&e.length?Yr(t,e):t}var ta=oi((function(t,e){var n=null==t?0:t.length,r=sr(t,e);return Jr(t,Te(e,(function(t){return _i(t,n)?+t:t})).sort(Do)),r}));function ea(t){return null==t?t:Sn.call(t)}var na=Zr((function(t){return ho(vr(t,1,Ja,!0))})),ra=Zr((function(t){var e=Zi(t);return Ja(e)&&(e=o),ho(vr(t,1,Ja,!0),li(e,2))})),oa=Zr((function(t){var e=Zi(t);return e="function"==typeof e?e:o,ho(vr(t,1,Ja,!0),o,e)}));function ia(t){if(!t||!t.length)return[];var e=0;return t=Be(t,(function(t){if(Ja(t))return e=wn(t.length,e),!0})),Ze(e,(function(e){return Te(t,Ye(e))}))}function aa(t,e){if(!t||!t.length)return[];var n=ia(t);return null==e?n:Te(n,(function(t){return Me(e,o,t)}))}var sa=Zr((function(t,e){return Ja(t)?fr(t,e):[]})),ca=Zr((function(t){return yo(Be(t,Ja))})),ua=Zr((function(t){var e=Zi(t);return Ja(e)&&(e=o),yo(Be(t,Ja),li(e,2))})),la=Zr((function(t){var e=Zi(t);return e="function"==typeof e?e:o,yo(Be(t,Ja),o,e)})),ha=Zr(ia);var fa=Zr((function(t){var e=t.length,n=e>1?t[e-1]:o;return n="function"==typeof n?(t.pop(),n):o,aa(t,n)}));function da(t){var e=zn(t);return e.__chain__=!0,e}function ga(t,e){return e(t)}var ma=oi((function(t){var e=t.length,n=e?t[0]:0,r=this.__wrapped__,i=function(e){return sr(e,t)};return!(e>1||this.__actions__.length)&&r instanceof Kn&&_i(n)?((r=r.slice(n,+n+(e?1:0))).__actions__.push({func:ga,args:[i],thisArg:o}),new Wn(r,this.__chain__).thru((function(t){return e&&!t.length&&t.push(o),t}))):this.thru(i)}));var pa=Lo((function(t,e,n){Ot.call(t,n)?++t[n]:ar(t,n,1)}));var ya=Uo(Wi),va=Uo(Ki);function wa(t,e){return(Ka(t)?Ie:dr)(t,li(e,3))}function _a(t,e){return(Ka(t)?Ae:gr)(t,li(e,3))}var ba=Lo((function(t,e,n){Ot.call(t,n)?t[n].push(e):ar(t,n,[e])}));var ka=Zr((function(t,e,n){var o=-1,i="function"==typeof e,a=Ya(t)?r(t.length):[];return dr(t,(function(t){a[++o]=i?Me(e,t,n):xr(t,e,n)})),a})),$a=Lo((function(t,e,n){ar(t,n,e)}));function Sa(t,e){return(Ka(t)?Te:Ur)(t,li(e,3))}var Ea=Lo((function(t,e,n){t[n?0:1].push(e)}),(function(){return[[],[]]}));var Ca=Zr((function(t,e){if(null==t)return[];var n=e.length;return n>1&&bi(t,e[0],e[1])?e=[]:n>2&&bi(e[0],e[1],e[2])&&(e=[e[0]]),Kr(t,vr(e,1),[])})),Ma=le||function(){return me.Date.now()};function Da(t,e,n){return e=n?o:e,e=t&&null==e?t.length:e,Xo(t,h,o,o,o,o,e)}function Ia(t,e){var n;if("function"!=typeof e)throw new At(i);return t=ms(t),function(){return--t>0&&(n=e.apply(this,arguments)),t<=1&&(e=o),n}}var Aa=Zr((function(t,e,n){var r=1;if(n.length){var o=hn(n,ui(Aa));r|=u}return Xo(t,r,e,n,o)})),xa=Zr((function(t,e,n){var r=3;if(n.length){var o=hn(n,ui(xa));r|=u}return Xo(e,r,t,n,o)}));function Ba(t,e,n){var r,a,s,c,u,l,h=0,f=!1,d=!1,g=!0;if("function"!=typeof t)throw new At(i);function m(e){var n=r,i=a;return r=a=o,h=e,c=t.apply(i,n)}function p(t){var n=t-l;return l===o||n>=e||n<0||d&&t-h>=s}function y(){var t=Ma();if(p(t))return v(t);u=Bi(y,function(t){var n=e-(t-l);return d?_n(n,s-(t-h)):n}(t))}function v(t){return u=o,g&&r?m(t):(r=a=o,c)}function w(){var t=Ma(),n=p(t);if(r=arguments,a=this,l=t,n){if(u===o)return function(t){return h=t,u=Bi(y,e),f?m(t):c}(l);if(d)return So(u),u=Bi(y,e),m(l)}return u===o&&(u=Bi(y,e)),c}return e=ys(e)||0,es(n)&&(f=!!n.leading,s=(d="maxWait"in n)?wn(ys(n.maxWait)||0,e):s,g="trailing"in n?!!n.trailing:g),w.cancel=function(){u!==o&&So(u),h=0,r=l=a=u=o},w.flush=function(){return u===o?c:v(Ma())},w}var La=Zr((function(t,e){return hr(t,1,e)})),Na=Zr((function(t,e,n){return hr(t,ys(e)||0,n)}));function Ta(t,e){if("function"!=typeof t||null!=e&&"function"!=typeof e)throw new At(i);var n=function(){var r=arguments,o=e?e.apply(this,r):r[0],i=n.cache;if(i.has(o))return i.get(o);var a=t.apply(this,r);return n.cache=i.set(o,a)||i,a};return n.cache=new(Ta.Cache||Jn),n}function Oa(t){if("function"!=typeof t)throw new At(i);return function(){var e=arguments;switch(e.length){case 0:return!t.call(this);case 1:return!t.call(this,e[0]);case 2:return!t.call(this,e[0],e[1]);case 3:return!t.call(this,e[0],e[1],e[2])}return!t.apply(this,e)}}Ta.Cache=Jn;var ja=ko((function(t,e){var n=(e=1==e.length&&Ka(e[0])?Te(e[0],Xe(li())):Te(vr(e,1),Xe(li()))).length;return Zr((function(r){for(var o=-1,i=_n(r.length,n);++o<i;)r[o]=e[o].call(this,r[o]);return Me(t,this,r)}))})),Ra=Zr((function(t,e){var n=hn(e,ui(Ra));return Xo(t,u,o,e,n)})),Pa=Zr((function(t,e){var n=hn(e,ui(Pa));return Xo(t,l,o,e,n)})),Ua=oi((function(t,e){return Xo(t,f,o,o,o,e)}));function za(t,e){return t===e||t!=t&&e!=e}var Ga=Jo(Mr),Ha=Jo((function(t,e){return t>=e})),Wa=Br(function(){return arguments}())?Br:function(t){return ns(t)&&Ot.call(t,"callee")&&!qt.call(t,"callee")},Ka=r.isArray,Fa=be?Xe(be):function(t){return ns(t)&&Cr(t)==N};function Ya(t){return null!=t&&ts(t.length)&&!Qa(t)}function Ja(t){return ns(t)&&Ya(t)}var qa=we||yc,Va=ke?Xe(ke):function(t){return ns(t)&&Cr(t)==b};function Za(t){if(!ns(t))return!1;var e=Cr(t);return e==k||"[object DOMException]"==e||"string"==typeof t.message&&"string"==typeof t.name&&!is(t)}function Qa(t){if(!es(t))return!1;var e=Cr(t);return e==$||e==S||"[object AsyncFunction]"==e||"[object Proxy]"==e}function Xa(t){return"number"==typeof t&&t==ms(t)}function ts(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=g}function es(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function ns(t){return null!=t&&"object"==typeof t}var rs=$e?Xe($e):function(t){return ns(t)&&pi(t)==E};function os(t){return"number"==typeof t||ns(t)&&Cr(t)==C}function is(t){if(!ns(t)||Cr(t)!=M)return!1;var e=Yt(t);if(null===e)return!0;var n=Ot.call(e,"constructor")&&e.constructor;return"function"==typeof n&&n instanceof n&&Tt.call(n)==Ut}var as=Se?Xe(Se):function(t){return ns(t)&&Cr(t)==I};var ss=Ee?Xe(Ee):function(t){return ns(t)&&pi(t)==A};function cs(t){return"string"==typeof t||!Ka(t)&&ns(t)&&Cr(t)==x}function us(t){return"symbol"==typeof t||ns(t)&&Cr(t)==B}var ls=Ce?Xe(Ce):function(t){return ns(t)&&ts(t.length)&&!!ce[Cr(t)]};var hs=Jo(Pr),fs=Jo((function(t,e){return t<=e}));function ds(t){if(!t)return[];if(Ya(t))return cs(t)?mn(t):xo(t);if(Qt&&t[Qt])return function(t){for(var e,n=[];!(e=t.next()).done;)n.push(e.value);return n}(t[Qt]());var e=pi(t);return(e==E?un:e==A?fn:zs)(t)}function gs(t){return t?(t=ys(t))===d||t===-1/0?17976931348623157e292*(t<0?-1:1):t==t?t:0:0===t?t:0}function ms(t){var e=gs(t),n=e%1;return e==e?n?e-n:e:0}function ps(t){return t?cr(ms(t),0,p):0}function ys(t){if("number"==typeof t)return t;if(us(t))return m;if(es(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=es(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=Qe(t);var n=yt.test(t);return n||wt.test(t)?fe(t.slice(2),n?2:8):pt.test(t)?m:+t}function vs(t){return Bo(t,Ls(t))}function ws(t){return null==t?"":lo(t)}var _s=No((function(t,e){if(Ei(e)||Ya(e))Bo(e,Bs(e),t);else for(var n in e)Ot.call(e,n)&&nr(t,n,e[n])})),bs=No((function(t,e){Bo(e,Ls(e),t)})),ks=No((function(t,e,n,r){Bo(e,Ls(e),t,r)})),$s=No((function(t,e,n,r){Bo(e,Bs(e),t,r)})),Ss=oi(sr);var Es=Zr((function(t,e){t=Mt(t);var n=-1,r=e.length,i=r>2?e[2]:o;for(i&&bi(e[0],e[1],i)&&(r=1);++n<r;)for(var a=e[n],s=Ls(a),c=-1,u=s.length;++c<u;){var l=s[c],h=t[l];(h===o||za(h,Lt[l])&&!Ot.call(t,l))&&(t[l]=a[l])}return t})),Cs=Zr((function(t){return t.push(o,ei),Me(Ts,o,t)}));function Ms(t,e,n){var r=null==t?o:Sr(t,e);return r===o?n:r}function Ds(t,e){return null!=t&&yi(t,e,Ir)}var Is=Ho((function(t,e,n){null!=e&&"function"!=typeof e.toString&&(e=Pt.call(e)),t[e]=n}),ec(oc)),As=Ho((function(t,e,n){null!=e&&"function"!=typeof e.toString&&(e=Pt.call(e)),Ot.call(t,e)?t[e].push(n):t[e]=[n]}),li),xs=Zr(xr);function Bs(t){return Ya(t)?Zn(t):jr(t)}function Ls(t){return Ya(t)?Zn(t,!0):Rr(t)}var Ns=No((function(t,e,n){Hr(t,e,n)})),Ts=No((function(t,e,n,r){Hr(t,e,n,r)})),Os=oi((function(t,e){var n={};if(null==t)return n;var r=!1;e=Te(e,(function(e){return e=bo(e,t),r||(r=e.length>1),e})),Bo(t,ai(t),n),r&&(n=ur(n,7,ni));for(var o=e.length;o--;)fo(n,e[o]);return n}));var js=oi((function(t,e){return null==t?{}:function(t,e){return Fr(t,e,(function(e,n){return Ds(t,n)}))}(t,e)}));function Rs(t,e){if(null==t)return{};var n=Te(ai(t),(function(t){return[t]}));return e=li(e),Fr(t,n,(function(t,n){return e(t,n[0])}))}var Ps=Qo(Bs),Us=Qo(Ls);function zs(t){return null==t?[]:tn(t,Bs(t))}var Gs=Ro((function(t,e,n){return e=e.toLowerCase(),t+(n?Hs(e):e)}));function Hs(t){return Zs(ws(t).toLowerCase())}function Ws(t){return(t=ws(t))&&t.replace(bt,on).replace(ee,"")}var Ks=Ro((function(t,e,n){return t+(n?"-":"")+e.toLowerCase()})),Fs=Ro((function(t,e,n){return t+(n?" ":"")+e.toLowerCase()})),Ys=jo("toLowerCase");var Js=Ro((function(t,e,n){return t+(n?"_":"")+e.toLowerCase()}));var qs=Ro((function(t,e,n){return t+(n?" ":"")+Zs(e)}));var Vs=Ro((function(t,e,n){return t+(n?" ":"")+e.toUpperCase()})),Zs=jo("toUpperCase");function Qs(t,e,n){return t=ws(t),(e=n?o:e)===o?function(t){return ie.test(t)}(t)?function(t){return t.match(re)||[]}(t):function(t){return t.match(ht)||[]}(t):t.match(e)||[]}var Xs=Zr((function(t,e){try{return Me(t,o,e)}catch(t){return Za(t)?t:new St(t)}})),tc=oi((function(t,e){return Ie(e,(function(e){e=Ri(e),ar(t,e,Aa(t[e],t))})),t}));function ec(t){return function(){return t}}var nc=zo(),rc=zo(!0);function oc(t){return t}function ic(t){return Or("function"==typeof t?t:ur(t,1))}var ac=Zr((function(t,e){return function(n){return xr(n,t,e)}})),sc=Zr((function(t,e){return function(n){return xr(t,n,e)}}));function cc(t,e,n){var r=Bs(e),o=$r(e,r);null!=n||es(e)&&(o.length||!r.length)||(n=e,e=t,t=this,o=$r(e,Bs(e)));var i=!(es(n)&&"chain"in n&&!n.chain),a=Qa(t);return Ie(o,(function(n){var r=e[n];t[n]=r,a&&(t.prototype[n]=function(){var e=this.__chain__;if(i||e){var n=t(this.__wrapped__);return(n.__actions__=xo(this.__actions__)).push({func:r,args:arguments,thisArg:t}),n.__chain__=e,n}return r.apply(t,Oe([this.value()],arguments))})})),t}function uc(){}var lc=Ko(Te),hc=Ko(xe),fc=Ko(Pe);function dc(t){return ki(t)?Ye(Ri(t)):function(t){return function(e){return Sr(e,t)}}(t)}var gc=Yo(),mc=Yo(!0);function pc(){return[]}function yc(){return!1}var vc=Wo((function(t,e){return t+e}),0),wc=Vo("ceil"),_c=Wo((function(t,e){return t/e}),1),bc=Vo("floor");var kc,$c=Wo((function(t,e){return t*e}),1),Sc=Vo("round"),Ec=Wo((function(t,e){return t-e}),0);return zn.after=function(t,e){if("function"!=typeof e)throw new At(i);return t=ms(t),function(){if(--t<1)return e.apply(this,arguments)}},zn.ary=Da,zn.assign=_s,zn.assignIn=bs,zn.assignInWith=ks,zn.assignWith=$s,zn.at=Ss,zn.before=Ia,zn.bind=Aa,zn.bindAll=tc,zn.bindKey=xa,zn.castArray=function(){if(!arguments.length)return[];var t=arguments[0];return Ka(t)?t:[t]},zn.chain=da,zn.chunk=function(t,e,n){e=(n?bi(t,e,n):e===o)?1:wn(ms(e),0);var i=null==t?0:t.length;if(!i||e<1)return[];for(var a=0,s=0,c=r(ge(i/e));a<i;)c[s++]=oo(t,a,a+=e);return c},zn.compact=function(t){for(var e=-1,n=null==t?0:t.length,r=0,o=[];++e<n;){var i=t[e];i&&(o[r++]=i)}return o},zn.concat=function(){var t=arguments.length;if(!t)return[];for(var e=r(t-1),n=arguments[0],o=t;o--;)e[o-1]=arguments[o];return Oe(Ka(n)?xo(n):[n],vr(e,1))},zn.cond=function(t){var e=null==t?0:t.length,n=li();return t=e?Te(t,(function(t){if("function"!=typeof t[1])throw new At(i);return[n(t[0]),t[1]]})):[],Zr((function(n){for(var r=-1;++r<e;){var o=t[r];if(Me(o[0],this,n))return Me(o[1],this,n)}}))},zn.conforms=function(t){return function(t){var e=Bs(t);return function(n){return lr(n,t,e)}}(ur(t,1))},zn.constant=ec,zn.countBy=pa,zn.create=function(t,e){var n=Gn(t);return null==e?n:ir(n,e)},zn.curry=function t(e,n,r){var i=Xo(e,8,o,o,o,o,o,n=r?o:n);return i.placeholder=t.placeholder,i},zn.curryRight=function t(e,n,r){var i=Xo(e,c,o,o,o,o,o,n=r?o:n);return i.placeholder=t.placeholder,i},zn.debounce=Ba,zn.defaults=Es,zn.defaultsDeep=Cs,zn.defer=La,zn.delay=Na,zn.difference=zi,zn.differenceBy=Gi,zn.differenceWith=Hi,zn.drop=function(t,e,n){var r=null==t?0:t.length;return r?oo(t,(e=n||e===o?1:ms(e))<0?0:e,r):[]},zn.dropRight=function(t,e,n){var r=null==t?0:t.length;return r?oo(t,0,(e=r-(e=n||e===o?1:ms(e)))<0?0:e):[]},zn.dropRightWhile=function(t,e){return t&&t.length?mo(t,li(e,3),!0,!0):[]},zn.dropWhile=function(t,e){return t&&t.length?mo(t,li(e,3),!0):[]},zn.fill=function(t,e,n,r){var i=null==t?0:t.length;return i?(n&&"number"!=typeof n&&bi(t,e,n)&&(n=0,r=i),function(t,e,n,r){var i=t.length;for((n=ms(n))<0&&(n=-n>i?0:i+n),(r=r===o||r>i?i:ms(r))<0&&(r+=i),r=n>r?0:ps(r);n<r;)t[n++]=e;return t}(t,e,n,r)):[]},zn.filter=function(t,e){return(Ka(t)?Be:yr)(t,li(e,3))},zn.flatMap=function(t,e){return vr(Sa(t,e),1)},zn.flatMapDeep=function(t,e){return vr(Sa(t,e),d)},zn.flatMapDepth=function(t,e,n){return n=n===o?1:ms(n),vr(Sa(t,e),n)},zn.flatten=Fi,zn.flattenDeep=function(t){return(null==t?0:t.length)?vr(t,d):[]},zn.flattenDepth=function(t,e){return(null==t?0:t.length)?vr(t,e=e===o?1:ms(e)):[]},zn.flip=function(t){return Xo(t,512)},zn.flow=nc,zn.flowRight=rc,zn.fromPairs=function(t){for(var e=-1,n=null==t?0:t.length,r={};++e<n;){var o=t[e];r[o[0]]=o[1]}return r},zn.functions=function(t){return null==t?[]:$r(t,Bs(t))},zn.functionsIn=function(t){return null==t?[]:$r(t,Ls(t))},zn.groupBy=ba,zn.initial=function(t){return(null==t?0:t.length)?oo(t,0,-1):[]},zn.intersection=Ji,zn.intersectionBy=qi,zn.intersectionWith=Vi,zn.invert=Is,zn.invertBy=As,zn.invokeMap=ka,zn.iteratee=ic,zn.keyBy=$a,zn.keys=Bs,zn.keysIn=Ls,zn.map=Sa,zn.mapKeys=function(t,e){var n={};return e=li(e,3),br(t,(function(t,r,o){ar(n,e(t,r,o),t)})),n},zn.mapValues=function(t,e){var n={};return e=li(e,3),br(t,(function(t,r,o){ar(n,r,e(t,r,o))})),n},zn.matches=function(t){return zr(ur(t,1))},zn.matchesProperty=function(t,e){return Gr(t,ur(e,1))},zn.memoize=Ta,zn.merge=Ns,zn.mergeWith=Ts,zn.method=ac,zn.methodOf=sc,zn.mixin=cc,zn.negate=Oa,zn.nthArg=function(t){return t=ms(t),Zr((function(e){return Wr(e,t)}))},zn.omit=Os,zn.omitBy=function(t,e){return Rs(t,Oa(li(e)))},zn.once=function(t){return Ia(2,t)},zn.orderBy=function(t,e,n,r){return null==t?[]:(Ka(e)||(e=null==e?[]:[e]),Ka(n=r?o:n)||(n=null==n?[]:[n]),Kr(t,e,n))},zn.over=lc,zn.overArgs=ja,zn.overEvery=hc,zn.overSome=fc,zn.partial=Ra,zn.partialRight=Pa,zn.partition=Ea,zn.pick=js,zn.pickBy=Rs,zn.property=dc,zn.propertyOf=function(t){return function(e){return null==t?o:Sr(t,e)}},zn.pull=Qi,zn.pullAll=Xi,zn.pullAllBy=function(t,e,n){return t&&t.length&&e&&e.length?Yr(t,e,li(n,2)):t},zn.pullAllWith=function(t,e,n){return t&&t.length&&e&&e.length?Yr(t,e,o,n):t},zn.pullAt=ta,zn.range=gc,zn.rangeRight=mc,zn.rearg=Ua,zn.reject=function(t,e){return(Ka(t)?Be:yr)(t,Oa(li(e,3)))},zn.remove=function(t,e){var n=[];if(!t||!t.length)return n;var r=-1,o=[],i=t.length;for(e=li(e,3);++r<i;){var a=t[r];e(a,r,t)&&(n.push(a),o.push(r))}return Jr(t,o),n},zn.rest=function(t,e){if("function"!=typeof t)throw new At(i);return Zr(t,e=e===o?e:ms(e))},zn.reverse=ea,zn.sampleSize=function(t,e,n){return e=(n?bi(t,e,n):e===o)?1:ms(e),(Ka(t)?Xn:Xr)(t,e)},zn.set=function(t,e,n){return null==t?t:to(t,e,n)},zn.setWith=function(t,e,n,r){return r="function"==typeof r?r:o,null==t?t:to(t,e,n,r)},zn.shuffle=function(t){return(Ka(t)?tr:ro)(t)},zn.slice=function(t,e,n){var r=null==t?0:t.length;return r?(n&&"number"!=typeof n&&bi(t,e,n)?(e=0,n=r):(e=null==e?0:ms(e),n=n===o?r:ms(n)),oo(t,e,n)):[]},zn.sortBy=Ca,zn.sortedUniq=function(t){return t&&t.length?co(t):[]},zn.sortedUniqBy=function(t,e){return t&&t.length?co(t,li(e,2)):[]},zn.split=function(t,e,n){return n&&"number"!=typeof n&&bi(t,e,n)&&(e=n=o),(n=n===o?p:n>>>0)?(t=ws(t))&&("string"==typeof e||null!=e&&!as(e))&&!(e=lo(e))&&cn(t)?$o(mn(t),0,n):t.split(e,n):[]},zn.spread=function(t,e){if("function"!=typeof t)throw new At(i);return e=null==e?0:wn(ms(e),0),Zr((function(n){var r=n[e],o=$o(n,0,e);return r&&Oe(o,r),Me(t,this,o)}))},zn.tail=function(t){var e=null==t?0:t.length;return e?oo(t,1,e):[]},zn.take=function(t,e,n){return t&&t.length?oo(t,0,(e=n||e===o?1:ms(e))<0?0:e):[]},zn.takeRight=function(t,e,n){var r=null==t?0:t.length;return r?oo(t,(e=r-(e=n||e===o?1:ms(e)))<0?0:e,r):[]},zn.takeRightWhile=function(t,e){return t&&t.length?mo(t,li(e,3),!1,!0):[]},zn.takeWhile=function(t,e){return t&&t.length?mo(t,li(e,3)):[]},zn.tap=function(t,e){return e(t),t},zn.throttle=function(t,e,n){var r=!0,o=!0;if("function"!=typeof t)throw new At(i);return es(n)&&(r="leading"in n?!!n.leading:r,o="trailing"in n?!!n.trailing:o),Ba(t,e,{leading:r,maxWait:e,trailing:o})},zn.thru=ga,zn.toArray=ds,zn.toPairs=Ps,zn.toPairsIn=Us,zn.toPath=function(t){return Ka(t)?Te(t,Ri):us(t)?[t]:xo(ji(ws(t)))},zn.toPlainObject=vs,zn.transform=function(t,e,n){var r=Ka(t),o=r||qa(t)||ls(t);if(e=li(e,4),null==n){var i=t&&t.constructor;n=o?r?new i:[]:es(t)&&Qa(i)?Gn(Yt(t)):{}}return(o?Ie:br)(t,(function(t,r,o){return e(n,t,r,o)})),n},zn.unary=function(t){return Da(t,1)},zn.union=na,zn.unionBy=ra,zn.unionWith=oa,zn.uniq=function(t){return t&&t.length?ho(t):[]},zn.uniqBy=function(t,e){return t&&t.length?ho(t,li(e,2)):[]},zn.uniqWith=function(t,e){return e="function"==typeof e?e:o,t&&t.length?ho(t,o,e):[]},zn.unset=function(t,e){return null==t||fo(t,e)},zn.unzip=ia,zn.unzipWith=aa,zn.update=function(t,e,n){return null==t?t:go(t,e,_o(n))},zn.updateWith=function(t,e,n,r){return r="function"==typeof r?r:o,null==t?t:go(t,e,_o(n),r)},zn.values=zs,zn.valuesIn=function(t){return null==t?[]:tn(t,Ls(t))},zn.without=sa,zn.words=Qs,zn.wrap=function(t,e){return Ra(_o(e),t)},zn.xor=ca,zn.xorBy=ua,zn.xorWith=la,zn.zip=ha,zn.zipObject=function(t,e){return vo(t||[],e||[],nr)},zn.zipObjectDeep=function(t,e){return vo(t||[],e||[],to)},zn.zipWith=fa,zn.entries=Ps,zn.entriesIn=Us,zn.extend=bs,zn.extendWith=ks,cc(zn,zn),zn.add=vc,zn.attempt=Xs,zn.camelCase=Gs,zn.capitalize=Hs,zn.ceil=wc,zn.clamp=function(t,e,n){return n===o&&(n=e,e=o),n!==o&&(n=(n=ys(n))==n?n:0),e!==o&&(e=(e=ys(e))==e?e:0),cr(ys(t),e,n)},zn.clone=function(t){return ur(t,4)},zn.cloneDeep=function(t){return ur(t,5)},zn.cloneDeepWith=function(t,e){return ur(t,5,e="function"==typeof e?e:o)},zn.cloneWith=function(t,e){return ur(t,4,e="function"==typeof e?e:o)},zn.conformsTo=function(t,e){return null==e||lr(t,e,Bs(e))},zn.deburr=Ws,zn.defaultTo=function(t,e){return null==t||t!=t?e:t},zn.divide=_c,zn.endsWith=function(t,e,n){t=ws(t),e=lo(e);var r=t.length,i=n=n===o?r:cr(ms(n),0,r);return(n-=e.length)>=0&&t.slice(n,i)==e},zn.eq=za,zn.escape=function(t){return(t=ws(t))&&Z.test(t)?t.replace(q,an):t},zn.escapeRegExp=function(t){return(t=ws(t))&&it.test(t)?t.replace(ot,"\\$&"):t},zn.every=function(t,e,n){var r=Ka(t)?xe:mr;return n&&bi(t,e,n)&&(e=o),r(t,li(e,3))},zn.find=ya,zn.findIndex=Wi,zn.findKey=function(t,e){return ze(t,li(e,3),br)},zn.findLast=va,zn.findLastIndex=Ki,zn.findLastKey=function(t,e){return ze(t,li(e,3),kr)},zn.floor=bc,zn.forEach=wa,zn.forEachRight=_a,zn.forIn=function(t,e){return null==t?t:wr(t,li(e,3),Ls)},zn.forInRight=function(t,e){return null==t?t:_r(t,li(e,3),Ls)},zn.forOwn=function(t,e){return t&&br(t,li(e,3))},zn.forOwnRight=function(t,e){return t&&kr(t,li(e,3))},zn.get=Ms,zn.gt=Ga,zn.gte=Ha,zn.has=function(t,e){return null!=t&&yi(t,e,Dr)},zn.hasIn=Ds,zn.head=Yi,zn.identity=oc,zn.includes=function(t,e,n,r){t=Ya(t)?t:zs(t),n=n&&!r?ms(n):0;var o=t.length;return n<0&&(n=wn(o+n,0)),cs(t)?n<=o&&t.indexOf(e,n)>-1:!!o&&He(t,e,n)>-1},zn.indexOf=function(t,e,n){var r=null==t?0:t.length;if(!r)return-1;var o=null==n?0:ms(n);return o<0&&(o=wn(r+o,0)),He(t,e,o)},zn.inRange=function(t,e,n){return e=gs(e),n===o?(n=e,e=0):n=gs(n),function(t,e,n){return t>=_n(e,n)&&t<wn(e,n)}(t=ys(t),e,n)},zn.invoke=xs,zn.isArguments=Wa,zn.isArray=Ka,zn.isArrayBuffer=Fa,zn.isArrayLike=Ya,zn.isArrayLikeObject=Ja,zn.isBoolean=function(t){return!0===t||!1===t||ns(t)&&Cr(t)==_},zn.isBuffer=qa,zn.isDate=Va,zn.isElement=function(t){return ns(t)&&1===t.nodeType&&!is(t)},zn.isEmpty=function(t){if(null==t)return!0;if(Ya(t)&&(Ka(t)||"string"==typeof t||"function"==typeof t.splice||qa(t)||ls(t)||Wa(t)))return!t.length;var e=pi(t);if(e==E||e==A)return!t.size;if(Ei(t))return!jr(t).length;for(var n in t)if(Ot.call(t,n))return!1;return!0},zn.isEqual=function(t,e){return Lr(t,e)},zn.isEqualWith=function(t,e,n){var r=(n="function"==typeof n?n:o)?n(t,e):o;return r===o?Lr(t,e,o,n):!!r},zn.isError=Za,zn.isFinite=function(t){return"number"==typeof t&&_e(t)},zn.isFunction=Qa,zn.isInteger=Xa,zn.isLength=ts,zn.isMap=rs,zn.isMatch=function(t,e){return t===e||Nr(t,e,fi(e))},zn.isMatchWith=function(t,e,n){return n="function"==typeof n?n:o,Nr(t,e,fi(e),n)},zn.isNaN=function(t){return os(t)&&t!=+t},zn.isNative=function(t){if(Si(t))throw new St("Unsupported core-js use. Try https://npms.io/search?q=ponyfill.");return Tr(t)},zn.isNil=function(t){return null==t},zn.isNull=function(t){return null===t},zn.isNumber=os,zn.isObject=es,zn.isObjectLike=ns,zn.isPlainObject=is,zn.isRegExp=as,zn.isSafeInteger=function(t){return Xa(t)&&t>=-9007199254740991&&t<=g},zn.isSet=ss,zn.isString=cs,zn.isSymbol=us,zn.isTypedArray=ls,zn.isUndefined=function(t){return t===o},zn.isWeakMap=function(t){return ns(t)&&pi(t)==L},zn.isWeakSet=function(t){return ns(t)&&"[object WeakSet]"==Cr(t)},zn.join=function(t,e){return null==t?"":Ue.call(t,e)},zn.kebabCase=Ks,zn.last=Zi,zn.lastIndexOf=function(t,e,n){var r=null==t?0:t.length;if(!r)return-1;var i=r;return n!==o&&(i=(i=ms(n))<0?wn(r+i,0):_n(i,r-1)),e==e?function(t,e,n){for(var r=n+1;r--;)if(t[r]===e)return r;return r}(t,e,i):Ge(t,Ke,i,!0)},zn.lowerCase=Fs,zn.lowerFirst=Ys,zn.lt=hs,zn.lte=fs,zn.max=function(t){return t&&t.length?pr(t,oc,Mr):o},zn.maxBy=function(t,e){return t&&t.length?pr(t,li(e,2),Mr):o},zn.mean=function(t){return Fe(t,oc)},zn.meanBy=function(t,e){return Fe(t,li(e,2))},zn.min=function(t){return t&&t.length?pr(t,oc,Pr):o},zn.minBy=function(t,e){return t&&t.length?pr(t,li(e,2),Pr):o},zn.stubArray=pc,zn.stubFalse=yc,zn.stubObject=function(){return{}},zn.stubString=function(){return""},zn.stubTrue=function(){return!0},zn.multiply=$c,zn.nth=function(t,e){return t&&t.length?Wr(t,ms(e)):o},zn.noConflict=function(){return me._===this&&(me._=zt),this},zn.noop=uc,zn.now=Ma,zn.pad=function(t,e,n){t=ws(t);var r=(e=ms(e))?gn(t):0;if(!e||r>=e)return t;var o=(e-r)/2;return Fo(pe(o),n)+t+Fo(ge(o),n)},zn.padEnd=function(t,e,n){t=ws(t);var r=(e=ms(e))?gn(t):0;return e&&r<e?t+Fo(e-r,n):t},zn.padStart=function(t,e,n){t=ws(t);var r=(e=ms(e))?gn(t):0;return e&&r<e?Fo(e-r,n)+t:t},zn.parseInt=function(t,e,n){return n||null==e?e=0:e&&(e=+e),kn(ws(t).replace(at,""),e||0)},zn.random=function(t,e,n){if(n&&"boolean"!=typeof n&&bi(t,e,n)&&(e=n=o),n===o&&("boolean"==typeof e?(n=e,e=o):"boolean"==typeof t&&(n=t,t=o)),t===o&&e===o?(t=0,e=1):(t=gs(t),e===o?(e=t,t=0):e=gs(e)),t>e){var r=t;t=e,e=r}if(n||t%1||e%1){var i=$n();return _n(t+i*(e-t+he("1e-"+((i+"").length-1))),e)}return qr(t,e)},zn.reduce=function(t,e,n){var r=Ka(t)?je:qe,o=arguments.length<3;return r(t,li(e,4),n,o,dr)},zn.reduceRight=function(t,e,n){var r=Ka(t)?Re:qe,o=arguments.length<3;return r(t,li(e,4),n,o,gr)},zn.repeat=function(t,e,n){return e=(n?bi(t,e,n):e===o)?1:ms(e),Vr(ws(t),e)},zn.replace=function(){var t=arguments,e=ws(t[0]);return t.length<3?e:e.replace(t[1],t[2])},zn.result=function(t,e,n){var r=-1,i=(e=bo(e,t)).length;for(i||(i=1,t=o);++r<i;){var a=null==t?o:t[Ri(e[r])];a===o&&(r=i,a=n),t=Qa(a)?a.call(t):a}return t},zn.round=Sc,zn.runInContext=t,zn.sample=function(t){return(Ka(t)?Qn:Qr)(t)},zn.size=function(t){if(null==t)return 0;if(Ya(t))return cs(t)?gn(t):t.length;var e=pi(t);return e==E||e==A?t.size:jr(t).length},zn.snakeCase=Js,zn.some=function(t,e,n){var r=Ka(t)?Pe:io;return n&&bi(t,e,n)&&(e=o),r(t,li(e,3))},zn.sortedIndex=function(t,e){return ao(t,e)},zn.sortedIndexBy=function(t,e,n){return so(t,e,li(n,2))},zn.sortedIndexOf=function(t,e){var n=null==t?0:t.length;if(n){var r=ao(t,e);if(r<n&&za(t[r],e))return r}return-1},zn.sortedLastIndex=function(t,e){return ao(t,e,!0)},zn.sortedLastIndexBy=function(t,e,n){return so(t,e,li(n,2),!0)},zn.sortedLastIndexOf=function(t,e){if(null==t?0:t.length){var n=ao(t,e,!0)-1;if(za(t[n],e))return n}return-1},zn.startCase=qs,zn.startsWith=function(t,e,n){return t=ws(t),n=null==n?0:cr(ms(n),0,t.length),e=lo(e),t.slice(n,n+e.length)==e},zn.subtract=Ec,zn.sum=function(t){return t&&t.length?Ve(t,oc):0},zn.sumBy=function(t,e){return t&&t.length?Ve(t,li(e,2)):0},zn.template=function(t,e,n){var r=zn.templateSettings;n&&bi(t,e,n)&&(e=o),t=ws(t),e=ks({},e,r,ti);var i,a,s=ks({},e.imports,r.imports,ti),c=Bs(s),u=tn(s,c),l=0,h=e.interpolate||kt,f="__p += '",d=Dt((e.escape||kt).source+"|"+h.source+"|"+(h===tt?gt:kt).source+"|"+(e.evaluate||kt).source+"|$","g"),g="//# sourceURL="+(Ot.call(e,"sourceURL")?(e.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++se+"]")+"\n";t.replace(d,(function(e,n,r,o,s,c){return r||(r=o),f+=t.slice(l,c).replace($t,sn),n&&(i=!0,f+="' +\n__e("+n+") +\n'"),s&&(a=!0,f+="';\n"+s+";\n__p += '"),r&&(f+="' +\n((__t = ("+r+")) == null ? '' : __t) +\n'"),l=c+e.length,e})),f+="';\n";var m=Ot.call(e,"variable")&&e.variable;if(m){if(ft.test(m))throw new St("Invalid `variable` option passed into `_.template`")}else f="with (obj) {\n"+f+"\n}\n";f=(a?f.replace(K,""):f).replace(F,"$1").replace(Y,"$1;"),f="function("+(m||"obj")+") {\n"+(m?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(i?", __e = _.escape":"")+(a?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+f+"return __p\n}";var p=Xs((function(){return Et(c,g+"return "+f).apply(o,u)}));if(p.source=f,Za(p))throw p;return p},zn.times=function(t,e){if((t=ms(t))<1||t>g)return[];var n=p,r=_n(t,p);e=li(e),t-=p;for(var o=Ze(r,e);++n<t;)e(n);return o},zn.toFinite=gs,zn.toInteger=ms,zn.toLength=ps,zn.toLower=function(t){return ws(t).toLowerCase()},zn.toNumber=ys,zn.toSafeInteger=function(t){return t?cr(ms(t),-9007199254740991,g):0===t?t:0},zn.toString=ws,zn.toUpper=function(t){return ws(t).toUpperCase()},zn.trim=function(t,e,n){if((t=ws(t))&&(n||e===o))return Qe(t);if(!t||!(e=lo(e)))return t;var r=mn(t),i=mn(e);return $o(r,nn(r,i),rn(r,i)+1).join("")},zn.trimEnd=function(t,e,n){if((t=ws(t))&&(n||e===o))return t.slice(0,pn(t)+1);if(!t||!(e=lo(e)))return t;var r=mn(t);return $o(r,0,rn(r,mn(e))+1).join("")},zn.trimStart=function(t,e,n){if((t=ws(t))&&(n||e===o))return t.replace(at,"");if(!t||!(e=lo(e)))return t;var r=mn(t);return $o(r,nn(r,mn(e))).join("")},zn.truncate=function(t,e){var n=30,r="...";if(es(e)){var i="separator"in e?e.separator:i;n="length"in e?ms(e.length):n,r="omission"in e?lo(e.omission):r}var a=(t=ws(t)).length;if(cn(t)){var s=mn(t);a=s.length}if(n>=a)return t;var c=n-gn(r);if(c<1)return r;var u=s?$o(s,0,c).join(""):t.slice(0,c);if(i===o)return u+r;if(s&&(c+=u.length-c),as(i)){if(t.slice(c).search(i)){var l,h=u;for(i.global||(i=Dt(i.source,ws(mt.exec(i))+"g")),i.lastIndex=0;l=i.exec(h);)var f=l.index;u=u.slice(0,f===o?c:f)}}else if(t.indexOf(lo(i),c)!=c){var d=u.lastIndexOf(i);d>-1&&(u=u.slice(0,d))}return u+r},zn.unescape=function(t){return(t=ws(t))&&V.test(t)?t.replace(J,yn):t},zn.uniqueId=function(t){var e=++jt;return ws(t)+e},zn.upperCase=Vs,zn.upperFirst=Zs,zn.each=wa,zn.eachRight=_a,zn.first=Yi,cc(zn,(kc={},br(zn,(function(t,e){Ot.call(zn.prototype,e)||(kc[e]=t)})),kc),{chain:!1}),zn.VERSION="4.17.21",Ie(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(t){zn[t].placeholder=zn})),Ie(["drop","take"],(function(t,e){Kn.prototype[t]=function(n){n=n===o?1:wn(ms(n),0);var r=this.__filtered__&&!e?new Kn(this):this.clone();return r.__filtered__?r.__takeCount__=_n(n,r.__takeCount__):r.__views__.push({size:_n(n,p),type:t+(r.__dir__<0?"Right":"")}),r},Kn.prototype[t+"Right"]=function(e){return this.reverse()[t](e).reverse()}})),Ie(["filter","map","takeWhile"],(function(t,e){var n=e+1,r=1==n||3==n;Kn.prototype[t]=function(t){var e=this.clone();return e.__iteratees__.push({iteratee:li(t,3),type:n}),e.__filtered__=e.__filtered__||r,e}})),Ie(["head","last"],(function(t,e){var n="take"+(e?"Right":"");Kn.prototype[t]=function(){return this[n](1).value()[0]}})),Ie(["initial","tail"],(function(t,e){var n="drop"+(e?"":"Right");Kn.prototype[t]=function(){return this.__filtered__?new Kn(this):this[n](1)}})),Kn.prototype.compact=function(){return this.filter(oc)},Kn.prototype.find=function(t){return this.filter(t).head()},Kn.prototype.findLast=function(t){return this.reverse().find(t)},Kn.prototype.invokeMap=Zr((function(t,e){return"function"==typeof t?new Kn(this):this.map((function(n){return xr(n,t,e)}))})),Kn.prototype.reject=function(t){return this.filter(Oa(li(t)))},Kn.prototype.slice=function(t,e){t=ms(t);var n=this;return n.__filtered__&&(t>0||e<0)?new Kn(n):(t<0?n=n.takeRight(-t):t&&(n=n.drop(t)),e!==o&&(n=(e=ms(e))<0?n.dropRight(-e):n.take(e-t)),n)},Kn.prototype.takeRightWhile=function(t){return this.reverse().takeWhile(t).reverse()},Kn.prototype.toArray=function(){return this.take(p)},br(Kn.prototype,(function(t,e){var n=/^(?:filter|find|map|reject)|While$/.test(e),r=/^(?:head|last)$/.test(e),i=zn[r?"take"+("last"==e?"Right":""):e],a=r||/^find/.test(e);i&&(zn.prototype[e]=function(){var e=this.__wrapped__,s=r?[1]:arguments,c=e instanceof Kn,u=s[0],l=c||Ka(e),h=function(t){var e=i.apply(zn,Oe([t],s));return r&&f?e[0]:e};l&&n&&"function"==typeof u&&1!=u.length&&(c=l=!1);var f=this.__chain__,d=!!this.__actions__.length,g=a&&!f,m=c&&!d;if(!a&&l){e=m?e:new Kn(this);var p=t.apply(e,s);return p.__actions__.push({func:ga,args:[h],thisArg:o}),new Wn(p,f)}return g&&m?t.apply(this,s):(p=this.thru(h),g?r?p.value()[0]:p.value():p)})})),Ie(["pop","push","shift","sort","splice","unshift"],(function(t){var e=xt[t],n=/^(?:push|sort|unshift)$/.test(t)?"tap":"thru",r=/^(?:pop|shift)$/.test(t);zn.prototype[t]=function(){var t=arguments;if(r&&!this.__chain__){var o=this.value();return e.apply(Ka(o)?o:[],t)}return this[n]((function(n){return e.apply(Ka(n)?n:[],t)}))}})),br(Kn.prototype,(function(t,e){var n=zn[e];if(n){var r=n.name+"";Ot.call(Bn,r)||(Bn[r]=[]),Bn[r].push({name:e,func:n})}})),Bn[Go(o,2).name]=[{name:"wrapper",func:o}],Kn.prototype.clone=function(){var t=new Kn(this.__wrapped__);return t.__actions__=xo(this.__actions__),t.__dir__=this.__dir__,t.__filtered__=this.__filtered__,t.__iteratees__=xo(this.__iteratees__),t.__takeCount__=this.__takeCount__,t.__views__=xo(this.__views__),t},Kn.prototype.reverse=function(){if(this.__filtered__){var t=new Kn(this);t.__dir__=-1,t.__filtered__=!0}else(t=this.clone()).__dir__*=-1;return t},Kn.prototype.value=function(){var t=this.__wrapped__.value(),e=this.__dir__,n=Ka(t),r=e<0,o=n?t.length:0,i=function(t,e,n){var r=-1,o=n.length;for(;++r<o;){var i=n[r],a=i.size;switch(i.type){case"drop":t+=a;break;case"dropRight":e-=a;break;case"take":e=_n(e,t+a);break;case"takeRight":t=wn(t,e-a)}}return{start:t,end:e}}(0,o,this.__views__),a=i.start,s=i.end,c=s-a,u=r?s:a-1,l=this.__iteratees__,h=l.length,f=0,d=_n(c,this.__takeCount__);if(!n||!r&&o==c&&d==c)return po(t,this.__actions__);var g=[];t:for(;c--&&f<d;){for(var m=-1,p=t[u+=e];++m<h;){var y=l[m],v=y.iteratee,w=y.type,_=v(p);if(2==w)p=_;else if(!_){if(1==w)continue t;break t}}g[f++]=p}return g},zn.prototype.at=ma,zn.prototype.chain=function(){return da(this)},zn.prototype.commit=function(){return new Wn(this.value(),this.__chain__)},zn.prototype.next=function(){this.__values__===o&&(this.__values__=ds(this.value()));var t=this.__index__>=this.__values__.length;return{done:t,value:t?o:this.__values__[this.__index__++]}},zn.prototype.plant=function(t){for(var e,n=this;n instanceof Hn;){var r=Ui(n);r.__index__=0,r.__values__=o,e?i.__wrapped__=r:e=r;var i=r;n=n.__wrapped__}return i.__wrapped__=t,e},zn.prototype.reverse=function(){var t=this.__wrapped__;if(t instanceof Kn){var e=t;return this.__actions__.length&&(e=new Kn(this)),(e=e.reverse()).__actions__.push({func:ga,args:[ea],thisArg:o}),new Wn(e,this.__chain__)}return this.thru(ea)},zn.prototype.toJSON=zn.prototype.valueOf=zn.prototype.value=function(){return po(this.__wrapped__,this.__actions__)},zn.prototype.first=zn.prototype.head,Qt&&(zn.prototype[Qt]=function(){return this}),zn}();me._=vn,(r=function(){return vn}.call(e,n,e,t))===o||(t.exports=r)}.call(this)}},e={};function n(r){var o=e[r];if(void 0!==o)return o.exports;var i=e[r]={id:r,loaded:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.nmd=t=>(t.paths=[],t.children||(t.children=[]),t);class r{backgroundMap={};constructor(){this.initBackgroundMap(),console.log("背景管理器初始化完成")}initBackgroundMap(){this.backgroundMap={公园_白天:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E7%99%BD%E5%A4%A9.jpg?ref_type=heads",公园_黄昏:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E9%BB%84%E6%98%8F.jpg?ref_type=heads",书店_内部:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E4%B9%A6%E5%BA%97%E5%86%85/%E4%B9%A6%E5%BA%97.jpg?ref_type=heads",修道院_图书室:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E4%B9%A6%E5%BA%97%E5%86%85/%E4%B9%A6%E5%BA%97.jpg?ref_type=heads",修道院_办公室:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E9%BB%84%E6%98%8F.jpg?ref_type=heads",修道院_花园:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E7%99%BD%E5%A4%A9.jpg?ref_type=heads"}}setBackground(t,e){const n=`${t}_${e}`;let r=this.backgroundMap[n];r||(r=this.backgroundMap[`${t}_默认`]),r||_.isEmpty(this.backgroundMap)||(r=_.values(this.backgroundMap)[0]),r?($(".background-container").css("backgroundImage",`url('${r}')`),console.log(`已设置背景: ${n}`)):(console.warn(`未找到背景: ${n}`),$(".background-container").css({backgroundImage:"none",backgroundColor:"#2a2a2a"}))}addBackground(t,e){this.backgroundMap[t]=e}applyBackgroundEffect(t){if($(".background-container").removeClass("effect-fade effect-slide effect-zoom"),t){const e=$(".background-container");switch(t){case"fade":e.addClass("effect-fade"),e.hide().fadeIn(1e3);break;case"slide":e.addClass("effect-slide"),e.hide().slideDown(1e3);break;case"zoom":e.addClass("effect-zoom"),e.hide().show("scale",{},1e3)}setTimeout((()=>{e.removeClass(`effect-${t}`)}),1e3)}}getAllBackgroundKeys(){return _.keys(this.backgroundMap)}}class o{characterResourceService;currentCharacters={};constructor(t){this.characterResourceService=t,console.log("角色管理器初始化完成")}setCharacter(t,e="default",n){const r=$(`.character-${n}`);if(0===r.length)return void console.error(`未找到${n}侧角色容器元素`);const o=this.characterResourceService.getCharacter(t);if(!o)return console.error(`未找到ID为${t}的角色资源`),void this.hideCharacter(n);const i=this.characterResourceService.getCharacterEmotionUrl(t,e);if(i)this.setCharacterImage(r,o,i,n,e);else{console.error(`角色${t}没有${e}表情差分`);const i=this.characterResourceService.getCharacterEmotionUrl(t);if(!i)return void this.hideCharacter(n);this.setCharacterImage(r,o,i,n,"default")}}setCharacterImage(t,e,n,r,o){t.css({backgroundImage:`url('${n}')`,opacity:1}).data({characterId:e.id,characterName:e.name}),this.currentCharacters[r]={id:e.id,emotion:o},console.log(`已设置${e.name}的${o}表情立绘在${r}侧`)}updateEmotion(t,e="default"){let n=null;this.currentCharacters.left?.id===t?n="left":this.currentCharacters.right?.id===t&&(n="right"),n?this.setCharacter(t,e,n):console.warn(`未找到ID为${t}的角色在场景中`)}hideCharacter(t){"left"!==t&&"all"!==t||($(".character-left").css({backgroundImage:"none",opacity:0}),delete this.currentCharacters.left),"right"!==t&&"all"!==t||($(".character-right").css({backgroundImage:"none",opacity:0}),delete this.currentCharacters.right)}setCharacterEffect(t,e){const n=$(`.character-${t}`);if(0!==n.length){if(n.removeClass("effect-shake effect-focus effect-blur"),e)switch(n.addClass(`effect-${e}`),e){case"shake":n.effect("shake",{times:3,distance:5},500);break;case"focus":$(".characters-container .character").not(n).animate({opacity:.5},500),n.animate({opacity:1},500);break;case"blur":n.fadeOut(250).fadeIn(250)}}else console.error(`未找到${t}侧角色容器元素`)}swapCharacters(){const t=$(".character-left"),e=$(".character-right");if(0===t.length||0===e.length)return;const n=this.currentCharacters.left,r=this.currentCharacters.right;n&&r&&(this.setCharacter(r.id,r.emotion,"left"),this.setCharacter(n.id,n.emotion,"right"),t.add(e).css("transition","all 0.5s ease-in-out"))}updateCharactersByDialogue(t,e="default"){if("narrator"===t)return;const n=this.characterResourceService.getCharacter(t);if(!n)return void console.log(`未找到ID为${t}的角色资源，跳过立绘更新`);let r="right";if(this.currentCharacters.left?.id===t)r="left";else{if(this.currentCharacters.right?.id!==t)return"left"!==n.position&&"right"!==n.position||(r=n.position),void this.setCharacter(t,e,r);r="right"}this.updateEmotion(t,e)}}class i{choices=[];choicesShown=!1;choicesHidden=!1;onChoiceSelectedCallback=null;constructor(){$("#custom-choice-button").on("click",(()=>{const t=$("#custom-choice-input").val();t&&t.trim()&&(this.selectChoice(t.trim()),$("#custom-choice-input").val(""))})),$("#custom-choice-input").on("keypress",(t=>{if("Enter"===t.key){const t=$("#custom-choice-input").val();t&&t.trim()&&(this.selectChoice(t.trim()),$("#custom-choice-input").val(""))}})),$(document).on("click","#hide-choices-btn",(t=>{t.stopPropagation(),this.hideChoices()})),console.log("选项管理器初始化完成")}setChoices(t){this.choices=t,this.choicesShown=!1,this.choicesHidden=!1}renderChoices(){const t=$(".preset-choices");if(0===t.length)return;t.empty(),_.forEach(this.choices,((e,n)=>{$("<button>",{class:"choice-button",text:e,"data-index":n,"data-choice":e,click:()=>this.selectChoice(e)}).appendTo(t)}));const e=$(".choices-container");this.choices.length<=2?e.addClass("compact-choices"):e.removeClass("compact-choices")}showChoices(){const t=$(".choices-container"),e=$(".preset-choices");0!==t.length&&0!==e.length&&(this.renderChoices(),t.removeClass("hidden").hide().fadeIn(300),this.choicesShown=!0,this.choicesHidden=!1,setTimeout((()=>{$("#custom-choice-input").focus()}),300))}hideChoices(){const t=this;$(".choices-container").fadeOut(300,(function(){$(this).addClass("hidden").show(),t.choicesHidden=!0}))}canReshowChoices(){return this.choicesShown&&this.choicesHidden&&this.choices.length>0}reshowChoices(){this.canReshowChoices()&&this.showChoices()}selectChoice(t){this.onChoiceSelectedCallback&&this.onChoiceSelectedCallback(t),this.hideChoices()}setOnChoiceSelected(t){this.onChoiceSelectedCallback=t}addChoice(t){_.includes(this.choices,t)||(this.choices.push(t),$(".choices-container").hasClass("hidden")||this.renderChoices())}removeChoice(t){_.pull(this.choices,t),$(".choices-container").hasClass("hidden")||this.renderChoices()}clearChoices(){this.choices=[],$(".choices-container").hasClass("hidden")||this.renderChoices()}getAllChoices(){return _.clone(this.choices)}areChoicesVisible(){return this.choicesShown&&!this.choicesHidden}}class a{dialogues=[];currentDialogueIndex=0;characterResourceService;characterManager;backgroundManager;isAutoPlaying=!1;autoPlayInterval=null;autoPlaySpeed=3e3;constructor(t,e,n){this.characterResourceService=t,this.characterManager=e,this.backgroundManager=n,$("#auto-play").on("click",(()=>{this.toggleAutoPlay()})),console.log("对话管理器初始化完成")}setDialogues(t){this.dialogues=t,this.currentDialogueIndex=0}showDialogue(t){if(t<0||t>=this.dialogues.length)return void console.error("无效的对话索引");this.currentDialogueIndex=t;const e=this.dialogues[t],n=e.speaker;$(".speaker-name").text(n);const r=$("<div>",{class:`dialogue-text style-${e.style||"normal"}`,text:e.content});$(".dialogue-content").empty().append(r),$(".dialogue-content").scrollTop($(".dialogue-content")[0].scrollHeight),this.updateCharacterDisplay(e),this.updateBackground(e)}updateCharacterDisplay(t){if(!t.portrait){return void(this.characterResourceService.getCharacter(t.speaker)?this.characterManager.updateCharactersByDialogue(t.speaker,"default"):this.characterManager.hideCharacter("all"))}const{character:e,emotion:n}=t.portrait;let r="right";const o=this.characterResourceService.getCharacter(e);o&&o.position&&(r=o.position),this.characterManager.setCharacter(e,n,r)}updateBackground(t){if(t.background){const{location:e,scene:n}=t.background;this.backgroundManager.setBackground(e,n)}}showNextDialogue(){return this.currentDialogueIndex<this.dialogues.length-1&&(this.showDialogue(this.currentDialogueIndex+1),!0)}showPreviousDialogue(){return this.currentDialogueIndex>0&&(this.showDialogue(this.currentDialogueIndex-1),!0)}renderDialogue(t=this.currentDialogueIndex){this.showDialogue(t)}addDialogue(t){this.dialogues.push(t),1===this.dialogues.length&&this.renderDialogue(0)}clearDialogues(){this.dialogues=[],this.currentDialogueIndex=0,$(".dialogue-content").empty(),$(".speaker-name").text(""),this.characterManager.hideCharacter("all")}toggleAutoPlay(){this.isAutoPlaying=!this.isAutoPlaying;const t=$("#auto-play");this.isAutoPlaying?(this.autoPlayInterval=window.setInterval((()=>{this.showNextDialogue()||this.stopAutoPlay()}),this.autoPlaySpeed),t.addClass("active").html('<i class="fas fa-pause"></i>')):(this.stopAutoPlay(),t.removeClass("active").html('<i class="fas fa-play"></i>'))}stopAutoPlay(){null!==this.autoPlayInterval&&(clearInterval(this.autoPlayInterval),this.autoPlayInterval=null),this.isAutoPlaying=!1,$("#auto-play").removeClass("active").html('<i class="fas fa-play"></i>')}setAutoPlaySpeed(t){this.autoPlaySpeed=t,this.isAutoPlaying&&(this.stopAutoPlay(),this.toggleAutoPlay())}getCurrentDialogue(){return this.currentDialogueIndex>=0&&this.currentDialogueIndex<this.dialogues.length?this.dialogues[this.currentDialogueIndex]:null}getAllDialogues(){return _.cloneDeep(this.dialogues)}showDialogueHistory(t){const e=this.currentDialogueIndex,n=$(".dialogue-content");n.empty();const r=t||this.dialogues;_.forEach(r,((t,e)=>{const r=$("<div>",{class:"dialogue-history-item","data-index":e}),o=$("<div>",{class:"speaker-name-history",text:t.speaker}),i=$("<div>",{class:`dialogue-text-history style-${t.style||"normal"}`,text:t.content});r.append(o).append(i),n.append(r)})),$("#dialogue-history-notice").show();const o=$("<button>",{id:"return-from-history",class:"btn btn-primary",text:"返回对话",click:()=>{$("#dialogue-history-notice").hide(),n.removeClass("history-mode"),this.renderDialogue(e)}});n.append(o),n.addClass("history-mode")}getCurrentDialogueIndex(){return this.currentDialogueIndex}isDialogueFinished(){return this.currentDialogueIndex>=this.dialogues.length-1}}class s{gameData=null;constructor(){console.log("日记管理器初始化完成")}setGameData(t){this.gameData=t}switchJournalSection(t){$(".journal-nav-item").removeClass("active"),$(".journal-section").removeClass("active"),$(`[data-section="${t}"]`).addClass("active"),$(`#${t}-section`).addClass("active"),this.showPlaceholder(t)}refreshJournalContent(){this.showPlaceholder("characters")}showPlaceholder(t){const e=$(`#${t}-section`);if(!e.length)return;e.empty();let n="日记";switch(t){case"characters":n="角色信息";break;case"monastery":n="修道院";break;case"knowledge":n="知识库"}$("<div>",{class:"journal-placeholder",css:{padding:"20px",textAlign:"center"}}).append($("<h3>",{text:n,css:{marginBottom:"15px"}})).append($("<p>",{text:"内容暂未实现",css:{color:"#888",fontStyle:"italic"}})).appendTo(e),console.log(`日记${n}部分已清空，仅保留占位符`)}selectCharacter(t){console.log(`尝试选择角色: ${t}，但该功能已简化为占位符`)}}class c{memories=[];selectedMemoryId=null;hasCreatedMemory=!1;alreadySavedKey="memory_already_saved";isTabSwitching=!1;onMemorySelectedCallback=null;onMemorySavedCallback=null;onMemoryTravelCallback=null;constructor(){$("#travel-to-memory").on("click",(()=>{this.travelToSelectedMemory()})),this.checkIfAlreadySaved(),$('a[data-bs-toggle="tab"]').on("hide.bs.tab",(t=>{"#memory-tab"===$(t.target).attr("href")&&(this.isTabSwitching=!0)})),$('a[data-bs-toggle="tab"]').on("shown.bs.tab",(t=>{"#memory-tab"===$(t.target).attr("href")&&setTimeout((()=>{$("#memory-timeline").empty(),this.renderMemories(),this.isTabSwitching=!1}),50)})),console.log("记忆管理器初始化完成")}checkIfAlreadySaved(){"true"===sessionStorage.getItem(this.alreadySavedKey)&&(this.hasCreatedMemory=!0,this.updateSaveButtonState())}updateSaveButtonState(){this.hasCreatedMemory&&$(".memory-button").prop("disabled",!0).css("opacity","0.5").attr("title","此场景已保存，每个场景只能保存一次").text("已保存")}setMemories(t){const e={};t.forEach((t=>{e[t.id]=t})),this.memories=Object.values(e),console.log(`设置了${this.memories.length}个记忆点（去重后）`)}renderMemories(){const t=$("#memory-timeline");if(0===t.length)return;if(this.isTabSwitching)return;t.empty();const e={};this.memories.forEach((t=>{e[t.id]=t}));const n=_.sortBy(Object.values(e),"id");this.memories=n,0!==n.length?(_.forEach(n,((e,n)=>{$("<div>",{class:"memory-node-simple "+(this.selectedMemoryId===e.id?"selected":""),"data-id":e.id,title:this.formatTimestamp(e.timestamp||""),click:()=>this.selectMemory(e.id)}).appendTo(t)})),console.log(`已渲染${n.length}个记忆点`),this.updateSaveButtonState()):t.html('<div class="memory-empty-timeline">尚未创建记忆点。保存当前场景来创建一个新的记忆点。</div>')}formatTimestamp(t){try{const e=new Date(t);return isNaN(e.getTime())?t:`${e.getMonth()+1}/${e.getDate()} ${e.getHours()}:${e.getMinutes().toString().padStart(2,"0")}`}catch(e){return t}}selectMemory(t){const e=_.find(this.memories,{id:t});if(!e)return void console.error(`未找到ID为${t}的记忆`);this.selectedMemoryId=t;const n=$("#memory-content");n.length>0&&(n.empty(),e.image&&$("<div>",{class:"memory-content-image",css:{backgroundImage:`url('${e.image}')`}}).appendTo(n),$("<div>",{class:"memory-content-text",text:e.content}).appendTo(n),e.timestamp&&$("<div>",{class:"memory-timestamp",text:e.timestamp}).appendTo(n)),$(".memory-node-simple").removeClass("selected"),$(`.memory-node-simple[data-id="${t}"]`).addClass("selected"),$("#travel-to-memory").prop("disabled",!1),this.onMemorySelectedCallback&&this.onMemorySelectedCallback(t)}travelToSelectedMemory(){null!==this.selectedMemoryId?this.onMemoryTravelCallback&&this.onMemoryTravelCallback(this.selectedMemoryId):console.error("没有选中的记忆点")}addMemory(t,e){if(this.hasCreatedMemory)return console.warn("此场景已保存过，每个场景只能保存一次"),this.showOneTimeOnlyMessage(),null;const n=_.map(this.memories,"id"),r=this.memories.length>0?(_.max(n)||0)+1:1,o={id:r,content:t,timestamp:(new Date).toLocaleString(),image:e};return this.memories.push(o),this.hasCreatedMemory=!0,sessionStorage.setItem(this.alreadySavedKey,"true"),this.renderMemories(),this.selectMemory(r),this.onMemorySavedCallback&&this.onMemorySavedCallback(o),o}showOneTimeOnlyMessage(){const t=$("<div>",{class:"notification notification-warning",text:"此场景已保存过，每个场景只能保存一次"}).appendTo("#notification-container");setTimeout((()=>{t.addClass("notification-show")}),10),setTimeout((()=>{t.addClass("notification-hide").removeClass("notification-show"),setTimeout((()=>{t.remove()}),300)}),3e3)}deleteMemory(t){const e=_.findIndex(this.memories,{id:t});-1!==e?(this.memories.splice(e,1),this.renderMemories(),this.selectedMemoryId===t&&(this.selectedMemoryId=null,this.setEmptyMemoryContent(),$("#travel-to-memory").prop("disabled",!0))):console.error(`未找到ID为${t}的记忆`)}getSelectedMemory(){return null===this.selectedMemoryId?null:_.find(this.memories,{id:this.selectedMemoryId})||null}getAllMemories(){const t={};return this.memories.forEach((e=>{t[e.id]=e})),_.cloneDeep(Object.values(t))}setEmptyMemoryContent(t="选择一个记忆点或保存当前场景"){$("#memory-content").html(`<div class="memory-empty-message">${t}</div>`),$("#travel-to-memory").prop("disabled",!0)}setOnMemorySelected(t){this.onMemorySelectedCallback=t}setOnMemorySaved(t){this.onMemorySavedCallback=t}setOnMemoryTravel(t){this.onMemoryTravelCallback=t}clearMemories(){this.memories=[],this.selectedMemoryId=null,this.hasCreatedMemory=!1,sessionStorage.removeItem(this.alreadySavedKey),this.renderMemories(),this.setEmptyMemoryContent()}initializeDisplay(){const t={};this.memories.forEach((e=>{t[e.id]=e})),this.memories=Object.values(t),this.memories.length>0?this.renderMemories():this.setEmptyMemoryContent(),this.checkIfAlreadySaved()}}class u{gameData=null;memoryManager;saveManager;uiManager;gameStateGenerationService;constructor(t,e,n,r){this.memoryManager=t,this.saveManager=e,this.uiManager=n,this.gameStateGenerationService=r,console.log("记忆UI管理器初始化完成")}setGameData(t){this.gameData=t}refreshMemoryTimeline(){this.gameData&&(this.memoryManager.setMemories(this.gameData.storySummary),this.memoryManager.renderMemories())}saveMemory(){if(!this.gameData)return null;const t=this.memoryManager.addMemory(`${this.gameData.story.currentChapter} - 在${this.gameData.story.location}`);return this.uiManager.showNotification("记忆点已保存","success"),t}async travelToMemory(t){const e=this.memoryManager.getSelectedMemory();e?this.uiManager.showConfirmDialog(`确定要穿越到"${e.content}"吗？`,(async()=>{this.uiManager.showLoading("正在穿越时间...");try{let n=null;const r=await this.saveManager.loadGameStateByID(e.id);if(r)n=r,console.log("从世界书中加载了游戏状态");else{const t=await this.gameStateGenerationService.generateMemoryState(e);if(!t)throw new Error("无法生成记忆点游戏状态");n=t,console.log("生成了新的记忆点游戏状态")}this.gameData=n,t(),this.uiManager.showNotification("时间旅行成功","success")}catch(t){console.error("穿越时间失败:",t),this.uiManager.showNotification("穿越失败: "+(t instanceof Error?t.message:"未知错误"),"error")}finally{this.uiManager.hideLoading()}})):this.uiManager.showNotification("请先选择一个记忆点","warning")}getGameData(){return this.gameData}}class l{uiManager;worldBookName="修女的追忆记录";modalId="load-game-modal";DIALOGUE_HISTORY_KEY="persistent_dialogue_history";COMPLETE_HISTORY_KEY="complete_game_history";SAVE_TYPE={AUTO:"auto_save_",MANUAL:"save_"};currentMaxSaveId={auto:0,manual:0};cachedCompleteHistory=null;constructor(t){this.uiManager=t,this.initializeLoadGameModal(),this.initializeChatLorebook(),this.ensureBootstrapLoaded(),this.loadCompleteHistory()}ensureBootstrapLoaded(){if("undefined"!=typeof $){if("function"!=typeof $.fn.modal){if(console.warn("Bootstrap modal未检测到，尝试加载"),!document.getElementById("bootstrap-css")){const t=document.createElement("link");t.id="bootstrap-css",t.rel="stylesheet",t.href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css",document.head.appendChild(t)}if(!document.getElementById("bootstrap-js")){const t=document.createElement("script");t.id="bootstrap-js",t.src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js",t.onload=()=>{console.log("Bootstrap已成功加载"),this.initializeLoadGameModal()},document.body.appendChild(t)}}}else console.error("jQuery未加载，这可能导致modal功能失效")}async initializeChatLorebook(){try{if(console.log(`正在初始化固定世界书: ${this.worldBookName}`),"function"!=typeof window.getLorebooks||"function"!=typeof window.createLorebook)return void console.error("世界书API不可用，无法初始化聊天世界书");const t=await window.getLorebooks();t.includes(this.worldBookName)?(console.log(`找到现有的固定世界书: ${this.worldBookName}`),"function"==typeof window.setChatLorebook&&await window.setChatLorebook(this.worldBookName)):(console.log(`创建新的固定世界书: ${this.worldBookName}`),await window.createLorebook(this.worldBookName),"function"==typeof window.setChatLorebook&&await window.setChatLorebook(this.worldBookName)),await this.initializeMaxSaveIds()}catch(t){console.error("初始化聊天世界书失败:",t)}}async initializeMaxSaveIds(){try{const t=await this.getAllWorldBookEntries();if(!t||!t.length)return;const e=t.filter((t=>this.checkEntryKeyStartsWith(t,this.SAVE_TYPE.AUTO)));e.length>0&&(this.currentMaxSaveId.auto=Math.max(...e.map((t=>{const e=this.getEntryKey(t).match(/(\d+)$/);return e?parseInt(e[1],10):0}))));const n=t.filter((t=>this.checkEntryKeyStartsWith(t,this.SAVE_TYPE.MANUAL)));n.length>0&&(this.currentMaxSaveId.manual=Math.max(...n.map((t=>{const e=this.getEntryKey(t).match(/(\d+)$/);return e?parseInt(e[1],10):0})))),console.log(`初始化存档ID: 自动存档=${this.currentMaxSaveId.auto}, 手动存档=${this.currentMaxSaveId.manual}`)}catch(t){console.error("初始化最大存档ID失败:",t)}}getEntryKey(t){return Array.isArray(t.key)&&t.key.length>0?t.key[0]:"string"==typeof t.key?t.key:""}async getAllWorldBookEntries(){try{if(!this.worldBookName&&(console.warn("无法获取世界书条目：世界书名为空"),await this.initializeChatLorebook(),!this.worldBookName))return[];if("function"!=typeof window.getLorebookEntries)return console.error("世界书API不可用：getLorebookEntries函数未定义"),[];let t;console.log(`正在获取世界书 ${this.worldBookName} 的所有条目...`);try{t=await window.getLorebookEntries(this.worldBookName)}catch(e){if(console.error("调用getLorebookEntries API出错:",e),"function"==typeof window.triggerSlash)try{console.log("尝试使用triggerSlash作为后备方案获取条目");const e=await window.triggerSlash(`/getlbentries ${this.worldBookName}`);if(e)try{t=JSON.parse(e)}catch(t){console.error("解析triggerSlash返回结果失败:",t)}}catch(t){console.error("使用triggerSlash获取条目失败:",t)}}if(!t)return console.log(`没有从世界书 ${this.worldBookName} 获取到条目`),[];if(!Array.isArray(t))return console.error("获取的条目不是数组类型:",t),[];if(console.log(`成功获取世界书条目，共 ${t.length} 个`),t.length>0){const e=t.filter((t=>!t||!t.uid||"number"!=typeof t.uid));e.length>0&&console.warn(`发现 ${e.length} 个无效条目（缺少UID或UID类型错误）`)}else console.log("世界书条目为空，可能是新创建的世界书");return t}catch(t){return console.error("获取世界书条目失败:",t),[]}}checkEntryKeyStartsWith(t,e){return!(!t||!t.key)&&(Array.isArray(t.key)?t.key.some((t=>t&&"string"==typeof t&&t.startsWith(e))):"string"==typeof t.key&&t.key.startsWith(e))}findEntryByKey(t,e){if(!t||!Array.isArray(t))return console.warn("查找条目时传入的条目列表无效"),null;if(!e)return console.warn("查找条目时传入的键名为空"),null;const n=t.find((t=>!!t&&(Array.isArray(t.key)?t.key.includes(e):t.key===e)));return n?!n.uid||"number"!=typeof n.uid||isNaN(n.uid)?console.warn(`找到键名为 ${e} 的条目，但其UID无效: ${n.uid}`):console.log(`找到键名为 ${e} 的条目，UID: ${n.uid}`):console.log(`未找到键名为 ${e} 的条目`),n}initializeLoadGameModal(){if(0===$(`#${this.modalId}`).length){const t=`\n      <div id="${this.modalId}" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="loadGameModalTitle" aria-hidden="true">\n        <div class="modal-dialog modal-lg" role="document">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title" id="loadGameModalTitle"><i class="fas fa-book-open"></i> 修道院典籍记录</h5>\n              <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                <span aria-hidden="true">&times;</span>\n              </button>\n            </div>\n            <div class="modal-body">\n              <div class="save-tabs">\n                <button class="save-tab-btn active" data-tab="auto"><i class="fas fa-clock"></i> 时间记忆</button>\n                <button class="save-tab-btn" data-tab="manual"><i class="fas fa-bookmark"></i> 永久典籍</button>\n              </div>\n              <div class="save-tab-content">\n                <div id="auto-saves-container" class="save-tab-pane active">\n                  <ul id="auto-save-list" class="save-list">\n                    <li class="save-item empty">暂无自动记录点</li>\n                  </ul>\n                </div>\n                <div id="manual-saves-container" class="save-tab-pane">\n                  <ul id="manual-save-list" class="save-list">\n                    <li class="save-item empty">暂无手动保存的典籍</li>\n                  </ul>\n                </div>\n              </div>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-primary" id="btn-create-manual-save">\n                <i class="fas fa-feather-alt"></i> 记录当前典籍\n              </button>\n              <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>\n            </div>\n          </div>\n        </div>\n      </div>`;$("body").append(t);const e=`\n        <style>\n          #${this.modalId} {\n            background-color: rgba(0, 0, 0, 0.5);\n          }\n          #${this.modalId}.show {\n            display: block !important;\n          }\n          .save-tabs {\n            display: flex;\n            border-bottom: 1px solid #dee2e6;\n            margin-bottom: 15px;\n          }\n          .save-tab-btn {\n            background: none;\n            border: none;\n            padding: 10px 15px;\n            cursor: pointer;\n            outline: none;\n          }\n          .save-tab-btn.active {\n            border-bottom: 2px solid #5d6e41;\n          }\n          .save-tab-pane {\n            display: none;\n          }\n          .save-tab-pane.active {\n            display: block;\n          }\n          .save-list {\n            list-style: none;\n            padding: 0;\n          }\n          .save-item {\n            margin-bottom: 10px;\n            border: 1px solid #dee2e6;\n            border-radius: 4px;\n            padding: 10px;\n            display: flex;\n            flex-direction: column;\n            cursor: pointer;\n            transition: box-shadow 0.3s;\n          }\n          .save-item:hover {\n            box-shadow: 0 0 10px rgba(0,0,0,0.1);\n          }\n          .save-item.empty {\n            color: #6c757d;\n            cursor: default;\n            text-align: center;\n          }\n          .save-item-thumbnail {\n            height: 120px;\n            background-size: cover;\n            background-position: center;\n            border-radius: 4px;\n          }\n          .save-item-header {\n            display: flex;\n            justify-content: space-between;\n            margin: 10px 0 5px;\n          }\n          .save-item-title {\n            font-weight: bold;\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n          }\n          .save-item-date {\n            font-size: 0.8em;\n            color: #6c757d;\n          }\n          .save-item-content {\n            font-size: 0.9em;\n            color: #333;\n            margin-bottom: 10px;\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n          }\n          .save-item-actions {\n            display: flex;\n            justify-content: space-between;\n          }\n          .btn-load, .btn-delete {\n            border: none;\n            padding: 5px 10px;\n            border-radius: 4px;\n            cursor: pointer;\n          }\n          .btn-load {\n            background-color: #5d6e41;\n            color: white;\n          }\n          .btn-delete {\n            background-color: #dc3545;\n            color: white;\n          }\n        </style>\n      `;$("head").append(e),$(document).off("click",`#${this.modalId} .save-tab-btn`),$(document).off("click","#btn-create-manual-save"),$(document).on("click",`#${this.modalId} .save-tab-btn`,(t=>{const e=$(t.currentTarget).data("tab");$(`#${this.modalId} .save-tab-btn`).removeClass("active"),$(`#${this.modalId} .save-tab-pane`).removeClass("active"),$(t.currentTarget).addClass("active"),"auto"===e?$("#auto-saves-container").addClass("active"):$("#manual-saves-container").addClass("active")})),$(document).on("click","#btn-create-manual-save",(()=>{console.log("创建手动存档按钮被点击"),this.createManualSave()})),$(document).on("click",`#${this.modalId} .close, #${this.modalId} .btn-secondary`,(()=>{this.closeLoadGameModal()})),$(document).on("click",`#${this.modalId}`,(t=>{$(t.target).attr("id")===this.modalId&&this.closeLoadGameModal()})),console.log(`加载游戏弹窗已初始化，ID: ${this.modalId}`)}}closeLoadGameModal(){"function"==typeof $.fn.modal?$(`#${this.modalId}`).modal("hide"):$(`#${this.modalId}`).css("display","none").removeClass("show")}async createManualSave(){try{console.log("开始创建手动存档流程"),this.uiManager.showInputDialog("请输入典籍标题","手动存档",(async t=>{console.log("用户输入的存档名称:",t),t||(t="手动存档",console.log("使用默认存档名称:",t)),this.uiManager.showLoading("正在记录典籍...");try{console.log("获取当前游戏状态");const e=await this.getCurrentGameData();if(!e)return console.error("无法获取当前游戏状态"),void this.uiManager.showNotification("无法获取当前游戏状态","error");console.log("成功获取当前游戏状态，准备保存");await this.saveGameState(e,!0,t)?(console.log("手动存档成功保存"),this.uiManager.showNotification(`典籍"${t}"已成功记录`,"success"),console.log("刷新存档列表"),this.refreshSaveList()):(console.error("保存游戏状态失败"),this.uiManager.showNotification("记录典籍失败","error"))}catch(t){console.error("创建手动存档失败:",t),this.uiManager.showNotification("记录典籍失败","error")}finally{this.uiManager.hideLoading()}}))}catch(t){console.error("创建手动存档流程出错:",t),this.uiManager.showNotification("记录典籍失败","error")}}async getCurrentGameData(){return new Promise((t=>{const e=new CustomEvent("request_game_data",{detail:{callback:e=>t(e)}});window.dispatchEvent(e),setTimeout((()=>t(null)),5e3)}))}async showLoadGameModal(){try{if(this.uiManager.showLoading("正在获取存档列表..."),await this.refreshSaveList(),this.ensureBootstrapLoaded(),"function"!=typeof $.fn.modal){console.log("Bootstrap modal方法不可用，使用替代方法显示弹窗");$(`#${this.modalId}`).css({display:"block","padding-right":"17px"}).addClass("show"),$("body").addClass("modal-open").css("overflow","hidden")}else{console.log("使用Bootstrap modal方法显示弹窗");try{$(`#${this.modalId}`).modal("show")}catch(t){console.error("显示modal出错:",t),$(`#${this.modalId}`).css({display:"block","padding-right":"17px"}).addClass("show"),$("body").addClass("modal-open").css("overflow","hidden")}}this.uiManager.hideLoading()}catch(t){console.error("显示加载游戏弹窗失败:",t),this.uiManager.showNotification("获取存档列表失败","error"),this.uiManager.hideLoading()}}async refreshSaveList(){try{const{autoSaves:t,manualSaves:e}=await this.getAllSaves(),n=$("#auto-save-list");if(n.empty(),0===t.length)n.append('<li class="save-item empty">暂无自动存档</li>');else{const e=t.sort(((t,e)=>e.saveId-t.saveId));for(const t of e)this.appendSaveItem(n,t)}const r=$("#manual-save-list");if(r.empty(),0===e.length)r.append('<li class="save-item empty">暂无手动存档</li>');else{const t=e.sort(((t,e)=>e.saveId-t.saveId));for(const e of t)this.appendSaveItem(r,e)}}catch(t){throw console.error("刷新存档列表失败:",t),t}}appendSaveItem(t,e){let n="";n=e.thumbnail?e.thumbnail:e.isAuto?"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E4%B9%A6%E5%BA%97%E5%86%85/%E4%B9%A6%E5%BA%97.jpg?ref_type=heads":"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%85%AC%E5%9B%AD/%E7%99%BD%E5%A4%A9.jpg?ref_type=heads";const r=$("<li>",{class:"save-item","data-key":e.key});$("<div>",{class:"save-item-thumbnail",style:`background-image: url(${n})`}).appendTo(r);const o=$("<div>",{class:"save-item-header"});$("<div>",{class:"save-item-title",text:e.title}).appendTo(o),$("<div>",{class:"save-item-date",text:e.date}).appendTo(o),o.appendTo(r),$("<div>",{class:"save-item-content",text:e.content||"无可用内容"}).appendTo(r);const i=$("<div>",{class:"save-item-actions"}),a=$("<button>",{class:"btn-load",html:'<i class="fas fa-book-reader"></i> 阅读',"data-key":e.key}),s=$("<button>",{class:"btn-delete",html:'<i class="fas fa-trash-alt"></i> 销毁',"data-key":e.key,"data-title":e.title});i.append(a).append(s),i.appendTo(r),t.append(r),a.on("click",(t=>(t.preventDefault(),t.stopPropagation(),console.log("点击加载按钮，key:",e.key),this.loadGameFromKey(e.key),!1))),s.on("click",(t=>(t.preventDefault(),t.stopPropagation(),console.log("点击删除按钮，key:",e.key,"title:",e.title),this.deleteSave(e.key,e.title),!1))),r.on("click",(t=>{$(t.target).closest(".save-item-actions").length>0||(console.log("点击存档项，key:",e.key),this.loadGameFromKey(e.key))}))}async deleteSave(t,e){try{console.log("准备删除存档，key:",t,"title:",e),this.uiManager.showConfirmDialog(`确定要销毁典籍"${e}"吗？此操作不可逆。`,(async()=>{console.log("用户确认删除存档，开始删除过程"),this.uiManager.showLoading("正在销毁典籍...");try{const n=await window.getLorebookEntries(this.worldBookName),r=this.findEntryByKey(n,t);r&&r.uid?(console.log(`找到存档条目，准备删除 UID=${r.uid}`),await window.deleteLorebookEntry(this.worldBookName,r.uid),await this.refreshSaveList(),this.uiManager.showNotification(`典籍"${e}"已成功销毁`,"success")):(console.error("找不到要删除的存档条目"),this.uiManager.showNotification("找不到指定的典籍记录","error"))}catch(t){console.error("删除存档过程中出错:",t),this.uiManager.showNotification("销毁典籍失败: "+(t instanceof Error?t.message:"未知错误"),"error")}finally{this.uiManager.hideLoading()}}))}catch(t){console.error("删除存档过程出错:",t),this.uiManager.showNotification("销毁典籍失败","error")}}async getAllSaves(){try{if(this.worldBookName||await this.initializeChatLorebook(),!this.worldBookName||"function"!=typeof window.getLorebookEntries)return console.warn("世界书API不可用，无法获取存档"),{autoSaves:[],manualSaves:[]};const t=await this.getAllWorldBookEntries();if(!t||!Array.isArray(t)||0===t.length)return{autoSaves:[],manualSaves:[]};const e=t.filter((t=>this.checkEntryKeyStartsWith(t,this.SAVE_TYPE.AUTO))),n=t.filter((t=>this.checkEntryKeyStartsWith(t,this.SAVE_TYPE.MANUAL)));console.log(`找到 ${e.length} 个自动存档和 ${n.length} 个手动存档`);const r=await Promise.all(e.map((t=>this.processSaveEntry(t,!0)))),o=await Promise.all(n.map((t=>this.processSaveEntry(t,!1))));return{autoSaves:r.filter((t=>null!==t)).sort(((t,e)=>e.saveId-t.saveId)),manualSaves:o.filter((t=>null!==t)).sort(((t,e)=>e.saveId-t.saveId))}}catch(t){return console.error("获取存档列表失败:",t),{autoSaves:[],manualSaves:[]}}}async processSaveEntry(t,e){try{if(!t||!t.key)return console.warn("无效的存档条目:",t),null;let n="";if(Array.isArray(t.key)&&t.key.length>0){const r=e?this.SAVE_TYPE.AUTO:this.SAVE_TYPE.MANUAL,o=t.key.find((t=>t&&"string"==typeof t&&t.startsWith(r)));n=o||t.key[0]}else{if("string"!=typeof t.key)return console.warn("无效的键值类型:",t.key),null;n=t.key}const r=n.match(/(\d+)$/),o=r?parseInt(r[1],10):0,i={key:n,uid:t.uid,title:t.comment||(e?`自动记录点 #${o}`:`永久典籍 #${o}`),saveId:o,date:new Date(t.created_at||Date.now()).toLocaleString(),content:"",thumbnail:"",isAuto:e};try{let e="";if(t.content?e=t.content:"function"==typeof window.triggerSlash&&(e=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${n}`)),e)try{const t=JSON.parse(e);if(t.storySummary&&t.storySummary.length>0){const e=t.storySummary[t.storySummary.length-1];i.content=e.content,e.image&&(i.thumbnail=e.image)}}catch(t){console.warn("解析存档内容失败:",t)}}catch(t){console.warn("无法获取存档内容摘要:",t)}return i}catch(t){return console.error("处理存档数据出错:",t),null}}async loadGameFromKey(t){try{console.log("准备加载存档，key:",t),this.uiManager.showConfirmDialog("确定要加载此存档吗？当前游戏进度将丢失。",(async()=>{console.log("用户确认加载存档，开始加载过程"),this.uiManager.showLoading("正在加载存档...");try{const e=await this.loadGameState(t);if(e){console.log("存档加载成功，准备关闭弹窗并更新游戏状态"),this.closeLoadGameModal(),console.log("触发gameloaded事件");const t=new CustomEvent("gameloaded",{detail:{gameData:e}});window.dispatchEvent(t),this.uiManager.showNotification("加载存档成功","success")}else console.error("加载游戏状态失败，gameData为null"),this.uiManager.showNotification("加载存档失败","error")}catch(t){console.error("加载存档处理过程中出错:",t),this.uiManager.showNotification("加载存档失败: "+(t instanceof Error?t.message:"未知错误"),"error")}finally{this.uiManager.hideLoading()}}))}catch(t){console.error("加载存档过程出错:",t),this.uiManager.showNotification("加载存档失败","error")}}async saveGameState(t,e=!1,n){if(!t||!t.storySummary||0===t.storySummary.length)return console.warn("没有可保存的游戏状态"),!1;try{if(!this.worldBookName&&(console.log("世界书名称为空，重新初始化"),await this.initializeChatLorebook(),!this.worldBookName))return console.error("初始化世界书失败，无法保存游戏状态"),this.uiManager.showNotification("无法初始化世界书，保存失败","error"),!1;if("function"!=typeof window.getLorebookEntries)return console.error("世界书API不可用"),this.uiManager.showNotification("世界书API不可用，无法保存游戏状态","error"),!1;const r=e?this.SAVE_TYPE.MANUAL:this.SAVE_TYPE.AUTO,o=e?++this.currentMaxSaveId.manual:++this.currentMaxSaveId.auto,i=`${r}${o}`;let a="",s=t.story.dialogue.length,c=t.storySummary.length;if(e&&n)a=`${n} #${o} [对话:${s}条|记忆:${c}条]`;else if(e)a=`手动存档 #${o} [对话:${s}条|记忆:${c}条]`;else{const e=t.storySummary[t.storySummary.length-1];a=`自动存档 #${o}-${e.content.substring(0,30)+(e.content.length>30?"...":"")} [对话:${s}条|记忆:${c}条]`}await this.saveDialogueHistory(t);const u=JSON.stringify(t),l=(Date.now(),3),h=1e4;for(let t=0;t<l;t++)try{console.log(`获取世界书条目，尝试 ${t+1}/${l}`);const e=await window.getLorebookEntries(this.worldBookName),n=this.findEntryByKey(e,i),r=async t=>{const e=new Promise(((t,e)=>{setTimeout((()=>e(new Error("操作超时"))),h)}));return Promise.race([t,e])};if(n){if(console.log(`存档 ${i} 已存在，将更新条目 uid=${n.uid}`),"number"!=typeof n.uid||isNaN(n.uid))throw new Error(`无效的UID: ${n.uid}`);const e={uid:n.uid,comment:a,content:u};try{if("function"==typeof window.setLorebookEntries){await r(window.setLorebookEntries(this.worldBookName,[e])),console.log(`成功更新条目 UID=${n.uid}`);break}if("function"==typeof window.editLorebookEntry){await r(window.editLorebookEntry(this.worldBookName,n.uid,{comment:a,content:u})),console.log(`成功更新条目 UID=${n.uid} (使用editLorebookEntry)`);break}{await r(window.deleteLorebookEntry(this.worldBookName,n.uid));const t=await r(window.createLorebookEntry(this.worldBookName,{key:[i],comment:a,content:u}));if(t>0){console.log(`成功删除旧条目并创建新条目 UID=${t}`);break}throw new Error(`创建新条目失败，返回的UID无效: ${t}`)}}catch(e){if(console.error(`更新条目尝试 ${t+1} 失败:`,e),!(t<l-1))throw e;console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)))}}else{console.log(`存档 ${i} 不存在，将创建新条目`);const e={key:[i],comment:a,content:u};try{let t=!1;if("function"==typeof window.createLorebookEntries){const n=await r(window.createLorebookEntries(this.worldBookName,[e]));n&&n.new_uids&&n.new_uids.length>0?(console.log(`成功创建新条目，UID=${n.new_uids[0]}`),t=!0):console.warn("createLorebookEntries返回结果无效，将尝试旧API")}if(!t&&"function"==typeof window.createLorebookEntry){const n=await r(window.createLorebookEntry(this.worldBookName,e));if(!(n>0))throw new Error(`创建条目失败，返回的UID无效: ${n}`);console.log(`成功创建新条目，UID=${n}`),t=!0}if(t)break;throw new Error("没有可用的API创建条目")}catch(e){if(console.error(`创建条目尝试 ${t+1} 失败:`,e),!(t<l-1))throw e;console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)))}}}catch(e){if(t===l-1)throw e}return e?this.currentMaxSaveId.manual=o:this.currentMaxSaveId.auto=o,console.log(`已成功保存游戏状态到世界书，包含 ${s} 条对话和 ${c} 条记忆`),!0}catch(t){return console.error("保存游戏状态到世界书失败:",t),this.uiManager.showNotification("保存游戏状态失败: "+(t instanceof Error?t.message:"未知错误"),"error"),!1}}async loadCompleteHistory(){try{if(this.cachedCompleteHistory)return this.cachedCompleteHistory;if(this.worldBookName||await this.initializeChatLorebook(),"function"!=typeof window.getLorebookEntries)return console.warn("世界书API不可用，无法加载完整历史记录"),null;const t=await window.getLorebookEntries(this.worldBookName);if(!t||!Array.isArray(t))return console.warn("未找到世界书条目"),null;const e=this.findEntryByKey(t,this.COMPLETE_HISTORY_KEY);if(!e){console.log("未找到完整历史记录条目，将创建新记录");const t={id:`history_${Date.now()}`,dialogues:[],memories:[]};return this.cachedCompleteHistory=t,t}let n="";if(e.content?n=e.content:"function"==typeof window.triggerSlash&&(n=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${this.COMPLETE_HISTORY_KEY}`)),!n){console.log("完整历史记录内容为空，将创建新记录");const t={id:`history_${Date.now()}`,dialogues:[],memories:[]};return this.cachedCompleteHistory=t,t}try{const t=JSON.parse(n);if(!t.id||!Array.isArray(t.dialogues)||!Array.isArray(t.memories))throw new Error("历史记录格式不正确");return console.log(`成功加载完整历史记录，包含 ${t.dialogues.length} 条对话和 ${t.memories.length} 条记忆`),this.cachedCompleteHistory=t,t}catch(t){console.error("解析完整历史记录失败:",t);const e={id:`history_${Date.now()}`,dialogues:[],memories:[]};return this.cachedCompleteHistory=e,e}}catch(t){return console.error("加载完整历史记录失败:",t),null}}async saveCompleteHistory(t){try{if(this.worldBookName||await this.initializeChatLorebook(),!this.worldBookName||"function"!=typeof window.getLorebookEntries)return console.warn("世界书API不可用，无法保存完整历史记录"),!1;const e=await window.getLorebookEntries(this.worldBookName),n=this.findEntryByKey(e,this.COMPLETE_HISTORY_KEY),r=`完整游戏历史记录 - 最后更新: ${(new Date).toLocaleString()}`,o=JSON.stringify(t);return n?("function"==typeof window.editLorebookEntry?await window.editLorebookEntry(this.worldBookName,n.uid,{comment:r,content:o}):(await window.deleteLorebookEntry(this.worldBookName,n.uid),await window.createLorebookEntry(this.worldBookName,{keys:[this.COMPLETE_HISTORY_KEY],comment:r,content:o})),console.log("更新了完整历史记录")):(await window.createLorebookEntry(this.worldBookName,{keys:[this.COMPLETE_HISTORY_KEY],comment:r,content:o}),console.log("创建了新的完整历史记录条目")),this.cachedCompleteHistory=t,!0}catch(t){return console.error("保存完整历史记录失败:",t),!1}}async saveDialogueHistory(t){if(!t.story||!t.story.dialogue)return console.warn("没有可保存的对话历史"),!1;try{let e=await this.loadCompleteHistory();e||(e={id:`history_${Date.now()}`,dialogues:[],memories:[]});const n=e.dialogues.length,r=t.story.dialogue.map((t=>({speaker:t.speaker,content:t.content,style:t.style})));if(n<r.length&&(e.dialogues=r,console.log(`更新对话历史：从 ${n} 条增加到 ${r.length} 条`)),t.storySummary&&t.storySummary.length>0){const n=new Set(e.memories.map((t=>t.id)));for(const r of t.storySummary)n.has(r.id)||(e.memories.push({id:r.id,content:r.content}),n.add(r.id));console.log(`更新记忆历史：当前共有 ${e.memories.length} 条记忆`)}const o=await this.saveCompleteHistory(e);return await this.saveLegacyDialogueHistory(t,e),o}catch(t){return console.error("保存对话历史到世界书失败:",t),!1}}async saveLegacyDialogueHistory(t,e){try{if(this.worldBookName||await this.initializeChatLorebook(),!this.worldBookName||"function"!=typeof window.getLorebookEntries)return console.warn("世界书API不可用，无法保存旧版对话历史"),!1;const t=await window.getLorebookEntries(this.worldBookName),n=this.findEntryByKey(t,this.DIALOGUE_HISTORY_KEY);let r="";for(const t of e.dialogues)"玩家"===t.speaker?r+=`选择:${t.content};`:r+=`${t.speaker}:${t.content};`;for(const t of e.memories)(t.content.includes("穿越")||t.content.includes("回到"))&&(r+=`回到过去:${t.content};`);const o=`对话历史记录 - ${(new Date).toLocaleString()}`,i=`<log>${r}</log>`;try{return n?("function"==typeof window.editLorebookEntry?await window.editLorebookEntry(this.worldBookName,n.uid,{comment:o,content:i}):(await window.deleteLorebookEntry(this.worldBookName,n.uid),await window.createLorebookEntry(this.worldBookName,{keys:[this.DIALOGUE_HISTORY_KEY],comment:o,content:i})),console.log("更新了旧版对话历史记录")):(await window.createLorebookEntry(this.worldBookName,{keys:[this.DIALOGUE_HISTORY_KEY],comment:o,content:i}),console.log("创建了新的旧版对话历史记录条目")),!0}catch(t){return console.error("保存旧版对话历史失败:",t),!1}}catch(t){return console.error("保存旧版对话历史到世界书失败:",t),!1}}async getDialogueHistory(){try{const t=await this.loadCompleteHistory();if(t&&t.dialogues&&t.dialogues.length>0){console.log(`从完整历史记录中获取 ${t.dialogues.length} 条对话历史`);return t.dialogues.map((t=>({speaker:t.speaker,content:t.content,style:t.style||"normal"})))}if(console.log("未找到完整历史记录，尝试旧版格式"),this.worldBookName||await this.initializeChatLorebook(),"function"!=typeof window.getLorebookEntries)return console.warn("世界书API不可用，无法获取对话历史"),null;const e=await window.getLorebookEntries(this.worldBookName);if(!e||!Array.isArray(e)||0===e.length)return console.warn("没有找到世界书条目"),null;const n=this.findEntryByKey(e,this.DIALOGUE_HISTORY_KEY);if(!n)return console.warn("没有找到对话历史条目"),null;let r="";if(n.content)r=n.content;else if("function"==typeof window.triggerSlash){let t=this.DIALOGUE_HISTORY_KEY;Array.isArray(n.key)&&n.key.length>0?t=n.key[0]:"string"==typeof n.key&&(t=n.key),r=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${t}`)}if(!r)return console.warn("对话历史内容为空"),null;try{if(r.includes("<log>")&&r.includes("</log>")){const t=r.match(/<log>([\s\S]*?)<\/log>/);if(t&&t[1]){const e=t[1].split(";").filter((t=>t.trim().length>0)),n=[];for(const t of e)if(t.includes(":")){const[e,r]=t.split(":",2);"选择"===e?n.push({speaker:"玩家",content:r,style:"normal"}):"回到过去"===e?n.push({speaker:"旁白",content:`【时间穿越：${r}】`,style:"special"}):n.push({speaker:e,content:r,style:"normal"})}return console.log(`从旧版格式读取了 ${n.length} 条对话历史`),n}}else try{const t=JSON.parse(r);if(Array.isArray(t))return console.log(`从JSON格式读取了 ${t.length} 条对话历史`),t}catch(t){console.warn("无法解析对话历史为JSON格式:",t)}}catch(t){console.error("解析对话历史内容失败:",t)}return null}catch(t){return console.error("获取对话历史失败:",t),null}}async loadGameState(t){for(let e=0;e<3;e++)try{if(!this.worldBookName&&(console.log("世界书名称为空，重新初始化"),await this.initializeChatLorebook(),!this.worldBookName))return console.error("初始化世界书失败，无法加载游戏状态"),this.uiManager.showNotification("无法初始化世界书，加载失败","error"),null;if("function"!=typeof window.getLorebookEntries)return console.error("世界书读取API不可用"),this.uiManager.showNotification("世界书API不可用，无法加载存档","error"),null;console.log(`获取世界书条目，尝试 ${e+1}/3`);const n=await window.getLorebookEntries(this.worldBookName),r=this.findEntryByKey(n,t);if(!r){if(console.warn(`找不到存档键 ${t}`),e<2){console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)));continue}return this.uiManager.showNotification("找不到指定存档","warning"),null}let o="";try{if(r.content)o=r.content,console.log("直接从条目获取到内容");else if("function"==typeof window.triggerSlash){let e=t;Array.isArray(r.key)&&r.key.length>0?e=r.key[0]:"string"==typeof r.key&&(e=r.key),console.log(`通过triggerSlash获取条目内容，key=${e}`),o=await window.triggerSlash(`/getentryfield file=${this.worldBookName} field=content ${e}`),o&&console.log("通过triggerSlash成功获取内容")}if(!o){if(console.warn(`存档键 ${t} 对应的内容为空`),e<2){console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)));continue}return this.uiManager.showNotification("存档内容为空","warning"),null}try{console.log("解析存档内容...");const t=JSON.parse(o);if(t&&t.story)return t.story.currentDialogueIndex=0,console.log("成功解析存档内容，重置对话索引"),t;if(console.warn("解析的存档缺少必要数据"),e<2){console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)));continue}return this.uiManager.showNotification("存档数据不完整或格式错误","error"),null}catch(t){if(console.error("解析存档内容失败:",t),e<2){console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)));continue}return this.uiManager.showNotification("存档内容格式错误","error"),null}}catch(n){if(console.error(`获取存档 ${t} 内容失败:`,n),e<2){console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)));continue}return this.uiManager.showNotification("获取存档内容失败","error"),null}}catch(t){if(console.error(`加载游戏存档尝试 ${e+1} 失败:`,t),!(e<2))return this.uiManager.showNotification("加载存档失败: "+(t instanceof Error?t.message:"未知错误"),"error"),null;console.log("等待500ms后重试..."),await new Promise((t=>setTimeout(t,500)))}return null}async loadGameStateByID(t,e=!1){const n=e?`${this.SAVE_TYPE.MANUAL}${t}`:`${this.SAVE_TYPE.AUTO}${t}`;return this.loadGameState(n)}async getCompleteHistory(){return this.loadCompleteHistory()}loadGame(){this.showLoadGameModal()}}var h=n(935);class f{defaultSettings={fontSize:"medium",uiMode:"adaptive",gameHeight:"auto"};currentSettings;onSettingsChangedCallback=null;SETTINGS_STORAGE_KEY="monastery_game_settings";constructor(){this.currentSettings=this.loadSettings(),this.applySettings(),console.log("设置管理器初始化完成")}loadSettings(){try{const t=localStorage.getItem(this.SETTINGS_STORAGE_KEY);if(t){const e=JSON.parse(t);return e.hasOwnProperty("useMobileUI")&&(e.uiMode=e.useMobileUI?"mobile":"desktop",delete e.useMobileUI),{...this.defaultSettings,...e}}}catch(t){console.error("加载设置失败:",t)}return{...this.defaultSettings}}saveSettings(){try{localStorage.setItem(this.SETTINGS_STORAGE_KEY,JSON.stringify(this.currentSettings))}catch(t){console.error("保存设置失败:",t)}}applySettings(){switch(document.documentElement.classList.remove("font-small","font-medium","font-large"),document.documentElement.classList.add(`font-${this.currentSettings.fontSize}`),document.documentElement.classList.remove("mobile-ui","desktop-ui"),this.currentSettings.uiMode){case"mobile":document.documentElement.classList.add("mobile-ui");break;case"desktop":document.documentElement.classList.add("desktop-ui")}const t=document.querySelector(".game-container");t&&("auto"===this.currentSettings.gameHeight?t.style.height="":t.style.height=`${this.currentSettings.gameHeight}px`),console.log("已应用设置:",this.currentSettings)}updateSettings(t){this.currentSettings={...this.currentSettings,...t},this.saveSettings(),this.applySettings(),this.onSettingsChangedCallback&&this.onSettingsChangedCallback(this.currentSettings)}setFontSize(t){this.updateSettings({fontSize:t})}setUIMode(t){this.updateSettings({uiMode:t})}setGameHeight(t){this.updateSettings({gameHeight:t})}getSettings(){return{...this.currentSettings}}resetSettings(){this.currentSettings={...this.defaultSettings},this.saveSettings(),this.applySettings(),this.onSettingsChangedCallback&&this.onSettingsChangedCallback(this.currentSettings)}setOnSettingsChanged(t){this.onSettingsChangedCallback=t}showSettingsDialog(){const t=`\n      <div id="settings-dialog" class="modal fade">\n        <div class="modal-dialog modal-dialog-centered monastery-dialog">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title"><i class="fas fa-cog"></i> 游戏设置</h5>\n              <button type="button" class="close" data-dismiss="modal">&times;</button>\n            </div>\n            <div class="modal-body">\n              <div class="form-group monastery-form-group">\n                <label for="font-size-select" class="monastery-label">\n                  <i class="fas fa-font"></i> 字体大小\n                </label>\n                <select id="font-size-select" class="form-control monastery-select">\n                  <option value="small" ${"small"===this.currentSettings.fontSize?"selected":""}>小</option>\n                  <option value="medium" ${"medium"===this.currentSettings.fontSize?"selected":""}>中</option>\n                  <option value="large" ${"large"===this.currentSettings.fontSize?"selected":""}>大</option>\n                </select>\n              </div>\n              <div class="form-group monastery-form-group">\n                <label for="ui-mode-select" class="monastery-label">\n                  <i class="fas fa-mobile-alt"></i> 界面模式\n                </label>\n                <select id="ui-mode-select" class="form-control monastery-select">\n                  <option value="adaptive" ${"adaptive"===this.currentSettings.uiMode?"selected":""}>自适应</option>\n                  <option value="mobile" ${"mobile"===this.currentSettings.uiMode?"selected":""}>手机</option>\n                  <option value="desktop" ${"desktop"===this.currentSettings.uiMode?"selected":""}>电脑</option>\n                </select>\n                <small class="form-text text-muted monastery-help-text">自适应: 根据屏幕大小自动调整; 手机/电脑: 强制使用对应界面</small>\n              </div>\n              <div class="form-group monastery-form-group">\n                <label for="game-height-mode" class="monastery-label">\n                  <i class="fas fa-arrows-alt-v"></i> 游戏界面高度\n                </label>\n                <div class="custom-control custom-switch mb-2">\n                  <input type="checkbox" class="custom-control-input" id="height-custom-switch" ${"auto"!==this.currentSettings.gameHeight?"checked":""}>\n                  <label class="custom-control-label" for="height-custom-switch">自定义高度</label>\n                </div>\n                <div id="custom-height-container" class="mt-2 ${"auto"===this.currentSettings.gameHeight?"d-none":""}">\n                  <div class="input-group">\n                    <input \n                      type="number" \n                      id="game-height-input" \n                      class="form-control monastery-input" \n                      value="${"auto"===this.currentSettings.gameHeight?1e3:this.currentSettings.gameHeight}" \n                      min="500" \n                      max="2000" \n                      step="50" \n                    />\n                    <div class="input-group-append">\n                      <span class="input-group-text">px</span>\n                    </div>\n                  </div>\n                  <small class="form-text text-muted monastery-help-text">推荐值: 1000px（可根据屏幕大小调整）</small>\n                </div>\n              </div>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-secondary monastery-btn monastery-btn-secondary" id="reset-settings-btn">\n                <i class="fas fa-undo"></i> 恢复默认\n              </button>\n              <button type="button" class="btn btn-primary monastery-btn monastery-btn-primary" id="save-settings-btn">\n                <i class="fas fa-check"></i> 保存设置\n              </button>\n              <button type="button" class="btn btn-secondary monastery-btn monastery-btn-cancel" data-dismiss="modal">\n                <i class="fas fa-times"></i> 取消\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;$("body").append(t),$("#height-custom-switch").on("change",(function(){$(this).is(":checked")?$("#custom-height-container").removeClass("d-none"):$("#custom-height-container").addClass("d-none")})),$("#save-settings-btn").on("click",(()=>{const t=$("#font-size-select").val(),e=$("#ui-mode-select").val();let n="auto";if($("#height-custom-switch").is(":checked")){const t=$("#game-height-input").val();n=h.clamp(h.parseInt(t)||1e3,500,2e3)}this.updateSettings({fontSize:t,uiMode:e,gameHeight:n}),$("#settings-dialog").modal("hide")})),$("#reset-settings-btn").on("click",(()=>{confirm("确定要恢复默认设置吗？")&&(this.resetSettings(),$("#font-size-select").val(this.defaultSettings.fontSize),$("#ui-mode-select").val(this.defaultSettings.uiMode),$("#height-custom-switch").prop("checked","auto"!==this.defaultSettings.gameHeight),"auto"===this.defaultSettings.gameHeight?$("#custom-height-container").addClass("d-none"):($("#custom-height-container").removeClass("d-none"),$("#game-height-input").val(this.defaultSettings.gameHeight)))})),$("#settings-dialog").modal("show").data("backdrop","static").data("keyboard",!1),$("#settings-dialog").on("hidden.bs.modal",(function(){$(this).remove()}))}}class d{currentConfirmCallback=null;constructor(){toastr.options={closeButton:!0,progressBar:!0,positionClass:"toast-top-right",preventDuplicates:!1,timeOut:3e3},console.log("UI管理器初始化完成")}showLoading(t="加载中..."){$(".loading-text").text(t),$(".loading-indicator").removeClass("hidden")}hideLoading(){$(".loading-indicator").addClass("hidden")}showConfirmDialog(t,e){this.currentConfirmCallback=e,console.log("显示确认对话框:",t),$("#confirm-message").text(t),$("#confirm-container").removeClass("hidden"),$("#confirm-yes").off("click").on("click",(()=>this.handleConfirmYes())),$("#confirm-no").off("click").on("click",(()=>this.hideConfirmDialog())),$(document).on("click.confirm-outside",(t=>{0!==$(t.target).closest(".confirm-dialog").length||$("#confirm-container").hasClass("hidden")||this.hideConfirmDialog()}))}hideConfirmDialog(){$("#confirm-container").addClass("hidden"),$(document).off("click.confirm-outside"),this.currentConfirmCallback=null}handleConfirmYes(){this.currentConfirmCallback&&this.currentConfirmCallback(),this.hideConfirmDialog()}showNotification(t,e="info",n=3e3){switch(toastr.options.timeOut=n,e){case"success":toastr.success(t);break;case"warning":toastr.warning(t);break;case"error":toastr.error(t);break;default:toastr.info(t)}}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}showTooltip(t,e){$(t).attr("title",e).tooltip({content:e,position:{my:"center bottom",at:"center top-5"},show:{effect:"fadeIn",duration:200},hide:{effect:"fadeOut",duration:200}}).tooltip("open"),setTimeout((()=>{$(t).tooltip("close")}),2e3)}showInputDialog(t,e,n){$("#input-dialog").length>0&&$("#input-dialog").remove();const r=`\n      <div id="input-dialog" class="modal fade">\n        <div class="modal-dialog modal-dialog-centered monastery-dialog">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title"><i class="fas fa-feather-alt"></i> ${t}</h5>\n              <button type="button" class="close" data-dismiss="modal">&times;</button>\n            </div>\n            <div class="modal-body">\n              <div class="input-dialog-container">\n                <label for="input-dialog-value" class="monastery-label">为您的记录命名：</label>\n                <input type="text" id="input-dialog-value" class="form-control monastery-input" value="${e}">\n              </div>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-primary monastery-btn monastery-btn-primary" id="input-dialog-confirm">\n                <i class="fas fa-save"></i> 确定\n              </button>\n              <button type="button" class="btn btn-secondary monastery-btn monastery-btn-secondary" data-dismiss="modal">\n                <i class="fas fa-times"></i> 取消\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;$("body").append(r),$("#input-dialog-confirm").on("click",(()=>{const t=$("#input-dialog-value").val();$("#input-dialog").modal("hide"),n(t)})),$("#input-dialog-value").on("keypress",(t=>{13===t.which&&$("#input-dialog-confirm").click()})),$("#input-dialog").modal("show"),$("#input-dialog-value").focus()}}class g{characters=new Map;constructor(){console.log("角色资源服务已初始化"),this.initializeCharacters()}initializeCharacters(){this.characters.set("cecilia",{id:"cecilia",name:"Cecilia修女",fullName:"Sister Cecilia",position:"right",emotions:{default:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%BE%AE%E7%AC%91.png?ref_type=heads",smile:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%BE%AE%E7%AC%91.png?ref_type=heads",sad:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%93%AD%E6%B3%A3.png?ref_type=heads",shocked:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E6%83%8A%E8%AE%B6.png?ref_type=heads",blush:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%AE%B3%E7%BE%9E.png?ref_type=heads"},bio:"一位年轻的见习修女，专注于抄写工作，对草药学有浓厚兴趣。"}),this.characters.set("player",{id:"player",name:"{{user}}",fullName:"The Visitor",position:"left",emotions:{default:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E9%BB%98%E8%AE%A4.png?ref_type=heads",smile:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%BE%AE%E7%AC%91.png?ref_type=heads",sad:"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%93%AD%E6%B3%A3.png?ref_type=heads"},bio:"一位到访修道院的神秘人物，对修道院的历史和草药学表示了浓厚兴趣。"})}getCharacter(t){return this.characters.get(t)}getAllCharacterIds(){return Array.from(this.characters.keys())}getCharacterEmotionUrl(t,e="default"){const n=this.characters.get(t);if(n)return n.emotions[e]||n.emotions.default}getCharacterName(t){const e=this.characters.get(t);return e?e.name:"未知角色"}addCharacter(t){return this.characters.has(t.id)?(console.warn(`角色ID: ${t.id} 已存在，无法添加`),!1):(this.characters.set(t.id,t),!0)}updateCharacter(t,e){const n=this.characters.get(t);if(!n)return console.warn(`角色ID: ${t} 不存在，无法更新`),!1;const r=_.merge({},n,e);return this.characters.set(t,r),!0}}class m{defaultGameData={story:{date:"1243年 夏",location:"修道院",scene:"图书室",dialogue:[{speaker:"Cecilia修女",content:"欢迎来到修道院，这里是我们的图书室。",style:"normal",portrait:{character:"cecilia",emotion:"smile"},background:{location:"修道院",scene:"图书室"}},{speaker:"玩家",content:"谢谢你的接待，这里的藏书真是令人惊叹。",style:"normal",portrait:{character:"player",emotion:"default"}},{speaker:"旁白",content:"Cecilia修女微笑着拿起一本古老的书籍。",style:"special"},{speaker:"Cecilia修女",content:"这本是我们修道院最珍贵的草药学手稿，记载了很多珍贵的药方。",style:"normal",portrait:{character:"cecilia",emotion:"thoughtful"}},{speaker:"图书管理员",content:"午餐时间到了，请各位移步餐厅。",style:"normal"},{speaker:"Cecilia修女",content:"不如我们去花园里继续聊吧？",style:"normal",portrait:{character:"cecilia",emotion:"smile"},background:{location:"修道院",scene:"花园"}}],options:["好的，我很乐意。","我想先了解更多关于那本草药手稿的内容。","我需要先休息一下，稍后再聊。"],currentDialogueIndex:0,currentChapter:"第一章：修道院的秘密",currentFunds:50},storySummary:[{id:1,content:"玩家来到修道院，与Cecilia修女在图书室相遇，得知了一本珍贵的草药学手稿。",timestamp:(new Date).toISOString()}]};constructor(){console.log("游戏数据服务已初始化")}async loadGameData(){return this.defaultGameData}async saveGameData(t){console.log("游戏数据已保存")}}class p{lastRawResponse="";constructor(){console.log("游戏状态生成服务已初始化")}getLastRawResponse(){return this.lastRawResponse}async generateNextGameState(t){if("function"!=typeof window.generate)return console.warn("generate API不可用"),null;try{const e={user_input:t,should_stream:!1,injects:[{role:"system",content:`<选择>${t}</选择>`,position:"before_prompt",depth:0,should_scan:!1}]},n=await window.generate(e);this.lastRawResponse=n,console.log("%c[LLM完整响应]","color: #ff5722; font-weight: bold;"),console.log(n);const r=/<gametext>([\s\S]*?)<\/gametext>/,o=n.match(r);if(!o||!o[1])return console.error("未找到<gametext>标签或内容为空"),null;try{const t=o[1].trim();console.log("%c[找到游戏状态JSON]","color: #4caf50; font-weight: bold;"),console.log(t);return JSON.parse(t)}catch(t){console.error("解析游戏数据JSON失败:",t);const e=o[1].trim();return console.log("%c[解析JSON失败]","color: #f44336; font-weight: bold;",e),null}}catch(t){return console.error("生成游戏状态失败:",t),null}}async generateMemoryState(t){if("function"!=typeof window.generate)return console.warn("generate API不可用"),null;try{const e=`<时间跳跃>${t.content}</时间跳跃>`,n=await window.generate({user_input:`穿越到记忆点"${t.content}"`,should_stream:!1,injects:[{role:"system",content:e,position:"before_prompt",depth:0,should_scan:!1}]});this.lastRawResponse=n,console.log("%c[LLM记忆点响应]","color: #ff9800; font-weight: bold;"),console.log(n);const r=/<gametext>([\s\S]*?)<\/gametext>/,o=n.match(r);if(o&&o[1])try{const t=o[1].trim();console.log("%c[找到记忆点游戏状态JSON]","color: #4caf50; font-weight: bold;"),console.log(t);return JSON.parse(t)}catch(t){console.error("解析记忆点游戏数据JSON失败:",t);const e=o[1].trim();return console.log("%c[解析记忆点JSON失败]","color: #f44336; font-weight: bold;",e),null}}catch(t){console.error("生成记忆点游戏状态失败:",t)}return null}async handleCustomAction(t){if("function"!=typeof window.generate)return console.warn("generate API不可用"),null;try{const e=`<自定义行动>${t}</自定义行动>`,n=await window.generate({user_input:t,should_stream:!1,injects:[{role:"system",content:e,position:"before_prompt",depth:0,should_scan:!1}]});this.lastRawResponse=n,console.log("%c[LLM自定义行动响应]","color: #2196f3; font-weight: bold;"),console.log(n);const r=/<gametext>([\s\S]*?)<\/gametext>/,o=n.match(r);if(o&&o[1])try{const t=o[1].trim();console.log("%c[找到自定义行动游戏状态JSON]","color: #4caf50; font-weight: bold;"),console.log(t);return JSON.parse(t)}catch(t){console.error("解析自定义行动游戏数据JSON失败:",t);const e=o[1].trim();return console.log("%c[解析自定义行动JSON失败]","color: #f44336; font-weight: bold;",e),null}}catch(t){console.error("处理自定义行动失败:",t)}return null}initDebugHelpers(){window.debugLLMResponse=()=>{console.log("%c[Debug] 最后一次LLM响应","background: #222; color: #bada55"),console.log(this.lastRawResponse);const t=this.lastRawResponse.match(/<gametext>([\s\S]*?)<\/gametext>/);if(t&&t[1]){console.log("%c[Debug] 提取的gametext内容","background: #222; color: #ffa500"),console.log(t[1]);try{const e=JSON.parse(t[1]);console.log("%c[Debug] 解析后的JSON对象","background: #222; color: #4caf50"),console.log(e)}catch(t){console.log("%c[Debug] JSON解析失败","background: #222; color: #f44336"),console.log(t)}}else console.log("%c[Debug] 未找到gametext标签","background: #222; color: #f44336");return"调试信息已输出到控制台"}}}class y{gameData=null;gameDataService;gameStateGenerationService;characterResourceService;dialogueManager;characterManager;backgroundManager;choiceManager;memoryManager;memoryUIManager;uiManager;saveManager;journalManager;settingsManager;constructor(){this.gameDataService=new m,this.gameStateGenerationService=new p,this.characterResourceService=new g,this.uiManager=new d,this.saveManager=new l(this.uiManager),this.backgroundManager=new r,this.characterManager=new o(this.characterResourceService),this.dialogueManager=new a(this.characterResourceService,this.characterManager,this.backgroundManager),this.choiceManager=new i,this.memoryManager=new c,this.journalManager=new s,this.memoryUIManager=new u(this.memoryManager,this.saveManager,this.uiManager,this.gameStateGenerationService),this.settingsManager=new f,this.gameStateGenerationService.initDebugHelpers(),console.log("调试辅助功能已初始化，请在控制台使用 window.debugLLMResponse() 查看最近一次LLM响应"),this.init()}async init(){console.log("初始化游戏界面..."),this.registerEventListeners(),await this.loadGameData(),this.updateUI(),this.initDebugFunctions(),console.log("游戏界面初始化完成!")}initDebugFunctions(){window.testConfirmDialog=()=>{console.log("测试确认对话框"),window.confirmTestCount||(window.confirmTestCount=0),window.confirmTestCount++,this.uiManager.showConfirmDialog(`这是一个测试确认对话框 #${window.confirmTestCount}，用于检查位置和点击功能。请点击"确认"按钮测试是否可点击。`,(()=>{console.log("确认对话框被确认"),this.uiManager.showNotification(`确认对话框 #${window.confirmTestCount} 测试成功!`,"success")}))},console.log("调试功能已初始化，可在控制台使用 window.testConfirmDialog() 测试确认对话框")}registerEventListeners(){$(".tab-button").on("click",(t=>{const e=$(t.currentTarget).data("tab");e&&this.switchTab(e)})),$(".journal-nav-item").on("click",(t=>{const e=$(t.currentTarget).data("section");e&&this.journalManager.switchJournalSection(e)})),$("#save-game").on("click",(()=>{this.saveGame()})),$("#load-game").on("click",(()=>{this.loadGame()})),$("#settings-button").on("click",(()=>{this.showSettings()})),$("#save-memory").on("click",(()=>{const t=this.memoryUIManager.saveMemory();t&&this.gameData&&this.gameData.storySummary.push(t)})),$("#travel-memory").on("click",(()=>{this.memoryUIManager.travelToMemory((()=>{this.gameData=this.memoryUIManager.getGameData(),this.updateUI(),this.switchTab("story-tab")}))})),$("#dialogue-history").on("click",(()=>{this.showDialogueHistory()})),$(document).on("click",".choice-button",(t=>{const e=$(t.currentTarget).data("choice");this.makeChoice(e)})),window.addEventListener("request_game_data",(t=>{if(t.detail&&"function"==typeof t.detail.callback){const e={story:this.gameData?.story||{date:"未知日期",location:"未知位置",scene:"未知场景",dialogue:[],options:[],currentDialogueIndex:0,currentChapter:"第1章",currentFunds:0},storySummary:this.gameData?.storySummary||[]};t.detail.callback(e)}})),window.addEventListener("gameloaded",(t=>{t.detail&&t.detail.gameData&&(this.gameData=t.detail.gameData,this.updateUI(),this.switchTab("story-tab"),this.uiManager.showNotification("游戏已加载","success"))})),$("#dialogue-container").on("click",(t=>{$(t.target).closest(".dialogue-controls").length||(this.choiceManager.canReshowChoices()?this.choiceManager.reshowChoices():this.nextDialogue())})),this.choiceManager.setOnChoiceSelected((t=>{this.makeChoice(t)}))}async loadGameData(){try{this.gameData=await this.gameDataService.loadGameData(),this.journalManager.setGameData(this.gameData),this.memoryUIManager.setGameData(this.gameData)}catch(t){console.error("加载游戏数据失败:",t)}}switchTab(t){$(".tab-button").removeClass("active"),$(".tab-pane").removeClass("active"),$(`[data-tab="${t}"]`).addClass("active"),$(`#${t}`).addClass("active"),"memory-tab"===t&&this.memoryUIManager.refreshMemoryTimeline(),"journal-tab"===t&&this.journalManager.refreshJournalContent()}async showDialogueHistory(){const t=await this.saveManager.getDialogueHistory();t&&this.dialogueManager.showDialogueHistory(t)}showSettings(){console.log("显示设置"),this.settingsManager.showSettingsDialog()}saveGame(){console.log("保存游戏..."),this.uiManager.showInputDialog("请输入典籍标题","当前进度记录",(async t=>{try{this.uiManager.showLoading("正在记录典籍...");await this.saveManager.saveGameState(this.gameData,!0,t)&&this.uiManager.showNotification("典籍记录成功","success")}catch(t){console.error("保存游戏失败:",t),this.uiManager.showNotification("典籍记录失败","error")}finally{this.uiManager.hideLoading()}}))}loadGame(){console.log("加载游戏..."),this.saveManager.loadGame()}updateUI(){if(this.gameData)try{$("#game-date").text(this.gameData.story.date),this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.dialogueManager.renderDialogue(this.gameData.story.currentDialogueIndex),this.backgroundManager.setBackground(this.gameData.story.location,this.gameData.story.scene),this.choiceManager.setChoices(this.gameData.story.options),$("#memory-tab").hasClass("active")&&this.memoryUIManager.refreshMemoryTimeline(),$("#journal-tab").hasClass("active")&&this.journalManager.refreshJournalContent(),console.log("UI已更新")}catch(t){console.error("更新UI时发生错误:",t)}else console.error("无法更新UI：游戏数据不存在")}nextDialogue(){if(!this.gameData)return;if(this.dialogueManager.showNextDialogue())this.gameData.story.currentDialogueIndex=this.dialogueManager.getCurrentDialogueIndex();else if(this.gameData.story.options.length>0){const t=this.dialogueManager.isDialogueFinished(),e=this.choiceManager.areChoicesVisible();t&&!e?(console.log("对话已结束，显示选项"),this.choiceManager.showChoices()):e&&console.log("选项已显示，不再重复显示")}else console.log("对话结束，且没有可用选项")}async makeChoice(t){if(!this.gameData)return;console.log(`玩家选择了: ${t}`);const e=!this.gameData.story.options.includes(t);this.choiceManager.hideChoices(),this.uiManager.showLoading("正在生成回应...");const n=this.gameData.story.dialogue.length,r=this.gameData.story.currentDialogueIndex,o={speaker:"玩家",content:t,style:"normal"};this.gameData.story.dialogue.push(o),this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.gameData.story.currentDialogueIndex=this.gameData.story.dialogue.length-1,this.dialogueManager.showDialogue(this.gameData.story.currentDialogueIndex);try{const o=e?await this.gameStateGenerationService.handleCustomAction(t):await this.gameStateGenerationService.generateNextGameState(t);o?(this.gameData=o,this.updateUI(),await this.saveManager.saveGameState(this.gameData)):this.gameData&&(this.gameData.story.dialogue=this.gameData.story.dialogue.slice(0,n),this.gameData.story.currentDialogueIndex=r,this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.dialogueManager.showDialogue(this.gameData.story.currentDialogueIndex),this.choiceManager.showChoices(),this.uiManager.showNotification("生成游戏状态失败，请重新选择","warning"))}catch(t){console.error("处理玩家选择时出错:",t),this.gameData&&(this.gameData.story.dialogue=this.gameData.story.dialogue.slice(0,n),this.gameData.story.currentDialogueIndex=r,this.dialogueManager.setDialogues(this.gameData.story.dialogue),this.dialogueManager.showDialogue(this.gameData.story.currentDialogueIndex),this.choiceManager.showChoices(),this.uiManager.showNotification("生成响应时出错，请重新选择","error"))}finally{this.uiManager.hideLoading()}}}$(document).ready((()=>{new y}));</script></body></html>