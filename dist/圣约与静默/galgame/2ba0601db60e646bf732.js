import'./index.scss';class GalgameEngine{constructor(){this.currentIndex=0,this.isAnimating=!1,this.activeCharacters={},this.isTransitioning=!1,this.currentBgPath='',this.dialogHistory=[],this.dialogBox=document.getElementById('dialog-box'),this.characterName=document.getElementById('character-name'),this.dialogText=document.getElementById('dialog-text'),this.currentImage=document.getElementById('background-image-current'),this.nextImage=document.getElementById('background-image-next'),this.characterContainer=document.getElementById('character-container'),this.historyPanel=document.getElementById('history-panel'),this.historyContent=document.getElementById('history-content');this.imageBaseUrl='https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/èƒŒæ™¯/',this.characterSpritesBaseUrl='https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/';try{const t=SillyTavern.chat[getCurrentMessageId()].mes.match(/<Galgame>\s*```(?:json|yaml)?(.*)```\s*<\/Galgame>/s)[1];if(!t)throw new Error('æ¸¸æˆæ•°æ® <Galgame> ä¸ºç©ºã€‚');let o=null;try{o=JSON.parse(t),console.log('æ¸¸æˆæ•°æ®åŠ è½½æˆåŠŸ (JSON æ ¼å¼)')}catch(e){console.warn('JSON è§£æå¤±è´¥ï¼Œå°è¯•è§£æä¸º YAML:',e.message);try{o=YAML.parse(t)}catch(t){throw console.error('YAML è§£æä¹Ÿå¤±è´¥:',t),new Error(`æ•°æ®è§£æå¤±è´¥ï¼šæ—¢ä¸æ˜¯æœ‰æ•ˆçš„ JSON ä¹Ÿä¸æ˜¯æœ‰æ•ˆçš„ YAMLã€‚JSON é”™è¯¯: ${e.message} | YAML é”™è¯¯: ${t.message}`)}}Array.isArray(o)&&0!==o.length?(this.dialogData=o,console.log('æœ€ç»ˆä½¿ç”¨çš„æ¸¸æˆæ•°æ®:',this.dialogData)):(console.warn('åŠ è½½çš„å¯¹è¯æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼æ— æ•ˆ (é¢„æœŸä¸ºéç©ºæ•°ç»„)ï¼Œå°†åŠ è½½é»˜è®¤æç¤ºä¿¡æ¯ã€‚'),this.dialogData=[{name:'ç³»ç»Ÿæç¤º',text:'åŠ è½½çš„å¯¹è¯æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼æ— æ•ˆã€‚',characters:'narrator'}])}catch(t){console.error('åŠ è½½æˆ–è§£ææ¸¸æˆæ•°æ®æ—¶å‡ºé”™:',t),this.dialogData=[{name:'ç³»ç»Ÿæç¤º',text:`åŠ è½½å¯¹è¯æ•°æ®å¤±è´¥ï¼š${t.message}`,characters:'narrator'}]}this.characterSprites={ç»œç»œ:{æ°´æ‰‹æœ:{'å¾®ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/å¾®ç¬‘.png','æµ…ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æµ…ç¬‘.png','ç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/ç”Ÿæ°”.png','æƒŠè®¶.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æƒŠè®¶.png','å®³ç¾.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/å®³ç¾.png','ç¨å¾®è„¸çº¢.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/ç¨å¾®è„¸çº¢.png','æ‰‹æ‰˜ä¸‹å·´æ€è€ƒ.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æ‰‹æ‰˜ä¸‹å·´æ€è€ƒ.png','çœ‹é€ä¸€åˆ‡çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/çœ‹é€ä¸€åˆ‡çš„åç¬‘.png','é‚ªæ¶çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/é‚ªæ¶çš„åç¬‘.png','æ˜Ÿæ˜Ÿçœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æ˜Ÿæ˜Ÿçœ¼.png','æ™•æ™•çœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æ™•æ™•çœ¼.png','çŒ«çˆªç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/çŒ«çˆªç”Ÿæ°”.png','æµå£æ°´.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æµå£æ°´.png','å“­æ³£.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/å“­æ³£.png','æ“¦çœ¼æ³ª.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æ“¦çœ¼æ³ª.png','ç­‰å¾…å».png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/ç­‰å¾…å».png','æ€§é«˜æ½®.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æ€§é«˜æ½®.png','çœ¼ç¥ç©ºæ´çš„å‚¬çœ çŠ¶æ€.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/çœ¼ç¥ç©ºæ´çš„å‚¬çœ çŠ¶æ€.png','æ— è¡¨æƒ….png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æ— è¡¨æƒ….png','æ— äºº.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ°´æ‰‹æœ/æ— äºº.png'},æ ¼çº¹è¡«:{'å¾®ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/å¾®ç¬‘.png','æµ…ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æµ…ç¬‘.png','ç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/ç”Ÿæ°”.png','æƒŠè®¶.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æƒŠè®¶.png','å®³ç¾.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/å®³ç¾.png','ç¨å¾®è„¸çº¢.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/ç¨å¾®è„¸çº¢.png','æ‰‹æ‰˜ä¸‹å·´æ€è€ƒ.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æ‰‹æ‰˜ä¸‹å·´æ€è€ƒ.png','çœ‹é€ä¸€åˆ‡çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/çœ‹é€ä¸€åˆ‡çš„åç¬‘.png','é‚ªæ¶çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/é‚ªæ¶çš„åç¬‘.png','æ˜Ÿæ˜Ÿçœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æ˜Ÿæ˜Ÿçœ¼.png','æ™•æ™•çœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æ™•æ™•çœ¼.png','çŒ«çˆªç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/çŒ«çˆªç”Ÿæ°”.png','æµå£æ°´.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æµå£æ°´.png','å“­æ³£.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/å“­æ³£.png','æ“¦çœ¼æ³ª.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æ“¦çœ¼æ³ª.png','ç­‰å¾…å».png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/ç­‰å¾…å».png','æ€§é«˜æ½®.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æ€§é«˜æ½®.png','çœ¼ç¥ç©ºæ´çš„å‚¬çœ çŠ¶æ€.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/çœ¼ç¥ç©ºæ´çš„å‚¬çœ çŠ¶æ€.png','æ— äºº.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/æ ¼çº¹è¡«/æ— äºº.png'},å¼€è¡«:{'å¾®ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/å¾®ç¬‘.png','æµ…ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æµ…ç¬‘.png','ç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/ç”Ÿæ°”.png','æƒŠè®¶.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æƒŠè®¶.png','å®³ç¾.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/å®³ç¾.png','ç¨å¾®è„¸çº¢.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/ç¨å¾®è„¸çº¢.png','æ‰‹æ‰˜ä¸‹å·´æ€è€ƒ.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æ‰‹æ‰˜ä¸‹å·´æ€è€ƒ.png','çœ‹é€ä¸€åˆ‡çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/çœ‹é€ä¸€åˆ‡çš„åç¬‘.png','é‚ªæ¶çš„ç¬‘å®¹.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/é‚ªæ¶çš„ç¬‘å®¹.png','æ˜Ÿæ˜Ÿçœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æ˜Ÿæ˜Ÿçœ¼.png','æ™•æ™•çœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æ™•æ™•çœ¼.png','çŒ«çˆªç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/çŒ«çˆªç”Ÿæ°”.png','æµå£æ°´.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æµå£æ°´.png','å“­æ³£.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/å“­æ³£.png','æ“¦çœ¼æ³ª.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æ“¦çœ¼æ³ª.png','ç­‰å¾…å».png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/ç­‰å¾…å».png','æ€§é«˜æ½®.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æ€§é«˜æ½®.png','æ— è¡¨æƒ….png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æ— è¡¨æƒ….png','æ— äºº.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å¼€è¡«/æ— äºº.png'},ç¡è¡£:{'å¾®ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/å¾®ç¬‘.png','æµ…ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/æµ…ç¬‘.png','ç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/ç”Ÿæ°”.png','æƒŠè®¶.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/æƒŠè®¶.png','å®³ç¾.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/å®³ç¾.png','ç¨å¾®è„¸çº¢.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/ç¨å¾®è„¸çº¢.png','çœ‹é€ä¸€åˆ‡çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/çœ‹é€ä¸€åˆ‡çš„åç¬‘.png','é‚ªæ¶çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/é‚ªæ¶çš„åç¬‘.png','æ˜Ÿæ˜Ÿçœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/æ˜Ÿæ˜Ÿçœ¼.png','æ™•æ™•çœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/æ™•æ™•çœ¼.png','çŒ«çˆªç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/çŒ«çˆªç”Ÿæ°”.png','æµå£æ°´.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/æµå£æ°´.png','å“­æ³£.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/å“­æ³£.png','ç­‰å¾…å».png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/ç­‰å¾…å».png','æ€§é«˜æ½®.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/æ€§é«˜æ½®.png','çœ¼ç¥ç©ºæ´çš„å‚¬çœ çŠ¶æ€.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/çœ¼ç¥ç©ºæ´çš„å‚¬çœ çŠ¶æ€.png','æ— äºº.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/ç¡è¡£/æ— äºº.png'},å…¨è£¸:{'æµ…ç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸æµ…ç¬‘.png','ç”Ÿæ°”.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸ç”Ÿæ°”.png','æƒŠè®¶.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸æƒŠè®¶.png','å®³ç¾.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸å®³ç¾.png','ç¨å¾®è„¸çº¢.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸å¾®å¾®å®³ç¾.png','çœ‹é€ä¸€åˆ‡çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸å¾—æ„è„¸smug.png','é‚ªæ¶çš„åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸é‚ªæ¶çš„ç¬‘å®¹.png','åç¬‘.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸åç¬‘.png','æ˜Ÿæ˜Ÿçœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸é—ªè€€çœ¼.png','æ™•æ™•çœ¼.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸æ™•çœ¼@_@.png','æµå£æ°´.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸çœ‹åˆ°é£Ÿç‰©é¦‹åˆ°æµå£æ°´.png','å“­æ³£.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸å“­æ³£.png','ç­‰å¾…å».png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸ç­‰å¾…æ¥å».png','æ€§é«˜æ½®.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸è‰²æƒ…é«˜æ½®å•Šå˜¿é¢œ.png','çœ¼ç¥ç©ºæ´çš„å‚¬çœ çŠ¶æ€.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/å…¨è£¸è¢«å‚¬çœ åŒçœ¼æ— ç¥ç•™å£æ°´.png','æ— äºº.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/è§’è‰²/å…¨è£¸/æ— äºº.png'}},ä½ :{é»˜è®¤:{'é»˜è®¤.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E7%AD%89%E5%BE%85%E5%90%BB.png','æƒŠè®¶.png':'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%A7%92%E8%89%B2/%E6%B0%B4%E6%89%8B%E6%9C%8D/%E5%93%AD%E6%B3%A3.png'}}},this.initEventListeners(),this.initializeBackground(),this.showDialog(0)}initializeBackground(){if(this.dialogData&&this.dialogData.length>0&&this.dialogData[0].background){const t=this.dialogData[0].background,o=this.getFullImageUrl(t);if(console.log('åˆå§‹åŒ–èƒŒæ™¯å›¾ç‰‡:',o),!this.currentImage)return void console.error('èƒŒæ™¯å›¾ç‰‡å…ƒç´ ä¸å­˜åœ¨!');this.currentBgPath=t,this.currentImage.src=o,this.currentImage.style.opacity='1',this.currentImage.onerror=()=>{console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:',o),this.currentImage.src='https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%95%86%E5%BA%97%E8%A1%97/%E9%BB%84%E6%98%8F.jpg'},this.currentImage.complete?console.log('èƒŒæ™¯å›¾ç‰‡å·²åŠ è½½å®Œæˆ'):this.currentImage.onload=()=>{console.log('èƒŒæ™¯å›¾ç‰‡åŠ è½½å®Œæˆ')}}}getFullImageUrl(t){if(!t)return'';if('å•†åº—è¡—/é»„æ˜.jpg'===t)return'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%95%86%E5%BA%97%E8%A1%97/%E9%BB%84%E6%98%8F.jpg';if('å•†åº—è¡—/å¤œæ™šå¼€ç¯.jpg'===t)return'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E8%83%8C%E6%99%AF/%E5%95%86%E5%BA%97%E8%A1%97/%E5%A4%9C%E6%99%9A%E5%BC%80%E7%81%AF.jpg';try{const o=t.split('/'),e=o.map(t=>encodeURIComponent(t)).join('/');return this.imageBaseUrl+e}catch(o){return console.error('URLç¼–ç å¤±è´¥:',o,'åŸå§‹è·¯å¾„:',t),''}}initEventListeners(){document.addEventListener('click',()=>{this.nextDialog()}),document.addEventListener('keydown',t=>{'Space'===t.code&&(t.preventDefault(),this.nextDialog())})}showDialog(t){if(t>=this.dialogData.length)return console.log('å¯¹è¯ç»“æŸï¼Œé‡æ–°å¼€å§‹'),this.currentIndex=0,void this.showDialog(0);this.currentIndex=t;const o=this.dialogData[t];if(!o)return void console.error('å¯¹è¯æ•°æ®ä¸å­˜åœ¨:',t);const e=o.background||'',a=e&&this.currentBgPath!==e;if(console.log(`æ˜¾ç¤ºå¯¹è¯ #${t}`,o.name,'å½“å‰èƒŒæ™¯:',this.currentBgPath||'(æ— )','æ–°èƒŒæ™¯:',e||'(æ— )','éœ€è¦è½¬åœº:',a),a){if(console.log('æ‰§è¡ŒèƒŒæ™¯è½¬åœº - ä»',this.currentBgPath||'(æ— )','åˆ°',e),'narrator'===o.characters||'protagonist'===o.characters||!o.characters){for(const t in this.activeCharacters)this.hideCharacter(t);this.activeCharacters={}}this.currentBgPath=e,this.fadeOutIn(()=>e,o)}else this.updateDialogContent(o)}updateDialogContent(t){t?(console.log('æ›´æ–°å¯¹è¯å†…å®¹:',t.name,t.text),this.updateCharacters(t),this.characterName.textContent=t.name,this.applyTypingEffect(t.text),this.addToHistory(t)):console.error('æ›´æ–°å¯¹è¯å†…å®¹å¤±è´¥: å¯¹è¯æ•°æ®ä¸ºç©º')}applyTypingEffect(t){this.isAnimating=!0,this.dialogText.textContent='',document.getElementById('next-hint').style.opacity='0';const o=Math.max(.5,Math.min(1.5,300/t.length)),e=Math.floor(30*o);let a=0;const l=()=>{if(a<t.length&&this.isAnimating){const o=t.charAt(a);this.dialogText.textContent+=o,a++,setTimeout(l,e)}else this.isAnimating=!1,document.getElementById('next-hint').style.opacity='1'};l()}updateCharacters(t){if(this.isTransitioning)return void console.log('æ­£åœ¨è½¬åœºä¸­ï¼Œå»¶è¿Ÿæ›´æ–°è§’è‰²æ˜¾ç¤º');const o={};if(document.body.classList.remove('narrator-mode','protagonist-mode'),t.characters)if('narrator'!==t.characters)if('protagonist'!==t.characters){if('object'!=typeof t.characters||!t.characters.id||t.characters.left||t.characters.right){if('object'==typeof t.characters){const e=!!t.characters.left,a=!!t.characters.right;if(e&&!a){const e=t.characters.left.id,a=t.characters.left.expression||'é»˜è®¤.png',l=t.characters.left.costume||'æ°´æ‰‹æœ';o[e]={position:'center',expression:a,costume:l},this.showCharacter(e,'center',t.name===e,a,l)}else if(!e&&a){const e=t.characters.right.id,a=t.characters.right.expression||'é»˜è®¤.png',l=t.characters.right.costume||'æ°´æ‰‹æœ';o[e]={position:'center',expression:a,costume:l},this.showCharacter(e,'center',t.name===e,a,l)}else{if(t.characters.left&&t.characters.left.id){const e=t.characters.left.id,a=t.characters.left.expression||'é»˜è®¤.png',l=t.characters.left.costume||'æ°´æ‰‹æœ';o[e]={position:'left',expression:a,costume:l},this.showCharacter(e,'left',t.name===e,a,l)}if(t.characters.right&&t.characters.right.id){const e=t.characters.right.id,a=t.characters.right.expression||'é»˜è®¤.png',l=t.characters.right.costume||'æ°´æ‰‹æœ';o[e]={position:'right',expression:a,costume:l},this.showCharacter(e,'right',t.name===e,a,l)}}}}else{const e=t.characters.id,a=t.characters.expression||'é»˜è®¤.png',l=t.characters.costume||'æ°´æ‰‹æœ';o[e]={position:'center',expression:a,costume:l},this.showCharacter(e,'center',t.name===e,a,l)}for(const t in this.activeCharacters)o[t]||this.hideCharacter(t);this.activeCharacters=o}else{document.body.classList.add('protagonist-mode');for(const t in this.activeCharacters)this.hideCharacter(t);this.activeCharacters={}}else{document.body.classList.add('narrator-mode');for(const t in this.activeCharacters)this.hideCharacter(t);this.activeCharacters={}}else{for(const t in this.activeCharacters)this.hideCharacter(t);this.activeCharacters={}}}showCharacter(t,o,e,a='é»˜è®¤',l='æ°´æ‰‹æœ'){if(this.isTransitioning)return void console.log('æ­£åœ¨è½¬åœºä¸­ï¼Œè·³è¿‡æ˜¾ç¤ºè§’è‰²:',t);if(!this.characterSprites[t])return;const s=this.characterSprites[t];let i=l;s[i]||(i=Object.keys(s)[0]);const r=s[i];let n=a;r[n]||(n=Object.keys(r)[0]||'é»˜è®¤.png');const g=r[n];if(!g)return;const c=`character-${t}`,d=this.activeCharacters[t]?.position;let h=document.getElementById(c);h?(h.dataset.expression!==n&&(h.src=g,h.dataset.expression=n),h.dataset.position!==o&&setTimeout(()=>{this.isTransitioning||(h.classList.remove(`character-${h.dataset.position}`),h.classList.add(`character-${o}`),h.dataset.position=o,this.applyPositionStyle(h,o))},50)):(h=document.createElement('img'),h.id=c,h.className='character-sprite character-enter',h.src=g,h.dataset.expression=n,h.dataset.position=o,h.alt=`${t}çš„ç«‹ç»˜`,d&&d!==o?h.classList.add(`character-${d}`):h.classList.add(`character-${o}`),this.characterContainer.appendChild(h),setTimeout(()=>{this.isTransitioning?h&&h.parentNode&&h.parentNode.removeChild(h):(h.classList.remove('character-enter'),h.classList.add('character-active'),d&&d!==o&&setTimeout(()=>{h.classList.remove(`character-${d}`),h.classList.add(`character-${o}`),h.dataset.position=o},50),this.applyPositionStyle(h,o))},50)),e?(h.classList.add('character-speaking'),h.classList.remove('character-dimmed'),h.style.opacity='1',h.style.zIndex='10'):(h.classList.remove('character-speaking'),h.classList.add('character-dimmed'),h.style.opacity='1',h.style.zIndex='5')}applyPositionStyle(t,o){'center'===o?(t.style.left='50%',t.style.right='auto',t.style.transform='translateX(-50%)',t.style.bottom='0',t.style.height='98%',t.style.maxHeight='98%'):'left'===o?(t.style.left='30%',t.style.right='auto',t.style.transform='translateX(-50%)',t.style.bottom='0',t.style.height='95%',t.style.maxHeight='95%'):'right'===o&&(t.style.right='30%',t.style.left='auto',t.style.transform='translateX(50%)',t.style.bottom='0',t.style.height='95%',t.style.maxHeight='95%')}hideCharacter(t){const o=document.getElementById(`character-${t}`);if(o){if(o.classList.contains('character-exit'))return;o.classList.add('character-exit'),o.classList.remove('character-active','character-speaking'),setTimeout(()=>{o&&o.parentNode&&o.parentNode.removeChild(o)},800)}}nextDialog(){if(this.isAnimating){this.isAnimating=!1;const t=this.dialogData[this.currentIndex];return this.dialogText.textContent=t.text,void(document.getElementById('next-hint').style.opacity='1')}if(this.currentIndex++,this.currentIndex>=this.dialogData.length){console.log('å¯¹è¯å·²å…¨éƒ¨æ’­æ”¾å®Œæ¯•ã€‚'),this.currentIndex=this.dialogData.length-1;const t=document.getElementById('next-hint');t&&(t.style.display='none');const o=document.getElementById('restart-btn');return void(o&&(o.style.display='block'))}this.showDialog(this.currentIndex)}restartDialog(){console.log('é‡æ–°å¼€å§‹å¯¹è¯æ’­æ”¾'),this.currentIndex=0;for(const t in this.activeCharacters)this.hideCharacter(t);if(this.activeCharacters={},this.dialogData&&this.dialogData.length>0&&this.dialogData[0].background){this.currentBgPath=this.dialogData[0].background;const t=this.getFullImageUrl(this.currentBgPath);this.currentImage.src=t}const t=document.getElementById('next-hint');t&&(t.style.display='block',t.style.opacity='1');const o=document.getElementById('restart-btn');o&&(o.style.display='none'),this.showDialog(0)}fadeOutIn(t,o){if(this.isTransitioning)return void console.log('å·²åœ¨è½¬åœºä¸­ï¼Œå¿½ç•¥æ–°çš„è½¬åœºè¯·æ±‚');this.isTransitioning=!0,console.log('å¼€å§‹èƒŒæ™¯è½¬åœº');const e=t();if(!e)return console.log('èƒŒæ™¯è·¯å¾„ä¸ºç©ºï¼Œè·³è¿‡è½¬åœº'),this.isTransitioning=!1,void(o&&this.updateDialogContent(o));let a=this.getFullImageUrl(e);if(console.log('åˆ‡æ¢èƒŒæ™¯å›¾ç‰‡:',e,'->',a),!a||a===this.currentImage.src)return console.log('è·³è¿‡èƒŒæ™¯è½¬åœº: URLä¸ºç©ºæˆ–ç›¸åŒ'),this.isTransitioning=!1,void(o&&this.updateDialogContent(o));const l=()=>{console.log('æ‰§è¡ŒèƒŒæ™¯è½¬åœºåŠ¨ç”»'),document.body.classList.add('transitioning'),this.nextImage.style.opacity='1',setTimeout(()=>{this.currentImage.src=this.nextImage.src,console.log('èƒŒæ™¯è½¬åœºå®Œæˆï¼Œå½“å‰èƒŒæ™¯:',this.currentImage.src),this.nextImage.style.opacity='0',document.body.classList.remove('transitioning'),this.isTransitioning=!1,o&&(console.log('è½¬åœºå®Œæˆï¼Œæ›´æ–°å¯¹è¯å†…å®¹:',o.name),setTimeout(()=>{this.updateDialogContent(o)},50))},1200)};this.nextImage.src=a,this.nextImage.onerror=()=>{console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:',a),this.isTransitioning=!1,o&&this.updateDialogContent(o)},this.nextImage.onload=()=>{console.log('èƒŒæ™¯å›¾ç‰‡åŠ è½½å®Œæˆ'),l()}}addToHistory(t){this.dialogHistory.some(o=>o.name===t.name&&o.text===t.text)||(this.dialogHistory.push({name:t.name,text:t.text,background:t.background||''}),this.updateHistoryPanel())}updateHistoryPanel(){if(this.historyContent.innerHTML='',0===this.dialogHistory.length){const t=document.createElement('div');return t.textContent='æš‚æ— å¯¹è¯å†å²',t.style.textAlign='center',t.style.color='#7D5B65',t.style.padding='20px',void this.historyContent.appendChild(t)}this.dialogHistory.forEach((t,o)=>{const e=document.createElement('div');if(e.className='history-item',e.style.marginBottom='15px',e.style.padding='15px',e.style.borderRadius='12px',e.style.background='rgba(255, 255, 255, 0.5)',e.style.boxShadow='0 2px 8px rgba(0,0,0,0.05), 0 0 0 1px rgba(255,255,255,0.7) inset',e.style.transition='transform 0.2s ease, box-shadow 0.2s ease',e.onmouseover=function(){this.style.transform='translateY(-2px)',this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08), 0 0 0 1px rgba(255,255,255,0.8) inset'},e.onmouseout=function(){this.style.transform='none',this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05), 0 0 0 1px rgba(255,255,255,0.7) inset'},t.name&&'æ—ç™½'!==t.name){const o=document.createElement('div');o.className='history-name',o.textContent=t.name,o.style.fontWeight='bold',o.style.color='#C18E98',o.style.marginBottom='8px',o.style.position='relative',o.style.paddingLeft='15px';const a=document.createElement('span');a.textContent='â€',a.style.position='absolute',a.style.left='0',a.style.top='50%',a.style.transform='translateY(-50%)',a.style.color='#FFB0C0',a.style.fontSize='12px',o.appendChild(a),e.appendChild(o)}else'æ—ç™½'===t.name&&(e.style.fontStyle='italic',e.style.background='rgba(245, 235, 235, 0.7)',e.style.borderLeft='3px solid #FFCAD5');const a=document.createElement('div');a.className='history-text',a.textContent=t.text,a.style.color='#4D2B35',a.style.lineHeight='1.5',a.style.letterSpacing='0.3px',e.appendChild(a),this.historyContent.appendChild(e)}),setTimeout(()=>{this.historyContent.scrollTop=this.historyContent.scrollHeight},100)}toggleHistoryPanel(t){t?(this.updateHistoryPanel(),this.historyPanel.style.display='block',this.historyPanel.style.opacity='0',this.historyPanel.style.transition='opacity 0.3s ease',setTimeout(()=>{this.historyPanel.style.opacity='1'},10)):(this.historyPanel.style.opacity='0',setTimeout(()=>{this.historyPanel.style.display='none'},300))}}$(()=>{const t=new GalgameEngine;!function(){const o=document.getElementById('toggle-ui-btn');o&&(o.addEventListener('click',function(e){if(e.stopPropagation(),document.body.classList.toggle('ui-hidden'),document.body.classList.contains('ui-hidden')){o.textContent='ğŸ’¬',o.title='æ˜¾ç¤ºç•Œé¢';document.querySelectorAll('.character-sprite').forEach(t=>{t.classList.remove('character-speaking','character-dimmed')})}else o.textContent='ğŸ’­',o.title='éšè—ç•Œé¢',t.updateCharacters(t.dialogData[t.currentIndex])}),o.textContent='ğŸ’­',o.title='éšè—ç•Œé¢')}();const o=document.getElementById('history-btn'),e=document.getElementById('close-history');o&&e&&(o.addEventListener('click',function(o){o.stopPropagation(),t.toggleHistoryPanel(!0)}),e.addEventListener('click',function(o){o.stopPropagation(),t.toggleHistoryPanel(!1)}),document.getElementById('history-panel').addEventListener('click',function(t){t.stopPropagation()}),document.addEventListener('keydown',function(o){'Escape'===o.key&&'block'===t.historyPanel.style.display&&t.toggleHistoryPanel(!1)}));const a=document.getElementById('restart-btn');a&&(a.addEventListener('click',function(o){o.stopPropagation(),t.restartDialog()}),a.title='é‡æ–°å¼€å§‹')});