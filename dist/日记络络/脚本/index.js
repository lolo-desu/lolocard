import'https://testingcf.jsdelivr.net/gh/MagicalAstrogy/MagVarUpdate@master/artifact/bundle.js';async function e(){const e={æ™¨é—´:'å…ˆæå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å¿«é€Ÿå°†æ—¶é—´è°ƒæ•´åˆ°ä¸‹ä¸ªæ™¨é—´\n<UpdateVariable>\n_.set(\'ä¸–ç•Œ.å½“å‰æ—¶é—´é˜¶æ®µ\', 1);\n</UpdateVariable>',è¯¾ä¸Š:'å…ˆæå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å¿«é€Ÿå°†æ—¶é—´è°ƒæ•´åˆ°ä¸‹ä¸ªè¯¾ä¸Š\n<UpdateVariable>\n_.set(\'ä¸–ç•Œ.å½“å‰æ—¶é—´é˜¶æ®µ\', 18);\n</UpdateVariable>',åˆä¼‘:'å…ˆæå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å¿«é€Ÿå°†æ—¶é—´è°ƒæ•´åˆ°ä¸‹ä¸ªåˆä¼‘\n<UpdateVariable>\n_.set(\'ä¸–ç•Œ.å½“å‰æ—¶é—´é˜¶æ®µ\', 32);\n</UpdateVariable>',æ”¾å­¦å:'å…ˆæå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å¿«é€Ÿå°†æ—¶é—´è°ƒæ•´åˆ°ä¸‹ä¸ªæ”¾å­¦å\n<UpdateVariable>\n_.set(\'ä¸–ç•Œ.å½“å‰æ—¶é—´é˜¶æ®µ\', 49);\n</UpdateVariable>',å¤œé—´:'å…ˆæå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å¿«é€Ÿå°†æ—¶é—´è°ƒæ•´åˆ°ä¸‹ä¸ªå¤œé—´\n<UpdateVariable>\n_.set(\'ä¸–ç•Œ.å½“å‰æ—¶é—´é˜¶æ®µ\', 66);\n</UpdateVariable>',å‡æ—¥:'å…ˆæå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å¿«é€Ÿå°†æ—¶é—´è°ƒæ•´åˆ°ä¸‹ä¸ªå‡æ—¥\n<UpdateVariable>\n_.set(\'ä¸–ç•Œ.å½“å‰æ—¶é—´é˜¶æ®µ\', 83);\n</UpdateVariable>',ç¬¬äºŒå¤©:'å…ˆæå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å¿«é€Ÿå°†æ—¶é—´è°ƒæ•´åˆ°ç¬¬äºŒå¤©ï¼Œå¹¶è°ƒæ•´å½“å‰æ—¶é—´é˜¶æ®µå˜é‡åˆ°æ¥ä¸‹æ¥æ•…äº‹æƒ…èŠ‚æœ€æœ‰æ„ä¹‰çš„æ—¶é—´ï¼Œä¸‹ä¸€æ¬¡å“åº”çš„æ—¶é—´é˜¶æ®µå˜é‡è°ƒæ•´æ²¡æœ‰ä»»ä½•é™åˆ¶\n<UpdateVariable>\n_.set(\'ä¸–ç•Œ.å½“å‰æ—¶é—´é˜¶æ®µ\', 1);\n</UpdateVariable>'},t=await triggerSlash(`/buttons labels=${JSON.stringify(Object.keys(e))} æ—¶é—´æ¥åˆ°äº†...`);_.has(e,t)&&await triggerSlash(`/send ${e[t]} || /trigger`)}async function t(){const e={ä½å®…:{æ—ç™½:'å›å®¶ï¼',åœ°ç‚¹:['ä½æ‰€ç„å…³','ä½æ‰€å®¢å…','æˆ¿é—´']},å­¦æ ¡:{æ—ç™½:'å»å­¦æ ¡å—...',åœ°ç‚¹:['ä¸Šå­¦è·¯ä¸Š','å­¦æ ¡æ•™å­¦æ¥¼æ­£é—¨å‰','æ•™å®¤','å­¦æ ¡ä¸­åº­','å­¦æ ¡å¤–ä¾§æ¥¼æ¢¯','å­¦æ ¡å±‹é¡¶']},åŸé•‡ä¸è¡—é“:{æ—ç™½:'å»é€›é€›å‘¢...',åœ°ç‚¹:['åŸé•‡è¡—é“ä¸Š','ä½å®…è¡—','å•†åº—è¡—','æ‹±å»Šå•†åº—è¡—','ç¹åå•†ä¸šè¡—','åŸå¸‚ä¸­çš„é“è·¯é“å£']},å•†ä¸šè®¾æ–½:{æ—ç™½:'å»çº¦ä¼šå—w...',åœ°ç‚¹:['ä¾¿åˆ©åº—å†…','ä¹¦åº—å†…','å’–å•¡å…','å®¶åº­é¤å…','è´­ç‰©ä¸­å¿ƒ','è´­ç‰©ä¸­å¿ƒäºŒå±‚','ç¾æœ¯é¦†','åœ°é“ç«™å†…','åœ°é“å†…','åº™ä¼šå°åƒè¡—']},æˆ·å¤–:{æ—ç™½:'é”»ç‚¼èº«ä½“...?',åœ°ç‚¹:['å…¬å›­','å…¬å›­å‡‰äº­','å…¬å›­å•†åº—äº­','æ²³æ—','æµ·æ»©']}},t=await triggerSlash(`/buttons labels=${JSON.stringify(Object.keys(e))} {{user}}å°†åŠ¨èº«å‰å¾€...`);if(!_.has(e,t))return;const{æ—ç™½:a,åœ°ç‚¹:n}=e[t],o=await triggerSlash(`/buttons labels=${JSON.stringify(n)} <small>${a}<small>`);n.includes(o)&&triggerSlash(`/send \x3c!--äºæœ¬æ¬¡å“åº”éœ€è¦æå†™ç»“æŸå½“å‰åœºæ™¯çš„å‰§æƒ…å†å†™å‡ºç†ç”±å‰å¾€ä¸‹ä¸€ä¸ªåœ°ç‚¹--\x3e[ç§»åŠ¨] {{user}}å‰å¾€äº†${o}\n<UpdateVariable>\n_.set('ä¸–ç•Œ.ä¸‹æ¬¡å“åº”ç•Œé¢é€‰æ‹©åˆ¤æ–­', 0);\n</UpdateVariable> || /trigger`)}function a(){console.log('ğŸ“Šè®¡æ•°'),triggerSlash('/ejs ä¸Šæ¬¡å‘é€äº†ï¼š<%- variables.LAST_SEND_TOKENS %> è¯ç¬¦(tokens), å…±è®¡ <%- variables.LAST_SEND_CHARS %> å­—ç¬¦ã€‚<br/>æ”¶åˆ°çš„æ¶ˆæ¯å¤„ç†åï¼š<%- variables.LAST_RECEIVE_TOKENS %> è¯ç¬¦(tokens), å…±è®¡ <%- variables.LAST_RECEIVE_CHARS %> å­—ç¬¦ã€‚ | /popup <h4>æç¤ºè¯è®¡æ•°</h4><br>{{pipe}}')}$(()=>{!async function(){const e='çº¯ç™½è‰²çš„å›å“';JSON.parse(await triggerSlash('/qr-set-list')).includes(e)&&triggerSlash(`/qr-set-delete ${e}`)}(),eventOnButton('ğŸ•›åº¦è¿‡',e),eventOnButton('ğŸ—ºï¸åœ°ç‚¹',t),eventOnButton('ğŸ“Šè®¡æ•°',a)}),$(()=>{!async function(){const e={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},t=getLorebookSettings();_.isEqual(_.merge({},t,e),t)||setLorebookSettings(e)}()}),$(()=>{EjsTemplate.setFeatures({enabled:!0,generate_enabled:!0,generate_loader_enabled:!1,render_enabled:!1,render_loader_enabled:!1,code_blocks_enabled:!1,raw_message_evaluation_enabled:!1,filter_message_enabled:!1,world_active_enabled:!1,autosave_enabled:!1,preload_worldinfo_enabled:!1,debug_enabled:!1,cache_enabled:!0})});async function n(e,t){const a=getVariables({type:'message',message_id:t});_.set(a,substitudeMacros('stat_data.<user>.æ€§åˆ«'),e),await replaceVariables(a,{type:'message',message_id:t})}$(async()=>{eventOn(tavern_events.MESSAGE_SENT,async e=>{if(1===e){const e=await async function(){const e=(await getLorebookEntries('ä¸Šé”çš„æ—¥è®°æœ¬')).filter(e=>e.comment.startsWith('æ€§åˆ«è®¾ç½®-')&&e.enabled).map(e=>e.comment.replace('æ€§åˆ«è®¾ç½®-',''));return 0===e.length?'ç”·':e[0]}();await n(e,0),await n(e,1)}})});const o='ä¸Šé”çš„æ—¥è®°æœ¬',r=/<roleplay_options>\s*(?:```.*\n)?([\s\S]*?)(?:\n```)?\s*<\/roleplay_options>/im;var i,s;async function l(e){const t=getChatMessages(e)[0].message.match(r);if(!t)return;const a=s.extract_options_element(t[1]),n=retrieveDisplayedMessage(e),o=n.find('.roleplay_options, pre:contains("<roleplay_options>")');o.length>0&&(o.remove(),n.append(a))}async function p(){$('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').each((e,t)=>{l(Number(t.getAttribute('mesid')))})}!function(e){const t={input_mode:'ç›´æ¥å‘é€'};e.update=async function(){const a=e.option;return e.option=await async function(){const e=_.merge({},...(await getLorebookEntries(o)).filter(e=>e.comment.startsWith('é€‰æ‹©æ¡†è®¾ç½®-')&&e.enabled).map(e=>{const t=e.comment.replace('é€‰æ‹©æ¡†è®¾ç½®-','');return{[t]:e.content}})),a=t;return _.has(e,'ç›´æ¥å‘é€')?a.input_mode='ç›´æ¥å‘é€':_.has(e,'è¦†ç›–è¾“å…¥')?a.input_mode='è¦†ç›–è¾“å…¥':_.has(e,'å°¾é™„è¾“å…¥')&&(a.input_mode='å°¾é™„è¾“å…¥'),a}(),!_.isEqual(e.option,a)}}(i||(i={})),function(e){let t;e.update=async function(){const e=t;return t=await async function(){const e=(await getLorebookEntries(o)).filter(e=>e.comment.startsWith('é€‰æ‹©æ¡†æ ·å¼-')&&e.enabled);return 0===e.length?'<style>*{-webkit-tap-highlight-color:transparent}.roleplay_options_hr{display:none}.roleplay_options_back{background:#fff0f3;border-radius:16px;box-shadow:0 8px 20px rgba(145,125,138,0.15);padding:22px 24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;border:1px solid #ffe5ea;width:90%;max-width:740px;margin:24px auto}.roleplay_options_item{position:relative;background:#fffafb;border-radius:12px;box-shadow:0 5px 15px rgba(145,125,138,0.1);padding:18px 20px;cursor:default;border:1px solid #ffe5ea;transition:all .28s cubic-bezier(0.22,1,0.36,1);overflow:hidden;display:flex;flex-direction:column;z-index:1;margin:0;color:#7d6b6e;font-weight:400;line-height:1.6;height:100%;font-family:"Microsoft YaHei",Arial,sans-serif}.last_mes .roleplay_options_item{cursor:pointer}.last_mes .roleplay_options_item::after{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(140deg,transparent 0%,transparent 50%,rgba(255,204,214,0.15) 150%);opacity:0;transition:opacity .35s ease;z-index:-1}.last_mes .roleplay_options_item:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(145,125,138,0.2);background:#fff5f7;border-color:rgba(255,204,214,0.3)}.last_mes .roleplay_options_item:hover::after{opacity:1}.last_mes .roleplay_options_item:hover .roleplay_options_content{color:#635759}.last_mes .roleplay_options_item:active{transform:translateY(-2px);box-shadow:0 4px 12px rgba(145,125,138,0.1)}.roleplay_options_item:before{content:"";position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,#ffd0d8,#ffbbc8);transform:scaleX(0);transform-origin:0 0;transition:transform .35s cubic-bezier(0.4,0,0.2,1)}.last_mes .roleplay_options_item:hover:before{transform:scaleX(1)}.roleplay_options_title{font-size:.95em;font-weight:600;color:#7d6b6e;margin-bottom:12px;letter-spacing:.04em;text-align:left;padding-bottom:10px;border-bottom:1px solid rgba(200,200,200,0.3);text-shadow:0 1px 1px rgba(255,255,255,0.5);line-height:1.4;position:relative;display:flex;align-items:center}.roleplay_options_title::before{content:"";display:inline-block;width:6px;height:6px;background:#ffd0d8;border-radius:50%;margin-right:10px;box-shadow:0 0 0 2px rgba(255,204,214,0.2)}.roleplay_options_content{font-size:.95em;line-height:1.65;color:#8e7478;font-weight:normal;transition:color .25s ease;text-align:left;flex:1;text-shadow:0 1px 1px rgba(255,255,255,0.5);letter-spacing:.018em}.roleplay_options_item.selected{background:rgba(255,235,240,0.7);border-color:rgba(255,204,214,0.5)}.roleplay_options_item.selected:before{background:linear-gradient(90deg,#ffd0d8,#ffbbc8);transform:scaleX(1)}.roleplay_options_item.selected .roleplay_options_title::before{background:#ffd0d8;box-shadow:0 0 0 2px rgba(255,204,214,0.3)}@media (max-width:999px){.roleplay_options_back{padding:18px;gap:14px;grid-template-columns:1fr;width:100%;max-width:none;margin:24px 0;background:#fff0f3;border:1px solid #ffe5ea}.roleplay_options_item{padding:16px;background:#fffafb;border:1px solid #ffe5ea}.roleplay_options_title{font-size:.9em;padding-bottom:8px;margin-bottom:10px}.roleplay_options_content{font-size:.92em;line-height:1.6}}@media (prefers-reduced-motion:reduce){.roleplay_options_item,.roleplay_options_item::before,.roleplay_options_item::after,.roleplay_options_content,.roleplay_options_title{transition:none}}</style>':e[0].content}(),!_.isEqual(t,e)},e.extract_options_element=function(e){const a=$('<div class="roleplay_options">');return a.append(t),a.append($('<div class="roleplay_options_back">').append([...e.matchAll(/(.+?)[:ï¼š]\s*(.+)/gm)].map(e=>({title:e[1],content:e[2].replace(/^\$\{(.+)\}$/,'$1').replace(/^ã€Œ(.+)ã€$/,'$1')})).map(({title:e,content:t})=>$('<div class="roleplay_options_item" tabindex="1">').on('click',function(){!async function(e){if(e.parents('.last_mes').length>0){const t=e.find('.roleplay_options_content').text().trim();if('ç›´æ¥å‘é€'===i.option.input_mode)triggerSlash(`/send ${t} || /trigger`);else if('è¦†ç›–è¾“å…¥'===i.option.input_mode)triggerSlash(`/setinput ${t}`);else if('å°¾é™„è¾“å…¥'===i.option.input_mode){const e=$('#send_textarea').val();$('#send_textarea').val([e,t].join('\n')||'')[0].dispatchEvent(new Event('input',{bubbles:!0}))}}}($(this))}).append(`<span class="roleplay_options_title"><strong>${e}</strong></span>`).append('<hr class="roleplay_options_hr">').append(`<span class="roleplay_options_content">${t}</span>`)))),a}}(s||(s={})),$(async()=>{await errorCatched(i.update)(),await errorCatched(s.update)(),await p(),eventOn(tavern_events.CHAT_CHANGED,errorCatched(p)),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,errorCatched(l)),eventOn(tavern_events.MESSAGE_UPDATED,errorCatched(l)),eventOn(tavern_events.MESSAGE_SWIPED,errorCatched(l)),eventOn(tavern_events.MESSAGE_DELETED,()=>setTimeout(errorCatched(p),1e3)),eventOn(tavern_events.WORLDINFO_UPDATED,errorCatched(async e=>{e===o&&(await i.update()||await s.update())&&await p()}))}),$(()=>{const e=function(e){return $('<style>').attr('id',`script_custom_style-${getScriptId()}`).text(e)}(_.get(getVariables({type:'script',script_id:getScriptId()}),'æ ·å¼åŠ è½½',''));!function(e){const t=$('head');t.find(`#script_custom_style-${getScriptId()}`).remove(),t.append(e)}(e)}),$(()=>{const e=function(e){return $('<div>').attr('id',`script_preload-${getScriptId()}`).append(e.map(e=>$('<link>').attr('rel','preload').attr('href',e).attr('as','image')))}(_.get(getVariables({type:'script',script_id:getScriptId()}),'èµ„æºé¢„è½½',[]));!function(e){const t=$('head');t.find(`#script_preload-${getScriptId()}`).remove(),t.append(e)}(e)}),$(()=>{setTimeout(async()=>{const e=Object.entries(_.get(getVariables({type:'script',script_id:getScriptId()}),'è‡ªåŠ¨å®‰è£…æ’ä»¶',{})).map(([e,t])=>{let a=t.replace(/(\.git|\/)$/,'');return a=a.substring(a.lastIndexOf('/')+1),{[a]:{name:e,url:t}}}).reduce((e,t)=>_.defaults(e,t),{}),t=await async function(){try{const e=await fetch('/api/extensions/discover');return e.ok?(await e.json()).filter(e=>'system'!==e.type).map(e=>e.name.replace('third-party/','')):[]}catch(e){return console.error(e),[]}}(),a=_.difference(Object.keys(e),t);0!==a.length&&await SillyTavern.callGenericPopup('ä»¥ä¸‹éœ€è¦çš„æ’ä»¶å°šæœªå®‰è£…, æ˜¯å¦å®‰è£…?<br>'+a.map(t=>`- ${e[t].name}`).join('<br>'),SillyTavern.POPUP_TYPE.CONFIRM,'',{leftAlign:!0})&&(await Promise.allSettled(a.map(t=>async function(e){const t=await fetch('/api/extensions/install',{method:'POST',headers:SillyTavern.getRequestHeaders(),body:JSON.stringify({url:e})});if(!t.ok){const e=await t.text();return toastr.warning(`${e||t.statusText}`,'æ‰©å±•å®‰è£…å¤±è´¥'),console.error('æ‰©å±•å®‰è£…å¤±è´¥',t.status,t.statusText,e),!1}const a=await t.json();return toastr.success(`å·²æˆåŠŸå®‰è£…ç”± '${a.author}' ç¼–å†™çš„ '${a.display_name}' (ç‰ˆæœ¬ ${a.version})!`,'æ‰©å±•å®‰è£…æˆåŠŸ'),console.debug(`å·²æˆåŠŸå°† '${a.display_name}' å®‰è£…åˆ° ${a.extensionPath}`),!0}(e[t].url))),setTimeout(()=>triggerSlash('/reload-page'),3e3))},1e4)});const c=_.debounce(function(){const e=2e6,t=SillyTavern.chatCompletionSettings;!0===t.max_context_unlocked&&t.openai_max_context===e||($('#oai_max_context_unlocked').prop('checked',!0).trigger('input'),$('#openai_max_context_counter').val(e),$('#openai_max_context').val(e).trigger('input'))},1e3);$(()=>{eventOn(tavern_events.SETTINGS_UPDATED,c)});