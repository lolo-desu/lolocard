import'https://testingcf.jsdelivr.net/gh/MagicalAstrogy/MagVarUpdate@master/artifact/bundle.js';async function e(){const e={晨间:'先描写结束当前场景的剧情再快速将时间调整到下个晨间\n<UpdateVariable>\n_.set(\'世界.当前时间阶段\', 1);\n</UpdateVariable>',课上:'先描写结束当前场景的剧情再快速将时间调整到下个课上\n<UpdateVariable>\n_.set(\'世界.当前时间阶段\', 18);\n</UpdateVariable>',午休:'先描写结束当前场景的剧情再快速将时间调整到下个午休\n<UpdateVariable>\n_.set(\'世界.当前时间阶段\', 32);\n</UpdateVariable>',放学后:'先描写结束当前场景的剧情再快速将时间调整到下个放学后\n<UpdateVariable>\n_.set(\'世界.当前时间阶段\', 49);\n</UpdateVariable>',夜间:'先描写结束当前场景的剧情再快速将时间调整到下个夜间\n<UpdateVariable>\n_.set(\'世界.当前时间阶段\', 66);\n</UpdateVariable>',假日:'先描写结束当前场景的剧情再快速将时间调整到下个假日\n<UpdateVariable>\n_.set(\'世界.当前时间阶段\', 83);\n</UpdateVariable>',第二天:'先描写结束当前场景的剧情再快速将时间调整到第二天，并调整当前时间阶段变量到接下来故事情节最有意义的时间，下一次响应的时间阶段变量调整没有任何限制\n<UpdateVariable>\n_.set(\'世界.当前时间阶段\', 1);\n</UpdateVariable>'},t=await triggerSlash(`/buttons labels=${JSON.stringify(Object.keys(e))} 时间来到了...`);_.has(e,t)&&await triggerSlash(`/send ${e[t]} || /trigger`)}async function t(){const e={住宅:{旁白:'回家！',地点:['住所玄关','住所客厅','房间']},学校:{旁白:'去学校吗...',地点:['上学路上','学校教学楼正门前','教室','学校中庭','学校外侧楼梯','学校屋顶']},城镇与街道:{旁白:'去逛逛呢...',地点:['城镇街道上','住宅街','商店街','拱廊商店街','繁华商业街','城市中的铁路道口']},商业设施:{旁白:'去约会吗w...',地点:['便利店内','书店内','咖啡厅','家庭餐厅','购物中心','购物中心二层','美术馆','地铁站内','地铁内','庙会小吃街']},户外:{旁白:'锻炼身体...?',地点:['公园','公园凉亭','公园商店亭','河旁','海滩']}},t=await triggerSlash(`/buttons labels=${JSON.stringify(Object.keys(e))} {{user}}将动身前往...`);if(!_.has(e,t))return;const{旁白:a,地点:n}=e[t],o=await triggerSlash(`/buttons labels=${JSON.stringify(n)} <small>${a}<small>`);n.includes(o)&&triggerSlash(`/send \x3c!--于本次响应需要描写结束当前场景的剧情再写出理由前往下一个地点--\x3e[移动] {{user}}前往了${o}\n<UpdateVariable>\n_.set('世界.下次响应界面选择判断', 0);\n</UpdateVariable> || /trigger`)}function a(){console.log('📊计数'),triggerSlash('/ejs 上次发送了：<%- variables.LAST_SEND_TOKENS %> 词符(tokens), 共计 <%- variables.LAST_SEND_CHARS %> 字符。<br/>收到的消息处理后：<%- variables.LAST_RECEIVE_TOKENS %> 词符(tokens), 共计 <%- variables.LAST_RECEIVE_CHARS %> 字符。 | /popup <h4>提示词计数</h4><br>{{pipe}}')}$(()=>{!async function(){const e='纯白色的回响';JSON.parse(await triggerSlash('/qr-set-list')).includes(e)&&triggerSlash(`/qr-set-delete ${e}`)}(),eventOnButton('🕛度过',e),eventOnButton('🗺️地点',t),eventOnButton('📊计数',a)}),$(()=>{!async function(){const e={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},t=getLorebookSettings();_.isEqual(_.merge({},t,e),t)||setLorebookSettings(e)}()}),$(()=>{EjsTemplate.setFeatures({enabled:!0,generate_enabled:!0,generate_loader_enabled:!1,render_enabled:!1,render_loader_enabled:!1,code_blocks_enabled:!1,raw_message_evaluation_enabled:!1,filter_message_enabled:!1,world_active_enabled:!1,autosave_enabled:!1,preload_worldinfo_enabled:!1,debug_enabled:!1,cache_enabled:!0})});async function n(e,t){const a=getVariables({type:'message',message_id:t});_.set(a,substitudeMacros('stat_data.<user>.性别'),e),await replaceVariables(a,{type:'message',message_id:t})}$(async()=>{eventOn(tavern_events.MESSAGE_SENT,async e=>{if(1===e){const e=await async function(){const e=(await getLorebookEntries('上锁的日记本')).filter(e=>e.comment.startsWith('性别设置-')&&e.enabled).map(e=>e.comment.replace('性别设置-',''));return 0===e.length?'男':e[0]}();await n(e,0),await n(e,1)}})});const o='上锁的日记本',r=/<roleplay_options>\s*(?:```.*\n)?([\s\S]*?)(?:\n```)?\s*<\/roleplay_options>/im;var i,s;async function l(e){const t=getChatMessages(e)[0].message.match(r);if(!t)return;const a=s.extract_options_element(t[1]),n=retrieveDisplayedMessage(e),o=n.find('.roleplay_options, pre:contains("<roleplay_options>")');o.length>0&&(o.remove(),n.append(a))}async function p(){$('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').each((e,t)=>{l(Number(t.getAttribute('mesid')))})}!function(e){const t={input_mode:'直接发送'};e.update=async function(){const a=e.option;return e.option=await async function(){const e=_.merge({},...(await getLorebookEntries(o)).filter(e=>e.comment.startsWith('选择框设置-')&&e.enabled).map(e=>{const t=e.comment.replace('选择框设置-','');return{[t]:e.content}})),a=t;return _.has(e,'直接发送')?a.input_mode='直接发送':_.has(e,'覆盖输入')?a.input_mode='覆盖输入':_.has(e,'尾附输入')&&(a.input_mode='尾附输入'),a}(),!_.isEqual(e.option,a)}}(i||(i={})),function(e){let t;e.update=async function(){const e=t;return t=await async function(){const e=(await getLorebookEntries(o)).filter(e=>e.comment.startsWith('选择框样式-')&&e.enabled);return 0===e.length?'<style>*{-webkit-tap-highlight-color:transparent}.roleplay_options_hr{display:none}.roleplay_options_back{background:#fff0f3;border-radius:16px;box-shadow:0 8px 20px rgba(145,125,138,0.15);padding:22px 24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;border:1px solid #ffe5ea;width:90%;max-width:740px;margin:24px auto}.roleplay_options_item{position:relative;background:#fffafb;border-radius:12px;box-shadow:0 5px 15px rgba(145,125,138,0.1);padding:18px 20px;cursor:default;border:1px solid #ffe5ea;transition:all .28s cubic-bezier(0.22,1,0.36,1);overflow:hidden;display:flex;flex-direction:column;z-index:1;margin:0;color:#7d6b6e;font-weight:400;line-height:1.6;height:100%;font-family:"Microsoft YaHei",Arial,sans-serif}.last_mes .roleplay_options_item{cursor:pointer}.last_mes .roleplay_options_item::after{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(140deg,transparent 0%,transparent 50%,rgba(255,204,214,0.15) 150%);opacity:0;transition:opacity .35s ease;z-index:-1}.last_mes .roleplay_options_item:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(145,125,138,0.2);background:#fff5f7;border-color:rgba(255,204,214,0.3)}.last_mes .roleplay_options_item:hover::after{opacity:1}.last_mes .roleplay_options_item:hover .roleplay_options_content{color:#635759}.last_mes .roleplay_options_item:active{transform:translateY(-2px);box-shadow:0 4px 12px rgba(145,125,138,0.1)}.roleplay_options_item:before{content:"";position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,#ffd0d8,#ffbbc8);transform:scaleX(0);transform-origin:0 0;transition:transform .35s cubic-bezier(0.4,0,0.2,1)}.last_mes .roleplay_options_item:hover:before{transform:scaleX(1)}.roleplay_options_title{font-size:.95em;font-weight:600;color:#7d6b6e;margin-bottom:12px;letter-spacing:.04em;text-align:left;padding-bottom:10px;border-bottom:1px solid rgba(200,200,200,0.3);text-shadow:0 1px 1px rgba(255,255,255,0.5);line-height:1.4;position:relative;display:flex;align-items:center}.roleplay_options_title::before{content:"";display:inline-block;width:6px;height:6px;background:#ffd0d8;border-radius:50%;margin-right:10px;box-shadow:0 0 0 2px rgba(255,204,214,0.2)}.roleplay_options_content{font-size:.95em;line-height:1.65;color:#8e7478;font-weight:normal;transition:color .25s ease;text-align:left;flex:1;text-shadow:0 1px 1px rgba(255,255,255,0.5);letter-spacing:.018em}.roleplay_options_item.selected{background:rgba(255,235,240,0.7);border-color:rgba(255,204,214,0.5)}.roleplay_options_item.selected:before{background:linear-gradient(90deg,#ffd0d8,#ffbbc8);transform:scaleX(1)}.roleplay_options_item.selected .roleplay_options_title::before{background:#ffd0d8;box-shadow:0 0 0 2px rgba(255,204,214,0.3)}@media (max-width:999px){.roleplay_options_back{padding:18px;gap:14px;grid-template-columns:1fr;width:100%;max-width:none;margin:24px 0;background:#fff0f3;border:1px solid #ffe5ea}.roleplay_options_item{padding:16px;background:#fffafb;border:1px solid #ffe5ea}.roleplay_options_title{font-size:.9em;padding-bottom:8px;margin-bottom:10px}.roleplay_options_content{font-size:.92em;line-height:1.6}}@media (prefers-reduced-motion:reduce){.roleplay_options_item,.roleplay_options_item::before,.roleplay_options_item::after,.roleplay_options_content,.roleplay_options_title{transition:none}}</style>':e[0].content}(),!_.isEqual(t,e)},e.extract_options_element=function(e){const a=$('<div class="roleplay_options">');return a.append(t),a.append($('<div class="roleplay_options_back">').append([...e.matchAll(/(.+?)[:：]\s*(.+)/gm)].map(e=>({title:e[1],content:e[2].replace(/^\$\{(.+)\}$/,'$1').replace(/^「(.+)」$/,'$1')})).map(({title:e,content:t})=>$('<div class="roleplay_options_item" tabindex="1">').on('click',function(){!async function(e){if(e.parents('.last_mes').length>0){const t=e.find('.roleplay_options_content').text().trim();if('直接发送'===i.option.input_mode)triggerSlash(`/send ${t} || /trigger`);else if('覆盖输入'===i.option.input_mode)triggerSlash(`/setinput ${t}`);else if('尾附输入'===i.option.input_mode){const e=$('#send_textarea').val();$('#send_textarea').val([e,t].join('\n')||'')[0].dispatchEvent(new Event('input',{bubbles:!0}))}}}($(this))}).append(`<span class="roleplay_options_title"><strong>${e}</strong></span>`).append('<hr class="roleplay_options_hr">').append(`<span class="roleplay_options_content">${t}</span>`)))),a}}(s||(s={})),$(async()=>{await errorCatched(i.update)(),await errorCatched(s.update)(),await p(),eventOn(tavern_events.CHAT_CHANGED,errorCatched(p)),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,errorCatched(l)),eventOn(tavern_events.MESSAGE_UPDATED,errorCatched(l)),eventOn(tavern_events.MESSAGE_SWIPED,errorCatched(l)),eventOn(tavern_events.MESSAGE_DELETED,()=>setTimeout(errorCatched(p),1e3)),eventOn(tavern_events.WORLDINFO_UPDATED,errorCatched(async e=>{e===o&&(await i.update()||await s.update())&&await p()}))}),$(()=>{const e=function(e){return $('<style>').attr('id',`script_custom_style-${getScriptId()}`).text(e)}(_.get(getVariables({type:'script',script_id:getScriptId()}),'样式加载',''));!function(e){const t=$('head');t.find(`#script_custom_style-${getScriptId()}`).remove(),t.append(e)}(e)}),$(()=>{const e=function(e){return $('<div>').attr('id',`script_preload-${getScriptId()}`).append(e.map(e=>$('<link>').attr('rel','preload').attr('href',e).attr('as','image')))}(_.get(getVariables({type:'script',script_id:getScriptId()}),'资源预载',[]));!function(e){const t=$('head');t.find(`#script_preload-${getScriptId()}`).remove(),t.append(e)}(e)}),$(()=>{setTimeout(async()=>{const e=Object.entries(_.get(getVariables({type:'script',script_id:getScriptId()}),'自动安装插件',{})).map(([e,t])=>{let a=t.replace(/(\.git|\/)$/,'');return a=a.substring(a.lastIndexOf('/')+1),{[a]:{name:e,url:t}}}).reduce((e,t)=>_.defaults(e,t),{}),t=await async function(){try{const e=await fetch('/api/extensions/discover');return e.ok?(await e.json()).filter(e=>'system'!==e.type).map(e=>e.name.replace('third-party/','')):[]}catch(e){return console.error(e),[]}}(),a=_.difference(Object.keys(e),t);0!==a.length&&await SillyTavern.callGenericPopup('以下需要的插件尚未安装, 是否安装?<br>'+a.map(t=>`- ${e[t].name}`).join('<br>'),SillyTavern.POPUP_TYPE.CONFIRM,'',{leftAlign:!0})&&(await Promise.allSettled(a.map(t=>async function(e){const t=await fetch('/api/extensions/install',{method:'POST',headers:SillyTavern.getRequestHeaders(),body:JSON.stringify({url:e})});if(!t.ok){const e=await t.text();return toastr.warning(`${e||t.statusText}`,'扩展安装失败'),console.error('扩展安装失败',t.status,t.statusText,e),!1}const a=await t.json();return toastr.success(`已成功安装由 '${a.author}' 编写的 '${a.display_name}' (版本 ${a.version})!`,'扩展安装成功'),console.debug(`已成功将 '${a.display_name}' 安装到 ${a.extensionPath}`),!0}(e[t].url))),setTimeout(()=>triggerSlash('/reload-page'),3e3))},1e4)});const c=_.debounce(function(){const e=2e6,t=SillyTavern.chatCompletionSettings;!0===t.max_context_unlocked&&t.openai_max_context===e||($('#oai_max_context_unlocked').prop('checked',!0).trigger('input'),$('#openai_max_context_counter').val(e),$('#openai_max_context').val(e).trigger('input'))},1e3);$(()=>{eventOn(tavern_events.SETTINGS_UPDATED,c)});