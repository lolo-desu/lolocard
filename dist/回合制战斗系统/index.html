<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>回合制战斗界面</title><script type="module">;// ./src/回合制战斗系统/ui/battle-interface.ts
/**
 * 更新角色信息的显示
 * @param type 'player' 或 'enemy'
 * @param character 角色数据
 */
function updateCharacterInfo(type, character) {
    const infoDiv = $(`#${type}-info`);
    if (infoDiv.length === 0)
        return;
    const attributes = character.attributes;
    const statusNames = character.status.map(s => s.name).join(', ');
    infoDiv.html(`
        <h3>${character.name}</h3>
        <div class="status-bar hp">
            <div class="bar-fill" style="width: ${(attributes.hp / attributes.maxHp) * 100}%;"></div>
        </div>
        <span>HP: ${attributes.hp} / ${attributes.maxHp}</span>
        <div class="status-bar mp">
            <div class="bar-fill" style="width: ${(attributes.mp / attributes.maxMp) * 100}%;"></div>
        </div>
        <span>MP: ${attributes.mp} / ${attributes.maxMp}</span>
        <div class="status-effects">
            状态: ${statusNames || '无'}
        </div>
    `);
}
/**
 * 向战斗日志添加条目
 * @param logEntry 日志条目数据
 */
function addLogEntry(logEntry) {
    const battleLog = $('#battle-log');
    if (battleLog.length === 0)
        return;
    let entryClass = 'log-entry';
    if (logEntry.actionType === 'system') {
        entryClass += ' system-message';
    }
    else if (logEntry.actorId === 'player') {
        // 假设玩家 ID 固定为 'player'
        entryClass += ' player-action';
    }
    else {
        entryClass += ' enemy-action';
    }
    // 使用 description 作为基础，可以根据结构化数据进一步丰富显示
    let messageHtml = `[回合 ${logEntry.turn}] ${logEntry.description}`;
    // 示例：为伤害、治疗、暴击添加样式
    if (logEntry.damageDealt) {
        messageHtml = messageHtml.replace(logEntry.damageDealt.toString(), `<span class="damage">${logEntry.damageDealt}</span>`);
    }
    if (logEntry.healingDone) {
        messageHtml = messageHtml.replace(logEntry.healingDone.toString(), `<span class="heal">${logEntry.healingDone}</span>`);
    }
    if (logEntry.isCritical) {
        // 假设描述中包含能标识暴击的词
        messageHtml = messageHtml.replace('暴击', '<span class="critical">暴击</span>');
    }
    const entry = $(`<div class="${entryClass}"></div>`).html(messageHtml);
    battleLog.append(entry);
    battleLog.scrollTop(battleLog[0].scrollHeight);
}
/**
 * 更新技能列表
 * @param skills 技能数组
 */
function updateSkillList(skills) {
    const skillListDiv = $('#skill-list');
    if (skillListDiv.length === 0)
        return;
    skillListDiv.empty();
    skills.forEach(skill => {
        const skillButton = $(`<button class="skill-button" data-skill-id="${skill.id}">${skill.name} (MP: ${skill.mpCost})</button>`);
        skillListDiv.append(skillButton);
    });
}
/**
 * 显示战斗结果
 * @param message 结果消息
 */
function showBattleResult(message) {
    const battleResultDiv = $('#battle-result');
    if (battleResultDiv.length === 0)
        return;
    battleResultDiv.html(`<h2>${message}</h2><button id="continue-plot-button">继续剧情</button>`);
    battleResultDiv.show();
    $('.battle-controls').hide();
}
// --- 示例数据和初始化 --- (后续会由战斗引擎和通信模块驱动)
const samplePlayerStatus = [{ id: 's001', name: '力量提升', description: '攻击力少量上升', duration: 3 }];
const sampleEnemyStatus = [{ id: 's002', name: '中毒', description: '每回合损失少量HP', duration: 5 }];
const samplePlayerSkills = [
    {
        id: 'sk001',
        name: '火焰球',
        description: '造成少量火属性伤害',
        mpCost: 10,
        type: 'attack',
        targetType: 'single',
        effects: [{ type: 'damage', value: 15 }],
    },
    {
        id: 'sk002',
        name: '治疗术',
        description: '恢复少量HP',
        mpCost: 15,
        type: 'heal',
        targetType: 'single',
        effects: [{ type: 'heal', value: 20 }],
    },
    {
        id: 'sk003',
        name: '英勇打击',
        description: '造成物理伤害',
        mpCost: 5,
        type: 'attack',
        targetType: 'single',
        effects: [{ type: 'damage', value: 10 }],
    },
];
const samplePlayer = {
    id: 'player',
    name: '英雄',
    type: 'player',
    attributes: { hp: 85, maxHp: 100, mp: 40, maxMp: 50, strength: 12, defense: 8, speed: 10, intelligence: 9 },
    skills: samplePlayerSkills,
    status: samplePlayerStatus,
};
const sampleEnemy = {
    id: 'enemy01',
    name: '史莱姆王',
    type: 'enemy',
    attributes: { hp: 120, maxHp: 120, mp: 20, maxMp: 20, strength: 10, defense: 10, speed: 5, intelligence: 3 },
    skills: [], // 敌人技能暂不在此示例中处理
    status: sampleEnemyStatus,
};
const sampleLog = [
    { turn: 1, actorId: 'system', actorName: '系统', actionType: 'system', description: '战斗开始！史莱姆王出现了！' },
    {
        turn: 1,
        actorId: 'player',
        actorName: '英雄',
        actionType: 'skill',
        skillName: '火焰球',
        targetId: 'enemy01',
        targetName: '史莱姆王',
        description: '英雄对史莱姆王使用了火焰球，造成 15 点伤害。',
        damageDealt: 15,
    },
    {
        turn: 1,
        actorId: 'enemy01',
        actorName: '史莱姆王',
        actionType: 'attack',
        targetId: 'player',
        targetName: '英雄',
        description: '史莱姆王撞向英雄，造成 8 点伤害。',
        damageDealt: 8,
    },
    {
        turn: 2,
        actorId: 'player',
        actorName: '英雄',
        actionType: 'attack',
        targetId: 'enemy01',
        targetName: '史莱姆王',
        description: '英雄发动了攻击，造成 18 点<span class="critical">暴击</span>伤害！',
        damageDealt: 18,
        isCritical: true,
    },
    {
        turn: 2,
        actorId: 'enemy01',
        actorName: '史莱姆王',
        actionType: 'system',
        description: '史莱姆王因为中毒，受到了 5 点伤害。',
        damageDealt: 5,
    }, // 状态伤害
    {
        turn: 2,
        actorId: 'player',
        actorName: '英雄',
        actionType: 'skill',
        skillName: '治疗术',
        targetId: 'player',
        targetName: '英雄',
        description: '英雄对自己使用了治疗术，恢复了 20 点HP。',
        healingDone: 20,
    },
];
$(document).ready(() => {
    updateCharacterInfo('player', samplePlayer);
    updateCharacterInfo('enemy', sampleEnemy);
    updateSkillList(samplePlayerSkills);
    // 显示示例日志
    sampleLog.forEach(log => addLogEntry(log));
    // 绑定事件监听 (这里的逻辑后续会被战斗引擎接管)
    $('.battle-controls').on('click', '.action-button', function () {
        const action = $(this).data('action');
        const log = {
            turn: 3, // 假设是第3回合
            actorId: 'player',
            actorName: '英雄',
            actionType: action,
            description: `英雄选择了 ${$(this).text()}`,
        };
        addLogEntry(log);
        // 模拟敌人回合和战斗结束
        setTimeout(() => {
            const enemyLog = {
                turn: 3,
                actorId: 'enemy01',
                actorName: '史莱姆王',
                actionType: 'attack',
                targetId: 'player',
                targetName: '英雄',
                description: '史莱姆王发动了最终一击！',
                damageDealt: 50, // 假设高伤害
                isCritical: true, // 假设暴击
            };
            addLogEntry(enemyLog);
            if (Math.random() > 0.3) {
                showBattleResult('胜利！');
            }
            else {
                showBattleResult('失败...');
            }
        }, 1000);
    });
    $('.battle-controls').on('click', '.skill-button', function () {
        const skillId = $(this).data('skill-id');
        const skill = samplePlayerSkills.find(s => s.id === skillId);
        if (!skill)
            return;
        const log = {
            turn: 3, // 假设是第3回合
            actorId: 'player',
            actorName: '英雄',
            actionType: 'skill',
            skillName: skill.name,
            description: `英雄使用了技能：${skill.name}`,
        };
        addLogEntry(log);
        // 模拟敌人回合和战斗结束
        setTimeout(() => {
            const enemyLog = {
                turn: 3,
                actorId: 'enemy01',
                actorName: '史莱姆王',
                actionType: 'attack',
                targetId: 'player',
                targetName: '英雄',
                description: '史莱姆王发动了反击！',
                damageDealt: 12,
            };
            addLogEntry(enemyLog);
            showBattleResult('战斗结束！');
        }, 1000);
    });
    $('#battle-result').on('click', '#continue-plot-button', function () {
        toastr.info('继续剧情...（此处将与SillyTavern交互）');
        // TODO: 实现与SillyTavern的交互逻辑
        $('#battle-container').hide(); // 隐藏战斗界面
    });
});


;// ./src/回合制战斗系统/index.ts
// 主入口文件，用于 Webpack 打包
// 导入 UI 模块，确保其代码被包含在打包结果中

// 导入样式文件，Webpack 会处理 SCSS 编译和打包

// 后续可以从这里导出模块的主要功能或类
// export { BattleManager } from './core/battle-manager';
// 也可以在这里执行一些全局初始化操作（如果需要）
console.log('回合制战斗系统组件已加载');
// TODO:
// 1. 实现核心战斗逻辑 (core/)
// 2. 定义数据模型 (models/)
// 3. 实现与 SillyTavern 的通信 (communication/)
// 4. 将 battle-interface.ts 中的模拟数据替换为真实数据流</script><style>.battle-container{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background-color:#252526;color:#e0e0e0;padding:10px;border:1px solid #404040;border-radius:4px;max-width:600px;margin:auto;display:flex;flex-direction:column;gap:10px}.battle-container .battle-scene{display:flex;justify-content:space-around;gap:10px}.battle-container .battle-scene .character-area{flex:1;padding:10px;border:1px solid #404040;border-radius:4px;min-height:100px}.battle-container .battle-scene .character-info h3{margin-top:0;margin-bottom:5px;font-size:16.8px}.battle-container .battle-scene .character-info .status-bar{width:100%;background-color:rgb(89.5,89.5,89.5);border-radius:2px;margin-bottom:5px;height:10px;overflow:hidden}.battle-container .battle-scene .character-info .status-bar .bar-fill{height:100%;transition:width .3s ease-in-out}.battle-container .battle-scene .character-info .status-bar.hp .bar-fill{background-color:#4caf50}.battle-container .battle-scene .character-info .status-bar.mp .bar-fill{background-color:#2196f3}.battle-container .battle-scene .character-info .status-effects{font-size:12.6px;color:#b0b0b0}.battle-container .battle-log-container{border:1px solid #404040;border-radius:4px;padding:10px;height:150px;overflow-y:auto;background-color:rgb(49.58,49.58,50.92)}.battle-container .battle-log-container .battle-log .log-entry{padding:5px 0;border-bottom:1px dashed rgb(51.25,51.25,51.25)}.battle-container .battle-log-container .battle-log .log-entry:last-child{border-bottom:none}.battle-container .battle-log-container .battle-log .log-entry.player-action{color:#64b5f6}.battle-container .battle-log-container .battle-log .log-entry.enemy-action{color:#e57373}.battle-container .battle-log-container .battle-log .log-entry.system-message{color:#ffd54f;font-style:italic}.battle-container .battle-log-container .battle-log .log-entry .damage{color:#f44336;font-weight:bold}.battle-container .battle-log-container .battle-log .log-entry .heal{color:#81c784;font-weight:bold}.battle-container .battle-log-container .battle-log .log-entry .critical{color:gold;font-weight:bold;animation:flash .5s infinite alternate}.battle-container .battle-controls{display:flex;flex-direction:column;gap:10px}.battle-container .battle-controls .skill-list{display:flex;flex-wrap:wrap;gap:5px}.battle-container .battle-controls .action-buttons{display:flex;justify-content:center;gap:5px}.battle-container .battle-controls .action-button,.battle-container .battle-controls .skill-button{padding:6.6666666667px 10px;background-color:rgb(62.16,62.16,63.84);border:1px solid #404040;color:#e0e0e0;border-radius:4px;cursor:pointer;transition:background-color .2s ease}.battle-container .battle-controls .action-button:hover,.battle-container .battle-controls .skill-button:hover{background-color:rgb(87.32,87.32,89.68)}.battle-container .battle-controls .action-button:active,.battle-container .battle-controls .skill-button:active{background-color:rgb(24.42,24.42,25.08)}.battle-container .battle-result{padding:10px;text-align:center;border:1px solid #404040;border-radius:4px}.battle-container .battle-result h2{margin-top:0}.battle-container .battle-result #continue-plot-button{padding:6.6666666667px 10px;background-color:#64b5f6;border:1px solid rgb(51.7987804878,157.987804878,243.2012195122);color:#fff;border-radius:4px;cursor:pointer;transition:background-color .2s ease;font-size:15.4px;margin-top:10px}.battle-container .battle-result #continue-plot-button:hover{background-color:rgb(148.2012195122,204.012195122,248.7987804878)}@keyframes flash{0%{opacity:1}50%{opacity:.6}100%{opacity:1}}
</style></head><body><div id="battle-root"><div id="battle-container" class="battle-container"><div class="battle-scene"><div class="character-area player-area"><div class="character-info" id="player-info"></div></div><div class="character-area enemy-area"><div class="character-info" id="enemy-info"></div></div></div><div class="battle-log-container"><div class="battle-log" id="battle-log"></div></div><div class="battle-controls"><div class="skill-list" id="skill-list"></div><div class="action-buttons"><button class="action-button" data-action="attack">攻击</button> <button class="action-button" data-action="defend">防御</button> <button class="action-button" data-action="escape">逃跑</button></div></div><div class="battle-result" id="battle-result" style="display:none"><button id="continue-plot-button">继续剧情</button></div></div></div></body></html>