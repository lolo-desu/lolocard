<head><script type="module">import{default as e}from'https://testingcf.jsdelivr.net/npm/lodash/get/+esm';import{default as t}from'https://testingcf.jsdelivr.net/npm/lodash/set/+esm';import{klona as a}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var n={895:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}}},l={};function r(e){var t=l[e];if(void 0!==t)return t.exports;var a=l[e]={exports:{}};return n[e](a,a.exports,r),a.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const o=$;var c=r.n(o);const s=Vue,i={class:'field-card'},p={class:'field-card__header'},u={key:0},d={class:'field-card__badge'},m={class:'field-card__label'},f={key:0},h=['type','value','placeholder','min','max','onInput'],v=['value','placeholder','onInput'],g=(0,s.defineComponent)({__name:'FieldGroupCard',props:{group:{},formState:{}},emits:['update:field'],setup(e,{emit:t}){const a=t;function n(e,t){a('update:field',e,t)}return(t,a)=>((0,s.openBlock)(),(0,s.createElementBlock)('section',i,[(0,s.createElementVNode)('header',p,[(0,s.createElementVNode)('div',null,[(0,s.createElementVNode)('h2',null,(0,s.toDisplayString)(e.group.title),1),e.group.description?((0,s.openBlock)(),(0,s.createElementBlock)('p',u,(0,s.toDisplayString)(e.group.description),1)):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createElementVNode)('span',d,'共 '+(0,s.toDisplayString)(e.group.fields.length)+' 项',1)]),(0,s.createElementVNode)('div',{class:'field-card__grid',style:(0,s.normalizeStyle)({gridTemplateColumns:`repeat(${e.group.columns??1}, minmax(0, 1fr))`})},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(e.group.fields,t=>((0,s.openBlock)(),(0,s.createElementBlock)('label',{key:t.path,class:'field-card__item'},[(0,s.createElementVNode)('span',m,[(0,s.createTextVNode)((0,s.toDisplayString)(t.label)+' ',1),t.note?((0,s.openBlock)(),(0,s.createElementBlock)('small',f,(0,s.toDisplayString)(t.note),1)):(0,s.createCommentVNode)('v-if',!0)]),'textarea'!==t.type?((0,s.openBlock)(),(0,s.createElementBlock)('input',{key:0,type:'number'===t.type?'number':'text',value:e.formState[t.path]??'',placeholder:t.placeholder,min:'number'===t.type?t.min??0:void 0,max:'number'===t.type?t.max??void 0:void 0,onInput:e=>n(t.path,e.target.value)},null,40,h)):((0,s.openBlock)(),(0,s.createElementBlock)('textarea',{key:1,value:e.formState[t.path]??'',placeholder:t.placeholder,rows:'3',onInput:e=>n(t.path,e.target.value)},null,40,v))]))),128))],4)]))}});var y=r(895);const k=(0,y.A)(g,[['__scopeId','data-v-4a7ec898']]),b=[{key:'system',title:'系统配置',description:'',columns:1,fields:[{path:'系统状态.对主角可见形象',label:'系统形象',placeholder:'示例: 光翼向导'},{path:'系统状态.玩家ID',label:'玩家 ID',placeholder:'示例: {{user}}'}]},{key:'hero-basic',title:'主角身份',description:'',columns:1,fields:[{path:'主角.姓名',label:'姓名',placeholder:'示例: 埃利欧特'},{path:'主角.性别',label:'性别',placeholder:'男 / 女 / 其他'},{path:'主角.年龄',label:'年龄',placeholder:'数字或描述'},{path:'主角.人设',label:'人设',placeholder:'一句话概述角色气质、目标等',type:'textarea',sync:!1}]}],E=e=>(e??'').trim();function B(n){const l=(0,s.ref)(null),r=(0,s.ref)(!1),o=(0,s.ref)(!1),c=(0,s.ref)(''),i=(0,s.ref)(''),p=(0,s.reactive)({}),u=n.flatMap(e=>e.fields),d=u.filter(e=>!1!==e.sync),m=u.filter(e=>!1===e.sync),f=(0,s.computed)(()=>d.filter(e=>''===E(p[e.path]))),h=(0,s.computed)(()=>f.value.map(e=>e.path)),v=(0,s.computed)(()=>r.value&&!o.value),g=async function(){try{await waitGlobalInitialized('Mvu'),l.value=getCurrentMessageId();const t=Mvu.getMvuData({type:'message',message_id:l.value});return u.forEach(a=>{!1!==a.sync?p[a.path]=function(t,a){const n=e(a,t.path);if(null==n||'待初始化'===n)return'';return String(n)}(a,t.stat_data):p[a.path]=''}),r.value=!0,t}catch(e){return c.value=e instanceof Error?e.message:'加载界面失败',null}}();return{formState:p,isReady:r,isSubmitting:o,errorMessage:c,confirmation:i,pendingEmptyPaths:h,pendingEmptyFields:f,canSubmit:v,handleSubmit:async function(){if(v.value&&l.value){o.value=!0,c.value='',i.value='';try{const e=await g;if(!e)throw new Error('变量未准备好, 请稍后重试');const n=a(e);d.forEach(e=>{const a=E(p[e.path]);if(''!==a){const l=function(e,t){if('number'===e.type){const e=Number(t);return Number.isFinite(e)?e:void 0}return t}(e,a);void 0!==l&&t(n.stat_data,e.path,l)}}),await Mvu.replaceMvuData(n,{type:'message',message_id:l.value});const r=[];m.forEach(e=>{const t=E(p[e.path]);t&&r.push(`${e.label}: ${t}`)}),r.push(...f.value.map(e=>`${e.path}: [未填写]`)),r.push('/初始化角色/');const o=r.join('\n');await createChatMessages([{role:'user',content:o}]),i.value='已提交, 请等待系统初始化'}catch(e){c.value=e instanceof Error?e.message:'提交失败, 请稍后重试'}finally{o.value=!1}}}}}const S={class:'opening-panel'},N={class:'panel-grid'},V={class:'panel-footer'},x={class:'panel-footer__messages'},D={key:0,class:'feedback feedback--error'},w={key:1,class:'feedback feedback--success'},C=['disabled'],M=(0,s.defineComponent)({__name:'App',setup(e){const{formState:t,isReady:a,isSubmitting:n,errorMessage:l,confirmation:r,canSubmit:o,handleSubmit:c}=B(b);function i(e,a){t[e]=a}return(e,a)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',S,[a[1]||(a[1]=(0,s.createElementVNode)('header',{class:'opening-panel__hero'},[(0,s.createElementVNode)('h1',null,'开局设定')],-1)),(0,s.createElementVNode)('div',N,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)((0,s.unref)(b),e=>((0,s.openBlock)(),(0,s.createBlock)(k,{key:e.key,group:e,'form-state':(0,s.unref)(t),'onUpdate:field':i},null,8,['group','form-state']))),128))]),(0,s.createElementVNode)('footer',V,[(0,s.createElementVNode)('div',x,[(0,s.unref)(l)?((0,s.openBlock)(),(0,s.createElementBlock)('p',D,(0,s.toDisplayString)((0,s.unref)(l)),1)):(0,s.createCommentVNode)('v-if',!0),(0,s.unref)(r)?((0,s.openBlock)(),(0,s.createElementBlock)('p',w,(0,s.toDisplayString)((0,s.unref)(r)),1)):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createElementVNode)('button',{disabled:!(0,s.unref)(o),onClick:a[0]||(a[0]=(...e)=>(0,s.unref)(c)&&(0,s.unref)(c)(...e))},(0,s.toDisplayString)((0,s.unref)(n)?'提交中...':'开始游戏'),9,C)])]))}}),I=(0,y.A)(M,[['__scopeId','data-v-149e00b6']]);let j=null;c()(()=>{j=(0,s.createApp)(I),j.mount('#app')}),c()(window).on('pagehide',()=>{j&&(j.unmount(),j=null)});
//# sourceMappingURL=index.js.map</script><style>.field-card[data-v-4a7ec898]{background-color:#141925;border:1px solid #1f2636;border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px}.field-card__header[data-v-4a7ec898]{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}.field-card__header h2[data-v-4a7ec898]{margin:0;font-size:1.1rem;color:#f7f8fb}.field-card__header p[data-v-4a7ec898]{margin:4px 0 0;color:#9ba4be;font-size:0.85rem}.field-card__badge[data-v-4a7ec898]{font-size:0.78rem;padding:2px 8px;border-radius:999px;border:1px solid #2b3246;color:#9ba4be}.field-card__grid[data-v-4a7ec898]{display:grid;gap:12px}.field-card__item[data-v-4a7ec898]{display:flex;flex-direction:column;gap:6px;font-size:0.9rem;color:#e1e6ef}.field-card__label[data-v-4a7ec898]{display:flex;justify-content:space-between;font-size:0.85rem;color:#b8c0d9}.field-card__label small[data-v-4a7ec898]{color:#75809f}input[data-v-4a7ec898],textarea[data-v-4a7ec898]{width:100%;background-color:#0f131d;border:1px solid #232a3d;border-radius:8px;padding:8px 10px;color:#f7f8fb;font-size:0.92rem;font-family:inherit;transition:border-color 0.15s ease}input[data-v-4a7ec898]:focus,textarea[data-v-4a7ec898]:focus{outline:none;border-color:#4a70ff}


.opening-panel[data-v-149e00b6]{display:flex;flex-direction:column;gap:16px;color:#e1e6ef}.opening-panel__hero[data-v-149e00b6]{display:flex;flex-direction:column;gap:12px;background-color:#151a26;border:1px solid #262f44;border-radius:14px;padding:18px}h1[data-v-149e00b6]{margin:0;font-size:1.4rem;color:#f7f8fb}.panel-grid[data-v-149e00b6]{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}.panel-footer[data-v-149e00b6]{display:flex;flex-wrap:wrap;justify-content:space-between;gap:12px;align-items:center;border-top:1px solid #232a3d;padding-top:12px}.panel-footer button[data-v-149e00b6]{background-color:#f2aa4c;color:#1a1720;border:1px solid #f2aa4c;border-radius:99px;padding:12px 30px;font-size:1rem;font-weight:600;cursor:pointer;transition:opacity 0.15s ease}.panel-footer button[data-v-149e00b6]:disabled{opacity:0.4;cursor:not-allowed}.panel-footer__messages[data-v-149e00b6]{flex:1;min-width:240px}.feedback[data-v-149e00b6]{margin:0;font-size:0.9rem}.feedback--error[data-v-149e00b6]{color:#ff8a8a}.feedback--success[data-v-149e00b6]{color:#9dea85}

:root{font-family:"Noto Serif SC","Times New Roman",serif;color:#e1e6ef;background-color:rgba(0,0,0,0)}body{margin:0;padding:0;color:inherit}#app{width:100%;min-height:100%;background-color:#0e121a;padding:12px;box-sizing:border-box}

/*# sourceMappingURL=main.css.map*/</style></head><body><div id="app"></div></body>