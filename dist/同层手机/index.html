<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/><title>æš´åŠ›ç¾å­¦BLMXåŒå±‚æ‰‹æœº</title><script type="module">/******/ var __webpack_modules__ = ({

/***/ 895:
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DialogManager: () => (/* binding */ DialogManager)
/* harmony export */ });
/**
 * å¯¹è¯æ¡†ç®¡ç†å™¨
 * æä¾›è‡ªå®šä¹‰çš„alertã€confirmã€promptå¯¹è¯æ¡†ï¼Œæ›¿ä»£ç³»ç»Ÿé»˜è®¤å¯¹è¯æ¡†
 */
class DialogManager {
    static instance;
    activeDialog = null;
    activeOverlay = null;
    constructor() {
        // ç§æœ‰æ„é€ å‡½æ•°ï¼Œç¡®ä¿å•ä¾‹æ¨¡å¼
    }
    /**
     * è·å–å•ä¾‹å®ä¾‹
     */
    static getInstance() {
        if (!DialogManager.instance) {
            DialogManager.instance = new DialogManager();
        }
        return DialogManager.instance;
    }
    /**
     * HTMLè½¬ä¹‰è¾…åŠ©æ–¹æ³•
     */
    escapeHtml(text) {
        return $('<div>').text(text).html();
    }
    /**
     * å®‰å…¨æ˜¾ç¤ºå¯¹è¯æ¡† - å¦‚æœå·²æœ‰å¯¹è¯æ¡†åˆ™å…ˆå…³é—­
     */
    async safeShowDialog(dialogFunction) {
        // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰å¯¹è¯æ¡†ï¼ˆæ— è®ºæ˜¯å¦æœ‰æ´»è·ƒå¯¹è¯æ¡†ï¼‰
        this.forceCleanupDialogs();
        return await dialogFunction();
    }
    /**
     * åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
     */
    createBaseDialogElements(dialogClass) {
        this.activeOverlay = $('<div>').addClass('dialog-overlay mobile-dialog-overlay')[0];
        this.activeDialog = $('<div>').addClass(`dialog ${dialogClass} mobile-dialog`)[0];
    }
    /**
     * å°†å¯¹è¯æ¡†æ·»åŠ åˆ°é¡µé¢ä¸­
     */
    appendDialogToPage() {
        if (!this.activeOverlay)
            return;
        const $phoneScreen = $('.phone-screen');
        if ($phoneScreen.length) {
            $phoneScreen.append(this.activeOverlay);
        }
        else {
            // å¦‚æœæ‰¾ä¸åˆ°æ‰‹æœºå±å¹•å®¹å™¨ï¼Œå›é€€åˆ°body
            $('body').append(this.activeOverlay);
        }
    }
    /**
     * åˆå§‹åŒ–å¯¹è¯æ¡†ä¸­çš„checkboxæŒ‰é’®æ ·å¼
     */
    initializeCheckboxButtons() {
        if (!this.activeDialog)
            return;
        $(this.activeDialog)
            .find('.checkbox-button')
            .each((_, button) => {
            const $button = $(button);
            const $checkbox = $button.find('input[type="checkbox"]');
            if (!$checkbox.length)
                return;
            const checkbox = $checkbox[0];
            // è®¾ç½®åˆå§‹çŠ¶æ€
            this.updateCheckboxButtonState(button, checkbox.checked);
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            $button.on('click', e => {
                e.preventDefault();
                e.stopPropagation();
                if (checkbox.disabled)
                    return;
                // åˆ‡æ¢çŠ¶æ€
                checkbox.checked = !checkbox.checked;
                this.updateCheckboxButtonState(button, checkbox.checked);
                // è§¦å‘changeäº‹ä»¶ - ä½¿ç”¨åŸç”Ÿäº‹ä»¶ç¡®ä¿å…¼å®¹æ€§
                const changeEvent = new Event('change', { bubbles: true });
                checkbox.dispatchEvent(changeEvent);
            });
            // ç›‘å¬å¤–éƒ¨çŠ¶æ€å˜åŒ–
            $checkbox.on('change', () => {
                this.updateCheckboxButtonState(button, checkbox.checked);
            });
            // è®¾ç½®å¯è®¿é—®æ€§å±æ€§
            $button.attr({
                role: 'checkbox',
                tabindex: '0',
                'aria-checked': checkbox.checked.toString(),
            });
        });
    }
    /**
     * æ›´æ–°checkboxæŒ‰é’®çŠ¶æ€
     */
    updateCheckboxButtonState(button, checked) {
        const $button = $(button);
        $button.toggleClass('checked', checked);
        $button.attr('aria-checked', checked.toString());
    }
    /**
     * æ˜¾ç¤ºæç¤ºå¯¹è¯æ¡†ï¼ˆæ›¿ä»£alertï¼‰
     */
    alert(message, title = 'æç¤º', confirmText = 'ç¡®å®š') {
        return this.safeShowDialog(() => this.showDialog({
            type: 'alert',
            title,
            message,
            confirmText,
        }));
    }
    /**
     * æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆæ›¿ä»£confirmï¼‰
     */
    confirm(message, title = 'ç¡®è®¤', confirmText = 'ç¡®å®š', cancelText = 'å–æ¶ˆ') {
        return this.safeShowDialog(() => this.showDialog({
            type: 'confirm',
            title,
            message,
            confirmText,
            cancelText,
        }));
    }
    /**
     * æ˜¾ç¤ºè¾“å…¥å¯¹è¯æ¡†ï¼ˆæ›¿ä»£promptï¼‰
     */
    prompt(message, defaultValue = '', title = 'è¯·è¾“å…¥', confirmText = 'ç¡®å®š', cancelText = 'å–æ¶ˆ', inputType = 'text', placeholder = '') {
        return this.safeShowDialog(() => this.showDialog({
            type: 'prompt',
            title,
            message,
            confirmText,
            cancelText,
            inputType,
            inputValue: defaultValue,
            inputPlaceholder: placeholder,
        }));
    }
    /**
     * æ˜¾ç¤ºå¯æ»šåŠ¨æ–‡æœ¬å¯¹è¯æ¡†ï¼ˆç”¨äºæ˜¾ç¤ºé•¿æ–‡æœ¬å†…å®¹ï¼‰
     */
    showScrollableText(content, title = 'å†…å®¹', confirmText = 'å…³é—­') {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('scrollable-text-dialog');
            // è®¾ç½®å¯¹è¯æ¡†å†…å®¹
            this.activeDialog.innerHTML = `
          <div class="dialog-header">
            <h3>${title}</h3>
          </div>
          <div class="dialog-body scrollable-content">
            <pre class="scrollable-text">${this.escapeHtml(content)}</pre>
          </div>
          <div class="dialog-footer">
            <button class="dialog-button copy-btn">å¤åˆ¶</button>
            <button class="dialog-button primary-button">${confirmText}</button>
          </div>
        `;
            const $copyBtn = $(this.activeDialog).find('.copy-btn');
            const $confirmBtn = $(this.activeDialog).find('.primary-button');
            const handleCopy = async () => {
                try {
                    await navigator.clipboard.writeText(content);
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡å­—æç¤ºå¤åˆ¶æˆåŠŸ
                    const originalText = $copyBtn.text();
                    $copyBtn.text('å·²å¤åˆ¶');
                    setTimeout(() => {
                        $copyBtn.text(originalText);
                    }, 1000);
                }
                catch (error) {
                    console.error('å¤åˆ¶å¤±è´¥:', error);
                    // é™çº§æ–¹æ¡ˆï¼šé€‰æ‹©æ–‡æœ¬
                    const $textElement = $(this.activeDialog).find('.scrollable-text');
                    if ($textElement.length) {
                        const range = document.createRange();
                        range.selectNodeContents($textElement[0]);
                        const selection = window.getSelection();
                        if (selection) {
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                    }
                }
            };
            const handleConfirm = () => {
                this.closeDialog();
                resolve();
            };
            const handleCancel = () => {
                this.closeDialog();
                resolve();
            };
            $copyBtn.on('click', handleCopy);
            $confirmBtn.on('click', handleConfirm);
            // ESCé”®å…³é—­
            $(document).on('keydown.dialog', (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                    $(document).off('keydown.dialog');
                }
            });
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            $(this.activeOverlay).append(this.activeDialog);
            this.appendDialogToPage();
        }));
    }
    /**
     * æ˜¾ç¤ºå¯¹è¯æ¡†
     */
    showDialog(options) {
        // åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
        const { overlay, dialog } = this.createDialogElements(options);
        // ä¿å­˜å¼•ç”¨
        this.activeOverlay = overlay;
        this.activeDialog = dialog;
        // æ·»åŠ åˆ°é¡µé¢ä¸­
        this.appendDialogToPage();
        // å¤„ç†è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦
        if (options.type === 'prompt') {
            const $inputEl = $(dialog).find('input, textarea');
            if ($inputEl.length) {
                setTimeout(() => $inputEl.trigger('focus'), 100);
            }
        }
        return new Promise(resolve => {
            // ç¡®è®¤æŒ‰é’®ç‚¹å‡»å¤„ç†
            const confirmButton = dialog.querySelector('.primary-button');
            if (confirmButton) {
                confirmButton.addEventListener('click', () => {
                    if (options.type === 'prompt') {
                        const inputEl = dialog.querySelector('input, textarea');
                        const value = inputEl ? inputEl.value : null;
                        this.closeDialog();
                        resolve(value);
                    }
                    else {
                        this.closeDialog();
                        resolve(options.type === 'confirm' ? true : undefined);
                    }
                });
            }
            // å–æ¶ˆæŒ‰é’®ç‚¹å‡»å¤„ç†
            const cancelButton = dialog.querySelector('.cancel-button');
            if (cancelButton) {
                cancelButton.addEventListener('click', () => {
                    this.closeDialog();
                    resolve(options.type === 'prompt' ? null : false);
                });
            }
            // ç‚¹å‡»é®ç½©å±‚å…³é—­ï¼ˆä»…å¯¹alertæœ‰æ•ˆï¼‰
            if (options.type === 'alert') {
                overlay.addEventListener('click', e => {
                    if (e.target === overlay) {
                        this.closeDialog();
                        resolve(undefined);
                    }
                });
            }
            // é”®ç›˜äº‹ä»¶å¤„ç†
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (options.type === 'prompt') {
                        const inputEl = dialog.querySelector('input, textarea');
                        const value = inputEl ? inputEl.value : null;
                        this.closeDialog();
                        resolve(value);
                    }
                    else if (options.type === 'confirm') {
                        this.closeDialog();
                        resolve(true);
                    }
                    else {
                        // alert
                        this.closeDialog();
                        resolve(undefined);
                    }
                    document.removeEventListener('keydown', handleKeyDown);
                }
                else if (e.key === 'Escape') {
                    e.preventDefault();
                    this.closeDialog();
                    resolve(options.type === 'prompt' ? null : false);
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
        });
    }
    /**
     * åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
     */
    createDialogElements(options) {
        // åˆ›å»ºé®ç½©å±‚
        const $overlay = $('<div>').addClass('custom-dialog-overlay');
        // åˆ›å»ºå¯¹è¯æ¡†
        const $dialog = $('<div>').addClass(`custom-dialog ${options.className || ''}`);
        // åˆ›å»ºæ ‡é¢˜
        const $header = $('<div>').addClass('dialog-header');
        const $title = $('<h3>')
            .addClass('dialog-title')
            .text(options.title || '');
        $header.append($title);
        $dialog.append($header);
        // åˆ›å»ºå†…å®¹
        const $body = $('<div>').addClass('dialog-body');
        // æ·»åŠ æ¶ˆæ¯
        const $message = $('<div>').text(options.message);
        $body.append($message);
        // å¦‚æœæ˜¯promptï¼Œæ·»åŠ è¾“å…¥æ¡†
        if (options.type === 'prompt') {
            const $inputContainer = $('<div>').addClass('dialog-input-container');
            const $input = $(options.inputType === 'textarea' ? '<textarea>' : '<input>');
            if (options.inputType !== 'textarea') {
                $input.attr('type', options.inputType || 'text');
            }
            if (options.inputValue) {
                $input.val(options.inputValue);
            }
            if (options.inputPlaceholder) {
                $input.attr('placeholder', options.inputPlaceholder);
            }
            $inputContainer.append($input);
            $body.append($inputContainer);
        }
        $dialog.append($body);
        // åˆ›å»ºæŒ‰é’®åŒºåŸŸ
        const $footer = $('<div>').addClass('dialog-footer');
        // æ ¹æ®ç±»å‹æ·»åŠ ä¸åŒçš„æŒ‰é’®
        if (options.type === 'confirm' || options.type === 'prompt') {
            const $cancelButton = $('<button>')
                .addClass('dialog-button cancel-button')
                .text(options.cancelText || 'å–æ¶ˆ');
            $footer.append($cancelButton);
        }
        const $confirmButton = $('<button>')
            .addClass('dialog-button primary-button')
            .text(options.confirmText || 'ç¡®å®š');
        $footer.append($confirmButton);
        $dialog.append($footer);
        $overlay.append($dialog);
        return { overlay: $overlay[0], dialog: $dialog[0] };
    }
    /**
     * æ˜¾ç¤ºæœ‹å‹åœˆè¯„è®º/ç‚¹èµå¯¹è¯æ¡†
     */
    showCommentDialog() {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('comment-dialog');
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>äº’åŠ¨</h3>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label for="comment-text">è¯„è®ºå†…å®¹</label>
            <textarea id="comment-text" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." rows="3"></textarea>
          </div>
        </div>
        <div class="dialog-footer">
          <button class="dialog-button cancel-btn">å–æ¶ˆ</button>
          <button class="dialog-button like-btn">ç‚¹èµ</button>
          <button class="dialog-button confirm-btn">å‘é€</button>
        </div>
      `;
            const $dialog = $(this.activeDialog);
            const $cancelBtn = $dialog.find('.cancel-btn');
            const $likeBtn = $dialog.find('.like-btn');
            const $confirmBtn = $dialog.find('.confirm-btn');
            const $commentText = $dialog.find('#comment-text');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleLike = () => {
                this.closeDialog();
                resolve({ type: 'like' });
            };
            const handleComment = () => {
                const content = $commentText.val();
                if (!content) {
                    // åœ¨è¾“å…¥æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $commentText.css('borderColor', '#ff4444');
                    $commentText.attr('placeholder', 'è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                    $commentText.trigger('focus');
                    return;
                }
                this.closeDialog();
                resolve({ type: 'comment', content });
            };
            $cancelBtn.on('click', handleCancel);
            $likeBtn.on('click', handleLike);
            $confirmBtn.on('click', handleComment);
            // é”®ç›˜äº‹ä»¶å¤„ç†
            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    // Ctrl+Enter å‘é€è¯„è®º
                    e.preventDefault();
                    handleComment();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            this.activeOverlay.appendChild(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°æ–‡æœ¬æ¡†
            setTimeout(() => {
                $commentText.trigger('focus');
            }, 100);
        }));
    }
    /**
     * æ˜¾ç¤ºè½¬è´¦å¯¹è¯æ¡†
     */
    showTransferDialog() {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('transfer-dialog');
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>è½¬è´¦</h3>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label for="transfer-amount">è½¬è´¦é‡‘é¢ *</label>
            <input type="number" id="transfer-amount" placeholder="è¯·è¾“å…¥è½¬è´¦é‡‘é¢" step="0.01" min="0.01">
          </div>
          <div class="form-group">
            <label for="transfer-note">è½¬è´¦å¤‡æ³¨</label>
            <input type="text" id="transfer-note" placeholder="è¯·è¾“å…¥è½¬è´¦å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
          </div>
        </div>
        <div class="dialog-footer">
          <button class="dialog-button cancel-btn">å–æ¶ˆ</button>
          <button class="dialog-button confirm-btn">ç¡®è®¤è½¬è´¦</button>
        </div>
      `;
            const $dialog = $(this.activeDialog);
            const $cancelBtn = $dialog.find('.cancel-btn');
            const $confirmBtn = $dialog.find('.confirm-btn');
            const $amountInput = $dialog.find('#transfer-amount');
            const $noteInput = $dialog.find('#transfer-note');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleConfirm = () => {
                const amount = $amountInput.val();
                const note = $noteInput.val();
                if (!amount || parseFloat(amount) <= 0) {
                    // åœ¨è¾“å…¥æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $amountInput.css('borderColor', '#ff4444');
                    $amountInput.attr('placeholder', 'è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
                    $amountInput.trigger('focus');
                    return;
                }
                this.closeDialog();
                resolve({ amount: parseFloat(amount).toFixed(2), note: note || '' });
            };
            $cancelBtn.on('click', handleCancel);
            $confirmBtn.on('click', handleConfirm);
            // å›è½¦é”®ç¡®è®¤
            $(document).on('keydown.transfer-dialog', (e) => {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    $(document).off('keydown.transfer-dialog');
                }
            });
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            $(this.activeOverlay).append(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°é‡‘é¢è¾“å…¥æ¡†
            setTimeout(() => {
                $amountInput.trigger('focus');
            }, 100);
        }));
    }
    /**
     * æ˜¾ç¤ºçº¢åŒ…å¯¹è¯æ¡†
     */
    showRedPacketDialog() {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('red-packet-dialog');
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>ğŸ§§ å‘é€çº¢åŒ…</h3>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label for="red-packet-amount">çº¢åŒ…é‡‘é¢ *</label>
            <input type="number" id="red-packet-amount" placeholder="è¯·è¾“å…¥çº¢åŒ…é‡‘é¢" step="0.01" min="0.01">
          </div>
          <div class="form-group">
            <label for="red-packet-note">çº¢åŒ…ç¥ç¦è¯­</label>
            <input type="text" id="red-packet-note" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼" value="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼">
          </div>
        </div>
        <div class="dialog-footer">
          <button class="dialog-button cancel-btn">å–æ¶ˆ</button>
          <button class="dialog-button confirm-btn">å‘é€çº¢åŒ…</button>
        </div>
      `;
            const $dialog = $(this.activeDialog);
            const $cancelBtn = $dialog.find('.cancel-btn');
            const $confirmBtn = $dialog.find('.confirm-btn');
            const $amountInput = $dialog.find('#red-packet-amount');
            const $noteInput = $dialog.find('#red-packet-note');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleConfirm = () => {
                const amount = $amountInput.val();
                const note = $noteInput.val();
                if (!amount || parseFloat(amount) <= 0) {
                    // åœ¨è¾“å…¥æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $amountInput.css('borderColor', '#ff4444');
                    $amountInput.attr('placeholder', 'è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…é‡‘é¢');
                    $amountInput.trigger('focus');
                    return;
                }
                this.closeDialog();
                resolve({ amount: parseFloat(amount).toFixed(2), note: note || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼' });
            };
            $cancelBtn.on('click', handleCancel);
            $confirmBtn.on('click', handleConfirm);
            // å›è½¦é”®ç¡®è®¤
            $(document).on('keydown.red-packet-dialog', (e) => {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    $(document).off('keydown.red-packet-dialog');
                }
            });
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            $(this.activeOverlay).append(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°é‡‘é¢è¾“å…¥æ¡†
            setTimeout(() => {
                $amountInput.trigger('focus');
            }, 100);
        }));
    }
    /**
     * æ˜¾ç¤ºç¤¼ç‰©å¯¹è¯æ¡†
     */
    showGiftDialog() {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('gift-dialog');
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>ğŸ å‘é€ç¤¼ç‰©</h3>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label for="gift-name">ç¤¼ç‰©åç§° *</label>
            <input type="text" id="gift-name" placeholder="è¯·è¾“å…¥ç¤¼ç‰©åç§°">
          </div>
          <div class="form-group">
            <label for="gift-price">ç¤¼ç‰©ä»·æ ¼</label>
            <input type="number" id="gift-price" placeholder="è¯·è¾“å…¥ä»·æ ¼ï¼ˆå¯é€‰ï¼‰" step="0.01" min="0">
          </div>
        </div>
        <div class="dialog-footer">
          <button class="dialog-button cancel-btn">å–æ¶ˆ</button>
          <button class="dialog-button confirm-btn">å‘é€ç¤¼ç‰©</button>
        </div>
      `;
            const cancelBtn = this.activeDialog.querySelector('.cancel-btn');
            const confirmBtn = this.activeDialog.querySelector('.confirm-btn');
            const nameInput = this.activeDialog.querySelector('#gift-name');
            const priceInput = this.activeDialog.querySelector('#gift-price');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleConfirm = () => {
                const name = nameInput.value.trim();
                const price = priceInput.value.trim();
                if (!name) {
                    // åœ¨è¾“å…¥æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $(nameInput).css('borderColor', '#ff4444');
                    $(nameInput).attr('placeholder', 'è¯·è¾“å…¥ç¤¼ç‰©åç§°');
                    $(nameInput).trigger('focus');
                    return;
                }
                this.closeDialog();
                resolve({
                    name,
                    price: price && parseFloat(price) > 0 ? parseFloat(price).toFixed(2) : undefined,
                });
            };
            cancelBtn.addEventListener('click', handleCancel);
            confirmBtn.addEventListener('click', handleConfirm);
            // å›è½¦é”®ç¡®è®¤
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            this.activeOverlay.appendChild(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
            setTimeout(() => {
                $(nameInput).trigger('focus');
            }, 100);
        }));
    }
    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥å¯¹è¯æ¡†ï¼ˆæ›¿ä»£ç³»ç»Ÿpromptï¼‰
     */
    showInputDialog(title, label, defaultValue = '', placeholder = '', inputType = 'text') {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('input-dialog');
            this.activeDialog.innerHTML = `
            <div class="dialog-header">
              <h3>${title}</h3>
            </div>
            <div class="dialog-body">
              <div class="form-group">
                <label for="input-field">${label}</label>
                <input type="${inputType}" id="input-field" placeholder="${placeholder}" value="${defaultValue}">
              </div>
            </div>
            <div class="dialog-footer">
              <button class="dialog-button cancel-btn">å–æ¶ˆ</button>
              <button class="dialog-button confirm-btn">ç¡®å®š</button>
            </div>
          `;
            const $dialog = $(this.activeDialog);
            const $cancelBtn = $dialog.find('.cancel-btn');
            const $confirmBtn = $dialog.find('.confirm-btn');
            const $inputField = $dialog.find('#input-field');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleConfirm = () => {
                const value = $inputField.val();
                this.closeDialog();
                resolve(value);
            };
            $cancelBtn.on('click', handleCancel);
            $confirmBtn.on('click', handleConfirm);
            // å›è½¦é”®ç¡®è®¤
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            this.activeOverlay.appendChild(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°è¾“å…¥æ¡†å¹¶é€‰ä¸­é»˜è®¤å€¼
            setTimeout(() => {
                $inputField.trigger('focus');
                if (defaultValue) {
                    $inputField.trigger('select');
                }
            }, 100);
        }));
    }
    /**
     * æ˜¾ç¤ºè¯­éŸ³è¾“å…¥å¯¹è¯æ¡†
     */
    showVoiceDialog() {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('voice-dialog');
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>ğŸ¤ è¯­éŸ³æ¶ˆæ¯</h3>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label for="voice-text">è¯­éŸ³å†…å®¹</label>
            <textarea id="voice-text" placeholder="è¯·è¾“å…¥è¯­éŸ³å†…å®¹..." rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="voice-duration">è¯­éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰</label>
            <input type="number" id="voice-duration" placeholder="è¯·è¾“å…¥ç§’æ•°" min="1" max="60" value="3">
          </div>
        </div>
        <div class="dialog-footer">
          <button class="dialog-button cancel-btn">å–æ¶ˆ</button>
          <button class="dialog-button confirm-btn">å‘é€</button>
        </div>
      `;
            const cancelBtn = this.activeDialog.querySelector('.cancel-btn');
            const confirmBtn = this.activeDialog.querySelector('.confirm-btn');
            const textArea = this.activeDialog.querySelector('#voice-text');
            const durationInput = this.activeDialog.querySelector('#voice-duration');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleConfirm = () => {
                const text = textArea.value.trim();
                const durationStr = durationInput.value.trim();
                if (!text) {
                    // åœ¨æ–‡æœ¬æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $(textArea).css('borderColor', '#ff4444');
                    $(textArea).attr('placeholder', 'è¯·è¾“å…¥è¯­éŸ³å†…å®¹');
                    $(textArea).trigger('focus');
                    return;
                }
                const duration = parseInt(durationStr, 10);
                if (!durationStr || isNaN(duration) || duration <= 0 || duration > 60) {
                    // åœ¨è¾“å…¥æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $(durationInput).css('borderColor', '#ff4444');
                    $(durationInput).attr('placeholder', 'è¯·è¾“å…¥æœ‰æ•ˆçš„è¯­éŸ³æ—¶é•¿ï¼ˆ1-60ç§’ï¼‰');
                    $(durationInput).trigger('focus');
                    return;
                }
                this.closeDialog();
                resolve({ text, duration });
            };
            cancelBtn.addEventListener('click', handleCancel);
            confirmBtn.addEventListener('click', handleConfirm);
            // å›è½¦é”®ç¡®è®¤ï¼ˆåœ¨textareaä¸­ä½¿ç”¨Ctrl+Enterï¼‰
            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    handleConfirm();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            this.activeOverlay.appendChild(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°æ–‡æœ¬æ¡†
            setTimeout(() => {
                $(textArea).trigger('focus');
            }, 100);
        }));
    }
    /**
     * æ˜¾ç¤ºç¤¼ç‰©/è½¬è´¦æ¥æ”¶å¯¹è¯æ¡†
     */
    showReceiveDialog(type, data) {
        return this.safeShowDialog(() => new Promise(resolve => {
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('receive-dialog');
            const isGift = type === 'gift';
            const title = isGift ? 'æ”¶åˆ°ç¤¼ç‰©' : 'æ”¶åˆ°è½¬è´¦';
            const icon = isGift ? 'ğŸ' : 'ğŸ’°';
            let content = '';
            if (isGift) {
                content = `
          <div class="receive-content">
            <div class="receive-icon">${icon}</div>
            <div class="receive-info">
              <div class="receive-title">${data.name}</div>
              ${data.price ? `<div class="receive-price">Â¥${data.price}</div>` : ''}
              ${data.note ? `<div class="receive-note">${data.note}</div>` : ''}
            </div>
          </div>
        `;
            }
            else {
                content = `
          <div class="receive-content">
            <div class="receive-icon">${icon}</div>
            <div class="receive-info">
              <div class="receive-title">è½¬è´¦é‡‘é¢</div>
              <div class="receive-price">Â¥${data.amount}</div>
              ${data.note ? `<div class="receive-note">${data.note}</div>` : ''}
            </div>
          </div>
        `;
            }
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>${title}</h3>
        </div>
        <div class="dialog-body">
          ${content}
        </div>
        <div class="dialog-footer">
          <button class="dialog-button reject-btn">æ‹’ç»</button>
          <button class="dialog-button accept-btn">æ¥æ”¶</button>
        </div>
      `;
            const rejectBtn = this.activeDialog.querySelector('.reject-btn');
            const acceptBtn = this.activeDialog.querySelector('.accept-btn');
            const handleReject = () => {
                this.closeDialog();
                resolve('reject');
            };
            const handleAccept = () => {
                this.closeDialog();
                resolve('accept');
            };
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            rejectBtn.addEventListener('click', handleReject);
            acceptBtn.addEventListener('click', handleAccept);
            // é”®ç›˜äº‹ä»¶å¤„ç†
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    // Enteré”®æ¥å—è½¬è´¦/ç¤¼ç‰©
                    e.preventDefault();
                    handleAccept();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            this.activeOverlay.appendChild(this.activeDialog);
            this.appendDialogToPage();
        }));
    }
    /**
     * æ˜¾ç¤ºæœ‹å‹åœˆå‘å¸ƒå¯¹è¯æ¡†
     */
    showMomentDialog(defaultTime) {
        return this.safeShowDialog(() => new Promise(resolve => {
            const currentDate = window.currentGameDate || new Date();
            const defaultDateTime = defaultTime ||
                `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate
                    .getDate()
                    .toString()
                    .padStart(2, '0')} ${currentDate.getHours().toString().padStart(2, '0')}:${currentDate
                    .getMinutes()
                    .toString()
                    .padStart(2, '0')}`;
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('moment-dialog');
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>å‘å¸ƒæœ‹å‹åœˆ</h3>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label for="moment-text">è¿™ä¸€åˆ»çš„æƒ³æ³•...</label>
            <textarea id="moment-text" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>ğŸ“· å›¾ç‰‡ç±»å‹</label>
            <div class="radio-group">
              <label><input type="radio" name="image-type" value="desc" checked> å›¾ç‰‡æè¿°</label>
              <label><input type="radio" name="image-type" value="url"> å›¾ç‰‡é“¾æ¥</label>
            </div>
          </div>

          <div class="form-group">
            <label for="image-content" id="image-content-label">å›¾ç‰‡æè¿°ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="image-content" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°...ï¼ˆå¯é€‰ï¼‰">
          </div>

          <div class="form-group url-desc-group" style="display: none;">
            <label for="image-desc">å›¾ç‰‡æè¿°ï¼ˆä¾›AIè¯†åˆ«ï¼Œå¯é€‰ï¼‰</label>
            <input type="text" id="image-desc" placeholder="æè¿°å›¾ç‰‡å†…å®¹ï¼Œä»…ä¾›AIè¯†åˆ«...ï¼ˆå¯é€‰ï¼‰">
          </div>

          <div class="form-group">
            <label for="moment-datetime">å‘å¸ƒæ—¶é—´</label>
            <input type="text" id="moment-datetime" value="${defaultDateTime}" placeholder="YYYY-MM-DD HH:MM">
          </div>
        </div>
        <div class="dialog-footer">
          <button class="dialog-btn dialog-btn-cancel">å–æ¶ˆ</button>
          <button class="dialog-btn dialog-btn-confirm">å‘å¸ƒ</button>
        </div>
      `;
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const imageTypeRadios = this.activeDialog.querySelectorAll('input[name="image-type"]');
            const imageContentLabel = this.activeDialog.querySelector('#image-content-label');
            const imageContentInput = this.activeDialog.querySelector('#image-content');
            const urlDescGroup = this.activeDialog.querySelector('.url-desc-group');
            // åˆå§‹åŒ–checkboxæŒ‰é’®æ ·å¼ï¼ˆå¦‚æœæœ‰å…¶ä»–checkboxçš„è¯ï¼‰
            this.initializeCheckboxButtons();
            // å›¾ç‰‡ç±»å‹åˆ‡æ¢
            imageTypeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const isDesc = radio.value === 'desc';
                    imageContentLabel.textContent = isDesc ? 'å›¾ç‰‡æè¿°ï¼ˆå¯é€‰ï¼‰' : 'å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰';
                    imageContentInput.placeholder = isDesc ? 'è¯·è¾“å…¥å›¾ç‰‡æè¿°...ï¼ˆå¯é€‰ï¼‰' : 'è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥...ï¼ˆå¯é€‰ï¼‰';
                    urlDescGroup.style.display = isDesc ? 'none' : 'block';
                });
            });
            // æŒ‰é’®äº‹ä»¶
            const cancelBtn = this.activeDialog.querySelector('.dialog-btn-cancel');
            const confirmBtn = this.activeDialog.querySelector('.dialog-btn-confirm');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleConfirm = () => {
                // æ£€æŸ¥å¯¹è¯æ¡†æ˜¯å¦è¿˜å­˜åœ¨
                if (!this.activeDialog) {
                    return;
                }
                const textArea = this.activeDialog.querySelector('#moment-text');
                const imageTypeInput = this.activeDialog.querySelector('input[name="image-type"]:checked');
                const imageContentField = this.activeDialog.querySelector('#image-content');
                const imageDescField = this.activeDialog.querySelector('#image-desc');
                const datetimeInput = this.activeDialog.querySelector('#moment-datetime');
                if (!textArea || !datetimeInput) {
                    return;
                }
                const text = textArea.value;
                const imageContent = imageContentField ? imageContentField.value.trim() : '';
                const hasImage = imageContent !== '';
                const imageType = hasImage && imageTypeInput ? imageTypeInput.value : 'none';
                const imageDesc = imageType === 'url' && imageDescField ? imageDescField.value.trim() : imageContent;
                const datetime = datetimeInput.value;
                // éªŒè¯è¾“å…¥
                if ((!text || text.trim() === '') && (!imageContent || imageContent.trim() === '')) {
                    // åœ¨æ–‡æœ¬æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $(textArea).css('borderColor', '#ff4444');
                    $(textArea).attr('placeholder', 'è¯·è¾“å…¥æœ‹å‹åœˆå†…å®¹æˆ–æ·»åŠ å›¾ç‰‡');
                    $(textArea).trigger('focus');
                    return;
                }
                // è§£ææ—¶é—´
                const datetimeMatch = datetime.match(/^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2})$/);
                if (!datetimeMatch) {
                    // åœ¨æ—¶é—´è¾“å…¥æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $(datetimeInput).css('borderColor', '#ff4444');
                    $(datetimeInput).attr('placeholder', 'æ ¼å¼ï¼šYYYY-MM-DD HH:MM');
                    $(datetimeInput).trigger('focus');
                    return;
                }
                this.closeDialog();
                resolve({
                    text: text.trim(),
                    image: imageContent.trim(),
                    image_type: imageType,
                    image_desc: imageDesc.trim(),
                    date: datetimeMatch[1],
                    time: datetimeMatch[2],
                });
            };
            cancelBtn.addEventListener('click', handleCancel);
            confirmBtn.addEventListener('click', handleConfirm);
            // é”®ç›˜äº‹ä»¶å¤„ç†
            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    // Ctrl+Enter å‘å¸ƒæœ‹å‹åœˆ
                    e.preventDefault();
                    handleConfirm();
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            this.activeOverlay.appendChild(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°æ–‡æœ¬æ¡†
            setTimeout(() => {
                if (this.activeDialog) {
                    const $textArea = $(this.activeDialog).find('#moment-text');
                    if ($textArea.length) {
                        $textArea.trigger('focus');
                    }
                }
            }, 100);
        }));
    }
    /**
     * æ˜¾ç¤ºæ—¶é—´è·³è·ƒå¯¹è¯æ¡†
     */
    showTimeJumpDialog(defaultTime) {
        return this.safeShowDialog(() => new Promise(resolve => {
            const currentDate = window.currentGameDate || new Date();
            const defaultDateTime = defaultTime ||
                `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate
                    .getDate()
                    .toString()
                    .padStart(2, '0')} ${currentDate.getHours().toString().padStart(2, '0')}:${currentDate
                    .getMinutes()
                    .toString()
                    .padStart(2, '0')}`;
            // åˆ›å»ºåŸºç¡€å¯¹è¯æ¡†å…ƒç´ 
            this.createBaseDialogElements('time-jump-dialog');
            this.activeDialog.innerHTML = `
        <div class="dialog-header">
          <h3>æ—¶é—´è·³è·ƒ</h3>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label for="jump-datetime">è·³è·ƒåˆ°æ—¶é—´</label>
            <input type="text" id="jump-datetime" value="${defaultDateTime}" placeholder="YYYY-MM-DD HH:MM">
          </div>

          <div class="form-group">
            <label for="event-description">ğŸ“ è®°å½•è¿™æ®µæ—¶é—´å‘ç”Ÿäº†ä»€ä¹ˆ</label>
            <textarea id="event-description" placeholder="æè¿°è¿™æ®µæ—¶é—´å‘ç”Ÿçš„äº‹æƒ…...ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
          </div>
        </div>
        <div class="dialog-footer">
          <button class="dialog-btn dialog-btn-cancel">å–æ¶ˆ</button>
          <button class="dialog-btn dialog-btn-confirm">è·³è·ƒ</button>
        </div>
      `;
            // åˆå§‹åŒ–checkboxæŒ‰é’®æ ·å¼ï¼ˆå¦‚æœæœ‰å…¶ä»–checkboxçš„è¯ï¼‰
            this.initializeCheckboxButtons();
            // æŒ‰é’®äº‹ä»¶
            const cancelBtn = this.activeDialog.querySelector('.dialog-btn-cancel');
            const confirmBtn = this.activeDialog.querySelector('.dialog-btn-confirm');
            const handleCancel = () => {
                this.closeDialog();
                resolve(null);
            };
            const handleConfirm = () => {
                // æ£€æŸ¥å¯¹è¯æ¡†æ˜¯å¦è¿˜å­˜åœ¨
                if (!this.activeDialog) {
                    return;
                }
                const datetimeInput = this.activeDialog.querySelector('#jump-datetime');
                const descriptionInput = this.activeDialog.querySelector('#event-description');
                if (!datetimeInput) {
                    return;
                }
                const datetime = datetimeInput.value;
                const description = descriptionInput ? descriptionInput.value.trim() : '';
                // è§£ææ—¶é—´
                const datetimeMatch = datetime.match(/^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2})$/);
                if (!datetimeMatch) {
                    // åœ¨æ—¶é—´è¾“å…¥æ¡†ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ–°çš„alert
                    $(datetimeInput).css('borderColor', '#ff4444');
                    $(datetimeInput).attr('placeholder', 'æ ¼å¼ï¼šYYYY-MM-DD HH:MM');
                    $(datetimeInput).trigger('focus');
                    return;
                }
                this.closeDialog();
                resolve({
                    date: datetimeMatch[1],
                    time: datetimeMatch[2],
                    description: description, // å¯ä»¥ä¸ºç©ºå­—ç¬¦ä¸²
                });
            };
            cancelBtn.addEventListener('click', handleCancel);
            confirmBtn.addEventListener('click', handleConfirm);
            // é”®ç›˜äº‹ä»¶å¤„ç†
            const handleKeyDown = (e) => {
                // æ£€æŸ¥å¯¹è¯æ¡†æ˜¯å¦è¿˜å­˜åœ¨
                if (!this.activeDialog) {
                    document.removeEventListener('keydown', handleKeyDown);
                    return;
                }
                if (e.key === 'Enter') {
                    // Enteré”®ç¡®è®¤æ—¶é—´è·³è½¬
                    e.preventDefault();
                    handleConfirm();
                    document.removeEventListener('keydown', handleKeyDown);
                }
                else if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…
            this.activeOverlay.appendChild(this.activeDialog);
            this.appendDialogToPage();
            // èšç„¦åˆ°æ—¶é—´è¾“å…¥æ¡†
            setTimeout(() => {
                if (this.activeDialog) {
                    const $timeInput = $(this.activeDialog).find('#jump-datetime');
                    if ($timeInput.length) {
                        $timeInput.trigger('focus');
                        $timeInput.trigger('select');
                    }
                }
            }, 100);
        }));
    }
    /**
     * å¼ºåˆ¶æ¸…ç†æ‰€æœ‰å¯¹è¯æ¡†å…ƒç´ 
     */
    forceCleanupDialogs() {
        // æ¸…ç†æ‰€æœ‰å¯èƒ½æ®‹ç•™çš„å¯¹è¯æ¡†å…ƒç´ 
        const $container = $('.phone-screen').length ? $('.phone-screen') : $('body');
        // ä½¿ç”¨é€šç”¨é€‰æ‹©å™¨æ¸…ç†æ‰€æœ‰å¯¹è¯æ¡†ç›¸å…³å…ƒç´ 
        const selectors = [
            '[class*="dialog-overlay"]',
            '[class*="dialog"]',
            '.custom-dialog-overlay',
            '.mobile-dialog-overlay',
            '.custom-dialog',
            '.mobile-dialog',
        ];
        selectors.forEach(selector => {
            $container.find(selector).each((_, element) => {
                try {
                    $(element).remove();
                }
                catch (error) {
                    console.warn('ç§»é™¤å¯¹è¯æ¡†å…ƒç´ æ—¶å‡ºé”™:', error);
                }
            });
        });
        // æ¸…ç†å¼•ç”¨
        this.activeDialog = null;
        this.activeOverlay = null;
    }
    /**
     * å…³é—­å¯¹è¯æ¡†
     */
    closeDialog() {
        this.forceCleanupDialogs();
    }
}


/***/ })

/******/ });
/************************************************************************/
/******/ // The module cache
/******/ var __webpack_module_cache__ = {};
/******/ 
/******/ // The require function
/******/ function __webpack_require__(moduleId) {
/******/ 	// Check if module is in cache
/******/ 	var cachedModule = __webpack_module_cache__[moduleId];
/******/ 	if (cachedModule !== undefined) {
/******/ 		return cachedModule.exports;
/******/ 	}
/******/ 	// Create a new module (and put it into the cache)
/******/ 	var module = __webpack_module_cache__[moduleId] = {
/******/ 		// no module.id needed
/******/ 		// no module.loaded needed
/******/ 		exports: {}
/******/ 	};
/******/ 
/******/ 	// Execute the module function
/******/ 	__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 
/******/ 	// Return the exports of the module
/******/ 	return module.exports;
/******/ }
/******/ 
/************************************************************************/
/******/ /* webpack/runtime/define property getters */
/******/ (() => {
/******/ 	// define getter functions for harmony exports
/******/ 	__webpack_require__.d = (exports, definition) => {
/******/ 		for(var key in definition) {
/******/ 			if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 				Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 			}
/******/ 		}
/******/ 	};
/******/ })();
/******/ 
/******/ /* webpack/runtime/hasOwnProperty shorthand */
/******/ (() => {
/******/ 	__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ })();
/******/ 
/************************************************************************/
var __webpack_exports__ = {};

;// ./src/åŒå±‚æ‰‹æœº/debug-logger.ts
/**
 * ç»Ÿä¸€çš„è°ƒè¯•æ—¥å¿—å·¥å…·
 * ç”¨äºæ›¿ä»£æ•£å¸ƒåœ¨å„å¤„çš„ console.log è°ƒè¯•ä»£ç 
 */
var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["DEBUG"] = 0] = "DEBUG";
    LogLevel[LogLevel["INFO"] = 1] = "INFO";
    LogLevel[LogLevel["WARN"] = 2] = "WARN";
    LogLevel[LogLevel["ERROR"] = 3] = "ERROR";
})(LogLevel || (LogLevel = {}));
class DebugLogger {
    static instance;
    isDevelopment;
    logLevel;
    logHistory = [];
    maxHistorySize = 1000;
    constructor() {
        // æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘æ¨¡å¼
        this.isDevelopment = this.checkDevelopmentMode();
        this.logLevel = this.isDevelopment ? LogLevel.DEBUG : LogLevel.ERROR;
    }
    static getInstance() {
        if (!DebugLogger.instance) {
            DebugLogger.instance = new DebugLogger();
        }
        return DebugLogger.instance;
    }
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘æ¨¡å¼
     */
    checkDevelopmentMode() {
        // æ£€æŸ¥å¤šç§å¼€å‘æ¨¡å¼æ ‡è¯†
        return !!(window.BLMX_DEV_MODE ||
            window.DEBUG ||
            localStorage.getItem('blmx_debug') === 'true' ||
            location.hostname === 'localhost' ||
            location.hostname === '127.0.0.1' ||
            location.search.includes('debug=true'));
    }
    /**
     * è®¾ç½®æ—¥å¿—çº§åˆ«
     */
    setLogLevel(level) {
        this.logLevel = level;
    }
    /**
     * å¯ç”¨/ç¦ç”¨å¼€å‘æ¨¡å¼
     */
    setDevelopmentMode(enabled) {
        this.isDevelopment = enabled;
        if (enabled) {
            localStorage.setItem('blmx_debug', 'true');
        }
        else {
            localStorage.removeItem('blmx_debug');
        }
    }
    /**
     * è®°å½•æ—¥å¿—åˆ°å†å²
     */
    addToHistory(level, module, message, data) {
        this.logHistory.push({
            timestamp: new Date(),
            level,
            module,
            message,
            data,
        });
        // é™åˆ¶å†å²è®°å½•å¤§å°
        if (this.logHistory.length > this.maxHistorySize) {
            this.logHistory.shift();
        }
    }
    /**
     * æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
     */
    formatMessage(module, message) {
        const timestamp = new Date().toISOString().substr(11, 12);
        return `[${timestamp}] [BLMX:${module}] ${message}`;
    }
    /**
     * è°ƒè¯•æ—¥å¿—
     */
    debug(module, message, data) {
        if (this.logLevel <= LogLevel.DEBUG && this.isDevelopment) {
            console.log(this.formatMessage(module, message), data || '');
            this.addToHistory(LogLevel.DEBUG, module, message, data);
        }
    }
    /**
     * ä¿¡æ¯æ—¥å¿—
     */
    info(module, message, data) {
        if (this.logLevel <= LogLevel.INFO && this.isDevelopment) {
            console.info(this.formatMessage(module, message), data || '');
            this.addToHistory(LogLevel.INFO, module, message, data);
        }
    }
    /**
     * è­¦å‘Šæ—¥å¿—
     */
    warn(module, message, data) {
        if (this.logLevel <= LogLevel.WARN) {
            console.warn(this.formatMessage(module, message), data || '');
            this.addToHistory(LogLevel.WARN, module, message, data);
        }
    }
    /**
     * é”™è¯¯æ—¥å¿—ï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼‰
     */
    error(module, message, data) {
        console.error(this.formatMessage(module, message), data || '');
        this.addToHistory(LogLevel.ERROR, module, message, data);
    }
    /**
     * æ€§èƒ½æµ‹é‡å¼€å§‹
     */
    timeStart(module, label) {
        if (this.isDevelopment) {
            console.time(this.formatMessage(module, label));
        }
    }
    /**
     * æ€§èƒ½æµ‹é‡ç»“æŸ
     */
    timeEnd(module, label) {
        if (this.isDevelopment) {
            console.timeEnd(this.formatMessage(module, label));
        }
    }
    /**
     * åˆ†ç»„æ—¥å¿—å¼€å§‹
     */
    groupStart(module, title) {
        if (this.isDevelopment) {
            console.group(this.formatMessage(module, title));
        }
    }
    /**
     * åˆ†ç»„æ—¥å¿—ç»“æŸ
     */
    groupEnd() {
        if (this.isDevelopment) {
            console.groupEnd();
        }
    }
    /**
     * è·å–æ—¥å¿—å†å²
     */
    getHistory(filterModule, filterLevel) {
        let filtered = this.logHistory;
        if (filterModule) {
            filtered = filtered.filter(log => log.module === filterModule);
        }
        if (filterLevel !== undefined) {
            filtered = filtered.filter(log => log.level >= filterLevel);
        }
        return filtered;
    }
    /**
     * æ¸…ç©ºæ—¥å¿—å†å²
     */
    clearHistory() {
        this.logHistory = [];
    }
    /**
     * å¯¼å‡ºæ—¥å¿—å†å²ä¸ºJSON
     */
    exportHistory() {
        return JSON.stringify(this.logHistory, null, 2);
    }
    /**
     * æ˜¾ç¤ºè°ƒè¯•é¢æ¿ï¼ˆå¦‚æœåœ¨å¼€å‘æ¨¡å¼ï¼‰
     */
    showDebugPanel() {
        if (!this.isDevelopment) {
            console.warn('è°ƒè¯•é¢æ¿ä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯ç”¨');
            return;
        }
        console.group('ğŸ› BLMX è°ƒè¯•ä¿¡æ¯');
        console.log('å¼€å‘æ¨¡å¼:', this.isDevelopment);
        console.log('æ—¥å¿—çº§åˆ«:', LogLevel[this.logLevel]);
        console.log('å†å²è®°å½•æ•°é‡:', this.logHistory.length);
        if (this.logHistory.length > 0) {
            console.log('æœ€è¿‘çš„æ—¥å¿—:');
            this.logHistory.slice(-10).forEach(log => {
                const levelIcon = ['ğŸ”', 'â„¹ï¸', 'âš ï¸', 'âŒ'][log.level];
                console.log(`${levelIcon} [${log.module}] ${log.message}`, log.data || '');
            });
        }
        console.groupEnd();
    }
    /**
     * è·å–å½“å‰çŠ¶æ€
     */
    getStatus() {
        return {
            isDevelopment: this.isDevelopment,
            logLevel: LogLevel[this.logLevel],
            historyCount: this.logHistory.length,
        };
    }
}
// åˆ›å»ºå…¨å±€å®ä¾‹
const debug_logger_logger = DebugLogger.getInstance();
// åœ¨å¼€å‘æ¨¡å¼ä¸‹æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œæ–¹ä¾¿è°ƒè¯•
if (typeof window !== 'undefined' && debug_logger_logger.getStatus().isDevelopment) {
    window.blmxLogger = debug_logger_logger;
}

;// ./src/åŒå±‚æ‰‹æœº/event-manager.ts
/**
 * äº‹ä»¶ç®¡ç†å™¨
 * ç»Ÿä¸€ç®¡ç†å…¨å±€äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
 */
class EventManager {
    listeners = [];
    timers = new Set();
    intervals = new Set();
    isDestroyed = false;
    /**
     * æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨
     * @param event äº‹ä»¶åç§°
     * @param handler äº‹ä»¶å¤„ç†å‡½æ•°
     * @returns æ¸…ç†å‡½æ•°
     */
    addGlobalListener(event, handler) {
        if (this.isDestroyed) {
            console.warn('[EventManager] å°è¯•åœ¨å·²é”€æ¯çš„ç®¡ç†å™¨ä¸Šæ·»åŠ ç›‘å¬å™¨');
            return () => { };
        }
        const cleanup = window.eventOn(event, handler);
        if (cleanup && typeof cleanup === 'function') {
            this.listeners.push(cleanup);
            return cleanup;
        }
        else {
            console.warn(`[EventManager] æ— æ³•ä¸ºäº‹ä»¶ ${event} åˆ›å»ºæ¸…ç†å‡½æ•°`);
            return () => { };
        }
    }
    /**
     * æ·»åŠ DOMäº‹ä»¶ç›‘å¬å™¨
     * @param element DOMå…ƒç´ 
     * @param event äº‹ä»¶ç±»å‹
     * @param handler äº‹ä»¶å¤„ç†å‡½æ•°
     * @param options äº‹ä»¶é€‰é¡¹
     */
    addDOMListener(element, event, handler, options) {
        if (this.isDestroyed) {
            console.warn('[EventManager] å°è¯•åœ¨å·²é”€æ¯çš„ç®¡ç†å™¨ä¸Šæ·»åŠ DOMç›‘å¬å™¨');
            return;
        }
        element.addEventListener(event, handler, options);
        // åˆ›å»ºæ¸…ç†å‡½æ•°
        const cleanup = () => {
            element.removeEventListener(event, handler, options);
        };
        this.listeners.push(cleanup);
    }
    /**
     * å®‰å…¨çš„setTimeout
     * @param callback å›è°ƒå‡½æ•°
     * @param delay å»¶è¿Ÿæ—¶é—´
     * @returns å®šæ—¶å™¨ID
     */
    setTimeout(callback, delay) {
        if (this.isDestroyed) {
            console.warn('[EventManager] å°è¯•åœ¨å·²é”€æ¯çš„ç®¡ç†å™¨ä¸Šåˆ›å»ºå®šæ—¶å™¨');
            return -1;
        }
        const timerId = window.setTimeout(() => {
            this.timers.delete(timerId);
            try {
                callback();
            }
            catch (error) {
                console.error('[EventManager] å®šæ—¶å™¨å›è°ƒæ‰§è¡Œé”™è¯¯:', error);
            }
        }, delay);
        this.timers.add(timerId);
        return timerId;
    }
    /**
     * å®‰å…¨çš„setInterval
     * @param callback å›è°ƒå‡½æ•°
     * @param interval é—´éš”æ—¶é—´
     * @returns å®šæ—¶å™¨ID
     */
    setInterval(callback, interval) {
        if (this.isDestroyed) {
            console.warn('[EventManager] å°è¯•åœ¨å·²é”€æ¯çš„ç®¡ç†å™¨ä¸Šåˆ›å»ºé—´éš”å®šæ—¶å™¨');
            return -1;
        }
        const intervalId = window.setInterval(() => {
            try {
                callback();
            }
            catch (error) {
                console.error('[EventManager] é—´éš”å®šæ—¶å™¨å›è°ƒæ‰§è¡Œé”™è¯¯:', error);
            }
        }, interval);
        this.intervals.add(intervalId);
        return intervalId;
    }
    /**
     * æ¸…é™¤æŒ‡å®šçš„å®šæ—¶å™¨
     * @param timerId å®šæ—¶å™¨ID
     */
    clearTimeout(timerId) {
        if (this.timers.has(timerId)) {
            window.clearTimeout(timerId);
            this.timers.delete(timerId);
        }
    }
    /**
     * æ¸…é™¤æŒ‡å®šçš„é—´éš”å®šæ—¶å™¨
     * @param intervalId é—´éš”å®šæ—¶å™¨ID
     */
    clearInterval(intervalId) {
        if (this.intervals.has(intervalId)) {
            window.clearInterval(intervalId);
            this.intervals.delete(intervalId);
        }
    }
    /**
     * æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨å’Œå®šæ—¶å™¨
     */
    cleanup() {
        if (this.isDestroyed) {
            return;
        }
        // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
        this.listeners.forEach(cleanup => {
            try {
                cleanup();
            }
            catch (error) {
                console.error('[EventManager] æ¸…ç†ç›‘å¬å™¨æ—¶å‡ºé”™:', error);
            }
        });
        this.listeners = [];
        // æ¸…ç†å®šæ—¶å™¨
        this.timers.forEach(timerId => {
            window.clearTimeout(timerId);
        });
        this.timers.clear();
        // æ¸…ç†é—´éš”å®šæ—¶å™¨
        this.intervals.forEach(intervalId => {
            window.clearInterval(intervalId);
        });
        this.intervals.clear();
        this.isDestroyed = true;
        //console.log('[EventManager] æ‰€æœ‰èµ„æºå·²æ¸…ç†');
    }
    /**
     * è·å–å½“å‰çŠ¶æ€ä¿¡æ¯
     */
    getStatus() {
        return {
            listenersCount: this.listeners.length,
            timersCount: this.timers.size,
            intervalsCount: this.intervals.size,
            isDestroyed: this.isDestroyed,
        };
    }
    /**
     * æ£€æŸ¥æ˜¯å¦å·²é”€æ¯
     */
    isDestroyed_() {
        return this.isDestroyed;
    }
}
/**
 * å…¨å±€äº‹ä»¶ç®¡ç†å™¨å®ä¾‹
 * ç”¨äºç®¡ç†åº”ç”¨çº§åˆ«çš„äº‹ä»¶ç›‘å¬å™¨
 */
const globalEventManager = new EventManager();
/**
 * åœ¨é¡µé¢å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†å…¨å±€äº‹ä»¶ç®¡ç†å™¨
 */
if (typeof window !== 'undefined') {
    window.addEventListener('beforeunload', () => {
        globalEventManager.cleanup();
    });
}

;// ./src/åŒå±‚æ‰‹æœº/script.ts
// ä¸ºTavernHelperåˆ›å»ºä¸€ä¸ªè®¿é—®å™¨å‡½æ•°
function getTavernHelper() {
    return window.parent.TavernHelper;
}
class BLMX_Protocol {
    logEntries = [];
    messageId = null;
    charId;
    LOG_START_TAG = '===BLMX_LOG_BEGIN===';
    LOG_END_TAG = '===BLMX_LOG_END===';
    constructor(charId) {
        this.charId = charId;
    }
    // è·å–è§’è‰²ID
    getCharId() {
        return this.charId;
    }
    async initialize() {
        // console.log('[BLMX] Initializing and scanning for chat history...');
        const lastMessageId = await getTavernHelper().getLastMessageId();
        if (lastMessageId === null) {
            // console.warn('[BLMX] No messages found. Starting fresh at message ID 0.');
            this.messageId = 0;
            this.logEntries = [];
            await this.persistLogToStorage();
            return true;
        }
        let latestUiMessage = null;
        const previousUiMessages = [];
        for (let i = lastMessageId; i >= 0; i--) {
            try {
                const msg = (await getTavernHelper().getChatMessages(i))[0];
                if (msg && msg.message && msg.message.includes(this.LOG_START_TAG)) {
                    if (!latestUiMessage) {
                        latestUiMessage = { id: i, content: msg.message };
                    }
                    else {
                        previousUiMessages.push({ id: i, content: msg.message });
                    }
                }
            }
            catch (error) {
                // Ignore errors, likely message not found
            }
        }
        if (!latestUiMessage) {
            // console.log('[BLMX] No UI log found. Creating a new one in the latest message.');
            this.messageId = lastMessageId;
            this.logEntries = [];
            await this.persistLogToStorage();
            return true;
        }
        // console.log(`[BLMX] Found latest UI log in message ${latestUiMessage.id}. Consolidating...`);
        this.messageId = latestUiMessage.id;
        const consolidatedLogParts = [];
        const latestLogStartIndex = latestUiMessage.content.indexOf(this.LOG_START_TAG);
        const latestLogEndIndex = latestUiMessage.content.indexOf(this.LOG_END_TAG);
        if (latestLogStartIndex !== -1 && latestLogEndIndex !== -1) {
            const logPart = latestUiMessage.content
                .slice(latestLogStartIndex + this.LOG_START_TAG.length, latestLogEndIndex)
                .trim();
            if (logPart)
                consolidatedLogParts.push(logPart);
        }
        for (const prevMsg of previousUiMessages) {
            const prevLogStartIndex = prevMsg.content.indexOf(this.LOG_START_TAG);
            const prevLogEndIndex = prevMsg.content.indexOf(this.LOG_END_TAG);
            if (prevLogStartIndex !== -1 && prevLogEndIndex !== -1) {
                const logPart = prevMsg.content.slice(prevLogStartIndex + this.LOG_START_TAG.length, prevLogEndIndex).trim();
                if (logPart)
                    consolidatedLogParts.unshift(logPart);
                const cleanedContent = prevMsg.content.substring(0, prevLogStartIndex) +
                    prevMsg.content.substring(prevLogEndIndex + this.LOG_END_TAG.length);
                await getTavernHelper().setChatMessage(cleanedContent.trim(), prevMsg.id, { refresh: 'none' });
                // console.log(`[BLMX] Cleaned and moved UI log from message ${prevMsg.id}.`);
            }
        }
        const finalLogString = consolidatedLogParts.join('\n');
        this._parseLogFromString(finalLogString);
        await this.persistLogToStorage();
        // console.log(`[BLMX] Consolidated log saved to message ${this.messageId}.`);
        return true;
    }
    async persistLogToStorage() {
        if (this.messageId === null) {
            console.warn('[BLMX] Cannot save log, message_id not initialized.'); // ä¿ç•™é‡è¦è­¦å‘Š
            return;
        }
        try {
            const logString = this._renderLogToString();
            const existingMessage = (await getTavernHelper().getChatMessages(this.messageId))[0];
            const existingContent = existingMessage ? existingMessage.message : '';
            const logStartIndex = existingContent.indexOf(this.LOG_START_TAG);
            const logEndIndex = existingContent.indexOf(this.LOG_END_TAG);
            const newLogBlock = `${this.LOG_START_TAG}\n${logString}\n${this.LOG_END_TAG}`;
            let fullText;
            if (logStartIndex !== -1 && logEndIndex !== -1) {
                fullText =
                    existingContent.substring(0, logStartIndex) +
                        newLogBlock +
                        existingContent.substring(logEndIndex + this.LOG_END_TAG.length);
            }
            else {
                fullText = existingContent + '\n' + newLogBlock;
            }
            await getTavernHelper().setChatMessage(fullText.trim(), this.messageId, { refresh: 'none' });
        }
        catch (error) {
            console.error('Failed to save narrative log to text box:', error);
        }
    }
    _parseLogFromString(logString) {
        this.logEntries = [];
        const lines = logString.split('\n').filter(line => line.trim() !== '');
        lines.forEach(line => {
            const separatorIndex = line.indexOf(':');
            if (separatorIndex === -1)
                return;
            const key = line.substring(0, separatorIndex).trim();
            const value = line.substring(separatorIndex + 1).trim();
            try {
                switch (key) {
                    case 'USER_MOMENT':
                    case 'CHAR_MOMENT':
                    case 'USER_COMMENT':
                    case 'CHAR_COMMENT':
                    case 'USER_LIKE':
                    case 'CHAR_LIKE':
                        try {
                            const data = JSON.parse(value);
                            this.logEntries.push({ key, data });
                        }
                        catch (error) {
                            console.warn('[BLMX] è§£ææœ‹å‹åœˆæ•°æ®å¤±è´¥:', value, error);
                        }
                        break;
                    case 'TIME':
                    case 'EVENT_LOG':
                        if (value) {
                            try {
                                const data = JSON.parse(value);
                                // console.log(`[BLMX] è§£æ${key}æ•°æ®:`, data);
                                // éªŒè¯å¿…è¦å­—æ®µ
                                if (!data.date || !data.time) {
                                    console.warn(`[BLMX] ${key}ç¼ºå°‘å¿…è¦å­—æ®µ:`, data);
                                    // å°è¯•è¡¥å……ç¼ºå¤±å­—æ®µ
                                    if (!data.date || !data.time) {
                                        const now = new Date();
                                        if (!data.date) {
                                            data.date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                                            // console.log(`[BLMX] ä¸º${key}è¡¥å……æ—¥æœŸ:`, data.date);
                                        }
                                        if (!data.time) {
                                            data.time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                                            // console.log(`[BLMX] ä¸º${key}è¡¥å……æ—¶é—´:`, data.time);
                                        }
                                    }
                                }
                                const entryType = key === 'TIME' ? 'time' : 'event';
                                const newEntry = { type: entryType, content: data };
                                this.logEntries.push(newEntry);
                                // console.log(`[BLMX] æ·»åŠ ${key}æ¡ç›®:`, newEntry);
                                const timeDate = new Date(`${data.date} ${data.time}`);
                                if (!isNaN(timeDate.getTime())) {
                                    window.currentGameDate = timeDate;
                                    const timeElement = document.getElementById('current-time');
                                    if (timeElement) {
                                        const timeString = `${window.currentGameDate
                                            .getHours()
                                            .toString()
                                            .padStart(2, '0')}:${window.currentGameDate.getMinutes().toString().padStart(2, '0')}`;
                                        timeElement.textContent = timeString;
                                    }
                                }
                            }
                            catch (error) {
                                console.error(`[BLMX] è§£æ${key}å¤±è´¥:`, value, error);
                            }
                        }
                        else {
                            // console.warn(`[BLMX] ${key}å€¼ä¸ºç©º`);
                        }
                        break;
                    case 'RECALL': {
                        // console.log('[BLMX] ä»å­˜å‚¨ä¸­åŠ è½½RECALLæ•°æ®:', value);
                        try {
                            const recallData = JSON.parse(value);
                            const senderToFind = recallData.sender === 'USER' ? 'me' : 'them';
                            // è·å–target_textï¼Œæ”¯æŒå¤šç§å¯èƒ½çš„å±æ€§å
                            const targetText = recallData.target_text || recallData['target text'] || recallData.text || '';
                            if (!targetText) {
                                console.warn('[BLMX] RECALLæ•°æ®ç¼ºå°‘ç›®æ ‡æ–‡æœ¬:', recallData);
                                break;
                            }
                            // ä½¿ç”¨æ›´çµæ´»çš„æŸ¥æ‰¾æ–¹æ³•
                            const entryToRecall = this.logEntries
                                .slice()
                                .reverse()
                                .find(e => {
                                // å¿…é¡»æ˜¯æœ‰senderå’Œcontentçš„æ¶ˆæ¯
                                if (!('sender' in e) || e.sender !== senderToFind || !('content' in e)) {
                                    return false;
                                }
                                // ç²¾ç¡®åŒ¹é…
                                if (e.content === targetText) {
                                    return true;
                                }
                                // æ¨¡ç³ŠåŒ¹é…ï¼ˆå»é™¤æ ‡ç‚¹ç¬¦å·å’Œç©ºæ ¼åæ¯”è¾ƒï¼‰
                                const normalizeText = (text) => typeof text === 'string' ? text.replace(/[^\w\u4e00-\u9fa5]/g, '').toLowerCase() : '';
                                if (typeof e.content === 'string') {
                                    // æ¨¡ç³ŠåŒ¹é…æ–‡æœ¬
                                    if (normalizeText(e.content) === normalizeText(targetText)) {
                                        return true;
                                    }
                                    // åŒ…å«åŒ¹é…
                                    if (e.content.includes(targetText) || targetText.includes(e.content)) {
                                        return true;
                                    }
                                }
                                // å¯¹äºå¤æ‚å†…å®¹å¯¹è±¡çš„åŒ¹é…
                                if (typeof e.content === 'object' && e.content !== null) {
                                    try {
                                        // æ¯”è¾ƒåºåˆ—åŒ–åçš„JSON
                                        if (JSON.stringify(e.content) === targetText) {
                                            return true;
                                        }
                                        // å¦‚æœæ˜¯è¯­éŸ³æ¶ˆæ¯ï¼Œæ¯”è¾ƒtextå­—æ®µ
                                        if ('text' in e.content) {
                                            const voiceText = e.content.text;
                                            if (voiceText === targetText || normalizeText(voiceText) === normalizeText(targetText)) {
                                                return true;
                                            }
                                        }
                                    }
                                    catch (err) {
                                        console.warn('[BLMX] æ¯”è¾ƒå¤æ‚å†…å®¹å¤±è´¥:', err);
                                    }
                                }
                                return false;
                            });
                            if (entryToRecall) {
                                // console.log('[BLMX] æ‰¾åˆ°å¹¶æ ‡è®°è¦æ’¤å›çš„æ¶ˆæ¯:', entryToRecall);
                                entryToRecall.recalled = true;
                                entryToRecall.recalled_content = entryToRecall.content;
                                entryToRecall.recalled_timestamp = recallData.timestamp || new Date().toISOString();
                            }
                            else {
                                console.warn('[BLMX] æœªæ‰¾åˆ°è¦æ’¤å›çš„æ¶ˆæ¯:', {
                                    sender: senderToFind,
                                    target_text: targetText,
                                    recall_data: recallData,
                                });
                            }
                        }
                        catch (error) {
                            console.error('[BLMX] å¤„ç†RECALLæ•°æ®å¤±è´¥:', error);
                        }
                        break;
                    }
                    case 'USER':
                    case 'CHAR': {
                        const sender = key === 'USER' ? 'me' : 'them';
                        const id = `msg-${Date.now()}${Math.random()}-${sender}`;
                        const voiceMatch = value.match(/^\[è¯­éŸ³:\s*({.*})\]/);
                        if (voiceMatch) {
                            try {
                                const voiceData = JSON.parse(voiceMatch[1]);
                                this.logEntries.push({ id, type: 'voice', sender, content: voiceData });
                                return;
                            }
                            catch (e) {
                                console.error('Failed to parse voice data:', voiceMatch[1], e);
                                // æ·»åŠ é»˜è®¤è¯­éŸ³æ•°æ®
                                this.logEntries.push({ id, type: 'voice', sender, content: { text: '', duration: 0 } });
                                return;
                            }
                        }
                        const stickerMatch = value.match(/^\[è¡¨æƒ…:\s*(.*)\]/);
                        if (stickerMatch) {
                            this.logEntries.push({ id, type: 'sticker', sender, content: stickerMatch[1] });
                            return;
                        }
                        const imageMatch = value.match(/^\[å›¾ç‰‡:\s*(.*)\]/);
                        if (imageMatch) {
                            try {
                                const imgData = JSON.parse(imageMatch[1]);
                                this.logEntries.push({ id, type: 'image', sender, content: imgData });
                            }
                            catch (e) {
                                this.logEntries.push({
                                    id,
                                    type: 'image',
                                    sender,
                                    content: { type: 'desc', value: imageMatch[1] },
                                });
                            }
                            return;
                        }
                        const locationMatch = value.match(/^\[ä½ç½®:\s*(.*)\]/);
                        if (locationMatch) {
                            this.logEntries.push({ id, type: 'location', sender, content: locationMatch[1] });
                            return;
                        }
                        const transferMatch = value.match(/^\[è½¬è´¦:\s*(.*)\]/);
                        if (transferMatch) {
                            this.logEntries.push({
                                id,
                                type: 'transfer',
                                sender,
                                content: transferMatch[1],
                                data: (() => {
                                    try {
                                        return JSON.parse(transferMatch[1]);
                                    }
                                    catch (e) {
                                        console.error('Failed to parse transfer data:', transferMatch[1], e);
                                        return { amount: 0, message: '' };
                                    }
                                })(),
                            });
                            return;
                        }
                        const fileMatch = value.match(/^\[æ–‡ä»¶:\s*(.*)\]/);
                        if (fileMatch) {
                            this.logEntries.push({ id, type: 'file', sender, content: fileMatch[1] });
                            return;
                        }
                        const giftMatch = value.match(/^\[ç¤¼ç‰©:\s*(.*)\]/);
                        if (giftMatch) {
                            this.logEntries.push({
                                id,
                                type: 'gift',
                                sender,
                                content: giftMatch[1],
                                data: (() => {
                                    try {
                                        return JSON.parse(giftMatch[1]);
                                    }
                                    catch (e) {
                                        console.error('Failed to parse gift data:', giftMatch[1], e);
                                        return { name: '', value: 0 };
                                    }
                                })(),
                            });
                            return;
                        }
                        this.logEntries.push({ id, type: 'message', sender, content: value });
                        break;
                    }
                }
            }
            catch (e) {
                console.error('Failed to parse log line:', line, e);
            }
        });
    }
    _renderLogToString() {
        const recallCommands = [];
        const allEntriesString = this.logEntries
            .map(e => {
            if (e.recalled) {
                const recallData = {
                    sender: 'sender' in e && e.sender === 'me' ? 'USER' : 'CHAR',
                    target_text: typeof e.recalled_content === 'object' && e.recalled_content !== null
                        ? e.recalled_content.text
                        : e.recalled_content,
                    timestamp: e.recalled_timestamp,
                };
                if (recallData.target_text) {
                    recallCommands.push(`RECALL: ${JSON.stringify(recallData)}`);
                }
            }
            if ('key' in e) {
                return `${e.key}: ${JSON.stringify(e.data)}`;
            }
            if ('type' in e) {
                if (e.type === 'time' || e.type === 'event') {
                    const key = e.type === 'time' ? 'TIME' : 'EVENT_LOG';
                    // console.log(`[BLMX] åºåˆ—åŒ–${key}æ¡ç›®:`, e);
                    return `${key}: ${JSON.stringify(e.content)}`;
                }
                const prefix = e.sender === 'me' ? 'USER' : 'CHAR';
                let content = e.content;
                switch (e.type) {
                    case 'sticker':
                        content = `[è¡¨æƒ…: ${e.content}]`;
                        break;
                    case 'voice':
                        content = `[è¯­éŸ³: ${JSON.stringify(e.content)}]`;
                        break;
                    case 'image':
                        content = `[å›¾ç‰‡: ${JSON.stringify(e.content)}]`;
                        break;
                    case 'location':
                        content = `[ä½ç½®: ${e.content}]`;
                        break;
                    case 'file':
                        content = `[æ–‡ä»¶: ${e.content}]`;
                        break;
                    case 'gift':
                        content = `[ç¤¼ç‰©: ${e.content}]`;
                        break;
                    case 'transfer':
                        content = `[è½¬è´¦: ${e.content}]`;
                        break;
                }
                return `${prefix}: ${content}`;
            }
            return ''; // Should not happen for valid entries
        })
            .join('\n');
        return [allEntriesString, ...recallCommands].filter(Boolean).join('\n');
    }
    // ç®€åŒ–çš„addEntryæ–¹æ³• - å¯¹è¡¨æƒ…åŒ…æ¶ˆæ¯ä¸è¿›è¡Œé‡å¤æ£€æŸ¥
    addEntry(entry) {
        if (entry) {
            // å¯¹äºè¡¨æƒ…åŒ…æ¶ˆæ¯ï¼Œç›´æ¥æ·»åŠ ï¼Œä¸è¿›è¡Œé‡å¤æ£€æŸ¥
            if ('type' in entry && entry.type === 'sticker') {
                this.logEntries.push(entry);
                return;
            }
            // å¯¹äºå…¶ä»–ç±»å‹çš„æ¡ç›®ï¼Œè¿›è¡Œé‡å¤æ£€æŸ¥
            const isDuplicate = this.logEntries.some(existingEntry => {
                // æ£€æŸ¥æœ‹å‹åœˆç›¸å…³æ¡ç›®
                if ('key' in entry && 'key' in existingEntry) {
                    if (entry.key === existingEntry.key) {
                        // å¯¹äºæœ‹å‹åœˆåŠ¨æ€ï¼Œæ¯”è¾ƒæ–‡æœ¬å’Œæ—¶é—´
                        if (entry.key.includes('_MOMENT')) {
                            const entryData = entry.data;
                            const existingData = existingEntry.data;
                            return (existingData.text === entryData.text &&
                                existingData.date === entryData.date &&
                                existingData.time === entryData.time);
                        }
                        // å¯¹äºè¯„è®ºï¼Œæ¯”è¾ƒæ–‡æœ¬å’Œç›®æ ‡å¸–å­ID
                        else if (entry.key.includes('_COMMENT')) {
                            const entryData = entry.data;
                            const existingData = existingEntry.data;
                            return existingData.text === entryData.text && existingData.target_post_id === entryData.target_post_id;
                        }
                        // å¯¹äºç‚¹èµï¼Œæ¯”è¾ƒç›®æ ‡å¸–å­ID
                        else if (entry.key.includes('_LIKE')) {
                            const entryData = entry.data;
                            const existingData = existingEntry.data;
                            return existingData.target_post_id === entryData.target_post_id;
                        }
                    }
                }
                // æ£€æŸ¥æ¶ˆæ¯ç±»å‹æ¡ç›®
                if ('type' in entry && 'type' in existingEntry) {
                    // å¦‚æœä¸¤ä¸ªæ¡ç›®ç±»å‹ç›¸åŒ
                    if (entry.type === existingEntry.type) {
                        // å¯¹äºæœ‰IDçš„æ¡ç›®ï¼Œæ¯”è¾ƒID
                        if ('id' in entry && 'id' in existingEntry && entry.id === existingEntry.id) {
                            return true;
                        }
                        // å¯¹äºæ¶ˆæ¯ç±»å‹æ¡ç›®ï¼Œæ¯”è¾ƒå‘é€è€…å’Œå†…å®¹
                        if ((entry.type === 'message' || entry.type === 'location' || entry.type === 'file') &&
                            'sender' in entry &&
                            'sender' in existingEntry &&
                            'content' in entry &&
                            'content' in existingEntry) {
                            return (entry.sender === existingEntry.sender && window._.isEqual(entry.content, existingEntry.content));
                        }
                        // å¯¹äºæ—¶é—´å’Œäº‹ä»¶æ—¥å¿—ï¼Œæ¯”è¾ƒå†…å®¹
                        if ((entry.type === 'time' || entry.type === 'event') && 'content' in entry && 'content' in existingEntry) {
                            return window._.isEqual(entry.content, existingEntry.content);
                        }
                        // å¯¹äºå…¶ä»–å¤æ‚ç±»å‹ï¼ˆå¦‚image, voice, transfer, giftï¼‰ï¼Œæ¯”è¾ƒå†…å®¹
                        if ('content' in entry &&
                            'content' in existingEntry &&
                            (entry.type === 'image' || entry.type === 'voice' || entry.type === 'transfer' || entry.type === 'gift')) {
                            return window._.isEqual(entry.content, existingEntry.content);
                        }
                    }
                }
                return false;
            });
            if (isDuplicate) {
                // console.log(`[BLMX] è·³è¿‡æ·»åŠ é‡å¤æ¡ç›®:`, entry);
                return; // å¦‚æœæ˜¯é‡å¤æ¡ç›®ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ·»åŠ 
            }
            this.logEntries.push(entry);
            // æ·»åŠ æ—¶é—´æ›´æ–°é€»è¾‘ - å‚è€ƒåŸç‰ˆç®€åŒ–
            if ('type' in entry && (entry.type === 'time' || entry.type === 'event')) {
                const data = entry.content;
                const timeDate = new Date(`${data.date} ${data.time}`);
                if (!isNaN(timeDate.getTime())) {
                    window.currentGameDate = timeDate;
                    const timeElement = document.getElementById('current-time');
                    if (timeElement) {
                        const timeString = `${window.currentGameDate
                            .getHours()
                            .toString()
                            .padStart(2, '0')}:${window.currentGameDate.getMinutes().toString().padStart(2, '0')}`;
                        timeElement.textContent = timeString;
                    }
                }
            }
        }
    }
    getContextForAI() {
        return this._renderLogToString();
    }
}

;// ./src/åŒå±‚æ‰‹æœº/utils.ts
/**
 * é€šç”¨å·¥å…·å‡½æ•°
 * ç”¨äºæŠ½è±¡é‡å¤çš„é€»è¾‘å’Œæä¾›å…±äº«åŠŸèƒ½
 */

/**
 * å®‰å…¨çš„JSONè§£æ
 * @param jsonString JSONå­—ç¬¦ä¸²
 * @param defaultValue è§£æå¤±è´¥æ—¶çš„é»˜è®¤å€¼
 * @returns è§£æç»“æœæˆ–é»˜è®¤å€¼
 */
function safeJsonParse(jsonString, defaultValue = null) {
    try {
        return JSON.parse(jsonString);
    }
    catch (error) {
        debug_logger_logger.warn('Utils', 'JSONè§£æå¤±è´¥', { jsonString: jsonString.substring(0, 100), error });
        return defaultValue;
    }
}
/**
 * å®‰å…¨çš„JSONå­—ç¬¦ä¸²åŒ–
 * @param obj è¦åºåˆ—åŒ–çš„å¯¹è±¡
 * @param defaultValue åºåˆ—åŒ–å¤±è´¥æ—¶çš„é»˜è®¤å€¼
 * @returns JSONå­—ç¬¦ä¸²æˆ–é»˜è®¤å€¼
 */
function safeJsonStringify(obj, defaultValue = '{}') {
    try {
        return JSON.stringify(obj);
    }
    catch (error) {
        debug_logger_logger.warn('Utils', 'JSONåºåˆ—åŒ–å¤±è´¥', { error });
        return defaultValue;
    }
}
/**
 * é˜²æŠ–å‡½æ•° - ä½¿ç”¨lodashçš„debounce
 * @param func è¦é˜²æŠ–çš„å‡½æ•°
 * @param wait ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 * @param options lodash debounceé€‰é¡¹
 * @returns é˜²æŠ–åçš„å‡½æ•°
 */
function debounce(func, wait, options) {
    return window._.debounce(func, wait, options);
}
/**
 * èŠ‚æµå‡½æ•° - ä½¿ç”¨lodashçš„throttle
 * @param func è¦èŠ‚æµçš„å‡½æ•°
 * @param wait ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 * @param options lodash throttleé€‰é¡¹
 * @returns èŠ‚æµåçš„å‡½æ•°
 */
function throttle(func, wait, options) {
    return window._.throttle(func, wait, options);
}
/**
 * å¼‚æ­¥å»¶è¿Ÿå‡½æ•°
 * @param ms å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 * @returns Promise
 */
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
/**
 * å®‰å…¨çš„DOMæŸ¥è¯¢ - ä½¿ç”¨jQuery
 * @param selector CSSé€‰æ‹©å™¨
 * @param context æŸ¥è¯¢ä¸Šä¸‹æ–‡ï¼Œé»˜è®¤ä¸ºdocument
 * @returns jQueryå¯¹è±¡
 */
function $safe(selector, context) {
    try {
        return context ? $(selector, context) : $(selector);
    }
    catch (error) {
        logger.warn('Utils', 'jQueryæŸ¥è¯¢å¤±è´¥', { selector, error });
        return $(); // è¿”å›ç©ºçš„jQueryå¯¹è±¡
    }
}
/**
 * å®‰å…¨çš„DOMæŸ¥è¯¢ï¼ˆåŸç”Ÿå…ƒç´ ï¼‰
 * @param selector CSSé€‰æ‹©å™¨
 * @param context æŸ¥è¯¢ä¸Šä¸‹æ–‡ï¼Œé»˜è®¤ä¸ºdocument
 * @returns å…ƒç´ æˆ–null
 */
function safeQuerySelector(selector, context = document) {
    try {
        return context.querySelector(selector);
    }
    catch (error) {
        logger.warn('Utils', 'DOMæŸ¥è¯¢å¤±è´¥', { selector, error });
        return null;
    }
}
/**
 * å®‰å…¨çš„DOMæŸ¥è¯¢ï¼ˆå¤šä¸ªå…ƒç´ ï¼‰- ä½¿ç”¨jQueryæ›´ç®€æ´
 * @param selector CSSé€‰æ‹©å™¨
 * @param context æŸ¥è¯¢ä¸Šä¸‹æ–‡ï¼Œé»˜è®¤ä¸ºdocument
 * @returns å…ƒç´ æ•°ç»„
 */
function safeQuerySelectorAll(selector, context = document) {
    try {
        const $elements = context ? $(selector, context) : $(selector);
        return $elements.toArray();
    }
    catch (error) {
        logger.warn('Utils', 'DOMæŸ¥è¯¢å¤±è´¥', { selector, error });
        return [];
    }
}
/**
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
 * @param bytes å­—èŠ‚æ•°
 * @returns æ ¼å¼åŒ–çš„æ–‡ä»¶å¤§å°å­—ç¬¦ä¸²
 */
function formatFileSize(bytes) {
    if (bytes === 0)
        return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
/**
 * æ ¼å¼åŒ–æ—¶é—´æˆ³
 * @param timestamp æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
 * @param format æ ¼å¼ç±»å‹
 * @returns æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
 */
function formatTimestamp(timestamp, format = 'full') {
    const date = new Date(timestamp);
    switch (format) {
        case 'time':
            return date.toLocaleTimeString('zh-CN', { hour12: false });
        case 'date':
            return date.toLocaleDateString('zh-CN');
        case 'full':
        default:
            return date.toLocaleString('zh-CN', { hour12: false });
    }
}
/**
 * ç”Ÿæˆå”¯ä¸€ID
 * @param prefix å‰ç¼€
 * @returns å”¯ä¸€IDå­—ç¬¦ä¸²
 */
function generateId(prefix = 'id') {
    return `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
}
/**
 * æ·±åº¦å…‹éš†å¯¹è±¡ - ä½¿ç”¨lodashçš„cloneDeep
 * @param obj è¦å…‹éš†çš„å¯¹è±¡
 * @returns å…‹éš†åçš„å¯¹è±¡
 */
function deepClone(obj) {
    return window._.cloneDeep(obj);
}
/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
 * @returns æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
 */
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
/**
 * æ£€æŸ¥æ˜¯å¦æ”¯æŒè§¦æ‘¸
 * @returns æ˜¯å¦æ”¯æŒè§¦æ‘¸
 */
function isTouchDevice() {
    return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}
/**
 * å®‰å…¨çš„æœ¬åœ°å­˜å‚¨æ“ä½œ
 */
const SafeStorage = {
    /**
     * è·å–æœ¬åœ°å­˜å‚¨é¡¹
     * @param key é”®å
     * @param defaultValue é»˜è®¤å€¼
     * @returns å­˜å‚¨çš„å€¼æˆ–é»˜è®¤å€¼
     */
    getItem(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            if (item === null)
                return defaultValue;
            // å°è¯•è§£æJSONï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›åŸå§‹å­—ç¬¦ä¸²
            try {
                return JSON.parse(item);
            }
            catch {
                return item;
            }
        }
        catch (error) {
            debug_logger_logger.warn('Utils', 'æœ¬åœ°å­˜å‚¨è¯»å–å¤±è´¥', { key, error });
            return defaultValue;
        }
    },
    /**
     * è®¾ç½®æœ¬åœ°å­˜å‚¨é¡¹
     * @param key é”®å
     * @param value å€¼
     * @returns æ˜¯å¦æˆåŠŸ
     */
    setItem(key, value) {
        try {
            const serialized = typeof value === 'string' ? value : JSON.stringify(value);
            localStorage.setItem(key, serialized);
            return true;
        }
        catch (error) {
            debug_logger_logger.warn('Utils', 'æœ¬åœ°å­˜å‚¨å†™å…¥å¤±è´¥', { key, error });
            return false;
        }
    },
    /**
     * åˆ é™¤æœ¬åœ°å­˜å‚¨é¡¹
     * @param key é”®å
     * @returns æ˜¯å¦æˆåŠŸ
     */
    removeItem(key) {
        try {
            localStorage.removeItem(key);
            return true;
        }
        catch (error) {
            debug_logger_logger.warn('Utils', 'æœ¬åœ°å­˜å‚¨åˆ é™¤å¤±è´¥', { key, error });
            return false;
        }
    },
    /**
     * æ¸…ç©ºæœ¬åœ°å­˜å‚¨
     * @returns æ˜¯å¦æˆåŠŸ
     */
    clear() {
        try {
            localStorage.clear();
            return true;
        }
        catch (error) {
            debug_logger_logger.warn('Utils', 'æœ¬åœ°å­˜å‚¨æ¸…ç©ºå¤±è´¥', { error });
            return false;
        }
    },
};
/**
 * é”™è¯¯å¤„ç†å·¥å…·
 */
const ErrorHandler = {
    /**
     * å®‰å…¨æ‰§è¡Œå¼‚æ­¥å‡½æ•°
     * @param fn å¼‚æ­¥å‡½æ•°
     * @param errorMessage é”™è¯¯æ¶ˆæ¯
     * @returns æ‰§è¡Œç»“æœæˆ–null
     */
    async safeAsync(fn, errorMessage) {
        try {
            return await fn();
        }
        catch (error) {
            debug_logger_logger.error('ErrorHandler', errorMessage || 'å¼‚æ­¥æ“ä½œå¤±è´¥', { error });
            return null;
        }
    },
    /**
     * å®‰å…¨æ‰§è¡ŒåŒæ­¥å‡½æ•°
     * @param fn åŒæ­¥å‡½æ•°
     * @param errorMessage é”™è¯¯æ¶ˆæ¯
     * @returns æ‰§è¡Œç»“æœæˆ–null
     */
    safeSync(fn, errorMessage) {
        try {
            return fn();
        }
        catch (error) {
            debug_logger_logger.error('ErrorHandler', errorMessage || 'åŒæ­¥æ“ä½œå¤±è´¥', { error });
            return null;
        }
    },
};

;// ./src/åŒå±‚æ‰‹æœº/ai-response-manager.ts
// AIå“åº”å¤„ç†æ¨¡å—
// è´Ÿè´£AIå“åº”è§¦å‘ã€æ¡ç›®å¤„ç†ã€åŠ¨ç”»æ˜¾ç¤ºç­‰åŠŸèƒ½




class AiResponseManager {
    blmxManager;
    uiRenderer;
    eventHandler;
    momentsManager;
    eventManager;
    isGenerating = false;
    latestAiRawResponse = 'è¿˜æ²¡æœ‰æ”¶åˆ°AIçš„å›å¤ã€‚';
    latestSentPrompt = 'è¿˜æ²¡æœ‰å‘é€ä»»ä½•å†…å®¹ç»™AIã€‚';
    // æ–°å¢ï¼šè®°å½•åŸå§‹å“åº”å’Œå®Œæ•´æç¤ºè¯ï¼Œä¸åŒå±‚æ‰‹æœºä¿æŒä¸€è‡´
    rawAiResponse = '';
    fullPrompt = '';
    constructor(blmxManager, uiRenderer, eventHandler, momentsManager) {
        this.blmxManager = blmxManager;
        this.uiRenderer = uiRenderer;
        this.eventHandler = eventHandler;
        this.momentsManager = momentsManager;
        this.eventManager = new EventManager();
        // ä½¿ç”¨äº‹ä»¶ç®¡ç†å™¨æ¥æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        this.eventManager.addGlobalListener('js_generation_ended', (text) => {
            this.rawAiResponse = text;
            debug_logger_logger.debug('AiResponseManager', 'åŸå§‹AIå“åº”å·²æ¥æ”¶', { length: text.length });
        });
        this.eventManager.addGlobalListener('chat_completion_prompt_ready', (event_data) => {
            this.fullPrompt = safeJsonStringify(event_data.chat);
            debug_logger_logger.debug('AiResponseManager', 'å®Œæ•´æç¤ºè¯å·²å‡†å¤‡', { promptLength: this.fullPrompt.length });
        });
    }
    // è·å–æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
    getIsGenerating() {
        return this.isGenerating;
    }
    // è§¦å‘AIå“åº” - æŒ‰ç…§åŸå§‹åŒå±‚æ‰‹æœºä¸­çš„å®ç°ç§»æ¤
    async triggerAiResponse(_immediate = false) {
        if (this.isGenerating || !this.blmxManager)
            return;
        // æ£€æŸ¥é€»è¾‘å·²ç§»åˆ°AppControllerä¸­ï¼Œè¿™é‡Œç›´æ¥å¤„ç†
        // æ£€æŸ¥å…¨å±€æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤å¤„ç†
        if (window.BLMX_PROCESSING_AI_RESPONSE) {
            debug_logger_logger.debug('AiResponseManager', 'å·²æœ‰AIå“åº”å¤„ç†è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤å¤„ç†');
            return;
        }
        // è®¾ç½®å…¨å±€å¤„ç†æ ‡å¿—
        window.BLMX_PROCESSING_AI_RESPONSE = true;
        this.isGenerating = true;
        try {
            // getContextForAI should now get all necessary context from the main log.
            let contextForAI = this.blmxManager.getContextForAI();
            contextForAI +=
                '\nã€BLMX_LOGä¸­çš„å†…å®¹ä¸ºç›®å‰è¿‡å¾€çº¿ä¸ŠèŠå¤©è®°å½•ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬æœ€æ–°çš„USERè¾“å…¥ï¼Œè¯·ä½ ä½œä¸ºCHARè¿›è¡Œå›åº”ã€‚ã€‘\nã€æœ¬æ¬¡å“åº”å¿…é¡»éµå¾ªçº¿ä¸Šè§„åˆ™ã€‘ã€å¿…é¡»ä½¿ç”¨ç‰¹æ®Šçº¦å®šçš„æ ¼å¼ä¸”ä¿è¯æ­£ç¡®æ¢è¡Œã€‘';
            this.latestSentPrompt = contextForAI;
            // Clean up 'isNewForAI' flags from the main log after generating context.
            this.blmxManager.logEntries.forEach(entry => {
                if ('type' in entry && entry.type === 'image' && 'content' in entry && entry.content.isNewForAI) {
                    entry.content.value = `[ç”¨æˆ·å‘é€çš„å›¾ç‰‡]`;
                    delete entry.content.isNewForAI;
                }
            });
            // é‡ç½®å¾…å“åº”æ ‡å¿—
            this.eventHandler.setHasPendingNotifications(false);
            const MAX_RETRIES = 2;
            let attempt = 0;
            let success = false;
            while (attempt <= MAX_RETRIES && !success) {
                if (attempt > 0) {
                    debug_logger_logger.warn('AiResponseManager', `AIå“åº”ä¸ºç©ºï¼Œé‡è¯•ä¸­`, { attempt: attempt + 1, maxRetries: MAX_RETRIES + 1 });
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
                try {
                    // æ˜¾ç¤ºçµåŠ¨å²›ç”ŸæˆæŒ‡ç¤ºå™¨ï¼Œè€Œä¸æ˜¯æ‰“å­—æŒ‡ç¤ºå™¨
                    this.uiRenderer.showGeneratingIndicator();
                    const stream = await getTavernHelper().generate({ user_input: contextForAI, should_stream: true });
                    let finalAiResponse = '';
                    for await (const chunk of stream) {
                        finalAiResponse += chunk;
                    }
                    // éšè—çµåŠ¨å²›ç”ŸæˆæŒ‡ç¤ºå™¨
                    this.uiRenderer.hideGeneratingIndicator();
                    this.latestAiRawResponse = finalAiResponse.trim();
                    // è®°å½•åŸå§‹å“åº”ä»¥ä¾¿è°ƒè¯•
                    if (!this.rawAiResponse) {
                        this.rawAiResponse = finalAiResponse.trim();
                        debug_logger_logger.debug('AiResponseManager', 'ç›´æ¥è·å–çš„åŸå§‹AIå“åº”', { length: this.rawAiResponse.length });
                    }
                    // å¤„ç†é‡å¤å“åº”é—®é¢˜ - ä»åŸå§‹åŒå±‚æ‰‹æœºç§»æ¤è¿‡æ¥
                    let processedResponse = finalAiResponse.trim();
                    const len = processedResponse.length;
                    // æ£€æŸ¥å®Œå…¨ç›¸åŒçš„ä¸¤åŠ
                    if (len > 0 && len % 2 === 0) {
                        const firstHalf = processedResponse.substring(0, len / 2);
                        const secondHalf = processedResponse.substring(len / 2);
                        if (firstHalf === secondHalf && firstHalf.trim() !== '') {
                            debug_logger_logger.warn('AiResponseManager', 'æ£€æµ‹åˆ°å®Œå…¨é‡å¤çš„AIå“åº”ï¼Œè‡ªåŠ¨ä¿®å‰ª');
                            processedResponse = firstHalf;
                        }
                    }
                    // å¢å¼ºçš„é‡å¤æ£€æµ‹ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„è¡Œè¢«é‡å¤
                    const lines = processedResponse.split('\n').filter(line => line.trim() !== '');
                    if (lines.length > 1) {
                        const uniqueLines = window._.uniq(lines);
                        // å¦‚æœå»é‡åçš„è¡Œæ•°æ˜æ˜¾å°‘äºåŸå§‹è¡Œæ•°ï¼Œå¯èƒ½å­˜åœ¨é‡å¤
                        if (uniqueLines.length < lines.length * 0.7) {
                            debug_logger_logger.warn('AiResponseManager', 'æ£€æµ‹åˆ°AIå“åº”ä¸­çš„æ½œåœ¨è¡Œé‡å¤ï¼Œä»…ä½¿ç”¨å”¯ä¸€è¡Œ');
                            processedResponse = uniqueLines.join('\n');
                        }
                    }
                    if (processedResponse.trim()) {
                        // å¤„ç†AIå“åº”
                        success = await this.processAiResponse(processedResponse.trim());
                    }
                }
                catch (error) {
                    debug_logger_logger.error('AiResponseManager', `å°è¯•${attempt}æ—¶å‡ºé”™`, { attempt, error });
                    this.uiRenderer.hideGeneratingIndicator();
                    if (attempt >= MAX_RETRIES) {
                        this.showErrorMessage('AIä»£ç†å‡ºé”™ (è¯¦æƒ…è§F12æ§åˆ¶å°)');
                    }
                }
                attempt++;
            }
            if (!success && attempt > MAX_RETRIES) {
                console.error(`[BLMX] AI generation failed after ${MAX_RETRIES + 1} attempts (empty response).`);
                this.showErrorMessage('(AIå“åº”ä¸ºç©ºï¼Œè¯·ç¨åå†è¯•æˆ–æ‰‹åŠ¨è§¦å‘)');
                this.latestAiRawResponse = '[AIå“åº”ä¸ºç©º]';
            }
            await this.blmxManager.persistLogToStorage();
            // åˆ·æ–°æ‰€æœ‰æ—¶é—´æˆ³çš„æ˜¾ç¤ºï¼Œç¡®ä¿AIå›å¤çš„æ—¶é—´æˆ³æ­£ç¡®å±•ç¤º
            this.uiRenderer.refreshAllTimestamps();
        }
        catch (error) {
            console.error('[BLMX] Error in triggerAiResponse:', error);
        }
        finally {
            // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½é‡ç½®å¤„ç†æ ‡å¿—
            this.isGenerating = false;
            window.BLMX_PROCESSING_AI_RESPONSE = false;
        }
    }
    // å¤„ç†AIå“åº”
    async processAiResponse(response) {
        const entriesForAnimation = [];
        let hasNewCharMoments = false;
        // é¢„å¤„ç†å“åº”æ–‡æœ¬
        const processedResponse = response.replace(/^\s*[[{].*[\]}]\s*$/gm, match => {
            const parsed = safeJsonParse(match.trim());
            return parsed !== null ? match : '';
        });
        const responseLines = processedResponse.split('\n').filter(line => line.trim() !== '');
        debug_logger_logger.debug('AiResponseManager', 'å¤„ç†AIå“åº”è¡Œ', { lineCount: responseLines.length });
        responseLines.forEach(line => {
            const separatorIndex = line.indexOf(':');
            if (separatorIndex === -1) {
                debug_logger_logger.debug('AiResponseManager', 'è·³è¿‡æ²¡æœ‰åˆ†éš”ç¬¦çš„è¡Œ', { line });
                return;
            }
            const key = line.substring(0, separatorIndex).trim();
            const value = line.substring(separatorIndex + 1).trim();
            debug_logger_logger.debug('AiResponseManager', 'è§£æå“åº”', {
                key,
                valuePreview: value.substring(0, 50) + (value.length > 50 ? '...' : ''),
                valueLength: value.length,
            });
            if (!key || !value)
                return;
            try {
                let newEntry = null;
                // å£°æ˜æ‰€æœ‰å¯èƒ½åœ¨caseä¸­ä½¿ç”¨çš„å˜é‡
                const id = `ai-${Date.now()}-${Math.random()}`;
                let voiceMatch = null;
                let stickerMatch = null;
                let imageMatch = null;
                let locationMatch = null;
                let transferMatch = null;
                let fileMatch = null;
                let giftMatch = null;
                switch (key) {
                    case 'CHAR_MOMENT':
                    case 'CHAR_COMMENT':
                    case 'CHAR_LIKE':
                        newEntry = { key, data: safeJsonParse(value) };
                        this.blmxManager.addEntry(newEntry);
                        // å°†æœ‹å‹åœˆç›¸å…³æ¡ç›®ä¹Ÿæ·»åŠ åˆ°åŠ¨ç”»é˜Ÿåˆ—ä¸­
                        if (newEntry) {
                            entriesForAnimation.push(newEntry);
                            hasNewCharMoments = true;
                        }
                        // ç«‹å³æ›´æ–°æœ‹å‹åœˆç•Œé¢ï¼Œä¸ç­‰å¾…åŠ¨ç”»å®Œæˆ
                        if (this.momentsManager) {
                            this.momentsManager.renderMomentsFeed();
                        }
                        break;
                    case 'message': {
                        const parsedMessageContent = safeJsonParse(value);
                        newEntry = {
                            id: `ai-${Date.now()}-${Math.random()}`,
                            type: 'message',
                            sender: 'them',
                            content: parsedMessageContent !== null ? parsedMessageContent : value,
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    }
                    case 'CHAR':
                        // å…¼å®¹åŸå§‹çš„CHARæ ¼å¼
                        voiceMatch = value.match(/^\[è¯­éŸ³:\s*({.*})\]/);
                        stickerMatch = value.match(/^\[è¡¨æƒ…:\s*(.*)\]/);
                        imageMatch = value.match(/^\[å›¾ç‰‡:\s*(.*)\]/);
                        locationMatch = value.match(/^\[ä½ç½®:\s*(.*)\]/);
                        transferMatch = value.match(/^\[è½¬è´¦:\s*(.*)\]/);
                        fileMatch = value.match(/^\[æ–‡ä»¶:\s*(.*)\]/);
                        giftMatch = value.match(/^\[ç¤¼ç‰©:\s*(.*)\]/);
                        if (voiceMatch) {
                            const parsedVoiceData = safeJsonParse(voiceMatch[1]);
                            newEntry = {
                                id,
                                type: 'voice',
                                sender: 'them',
                                content: parsedVoiceData || { text: '', duration: 0 },
                            };
                        }
                        else if (stickerMatch) {
                            newEntry = {
                                id,
                                type: 'sticker',
                                sender: 'them',
                                content: stickerMatch[1],
                            };
                        }
                        else if (imageMatch) {
                            const parsedImageData = safeJsonParse(imageMatch[1]);
                            if (parsedImageData !== null) {
                                // æˆåŠŸè§£æJSONæ ¼å¼çš„å›¾ç‰‡æ•°æ®
                                newEntry = {
                                    id,
                                    type: 'image',
                                    sender: 'them',
                                    content: parsedImageData,
                                };
                            }
                            else {
                                // è§£æå¤±è´¥ï¼Œè¯´æ˜æ˜¯çº¯æ–‡æœ¬æè¿°
                                newEntry = {
                                    id,
                                    type: 'image',
                                    sender: 'them',
                                    content: { type: 'desc', value: imageMatch[1] },
                                };
                            }
                        }
                        else if (locationMatch) {
                            newEntry = {
                                id,
                                type: 'location',
                                sender: 'them',
                                content: locationMatch[1],
                            };
                        }
                        else if (transferMatch) {
                            try {
                                newEntry = {
                                    id,
                                    type: 'transfer',
                                    sender: 'them',
                                    content: transferMatch[1],
                                    data: safeJsonParse(transferMatch[1]) || { amount: 0, message: '' },
                                };
                            }
                            catch (e) {
                                console.error('Failed to parse transfer data:', transferMatch[1], e);
                            }
                        }
                        else if (fileMatch) {
                            try {
                                newEntry = {
                                    id,
                                    type: 'file',
                                    sender: 'them',
                                    content: fileMatch[1],
                                    data: safeJsonParse(fileMatch[1]) || { name: '', size: 0, url: '' },
                                };
                            }
                            catch (e) {
                                console.error('Failed to parse file data:', fileMatch[1], e);
                            }
                        }
                        else if (giftMatch) {
                            try {
                                newEntry = {
                                    id,
                                    type: 'gift',
                                    sender: 'them',
                                    content: giftMatch[1],
                                    data: safeJsonParse(giftMatch[1]) || { name: '', value: 0 },
                                };
                            }
                            catch (e) {
                                console.error('Failed to parse gift data:', giftMatch[1], e);
                            }
                        }
                        else {
                            // çº¯æ–‡æœ¬æ¶ˆæ¯
                            newEntry = {
                                id,
                                type: 'message',
                                sender: 'them',
                                content: value,
                            };
                        }
                        if (newEntry) {
                            this.blmxManager.addEntry(newEntry);
                            entriesForAnimation.push(newEntry);
                        }
                        break;
                    case 'sticker': {
                        const parsedStickerContent = safeJsonParse(value);
                        newEntry = {
                            id: `ai-sticker-${Date.now()}-${Math.random()}`,
                            type: 'sticker',
                            sender: 'them',
                            content: parsedStickerContent !== null ? parsedStickerContent : value,
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    }
                    case 'voice':
                        newEntry = {
                            id: `ai-voice-${Date.now()}-${Math.random()}`,
                            type: 'voice',
                            sender: 'them',
                            content: JSON.parse(value),
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    case 'image':
                        newEntry = {
                            id: `ai-image-${Date.now()}-${Math.random()}`,
                            type: 'image',
                            sender: 'them',
                            content: JSON.parse(value),
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    case 'location':
                        newEntry = {
                            id: `ai-location-${Date.now()}-${Math.random()}`,
                            type: 'location',
                            sender: 'them',
                            content: JSON.parse(value),
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    case 'transfer':
                        newEntry = {
                            id: `ai-transfer-${Date.now()}-${Math.random()}`,
                            type: 'transfer',
                            sender: 'them',
                            content: JSON.parse(value),
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    case 'file':
                        newEntry = {
                            id: `ai-file-${Date.now()}-${Math.random()}`,
                            type: 'file',
                            sender: 'them',
                            content: JSON.parse(value),
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    case 'gift':
                        newEntry = {
                            id: `ai-gift-${Date.now()}-${Math.random()}`,
                            type: 'gift',
                            sender: 'them',
                            content: JSON.parse(value),
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    case 'RECALL': {
                        const recallData = safeJsonParse(value);
                        const senderToFind = recallData.sender === 'USER' ? 'me' : 'them';
                        const entryToRecall = this.blmxManager.logEntries
                            .slice()
                            .reverse()
                            .find(e => 'sender' in e && e.sender === senderToFind && 'content' in e && e.content === recallData.target_text);
                        if (entryToRecall) {
                            // åˆ›å»ºä¸€ä¸ª"æŒ‡ä»¤"æ¡ç›®ç»™åŠ¨ç”»å‡½æ•°å¤„ç†
                            entriesForAnimation.push({
                                type: 'recall_instruction',
                                content: {
                                    originalEntry: entryToRecall,
                                    recallTimestamp: recallData.timestamp,
                                },
                            });
                        }
                        break;
                    }
                    case 'EVENT_LOG':
                    case 'TIME':
                        newEntry = {
                            type: key === 'TIME' ? 'time' : 'event',
                            content: safeJsonParse(value),
                        };
                        this.blmxManager.addEntry(newEntry);
                        if (newEntry)
                            entriesForAnimation.push(newEntry);
                        break;
                    default:
                        debug_logger_logger.warn('AiResponseManager', 'æœªçŸ¥çš„AIå“åº”é”®', { key });
                }
            }
            catch (error) {
                console.error(`[BLMX] Error processing AI response line "${line}":`, error);
            }
        });
        // å¦‚æœæœ‰æ–°æ¡ç›®è¦åŠ¨ç”»æ˜¾ç¤º
        if (entriesForAnimation.length > 0) {
            await this.displayAiEntriesSequentially(entriesForAnimation);
            // å¦‚æœæœ‰æœ‹å‹åœˆç›¸å…³çš„æ›´æ–°ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æœ‹å‹åœˆè§†å›¾
            if (hasNewCharMoments && this.momentsManager) {
                // åªæœ‰å½“ç”¨æˆ·ä¸åœ¨æœ‹å‹åœˆè§†å›¾æ—¶æ‰è®¾ç½®é€šçŸ¥
                const userInMomentsView = $('#moments-view').hasClass('active');
                if (!userInMomentsView) {
                    this.momentsManager.setMomentNotification(true);
                }
                else {
                    // å¦‚æœç”¨æˆ·æ­£åœ¨æœ‹å‹åœˆè§†å›¾ï¼Œæ›´æ–°æœ€åæŸ¥çœ‹æ—¶é—´æˆ³
                    this.momentsManager.setLastMomentViewTimestamp();
                }
            }
            return true;
        }
        return false;
    }
    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    showErrorMessage(message) {
        const $errorDiv = $('<div>').addClass('ai-error-message').text(message);
        $('.wechat-body').append($errorDiv);
        setTimeout(() => {
            $errorDiv.remove();
        }, 5000);
    }
    // æŒ‰é¡ºåºå±•ç¤ºAIæ¡ç›®
    async displayAiEntriesSequentially(entries) {
        // å®šä¹‰å“ªäº›ç±»å‹æ˜¯"æ¶ˆæ¯"ï¼Œéœ€è¦æ’­æ”¾è¾“å…¥åŠ¨ç”»
        const messageLikeTypes = ['message', 'sticker', 'voice', 'image', 'location', 'transfer', 'file', 'gift'];
        for (const entry of entries) {
            // æ‰¾åˆ°æ¡ç›®åœ¨æ—¥å¿—ä¸­çš„ç´¢å¼•
            const entryIndex = this.blmxManager.logEntries.findIndex(log => {
                // å¯¹äºæœ‰IDçš„æ¡ç›®ï¼Œé€šè¿‡IDåŒ¹é…
                if ('id' in log && 'id' in entry && log.id === entry.id) {
                    return true;
                }
                // å¯¹äºæœ‹å‹åœˆç›¸å…³æ¡ç›®ï¼Œé€šè¿‡keyå’Œå†…å®¹åŒ¹é…
                if ('key' in log && 'key' in entry && log.key === entry.key) {
                    // å¯¹äºæœ‹å‹åœˆåŠ¨æ€
                    if (entry.key.includes('_MOMENT')) {
                        return window._.isEqual(log.data, entry.data);
                    }
                    // å¯¹äºç‚¹èµå’Œè¯„è®º
                    if (entry.key.includes('_LIKE') || entry.key.includes('_COMMENT')) {
                        return window._.isEqual(log.data, entry.data);
                    }
                }
                // å¯¹äºæ²¡æœ‰IDçš„æ¡ç›®ï¼ˆå¦‚TIMEã€EVENT_LOGï¼‰ï¼Œé€šè¿‡å†…å®¹åŒ¹é…
                if ('type' in log &&
                    'type' in entry &&
                    (log.type === 'time' || log.type === 'event') &&
                    log.type === entry.type &&
                    window._.isEqual(log.content, entry.content)) {
                    return true;
                }
                // å¯¹äºæ¶ˆæ¯ç±»å‹æ¡ç›®ï¼Œé€šè¿‡ç±»å‹ã€å‘é€è€…å’Œå†…å®¹åŒ¹é…
                if ('type' in log &&
                    'type' in entry &&
                    'sender' in log &&
                    'sender' in entry &&
                    'content' in log &&
                    'content' in entry &&
                    log.type === entry.type &&
                    log.sender === entry.sender) {
                    // å¯¹äºç®€å•ç±»å‹çš„å†…å®¹ï¼Œç›´æ¥æ¯”è¾ƒ
                    if (typeof log.content === 'string' && typeof entry.content === 'string') {
                        return log.content === entry.content;
                    }
                    // å¯¹äºå¤æ‚ç±»å‹çš„å†…å®¹ï¼Œä½¿ç”¨lodashæ·±åº¦æ¯”è¾ƒ
                    return window._.isEqual(log.content, entry.content);
                }
                return false;
            });
            if (entryIndex !== -1) {
                debug_logger_logger.debug('AiResponseManager', 'æ‰¾åˆ°å·²å­˜åœ¨çš„æ¡ç›®', {
                    entryIndex,
                    entryType: 'type' in entry ? entry.type : 'unknown',
                });
            }
            // åˆ¤æ–­æ¡ç›®ç±»å‹æ˜¯å¦æ˜¯éœ€è¦åŠ¨ç”»çš„"æ¶ˆæ¯"
            if ('type' in entry && messageLikeTypes.includes(entry.type)) {
                // æ˜¯æ¶ˆæ¯ï¼Œæ‰§è¡Œå®Œæ•´çš„åŠ¨ç”»æµç¨‹
                this.uiRenderer.showTypingIndicator();
                const messageText = entry.type === 'message' ? entry.content : entry.type === 'voice' ? entry.content.text : '';
                const delay = this.uiRenderer.calculateTypingDelay(messageText);
                await new Promise(resolve => setTimeout(resolve, delay));
                this.uiRenderer.hideTypingIndicator();
                this.uiRenderer.renderEntry(entry, entryIndex !== -1 ? entryIndex : undefined, true);
            }
            else if ('type' in entry && entry.type === 'recall_instruction') {
                // å¤„ç†æ’¤å›æŒ‡ä»¤ï¼Œä½¿ç”¨ç±»å‹æ–­è¨€
                const { originalEntry, recallTimestamp } = entry.content;
                // åœ¨å†…å­˜ä¸­æ‰¾åˆ°è¿™ä¸ªæ¡ç›®å¹¶æ ‡è®°
                const entryToUpdate = this.blmxManager.logEntries.find(log => 'id' in log && log.id === originalEntry.id);
                if (entryToUpdate) {
                    entryToUpdate.recalled = true;
                    entryToUpdate.recalled_content = originalEntry.content;
                    entryToUpdate.recalled_timestamp = recallTimestamp;
                    // è·å–æ¡ç›®åœ¨æ—¥å¿—ä¸­çš„ç´¢å¼•ï¼Œä»¥ä¾¿åœ¨åˆ é™¤æ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    const recallEntryIndex = this.blmxManager.logEntries.indexOf(entryToUpdate);
                    // åœ¨UIä¸Šæ‰¾åˆ°å¯¹åº”çš„DOMå…ƒç´ å¹¶æ›¿æ¢å®ƒ
                    const $elementToReplace = $(`[data-message-id="${originalEntry.id}"]`);
                    if ($elementToReplace.length) {
                        // ä½¿ç”¨ä¸€ä¸ªå°çš„å»¶è¿Ÿï¼Œè®©æ’¤å›åŠ¨ä½œçœ‹èµ·æ¥æ›´è‡ªç„¶
                        await new Promise(resolve => setTimeout(resolve, 500));
                        this.uiRenderer.renderRecallNotice(entryToUpdate, $elementToReplace[0], recallEntryIndex);
                    }
                }
            }
            else {
                // æ˜¯ç³»ç»Ÿäº‹ä»¶ (å¦‚ EVENT_LOG, TIME)ï¼Œç›´æ¥æ˜¾ç¤º
                this.uiRenderer.renderEntry(entry, entryIndex !== -1 ? entryIndex : undefined, true);
            }
            // åœ¨æ‰€æœ‰æ¡ç›®ä¹‹é—´éƒ½å¢åŠ ä¸€ä¸ªçŸ­æš‚çš„åœé¡¿ï¼Œè®©èŠ‚å¥æ›´èˆ’é€‚
            await new Promise(resolve => setTimeout(resolve, 800));
        }
        // æ˜¾ç¤ºå®Œæ‰€æœ‰æ¡ç›®ååˆ·æ–°æ—¶é—´æˆ³ï¼Œç¡®ä¿æ—¥æœŸæ ¼å¼æ­£ç¡®
        this.uiRenderer.refreshAllTimestamps();
    }
    /**
     * æ¸…ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
     */
    cleanup() {
        this.eventManager.cleanup();
    }
    // è·å–æœ€æ–°çš„AIåŸå§‹å“åº”
    getLatestAiRawResponse() {
        return this.latestAiRawResponse;
    }
    // è·å–æœ€æ–°å‘é€çš„æç¤ºè¯
    getLatestSentPrompt() {
        return this.latestSentPrompt;
    }
    // è·å–åŸå§‹AIå“åº”
    getRawAiResponse() {
        return this.rawAiResponse;
    }
    // è·å–å®Œæ•´æç¤ºè¯
    getFullPrompt() {
        return this.fullPrompt;
    }
}

;// ./src/åŒå±‚æ‰‹æœº/config-manager.ts
// é…ç½®ç®¡ç†æ¨¡å—
// è´Ÿè´£ç®¡ç†åº”ç”¨é…ç½®ã€å¸¸é‡å®šä¹‰å’Œé…ç½®åˆå§‹åŒ–

// å¸¸é‡å®šä¹‰
const STORAGE_KEYS = {
    GLOBAL_STICKER: 'blmx_wechat_stickers_global_blmx', // ä¿®æ”¹ä¸ºä¸åŸç‰ˆä¸€è‡´
    CHAR_STICKER_PREFIX: 'blmx_char_stickers_blmx_', // ä¿®æ”¹ä¸ºä¸åŸç‰ˆä¸€è‡´
    PHONE_SIZE: 'blmx_phone_size',
    FULLSCREEN_SIZE: 'blmx_fullscreen_size',
    STICKER_SIZE: 'blmx_sticker_size',
    MOMENT_NOTIFICATION: 'blmx_moment_notification',
    MOMENT_LAST_VIEW: 'blmx_moment_last_view',
    USER_NAME_PREFIX: 'blmx_user_name_',
    USER_AVATAR_PREFIX: 'blmx_user_avatar_',
    CHAR_AVATAR_PREFIX: 'blmx_char_avatar_',
    CHAR_REMARK_PREFIX: 'blmx_remark_',
    COVER_PHOTO_PREFIX: 'blmx_cover_photo_',
    SIGNATURE_PREFIX: 'blmx_signature_',
    INPUT_PLACEHOLDER_PREFIX: 'blmx_input_placeholder_',
    LAST_NOTIFIED_VERSION: 'blmx_last_notified_version',
};
// æ‰‹æœºå°ºå¯¸å¸¸é‡
const PHONE_SIZES = {
    default: '48.75rem', // é»˜è®¤å°ºå¯¸: 48.75rem (780px)
    medium: '42rem', // ä¸­ç­‰å°ºå¯¸: 42rem (672px)
    small: '36rem', // å°å°ºå¯¸: 36rem (576px)
};
// å…¨å±æ¨¡å¼æ‰‹æœºå¤§å°å¸¸é‡ï¼ˆç¼©æ”¾æ¯”ä¾‹ï¼‰
const FULLSCREEN_SIZES = {
    default: 100, // é»˜è®¤ï¼š100%
    large: 130, // å¤§ï¼š130%
    xlarge: 160, // è¶…å¤§ï¼š160%
};
// é…ç½®ç®¡ç†å™¨ç±»
class ConfigManager {
    config;
    defaultGlobalStickers = [{ label: 'å¥½çš„', url: 'https://files.catbox.moe/3j0tpc.jpeg' }];
    constructor() {
        // åˆå§‹åŒ–é»˜è®¤é…ç½®
        this.config = {
            avatars: { user: '', char: '' },
            names: { user: 'User', char: 'Character' },
            charRemark: '',
            currentCharId: '',
        };
    }
    // è·å–é…ç½®
    getConfig() {
        return this.config;
    }
    // è®¾ç½®é…ç½®
    setConfig(config) {
        this.config = { ...this.config, ...config };
    }
    // è·å–æ˜¾ç¤ºåç§°
    getDisplayName(type) {
        if (type === 'char') {
            return this.config.charRemark || this.config.names.char;
        }
        return this.config.names.user;
    }
    // æ›´æ–°å¤´åƒ
    updateAvatar(avatarType, newUrl) {
        this.config.avatars[avatarType] = newUrl;
        const storageKey = avatarType === 'user'
            ? `${STORAGE_KEYS.USER_AVATAR_PREFIX}${this.config.currentCharId}`
            : `${STORAGE_KEYS.CHAR_AVATAR_PREFIX}${this.config.currentCharId}`;
        localStorage.setItem(storageKey, newUrl);
    }
    // æ›´æ–°è§’è‰²å¤‡æ³¨
    updateCharRemark(newRemark) {
        this.config.charRemark = newRemark;
        localStorage.setItem(`${STORAGE_KEYS.CHAR_REMARK_PREFIX}${this.config.currentCharId}`, newRemark);
    }
    // æ›´æ–°ç”¨æˆ·å
    updateUserName(newName) {
        this.config.names.user = newName;
        localStorage.setItem(`${STORAGE_KEYS.USER_NAME_PREFIX}${this.config.currentCharId}`, newName);
    }
    // æŸ¥æ‰¾è¡¨æƒ…åŒ…URL - å¢åŠ å‘åå…¼å®¹æ€§
    findStickerUrlByName(name) {
        // å°è¯•ä»æ–°çš„å­˜å‚¨é”®è¯»å–
        let customGlobalStickers = SafeStorage.getItem(STORAGE_KEYS.GLOBAL_STICKER, []) || [];
        let charStickers = SafeStorage.getItem(`${STORAGE_KEYS.CHAR_STICKER_PREFIX}${this.config.currentCharId}`, []) || [];
        // å¦‚æœæ–°å­˜å‚¨é”®æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»æ—§å­˜å‚¨é”®è¿ç§»
        if (customGlobalStickers.length === 0) {
            const oldGlobalStickers = SafeStorage.getItem('blmx_wechat_stickers_global', []) || [];
            if (oldGlobalStickers.length > 0) {
                // è¿ç§»æ•°æ®åˆ°æ–°å­˜å‚¨é”®
                SafeStorage.setItem(STORAGE_KEYS.GLOBAL_STICKER, oldGlobalStickers);
                customGlobalStickers = oldGlobalStickers;
                console.log('[BLMX] å·²è¿ç§»å…¨å±€è¡¨æƒ…åŒ…æ•°æ®åˆ°æ–°å­˜å‚¨é”®');
            }
        }
        if (charStickers.length === 0) {
            const oldCharStickers = SafeStorage.getItem(`blmx_char_stickers_${this.config.currentCharId}`, []) || [];
            if (oldCharStickers.length > 0) {
                // è¿ç§»æ•°æ®åˆ°æ–°å­˜å‚¨é”®
                SafeStorage.setItem(`${STORAGE_KEYS.CHAR_STICKER_PREFIX}${this.config.currentCharId}`, oldCharStickers);
                charStickers = oldCharStickers;
                console.log('[BLMX] å·²è¿ç§»è§’è‰²è¡¨æƒ…åŒ…æ•°æ®åˆ°æ–°å­˜å‚¨é”®');
            }
        }
        const globalStickers = [...this.defaultGlobalStickers, ...customGlobalStickers];
        return [...globalStickers, ...charStickers].find((s) => s.label === name)?.url;
    }
    // ä»localStorageåŠ è½½é…ç½®
    async loadFromStorage(charData) {
        this.config.currentCharId = charData.name;
        this.config.names.char = charData.name;
        // åŠ è½½ä¿å­˜çš„é…ç½®
        this.config.charRemark =
            localStorage.getItem(`${STORAGE_KEYS.CHAR_REMARK_PREFIX}${this.config.currentCharId}`) || '';
        this.config.names.user =
            localStorage.getItem(`${STORAGE_KEYS.USER_NAME_PREFIX}${this.config.currentCharId}`) || 'User';
        this.config.avatars.user =
            localStorage.getItem(`${STORAGE_KEYS.USER_AVATAR_PREFIX}${this.config.currentCharId}`) || '';
        // åŠ è½½è§’è‰²å¤´åƒ
        const savedCharAvatar = localStorage.getItem(`${STORAGE_KEYS.CHAR_AVATAR_PREFIX}${this.config.currentCharId}`);
        if (savedCharAvatar) {
            this.config.avatars.char = savedCharAvatar;
        }
        else {
            // è¿™é‡Œéœ€è¦ä»å¤–éƒ¨è·å–è§’è‰²å¤´åƒè·¯å¾„
            // åœ¨å®é™…ä½¿ç”¨æ—¶ä¼šé€šè¿‡å‚æ•°ä¼ å…¥
            this.config.avatars.char = '';
        }
    }
    // è·å–æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€
    getMomentNotificationState() {
        const notificationState = localStorage.getItem(`${STORAGE_KEYS.MOMENT_NOTIFICATION}_${this.config.currentCharId}`);
        return notificationState === 'true';
    }
    // è®¾ç½®æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€
    setMomentNotificationState(value) {
        localStorage.setItem(`${STORAGE_KEYS.MOMENT_NOTIFICATION}_${this.config.currentCharId}`, value.toString());
    }
    // è·å–æœ€åæŸ¥çœ‹æœ‹å‹åœˆæ—¶çš„æ—¶é—´æˆ³
    getLastMomentViewTimestamp() {
        const lastView = localStorage.getItem(`${STORAGE_KEYS.MOMENT_LAST_VIEW}_${this.config.currentCharId}`);
        return lastView ? parseInt(lastView, 10) : 0;
    }
    // è®¾ç½®æœ€åæŸ¥çœ‹æœ‹å‹åœˆæ—¶çš„æ—¶é—´æˆ³
    setLastMomentViewTimestamp(timestamp) {
        localStorage.setItem(`${STORAGE_KEYS.MOMENT_LAST_VIEW}_${this.config.currentCharId}`, timestamp.toString());
    }
    // è·å–ä¿å­˜çš„å°é¢å›¾ç‰‡
    getSavedCoverPhoto() {
        return localStorage.getItem(`${STORAGE_KEYS.COVER_PHOTO_PREFIX}${this.config.currentCharId}`);
    }
    // è®¾ç½®å°é¢å›¾ç‰‡
    setCoverPhoto(url) {
        localStorage.setItem(`${STORAGE_KEYS.COVER_PHOTO_PREFIX}${this.config.currentCharId}`, url);
    }
    // è·å–ä¿å­˜çš„ä¸ªæ€§ç­¾å
    getSavedSignature() {
        return localStorage.getItem(`${STORAGE_KEYS.SIGNATURE_PREFIX}${this.config.currentCharId}`) || '';
    }
    // è®¾ç½®ä¸ªæ€§ç­¾å
    setSignature(signature) {
        localStorage.setItem(`${STORAGE_KEYS.SIGNATURE_PREFIX}${this.config.currentCharId}`, signature);
    }
    // è·å–ä¿å­˜çš„è¾“å…¥æ¡†å ä½ç¬¦
    getSavedInputPlaceholder() {
        return localStorage.getItem(`${STORAGE_KEYS.INPUT_PLACEHOLDER_PREFIX}${this.config.currentCharId}`);
    }
    // è®¾ç½®è¾“å…¥æ¡†å ä½ç¬¦
    setInputPlaceholder(placeholder) {
        localStorage.setItem(`${STORAGE_KEYS.INPUT_PLACEHOLDER_PREFIX}${this.config.currentCharId}`, placeholder);
    }
    // è·å–æ‰‹æœºå°ºå¯¸è®¾ç½®
    getPhoneSize() {
        const savedSize = localStorage.getItem(STORAGE_KEYS.PHONE_SIZE) || 'default';
        return savedSize === 'medium' ? 'medium' : savedSize === 'small' ? 'small' : 'default';
    }
    // è®¾ç½®æ‰‹æœºå°ºå¯¸
    setPhoneSize(size) {
        localStorage.setItem(STORAGE_KEYS.PHONE_SIZE, size);
    }
    // è·å–å…¨å±æ¨¡å¼æ‰‹æœºå¤§å°è®¾ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
    getFullscreenSize() {
        const savedSize = localStorage.getItem(STORAGE_KEYS.FULLSCREEN_SIZE) || '100';
        const size = parseInt(savedSize, 10);
        // ç¡®ä¿åœ¨æœ‰æ•ˆèŒƒå›´å†…
        return Math.max(50, Math.min(200, size));
    }
    // è®¾ç½®å…¨å±æ¨¡å¼æ‰‹æœºå¤§å°ï¼ˆç™¾åˆ†æ¯”ï¼‰
    setFullscreenSize(size) {
        // ç¡®ä¿åœ¨æœ‰æ•ˆèŒƒå›´å†…
        const clampedSize = Math.max(50, Math.min(200, size));
        localStorage.setItem(STORAGE_KEYS.FULLSCREEN_SIZE, clampedSize.toString());
    }
    // è·å–è¡¨æƒ…åŒ…å°ºå¯¸è®¾ç½®
    getStickerSize() {
        const savedSize = localStorage.getItem(STORAGE_KEYS.STICKER_SIZE) || '120';
        return parseInt(savedSize, 10);
    }
    // è®¾ç½®è¡¨æƒ…åŒ…å°ºå¯¸
    setStickerSize(size) {
        localStorage.setItem(STORAGE_KEYS.STICKER_SIZE, size.toString());
    }
    // è·å–ç‰ˆæœ¬é€šçŸ¥çŠ¶æ€
    getLastNotifiedVersion() {
        return localStorage.getItem(STORAGE_KEYS.LAST_NOTIFIED_VERSION);
    }
    // è®¾ç½®ç‰ˆæœ¬é€šçŸ¥çŠ¶æ€
    setLastNotifiedVersion(version) {
        localStorage.setItem(STORAGE_KEYS.LAST_NOTIFIED_VERSION, version);
    }
}

;// ./src/åŒå±‚æ‰‹æœº/debug-data.ts
// debug-data.ts
// æ­¤æ–‡ä»¶åŒ…å«ç”¨äºæµ‹è¯•å’Œè°ƒè¯•çš„æ•°æ®
// åœ¨å‘å¸ƒå‰åº”åˆ é™¤æˆ–æ³¨é‡Šæ‰å¯¹æ­¤æ–‡ä»¶çš„å¼•ç”¨
// è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
const getCurrentDate = () => {
    const now = new Date();
    return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now
        .getDate()
        .toString()
        .padStart(2, '0')}`;
};
const getCurrentTime = () => {
    const now = new Date();
    return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
};
// ç”ŸæˆéšæœºID
const debug_data_generateId = (prefix) => {
    return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
};
// æµ‹è¯•æ•°æ®
const debugData = [
    // ç³»ç»Ÿæ—¶é—´æ¡ç›®
    {
        type: 'time',
        content: {
            date: getCurrentDate(),
            time: getCurrentTime(),
        },
    },
    // ç³»ç»Ÿäº‹ä»¶æ¡ç›®
    {
        type: 'event',
        content: {
            date: getCurrentDate(),
            time: getCurrentTime(),
            description: 'è°ƒè¯•æ¨¡å¼å·²å¯ç”¨',
        },
    },
    // æ–‡æœ¬æ¶ˆæ¯ - ç”¨æˆ·
    {
        id: debug_data_generateId('msg'),
        type: 'message',
        sender: 'me',
        content: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯',
    },
    // æ–‡æœ¬æ¶ˆæ¯ - AI
    {
        id: debug_data_generateId('msg'),
        type: 'message',
        sender: 'them',
        content: 'ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï¼Œè¿™æ˜¯ä¸€æ¡AIå›å¤çš„æµ‹è¯•æ¶ˆæ¯ã€‚',
    },
    // è¡¨æƒ…æ¶ˆæ¯ - ç”¨æˆ·
    {
        id: debug_data_generateId('sticker'),
        type: 'sticker',
        sender: 'me',
        content: 'å¥½çš„',
    },
    // è¡¨æƒ…æ¶ˆæ¯ - AI
    {
        id: debug_data_generateId('sticker'),
        type: 'sticker',
        sender: 'them',
        content: 'å¥½çš„',
    },
    // å›¾ç‰‡æ¶ˆæ¯ - ç”¨æˆ·
    {
        id: debug_data_generateId('img'),
        type: 'image',
        sender: 'me',
        content: {
            type: 'url',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_1.jpg',
        },
    },
    // å›¾ç‰‡æ¶ˆæ¯ - AI
    {
        id: debug_data_generateId('img'),
        type: 'image',
        sender: 'them',
        content: {
            type: 'url',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ˜Ÿæ˜Ÿ_1.jpg',
        },
    },
    // å›¾ç‰‡æ¶ˆæ¯ - æè¿°ç±»å‹
    {
        id: debug_data_generateId('img'),
        type: 'image',
        sender: 'them',
        content: {
            type: 'desc',
            value: 'è¿™æ˜¯ä¸€å¼ æè¿°ç±»å‹çš„å›¾ç‰‡ï¼Œå®é™…ä¸Šä¸ä¼šæ˜¾ç¤ºå›¾ç‰‡å†…å®¹',
        },
    },
    // è¯­éŸ³æ¶ˆæ¯ - ç”¨æˆ·
    {
        id: debug_data_generateId('voice'),
        type: 'voice',
        sender: 'me',
        content: {
            text: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯­éŸ³æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹',
            duration: 5,
        },
    },
    // è¯­éŸ³æ¶ˆæ¯ - AI
    {
        id: debug_data_generateId('voice'),
        type: 'voice',
        sender: 'them',
        content: {
            text: 'è¿™æ˜¯AIå›å¤çš„è¯­éŸ³æ¶ˆæ¯æ–‡æœ¬å†…å®¹',
            duration: 8,
        },
    },
    // ä½ç½®æ¶ˆæ¯ - ç”¨æˆ·
    {
        id: debug_data_generateId('loc'),
        type: 'location',
        sender: 'me',
        content: 'åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯',
    },
    // ä½ç½®æ¶ˆæ¯ - AI
    {
        id: debug_data_generateId('loc'),
        type: 'location',
        sender: 'them',
        content: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºé™†å®¶å˜´',
    },
    // è½¬è´¦æ¶ˆæ¯ - ç”¨æˆ·å‘é€
    {
        id: debug_data_generateId('transfer'),
        type: 'transfer',
        sender: 'me',
        content: JSON.stringify({
            amount: '88.88',
            note: 'æµ‹è¯•è½¬è´¦',
            status: 'sent',
        }),
        data: {
            amount: '88.88',
            note: 'æµ‹è¯•è½¬è´¦',
            status: 'sent',
        },
    },
    // è½¬è´¦æ¶ˆæ¯ - AIæ¥å—
    {
        id: debug_data_generateId('transfer'),
        type: 'transfer',
        sender: 'them',
        content: JSON.stringify({
            amount: '88.88',
            note: 'æµ‹è¯•è½¬è´¦',
            status: 'accepted',
        }),
        data: {
            amount: '88.88',
            note: 'æµ‹è¯•è½¬è´¦',
            status: 'accepted',
        },
    },
    // è½¬è´¦æ¶ˆæ¯ - AIå‘é€
    {
        id: debug_data_generateId('transfer'),
        type: 'transfer',
        sender: 'them',
        content: JSON.stringify({
            amount: '66.66',
            note: 'AIæµ‹è¯•è½¬è´¦',
            status: 'sent',
        }),
        data: {
            amount: '66.66',
            note: 'AIæµ‹è¯•è½¬è´¦',
            status: 'sent',
        },
    },
    // è½¬è´¦æ¶ˆæ¯ - ç”¨æˆ·æ¥å—
    {
        id: debug_data_generateId('transfer'),
        type: 'transfer',
        sender: 'me',
        content: JSON.stringify({
            amount: '66.66',
            note: 'AIæµ‹è¯•è½¬è´¦',
            status: 'accepted',
        }),
        data: {
            amount: '66.66',
            note: 'AIæµ‹è¯•è½¬è´¦',
            status: 'accepted',
        },
    },
    // ç¤¼ç‰©æ¶ˆæ¯ - ç”¨æˆ·å‘é€
    {
        id: debug_data_generateId('gift'),
        type: 'gift',
        sender: 'me',
        content: JSON.stringify({
            name: 'ç”Ÿæ—¥è›‹ç³•',
            price: '99.99',
            status: 'sent',
        }),
        data: {
            name: 'ç”Ÿæ—¥è›‹ç³•',
            price: '99.99',
            status: 'sent',
        },
    },
    // ç¤¼ç‰©æ¶ˆæ¯ - AIæ¥å—
    {
        id: debug_data_generateId('gift'),
        type: 'gift',
        sender: 'them',
        content: JSON.stringify({
            name: 'ç”Ÿæ—¥è›‹ç³•',
            status: 'accepted',
        }),
        data: {
            name: 'ç”Ÿæ—¥è›‹ç³•',
            status: 'accepted',
        },
    },
    // ç¤¼ç‰©æ¶ˆæ¯ - AIå‘é€
    {
        id: debug_data_generateId('gift'),
        type: 'gift',
        sender: 'them',
        content: JSON.stringify({
            name: 'å·§å…‹åŠ›',
            price: '39.99',
            status: 'sent',
        }),
        data: {
            name: 'å·§å…‹åŠ›',
            price: '39.99',
            status: 'sent',
        },
    },
    // ç¤¼ç‰©æ¶ˆæ¯ - ç”¨æˆ·æ¥å—
    {
        id: debug_data_generateId('gift'),
        type: 'gift',
        sender: 'me',
        content: JSON.stringify({
            name: 'å·§å…‹åŠ›',
            status: 'accepted',
        }),
        data: {
            name: 'å·§å…‹åŠ›',
            status: 'accepted',
        },
    },
    // æ–‡ä»¶æ¶ˆæ¯ - ç”¨æˆ·
    {
        id: debug_data_generateId('file'),
        type: 'file',
        sender: 'me',
        content: 'æµ‹è¯•æ–‡æ¡£.docx',
    },
    // æ–‡ä»¶æ¶ˆæ¯ - AI
    {
        id: debug_data_generateId('file'),
        type: 'file',
        sender: 'them',
        content: 'é‡è¦èµ„æ–™.pdf',
    },
    // æœ‹å‹åœˆ - ç”¨æˆ·å‘å¸ƒ
    {
        key: 'USER_MOMENT',
        data: {
            text: 'è¿™æ˜¯ç”¨æˆ·å‘å¸ƒçš„æœ‹å‹åœˆæµ‹è¯•å†…å®¹',
            image: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_2.jpg',
            image_type: 'url',
            date: getCurrentDate(),
            time: getCurrentTime(),
        },
    },
    // æœ‹å‹åœˆ - AIå‘å¸ƒ
    {
        key: 'CHAR_MOMENT',
        data: {
            text: 'è¿™æ˜¯AIå‘å¸ƒçš„æœ‹å‹åœˆæµ‹è¯•å†…å®¹',
            image: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²å°çŒ«_1.jpg',
            image_type: 'url',
            date: getCurrentDate(),
            time: getCurrentTime(),
        },
    },
    // æœ‹å‹åœˆ - çº¯æ–‡æœ¬
    {
        key: 'CHAR_MOMENT',
        data: {
            text: 'è¿™æ˜¯ä¸€æ¡æ²¡æœ‰å›¾ç‰‡çš„æœ‹å‹åœˆ',
            image: '',
            image_type: 'none',
            date: getCurrentDate(),
            time: getCurrentTime(),
        },
    },
    // æœ‹å‹åœˆ - å›¾ç‰‡æè¿°
    {
        key: 'USER_MOMENT',
        data: {
            text: 'è¿™æ˜¯å¸¦æœ‰å›¾ç‰‡æè¿°çš„æœ‹å‹åœˆ',
            image: 'ä¸€å¼ ç¾ä¸½çš„é£æ™¯ç…§ç‰‡',
            image_type: 'desc',
            image_desc: 'ä¸€å¼ ç¾ä¸½çš„é£æ™¯ç…§ç‰‡',
            date: getCurrentDate(),
            time: getCurrentTime(),
        },
    },
    // æœ‹å‹åœˆè¯„è®º - ç”¨æˆ·è¯„è®º
    {
        key: 'USER_COMMENT',
        data: {
            text: 'è¿™æ˜¯ç”¨æˆ·çš„è¯„è®º',
            target_post_id: 1,
        },
    },
    // æœ‹å‹åœˆè¯„è®º - AIè¯„è®º
    {
        key: 'CHAR_COMMENT',
        data: {
            text: 'è¿™æ˜¯AIçš„è¯„è®º',
            target_post_id: 0,
        },
    },
    // æœ‹å‹åœˆç‚¹èµ - ç”¨æˆ·ç‚¹èµ
    {
        key: 'USER_LIKE',
        data: {
            target_post_id: 1,
        },
    },
    // æœ‹å‹åœˆç‚¹èµ - AIç‚¹èµ
    {
        key: 'CHAR_LIKE',
        data: {
            target_post_id: 0,
        },
    },
    // æ’¤å›æ¶ˆæ¯ç¤ºä¾‹
    {
        id: debug_data_generateId('msg'),
        type: 'message',
        sender: 'them',
        content: 'è¿™æ¡æ¶ˆæ¯å°†è¢«æ’¤å›',
        recalled: true,
        recalled_content: 'è¿™æ¡æ¶ˆæ¯å°†è¢«æ’¤å›',
        recalled_timestamp: getCurrentTime(),
    },
];
// åŠ è½½è°ƒè¯•æ•°æ®çš„å‡½æ•° - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå‡å°‘æ€§èƒ½æ¶ˆè€—
function loadDebugData(blmxManager) {
    // æ£€æŸ¥æ˜¯å¦åœ¨å¼€å‘æ¨¡å¼
    const isDevelopment = window.location.hostname === 'localhost' || window.location.search.includes('debug=true');
    if (!isDevelopment) {
        console.log('[DEBUG] ç”Ÿäº§æ¨¡å¼ï¼Œè·³è¿‡è°ƒè¯•æ•°æ®åŠ è½½');
        return;
    }
    console.log('[DEBUG] æ­£åœ¨åŠ è½½è°ƒè¯•æ•°æ®...');
    // æ‰¹é‡æ·»åŠ ï¼Œå‡å°‘å•æ¬¡æ“ä½œ
    const batchSize = 10;
    let index = 0;
    const addBatch = () => {
        const batch = debugData.slice(index, index + batchSize);
        batch.forEach(entry => {
            blmxManager.addEntry(entry);
        });
        index += batchSize;
        if (index < debugData.length) {
            // ä½¿ç”¨requestAnimationFrameé¿å…é˜»å¡UI
            requestAnimationFrame(addBatch);
        }
        else {
            console.log('[DEBUG] è°ƒè¯•æ•°æ®åŠ è½½å®Œæˆï¼Œå…±åŠ è½½', debugData.length, 'æ¡æ•°æ®');
        }
    };
    addBatch();
}
// æ¸…é™¤è°ƒè¯•æ•°æ®çš„å‡½æ•°
function clearDebugData(blmxManager) {
    console.log('[DEBUG] æ­£åœ¨æ¸…é™¤è°ƒè¯•æ•°æ®...');
    blmxManager.logEntries = [];
    console.log('[DEBUG] è°ƒè¯•æ•°æ®å·²æ¸…é™¤');
}
// æ·»åŠ å•ä¸ªæµ‹è¯•æ•°æ®çš„å‡½æ•°ï¼Œæ–¹ä¾¿åœ¨æ§åˆ¶å°ä¸­ä½¿ç”¨
function addTestEntry(blmxManager, entryType) {
    let entry = null;
    switch (entryType) {
        case 'text-user':
            entry = {
                id: debug_data_generateId('msg'),
                type: 'message',
                sender: 'me',
                content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ–‡æœ¬æ¶ˆæ¯',
            };
            break;
        case 'text-char':
            entry = {
                id: debug_data_generateId('msg'),
                type: 'message',
                sender: 'them',
                content: 'è¿™æ˜¯ä¸€æ¡AIå›å¤çš„æµ‹è¯•æ¶ˆæ¯',
            };
            break;
        case 'sticker-user':
            entry = {
                id: debug_data_generateId('sticker'),
                type: 'sticker',
                sender: 'me',
                content: 'å¥½çš„',
            };
            break;
        case 'sticker-char':
            entry = {
                id: debug_data_generateId('sticker'),
                type: 'sticker',
                sender: 'them',
                content: 'å¥½çš„',
            };
            break;
        case 'image-user':
            entry = {
                id: debug_data_generateId('img'),
                type: 'image',
                sender: 'me',
                content: {
                    type: 'url',
                    value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_1.jpg',
                },
            };
            break;
        case 'image-char':
            entry = {
                id: debug_data_generateId('img'),
                type: 'image',
                sender: 'them',
                content: {
                    type: 'url',
                    value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ˜Ÿæ˜Ÿ_1.jpg',
                },
            };
            break;
        case 'voice-user':
            entry = {
                id: debug_data_generateId('voice'),
                type: 'voice',
                sender: 'me',
                content: {
                    text: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯­éŸ³æ¶ˆæ¯',
                    duration: 3,
                },
            };
            break;
        case 'voice-char':
            entry = {
                id: debug_data_generateId('voice'),
                type: 'voice',
                sender: 'them',
                content: {
                    text: 'è¿™æ˜¯AIçš„æµ‹è¯•è¯­éŸ³æ¶ˆæ¯',
                    duration: 4,
                },
            };
            break;
        case 'transfer-user':
            entry = {
                id: debug_data_generateId('transfer'),
                type: 'transfer',
                sender: 'me',
                content: JSON.stringify({
                    amount: '88.88',
                    note: 'æµ‹è¯•è½¬è´¦',
                    status: 'sent',
                }),
                data: {
                    amount: '88.88',
                    note: 'æµ‹è¯•è½¬è´¦',
                    status: 'sent',
                },
            };
            break;
        case 'transfer-char':
            entry = {
                id: debug_data_generateId('transfer'),
                type: 'transfer',
                sender: 'them',
                content: JSON.stringify({
                    amount: '66.66',
                    note: 'AIæµ‹è¯•è½¬è´¦',
                    status: 'sent',
                }),
                data: {
                    amount: '66.66',
                    note: 'AIæµ‹è¯•è½¬è´¦',
                    status: 'sent',
                },
            };
            break;
        case 'gift-user':
            entry = {
                id: debug_data_generateId('gift'),
                type: 'gift',
                sender: 'me',
                content: JSON.stringify({
                    name: 'ç”Ÿæ—¥è›‹ç³•',
                    price: '99.99',
                    status: 'sent',
                }),
                data: {
                    name: 'ç”Ÿæ—¥è›‹ç³•',
                    price: '99.99',
                    status: 'sent',
                },
            };
            break;
        case 'gift-char':
            entry = {
                id: debug_data_generateId('gift'),
                type: 'gift',
                sender: 'them',
                content: JSON.stringify({
                    name: 'å·§å…‹åŠ›',
                    price: '39.99',
                    status: 'sent',
                }),
                data: {
                    name: 'å·§å…‹åŠ›',
                    price: '39.99',
                    status: 'sent',
                },
            };
            break;
        case 'moment-user':
            entry = {
                key: 'USER_MOMENT',
                data: {
                    text: 'ç”¨æˆ·æœ‹å‹åœˆæµ‹è¯•',
                    image: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_2.jpg',
                    image_type: 'url',
                    date: getCurrentDate(),
                    time: getCurrentTime(),
                },
            };
            break;
        case 'moment-char':
            entry = {
                key: 'CHAR_MOMENT',
                data: {
                    text: 'AIæœ‹å‹åœˆæµ‹è¯•',
                    image: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²å°çŒ«_1.jpg',
                    image_type: 'url',
                    date: getCurrentDate(),
                    time: getCurrentTime(),
                },
            };
            break;
        case 'event-short':
            entry = {
                type: 'event',
                content: {
                    date: getCurrentDate(),
                    time: getCurrentTime(),
                    description: 'è¿™æ˜¯ä¸€ä¸ªç®€çŸ­çš„äº‹ä»¶æ—¥å¿—æµ‹è¯•',
                },
            };
            break;
        case 'event-long':
            entry = {
                type: 'event',
                content: {
                    date: getCurrentDate(),
                    time: getCurrentTime(),
                    description: 'è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„äº‹ä»¶æ—¥å¿—æµ‹è¯•ï¼Œç”¨æ¥éªŒè¯é•¿æ–‡æœ¬çš„æ˜¾ç¤ºæ•ˆæœã€‚åœ¨ç‰©è¯­ä¸–ç•Œçš„æ·±å¤„ï¼Œéšè—ç€æ— æ•°çš„ç§˜å¯†å’Œä¼ è¯´ã€‚æ¯å½“å¤œå¹•é™ä¸´ï¼Œæ˜Ÿå…‰æ´’å‘å¤§åœ°ï¼Œé‚£äº›å¤è€çš„æ•…äº‹ä¾¿ä¼šåœ¨é£ä¸­è½»å£°è¯‰è¯´ã€‚ä¸»è§’è¸ä¸Šäº†å¯»æ‰¾çœŸç›¸çš„æ—…ç¨‹ï¼Œç©¿è¶Šäº†æ£®æ—ã€å±±å·å’Œæµ·æ´‹ï¼Œé‡åˆ°äº†å„ç§å„æ ·çš„äººç‰©å’ŒæŒ‘æˆ˜ã€‚è¿™æ®µæ—…ç¨‹ä¸ä»…æ˜¯å¯¹å¤–åœ¨ä¸–ç•Œçš„æ¢ç´¢ï¼Œæ›´æ˜¯å¯¹å†…å¿ƒæ·±å¤„çš„è‡ªæˆ‘å‘ç°ã€‚',
                },
            };
            break;
        case 'time':
            entry = {
                type: 'time',
                content: {
                    date: getCurrentDate(),
                    time: getCurrentTime(),
                },
            };
            break;
        default:
            console.error('[DEBUG] æœªçŸ¥çš„æµ‹è¯•æ•°æ®ç±»å‹:', entryType);
            return;
    }
    if (entry) {
        blmxManager.addEntry(entry);
        blmxManager.persistLogToStorage();
        console.log(`[DEBUG] å·²æ·»åŠ æµ‹è¯•æ•°æ®: ${entryType}`, entry);
    }
}
// æ˜¾ç¤ºæµ‹è¯•æ¡ç›®ç±»å‹
function showTestEntryTypes() {
    console.log('[BLMX Debug] å¯ç”¨çš„æµ‹è¯•æ¡ç›®ç±»å‹:');
    console.log('- text-user: ç”¨æˆ·æ–‡æœ¬æ¶ˆæ¯');
    console.log('- text-char: AIæ–‡æœ¬æ¶ˆæ¯');
    console.log('- sticker-user: ç”¨æˆ·è¡¨æƒ…æ¶ˆæ¯');
    console.log('- sticker-char: AIè¡¨æƒ…æ¶ˆæ¯');
    console.log('- image-user: ç”¨æˆ·å›¾ç‰‡æ¶ˆæ¯');
    console.log('- image-char: AIå›¾ç‰‡æ¶ˆæ¯');
    console.log('- voice-user: ç”¨æˆ·è¯­éŸ³æ¶ˆæ¯');
    console.log('- voice-char: AIè¯­éŸ³æ¶ˆæ¯');
    console.log('- transfer-user: ç”¨æˆ·è½¬è´¦æ¶ˆæ¯');
    console.log('- gift-user: ç”¨æˆ·ç¤¼ç‰©æ¶ˆæ¯');
    console.log('- moment-user: ç”¨æˆ·æœ‹å‹åœˆåŠ¨æ€');
    console.log('- moment-char: AIæœ‹å‹åœˆåŠ¨æ€');
    console.log('- event-short: çŸ­äº‹ä»¶æ—¥å¿—');
    console.log('- event-long: é•¿äº‹ä»¶æ—¥å¿—ï¼ˆæµ‹è¯•é•¿æ–‡æœ¬æ˜¾ç¤ºï¼‰');
    console.log('- time: æ—¶é—´æˆ³');
}
// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebugInfo(appController) {
    console.log('[BLMX Debug] è°ƒè¯•ä¿¡æ¯:');
    try {
        // ç¡®ä¿èƒ½å¤Ÿè·å–åˆ°è¿™äº›æ–¹æ³•
        const rawAiResponse = appController.getRawAiResponse ? appController.getRawAiResponse() : 'æ— æ³•è·å–';
        const fullPrompt = appController.getFullPrompt ? appController.getFullPrompt() : 'æ— æ³•è·å–';
        const latestAiRawResponse = appController.getLatestAiRawResponse
            ? appController.getLatestAiRawResponse()
            : 'æ— æ³•è·å–';
        const latestSentPrompt = appController.getLatestSentPrompt ? appController.getLatestSentPrompt() : 'æ— æ³•è·å–';
        console.log('- åŸå§‹AIå“åº”:', rawAiResponse);
        console.log('- å®Œæ•´æç¤ºè¯:', fullPrompt);
        console.log('- æœ€æ–°å¤„ç†åçš„AIå“åº”:', latestAiRawResponse);
        console.log('- æœ€æ–°å‘é€ç»™AIçš„æç¤º:', latestSentPrompt);
    }
    catch (error) {
        console.error('[BLMX Debug] è·å–è°ƒè¯•ä¿¡æ¯æ—¶å‡ºé”™:', error);
    }
}

// EXTERNAL MODULE: ./src/åŒå±‚æ‰‹æœº/dialog-manager.ts
var dialog_manager = __webpack_require__(895);
;// ./src/åŒå±‚æ‰‹æœº/input-handler.ts
// è¾“å…¥å¤„ç†æ¨¡å—
// è´Ÿè´£æ¶ˆæ¯å‘é€ã€æ–‡ä»¶ä¸Šä¼ ã€è¯­éŸ³å½•åˆ¶ã€è¡¨æƒ…åŒ…é€‰æ‹©ç­‰åŠŸèƒ½

class InputHandler {
    configManager;
    onStageAndDisplayEntry;
    onUpdateFooterButtonsState;
    dialogManager;
    constructor(configManager, onStageAndDisplayEntry, onUpdateFooterButtonsState) {
        this.configManager = configManager;
        this.onStageAndDisplayEntry = onStageAndDisplayEntry;
        this.onUpdateFooterButtonsState = onUpdateFooterButtonsState;
        this.dialogManager = dialog_manager.DialogManager.getInstance();
    }
    // å¤„ç†è½¬è´¦æ¥å—
    async handleTransferAccept(data) {
        const result = await this.dialogManager.showReceiveDialog('transfer', data);
        if (result === 'accept') {
            const acceptData = { ...data, status: 'accepted' };
            this.onStageAndDisplayEntry({
                type: 'transfer',
                sender: 'me',
                content: JSON.stringify(acceptData),
                data: acceptData,
                id: `transfer-${Date.now()}`,
            });
        }
        else if (result === 'reject') {
            const rejectData = { ...data, status: 'rejected' };
            this.onStageAndDisplayEntry({
                type: 'transfer',
                sender: 'me',
                content: JSON.stringify(rejectData),
                data: rejectData,
                id: `transfer-${Date.now()}`,
            });
        }
    }
    // å¤„ç†ç¤¼ç‰©åŠ¨ä½œ
    async handleGiftAction(data) {
        const result = await this.dialogManager.showReceiveDialog('gift', data);
        if (result === 'accept') {
            const receiptData = { name: data.name, status: 'accepted' };
            this.onStageAndDisplayEntry({
                type: 'gift',
                sender: 'me',
                content: JSON.stringify(receiptData),
                data: receiptData,
                id: `gift-${Date.now()}`,
            });
        }
        else if (result === 'reject') {
            const receiptData = { name: data.name, status: 'rejected' };
            this.onStageAndDisplayEntry({
                type: 'gift',
                sender: 'me',
                content: JSON.stringify(receiptData),
                data: receiptData,
                id: `gift-${Date.now()}`,
            });
        }
        // é€šçŸ¥æœ‰å¾…å¤„ç†çš„é€šçŸ¥
        this.onUpdateFooterButtonsState();
    }
    // å‘é€æ–‡æœ¬æ¶ˆæ¯
    sendTextMessage(text) {
        if (!text.trim())
            return;
        const messageEntry = {
            type: 'message',
            sender: 'me',
            content: text.trim(),
            id: `msg-${Date.now()}-${Math.random()}`,
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(messageEntry);
        this.onUpdateFooterButtonsState();
    }
    // å‘é€è¡¨æƒ…åŒ… - ç®€åŒ–æ•°æ®ç»“æ„
    sendSticker(stickerName) {
        const stickerUrl = this.configManager.findStickerUrlByName(stickerName);
        if (!stickerUrl) {
            console.error(`[BLMX] æœªæ‰¾åˆ°è¡¨æƒ…åŒ…: ${stickerName}`);
            return;
        }
        // ä½¿ç”¨ç®€å•çš„æ•°æ®ç»“æ„ï¼Œä¸åŸç‰ˆä¿æŒä¸€è‡´
        const stickerEntry = {
            type: 'sticker',
            sender: 'me',
            content: stickerName, // ç›´æ¥å­˜å‚¨è¡¨æƒ…åŒ…åç§°
            id: `sticker-${Date.now()}-${Math.random()}`, // æ¢å¤åŸæ¥çš„IDæ ¼å¼ä»¥ä¿æŒå…¼å®¹æ€§
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(stickerEntry);
        this.onUpdateFooterButtonsState();
    }
    // å‘é€å›¾ç‰‡
    sendImage(imageData) {
        const imageEntry = {
            type: 'image',
            sender: 'me',
            content: imageData,
            id: `image-${Date.now()}-${Math.random()}`,
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(imageEntry);
        this.onUpdateFooterButtonsState();
    }
    // å‘é€è¯­éŸ³æ¶ˆæ¯
    sendVoiceMessage(voiceData) {
        const voiceEntry = {
            type: 'voice',
            sender: 'me',
            content: voiceData,
            id: `voice-${Date.now()}-${Math.random()}`,
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(voiceEntry);
        this.onUpdateFooterButtonsState();
    }
    // å‘é€ä½ç½®ä¿¡æ¯
    sendLocation(locationData) {
        const locationEntry = {
            type: 'location',
            sender: 'me',
            content: locationData,
            id: `location-${Date.now()}-${Math.random()}`,
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(locationEntry);
        this.onUpdateFooterButtonsState();
    }
    // å‘é€æ–‡ä»¶
    sendFile(fileData) {
        const fileEntry = {
            type: 'file',
            sender: 'me',
            content: fileData,
            id: `file-${Date.now()}-${Math.random()}`,
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(fileEntry);
        this.onUpdateFooterButtonsState();
    }
    // å‘é€è½¬è´¦
    sendTransfer(transferData) {
        const transferEntry = {
            type: 'transfer',
            sender: 'me',
            content: transferData,
            id: `transfer-${Date.now()}-${Math.random()}`,
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(transferEntry);
        this.onUpdateFooterButtonsState();
    }
    // å‘é€ç¤¼ç‰©
    sendGift(giftData) {
        const giftEntry = {
            type: 'gift',
            sender: 'me',
            content: giftData,
            id: `gift-${Date.now()}-${Math.random()}`,
            timestamp: Date.now(),
        };
        this.onStageAndDisplayEntry(giftEntry);
        this.onUpdateFooterButtonsState();
    }
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    async handleFileUpload(file) {
        try {
            if (file.type.startsWith('image/')) {
                // å¤„ç†å›¾ç‰‡æ–‡ä»¶
                const reader = new FileReader();
                reader.onload = e => {
                    const result = e.target?.result;
                    this.sendImage({
                        type: 'file',
                        value: result,
                        name: file.name,
                    });
                };
                reader.readAsDataURL(file);
            }
            else {
                // å¤„ç†å…¶ä»–æ–‡ä»¶ç±»å‹
                this.sendFile({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                });
            }
        }
        catch (error) {
            console.error('[BLMX] æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
            const dialogManager = dialog_manager.DialogManager.getInstance();
            await dialogManager.alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'ä¸Šä¼ å¤±è´¥');
        }
    }
    // å¤„ç†å›¾ç‰‡URLè¾“å…¥
    async handleImageUrl(url) {
        if (!url.trim())
            return;
        // éªŒè¯URLæ ¼å¼
        try {
            new URL(url);
            this.sendImage({
                type: 'url',
                value: url.trim(),
            });
        }
        catch (error) {
            const dialogManager = dialog_manager.DialogManager.getInstance();
            await dialogManager.alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URL', 'URLæ ¼å¼é”™è¯¯');
        }
    }
    // å¤„ç†è¯­éŸ³å½•åˆ¶
    async handleVoiceRecording() {
        try {
            const dialogManager = dialog_manager.DialogManager.getInstance();
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³å½•åˆ¶
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                await dialogManager.alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³å½•åˆ¶åŠŸèƒ½', 'ä¸æ”¯æŒè¯­éŸ³å½•åˆ¶');
                return;
            }
            // è¯·æ±‚éº¦å…‹é£æƒé™
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            // è¿™é‡Œå¯ä»¥é›†æˆè¯­éŸ³å½•åˆ¶åº“ï¼Œå¦‚ MediaRecorder API
            // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿè¯­éŸ³å½•åˆ¶
            const text = await dialogManager.prompt('è¯·è¾“å…¥è¯­éŸ³å†…å®¹ï¼ˆæ¨¡æ‹Ÿè¯­éŸ³è½¬æ–‡å­—ï¼‰:', '', 'è¯­éŸ³å½•åˆ¶');
            if (text) {
                this.sendVoiceMessage({
                    text: text.trim(),
                    duration: Math.floor(Math.random() * 30) + 5, // æ¨¡æ‹Ÿ5-35ç§’çš„è¯­éŸ³
                });
            }
            // åœæ­¢å½•åˆ¶
            stream.getTracks().forEach(track => track.stop());
        }
        catch (error) {
            console.error('[BLMX] è¯­éŸ³å½•åˆ¶å¤±è´¥:', error);
            const dialogManager = dialog_manager.DialogManager.getInstance();
            await dialogManager.alert('è¯­éŸ³å½•åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™ã€‚', 'å½•åˆ¶å¤±è´¥');
        }
    }
    // å¤„ç†ä½ç½®åˆ†äº«
    handleLocationShare() {
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåœ°ç†ä½ç½®
        if (!navigator.geolocation) {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½');
            return;
        }
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const locationName = prompt('è¯·è¾“å…¥ä½ç½®åç§°:') || 'æˆ‘çš„ä½ç½®';
            const address = prompt('è¯·è¾“å…¥è¯¦ç»†åœ°å€:') || `çº¬åº¦: ${latitude.toFixed(6)}, ç»åº¦: ${longitude.toFixed(6)}`;
            this.sendLocation({
                name: locationName,
                address: address,
                latitude: latitude,
                longitude: longitude,
            });
        }, error => {
            console.error('[BLMX] è·å–ä½ç½®å¤±è´¥:', error);
            // å…è®¸ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ä½ç½®ä¿¡æ¯
            const locationName = prompt('æ— æ³•è·å–å½“å‰ä½ç½®ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ä½ç½®åç§°:');
            const address = prompt('è¯·è¾“å…¥è¯¦ç»†åœ°å€:');
            if (locationName && address) {
                this.sendLocation({
                    name: locationName,
                    address: address,
                });
            }
        });
    }
    // å¤„ç†è½¬è´¦å‘é€
    handleTransferSend() {
        const amountStr = prompt('è¯·è¾“å…¥è½¬è´¦é‡‘é¢:');
        if (!amountStr)
            return;
        const amount = parseFloat(amountStr);
        if (isNaN(amount) || amount <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
            return;
        }
        const note = prompt('è¯·è¾“å…¥è½¬è´¦å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:') || '';
        this.sendTransfer({
            amount: amount,
            note: note,
        });
    }
    // å¤„ç†ç¤¼ç‰©å‘é€
    handleGiftSend() {
        const giftName = prompt('è¯·è¾“å…¥ç¤¼ç‰©åç§°:');
        if (!giftName)
            return;
        const giftImage = prompt('è¯·è¾“å…¥ç¤¼ç‰©å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰:') || '';
        const description = prompt('è¯·è¾“å…¥ç¤¼ç‰©æè¿°ï¼ˆå¯é€‰ï¼‰:') || '';
        this.sendGift({
            name: giftName,
            image: giftImage,
            description: description,
        });
    }
    // è·å–è¡¨æƒ…åŒ…åˆ—è¡¨ - å¢åŠ å‘åå…¼å®¹æ€§
    getStickerList() {
        // å°è¯•ä»æ–°çš„å­˜å‚¨é”®è¯»å–
        let globalStickers = JSON.parse(localStorage.getItem('blmx_wechat_stickers_global_blmx') || '[]');
        let charStickers = JSON.parse(localStorage.getItem(`blmx_char_stickers_blmx_${this.configManager.getConfig().currentCharId}`) || '[]');
        // å¦‚æœæ–°å­˜å‚¨é”®æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»æ—§å­˜å‚¨é”®è¯»å–
        if (globalStickers.length === 0) {
            const oldGlobalStickers = JSON.parse(localStorage.getItem('blmx_wechat_stickers_global') || '[]');
            if (oldGlobalStickers.length > 0) {
                globalStickers = oldGlobalStickers;
            }
        }
        if (charStickers.length === 0) {
            const oldCharStickers = JSON.parse(localStorage.getItem(`blmx_char_stickers_${this.configManager.getConfig().currentCharId}`) || '[]');
            if (oldCharStickers.length > 0) {
                charStickers = oldCharStickers;
            }
        }
        return [...globalStickers, ...charStickers];
    }
    // æœç´¢è¡¨æƒ…åŒ…
    searchStickers(query) {
        const stickers = this.getStickerList();
        if (!query.trim())
            return stickers;
        const searchTerm = query.toLowerCase();
        return stickers.filter(sticker => sticker.label.toLowerCase().includes(searchTerm));
    }
    // æ¸…ç©ºè¾“å…¥æ¡†
    clearInput() {
        const inputElement = document.getElementById('wechat-input-field');
        if (inputElement) {
            inputElement.value = '';
            this.onUpdateFooterButtonsState();
        }
    }
    // è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹
    focusInput() {
        const inputElement = document.getElementById('wechat-input-field');
        if (inputElement) {
            inputElement.focus();
        }
    }
    // è·å–è¾“å…¥æ¡†å†…å®¹
    getInputText() {
        const inputElement = document.getElementById('wechat-input-field');
        return inputElement ? inputElement.value : '';
    }
    // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
    setInputText(text) {
        const inputElement = document.getElementById('wechat-input-field');
        if (inputElement) {
            inputElement.value = text;
            this.onUpdateFooterButtonsState();
        }
    }
}

;// ./src/åŒå±‚æ‰‹æœº/moments-manager.ts
// æœ‹å‹åœˆç®¡ç†æ¨¡å—
// è´Ÿè´£æœ‹å‹åœˆæ¸²æŸ“ã€é€šçŸ¥ç®¡ç†ã€æ—¶é—´æ ¼å¼åŒ–ç­‰åŠŸèƒ½
class MomentsManager {
    blmxManager;
    configManager;
    uiRenderer;
    hasMomentNotification = false;
    constructor(blmxManager, configManager, uiRenderer) {
        this.blmxManager = blmxManager;
        this.configManager = configManager;
        this.uiRenderer = uiRenderer;
        // åˆå§‹åŒ–é€šçŸ¥çŠ¶æ€
        this.hasMomentNotification = this.configManager.getMomentNotificationState();
    }
    // æ¸²æŸ“æœ‹å‹åœˆ
    renderMomentsFeed() {
        if (!this.blmxManager || !this.uiRenderer)
            return;
        const logEntries = this.blmxManager.logEntries;
        const avatars = this.configManager.getConfig().avatars;
        // ä½¿ç”¨jQueryé€‰æ‹©å™¨
        const $momentsFeedList = $('#moments-feed-list');
        if (!$momentsFeedList.length)
            return;
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æœ‹å‹åœˆç•Œé¢ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ–°æœ€åæŸ¥çœ‹æ—¶é—´æˆ³
        const isCurrentlyInMomentsView = this.isInMomentsView();
        if (isCurrentlyInMomentsView) {
            this.setLastMomentViewTimestamp();
            // æ¸…é™¤æœ‹å‹åœˆé€šçŸ¥ï¼Œå› ä¸ºç”¨æˆ·æ­£åœ¨æŸ¥çœ‹æœ‹å‹åœˆ
            this.setMomentNotification(false);
        }
        $momentsFeedList.empty();
        // ä½¿ç”¨lodashè¿›è¡Œæ•°æ®å¤„ç†
        const posts = {};
        const momentPostLogIndices = _.reduce(logEntries, (result, entry, index) => {
            if ('key' in entry && entry.key.includes('_MOMENT')) {
                result.push(index);
            }
            return result;
        }, []);
        // æ”¶é›†æ‰€æœ‰å¸–å­
        _.forEach(momentPostLogIndices, (logIndex) => {
            const entry = logEntries[logIndex];
            posts[logIndex] = { ...entry, likes: [], comments: [], id: logIndex };
        });
        // æ£€æŸ¥æ˜¯å¦æœ‰CHARå‘è¡¨çš„æ–°æœ‹å‹åœˆæˆ–è¯„è®º
        let hasNewCharMoments = false;
        const lastViewTimestamp = this.getLastMomentViewTimestamp();
        const userInMomentsView = this.isInMomentsView();
        // å¤„ç†ç‚¹èµå’Œè¯„è®º
        _.forEach(logEntries, (entry, index) => {
            if ('key' in entry && (entry.key.includes('_LIKE') || entry.key.includes('_COMMENT'))) {
                // ä¿®å¤target_post_idçš„å¤„ç†é€»è¾‘ï¼Œä½¿ç”¨ä¸åŸç‰ˆç›¸åŒçš„æ–¹å¼
                const targetPostAbsoluteIndex = momentPostLogIndices[parseInt(entry.data.target_post_id, 10)];
                const targetPost = posts[targetPostAbsoluteIndex];
                if (targetPost) {
                    if (entry.key.includes('_LIKE')) {
                        const likerName = entry.key.startsWith('USER') ? this.getDisplayName('user') : this.getDisplayName('char');
                        if (!_.some(targetPost.likes, (l) => l.name === likerName)) {
                            targetPost.likes.push({ key: entry.key, name: likerName, originalLogIndex: index });
                            // å¦‚æœæ˜¯CHARç‚¹èµï¼Œä¸”ç”¨æˆ·ä¸åœ¨æœ‹å‹åœˆç•Œé¢ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ´»åŠ¨
                            if (entry.key.startsWith('CHAR') && !userInMomentsView) {
                                // ä½¿ç”¨ç´¢å¼•ä½ç½®æ¥åˆ¤æ–­æ˜¯å¦æ˜¯æ–°æ´»åŠ¨ï¼š
                                // å¦‚æœè¿™ä¸ªç‚¹èµåœ¨æ—¥å¿—ä¸­çš„ç´¢å¼•å¤§äºæœ€åæŸ¥çœ‹æœ‹å‹åœˆæ—¶ä¿å­˜çš„æ—¥å¿—é•¿åº¦ï¼Œè¯´æ˜è¿™æ˜¯æ–°æ´»åŠ¨
                                const isNewActivity = index > lastViewTimestamp;
                                if (isNewActivity) {
                                    hasNewCharMoments = true;
                                }
                            }
                        }
                    }
                    else {
                        targetPost.comments.push({ ...entry, originalLogIndex: index });
                        // å¦‚æœæ˜¯CHARè¯„è®ºï¼Œä¸”ç”¨æˆ·ä¸åœ¨æœ‹å‹åœˆç•Œé¢ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ´»åŠ¨
                        if (entry.key.startsWith('CHAR') && !userInMomentsView) {
                            // ä½¿ç”¨ç´¢å¼•ä½ç½®æ¥åˆ¤æ–­æ˜¯å¦æ˜¯æ–°æ´»åŠ¨
                            const isNewActivity = index > lastViewTimestamp;
                            if (isNewActivity) {
                                hasNewCharMoments = true;
                            }
                        }
                    }
                }
                else {
                    console.warn(`[BLMX] Could not find target post for interaction. target_post_id: ${entry.data.target_post_id}, available posts: ${Object.keys(posts).join(', ')}`, entry);
                }
            }
            // æ£€æŸ¥CHARå‘è¡¨çš„æœ‹å‹åœˆ
            if ('key' in entry && entry.key === 'CHAR_MOMENT') {
                // ä½¿ç”¨ç´¢å¼•ä½ç½®åˆ¤æ–­æ˜¯å¦æ˜¯æ–°æœ‹å‹åœˆ
                const isNewMoment = index > lastViewTimestamp;
                // åªæœ‰å½“æ˜¯æ–°æœ‹å‹åœˆä¸”ç”¨æˆ·ä¸åœ¨æœ‹å‹åœˆç•Œé¢æ—¶æ‰æ˜¾ç¤ºé€šçŸ¥
                if (isNewMoment && !userInMomentsView) {
                    hasNewCharMoments = true;
                }
            }
        });
        // æ›´æ–°æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€ - åªæœ‰å½“æœ‰æ–°æ´»åŠ¨ä¸”ç”¨æˆ·ä¸åœ¨æœ‹å‹åœˆç•Œé¢æ—¶æ‰è®¾ç½®é€šçŸ¥
        if (!userInMomentsView) {
            this.setMomentNotification(hasNewCharMoments);
            // console.log('[BLMX] æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€:', {
            //   hasNewCharMoments,
            //   lastViewIndex: this.getLastMomentViewTimestamp(),
            //   currentLogLength: this.blmxManager.logEntries.length,
            //   userInMomentsView,
            // });
        }
        // åè½¬å¸–å­é¡ºåºå¹¶æ¸²æŸ“
        _.chain(posts)
            .values()
            .reverse()
            .forEach((post) => {
            const fromUser = post.key.startsWith('USER');
            const authorName = fromUser ? this.getDisplayName('user') : this.getDisplayName('char');
            const authorAvatar = fromUser ? avatars.user : avatars.char;
            const $li = $('<li>').addClass('moment-post').attr('data-post-id', post.id);
            const momentSequenceId = momentPostLogIndices.indexOf(post.id);
            $li.attr('data-moment-sequence-id', String(momentSequenceId));
            // è®¾ç½®moment-idå±æ€§ï¼Œä½¿ç”¨momentSequenceIdä½œä¸ºæœ‹å‹åœˆçš„å”¯ä¸€æ ‡è¯†ç¬¦
            // è¿™æ ·å¯ä»¥ç¡®ä¿ç‚¹èµå’Œè¯„è®ºæ­£ç¡®å…³è”åˆ°å¯¹åº”çš„æœ‹å‹åœˆ
            $li.attr('data-moment-id', String(momentSequenceId));
            // æ„å»ºåª’ä½“HTML
            let mediaHtml = '';
            if (post.data.image_type === 'url' && post.data.image) {
                mediaHtml = `<img src="${post.data.image}" class="post-media-image" />`;
            }
            else if (post.data.image_type === 'desc' && post.data.image) {
                mediaHtml = `<div class="image-desc-content"><div class="text-wrapper">${post.data.image}</div></div>`;
            }
            // æ„å»ºäº’åŠ¨åŒºåŸŸHTML
            let interactionsHtml = '';
            if (post.likes.length > 0 || post.comments.length > 0) {
                const likersHtml = post.likes.length > 0
                    ? `<div class="likes-section"><i class="fas fa-heart"></i> ${_.map(post.likes, (l) => `<span class="liker-name">${l.name}</span>`).join(', ')}</div>`
                    : '';
                const commentsHtml = post.comments.length > 0
                    ? `<ul class="comments-section">${_.map(post.comments, (c) => `<li><span class="comment-author">${c.key.startsWith('USER') ? this.getDisplayName('user') : this.getDisplayName('char')}</span>: ${c.data.text}</li>`).join('')}</ul>`
                    : '';
                interactionsHtml = `<div class="post-interactions">${likersHtml}${commentsHtml}</div>`;
            }
            // ä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼åŒ–æ—¶é—´å‡½æ•°
            const displayTime = this.formatMomentTime(post.data.date, post.data.time);
            const deleteBtnHtml = `<span class="delete-moment-btn" title="åˆ é™¤">åˆ é™¤</span>`;
            $li.html(`<img src="${authorAvatar}" class="post-author-avatar" />
                 <div class="post-details">
                     <span class="post-author-name">${authorName}</span>
                     <p class="post-content">${post.data.text || ''}</p>
                     <div class="post-media">${mediaHtml}</div>
                     <div class="post-meta">
                         <div class="post-meta-left">
                             <span class="timestamp">${displayTime}</span>
                             ${deleteBtnHtml}
                         </div>
                         <div class="post-actions">
                             <span class="comment-button" title="è¯„è®º/ç‚¹èµ"><i class="fas fa-comment-dots"></i></span>
                         </div>
                     </div>
                     ${interactionsHtml}
                 </div>`);
            $momentsFeedList.append($li);
        })
            .value();
        // ç¡®ä¿åŠ è½½æœ€æ–°çš„å°é¢å›¾ç‰‡
        const savedCoverPhoto = this.configManager.getSavedCoverPhoto();
        if (savedCoverPhoto) {
            $('#moments-cover-photo').attr('src', savedCoverPhoto);
        }
    }
    // æ ¼å¼åŒ–æœ‹å‹åœˆæ—¶é—´æ˜¾ç¤º
    formatMomentTime(dateString, timeString) {
        try {
            // ä½¿ç”¨æ¸¸æˆå†…æ—¶é—´è€Œéç°å®æ—¶é—´
            const now = window.currentGameDate ? new Date(window.currentGameDate) : new Date();
            const date = new Date(`${dateString} ${timeString}`);
            const diffMs = now.getTime() - date.getTime();
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            if (diffMins < 1) {
                return 'åˆšåˆš';
            }
            else if (diffMins < 60) {
                return `${diffMins}åˆ†é’Ÿå‰`;
            }
            else if (diffHours < 24) {
                return `${diffHours}å°æ—¶å‰`;
            }
            else if (diffDays === 1) {
                return 'æ˜¨å¤©';
            }
            else if (diffDays === 2) {
                return 'å‰å¤©';
            }
            else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            }
            else {
                // è¶…è¿‡ä¸€å‘¨æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}æœˆ${day}æ—¥`;
            }
        }
        catch (error) {
            console.error('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', error);
            return `${dateString} ${timeString}`;
        }
    }
    // è·å–æ˜¾ç¤ºåç§°
    getDisplayName(type) {
        return this.configManager.getDisplayName(type);
    }
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æœ‹å‹åœˆç•Œé¢
    isInMomentsView() {
        return $('#moments-view').hasClass('active');
    }
    // è·å–æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€
    hasMomentNotifications() {
        return this.configManager.getMomentNotificationState();
    }
    // è®¾ç½®æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€
    setMomentNotification(value) {
        this.hasMomentNotification = value;
        this.configManager.setMomentNotificationState(value);
        // æ›´æ–°UIä¸­çš„é€šçŸ¥æŒ‡ç¤ºå™¨
        this.updateMomentNotificationIndicator();
    }
    // æ›´æ–°æœ‹å‹åœˆé€šçŸ¥æŒ‡ç¤ºå™¨
    updateMomentNotificationIndicator() {
        const $optionsBtn = $('#wechat-options-btn');
        if (this.hasMomentNotification) {
            if (!$optionsBtn.find('.notification-dot').length) {
                $optionsBtn.append('<span class="notification-dot"></span>');
            }
        }
        else {
            $optionsBtn.find('.notification-dot').remove();
        }
    }
    // è·å–æœ€åæŸ¥çœ‹æœ‹å‹åœˆæ—¶çš„æ—¶é—´æˆ³
    getLastMomentViewTimestamp() {
        return this.configManager.getLastMomentViewTimestamp();
    }
    // è®¾ç½®æœ€åæŸ¥çœ‹æœ‹å‹åœˆæ—¶çš„æ—¶é—´æˆ³
    setLastMomentViewTimestamp() {
        // ä¿å­˜å½“å‰æ—¥å¿—é•¿åº¦ä½œä¸ºæœ€åæŸ¥çœ‹æ—¶é—´ç‚¹
        const currentLogLength = this.blmxManager.logEntries.length;
        this.configManager.setLastMomentViewTimestamp(currentLogLength);
    }
    // è¿›å…¥æœ‹å‹åœˆè§†å›¾æ—¶çš„å¤„ç†
    onEnterMomentsView() {
        // console.log('[BLMX] è¿›å…¥æœ‹å‹åœˆè§†å›¾ï¼Œæ¸…é™¤é€šçŸ¥å¹¶æ›´æ–°æœ€åæŸ¥çœ‹æ—¶é—´');
        // ä½¿ç”¨jQueryæ›´æ–°å°é¢å›¾ç‰‡
        const savedCoverPhoto = this.configManager.getSavedCoverPhoto();
        if (savedCoverPhoto) {
            $('#moments-cover-photo').attr('src', savedCoverPhoto);
        }
        // ä½¿ç”¨jQueryæ›´æ–°ä¸ªæ€§ç­¾å
        const savedSignature = this.configManager.getSavedSignature();
        $('#user-signature-display').text(savedSignature || 'ç‚¹å‡»å¤´åƒè®¾ç½®ä¸ªæ€§ç­¾å');
        // æ¸…é™¤æœ‹å‹åœˆé€šçŸ¥
        this.setMomentNotification(false);
        // æ›´æ–°æœ€åæŸ¥çœ‹æœ‹å‹åœˆçš„æ—¶é—´æˆ³
        this.setLastMomentViewTimestamp();
        // è®°å½•å½“å‰æ—¥å¿—é•¿åº¦ç”¨äºè°ƒè¯•
        // console.log('[BLMX] æ›´æ–°æœ‹å‹åœˆæœ€åæŸ¥çœ‹ç´¢å¼•ä¸º:', this.blmxManager.logEntries.length);
    }
    // åˆ›å»ºç”¨æˆ·æœ‹å‹åœˆåŠ¨æ€
    createUserMoment(text, image = '', imageType = 'none') {
        // è·å–å½“å‰æ—¥æœŸæ—¶é—´
        const now = window.currentGameDate || new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        return {
            key: 'USER_MOMENT',
            data: {
                text,
                image,
                image_type: imageType,
                date: dateStr,
                time: timeStr,
            },
        };
    }
    // å‘é€æœ‹å‹åœˆåŠ¨æ€é€šçŸ¥ï¼ˆç”¨äºç”¨æˆ·åã€ç­¾åç­‰å˜æ›´ï¼‰
    notifyMomentChange(type, _oldValue, newValue) {
        let text = '';
        switch (type) {
            case 'name':
                text = `æˆ‘æ”¹åå­—å•¦ï¼Œæ–°åå­—æ˜¯"${newValue}"`;
                break;
            case 'signature':
                text = `æˆ‘çš„ä¸ªæ€§ç­¾åå·²æ›´æ”¹ä¸ºï¼š"${newValue}"`;
                break;
        }
        const momentEntry = this.createUserMoment(text);
        // æ·»åŠ åˆ°èŠå¤©è®°å½•
        this.blmxManager.addEntry(momentEntry);
        this.renderMomentsFeed();
    }
    // å¤„ç†æ¶ˆæ¯æ’¤å›çš„æœ‹å‹åœˆé€šçŸ¥
    notifyRecallViaMoments(sender, targetText) {
        // è·å–å½“å‰æ—¥æœŸæ—¶é—´
        const now = window.currentGameDate || new Date();
        const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        // åˆ›å»ºæ’¤å›é€šçŸ¥æ¡ç›®
        const recallEntry = {
            key: 'RECALL',
            data: {
                sender: sender,
                target_text: targetText,
                timestamp: `${timeStr}`,
            },
        };
        // æ·»åŠ åˆ°èŠå¤©è®°å½•
        this.blmxManager.addEntry(recallEntry);
        return recallEntry;
    }
}

;// ./src/åŒå±‚æ‰‹æœº/theme-editor.ts
class ThemeEditor {
    themeManager;
    onThemeChanged;
    $modal;
    checkboxHandlers = new Map();
    constructor(themeManager, onThemeChanged) {
        this.themeManager = themeManager;
        this.onThemeChanged = onThemeChanged;
        this.$modal = $('#theme-editor-modal');
    }
    // è®¾ç½®ä¸»é¢˜é€‰æ‹©å™¨ - ä½¿ç”¨jQueryé‡æ„
    setupThemeSelector() {
        const $container = $('.theme-options');
        if (!$container.length)
            return;
        // æ¸…ç©ºç°æœ‰å†…å®¹
        $container.empty();
        // è·å–æ‰€æœ‰é»˜è®¤ä¸»é¢˜
        const themes = this.themeManager.getThemes();
        // ä½¿ç”¨lodashéå†ä¸»é¢˜
        _.forEach(themes, theme => {
            const $themeButton = $('<div>').addClass('theme-option').css({
                width: 'calc(50% - 0.5rem)',
                'aspect-ratio': '1/1',
                'border-radius': '8px',
                'background-color': theme.colors.primary,
                display: 'flex',
                'flex-direction': 'column',
                'align-items': 'center',
                'justify-content': 'center',
                cursor: 'pointer',
                position: 'relative',
                overflow: 'hidden',
                'box-shadow': '0 2px 8px rgba(0,0,0,0.1)',
            });
            // æ·»åŠ ä¸»é¢˜é¢„è§ˆ
            const $previewEl = $('<div>').css({
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: '100%',
                background: `linear-gradient(135deg, ${theme.colors.gradientStart}, ${theme.colors.gradientEnd})`,
            });
            // æ·»åŠ æ°”æ³¡é¢„è§ˆ
            const $bubblePreview = $('<div>').css({
                position: 'relative',
                width: '70%',
                height: '60%',
                display: 'flex',
                'flex-direction': 'column',
                'justify-content': 'space-between',
                'z-index': 1,
            });
            const $themBubble = $('<div>').css({
                'align-self': 'flex-start',
                width: '60%',
                height: '40%',
                'background-color': theme.colors.bubbleThemBg,
                'border-radius': '8px',
            });
            const $meBubble = $('<div>').css({
                'align-self': 'flex-end',
                width: '60%',
                height: '40%',
                'background-color': theme.colors.bubbleMeBg,
                'border-radius': '8px',
            });
            $bubblePreview.append($themBubble, $meBubble);
            // æ·»åŠ ä¸»é¢˜åç§°
            const $nameEl = $('<div>').text(theme.displayName).css({
                position: 'relative',
                color: 'white',
                'font-size': '0.8rem',
                'font-weight': '500',
                'margin-top': '5px',
                'text-shadow': '0 1px 2px rgba(0,0,0,0.3)',
                'z-index': 1,
            });
            $themeButton.append($previewEl, $bubblePreview, $nameEl);
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            $themeButton.on('click', () => {
                this.themeManager.switchTheme(theme.name);
                // é€šçŸ¥ä¸»é¢˜å·²æ›´æ”¹
                if (this.onThemeChanged) {
                    this.onThemeChanged();
                }
            });
            $container.append($themeButton);
        });
        // æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜é€‰æ‹©æŒ‰é’®ï¼ˆæ­£æ–¹å½¢ï¼Œç”¨äºåˆ‡æ¢ä¸»é¢˜ï¼‰
        this.addCustomThemeSelector($container);
    }
    // æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜ç¼–è¾‘æŒ‰é’®ï¼ˆé•¿æ–¹å½¢ï¼Œç”¨äºæ‰“å¼€ç¼–è¾‘å™¨ï¼‰
    addCustomThemeEditButton() {
        // æŸ¥æ‰¾è®¾ç½®é¢æ¿ä¸­çš„æŒ‰é’®å®¹å™¨
        const $settingsPanel = $('.settings-panel');
        if (!$settingsPanel.length)
            return;
        // åˆ›å»ºé•¿æ–¹å½¢çš„ç¼–è¾‘æŒ‰é’®
        const $editButton = $('<div>').addClass('custom-theme-edit-button').css({
            width: '100%',
            padding: '12px 16px',
            margin: '8px 0',
            'border-radius': '8px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            color: 'white',
            'font-size': '0.9rem',
            'font-weight': '500',
            'text-align': 'center',
            cursor: 'pointer',
            'box-shadow': '0 2px 8px rgba(0,0,0,0.1)',
            transition: 'all 0.2s ease',
            display: 'flex',
            'align-items': 'center',
            'justify-content': 'center',
            gap: '8px',
        });
        const $icon = $('<span>').html('ğŸ¨');
        const $text = $('<span>').text('è‡ªå®šä¹‰ä¸»é¢˜è®¾ç½®');
        $editButton.append($icon, $text);
        // æ·»åŠ æ‚¬åœæ•ˆæœ
        $editButton
            .on('mouseenter', function () {
            $(this).css('transform', 'translateY(-1px)');
        })
            .on('mouseleave', function () {
            $(this).css('transform', 'translateY(0)');
        });
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        $editButton.on('click', () => {
            this.openThemeEditor();
        });
        // å°†æŒ‰é’®æ·»åŠ åˆ°è®¾ç½®é¢æ¿çš„é€‚å½“ä½ç½®
        // æŸ¥æ‰¾ä¸»é¢˜é€‰æ‹©å™¨å®¹å™¨ï¼Œåœ¨å…¶åæ·»åŠ ç¼–è¾‘æŒ‰é’®
        const $themeOptions = $settingsPanel.find('.theme-options');
        if ($themeOptions.length) {
            $themeOptions.after($editButton);
        }
        else {
            $settingsPanel.append($editButton);
        }
    }
    // æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜é€‰æ‹©æŒ‰é’®ï¼ˆæ­£æ–¹å½¢ï¼Œç”¨äºåˆ‡æ¢åˆ°è‡ªå®šä¹‰ä¸»é¢˜ï¼‰
    addCustomThemeSelector($container) {
        // è·å–è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®
        const customThemeData = this.getCustomThemeData();
        const $customButton = $('<div>').addClass('theme-option custom-theme-option').css({
            width: 'calc(50% - 0.5rem)',
            'aspect-ratio': '1/1',
            'border-radius': '8px',
            background: customThemeData.background,
            display: 'flex',
            'flex-direction': 'column',
            'align-items': 'center',
            'justify-content': 'center',
            cursor: 'pointer',
            position: 'relative',
            overflow: 'hidden',
            'box-shadow': '0 2px 8px rgba(0,0,0,0.1)',
        });
        // æ·»åŠ æ¸å˜èƒŒæ™¯é¢„è§ˆï¼ˆç±»ä¼¼å…¶ä»–ä¸»é¢˜æŒ‰é’®ï¼‰
        const $previewEl = $('<div>').css({
            position: 'absolute',
            top: 0,
            left: 0,
            width: '100%',
            height: '100%',
            background: customThemeData.gradient,
        });
        const $iconEl = $('<div>').html('âœ¨').css({
            'font-size': '2rem',
            'margin-bottom': '5px',
            position: 'relative',
            'z-index': 1,
        });
        const $nameEl = $('<div>').text(customThemeData.displayName).css({
            color: 'white',
            'font-size': '0.8rem',
            'font-weight': '500',
            'text-shadow': '0 1px 2px rgba(0,0,0,0.3)',
            position: 'relative',
            'z-index': 1,
        });
        $customButton.append($previewEl, $iconEl, $nameEl);
        $customButton.on('click', () => {
            // åˆ‡æ¢åˆ°è‡ªå®šä¹‰ä¸»é¢˜
            this.themeManager.switchTheme('custom');
            // é€šçŸ¥ä¸»é¢˜å·²æ›´æ”¹
            if (this.onThemeChanged) {
                this.onThemeChanged();
            }
        });
        $container.append($customButton);
    }
    // è·å–è‡ªå®šä¹‰ä¸»é¢˜æ•°æ®ï¼ˆåç§°å’Œé¢œè‰²ï¼‰
    getCustomThemeData() {
        try {
            const customThemeJson = localStorage.getItem('blmx_custom_theme');
            if (customThemeJson) {
                const customTheme = JSON.parse(customThemeJson);
                const primaryColor = customTheme.colors?.primary || '#667eea';
                const gradientStart = customTheme.colors?.gradientStart || primaryColor;
                const gradientEnd = customTheme.colors?.gradientEnd || primaryColor;
                return {
                    displayName: customTheme.displayName || 'è‡ªå®šä¹‰ä¸»é¢˜',
                    background: primaryColor,
                    gradient: `linear-gradient(135deg, ${gradientStart}, ${gradientEnd})`,
                };
            }
        }
        catch (error) {
            console.warn('Failed to load custom theme data:', error);
        }
        // é»˜è®¤å€¼
        return {
            displayName: 'è‡ªå®šä¹‰ä¸»é¢˜',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        };
    }
    // æ›´æ–°è‡ªå®šä¹‰ä¸»é¢˜æŒ‰é’®çš„æ˜¾ç¤ºï¼ˆå…¬å…±æ–¹æ³•ï¼‰
    updateCustomThemeButton() {
        const $customButton = $('.custom-theme-option');
        if (!$customButton.length)
            return;
        const customThemeData = this.getCustomThemeData();
        // æ›´æ–°èƒŒæ™¯æ¸å˜é¢„è§ˆå±‚
        const $previewEl = $customButton.children().eq(0); // ç¬¬ä¸€ä¸ªå­å…ƒç´ æ˜¯é¢„è§ˆå±‚
        if ($previewEl.length) {
            $previewEl.css('background', customThemeData.gradient);
        }
        // æ›´æ–°ä¸»é¢˜åç§°ï¼ˆæœ€åä¸€ä¸ªå­å…ƒç´ ï¼‰
        const $nameEl = $customButton.children().last();
        if ($nameEl.length && $nameEl.text() !== customThemeData.displayName) {
            $nameEl.text(customThemeData.displayName);
        }
        // æ›´æ–°æŒ‰é’®æ•´ä½“èƒŒæ™¯è‰²
        $customButton.css('background', customThemeData.background);
    }
    // æ‰“å¼€ä¸»é¢˜ç¼–è¾‘å™¨ - ä½¿ç”¨jQueryé‡æ„
    openThemeEditor() {
        if (!this.$modal.length)
            return;
        // è·å–å½“å‰ä¸»é¢˜çš„å®é™…åº”ç”¨æ•°æ®ï¼ˆåŒ…æ‹¬åŠ¨æ€è®¡ç®—çš„å€¼ï¼‰
        const currentTheme = this.themeManager.getCurrentThemeWithAppliedValues();
        this.fillThemeEditor(currentTheme);
        // è®¾ç½®checkboxäº‹ä»¶ç›‘å¬å™¨
        this.setupCheckboxes();
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        this.$modal.show();
    }
    // å…³é—­ä¸»é¢˜ç¼–è¾‘å™¨ - ä½¿ç”¨jQueryé‡æ„
    closeThemeEditor() {
        this.$modal.hide();
        // æ¸…ç†checkboxäº‹ä»¶ç›‘å¬å™¨
        this.cleanupCheckboxes();
    }
    // å¡«å……ä¸»é¢˜ç¼–è¾‘å™¨ - ä½¿ç”¨jQueryé‡æ„
    fillThemeEditor(theme) {
        // ä½¿ç”¨jQueryé€‰æ‹©å™¨ï¼Œæ›´ç®€æ´
        const $nameInput = $('#theme-name-input');
        const $darkModeToggle = $('#dark-mode-toggle');
        const $singleColorIconsToggle = $('#single-color-icons-toggle');
        // å¡«å……ä¸»é¢˜åç§° - ä¿®å¤ï¼šä¿æŒç”¨æˆ·è‡ªå®šä¹‰çš„åç§°
        let themeName;
        if (theme.name === 'custom') {
            // å¦‚æœæ˜¯è‡ªå®šä¹‰ä¸»é¢˜ï¼Œä½¿ç”¨ç”¨æˆ·ä¿å­˜çš„displayName
            themeName = theme.displayName || 'æˆ‘çš„è‡ªå®šä¹‰ä¸»é¢˜';
        }
        else {
            // å¦‚æœæ˜¯åŸºäºå…¶ä»–ä¸»é¢˜çš„è‡ªå®šä¹‰ï¼Œä½¿ç”¨"è‡ªå®šä¹‰ + åŸä¸»é¢˜å"æ ¼å¼
            themeName = `è‡ªå®šä¹‰ ${theme.displayName}`;
        }
        $nameInput.val(themeName);
        // å®šä¹‰é¢œè‰²å­—æ®µæ˜ å°„ - ä½¿ç”¨lodashç®€åŒ–æ•°æ®å¤„ç†
        const colorMappings = {
            '#phone-frame-color': theme.colors.phoneFrame,
            '#primary-color': theme.colors.primary,
            '#light-color': theme.colors.light,
            '#ultra-light-color': theme.colors.ultraLight,
            '#deep-color': theme.colors.deep,
            '#text-primary-color': theme.colors.textPrimary,
            '#text-secondary-color': theme.colors.textSecondary,
            '#bubble-me-color': theme.colors.bubbleMeBg,
            '#bubble-me-text-color': theme.colors.bubbleMeText,
            '#bubble-them-color': theme.colors.bubbleThemBg,
            '#bubble-them-text-color': theme.colors.bubbleThemText,
            '#status-bar-color': theme.colors.statusBarColor,
            '#dynamic-island-color': theme.colors.dynamicIslandColor,
            '#border-color': theme.colors.borderColor,
            '#shadow-color': theme.colors.shadowColor,
        };
        // ä½¿ç”¨lodashçš„forEachæ‰¹é‡è®¾ç½®é¢œè‰²å€¼
        _.forEach(colorMappings, (colorValue, selector) => {
            $(selector).val(this.convertToHex(colorValue));
        });
        // è®¾ç½®checkboxçŠ¶æ€
        $darkModeToggle.prop('checked', theme.colors.isDarkMode);
        $singleColorIconsToggle.prop('checked', theme.colors.useSingleColorIcons || false);
        // æ³¨æ„ï¼šcheckboxçš„äº‹ä»¶ç›‘å¬å™¨å’Œåˆå§‹çŠ¶æ€åœ¨openThemeEditor()ä¸­çš„setupCheckboxes()é‡Œè®¾ç½®
    }
    // è®¾ç½®checkboxäº‹ä»¶ç›‘å¬å™¨ - ä½¿ç”¨jQueryé‡æ„
    setupCheckboxes() {
        // æ¸…ç†ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
        this.cleanupCheckboxes();
        // è®¾ç½®å¤œé—´æ¨¡å¼checkbox
        this.setupSingleCheckboxWithJQuery('dark-mode-toggle', 'dark-mode-checkbox-button');
        // è®¾ç½®å•ä¸€é¢œè‰²å›¾æ ‡checkbox
        this.setupSingleCheckboxWithJQuery('single-color-icons-toggle', 'single-color-icons-checkbox-button');
    }
    // æ¸…ç†checkboxäº‹ä»¶ç›‘å¬å™¨
    cleanupCheckboxes() {
        // ç§»é™¤æ‰€æœ‰å­˜å‚¨çš„äº‹ä»¶å¤„ç†å™¨
        this.checkboxHandlers.forEach((handler, id) => {
            $(`#${id}`).off('click', handler);
        });
        this.checkboxHandlers.clear();
    }
    // ä½¿ç”¨jQueryè®¾ç½®å•ä¸ªcheckbox
    setupSingleCheckboxWithJQuery(checkboxId, buttonId) {
        const $checkbox = $(`#${checkboxId}`);
        const $button = $(`#${buttonId}`);
        if (!$checkbox.length || !$button.length)
            return;
        // æ›´æ–°checkboxæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
        const updateCheckboxState = (checked) => {
            $button.toggleClass('checked', checked);
        };
        // ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
        const handleClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const checkbox = $checkbox[0];
            checkbox.checked = !checkbox.checked;
            updateCheckboxState(checkbox.checked);
        };
        // å­˜å‚¨äº‹ä»¶å¤„ç†å™¨ä»¥ä¾¿åç»­æ¸…ç†
        this.checkboxHandlers.set(buttonId, handleClick);
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        $button.on('click', handleClick);
        // è®¾ç½®åˆå§‹çŠ¶æ€
        const checkbox = $checkbox[0];
        updateCheckboxState(checkbox.checked);
    }
    // é‡ç½®ä¸»é¢˜ç¼–è¾‘å™¨
    resetThemeEditor() {
        // ä½¿ç”¨è“è‰²ä¸»é¢˜é‡ç½®ç¼–è¾‘å™¨
        const blueTheme = this.themeManager.getThemes().blue;
        this.fillThemeEditor(blueTheme);
        // é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿æŒ‰é’®èƒ½æ­£å¸¸å·¥ä½œ
        this.setupCheckboxes();
    }
    // å¯¼å‡ºä¸»é¢˜ä¸ºJSON - ä¿®å¤ï¼šåŒ…å«å®é™…å£çº¸è®¾ç½®å’Œæ­£ç¡®æ–‡ä»¶å
    exportThemeAsJSON() {
        try {
            const currentTheme = this.getCurrentThemeFromEditor();
            const wallpaperManager = this.themeManager.getWallpaperManager();
            // è·å–å½“å‰å®é™…ä½¿ç”¨çš„å£çº¸è®¾ç½®
            const currentWallpapers = {
                chat: wallpaperManager.getCurrentWallpaper('chat'),
                home: wallpaperManager.getCurrentWallpaper('home'),
                settings: wallpaperManager.getCurrentWallpaper('settings'),
            };
            // æ„å»ºå¯¼å‡ºæ•°æ®ï¼ŒåŒ…å«å£çº¸ä¿¡æ¯
            const themeData = {
                name: currentTheme.name,
                displayName: currentTheme.displayName,
                version: '1.0',
                exportDate: new Date().toISOString(),
                colors: currentTheme.colors,
                wallpapers: currentWallpapers, // åŒ…å«å®é™…ä½¿ç”¨çš„å£çº¸
            };
            const jsonString = JSON.stringify(themeData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            // ç”Ÿæˆæ–‡ä»¶åï¼šcustom-ä¸»é¢˜åå­—.json
            const themeName = currentTheme.displayName || 'è‡ªå®šä¹‰ä¸»é¢˜';
            const safeThemeName = themeName.replace(/[<>:"/\\|?*]/g, '_'); // æ›¿æ¢æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
            const fileName = `custom-${safeThemeName}.json`;
            // ä½¿ç”¨jQueryåˆ›å»ºä¸‹è½½é“¾æ¥
            const $a = $('<a>', {
                href: url,
                download: fileName,
                css: { display: 'none' },
            });
            $('body').append($a);
            $a[0].click();
            $a.remove();
            URL.revokeObjectURL(url);
            console.log(`[ThemeEditor] ä¸»é¢˜å·²å¯¼å‡ºä¸ºJSON: ${fileName}`);
        }
        catch (error) {
            console.error('[ThemeEditor] å¯¼å‡ºJSONå¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
    // å¯¼å…¥ä¸»é¢˜æ–‡ä»¶
    importTheme() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.style.display = 'none';
        input.addEventListener('change', event => {
            const file = event.target.files?.[0];
            if (!file)
                return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const content = e.target?.result;
                    let themeData;
                    if (file.name.endsWith('.json')) {
                        themeData = JSON.parse(content);
                    }
                    else {
                        throw new Error('åªæ”¯æŒJSONæ ¼å¼çš„ä¸»é¢˜æ–‡ä»¶');
                    }
                    // éªŒè¯ä¸»é¢˜æ•°æ®
                    if (!this.validateThemeData(themeData)) {
                        throw new Error('ä¸»é¢˜æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                    // åº”ç”¨å¯¼å…¥çš„ä¸»é¢˜
                    this.applyImportedTheme(themeData);
                    console.log('[ThemeEditor] ä¸»é¢˜å¯¼å…¥æˆåŠŸ');
                    alert('ä¸»é¢˜å¯¼å…¥æˆåŠŸï¼');
                }
                catch (error) {
                    console.error('[ThemeEditor] å¯¼å…¥å¤±è´¥:', error);
                    alert(`å¯¼å…¥å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);
                }
            };
            reader.readAsText(file);
        });
        // ä½¿ç”¨jQueryæ“ä½œDOM
        $('body').append(input);
        input.click();
        $(input).remove();
    }
    // ä»ç¼–è¾‘å™¨è·å–å½“å‰ä¸»é¢˜ - ä½¿ç”¨jQueryé‡æ„
    getCurrentThemeFromEditor() {
        // ä½¿ç”¨jQueryè·å–å€¼ï¼Œæ›´ç®€æ´
        const getValue = (selector, defaultValue = '') => $(selector).val() || defaultValue;
        const getChecked = (selector) => $(selector).prop('checked');
        return this.createCustomTheme({
            name: getValue('#theme-name-input', 'è‡ªå®šä¹‰ä¸»é¢˜'),
            phoneFrame: getValue('#phone-frame-color', '#b4d0fa'),
            primary: getValue('#primary-color', '#72adf3'),
            light: getValue('#light-color', '#a8cbeb'),
            ultraLight: getValue('#ultra-light-color', '#e8f4fd'),
            deep: getValue('#deep-color', '#2c5282'),
            textPrimary: getValue('#text-primary-color', 'rgb(139, 162, 186)'),
            textSecondary: getValue('#text-secondary-color', '#64748b'),
            bubbleMeBg: getValue('#bubble-me-color', '#a8cbeb'),
            bubbleMeText: getValue('#bubble-me-text-color', '#ffffff'),
            bubbleThemBg: getValue('#bubble-them-color', '#ffffff'),
            bubbleThemText: getValue('#bubble-them-text-color', '#72adf3'),
            appBgColor: '#ffffff',
            settingsBgColor: '#f2f2f7',
            settingsCardBgColor: '#ffffff',
            statusBar: getValue('#status-bar-color', '#428af2'),
            dynamicIsland: getValue('#dynamic-island-color', '#a0c4f4'),
            border: getValue('#border-color', '#E0E0E0'),
            shadow: getValue('#shadow-color', '#4a90e2'),
            isDarkMode: getChecked('#dark-mode-toggle'),
            useSingleColorIcons: getChecked('#single-color-icons-toggle'),
        });
    }
    // ä¿å­˜è‡ªå®šä¹‰ä¸»é¢˜ - ä½¿ç”¨jQueryé‡æ„
    saveCustomTheme() {
        // ç›´æ¥ä½¿ç”¨getCurrentThemeFromEditoræ–¹æ³•ï¼Œé¿å…é‡å¤ä»£ç 
        const customTheme = this.getCurrentThemeFromEditor();
        // ä¿å­˜å¹¶åº”ç”¨ä¸»é¢˜
        this.themeManager.saveCustomTheme(customTheme);
        this.themeManager.switchTheme('custom');
        // æ›´æ–°è‡ªå®šä¹‰ä¸»é¢˜æŒ‰é’®çš„æ˜¾ç¤º
        this.updateCustomThemeButton();
        // å…³é—­ç¼–è¾‘å™¨
        this.closeThemeEditor();
        // é€šçŸ¥ä¸»é¢˜å·²æ›´æ”¹
        if (this.onThemeChanged) {
            this.onThemeChanged();
        }
    }
    // åˆ›å»ºè‡ªå®šä¹‰ä¸»é¢˜
    createCustomTheme(params) {
        const { name, phoneFrame, primary, light, ultraLight, deep, textPrimary, textSecondary, bubbleMeBg, bubbleMeText, bubbleThemBg, bubbleThemText, appBgColor, settingsBgColor, settingsCardBgColor, statusBar, dynamicIsland, border, shadow, isDarkMode, useSingleColorIcons, } = params;
        // æå–é˜´å½±é¢œè‰²çš„RGBåˆ†é‡
        const r = parseInt(shadow.slice(1, 3), 16);
        const g = parseInt(shadow.slice(3, 5), 16);
        const b = parseInt(shadow.slice(5, 7), 16);
        const shadowColorRgba = isDarkMode ? 'rgba(0, 0, 0, 0.5)' : `rgba(${r}, ${g}, ${b}, 0.3)`;
        const bubbleShadow = `0 2px 8px rgba(${r}, ${g}, ${b}, 0.15)`;
        // æ¸å˜è‰²
        const gradientStart = this.lightenDarkenColor(primary, 20);
        const gradientEnd = this.lightenDarkenColor(primary, -10);
        // æ·»åŠ ç¼ºå°‘çš„å±æ€§
        const soft = this.lightenDarkenColor(light, -10);
        const textColor = '#ffffff';
        const headerBg = isDarkMode
            ? 'linear-gradient(315deg, #333333 0%, #444444 100%)'
            : `linear-gradient(315deg, ${this.lightenDarkenColor(ultraLight, -5)} 0%, ${ultraLight} 100%)`;
        // åˆ›å»ºè‡ªå®šä¹‰ä¸»é¢˜
        const customTheme = {
            name: 'custom',
            displayName: name,
            colors: {
                phoneFrame: phoneFrame,
                phoneFrameGradient: [
                    this.lightenDarkenColor(phoneFrame, -40),
                    phoneFrame,
                    this.lightenDarkenColor(phoneFrame, 20),
                    this.lightenDarkenColor(phoneFrame, -40),
                ],
                primary: primary,
                light: light,
                ultraLight: ultraLight,
                soft: soft,
                deep: deep,
                textPrimary: textPrimary,
                textSecondary: textSecondary,
                textColor: textColor,
                bubbleMeBg,
                bubbleMeText,
                bubbleThemBg,
                bubbleThemText,
                headerBg,
                appBgColor,
                settingsBgColor,
                settingsCardBgColor,
                gradientStart,
                gradientEnd,
                statusBarColor: statusBar,
                dynamicIslandColor: dynamicIsland,
                borderColor: border,
                shadowColor: shadow,
                shadowColorRgba,
                bubbleShadow,
                isDarkMode,
                defaultWallpapers: {
                    chat: isDarkMode
                        ? 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/æ·±è‰²æ˜Ÿæ˜Ÿ_1.jpg'
                        : 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_3.jpg',
                    home: isDarkMode
                        ? 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/æ·±è‰²æ˜Ÿæ˜Ÿ_1.jpg'
                        : 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_2.jpg',
                    settings: isDarkMode ? '#1a1a1a' : '#f2f7fd',
                },
                useSingleColorIcons,
            },
        };
        return customTheme;
    }
    // é¢œè‰²å¤„ç†å·¥å…·ï¼šè°ƒäº®æˆ–è°ƒæš—é¢œè‰²
    lightenDarkenColor(col, amt) {
        let usePound = false;
        if (col[0] === '#') {
            col = col.slice(1);
            usePound = true;
        }
        const num = parseInt(col, 16);
        let r = (num >> 16) + amt;
        if (r > 255)
            r = 255;
        else if (r < 0)
            r = 0;
        let b = ((num >> 8) & 0x00ff) + amt;
        if (b > 255)
            b = 255;
        else if (b < 0)
            b = 0;
        let g = (num & 0x0000ff) + amt;
        if (g > 255)
            g = 255;
        else if (g < 0)
            g = 0;
        return (usePound ? '#' : '') + (g | (b << 8) | (r << 16)).toString(16);
    }
    // å°†é¢œè‰²å€¼è½¬æ¢ä¸ºåå…­è¿›åˆ¶æ ¼å¼ï¼ˆç”¨äºé¢œè‰²è¾“å…¥æ¡†ï¼‰
    convertToHex(color) {
        // å¦‚æœå·²ç»æ˜¯åå…­è¿›åˆ¶æ ¼å¼ï¼Œç›´æ¥è¿”å›
        if (color.startsWith('#')) {
            return color;
        }
        // å¤„ç†rgb()æ ¼å¼
        const rgbMatch = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (rgbMatch) {
            const r = parseInt(rgbMatch[1]);
            const g = parseInt(rgbMatch[2]);
            const b = parseInt(rgbMatch[3]);
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        // å¤„ç†rgba()æ ¼å¼ï¼ˆå¿½ç•¥alphaé€šé“ï¼‰
        const rgbaMatch = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*[\d.]+\)/);
        if (rgbaMatch) {
            const r = parseInt(rgbaMatch[1]);
            const g = parseInt(rgbaMatch[2]);
            const b = parseInt(rgbaMatch[3]);
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        // å¦‚æœæ— æ³•è¯†åˆ«æ ¼å¼ï¼Œè¿”å›é»˜è®¤é¢œè‰²
        console.warn(`[ThemeEditor] æ— æ³•è½¬æ¢é¢œè‰²æ ¼å¼: ${color}`);
        return '#000000';
    }
    // éªŒè¯ä¸»é¢˜æ•°æ®æ ¼å¼
    validateThemeData(data) {
        if (!data || typeof data !== 'object')
            return false;
        // æ£€æŸ¥å¿…éœ€çš„å­—æ®µ
        const requiredFields = ['name', 'colors'];
        for (const field of requiredFields) {
            if (!(field in data))
                return false;
        }
        // æ£€æŸ¥colorså¯¹è±¡
        const colors = data.colors;
        if (!colors || typeof colors !== 'object')
            return false;
        // æ£€æŸ¥å¿…éœ€çš„é¢œè‰²å­—æ®µ
        const requiredColors = ['primary', 'phoneFrame', 'textPrimary', 'textSecondary'];
        for (const color of requiredColors) {
            if (!(color in colors))
                return false;
        }
        return true;
    }
    // åº”ç”¨å¯¼å…¥çš„ä¸»é¢˜ - ä½¿ç”¨jQueryé‡æ„
    applyImportedTheme(themeData) {
        // å¡«å……ä¸»é¢˜åç§°
        $('#theme-name-input').val(themeData.displayName || themeData.name || 'å¯¼å…¥çš„ä¸»é¢˜');
        // å¡«å……é¢œè‰²å­—æ®µ - ä½¿ç”¨lodashç®€åŒ–æ˜ å°„
        const colorMappings = {
            '#phone-frame-color': themeData.colors.phoneFrame,
            '#primary-color': themeData.colors.primary,
            '#light-color': themeData.colors.light,
            '#ultra-light-color': themeData.colors.ultraLight,
            '#deep-color': themeData.colors.deep,
            '#text-primary-color': themeData.colors.textPrimary,
            '#text-secondary-color': themeData.colors.textSecondary,
            '#bubble-me-color': themeData.colors.bubbleMeBg,
            '#bubble-me-text-color': themeData.colors.bubbleMeText,
            '#bubble-them-color': themeData.colors.bubbleThemBg,
            '#bubble-them-text-color': themeData.colors.bubbleThemText,
            '#status-bar-color': themeData.colors.statusBarColor,
            '#dynamic-island-color': themeData.colors.dynamicIslandColor,
            '#border-color': themeData.colors.borderColor,
            '#shadow-color': themeData.colors.shadowColor,
        };
        // ä½¿ç”¨lodashæ‰¹é‡è®¾ç½®é¢œè‰²å€¼ï¼Œå¹¶è½¬æ¢ä¸ºåå…­è¿›åˆ¶æ ¼å¼
        _.forEach(colorMappings, (colorValue, selector) => {
            if (colorValue) {
                $(selector).val(this.convertToHex(colorValue));
            }
        });
        // å¡«å……checkboxé€‰é¡¹
        if ('isDarkMode' in themeData.colors) {
            $('#dark-mode-toggle').prop('checked', themeData.colors.isDarkMode);
        }
        if ('useSingleColorIcons' in themeData.colors) {
            $('#single-color-icons-toggle').prop('checked', themeData.colors.useSingleColorIcons);
        }
        // å¤„ç†å£çº¸ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (themeData.wallpapers) {
            this.applyImportedWallpapers(themeData.wallpapers);
        }
        // é‡æ–°è®¾ç½®checkboxçŠ¶æ€
        this.setupCheckboxes();
    }
    // åº”ç”¨å¯¼å…¥çš„å£çº¸è®¾ç½®
    applyImportedWallpapers(wallpapers) {
        try {
            const wallpaperManager = this.themeManager.getWallpaperManager();
            // åº”ç”¨å„ä¸ªè§†å›¾çš„å£çº¸
            const viewTypes = ['chat', 'home', 'settings'];
            viewTypes.forEach(viewType => {
                const wallpaper = wallpapers[viewType];
                if (wallpaper) {
                    // è®¾ç½®å£çº¸åˆ°å½“å‰ä¸»é¢˜
                    wallpaperManager.setWallpaper(viewType, wallpaper);
                }
            });
            console.log('[ThemeEditor] å£çº¸è®¾ç½®å·²å¯¼å…¥');
        }
        catch (error) {
            console.warn('[ThemeEditor] å¯¼å…¥å£çº¸è®¾ç½®å¤±è´¥:', error);
        }
    }
}

;// ./src/åŒå±‚æ‰‹æœº/theme-manager.ts
// å½“å‰åº”ç”¨ç‰ˆæœ¬
const APP_VERSION = '1.1.0';
// é»˜è®¤ä¸»é¢˜é…ç½®
const THEMES = {
    blue: {
        name: 'blue',
        displayName: 'è“è‰²ä¸»é¢˜',
        colors: {
            // æ‰‹æœºè¾¹æ¡†
            phoneFrame: '#b4d0fa',
            phoneFrameGradient: ['#4a95ed', '#98c2f5', '#accef2', '#4a95ed'],
            // ä¸»è¦é¢œè‰²
            primary: '#72adf3',
            light: '#a8cbeb',
            ultraLight: '#e8f4fd',
            soft: '#b8d4f0',
            deep: '#2c5282',
            // æ¸å˜è‰²
            gradientStart: '#98c2f5',
            gradientEnd: '#accef2',
            // æ–‡å­—é¢œè‰²
            textColor: '#ffffff',
            textPrimary: 'rgb(139, 162, 186)',
            textSecondary: '#64748b',
            // è¾¹æ¡†å’Œé˜´å½±
            borderColor: '#cbd5e1',
            bubbleShadow: '0 2px 8px rgba(74, 144, 226, 0.15)',
            // æ°”æ³¡èƒŒæ™¯
            bubbleThemBg: '#ffffff',
            bubbleMeBg: '#a8cbeb',
            // æ°”æ³¡æ–‡å­—é¢œè‰²
            bubbleThemText: '#72adf3',
            bubbleMeText: '#ffffff',
            // å¤´éƒ¨èƒŒæ™¯
            headerBg: 'linear-gradient(315deg, #eef4ff 0%, #f8faff 100%)',
            // æ–°å¢ï¼šçŠ¶æ€æ é¢œè‰²
            statusBarColor: '#428af2',
            // æ–°å¢ï¼šçµåŠ¨å²›é¢œè‰²
            dynamicIslandColor: '#a0c4f4',
            // æ–°å¢ï¼šåº”ç”¨èƒŒæ™¯è‰²
            appBgColor: '#ffffff',
            // æ–°å¢ï¼šè®¾ç½®é¡µé¢èƒŒæ™¯è‰²
            settingsBgColor: '#f2f2f7',
            // æ–°å¢ï¼šè®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
            settingsCardBgColor: '#ffffff',
            // æ–°å¢ï¼šé˜´å½±é¢œè‰²
            shadowColor: '#4a90e2',
            shadowColorRgba: 'rgba(74, 144, 226, 0.3)',
            // æ–°å¢ï¼šæ˜¯å¦æ˜¯æš—è‰²ä¸»é¢˜
            isDarkMode: false,
            // æ–°å¢ï¼šé»˜è®¤å£çº¸
            defaultWallpapers: {
                chat: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_3.jpg', // æ›´æ–°ä¸ºæŒ‡å®šçš„è“è‰²ä¸»é¢˜å£çº¸
                home: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_2.jpg', // æ›´æ–°ä¸ºæŒ‡å®šçš„è“è‰²ä¸»é¢˜å£çº¸
                settings: '#f2f7fd',
            },
            // æ–°å¢ï¼šæ˜¯å¦ä½¿ç”¨å•ä¸€é¢œè‰²å›¾æ ‡
            useSingleColorIcons: true,
        },
    },
    pink: {
        name: 'pink',
        displayName: 'ç²‰è‰²ä¸»é¢˜',
        colors: {
            // æ‰‹æœºè¾¹æ¡†
            phoneFrame: '#fad0e8',
            phoneFrameGradient: ['#ed4a9e', '#f598c8', '#f2acce', '#ed4a9e'],
            // ä¸»è¦é¢œè‰²
            primary: '#f372ad',
            light: '#eba8cb',
            ultraLight: '#fde8f4',
            soft: '#f0b8d4',
            deep: '#822c5c',
            // æ¸å˜è‰²
            gradientStart: '#f598c8',
            gradientEnd: '#f2acce',
            // æ–‡å­—é¢œè‰²
            textColor: '#ffffff',
            textPrimary: 'rgb(186, 139, 162)',
            textSecondary: '#8b647a',
            // è¾¹æ¡†å’Œé˜´å½±
            borderColor: '#e1cbd5',
            bubbleShadow: '0 2px 8px rgba(226, 74, 144, 0.15)',
            // æ°”æ³¡èƒŒæ™¯
            bubbleThemBg: '#ffffff',
            bubbleMeBg: '#eba8cb',
            // æ°”æ³¡æ–‡å­—é¢œè‰²
            bubbleThemText: '#f372ad',
            bubbleMeText: '#ffffff',
            // å¤´éƒ¨èƒŒæ™¯
            headerBg: 'linear-gradient(315deg, #ffeeef 0%, #fff8fa 100%)',
            // æ–°å¢ï¼šçŠ¶æ€æ é¢œè‰²
            statusBarColor: '#ed72ad',
            // æ–°å¢ï¼šçµåŠ¨å²›é¢œè‰²
            dynamicIslandColor: '#f4a0c4',
            // æ–°å¢ï¼šåº”ç”¨èƒŒæ™¯è‰²
            appBgColor: '#ffffff',
            // æ–°å¢ï¼šè®¾ç½®é¡µé¢èƒŒæ™¯è‰²
            settingsBgColor: '#fff2f7',
            // æ–°å¢ï¼šè®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
            settingsCardBgColor: '#ffffff',
            // æ–°å¢ï¼šé˜´å½±é¢œè‰²
            shadowColor: '#e24a90',
            shadowColorRgba: 'rgba(226, 74, 144, 0.3)',
            // æ–°å¢ï¼šæ˜¯å¦æ˜¯æš—è‰²ä¸»é¢˜
            isDarkMode: false,
            // æ–°å¢ï¼šé»˜è®¤å£çº¸
            defaultWallpapers: {
                chat: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ˜Ÿæ˜Ÿ_1.jpg', // æ›´æ–°ä¸ºæŒ‡å®šçš„ç²‰è‰²ä¸»é¢˜å£çº¸
                home: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ ¼å­_3.jpg', // æ›´æ–°ä¸ºæŒ‡å®šçš„ç²‰è‰²ä¸»é¢˜å£çº¸
                settings: '#fdf2f7',
            },
            // æ–°å¢ï¼šæ˜¯å¦ä½¿ç”¨å•ä¸€é¢œè‰²å›¾æ ‡
            useSingleColorIcons: true,
        },
    },
    white: {
        name: 'white',
        displayName: 'å¾®ä¿¡ä¸»é¢˜',
        colors: {
            // æ‰‹æœºè¾¹æ¡†
            phoneFrame: '#000000',
            phoneFrameGradient: ['#000000', '#222222', '#333333', '#000000'],
            // ä¸»è¦é¢œè‰² - å¾®ä¿¡ç»¿åªç”¨äºç‰¹å®šå…ƒç´ 
            primary: '#999999', // å¤§å¤šæ•°æŒ‰é’®å’Œå›¾æ ‡ç”¨ç°è‰²
            light: '#cccccc',
            ultraLight: '#f8f8f8',
            soft: '#e0e0e0',
            deep: '#666666',
            // æ¸å˜è‰²
            gradientStart: '#cccccc',
            gradientEnd: '#dddddd',
            // æ–‡å­—é¢œè‰²
            textColor: '#ffffff',
            textPrimary: '#333333',
            textSecondary: '#909090',
            // è¾¹æ¡†å’Œé˜´å½±
            borderColor: '#e0e0e0',
            bubbleShadow: '0 2px 8px rgba(0, 0, 0, 0.08)',
            // æ°”æ³¡èƒŒæ™¯
            bubbleThemBg: '#ffffff',
            bubbleMeBg: '#A0E75A', // æ›´æµ…çš„å¾®ä¿¡æ°”æ³¡ç»¿è‰²
            // æ°”æ³¡æ–‡å­—é¢œè‰²
            bubbleThemText: '#333333',
            bubbleMeText: '#333333',
            // å¤´éƒ¨èƒŒæ™¯
            headerBg: 'linear-gradient(315deg, #f5f5f5 0%, #ffffff 100%)',
            // æ–°å¢ï¼šçŠ¶æ€æ é¢œè‰²
            statusBarColor: '#000000',
            // æ–°å¢ï¼šçµåŠ¨å²›é¢œè‰²
            dynamicIslandColor: '#000000',
            // æ–°å¢ï¼šåº”ç”¨èƒŒæ™¯è‰²
            appBgColor: '#ffffff',
            // æ–°å¢ï¼šè®¾ç½®é¡µé¢èƒŒæ™¯è‰²
            settingsBgColor: '#f5f5f5',
            // æ–°å¢ï¼šè®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
            settingsCardBgColor: '#ffffff',
            // æ–°å¢ï¼šé˜´å½±é¢œè‰²
            shadowColor: '#999999',
            shadowColorRgba: 'rgba(0, 0, 0, 0.1)',
            // æ–°å¢ï¼šæ˜¯å¦æ˜¯æš—è‰²ä¸»é¢˜
            isDarkMode: false,
            // æ–°å¢ï¼šé»˜è®¤å£çº¸
            defaultWallpapers: {
                chat: '#EDEDED', // å¾®ä¿¡èŠå¤©èƒŒæ™¯ç°è‰²
                home: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç™½è‰²_1.jpg', // é»˜è®¤å›¾ç‰‡å£çº¸
                settings: '#f5f5f5',
            },
            // æ–°å¢ï¼šæ˜¯å¦ä½¿ç”¨å•ä¸€é¢œè‰²å›¾æ ‡
            useSingleColorIcons: false,
        },
    },
    dark: {
        name: 'dark',
        displayName: 'å¤œé—´æ¨¡å¼',
        colors: {
            // æ‰‹æœºè¾¹æ¡†
            phoneFrame: '#2c2c2c',
            phoneFrameGradient: ['#1a1a1a', '#2c2c2c', '#3c3c3c', '#1a1a1a'],
            // ä¸»è¦é¢œè‰²
            primary: '#505050',
            light: '#3c3c3c',
            ultraLight: '#1a1a1a',
            soft: '#2c2c2c',
            deep: '#c0c0c0',
            // æ¸å˜è‰²
            gradientStart: '#3c3c3c',
            gradientEnd: '#2c2c2c',
            // æ–‡å­—é¢œè‰²
            textColor: '#e0e0e0',
            textPrimary: '#c0c0c0',
            textSecondary: '#a0a0a0',
            // è¾¹æ¡†å’Œé˜´å½±
            borderColor: '#3c3c3c',
            bubbleShadow: '0 2px 8px rgba(0, 0, 0, 0.3)',
            // æ°”æ³¡èƒŒæ™¯
            bubbleThemBg: '#2a2a2a',
            bubbleMeBg: '#505050',
            // æ°”æ³¡æ–‡å­—é¢œè‰²
            bubbleThemText: '#e0e0e0',
            bubbleMeText: '#c0c0c0',
            // å¤´éƒ¨èƒŒæ™¯
            headerBg: 'linear-gradient(315deg, #2c2c2c 0%, #1a1a1a 100%)',
            // æ–°å¢ï¼šçŠ¶æ€æ é¢œè‰²
            statusBarColor: '#888888',
            // æ–°å¢ï¼šçµåŠ¨å²›é¢œè‰²
            dynamicIslandColor: '#3c3c3c',
            // æ–°å¢ï¼šåº”ç”¨èƒŒæ™¯è‰²
            appBgColor: '#1a1a1a',
            // æ–°å¢ï¼šè®¾ç½®é¡µé¢èƒŒæ™¯è‰²
            settingsBgColor: '#1a1a1a',
            // æ–°å¢ï¼šè®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
            settingsCardBgColor: '#2c2c2c',
            // æ–°å¢ï¼šé˜´å½±é¢œè‰²
            shadowColor: '#000000',
            shadowColorRgba: 'rgba(0, 0, 0, 0.5)',
            // æ–°å¢ï¼šæ˜¯å¦æ˜¯æš—è‰²ä¸»é¢˜
            isDarkMode: true,
            // æ–°å¢ï¼šé»˜è®¤å£çº¸
            defaultWallpapers: {
                chat: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/æ·±è‰²æ˜Ÿæ˜Ÿ_1.jpg', // å¤œé—´æ¨¡å¼å£çº¸
                home: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/æ·±è‰²æ˜Ÿæ˜Ÿ_1.jpg', // å¤œé—´æ¨¡å¼å£çº¸
                settings: '#1a1a1a',
            },
            // æ–°å¢ï¼šæ˜¯å¦ä½¿ç”¨å•ä¸€é¢œè‰²å›¾æ ‡
            useSingleColorIcons: false,
        },
    },
};
// ä¸»é¢˜ç®¡ç†å™¨ç±»
class ThemeManager {
    static THEME_STORAGE_KEY = 'blmx_theme';
    static CUSTOM_THEME_STORAGE_KEY = 'blmx_custom_theme';
    static VERSION_STORAGE_KEY = 'blmx_app_version';
    currentTheme;
    wallpaperManager;
    constructor() {
        // æ£€æŸ¥ç‰ˆæœ¬å¹¶åœ¨éœ€è¦æ—¶æ¸…ç†ç¼“å­˜
        this.checkVersion();
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸»é¢˜æˆ–ä½¿ç”¨é»˜è®¤å¾®ä¿¡ä¸»é¢˜
        const savedThemeName = localStorage.getItem(ThemeManager.THEME_STORAGE_KEY) || 'white';
        if (savedThemeName === 'custom') {
            try {
                const customThemeJson = localStorage.getItem(ThemeManager.CUSTOM_THEME_STORAGE_KEY);
                if (customThemeJson) {
                    this.currentTheme = JSON.parse(customThemeJson);
                }
                else {
                    this.currentTheme = THEMES.white;
                }
            }
            catch (e) {
                console.error('Failed to load custom theme:', e);
                this.currentTheme = THEMES.white;
            }
        }
        else {
            this.currentTheme = THEMES[savedThemeName] || THEMES.white;
        }
        // åˆå§‹åŒ–å£çº¸ç®¡ç†å™¨
        this.wallpaperManager = new WallpaperManager();
        // åº”ç”¨å½“å‰ä¸»é¢˜
        this.applyTheme(this.currentTheme);
    }
    // æ£€æŸ¥ç‰ˆæœ¬å¹¶æ¸…ç†è¿‡æ—¶æ•°æ®
    checkVersion() {
        const savedVersion = localStorage.getItem(ThemeManager.VERSION_STORAGE_KEY);
        // å¦‚æœæ²¡æœ‰ç‰ˆæœ¬è®°å½•æˆ–ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ‰§è¡Œæ¸…ç†
        if (!savedVersion || savedVersion !== APP_VERSION) {
            console.log(`ç‰ˆæœ¬æ›´æ–°: ${savedVersion || 'åˆæ¬¡å®‰è£…'} -> ${APP_VERSION}, æ¸…ç†è¿‡æ—¶æ•°æ®...`);
            this.cleanOutdatedData();
            // ä¿å­˜æ–°ç‰ˆæœ¬å·
            localStorage.setItem(ThemeManager.VERSION_STORAGE_KEY, APP_VERSION);
        }
    }
    // æ¸…ç†è¿‡æ—¶æ•°æ®
    cleanOutdatedData() {
        // ä¿ç•™ç”¨æˆ·çš„ä¸ªäººè®¾ç½®æ•°æ®ï¼Œä½†æ¸…ç†å¯èƒ½å¯¼è‡´é—®é¢˜çš„ä¸»é¢˜å’Œå£çº¸æ•°æ®
        const keysToPreserve = [];
        // æŸ¥æ‰¾æ‰€æœ‰éœ€è¦ä¿ç•™çš„ä¸ªäººè®¾ç½®é”®
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key &&
                (key.startsWith('blmx_user_name_') ||
                    key.startsWith('blmx_user_avatar_') ||
                    key.startsWith('blmx_char_avatar_') ||
                    key.startsWith('blmx_remark_') ||
                    key.startsWith('blmx_signature_') ||
                    key.startsWith('blmx_cover_photo_') ||
                    key.startsWith('blmx_input_placeholder_'))) {
                keysToPreserve.push(key);
            }
        }
        // ä¸´æ—¶ä¿å­˜éœ€è¦ä¿ç•™çš„æ•°æ®
        const preservedData = {};
        keysToPreserve.forEach(key => {
            const value = localStorage.getItem(key);
            if (value)
                preservedData[key] = value;
        });
        // æ¸…é™¤æ‰€æœ‰ blmx_ å¼€å¤´çš„æ•°æ®
        for (let i = localStorage.length - 1; i >= 0; i--) {
            const key = localStorage.key(i);
            if (key && key.startsWith('blmx_')) {
                localStorage.removeItem(key);
            }
        }
        // æ¢å¤éœ€è¦ä¿ç•™çš„æ•°æ®
        Object.entries(preservedData).forEach(([key, value]) => {
            localStorage.setItem(key, value);
        });
    }
    // è·å–å½“å‰ä¸»é¢˜
    getCurrentTheme() {
        return this.currentTheme;
    }
    // è·å–å½“å‰ä¸»é¢˜çš„å®é™…åº”ç”¨æ•°æ®ï¼ˆä»DOMçš„CSSå˜é‡ä¸­è¯»å–ï¼‰
    getCurrentThemeWithAppliedValues() {
        const theme = { ...this.currentTheme };
        const colors = { ...theme.colors };
        // ä»DOMä¸­è¯»å–å®é™…åº”ç”¨çš„CSSå˜é‡å€¼
        const root = document.documentElement;
        const computedStyle = getComputedStyle(root);
        // è¯»å–å®é™…åº”ç”¨çš„é¢œè‰²å€¼
        const actualValues = {
            phoneFrame: computedStyle.getPropertyValue('--phoneFrame').trim(),
            primary: computedStyle.getPropertyValue('--primary-blue').trim(),
            light: computedStyle.getPropertyValue('--light-blue').trim(),
            ultraLight: computedStyle.getPropertyValue('--ultra-light-blue').trim(),
            soft: computedStyle.getPropertyValue('--soft-blue').trim(),
            deep: computedStyle.getPropertyValue('--deep-blue').trim(),
            textColor: computedStyle.getPropertyValue('--text-color').trim(),
            textPrimary: computedStyle.getPropertyValue('--text-primary').trim(),
            textSecondary: computedStyle.getPropertyValue('--text-secondary').trim(),
            borderColor: computedStyle.getPropertyValue('--border-color').trim(),
            bubbleShadow: computedStyle.getPropertyValue('--bubble-shadow').trim(),
            bubbleThemBg: computedStyle.getPropertyValue('--wechat-bubble-them-bg').trim(),
            bubbleMeBg: computedStyle.getPropertyValue('--wechat-bubble-me-bg').trim(),
            bubbleThemText: computedStyle.getPropertyValue('--wechat-bubble-them-text').trim(),
            bubbleMeText: computedStyle.getPropertyValue('--wechat-bubble-me-text').trim(),
            headerBg: computedStyle.getPropertyValue('--header-bg').trim(),
            statusBarColor: computedStyle.getPropertyValue('--status-bar-color').trim(),
            dynamicIslandColor: computedStyle.getPropertyValue('--dynamic-island-color').trim(),
            appBgColor: computedStyle.getPropertyValue('--app-bg-color').trim(),
            settingsBgColor: computedStyle.getPropertyValue('--settings-bg-color').trim(),
            settingsCardBgColor: computedStyle.getPropertyValue('--settings-card-bg-color').trim(),
            shadowColor: computedStyle.getPropertyValue('--shadow-color').trim(),
            shadowColorRgba: computedStyle.getPropertyValue('--shadow-color-rgba').trim(),
            gradientStart: computedStyle.getPropertyValue('--blue-gradient-start').trim() ||
                computedStyle.getPropertyValue('--primary-gradient-light').trim(),
            gradientEnd: computedStyle.getPropertyValue('--blue-gradient-end').trim() ||
                computedStyle.getPropertyValue('--primary-gradient-dark').trim(),
        };
        // ä½¿ç”¨å®é™…åº”ç”¨çš„å€¼ï¼Œå¦‚æœCSSå˜é‡å­˜åœ¨çš„è¯
        Object.keys(actualValues).forEach(key => {
            const value = actualValues[key];
            if (value && value !== '') {
                colors[key] = value;
            }
        });
        // ä¿æŒåŸæœ‰çš„å¸ƒå°”å€¼å’Œå…¶ä»–éé¢œè‰²å±æ€§
        colors.isDarkMode = theme.colors.isDarkMode;
        colors.useSingleColorIcons = theme.colors.useSingleColorIcons;
        colors.phoneFrameGradient = theme.colors.phoneFrameGradient;
        colors.defaultWallpapers = theme.colors.defaultWallpapers;
        return {
            ...theme,
            colors,
        };
    }
    // è·å–æ‰€æœ‰é»˜è®¤ä¸»é¢˜
    getThemes() {
        return THEMES;
    }
    // è·å–å£çº¸ç®¡ç†å™¨
    getWallpaperManager() {
        return this.wallpaperManager;
    }
    // åˆ‡æ¢åˆ°æŒ‡å®šä¸»é¢˜
    switchTheme(themeName) {
        if (themeName === 'custom') {
            try {
                const customThemeJson = localStorage.getItem(ThemeManager.CUSTOM_THEME_STORAGE_KEY);
                if (customThemeJson) {
                    this.currentTheme = JSON.parse(customThemeJson);
                    localStorage.setItem(ThemeManager.THEME_STORAGE_KEY, 'custom');
                    // æ›´æ–°å£çº¸ç®¡ç†å™¨ä¸­çš„å½“å‰ä¸»é¢˜åç§°
                    this.wallpaperManager.setCurrentThemeName('custom');
                    this.applyTheme(this.currentTheme);
                    // åº”ç”¨ä¸»é¢˜é»˜è®¤å£çº¸
                    this.wallpaperManager.applyThemeDefaultWallpapers(this.currentTheme);
                }
            }
            catch (e) {
                console.error('Failed to load custom theme:', e);
            }
        }
        else if (THEMES[themeName]) {
            this.currentTheme = THEMES[themeName];
            localStorage.setItem(ThemeManager.THEME_STORAGE_KEY, themeName);
            // æ›´æ–°å£çº¸ç®¡ç†å™¨ä¸­çš„å½“å‰ä¸»é¢˜åç§°
            this.wallpaperManager.setCurrentThemeName(themeName);
            this.applyTheme(this.currentTheme);
            // åº”ç”¨ä¸»é¢˜é»˜è®¤å£çº¸
            this.wallpaperManager.applyThemeDefaultWallpapers(this.currentTheme);
        }
    }
    // ä¿å­˜è‡ªå®šä¹‰ä¸»é¢˜
    saveCustomTheme(theme) {
        this.currentTheme = theme;
        localStorage.setItem(ThemeManager.CUSTOM_THEME_STORAGE_KEY, JSON.stringify(theme));
        localStorage.setItem(ThemeManager.THEME_STORAGE_KEY, 'custom');
        // æ›´æ–°å£çº¸ç®¡ç†å™¨ä¸­çš„å½“å‰ä¸»é¢˜åç§°
        this.wallpaperManager.setCurrentThemeName('custom');
        this.applyTheme(theme);
        // åº”ç”¨ä¸»é¢˜é»˜è®¤å£çº¸
        this.wallpaperManager.applyThemeDefaultWallpapers(theme);
    }
    // åº”ç”¨ä¸»é¢˜åˆ°DOM
    applyTheme(theme) {
        const colors = theme.colors;
        const root = document.documentElement;
        // è®¾ç½®CSSå˜é‡
        root.style.setProperty('--phoneFrame', colors.phoneFrame);
        root.style.setProperty('--primary-blue', colors.primary);
        root.style.setProperty('--light-blue', colors.light);
        root.style.setProperty('--ultra-light-blue', colors.ultraLight);
        root.style.setProperty('--blue-gradient-start', colors.gradientStart);
        root.style.setProperty('--blue-gradient-end', colors.gradientEnd);
        root.style.setProperty('--soft-blue', colors.soft);
        root.style.setProperty('--deep-blue', colors.deep);
        // è®¾ç½®æ–‡å­—é¢œè‰²å˜é‡ - è¿™æ˜¯å…³é”®çš„ä¿®å¤ï¼
        root.style.setProperty('--text-color', colors.textColor);
        root.style.setProperty('--text-primary', colors.textPrimary);
        root.style.setProperty('--text-secondary', colors.textSecondary);
        // è®¾ç½®è¾¹æ¡†é¢œè‰²
        root.style.setProperty('--border-color', colors.borderColor);
        // æ ¹æ®useSingleColorIconså±æ€§è®¾ç½®å›¾æ ‡é¢œè‰²
        if (colors.useSingleColorIcons) {
            // ä½¿ç”¨ä¸»é¢˜è‰²ä½œä¸ºå›¾æ ‡é¢œè‰²
            document.body.classList.add('single-color-icon');
            // è®¡ç®—æ¸å˜è‰²ï¼šæ¯”ä¸»è‰²æ›´äº®å’Œæ›´æš—çš„å˜ä½“
            const lighterColor = this.lightenDarkenColor(colors.primary, 20);
            const darkerColor = this.lightenDarkenColor(colors.primary, -20);
            // è®¾ç½®æ¸å˜è‰²å˜é‡
            root.style.setProperty('--primary-gradient-light', lighterColor);
            root.style.setProperty('--primary-gradient-dark', darkerColor);
        }
        else {
            // ä½¿ç”¨é»˜è®¤çš„ç»¿è‰²å’Œç°è‰²å›¾æ ‡
            document.body.classList.remove('single-color-icon');
            root.style.setProperty('--wechat-green-icon', theme.name === 'white' ? '#07C160' : '#07C160');
            root.style.setProperty('--settings-icon-color', theme.name === 'white' ? '#8a8a8a' : '#8a8a8a');
        }
        root.style.setProperty('--wechat-green-bubble', colors.light);
        root.style.setProperty('--wechat-bg', colors.ultraLight);
        root.style.setProperty('--link-color', colors.primary);
        root.style.setProperty('--text-color', colors.textColor);
        root.style.setProperty('--text-primary', colors.textPrimary);
        root.style.setProperty('--text-secondary', colors.textSecondary);
        root.style.setProperty('--border-color', colors.borderColor);
        root.style.setProperty('--header-bg', colors.headerBg);
        root.style.setProperty('--bubble-shadow', colors.bubbleShadow);
        root.style.setProperty('--wechat-bubble-them-bg', colors.bubbleThemBg);
        root.style.setProperty('--wechat-bubble-me-bg', colors.bubbleMeBg);
        // è®¾ç½®æ°”æ³¡æ–‡å­—é¢œè‰²
        root.style.setProperty('--wechat-bubble-them-text', colors.bubbleThemText || colors.primary);
        root.style.setProperty('--wechat-bubble-me-text', colors.bubbleMeText || '#ffffff');
        // è®¾ç½®çŠ¶æ€æ é¢œè‰²
        root.style.setProperty('--status-bar-color', colors.statusBarColor);
        // è®¾ç½®çµåŠ¨å²›é¢œè‰²
        root.style.setProperty('--dynamic-island-color', colors.dynamicIslandColor);
        // è®¾ç½®åº”ç”¨èƒŒæ™¯è‰²
        root.style.setProperty('--app-bg-color', colors.appBgColor);
        // è®¾ç½®è®¾ç½®é¡µé¢èƒŒæ™¯è‰²
        root.style.setProperty('--settings-bg-color', colors.settingsBgColor);
        // è®¾ç½®è®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
        root.style.setProperty('--settings-card-bg-color', colors.settingsCardBgColor);
        // è®¾ç½®è¾“å…¥æ¡†èƒŒæ™¯è‰²ï¼ˆéå¤œé—´æ¨¡å¼ç»Ÿä¸€ä¸ºç™½è‰²ï¼‰
        root.style.setProperty('--input-bg', colors.isDarkMode ? '#2a2a2a' : '#ffffff');
        // è®¾ç½®é˜´å½±é¢œè‰²
        root.style.setProperty('--shadow-color', colors.shadowColor);
        root.style.setProperty('--shadow-color-rgba', colors.shadowColorRgba);
        // æå–é˜´å½±é¢œè‰²çš„RGBåˆ†é‡ï¼Œç”¨äºå…¶ä»–è®¡ç®—
        const shadowRGB = this.extractRgbComponents(colors.shadowColor);
        root.style.setProperty('--shadow-r', shadowRGB.r.toString());
        root.style.setProperty('--shadow-g', shadowRGB.g.toString());
        root.style.setProperty('--shadow-b', shadowRGB.b.toString());
        // è®¾ç½®æš—è‰²æ¨¡å¼ç±»
        if (colors.isDarkMode) {
            document.body.classList.add('dark-mode');
        }
        else {
            document.body.classList.remove('dark-mode');
        }
        // æ‰‹æœºè¾¹æ¡†æ ·å¼
        const phoneFrame = document.querySelector('.phone-frame');
        if (phoneFrame) {
            phoneFrame.style.background = colors.phoneFrame;
            // æ›´æ–°æ‰‹æœºè¾¹æ¡†æ¸å˜ - åŸå­æ€§æ›´æ–°é¿å…é—ªçƒ
            const gradientColors = colors.phoneFrameGradient.join(', ');
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ ·å¼å…ƒç´ 
            let phoneFrameStyle = document.getElementById('phone-frame-style');
            if (!phoneFrameStyle) {
                phoneFrameStyle = document.createElement('style');
                phoneFrameStyle.id = 'phone-frame-style';
                document.head.appendChild(phoneFrameStyle);
            }
            // ç›´æ¥æ›´æ–°æ ·å¼å†…å®¹ï¼Œé¿å…ç§»é™¤å’Œé‡æ–°æ·»åŠ é€ æˆçš„é—ªçƒ
            phoneFrameStyle.textContent = `
        .phone-frame::before {
          background: linear-gradient(45deg, ${gradientColors});
          background-size: 400% 400%;
        }
      `;
        }
        // æ›´æ–°åŠ¨æ€å²›é¢œè‰²
        const dynamicIsland = document.querySelector('.dynamic-island');
        if (dynamicIsland) {
            dynamicIsland.style.background = colors.dynamicIslandColor;
        }
        // æ›´æ–°çŠ¶æ€æ é¢œè‰²
        const statusLeft = document.querySelector('.status-left');
        const statusRight = document.querySelector('.status-right');
        if (statusLeft && statusRight) {
            statusLeft.style.color = colors.statusBarColor;
            statusRight.style.color = colors.statusBarColor;
        }
        // æ›´æ–°è®¾ç½®é¡µé¢èƒŒæ™¯è‰²
        const settingsView = document.getElementById('settings-view');
        if (settingsView) {
            settingsView.style.backgroundColor = colors.settingsBgColor;
        }
        // æ›´æ–°è®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
        const settingsCards = document.querySelectorAll('.settings-card');
        settingsCards.forEach((card) => {
            card.style.backgroundColor = colors.settingsCardBgColor;
        });
        // æ›´æ–°æ‰‹æœºé˜´å½±
        if (phoneFrame) {
            phoneFrame.style.boxShadow = `
        0 15px 20px ${this.hexToRgba(colors.shadowColor, 0.25)},
        0 8px 20px ${this.hexToRgba(colors.shadowColor, 0.15)},
        0 3px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.5),
        inset 0 -1px 0 rgba(255, 255, 255, 0.2),
        0 5px ${this.hexToRgba(colors.shadowColor, 0.08)}
      `;
        }
        // æ›´æ–°æ°”æ³¡é˜´å½±å’Œé¢œè‰²
        const style = document.createElement('style');
        style.id = 'theme-dynamic-styles';
        // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰ä¸»é¢˜ï¼ˆä½¿ç”¨çº¯è‰²èƒŒæ™¯ï¼‰è¿˜æ˜¯é»˜è®¤ä¸»é¢˜ï¼ˆä¿ç•™æ¸å˜ï¼‰
        // æ³¨é‡Šæ‰æœªä½¿ç”¨çš„å˜é‡
        // const isCustomBubbleColors = theme.name === 'custom';
        style.textContent = `
      /* å¾®ä¿¡ä¸»é¢˜ä¸‹çš„æ°”æ³¡æ ·å¼ - ç›´æ¥åº”ç”¨ç»¿è‰² */
      .message-row.me .message-bubble {
        background-color: ${colors.bubbleMeBg} !important;
        background: ${colors.bubbleMeBg} !important;
        color: ${colors.bubbleMeText || '#ffffff'} !important;
        box-shadow: 0 4px 12px ${this.hexToRgba(colors.shadowColor, 0.3)};
      }
      
      /* å¯¹æ–¹æ°”æ³¡æ ·å¼ */
      .message-row.them .message-bubble {
        background-color: ${colors.bubbleThemBg} !important;
        background: ${colors.bubbleThemBg} !important;
        color: ${colors.bubbleThemText || colors.primary} !important;
      }
      
      /* ç¡®ä¿è¯­éŸ³æ°”æ³¡ä¹Ÿä½¿ç”¨æ­£ç¡®çš„é¢œè‰² */
      .message-row.me .message-bubble.voice-bubble {
        background: ${colors.bubbleMeBg} !important;
        background-color: ${colors.bubbleMeBg} !important;
        background-image: none !important;
        color: ${colors.bubbleMeText || '#ffffff'} !important;
      }
      
      .message-row.them .message-bubble.voice-bubble {
        background: ${colors.bubbleThemBg} !important;
        color: ${colors.bubbleThemText || colors.primary} !important;
      }
      
      /* æœ‹å‹åœˆæ–‡å­—æè¿°å›¾ç‰‡æ ·å¼ */
      .post-media .image-desc-content {
        background-color: ${this.hexToRgba(colors.primary, 0.1)} !important;
        border: 1px solid ${this.hexToRgba(colors.primary, 0.1)} !important;
      }
      
      /* å‘é€æŒ‰é’®æ ·å¼ */
      .wechat-footer .send-btn {
        box-shadow: 0 4px 12px ${this.hexToRgba(colors.shadowColor, 0.3)};
      }
      
      .wechat-footer .send-btn:hover {
        box-shadow: 0 6px 16px ${this.hexToRgba(colors.shadowColor, 0.4)};
      }
      
      /* å¤œé—´æ¨¡å¼ç‰¹æ®Šå¤„ç† */
      ${colors.isDarkMode
            ? `
        .settings-card p, 
        .settings-card a,
        .settings-card li a,
        .post-content,
        .post-meta,
        .theme-editor-modal .modal-content {
          color: #e0e0e0 !important;
        }
        
        .settings-card,
        .theme-editor-modal .modal-content {
          background-color: #2a2a2a !important;
        }
        
        /* ä¿®æ”¹å¤œé—´æ¨¡å¼ä¸‹æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨æ ·å¼ */
        .typing-indicator .message-bubble {
          background-color: ${colors.bubbleThemBg} !important;
          background: ${colors.bubbleThemBg} !important;
          color: #ffffff !important;
          border: none !important;
        }
        
        .typing-dot {
          background-color: rgba(255, 255, 255, 0.6) !important;
        }
        
        .settings-card li {
          border-bottom-color: #3c3c3c !important;
        }
        
        .settings-card li a {
          color: #a0a0a0 !important;
        }
        
        #show-last-ai-response-btn,
        #show-last-sent-prompt-btn {
          background-color: #2c2c2c !important;
          color: #a0a0a0 !important;
        }

        /* æœ‹å‹åœˆæš—è‰²æ¨¡å¼ */
        #moments-view {
          background: linear-gradient(180deg, #1a1a1a 0%, #252525 100%) !important;
        }
        
        .moments-body {
          background-color: #1a1a1a !important;
        }
        
        .moment-post {
          border-bottom-color: #2c2c2c !important;
        }
        
        .post-interactions {
          background: #2a2a2a !important;
          border-color: #3c3c3c !important;
        }
        
        .post-interactions::before {
          border-bottom-color: #2a2a2a !important;
        }
        
        .likes-section {
          background: rgba(42, 42, 42, 0.8) !important;
        }
        
        .comments-section {
          border-top-color: #3c3c3c !important;
        }
        
        .post-meta .comment-button {
          background: #2c2c2c !important;
        }

        /* æœ‹å‹åœˆæ–‡å­—æè¿°å›¾ç‰‡æ ·å¼ - å¤œé—´æ¨¡å¼ */
        .post-media .image-desc-content {
          background-color: rgba(42, 42, 42, 0.8) !important;
          border: 1px solid rgba(60, 60, 60, 0.4) !important;
          color: #e0e0e0 !important;
        }

        /* æ›´å¤šå¤œé—´æ¨¡å¼æ ·å¼ */
        .post-author-name, 
        .liker-name, 
        .comment-author {
          color: #a0c0e0 !important;
        }
        
        .moments-header,
        .wechat-header {
          background: linear-gradient(315deg, #252525 0%, #1a1a1a 100%) !important;
          border-bottom-color: #3c3c3c !important;
        }
        
        .wechat-footer {
          background: linear-gradient(315deg, #252525 0%, #1a1a1a 100%) !important;
          border-top-color: #3c3c3c !important;
        }
        
        .wechat-footer .text-input {
          background-color: #2a2a2a !important;
          border-color: #3c3c3c !important;
          color: #e0e0e0 !important;
        }
        
        .wechat-footer .text-input::placeholder {
          color: #808080 !important;
        }
        
        .timestamp-text,
        .event-time-text {
          background: linear-gradient(315deg, #505050 0%, #3c3c3c 100%) !important;
        }
        
        .recall-notice-text {
          background: linear-gradient(315deg, #505050 0%, #3c3c3c 100%) !important;
        }
        
        .message-row.them .voice-bubble .voice-icon {
          color: #a0c0e0 !important;
        }
        
        .voice-text-content {
          background-color: #2a2a2a !important;
          border-color: #3c3c3c !important;
          color: #e0e0e0 !important;
        }
        
        .location-card,
        .file-card {
          background-color: #2a2a2a !important;
        }
        
        .location-content .location-title {
          color: #e0e0e0 !important;
        }
        
        .file-details .file-name {
          color: #e0e0e0 !important;
        }
        
        .file-footer {
          background-color: #252525 !important;
          border-top-color: #3c3c3c !important;
        }
        
        .panel-container {
          background-color: #1a1a1a !important;
        }
        
        .feature-icon {
          background-color: #2a2a2a !important;
          border-color: #3c3c3c !important;
        }
        
        .feature-label {
          color: #a0a0a0 !important;
        }
        
        /* Theme-colored icons in dark mode */
        .feature-icon .theme-icon {
          color: var(--primary-blue) !important;
        }
        
        /* å£çº¸é€‰æ‹©å™¨æš—è‰²æ¨¡å¼ */
        .wallpaper-container {
          background-color: #2a2a2a !important;
          color: #e0e0e0 !important;
        }
        
        .wallpaper-container h2,
        .wallpaper-container h3,
        .wallpaper-container p {
          color: #e0e0e0 !important;
        }
        
        .wallpaper-container input[type="text"],
        .wallpaper-container input[type="file"] {
          background-color: #1a1a1a !important;
          border-color: #3c3c3c !important;
          color: #e0e0e0 !important;
        }
        
        .wallpaper-item .name {
          background-color: rgba(42, 42, 42, 0.9) !important;
          color: #e0e0e0 !important;
        }
      `
            : ''}
    `;
        const oldDynamicStyles = document.getElementById('theme-dynamic-styles');
        if (oldDynamicStyles) {
            oldDynamicStyles.remove();
        }
        document.head.appendChild(style);
    }
    // è¾…åŠ©æ–¹æ³•ï¼šHEXè½¬RGBA
    hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    // è¾…åŠ©æ–¹æ³•ï¼šæå–RGBåˆ†é‡
    extractRgbComponents(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return { r, g, b };
    }
    // è¾…åŠ©æ–¹æ³•ï¼šè°ƒæ•´é¢œè‰²äº®åº¦
    lightenDarkenColor(color, amount) {
        let hex = color.replace('#', '');
        if (hex.length === 3) {
            hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
        }
        const num = parseInt(hex, 16);
        let r = (num >> 16) + amount;
        let g = ((num >> 8) & 0x00ff) + amount;
        let b = (num & 0x0000ff) + amount;
        r = Math.max(0, Math.min(255, r));
        g = Math.max(0, Math.min(255, g));
        b = Math.max(0, Math.min(255, b));
        const rHex = r.toString(16).padStart(2, '0');
        const gHex = g.toString(16).padStart(2, '0');
        const bHex = b.toString(16).padStart(2, '0');
        return `#${rHex}${gHex}${bHex}`;
    }
}
// å£çº¸ç®¡ç†å™¨ç±»
class WallpaperManager {
    static WALLPAPER_STORAGE_KEY_PREFIX = 'blmx_wallpaper_';
    static CUSTOM_WALLPAPERS_KEY = 'blmx_custom_wallpapers';
    static THEME_WALLPAPER_KEY_PREFIX = 'blmx_theme_wallpaper_';
    currentThemeName = 'white'; // é»˜è®¤ä¸»é¢˜åç§°
    // å†…ç½®å£çº¸
    builtInWallpapers = [
        { id: 'blue_solid', type: 'color', value: '#e8f4fd', name: 'è“è‰²çº¯è‰²' },
        { id: 'pink_solid', type: 'color', value: '#fde8f4', name: 'ç²‰è‰²çº¯è‰²' },
        { id: 'white_solid', type: 'color', value: '#f8f8f8', name: 'ç™½è‰²çº¯è‰²' },
        { id: 'dark_solid', type: 'color', value: '#1a1a1a', name: 'é»‘è‰²çº¯è‰²' },
        {
            id: 'default_image',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç™½è‰²_1.jpg',
            name: 'ç™½è‰²å£çº¸',
        },
        {
            id: 'dark_image',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/æ·±è‰²æ˜Ÿæ˜Ÿ_1.jpg',
            name: 'æ·±è‰²æ˜Ÿæ˜Ÿå£çº¸',
        },
        {
            id: 'blue_theme',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²æ˜Ÿæ˜Ÿ_1.jpg',
            name: 'è“è‰²æ˜Ÿæ˜Ÿå£çº¸',
        },
        {
            id: 'pink_theme',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ˜Ÿæ˜Ÿ_1.jpg',
            name: 'ç²‰è‰²æ˜Ÿæ˜Ÿå£çº¸',
        },
        {
            id: 'kitty_theme',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²å°çŒ«_1.jpg',
            name: 'ç²‰è‰²å°çŒ«å£çº¸',
        },
        {
            id: 'deep_stars_2',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/æ·±è‰²æ˜Ÿæ˜Ÿ_2.jpg',
            name: 'æ·±è‰²æ˜Ÿæ˜Ÿå£çº¸2',
        },
        {
            id: 'deep_stars_3',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/æ·±è‰²æ˜Ÿæ˜Ÿ_3.jpg',
            name: 'æ·±è‰²æ˜Ÿæ˜Ÿå£çº¸3',
        },
        {
            id: 'white_stars',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç™½è‰²æ˜Ÿæ˜Ÿ_1.jpg',
            name: 'ç™½è‰²æ˜Ÿæ˜Ÿå£çº¸',
        },
        {
            id: 'pink_stars_2',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ˜Ÿæ˜Ÿ_2.jpg',
            name: 'ç²‰è‰²æ˜Ÿæ˜Ÿå£çº¸2',
        },
        {
            id: 'pink_grid_2',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ ¼å­_2.jpg',
            name: 'ç²‰è‰²æ ¼å­å£çº¸2',
        },
        {
            id: 'pink_grid_4',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç²‰è‰²æ ¼å­_4.jpg',
            name: 'ç²‰è‰²æ ¼å­å£çº¸4',
        },
        {
            id: 'blue_1',
            type: 'image',
            value: 'https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/è“è‰²_1.jpg',
            name: 'è“è‰²å£çº¸1',
        },
    ];
    // è‡ªå®šä¹‰å£çº¸
    customWallpapers = [];
    constructor() {
        this.loadCustomWallpapers();
        // ä»localStorageåŠ è½½å½“å‰ä¸»é¢˜åç§°
        const savedThemeName = localStorage.getItem('blmx_theme');
        if (savedThemeName) {
            this.currentThemeName = savedThemeName;
        }
        // è¿ç§»æ—§çš„å£çº¸è®¾ç½®åˆ°æ–°çš„ä¸»é¢˜å…³è”æ ¼å¼
        this.migrateOldWallpaperSettings();
    }
    // è®¾ç½®å½“å‰ä¸»é¢˜åç§°
    setCurrentThemeName(themeName) {
        this.currentThemeName = themeName;
    }
    // è·å–æ‰€æœ‰å£çº¸ï¼ˆå†…ç½®+è‡ªå®šä¹‰ï¼‰
    getAllWallpapers() {
        return [...this.builtInWallpapers, ...this.customWallpapers];
    }
    // è·å–å†…ç½®å£çº¸
    getBuiltInWallpapers() {
        return this.builtInWallpapers;
    }
    // è·å–è‡ªå®šä¹‰å£çº¸
    getCustomWallpapers() {
        return this.customWallpapers;
    }
    // æ·»åŠ è‡ªå®šä¹‰å£çº¸
    addCustomWallpaper(wallpaper) {
        const id = `custom_${Date.now()}`;
        const newWallpaper = { ...wallpaper, id };
        this.customWallpapers.push(newWallpaper);
        this.saveCustomWallpapers();
        return newWallpaper;
    }
    // åˆ é™¤è‡ªå®šä¹‰å£çº¸
    deleteCustomWallpaper(id) {
        const initialLength = this.customWallpapers.length;
        this.customWallpapers = this.customWallpapers.filter(w => w.id !== id);
        if (this.customWallpapers.length !== initialLength) {
            this.saveCustomWallpapers();
            return true;
        }
        return false;
    }
    // è®¾ç½®å£çº¸ï¼ˆä¸ä¸»é¢˜å…³è”ï¼‰
    setWallpaper(viewType, wallpaper) {
        // ä½¿ç”¨ä¸»é¢˜åç§°ä½œä¸ºå­˜å‚¨é”®çš„ä¸€éƒ¨åˆ†
        const storageKey = `${WallpaperManager.THEME_WALLPAPER_KEY_PREFIX}${this.currentThemeName}_${viewType}`;
        if (wallpaper) {
            localStorage.setItem(storageKey, JSON.stringify(wallpaper));
        }
        else {
            localStorage.removeItem(storageKey);
        }
    }
    // è·å–å½“å‰å£çº¸ï¼ˆä¸ä¸»é¢˜å…³è”ï¼‰
    getCurrentWallpaper(viewType) {
        // é¦–å…ˆå°è¯•è·å–ä¸å½“å‰ä¸»é¢˜å…³è”çš„å£çº¸
        const themeStorageKey = `${WallpaperManager.THEME_WALLPAPER_KEY_PREFIX}${this.currentThemeName}_${viewType}`;
        const savedThemeWallpaper = localStorage.getItem(themeStorageKey);
        if (savedThemeWallpaper) {
            try {
                return JSON.parse(savedThemeWallpaper);
            }
            catch (e) {
                console.error('Failed to parse theme wallpaper:', e);
            }
        }
        // å¦‚æœæ²¡æœ‰ä¸ä¸»é¢˜å…³è”çš„å£çº¸ï¼Œåˆ™å°è¯•è·å–æ—§æ ¼å¼çš„å£çº¸è®¾ç½®ï¼ˆå…¼å®¹æ€§ï¼‰
        const oldStorageKey = `${WallpaperManager.WALLPAPER_STORAGE_KEY_PREFIX}${viewType}`;
        const savedOldWallpaper = localStorage.getItem(oldStorageKey);
        if (savedOldWallpaper) {
            try {
                return JSON.parse(savedOldWallpaper);
            }
            catch (e) {
                console.error('Failed to parse old wallpaper:', e);
            }
        }
        return null;
    }
    // è¿ç§»æ—§çš„å£çº¸è®¾ç½®åˆ°æ–°çš„ä¸»é¢˜å…³è”æ ¼å¼
    migrateOldWallpaperSettings() {
        const viewTypes = ['chat', 'home', 'settings'];
        viewTypes.forEach(viewType => {
            const oldStorageKey = `${WallpaperManager.WALLPAPER_STORAGE_KEY_PREFIX}${viewType}`;
            const savedOldWallpaper = localStorage.getItem(oldStorageKey);
            if (savedOldWallpaper) {
                try {
                    // è§£æä½†ä¸å­˜å‚¨æœªä½¿ç”¨çš„å˜é‡
                    JSON.parse(savedOldWallpaper);
                    // å°†æ—§è®¾ç½®è¿ç§»åˆ°å½“å‰ä¸»é¢˜ä¸‹
                    const themeStorageKey = `${WallpaperManager.THEME_WALLPAPER_KEY_PREFIX}${this.currentThemeName}_${viewType}`;
                    // åªæœ‰åœ¨å½“å‰ä¸»é¢˜ä¸‹æ²¡æœ‰è®¾ç½®æ—¶æ‰è¿ç§»
                    if (!localStorage.getItem(themeStorageKey)) {
                        localStorage.setItem(themeStorageKey, savedOldWallpaper);
                    }
                    // è¿ç§»ååˆ é™¤æ—§è®¾ç½®
                    localStorage.removeItem(oldStorageKey);
                }
                catch (e) {
                    console.error('Failed to migrate old wallpaper setting:', e);
                }
            }
        });
    }
    // åº”ç”¨ä¸»é¢˜é»˜è®¤å£çº¸
    applyThemeDefaultWallpapers(theme) {
        // æ›´æ–°å½“å‰ä¸»é¢˜åç§°
        this.setCurrentThemeName(theme.name);
        const viewTypes = ['chat', 'home', 'settings'];
        viewTypes.forEach(viewType => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä¸å½“å‰ä¸»é¢˜å…³è”çš„å£çº¸è®¾ç½®
            const themeStorageKey = `${WallpaperManager.THEME_WALLPAPER_KEY_PREFIX}${theme.name}_${viewType}`;
            const existingWallpaper = localStorage.getItem(themeStorageKey);
            if (existingWallpaper) {
                // å·²æœ‰å£çº¸è®¾ç½®ï¼Œä¿ç•™ç°æœ‰è®¾ç½®
                return;
            }
            const defaultValue = theme.colors.defaultWallpapers[viewType];
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¢œè‰²å€¼
            const isColor = defaultValue.startsWith('#');
            const wallpaper = {
                id: `theme_default_${viewType}`,
                type: isColor ? 'color' : 'image',
                value: defaultValue,
                name: `${theme.displayName}é»˜è®¤${viewType === 'chat' ? 'èŠå¤©' : viewType === 'home' ? 'ä¸»å±å¹•' : 'è®¾ç½®'}å£çº¸`,
            };
            // ä¿å­˜ä¸ºä¸ä¸»é¢˜å…³è”çš„å£çº¸
            localStorage.setItem(themeStorageKey, JSON.stringify(wallpaper));
        });
    }
    // åº”ç”¨å£çº¸åˆ°DOM
    applyWallpaperToElement(element, wallpaper, defaultThemeWallpaper) {
        if (!element)
            return;
        // é‡ç½®æ ·å¼
        element.style.backgroundImage = 'none';
        element.style.backgroundColor = '';
        element.style.backgroundSize = '';
        element.style.backgroundPosition = '';
        element.style.backgroundRepeat = '';
        if (wallpaper) {
            if (wallpaper.type === 'color') {
                // çº¯è‰²å£çº¸ - ç¡®ä¿æ¸…é™¤èƒŒæ™¯å›¾å¹¶è®¾ç½®èƒŒæ™¯è‰²
                element.style.backgroundImage = 'none';
                element.style.backgroundColor = wallpaper.value;
            }
            else {
                // å›¾ç‰‡å£çº¸
                element.style.backgroundImage = `url("${wallpaper.value}")`;
                element.style.backgroundSize = 'cover';
                element.style.backgroundPosition = 'center';
                element.style.backgroundRepeat = 'no-repeat';
            }
        }
        else if (defaultThemeWallpaper) {
            // ä½¿ç”¨ä¸»é¢˜é»˜è®¤å£çº¸
            if (defaultThemeWallpaper.startsWith('#')) {
                // å¦‚æœæ˜¯é¢œè‰²å€¼ï¼Œè®¾ç½®èƒŒæ™¯è‰²
                element.style.backgroundImage = 'none';
                element.style.backgroundColor = defaultThemeWallpaper;
            }
            else {
                // å¦‚æœæ˜¯å›¾ç‰‡URLï¼Œè®¾ç½®èƒŒæ™¯å›¾
                element.style.backgroundImage = `url("${defaultThemeWallpaper}")`;
                element.style.backgroundSize = 'cover';
                element.style.backgroundPosition = 'center';
                element.style.backgroundRepeat = 'no-repeat';
            }
        }
    }
    // ä»URLåˆ›å»ºå£çº¸
    async createWallpaperFromUrl(url, name) {
        try {
            // éªŒè¯URL
            new URL(url);
            return this.addCustomWallpaper({
                type: 'url',
                value: url,
                name: name || `URLå£çº¸ ${new Date().toLocaleString()}`,
            });
        }
        catch (e) {
            console.error('Invalid URL:', e);
            return null;
        }
    }
    // ä»Fileå¯¹è±¡åˆ›å»ºå£çº¸
    async createWallpaperFromFile(file) {
        return new Promise(resolve => {
            if (!file.type.startsWith('image/')) {
                resolve(null);
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                if (e.target?.result) {
                    const wallpaper = this.addCustomWallpaper({
                        type: 'image',
                        value: e.target.result,
                        name: file.name || `ä¸Šä¼ çš„å£çº¸ ${new Date().toLocaleString()}`,
                    });
                    resolve(wallpaper);
                }
                else {
                    resolve(null);
                }
            };
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(file);
        });
    }
    // åˆ›å»ºçº¯è‰²å£çº¸
    createSolidColorWallpaper(color, name) {
        // éªŒè¯é¢œè‰²æ ¼å¼ï¼Œæ”¯æŒ3ä½å’Œ6ä½åå…­è¿›åˆ¶é¢œè‰²
        if (!color.match(/^#([0-9A-Fa-f]{3}){1,2}$/)) {
            console.error('Invalid color format:', color);
            return null;
        }
        // ç¡®ä¿é¢œè‰²æ ¼å¼ç»Ÿä¸€ä¸º6ä½åå…­è¿›åˆ¶
        let normalizedColor = color;
        if (color.length === 4) {
            // #RGB æ ¼å¼
            const r = color[1];
            const g = color[2];
            const b = color[3];
            normalizedColor = `#${r}${r}${g}${g}${b}${b}`;
        }
        return this.addCustomWallpaper({
            type: 'color',
            value: normalizedColor,
            name: name || `çº¯è‰²å£çº¸ ${normalizedColor}`,
        });
    }
    // åŠ è½½è‡ªå®šä¹‰å£çº¸
    loadCustomWallpapers() {
        const savedWallpapers = localStorage.getItem(WallpaperManager.CUSTOM_WALLPAPERS_KEY);
        if (savedWallpapers) {
            try {
                this.customWallpapers = JSON.parse(savedWallpapers);
            }
            catch (e) {
                console.error('Failed to load custom wallpapers:', e);
                this.customWallpapers = [];
            }
        }
    }
    // ä¿å­˜è‡ªå®šä¹‰å£çº¸
    saveCustomWallpapers() {
        localStorage.setItem(WallpaperManager.CUSTOM_WALLPAPERS_KEY, JSON.stringify(this.customWallpapers));
    }
}

;// ./src/åŒå±‚æ‰‹æœº/ui-manager.ts
// ç”¨æˆ·ç•Œé¢ç®¡ç†æ¨¡å—
// è´Ÿè´£å¯¼èˆªã€é¢æ¿åˆ‡æ¢ã€å°ºå¯¸è°ƒæ•´ã€ç‰ˆæœ¬æ˜¾ç¤ºç­‰UIç›¸å…³åŠŸèƒ½

class UIManager {
    configManager;
    onAddEntry;
    onRenderEntry;
    constructor(configManager, onAddEntry, onRenderEntry) {
        this.configManager = configManager;
        this.onAddEntry = onAddEntry;
        this.onRenderEntry = onRenderEntry;
    }
    // æ˜¾ç¤ºåº”ç”¨ç‰ˆæœ¬
    displayAppVersion() {
        $('#app-version-display').text(`v${APP_VERSION}`);
    }
    // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºç‰ˆæœ¬æ›´æ–°é€šçŸ¥
    checkVersionUpdateNotification() {
        const lastNotifiedVersion = this.configManager.getLastNotifiedVersion();
        // å¦‚æœæ²¡æœ‰é€šçŸ¥è¿‡å½“å‰ç‰ˆæœ¬ï¼Œæ˜¾ç¤ºé€šçŸ¥
        if (lastNotifiedVersion !== APP_VERSION) {
            this.showVersionUpdateNotification();
            this.configManager.setLastNotifiedVersion(APP_VERSION);
        }
    }
    // æ˜¾ç¤ºç‰ˆæœ¬æ›´æ–°é€šçŸ¥
    showVersionUpdateNotification() {
        // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
        const updateEntry = {
            type: 'message',
            sender: 'them',
            content: `ç³»ç»Ÿæ¶ˆæ¯ï¼šåº”ç”¨å·²æ›´æ–°åˆ° v${APP_VERSION}ï¼Œå·²è‡ªåŠ¨æ¸…ç†è¿‡æ—¶æ•°æ®ä»¥ç¡®ä¿åŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚æ‚¨æ— éœ€æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€‚`,
            id: `system-${Date.now()}`,
            isSystemMessage: true,
        };
        // æ·»åŠ åˆ°èŠå¤©è®°å½•
        if (this.onAddEntry) {
            this.onAddEntry(updateEntry);
        }
        // æ¸²æŸ“æ¶ˆæ¯
        if (this.onRenderEntry) {
            this.onRenderEntry(updateEntry, undefined, true);
        }
    }
    // æ›´æ–°åº•éƒ¨æŒ‰é’®çŠ¶æ€
    updateFooterButtonsState(hasNotifications) {
        const $wechatInput = $('#wechat-input-field');
        const $sendBtn = $('#send-btn');
        const $plusBtn = $('#plus-btn');
        const hasText = $wechatInput.val()?.toString().trim() !== '';
        const shouldShowSendBtn = hasText || hasNotifications;
        // ä½¿ç”¨jQueryæ–¹æ³•æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
        $sendBtn.css('display', shouldShowSendBtn ? 'flex' : 'none');
        $plusBtn.css('display', hasText ? 'none' : 'inline-block');
    }
    // åˆ‡æ¢é¢æ¿
    togglePanel(panelToShow) {
        const $panelContainer = $('#panel-container');
        const $currentActivePanel = $('.panel-view.active');
        const isActive = $panelContainer.hasClass('active');
        if (isActive && $currentActivePanel.length && $currentActivePanel.attr('id')?.startsWith(panelToShow || '')) {
            $panelContainer.removeClass('active');
            $currentActivePanel.removeClass('active');
        }
        else if (panelToShow) {
            if ($currentActivePanel.length)
                $currentActivePanel.removeClass('active');
            $(`#${panelToShow}-panel`).addClass('active');
            if (!isActive)
                $panelContainer.addClass('active');
        }
        else {
            if (isActive)
                $panelContainer.removeClass('active');
            if ($currentActivePanel.length)
                $currentActivePanel.removeClass('active');
        }
    }
    // å¯¼èˆªåˆ°æŒ‡å®šè§†å›¾
    navigateTo(viewName, onEnterMomentsView) {
        const views = {
            home: '#app-homescreen',
            wechat: '#wechat-view',
            moments: '#moments-view',
            settings: '#settings-view',
        };
        // ä½¿ç”¨jQueryéšè—æ‰€æœ‰è§†å›¾å¹¶æ˜¾ç¤ºç›®æ ‡è§†å›¾
        $('.app-view').removeClass('active');
        $(views[viewName]).addClass('active');
        // å½“å¯¼èˆªåˆ°æœ‹å‹åœˆè§†å›¾æ—¶ï¼Œæ‰§è¡Œå›è°ƒ
        if (viewName === 'moments' && onEnterMomentsView) {
            onEnterMomentsView();
        }
    }
    // è®¾ç½®è¾“å…¥æ¡†æç¤ºæ–‡å­—
    setupInputPlaceholder(charDisplayName) {
        const savedPlaceholder = this.configManager.getSavedInputPlaceholder();
        const $inputElement = $('#wechat-input-field');
        $inputElement.attr('placeholder', savedPlaceholder || `ä¸ ${charDisplayName} å¯¹è¯...`);
        $inputElement.prop('disabled', false);
    }
    // è®¾ç½®æ‰‹æœºå°ºå¯¸è°ƒæ•´
    setupPhoneSizeAdjustment() {
        const defaultBtn = document.getElementById('phone-size-default');
        const mediumBtn = document.getElementById('phone-size-medium');
        const smallBtn = document.getElementById('phone-size-small');
        const phoneScreen = document.querySelector('.phone-screen');
        if (!defaultBtn || !mediumBtn || !smallBtn || !phoneScreen) {
            console.error('[BLMX] Phone size adjustment elements not found');
            return;
        }
        // åº”ç”¨ä¿å­˜çš„å°ºå¯¸è®¾ç½®
        const savedSize = this.configManager.getPhoneSize();
        this.applyPhoneSize(savedSize, phoneScreen, [defaultBtn, mediumBtn, smallBtn]);
        // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        defaultBtn.addEventListener('click', () => {
            this.applyPhoneSize('default', phoneScreen, [defaultBtn, mediumBtn, smallBtn]);
        });
        mediumBtn.addEventListener('click', () => {
            this.applyPhoneSize('medium', phoneScreen, [defaultBtn, mediumBtn, smallBtn]);
        });
        smallBtn.addEventListener('click', () => {
            this.applyPhoneSize('small', phoneScreen, [defaultBtn, mediumBtn, smallBtn]);
        });
    }
    // è®¾ç½®è¡¨æƒ…åŒ…å°ºå¯¸æ§åˆ¶
    setupStickerSizeControl() {
        const sizeSlider = document.getElementById('sticker-size-slider');
        const sizeInput = document.getElementById('sticker-size-input');
        const smallSizeBtn = document.getElementById('sticker-size-small');
        const mediumSizeBtn = document.getElementById('sticker-size-medium');
        if (!sizeSlider || !sizeInput || !smallSizeBtn || !mediumSizeBtn) {
            return;
        }
        // è·å–ä¿å­˜çš„å°ºå¯¸è®¾ç½®
        const savedSize = this.configManager.getStickerSize();
        // åˆå§‹åŒ–æ§ä»¶å€¼
        sizeSlider.value = savedSize.toString();
        sizeInput.value = savedSize.toString();
        // è®¾ç½®åˆå§‹æŒ‰é’®çŠ¶æ€
        if (savedSize === 80) {
            smallSizeBtn.classList.add('sticker-size-active');
            mediumSizeBtn.classList.remove('sticker-size-active');
        }
        else if (savedSize === 120) {
            smallSizeBtn.classList.remove('sticker-size-active');
            mediumSizeBtn.classList.add('sticker-size-active');
        }
        else {
            smallSizeBtn.classList.remove('sticker-size-active');
            mediumSizeBtn.classList.remove('sticker-size-active');
        }
        // è®¾ç½®CSSå˜é‡
        this.applyStickerSize(savedSize);
        // æ»‘å—äº‹ä»¶
        sizeSlider.addEventListener('input', () => {
            const newSize = parseInt(sizeSlider.value);
            sizeInput.value = newSize.toString();
            this.configManager.setStickerSize(newSize);
            this.applyStickerSize(newSize);
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            this.updateStickerSizeButtonState(newSize, smallSizeBtn, mediumSizeBtn);
        });
        // æ•°å­—è¾“å…¥æ¡†äº‹ä»¶
        sizeInput.addEventListener('change', () => {
            let newSize = parseInt(sizeInput.value);
            // é™åˆ¶èŒƒå›´
            if (newSize < 40)
                newSize = 40;
            if (newSize > 200)
                newSize = 200;
            const newSizeStr = newSize.toString();
            sizeInput.value = newSizeStr;
            sizeSlider.value = newSizeStr;
            this.configManager.setStickerSize(newSize);
            this.applyStickerSize(newSize);
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            this.updateStickerSizeButtonState(newSize, smallSizeBtn, mediumSizeBtn);
        });
        // å°å°ºå¯¸æŒ‰é’®äº‹ä»¶
        smallSizeBtn.addEventListener('click', () => {
            this.setStickerSize(80, sizeSlider, sizeInput, smallSizeBtn, mediumSizeBtn);
        });
        // ä¸­å°ºå¯¸æŒ‰é’®äº‹ä»¶
        mediumSizeBtn.addEventListener('click', () => {
            this.setStickerSize(120, sizeSlider, sizeInput, smallSizeBtn, mediumSizeBtn);
        });
    }
    // åº”ç”¨æ‰‹æœºå°ºå¯¸è®¾ç½®
    applyPhoneSize(size, phoneScreen, buttons) {
        // æ‰‹æœºå°ºå¯¸å¸¸é‡
        const PHONE_SIZES = {
            default: '48.75rem', // é»˜è®¤å°ºå¯¸: 48.75rem (780px)
            medium: '42rem', // ä¸­ç­‰å°ºå¯¸: 42rem (672px)
            small: '36rem', // å°å°ºå¯¸: 36rem (576px)
        };
        // è®¾ç½®å±å¹•é«˜åº¦
        phoneScreen.style.height = PHONE_SIZES[size];
        // ä¿å­˜è®¾ç½®
        this.configManager.setPhoneSize(size);
        // æ›´æ–°æŒ‰é’®æ ·å¼
        buttons.forEach(btn => btn.classList.remove('phone-size-active'));
        // æ ¹æ®é€‰æ‹©çš„å°ºå¯¸æ¿€æ´»å¯¹åº”æŒ‰é’®
        if (size === 'default') {
            buttons[0].classList.add('phone-size-active');
        }
        else if (size === 'medium') {
            buttons[1].classList.add('phone-size-active');
        }
        else if (size === 'small') {
            buttons[2].classList.add('phone-size-active');
        }
    }
    // åº”ç”¨è¡¨æƒ…åŒ…å°ºå¯¸
    applyStickerSize(size) {
        document.documentElement.style.setProperty('--sticker-size', `${size}px`);
    }
    // è®¾ç½®è¡¨æƒ…åŒ…å°ºå¯¸
    setStickerSize(size, sizeSlider, sizeInput, smallSizeBtn, mediumSizeBtn) {
        sizeSlider.value = size.toString();
        sizeInput.value = size.toString();
        this.configManager.setStickerSize(size);
        this.applyStickerSize(size);
        this.updateStickerSizeButtonState(size, smallSizeBtn, mediumSizeBtn);
    }
    // æ›´æ–°è¡¨æƒ…åŒ…å°ºå¯¸æŒ‰é’®çŠ¶æ€
    updateStickerSizeButtonState(size, smallSizeBtn, mediumSizeBtn) {
        if (size === 80) {
            smallSizeBtn.classList.add('sticker-size-active');
            mediumSizeBtn.classList.remove('sticker-size-active');
        }
        else if (size === 120) {
            smallSizeBtn.classList.remove('sticker-size-active');
            mediumSizeBtn.classList.add('sticker-size-active');
        }
        else {
            smallSizeBtn.classList.remove('sticker-size-active');
            mediumSizeBtn.classList.remove('sticker-size-active');
        }
    }
    // æ»šåŠ¨åˆ°èŠå¤©åº•éƒ¨
    scrollToBottom() {
        setTimeout(() => {
            const wechatBody = document.querySelector('.wechat-body');
            if (wechatBody) {
                wechatBody.scrollTop = wechatBody.scrollHeight;
            }
        }, 300);
    }
    // è®¾ç½®å­—ä½“é€‰æ‹©åŠŸèƒ½
    setupFontSelection() {
        const $customFontBtn = $('#font-default');
        const $systemFontBtn = $('#font-system');
        if (!$customFontBtn.length || !$systemFontBtn.length) {
            return;
        }
        // ä»localStorageè¯»å–ä¿å­˜çš„å­—ä½“è®¾ç½®
        const savedFont = localStorage.getItem('blmx_font_setting') || 'custom';
        this.applyFontSetting(savedFont);
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        $customFontBtn.on('click', () => {
            this.applyFontSetting('custom');
            localStorage.setItem('blmx_font_setting', 'custom');
        });
        $systemFontBtn.on('click', () => {
            this.applyFontSetting('system');
            localStorage.setItem('blmx_font_setting', 'system');
        });
    }
    // åº”ç”¨å­—ä½“è®¾ç½®
    applyFontSetting(fontType) {
        const $body = $('body');
        const $customBtn = $('#font-default');
        const $systemBtn = $('#font-system');
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
        $('.font-btn').removeClass('font-active');
        if (fontType === 'custom') {
            // ä½¿ç”¨è‡ªå®šä¹‰å­—ä½“ - æ”¹è¿›å…¼å®¹æ€§
            this.applyCustomFont();
            $customBtn.addClass('font-active');
        }
        else {
            // ä½¿ç”¨ç³»ç»Ÿå­—ä½“ - æ”¹è¿›å…¼å®¹æ€§
            this.applySystemFont();
            $systemBtn.addClass('font-active');
        }
    }
    // åº”ç”¨è‡ªå®šä¹‰å­—ä½“çš„å…¼å®¹æ€§æ–¹æ³•
    applyCustomFont() {
        const $body = $('body');
        // æ£€æµ‹ç‰¹æ®ŠWebViewç¯å¢ƒ
        const isIOSWebView = /iPhone|iPad|iPod/.test(navigator.userAgent) && /WebKit/.test(navigator.userAgent);
        const isHuaweiWebView = /HUAWEI/.test(navigator.userAgent);
        if (isIOSWebView || isHuaweiWebView) {
            // å¯¹äºé—®é¢˜WebViewï¼Œä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•
            // ç›´æ¥è®¾ç½®å­—ä½“ï¼Œä¸ä¾èµ–Font Loading API
            const fontStack = "'MyCustomFont', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif";
            $body.css('font-family', fontStack);
            // å¼ºåˆ¶é‡æ–°æ¸²æŸ“
            $body.addClass('force-font-refresh');
            setTimeout(() => {
                $body.removeClass('force-font-refresh');
            }, 50);
            // å»¶è¿Ÿå†æ¬¡åº”ç”¨ï¼Œç¡®ä¿ç”Ÿæ•ˆ
            setTimeout(() => {
                $body.css('font-family', fontStack);
            }, 100);
            return;
        }
        // å¯¹äºæ­£å¸¸æµè§ˆå™¨ï¼Œä½¿ç”¨æ ‡å‡†æ–¹æ³•
        this.checkFontLoaded('MyCustomFont').then(loaded => {
            if (loaded) {
                // å­—ä½“å·²åŠ è½½ï¼Œç›´æ¥åº”ç”¨
                $body.css('font-family', "'MyCustomFont', 'Noto Sans SC', sans-serif");
            }
            else {
                // å­—ä½“æœªåŠ è½½ï¼Œå°è¯•åŠ è½½åå†åº”ç”¨
                this.loadCustomFont()
                    .then(() => {
                    $body.css('font-family', "'MyCustomFont', 'Noto Sans SC', sans-serif");
                })
                    .catch(() => {
                    // åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å­—ä½“
                    $body.css('font-family', "'Noto Sans SC', sans-serif");
                });
            }
        });
    }
    // åº”ç”¨ç³»ç»Ÿå­—ä½“çš„å…¼å®¹æ€§æ–¹æ³•
    applySystemFont() {
        const $body = $('body');
        // æ£€æµ‹ç‰¹æ®ŠWebViewç¯å¢ƒ
        const isIOSWebView = /iPhone|iPad|iPod/.test(navigator.userAgent) && /WebKit/.test(navigator.userAgent);
        const isHuaweiWebView = /HUAWEI/.test(navigator.userAgent);
        let fontStack;
        if (isIOSWebView) {
            // iOS WebView ä¼˜åŒ–å­—ä½“æ ˆ
            fontStack = '-apple-system, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif';
        }
        else if (isHuaweiWebView) {
            // åä¸º WebView ä¼˜åŒ–å­—ä½“æ ˆ
            fontStack = '"HarmonyOS Sans", "Noto Sans SC", "Microsoft YaHei", Arial, sans-serif';
        }
        else {
            // é€šç”¨ç³»ç»Ÿå­—ä½“æ ˆ
            fontStack =
                '-apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"';
        }
        $body.css('font-family', fontStack);
        // å¯¹äºé—®é¢˜WebViewï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
        if (isIOSWebView || isHuaweiWebView) {
            $body.addClass('force-font-refresh');
            setTimeout(() => {
                $body.removeClass('force-font-refresh');
            }, 50);
        }
    }
    // æ£€æŸ¥å­—ä½“æ˜¯å¦å·²åŠ è½½
    checkFontLoaded(fontFamily) {
        return new Promise(resolve => {
            if (!document.fonts) {
                // ä¸æ”¯æŒFont Loading APIï¼Œå‡è®¾å·²åŠ è½½
                resolve(true);
                return;
            }
            document.fonts.ready
                .then(() => {
                const fontFace = Array.from(document.fonts).find(font => font.family === fontFamily || font.family === `'${fontFamily}'`);
                resolve(!!fontFace && fontFace.status === 'loaded');
            })
                .catch(() => {
                resolve(false);
            });
        });
    }
    // åŠ è½½è‡ªå®šä¹‰å­—ä½“
    loadCustomFont() {
        return new Promise((resolve, reject) => {
            if (!document.fonts) {
                // ä¸æ”¯æŒFont Loading APIï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const testElement = $('<div>')
                    .css({
                    position: 'absolute',
                    left: '-9999px',
                    top: '-9999px',
                    fontSize: '72px',
                    fontFamily: "'MyCustomFont', monospace",
                    visibility: 'hidden',
                })
                    .text('test')
                    .appendTo('body');
                // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ£€æŸ¥
                setTimeout(() => {
                    testElement.remove();
                    resolve();
                }, 1000);
                return;
            }
            const fontFace = new FontFace('MyCustomFont', 'url(https://files.catbox.moe/er4wsg.ttf)');
            fontFace
                .load()
                .then(loadedFace => {
                document.fonts.add(loadedFace);
                resolve();
            })
                .catch(error => {
                reject(error);
            });
        });
    }
    // è®¾ç½®å…¨å±æ¨¡å¼æ‰‹æœºå¤§å°è°ƒæ•´
    setupFullscreenSizeAdjustment() {
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
            const $defaultBtn = $('#fullscreen-size-default');
            const $largeBtn = $('#fullscreen-size-large');
            const $xlargeBtn = $('#fullscreen-size-xlarge');
            const $slider = $('#fullscreen-size-slider');
            const $input = $('#fullscreen-size-input');
            if (!$defaultBtn.length || !$largeBtn.length || !$xlargeBtn.length || !$slider.length || !$input.length) {
                return;
            }
            this.initializeFullscreenSizeControls($defaultBtn, $largeBtn, $xlargeBtn, $slider, $input);
        }, 100);
    }
    // åˆå§‹åŒ–å…¨å±å¤§å°æ§ä»¶
    initializeFullscreenSizeControls($defaultBtn, $largeBtn, $xlargeBtn, $slider, $input) {
        // ä»localStorageè¯»å–ä¿å­˜çš„å…¨å±å¤§å°è®¾ç½®
        const savedSize = this.configManager.getFullscreenSize();
        // åˆå§‹åŒ–æ§ä»¶å€¼
        $slider.val(savedSize);
        $input.val(savedSize);
        this.applyFullscreenSize(savedSize);
        this.updateFullscreenSizeButtonState(savedSize);
        // é¢„è®¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $defaultBtn.off('click').on('click', e => {
            e.preventDefault();
            e.stopPropagation();
            this.setFullscreenSize(100);
        });
        $largeBtn.off('click').on('click', e => {
            e.preventDefault();
            e.stopPropagation();
            this.setFullscreenSize(130);
        });
        $xlargeBtn.off('click').on('click', e => {
            e.preventDefault();
            e.stopPropagation();
            this.setFullscreenSize(160);
        });
        // æ»‘å—äº‹ä»¶
        $slider.off('input').on('input', e => {
            const newSize = parseInt($(e.target).val());
            $input.val(newSize);
            this.setFullscreenSize(newSize);
        });
        // æ•°å­—è¾“å…¥æ¡†äº‹ä»¶
        $input.off('change').on('change', e => {
            let newSize = parseInt($(e.target).val());
            // é™åˆ¶èŒƒå›´
            if (newSize < 50)
                newSize = 50;
            if (newSize > 200)
                newSize = 200;
            $input.val(newSize);
            $slider.val(newSize);
            this.setFullscreenSize(newSize);
        });
        // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
        this.setupFullscreenListener();
    }
    // è®¾ç½®å…¨å±çŠ¶æ€ç›‘å¬å™¨
    setupFullscreenListener() {
        const handleFullscreenChange = () => {
            const isFullscreen = !!(document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement);
            if (!isFullscreen) {
                // é€€å‡ºå…¨å±æ—¶é‡ç½®ç¼©æ”¾
                this.resetBrowserZoom();
            }
            else {
                // è¿›å…¥å…¨å±æ—¶åº”ç”¨å½“å‰è®¾ç½®
                const currentSize = this.configManager.getFullscreenSize();
                this.applyBrowserLikeZoom(currentSize / 100);
            }
        };
        // ç»‘å®šå…¨å±çŠ¶æ€å˜åŒ–äº‹ä»¶
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
    }
    // é‡ç½®æµè§ˆå™¨ç¼©æ”¾
    resetBrowserZoom() {
        const body = document.body;
        // é‡ç½®æ‰€æœ‰ç¼©æ”¾ç›¸å…³æ ·å¼
        body.style.transform = '';
        body.style.transformOrigin = '';
        body.style.position = '';
        body.style.width = '';
        body.style.height = '';
        body.style.margin = '';
    }
    // è®¾ç½®å…¨å±å¤§å°å¹¶æ›´æ–°UI
    setFullscreenSize(size) {
        // ä¿å­˜è®¾ç½®
        this.configManager.setFullscreenSize(size);
        // æ›´æ–°æ»‘å—å’Œè¾“å…¥æ¡†
        $('#fullscreen-size-slider').val(size);
        $('#fullscreen-size-input').val(size);
        // åº”ç”¨è®¾ç½®
        this.applyFullscreenSize(size);
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        this.updateFullscreenSizeButtonState(size);
    }
    // åº”ç”¨å…¨å±æ¨¡å¼æ‰‹æœºå¤§å°è®¾ç½®
    applyFullscreenSize(size) {
        const scale = size / 100;
        // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨å…¨å±æ¨¡å¼
        const isFullscreen = !!(document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement);
        if (isFullscreen) {
            // åœ¨å…¨å±æ¨¡å¼ä¸‹åº”ç”¨æµè§ˆå™¨çº§åˆ«çš„ç¼©æ”¾
            this.applyBrowserLikeZoom(scale);
        }
        // åˆ é™¤éå…¨å±æ¨¡å¼ä¸‹çš„ä¸´æ—¶é¢„è§ˆåŠŸèƒ½
    }
    // åº”ç”¨ç±»ä¼¼æµè§ˆå™¨çš„ç¼©æ”¾æ•ˆæœ
    applyBrowserLikeZoom(scale) {
        const body = document.body;
        if (scale !== 1) {
            body.style.transform = `scale(${scale})`;
            body.style.transformOrigin = 'center center';
            body.style.position = 'relative';
            body.style.width = `${100 / scale}%`;
            body.style.height = `${100 / scale}%`;
            body.style.margin = '0 auto';
        }
        else {
            body.style.transform = '';
            body.style.transformOrigin = '';
            body.style.position = '';
            body.style.width = '';
            body.style.height = '';
            body.style.margin = '';
        }
    }
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateFullscreenSizeButtonState(size) {
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
        $('.fullscreen-size-btn').removeClass('fullscreen-size-active');
        // æ ¹æ®å¤§å°æ¿€æ´»å¯¹åº”æŒ‰é’®
        if (size === 100) {
            $('#fullscreen-size-default').addClass('fullscreen-size-active');
        }
        else if (size === 130) {
            $('#fullscreen-size-large').addClass('fullscreen-size-active');
        }
        else if (size === 160) {
            $('#fullscreen-size-xlarge').addClass('fullscreen-size-active');
        }
        // è‡ªå®šä¹‰å¤§å°ä¸æ¿€æ´»ä»»ä½•é¢„è®¾æŒ‰é’®
    }
}

;// ./src/åŒå±‚æ‰‹æœº/ui-renderer.ts

// UIæ¸²æŸ“å™¨ç±»
class UIRenderer {
    wechatBody;
    lastDisplayedTimeInMinutes = -Infinity;
    options;
    avatars;
    eventManager;
    // æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ æ¸²æŸ“èŠ‚æµ
    renderQueue = [];
    isRendering = false;
    renderThrottle = 16; // 60fps
    constructor(wechatBodySelector, avatars, options) {
        const $wechatBody = $(wechatBodySelector);
        if (!$wechatBody.length) {
            throw new Error(`Element with selector "${wechatBodySelector}" not found`);
        }
        this.wechatBody = $wechatBody[0];
        this.avatars = avatars;
        this.options = options;
        this.eventManager = new EventManager();
        // å¯åŠ¨æ¸²æŸ“é˜Ÿåˆ—å¤„ç†
        this.startRenderLoop();
    }
    /**
     * æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡æ¸²æŸ“é˜Ÿåˆ—å¤„ç†
     */
    startRenderLoop() {
        const processQueue = () => {
            if (this.renderQueue.length > 0 && !this.isRendering) {
                this.isRendering = true;
                const batch = this.renderQueue.splice(0, 5); // æ¯æ¬¡å¤„ç†5ä¸ª
                batch.forEach(entry => {
                    this.renderEntry(entry, undefined, false);
                });
                this.isRendering = false;
            }
            setTimeout(processQueue, this.renderThrottle);
        };
        processQueue();
    }
    /**
     * æ·»åŠ åˆ°æ¸²æŸ“é˜Ÿåˆ—è€Œä¸æ˜¯ç«‹å³æ¸²æŸ“
     */
    queueRender(entry) {
        this.renderQueue.push(entry);
    }
    // æ¸…é™¤èŠå¤©ç•Œé¢
    clearChat() {
        this.wechatBody.innerHTML = '';
        this.lastDisplayedTimeInMinutes = -Infinity;
    }
    // æ¸²æŸ“å•ä¸ªæ¡ç›®åˆ°UI
    renderEntry(entry, index, animate = false) {
        if (!entry)
            return;
        if ('type' in entry) {
            switch (entry.type) {
                case 'message':
                    if (entry.isSystemMessage) {
                        this.renderSystemMessage(entry, animate, index);
                    }
                    else {
                        this.addMessageToWeChat(entry, index, animate);
                    }
                    break;
                case 'time':
                    this.addTimestampToWeChat(entry.content.date, entry.content.time, true, index);
                    break;
                case 'event':
                    this.addEventLogToWeChat(entry.content, index);
                    break;
                default:
                    this.addMessageToWeChat(entry, index, animate);
            }
        }
    }
    // æ¸²æŸ“æ’¤å›é€šçŸ¥
    renderRecallNotice(entry, elementToReplace = null, index) {
        const who = this.options.getDisplayName('sender' in entry && entry.sender === 'me' ? 'user' : 'char');
        const noticeRow = document.createElement('div');
        noticeRow.className = 'timestamp-row';
        // ç¡®ä¿æ·»åŠ data-log-indexå±æ€§ï¼Œè¿™æ ·åœ¨åˆ é™¤æ¨¡å¼ä¸‹å¯ä»¥æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        if (index !== undefined) {
            noticeRow.dataset.logIndex = index.toString();
        }
        // å¦‚æœæœ‰idï¼Œæ·»åŠ message-idå±æ€§
        if ('id' in entry) {
            noticeRow.dataset.messageId = entry.id;
        }
        const recalledText = typeof entry.recalled_content === 'object' && entry.recalled_content !== null
            ? entry.recalled_content.text
            : entry.recalled_content;
        noticeRow.innerHTML = `
      <div class="recall-notice-container">
        <div class="recall-notice-text">"${who}" æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯</div>
        <div class="recall-content">${recalledText || ('content' in entry ? entry.content : '')}</div>
      </div>
    `;
        const noticeTextEl = noticeRow.querySelector('.recall-notice-text');
        const contentEl = noticeRow.querySelector('.recall-content');
        if (noticeTextEl && contentEl) {
            noticeTextEl.addEventListener('click', () => {
                contentEl.classList.toggle('expanded');
            });
        }
        if (elementToReplace) {
            elementToReplace.replaceWith(noticeRow);
        }
        else {
            this.wechatBody.appendChild(noticeRow);
        }
        this.scrollToBottom();
    }
    renderMomentsFeed(logEntries, getDisplayName, avatars) {
        const momentsFeedList = $('#moments-feed-list')[0];
        if (!momentsFeedList)
            return;
        momentsFeedList.innerHTML = '';
        const posts = {};
        const momentPostLogIndices = [];
        logEntries.forEach((entry, index) => {
            if ('key' in entry && entry.key.includes('_MOMENT')) {
                momentPostLogIndices.push(index);
            }
        });
        momentPostLogIndices.forEach(logIndex => {
            const entry = logEntries[logIndex];
            posts[logIndex] = { ...entry, likes: [], comments: [], id: logIndex };
        });
        logEntries.forEach((entry, index) => {
            if ('key' in entry && (entry.key.includes('_LIKE') || entry.key.includes('_COMMENT'))) {
                const targetPostAbsoluteIndex = momentPostLogIndices[parseInt(entry.data.target_post_id, 10)];
                const targetPost = posts[targetPostAbsoluteIndex];
                if (targetPost) {
                    if (entry.key.includes('_LIKE')) {
                        const likerName = entry.key.startsWith('USER') ? getDisplayName('user') : getDisplayName('char');
                        if (!targetPost.likes.some((l) => l.name === likerName)) {
                            targetPost.likes.push({ key: entry.key, name: likerName, originalLogIndex: index });
                        }
                    }
                    else {
                        targetPost.comments.push({ ...entry, originalLogIndex: index });
                    }
                }
                else {
                    // ç›®æ ‡å¸–å­æœªæ‰¾åˆ°ï¼Œè·³è¿‡äº¤äº’æ¸²æŸ“
                }
            }
        });
        Object.values(posts)
            .reverse()
            .forEach(post => {
            const fromUser = post.key.startsWith('USER');
            const authorName = fromUser ? getDisplayName('user') : getDisplayName('char');
            const authorAvatar = fromUser ? avatars.user : avatars.char;
            const li = document.createElement('li');
            li.className = 'moment-post';
            li.dataset.postId = post.id;
            const momentSequenceId = momentPostLogIndices.indexOf(post.id);
            li.dataset.momentSequenceId = String(momentSequenceId);
            // è®¾ç½®moment-idå±æ€§ï¼Œç”¨äºåˆ é™¤åŠŸèƒ½
            li.dataset.momentId = String(momentSequenceId);
            let mediaHtml = '';
            if (post.data.image_type === 'url' && post.data.image) {
                mediaHtml = `<img src="${post.data.image}" class="post-media-image" />`;
            }
            else if (post.data.image_type === 'desc' && post.data.image) {
                mediaHtml = `<div class="image-desc-content"><div class="text-wrapper">${post.data.image}</div></div>`;
            }
            let interactionsHtml = '';
            if (post.likes.length > 0 || post.comments.length > 0) {
                const likersHtml = post.likes.length > 0
                    ? `<div class="likes-section"><i class="fas fa-heart"></i> ${post.likes
                        .map((l) => `<span class="liker-name">${l.name}</span>`)
                        .join(', ')}</div>`
                    : '';
                const commentsHtml = post.comments.length > 0
                    ? `<ul class="comments-section">${post.comments
                        .map((c) => `<li><span class="comment-author">${c.key.startsWith('USER') ? getDisplayName('user') : getDisplayName('char')}</span>: ${c.data.text}</li>`)
                        .join('')}</ul>`
                    : '';
                interactionsHtml = `<div class="post-interactions">${likersHtml}${commentsHtml}</div>`;
            }
            const displayTime = this.formatMomentTimestamp(post.data.date, post.data.time);
            const deleteBtnHtml = fromUser ? `<span class="delete-moment-btn" title="åˆ é™¤">åˆ é™¤</span>` : '';
            li.innerHTML = `<img src="${authorAvatar}" class="post-author-avatar" />
                         <div class="post-details">
                             <span class="post-author-name">${authorName}</span>
                             <p class="post-content">${post.data.text || ''}</p>
                             <div class="post-media">${mediaHtml}</div>
                             <div class="post-meta">
                                 <div class="post-meta-left">
                                     <span class="timestamp">${displayTime}</span>
                                     ${deleteBtnHtml}
                                 </div>
                                 <div class="post-actions">
                                     <span class="comment-button" title="è¯„è®º/ç‚¹èµ"><i class="fas fa-comment-dots"></i></span>
                                 </div>
                             </div>
                             ${interactionsHtml}
                         </div>`;
            momentsFeedList.appendChild(li);
        });
    }
    // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
    showTypingIndicator() {
        this.hideTypingIndicator(); // ç¡®ä¿åªæœ‰ä¸€ä¸ª
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.id = 'typing-indicator-id';
        const avatarSrc = this.avatars.char;
        indicator.innerHTML = `
      <img src="${avatarSrc}" class="message-avatar" />
      <div class="message-bubble">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    `;
        this.wechatBody.appendChild(indicator);
        this.scrollToBottom();
    }
    // éšè—"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
    hideTypingIndicator() {
        $('#typing-indicator-id').remove();
    }
    // æ˜¾ç¤ºAIç”Ÿæˆå†…å®¹çš„åŠ è½½åŠ¨ç”»ï¼ˆåœ¨çµåŠ¨å²›ä¸Šï¼‰
    showGeneratingIndicator() {
        this.hideGeneratingIndicator(); // ç¡®ä¿åªæœ‰ä¸€ä¸ª
        // è·å–çµåŠ¨å²›å…ƒç´  - ä½¿ç”¨jQuery
        const dynamicIsland = $('.dynamic-island')[0];
        if (!dynamicIsland)
            return;
        // åˆ›å»ºåŠ è½½åŠ¨ç”»å®¹å™¨
        const loadingContainer = document.createElement('div');
        loadingContainer.className = 'generating-indicator';
        loadingContainer.id = 'generating-indicator-id';
        // åˆ›å»ºåŠ è½½åŠ¨ç”»ç‚¹
        loadingContainer.innerHTML = `
      <span class="generating-dot"></span>
      <span class="generating-dot"></span>
      <span class="generating-dot"></span>
    `;
        // æ·»åŠ åˆ°çµåŠ¨å²›
        dynamicIsland.appendChild(loadingContainer);
        // æ·»åŠ æ´»è·ƒç±»
        dynamicIsland.classList.add('generating-active');
    }
    // éšè—AIç”Ÿæˆå†…å®¹çš„åŠ è½½åŠ¨ç”»
    hideGeneratingIndicator() {
        $('#generating-indicator-id').remove();
        $('.dynamic-island').removeClass('generating-active');
    }
    // è®¡ç®—æ‰“å­—å»¶è¿Ÿæ—¶é—´
    calculateTypingDelay(messageContent) {
        // å¯¹äºéæ–‡æœ¬æ¶ˆæ¯ï¼ˆå¦‚è¡¨æƒ…ã€å›¾ç‰‡ç­‰ï¼‰ï¼Œä½¿ç”¨ä¸€ä¸ªè¾ƒçŸ­çš„å›ºå®šå»¶è¿Ÿ
        if (typeof messageContent !== 'string' || messageContent.trim() === '') {
            return 800 + Math.random() * 700; // 0.8s to 1.5s
        }
        const textLength = messageContent.length;
        const baseDelay = 500; // åŸºç¡€å»¶è¿Ÿ 0.5s
        const perCharDelay = 40; // æ¯ä¸ªå­—ç¬¦å¢åŠ  40ms
        const randomComponent = Math.random() * 800; // å¢åŠ  0-0.8s çš„éšæœºæ€§
        const totalDelay = baseDelay + textLength * perCharDelay + randomComponent;
        // ç¡®ä¿æ€»å»¶è¿Ÿä¸è¶…è¿‡3ç§’ (3000ms)
        return Math.min(totalDelay, 3000);
    }
    // æ·»åŠ æ¶ˆæ¯åˆ°å¾®ä¿¡ç•Œé¢
    addMessageToWeChat(entry, index, isNewMessage = false) {
        const { id, sender, type } = entry;
        const messageRow = document.createElement('div');
        messageRow.className = 'message-row';
        if (index !== undefined)
            messageRow.dataset.logIndex = index.toString();
        messageRow.dataset.messageId = id;
        const senderClass = sender;
        messageRow.classList.add(senderClass);
        const avatarSrc = sender === 'me' ? this.avatars.user : this.avatars.char;
        const avatarImgHtml = `<img src="${avatarSrc}" class="message-avatar" />`;
        if (type === 'voice') {
            this.renderVoiceMessage(messageRow, entry, avatarImgHtml);
        }
        else {
            let bubbleContent = '';
            switch (type) {
                case 'sticker':
                    bubbleContent = this.renderStickerContent(entry);
                    break;
                case 'image':
                    bubbleContent = this.renderImageContent(entry);
                    break;
                case 'location':
                    bubbleContent = this.renderLocationContent(entry);
                    break;
                case 'transfer':
                    bubbleContent = this.renderTransferContent(entry);
                    break;
                case 'file':
                    bubbleContent = this.renderFileContent(entry);
                    break;
                case 'gift':
                    {
                        // åˆ¤æ–­æ˜¯çº¢åŒ…è¿˜æ˜¯ç¤¼ç‰©
                        const giftEntry = entry;
                        const isRedEnvelope = giftEntry.data.name.includes('çº¢åŒ…') ||
                            giftEntry.data.name.includes('å‹å²é’±') ||
                            giftEntry.data.name.includes('çº¢åˆ©');
                        if (isRedEnvelope) {
                            bubbleContent = this.renderRedEnvelopeContent(giftEntry);
                        }
                        else {
                            bubbleContent = this.renderGiftContent(giftEntry);
                        }
                    }
                    break;
                default:
                    bubbleContent = entry.content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    break;
            }
            // æ ¹æ®æ¶ˆæ¯ç±»å‹æ·»åŠ ç‰¹æ®Šçš„æ°”æ³¡ç±»
            let bubbleClass = 'message-bubble';
            if (type === 'sticker') {
                bubbleClass += ' sticker-bubble';
            }
            else if (type === 'image') {
                bubbleClass += ' image-desc-bubble';
            }
            else if (type === 'location') {
                bubbleClass += ' location-bubble';
            }
            else if (type === 'transfer') {
                bubbleClass += ' transfer-bubble';
            }
            else if (type === 'file') {
                bubbleClass += ' file-bubble';
            }
            else if (type === 'gift') {
                bubbleClass += ' gift-bubble';
            }
            messageRow.innerHTML =
                sender === 'me'
                    ? `<div class="${bubbleClass}">${bubbleContent}</div>${avatarImgHtml}`
                    : `${avatarImgHtml}<div class="${bubbleClass}">${bubbleContent}</div>`;
            const bubble = messageRow.querySelector('.message-bubble');
            if (bubble) {
                this.applyBubbleStyles(bubble, type, entry);
                this.setupBubbleInteractions(bubble, type, entry);
            }
        }
        if (isNewMessage) {
            messageRow.classList.add('new-message');
        }
        // ä¸ºUSERæ–‡å­—æ¶ˆæ¯æ·»åŠ é•¿æŒ‰æ’¤å›åŠŸèƒ½
        if (sender === 'me' && entry.type === 'message') {
            this.setupUserMessageLongPress(messageRow, entry);
        }
        this.wechatBody.appendChild(messageRow);
        this.scrollToBottom();
    }
    // æ¸²æŸ“è¯­éŸ³æ¶ˆæ¯
    renderVoiceMessage(messageRow, entry, avatarImgHtml) {
        const contentContainer = document.createElement('div');
        contentContainer.className = 'message-content-container';
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble voice-bubble';
        bubble.innerHTML = `<span class="duration">${entry.content.duration}"</span><i class="fas fa-wifi voice-icon"></i>`;
        const textRevealBox = document.createElement('div');
        textRevealBox.className = 'voice-text-content';
        textRevealBox.textContent = entry.content.text;
        contentContainer.appendChild(bubble);
        contentContainer.appendChild(textRevealBox);
        if (entry.sender === 'me') {
            messageRow.appendChild(contentContainer);
            messageRow.insertAdjacentHTML('beforeend', avatarImgHtml);
        }
        else {
            messageRow.insertAdjacentHTML('afterbegin', avatarImgHtml);
            messageRow.appendChild(contentContainer);
        }
        let longPressFired = false;
        const timerDuration = 500;
        let pressTimer;
        bubble.addEventListener('pointerdown', e => {
            if (e.pointerType === 'mouse' && e.button !== 0)
                return;
            longPressFired = false;
            pressTimer = window.setTimeout(() => {
                messageRow.classList.add('voice-text-visible');
                longPressFired = true;
            }, timerDuration);
        });
        bubble.addEventListener('pointerup', () => {
            clearTimeout(pressTimer);
            if (!longPressFired) {
                if (messageRow.classList.contains('voice-text-visible')) {
                    messageRow.classList.remove('voice-text-visible');
                }
            }
        });
        bubble.addEventListener('pointerleave', () => clearTimeout(pressTimer));
        bubble.addEventListener('contextmenu', e => e.preventDefault());
    }
    // æ¸²æŸ“è¡¨æƒ…åŒ…å†…å®¹
    renderStickerContent(entry) {
        const stickerUrl = this.options.findStickerUrlByName(entry.content);
        if (stickerUrl) {
            // ä½¿ç”¨çº¯HTMLåˆ›å»ºè¡¨æƒ…åŒ…å®¹å™¨å’Œå›¾ç‰‡
            return `<div class="sticker-container"><img src="${stickerUrl}" class="sticker-img" /></div>`;
        }
        else {
            return `<div class="sticker-placeholder">[è¡¨æƒ…]</div>`;
        }
    }
    // æ¸²æŸ“å›¾ç‰‡å†…å®¹
    renderImageContent(entry) {
        if (entry.content.type === 'url') {
            let imageUrl = entry.content.value;
            if (imageUrl.startsWith('blmx-img-')) {
                const storedImage = sessionStorage.getItem(imageUrl);
                if (storedImage) {
                    imageUrl = storedImage;
                }
                else {
                    return `<div class="image-desc-content"><div class="text-wrapper">[å›¾ç‰‡å·²è¿‡æœŸ]</div></div>`;
                }
            }
            return `<img src="${imageUrl}" class="chat-image" />`;
        }
        else {
            const descText = entry.content.value;
            return `<div class="image-desc-content"><div class="text-wrapper">${String(descText)
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')}</div></div>`;
        }
    }
    // æ¸²æŸ“ä½ç½®å†…å®¹
    renderLocationContent(entry) {
        return `<div class="location-card">
      <div class="location-content">
        <div class="location-title">${entry.content}</div>
        <div class="location-subtitle">å…±äº«å®æ—¶ä½ç½®</div>
      </div>
      <div class="location-map-placeholder"></div>
    </div>`;
    }
    // æ¸²æŸ“è½¬è´¦å†…å®¹
    renderTransferContent(entry) {
        const isReceipt = entry.data.status !== 'sent';
        const detailsHtml = isReceipt
            ? `<div class="status-text">${entry.data.status === 'accepted' ? 'å·²æ¥æ”¶' : 'å·²é€€è¿˜'}</div>`
            : `<div class="note">${entry.data.note || ' '}</div>`;
        const cardClass = isReceipt ? 'transfer-receipt' : 'transfer-initial';
        return `<div class="transfer-card ${cardClass}">
      <div class="transfer-content">
        <img src="https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E7%B4%A0%E6%9D%90/arrows.png" class="transfer-icon-image">
        <div class="transfer-details">
          <div class="amount">Â¥${entry.data.amount}</div>
          ${detailsHtml}
        </div>
      </div>
      <div class="transfer-footer">è½¬è´¦</div>
    </div>`;
    }
    // æ¸²æŸ“æ–‡ä»¶å†…å®¹
    renderFileContent(entry) {
        return `<div class="file-card">
      <div class="file-content">
        <i class="fas fa-file-alt file-icon"></i>
        <div class="file-details">
          <div class="file-name">${entry.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
        </div>
      </div>
      <div class="file-footer">æ–‡ä»¶</div>
    </div>`;
    }
    // æ¸²æŸ“ç¤¼ç‰©å†…å®¹
    renderGiftContent(entry) {
        let detailsClass = '';
        let detailsContent = '';
        const isReceipt = entry.data.status !== 'sent';
        const cardClass = isReceipt ? 'gift-receipt' : 'gift-initial';
        if (entry.data.status === 'sent') {
            if (entry.data.price) {
                detailsClass = 'gift-price';
                detailsContent = `Â¥ ${entry.data.price}`;
            }
        }
        else {
            detailsClass = 'gift-status-text';
            detailsContent = entry.data.status === 'accepted' ? 'å·²æ”¶ä¸‹' : 'å·²æ‹’æ”¶';
        }
        return `<div class="gift-card ${cardClass}">
      <div class="gift-content">
        <span class="gift-icon-emoji">ğŸ</span>
        <div class="gift-details">
          <div class="gift-name">${entry.data.name}</div>
          ${detailsContent ? `<div class="${detailsClass}">${detailsContent}</div>` : ''}
        </div>
      </div>
      <div class="gift-footer">ç¤¼ç‰©</div>
    </div>`;
    }
    // æ¸²æŸ“çº¢åŒ…å†…å®¹
    renderRedEnvelopeContent(entry) {
        let detailsClass = '';
        let detailsContent = '';
        const isReceipt = entry.data.status !== 'sent';
        const cardClass = isReceipt ? 'gift-receipt' : 'gift-initial';
        if (entry.data.status === 'sent') {
            if (entry.data.price) {
                detailsClass = 'gift-price';
                detailsContent = `Â¥ ${entry.data.price}`;
            }
        }
        else {
            detailsClass = 'gift-status-text';
            detailsContent = entry.data.status === 'accepted' ? 'å·²é¢†å–' : 'å·²æ‹’æ”¶';
        }
        return `<div class="gift-card ${cardClass}">
      <div class="gift-content">
        <img src="https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E7%B4%A0%E6%9D%90/red-envelope.png" class="gift-icon-image">
        <div class="gift-details">
          <div class="gift-name">${entry.data.name}</div>
          ${detailsContent ? `<div class="${detailsClass}">${detailsContent}</div>` : ''}
        </div>
      </div>
      <div class="gift-footer">çº¢åŒ…</div>
    </div>`;
    }
    // åº”ç”¨æ°”æ³¡æ ·å¼
    applyBubbleStyles(bubble, type, entry) {
        if (type === 'image') {
            if (entry.content.type === 'url') {
                bubble.classList.add('image-url-bubble');
            }
            else {
                bubble.classList.add('image-desc-bubble');
            }
        }
        else {
            const bubbleTypeMap = {
                sticker: 'sticker-bubble',
                location: 'location-bubble',
                transfer: 'transfer-bubble',
                file: 'file-bubble',
                gift: 'gift-bubble',
            };
            if (bubbleTypeMap[type]) {
                bubble.classList.add(bubbleTypeMap[type]);
            }
        }
    }
    // è®¾ç½®æ°”æ³¡äº¤äº’
    setupBubbleInteractions(bubble, type, entry) {
        if (type === 'transfer') {
            const transferCard = bubble.querySelector('.transfer-card');
            if (!transferCard)
                return;
            const transferEntry = entry;
            const isReceipt = transferEntry.data.status !== 'sent';
            if (!isReceipt && entry.sender === 'them') {
                transferCard.classList.add('them');
                transferCard.addEventListener('click', () => {
                    // ç›´æ¥æ¥æ”¶è½¬è´¦ï¼Œå› ä¸ºè½¬è´¦åŠŸèƒ½æœ¬èº«å·²ç»æœ‰è‡ªå®šä¹‰å¯¹è¯æ¡†
                    if (this.options.onTransferAccept) {
                        this.options.onTransferAccept({
                            ...transferEntry.data,
                            status: 'accepted',
                        });
                    }
                }, { once: true });
            }
        }
        if (type === 'gift') {
            const giftBubble = bubble;
            const giftCard = bubble.querySelector('.gift-card');
            const giftEntry = entry;
            const isReceipt = giftEntry.data.status !== 'sent';
            if (isReceipt) {
                // å·²ç»æ¥æ”¶æˆ–æ‹’æ”¶çš„ç¤¼ç‰©ï¼Œä¸éœ€è¦æ·»åŠ ç‚¹å‡»äº‹ä»¶
                return;
            }
            // ä¸ºæ‰€æœ‰æœªå¤„ç†çš„ç¤¼ç‰©æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ— è®ºæ˜¯ç”¨æˆ·è¿˜æ˜¯AIå‘é€çš„
            if (giftCard)
                giftCard.classList.add(entry.sender === 'them' ? 'them' : 'me');
            giftBubble.classList.add('gift-clickable');
            giftBubble.addEventListener('click', async () => {
                if (this.options.onGiftAction) {
                    await this.options.onGiftAction(giftEntry.data);
                }
                giftBubble.classList.remove('gift-clickable');
            }, { once: true });
        }
    }
    // æ·»åŠ æ—¶é—´æˆ³åˆ°å¾®ä¿¡ç•Œé¢
    addTimestampToWeChat(date, time, isSystemTime, index) {
        const timeText = this.formatMomentTimestamp(date, time);
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ—¶é—´æˆ³
        // å¦‚æœæ˜¯ç³»ç»Ÿæ—¶é—´ï¼ˆè€Œä¸æ˜¯ç”¨æˆ·æ‰‹åŠ¨æ’å…¥çš„æ—¶é—´ï¼‰
        if (isSystemTime) {
            // åªæœ‰çº¯æ—¶é—´ï¼ˆä»Šå¤©çš„æ¶ˆæ¯ï¼‰æ‰éœ€è¦è¿›è¡Œ10åˆ†é’Ÿè¿‡æ»¤
            const isOnlyTime = timeText === time;
            if (isOnlyTime) {
                // å¯¹äºä»Šå¤©çš„æ¶ˆæ¯ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ä¸Šä¸€æ¡æ—¶é—´æˆ³å¤ªæ¥è¿‘
                const timeInMinutes = this.parseTimeToMinutes(timeText);
                if (timeInMinutes !== null && timeInMinutes - this.lastDisplayedTimeInMinutes < 10) {
                    return; // è·³è¿‡æ˜¾ç¤ºè¿™ä¸ªæ—¶é—´æˆ³
                }
                // æ›´æ–°æœ€åæ˜¾ç¤ºçš„æ—¶é—´
                if (timeInMinutes !== null) {
                    this.lastDisplayedTimeInMinutes = timeInMinutes;
                }
            }
            else {
                // å¯¹äºæ˜¨å¤©æˆ–æ›´æ—©çš„æ¶ˆæ¯ï¼Œæ€»æ˜¯æ˜¾ç¤ºå¹¶é‡ç½®æ—¶é—´è®¡æ•°å™¨
                this.lastDisplayedTimeInMinutes = -Infinity;
            }
        }
        // åˆ›å»ºå¹¶æ·»åŠ æ—¶é—´æˆ³å…ƒç´ 
        const t = document.createElement('div');
        t.className = 'timestamp-row';
        if (index !== undefined)
            t.dataset.logIndex = index.toString();
        // å­˜å‚¨åŸå§‹æ—¥æœŸå’Œæ—¶é—´ç”¨äºåˆ·æ–°
        t.dataset.originalDate = date;
        t.dataset.originalTime = time;
        t.innerHTML = `<span class="timestamp-text">${timeText}</span>`;
        this.wechatBody.appendChild(t);
        this.scrollToBottom();
    }
    // æ·»åŠ äº‹ä»¶æ—¥å¿—åˆ°å¾®ä¿¡ç•Œé¢
    addEventLogToWeChat(eventData, index) {
        // ç¡®ä¿eventDataå…·æœ‰å¿…è¦çš„å­—æ®µ
        if (!eventData || !eventData.date || !eventData.time) {
            console.error('äº‹ä»¶æ—¥å¿—æ•°æ®ä¸å®Œæ•´:', eventData);
            return;
        }
        // è·å–æ ¼å¼åŒ–åçš„æ—¶é—´æ–‡æœ¬ï¼ŒåŒ…å«æ—¥æœŸä¿¡æ¯
        const timeText = this.formatMomentTimestamp(eventData.date, eventData.time);
        // åˆ›å»ºäº‹ä»¶æ—¥å¿—è¡Œ
        const row = document.createElement('div');
        row.className = 'event-log-row';
        if (index !== undefined)
            row.dataset.logIndex = index.toString();
        // å­˜å‚¨åŸå§‹æ—¥æœŸå’Œæ—¶é—´ç”¨äºåˆ·æ–°
        row.dataset.originalDate = eventData.date;
        row.dataset.originalTime = eventData.time;
        // å¦‚æœæ²¡æœ‰æè¿°ï¼Œåªæ˜¾ç¤ºæ—¶é—´ï¼›å¦‚æœæœ‰æè¿°ï¼Œæ˜¾ç¤ºæ—¶é—´å’Œæè¿°
        if (eventData.description) {
            row.innerHTML = `
        <div class="event-log-container">
          <div class="event-time-text has-desc clickable">${timeText}</div>
          <div class="event-description">${eventData.description}</div>
        </div>
      `;
        }
        else {
            row.innerHTML = `
        <div class="event-log-container">
          <div class="event-time-text">${timeText}</div>
        </div>
      `;
        }
        // ä¸ºå¸¦æœ‰æè¿°çš„äº‹ä»¶æ·»åŠ ç‚¹å‡»å±•å¼€åŠŸèƒ½
        if (eventData.description) {
            const timeEl = row.querySelector('.event-time-text');
            const descEl = row.querySelector('.event-description');
            if (timeEl && descEl) {
                timeEl.addEventListener('click', () => {
                    // åªä½¿ç”¨CSSç±»æ¥æ§åˆ¶æ˜¾ç¤º/éšè—ï¼Œä¸æ‰‹åŠ¨è®¾ç½®displayå±æ€§
                    descEl.classList.toggle('expanded');
                });
            }
        }
        // æ·»åŠ åˆ°èŠå¤©ç•Œé¢å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
        this.wechatBody.appendChild(row);
        this.scrollToBottom();
    }
    // æ¸²æŸ“ç³»ç»Ÿæ¶ˆæ¯
    renderSystemMessage(entry, animate = false, index) {
        const chatContainer = this.wechatBody;
        if (!chatContainer)
            return;
        const systemRow = document.createElement('div');
        systemRow.className = 'event-log-row';
        if (animate)
            systemRow.classList.add('new-message');
        if (entry.id) {
            systemRow.dataset.messageId = entry.id;
        }
        if (index !== undefined) {
            systemRow.dataset.logIndex = index.toString();
        }
        const systemContainer = document.createElement('div');
        systemContainer.className = 'event-log-container';
        const systemText = document.createElement('div');
        systemText.className = 'event-time-text system-message';
        systemText.textContent = entry.content;
        systemContainer.appendChild(systemText);
        systemRow.appendChild(systemContainer);
        chatContainer.appendChild(systemRow);
        this.scrollToBottom();
    }
    // è§£ææ—¶é—´ä¸ºåˆ†é’Ÿæ•°
    parseTimeToMinutes(timeString) {
        const match = timeString.match(/(\d{1,2}):(\d{2})/);
        return match ? 60 * parseInt(match[1], 10) + parseInt(match[2], 10) : null;
    }
    // æ ¼å¼åŒ–æ—¶é—´æˆ³
    formatMomentTimestamp(dateString, timeString) {
        if (!dateString || !timeString)
            return ' ';
        try {
            // è§£ææ—¥æœŸå’Œå½“å‰æ—¥æœŸ
            const postDate = new Date(dateString);
            // ç¡®ä¿æˆ‘ä»¬ä½¿ç”¨æ¸¸æˆæ—¶é—´è€Œéç°å®æ—¶é—´
            const currentDate = window.currentGameDate ? new Date(window.currentGameDate) : new Date();
            // æå–å¹´æœˆæ—¥
            const postYear = postDate.getFullYear();
            const postMonth = postDate.getMonth();
            const postDay = postDate.getDate();
            const nowYear = currentDate.getFullYear();
            const nowMonth = currentDate.getMonth();
            const nowDay = currentDate.getDate();
            // åˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©çš„æ¶ˆæ¯
            if (postYear === nowYear && postMonth === nowMonth && postDay === nowDay) {
                return timeString;
            }
            // åˆ›å»ºæ˜¨å¤©çš„æ—¥æœŸå¯¹è±¡
            const yesterday = new Date(currentDate);
            yesterday.setDate(currentDate.getDate() - 1);
            const yesterdayYear = yesterday.getFullYear();
            const yesterdayMonth = yesterday.getMonth();
            const yesterdayDay = yesterday.getDate();
            // åˆ¤æ–­æ˜¯å¦æ˜¯æ˜¨å¤©çš„æ¶ˆæ¯
            if (postYear === yesterdayYear && postMonth === yesterdayMonth && postDay === yesterdayDay) {
                return `æ˜¨å¤© ${timeString}`;
            }
            // åˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¹´çš„æ¶ˆæ¯
            if (postYear === nowYear) {
                return `${postMonth + 1}æœˆ${postDay}æ—¥ ${timeString}`;
            }
            // å…¶ä»–æƒ…å†µæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
            return `${postYear}å¹´${postMonth + 1}æœˆ${postDay}æ—¥ ${timeString}`;
        }
        catch (error) {
            console.error('Error formatting timestamp:', error);
            return timeString; // å‡ºé”™æ—¶è‡³å°‘è¿”å›æ—¶é—´
        }
    }
    // åˆ·æ–°æ‰€æœ‰æ—¶é—´æˆ³æ˜¾ç¤º
    refreshAllTimestamps() {
        // åˆ·æ–°æ‰€æœ‰æ—¶é—´æˆ³
        const timestampRows = $('.timestamp-row', this.wechatBody);
        const eventLogRows = $('.event-log-row', this.wechatBody);
        // åˆ·æ–°æ—¶é—´æˆ³è¡Œ
        timestampRows.each((_, row) => {
            const $row = $(row);
            const $timestampText = $row.find('.timestamp-text');
            if ($timestampText.length) {
                const originalDate = $row.data('originalDate');
                const originalTime = $row.data('originalTime');
                if (originalDate && originalTime) {
                    $timestampText.text(this.formatMomentTimestamp(originalDate, originalTime));
                }
            }
        });
        // åˆ·æ–°äº‹ä»¶æ—¥å¿—è¡Œ
        eventLogRows.each((_, row) => {
            const $row = $(row);
            const $eventTimeText = $row.find('.event-time-text');
            if ($eventTimeText.length) {
                const originalDate = $row.data('originalDate');
                const originalTime = $row.data('originalTime');
                if (originalDate && originalTime) {
                    // æ›´æ–°æ–‡æœ¬å†…å®¹
                    $eventTimeText.text(this.formatMomentTimestamp(originalDate, originalTime));
                }
            }
        });
    }
    renderFeatureGrid(gridElement, features, callbacks) {
        if (!gridElement) {
            console.error('[BLMX] Grid element not found for renderFeatureGrid');
            return;
        }
        gridElement.innerHTML = '';
        const isDeleteMode = gridElement.classList.contains('sticker-delete-mode');
        features.forEach(feature => {
            const item = document.createElement('div');
            item.className = 'feature-item';
            let iconHtml = '';
            if (feature.isAddBtn) {
                // å¦‚æœæ˜¯è¡¨æƒ…ç®¡ç†æŒ‰é’®ï¼Œä½¿ç”¨é½¿è½®å›¾æ ‡
                if (feature.label === 'è¡¨æƒ…ç®¡ç†') {
                    iconHtml = `<div class="feature-icon"><i class="fas fa-cog"></i></div>`;
                }
                else {
                    iconHtml = `<div class="feature-icon"><i class="fas fa-${feature.label === 'æ·»åŠ ' ? 'plus' : 'trash-alt'}"></i></div>`;
                }
            }
            else if (feature.icon && feature.icon.startsWith('http')) {
                // å¤„ç†å›¾ç‰‡URL (è¡¨æƒ…åŒ…)
                iconHtml = `<div class="feature-icon"><img src="${feature.icon}" alt="${feature.label}" class="feature-icon-img"></div>`;
            }
            else if (feature.icon &&
                (feature.icon.startsWith('fas ') || feature.icon.startsWith('far ') || feature.icon.startsWith('fab '))) {
                // å¤„ç†å¸¦ç©ºæ ¼çš„Font Awesomeå›¾æ ‡
                iconHtml = `<div class="feature-icon"><i class="${feature.icon} theme-icon"></i></div>`;
            }
            else if (feature.icon && feature.icon.startsWith('fa')) {
                // å¤„ç†ä¸å¸¦ç©ºæ ¼çš„Font Awesomeå›¾æ ‡
                iconHtml = `<div class="feature-icon"><i class="${feature.icon} theme-icon"></i></div>`;
            }
            else {
                // å¤„ç†å…¶ä»–å›¾æ ‡ç±»å‹
                iconHtml = `<div class="feature-icon"><i class="${feature.icon || 'fas fa-question'}"></i></div>`;
            }
            item.innerHTML = `${iconHtml}<span class="feature-label">${feature.label}</span>`;
            const iconContainer = item.querySelector('.feature-icon');
            if (isDeleteMode && !feature.isAddBtn && !feature.isDefault) {
                // åˆ›å»ºéšè—çš„åŸç”Ÿcheckbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'sticker-checkbox';
                checkbox.dataset.stickerLabel = feature.label;
                item.appendChild(checkbox);
                // åˆ›å»ºå¯è§çš„checkboxæŒ‰é’®
                const checkboxButton = document.createElement('div');
                checkboxButton.className = 'sticker-checkbox-button';
                checkboxButton.style.display = 'block';
                item.appendChild(checkboxButton);
                // æ›´æ–°checkboxæŒ‰é’®çŠ¶æ€
                const updateCheckboxState = (checked) => {
                    if (checked) {
                        checkboxButton.classList.add('checked');
                    }
                    else {
                        checkboxButton.classList.remove('checked');
                    }
                    iconContainer?.classList.toggle('selected-for-delete', checked);
                };
                // ç‚¹å‡»äº‹ä»¶
                const handleClick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    checkbox.checked = !checkbox.checked;
                    updateCheckboxState(checkbox.checked);
                };
                item.addEventListener('click', handleClick);
                checkboxButton.addEventListener('click', handleClick);
                // è®¾ç½®åˆå§‹çŠ¶æ€
                updateCheckboxState(checkbox.checked);
            }
            else if (feature.label === 'æ·»åŠ ') {
                item.addEventListener('click', callbacks.onAddStickers);
            }
            else if (feature.label === 'åˆ é™¤' || feature.label === 'è¡¨æƒ…ç®¡ç†') {
                item.addEventListener('click', callbacks.onToggleDeleteMode);
            }
            else {
                item.addEventListener('click', feature.action);
            }
            gridElement.appendChild(item);
        });
    }
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom() {
        // ç›´æ¥è®¾ç½®scrollTopï¼Œé¿å…jQueryåŠ¨ç”»å¯èƒ½å¯¼è‡´çš„æ»šåŠ¨é”å®šé—®é¢˜
        this.wechatBody.scrollTop = this.wechatBody.scrollHeight;
        // æ·»åŠ ä¸€ä¸ªå»¶è¿Ÿæ‰§è¡Œçš„å¤‡ä»½æ»šåŠ¨ï¼Œç¡®ä¿åœ¨DOMå®Œå…¨æ¸²æŸ“åæ»šåŠ¨ç”Ÿæ•ˆ
        setTimeout(() => {
            this.wechatBody.scrollTop = this.wechatBody.scrollHeight;
        }, 100);
    }
    // ä¸ºUSERæ¶ˆæ¯è®¾ç½®é•¿æŒ‰æ’¤å›åŠŸèƒ½ - å®Œå…¨ç…§æŠ„åŸç‰ˆé€»è¾‘
    setupUserMessageLongPress(messageRow, entry) {
        const $messageRow = $(messageRow);
        const $messageBubble = $messageRow.find('.message-bubble');
        const $targetElement = $messageBubble.length ? $messageBubble : $messageRow;
        // åŸç‰ˆé•¿æŒ‰ç›‘å¬å™¨å®ç°
        this.addLongPressListener($targetElement[0], () => {
            this.handleLongPressRecall(entry);
        });
        // æ·»åŠ åŒå‡»æ’¤å›åŠŸèƒ½ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼ˆç‰¹åˆ«æ˜¯åœ¨å…¨å±æ¨¡å¼ä¸‹é•¿æŒ‰å¯èƒ½å¤±æ•ˆæ—¶ï¼‰
        this.setupDoubleClickRecall($targetElement, entry);
    }
    // åŸç‰ˆé•¿æŒ‰ç›‘å¬å™¨å®ç° - å®Œå…¨ç…§æŠ„åŸç‰ˆé€»è¾‘
    addLongPressListener(element, callback, options = { duration: 600, preventDefault: true }) {
        let timer;
        let startX, startY;
        const onStart = (e) => {
            if (e.pointerType === 'mouse' && e.button !== 0)
                return;
            startX = e.clientX;
            startY = e.clientY;
            if (options.preventDefault)
                e.preventDefault();
            clearTimeout(timer);
            timer = setTimeout(() => {
                timer = 0;
                callback();
            }, options.duration);
        };
        const onMove = (e) => {
            if (!timer)
                return;
            const moveX = e.clientX;
            const moveY = e.clientY;
            if (Math.abs(moveX - startX) > 10 || Math.abs(moveY - startY) > 10) {
                clearTimeout(timer);
            }
        };
        const onEnd = () => clearTimeout(timer);
        element.addEventListener('pointerdown', onStart);
        element.addEventListener('pointermove', onMove);
        element.addEventListener('pointerup', onEnd);
        element.addEventListener('pointerleave', onEnd);
        if (options.preventDefault) {
            element.addEventListener('contextmenu', e => e.preventDefault());
        }
    }
    // å¤„ç†é•¿æŒ‰æ’¤å› - å…ˆæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å¯ä»¥æ’¤å›
    async handleLongPressRecall(entry) {
        try {
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å¯ä»¥æ’¤å›
            if (this.options.isMessageInQueue && this.options.isMessageInQueue(entry.id)) {
                await this.handleUserMessageRecall(entry);
            }
            else {
                // ä½¿ç”¨jQuery UIçš„æ•ˆæœæ˜¾ç¤ºæ— æ³•æ’¤å›
                const $messageElement = $(`[data-message-id="${entry.id}"]`);
                $messageElement.effect('shake', { times: 2, distance: 5 }, 300);
                const { DialogManager } = await Promise.resolve(/* import() */).then(__webpack_require__.bind(__webpack_require__, 895));
                const dialogManager = DialogManager.getInstance();
                await dialogManager.alert('æ¶ˆæ¯å·²åˆå¹¶å‘é€ï¼Œæ— æ³•æ’¤å›ã€‚', 'æ— æ³•æ’¤å›');
            }
        }
        catch (error) {
            console.error('é•¿æŒ‰æ’¤å›å¤±è´¥:', error);
            // æ˜¾ç¤ºé”™è¯¯åé¦ˆ
            const $messageElement = $(`[data-message-id="${entry.id}"]`);
            $messageElement.effect('shake', { times: 2, distance: 5 }, 300);
        }
    }
    // å¤„ç†USERæ¶ˆæ¯æ’¤å›
    async handleUserMessageRecall(entry) {
        try {
            // å¯¼å…¥DialogManager
            const { DialogManager } = await Promise.resolve(/* import() */).then(__webpack_require__.bind(__webpack_require__, 895));
            const dialogManager = DialogManager.getInstance();
            // ç¡®è®¤æ’¤å›æ“ä½œ
            const confirmed = await dialogManager.confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ–‡å­—æ¶ˆæ¯å—ï¼Ÿæ’¤å›åå¯¹æ–¹å°†çœ‹åˆ°"ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"ã€‚', 'æ’¤å›æ–‡å­—æ¶ˆæ¯', 'æ’¤å›', 'å–æ¶ˆ');
            if (confirmed) {
                // è°ƒç”¨æ’¤å›åŠŸèƒ½
                if (this.options.onRecallMessage) {
                    await this.options.onRecallMessage(entry);
                }
            }
        }
        catch (error) {
            console.error('æ’¤å›æ¶ˆæ¯æ—¶å‡ºé”™:', error);
        }
    }
    // è®¾ç½®åŒå‡»æ’¤å›åŠŸèƒ½ - ä½œä¸ºé•¿æŒ‰æ’¤å›çš„å¤‡ç”¨æ–¹æ¡ˆ
    setupDoubleClickRecall($targetElement, entry) {
        let clickCount = 0;
        let clickTimer;
        const doubleClickDelay = 300; // 300mså†…çš„ä¸¤æ¬¡ç‚¹å‡»è§†ä¸ºåŒå‡»
        $targetElement.on('click.doubleClickRecall', e => {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å¹²æ‰°å…¶ä»–ç‚¹å‡»äº‹ä»¶
            e.stopPropagation();
            clickCount++;
            if (clickCount === 1) {
                // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œå¯åŠ¨å®šæ—¶å™¨
                clickTimer = window.setTimeout(() => {
                    // è¶…æ—¶åé‡ç½®ç‚¹å‡»è®¡æ•°
                    clickCount = 0;
                }, doubleClickDelay);
            }
            else if (clickCount === 2) {
                // åŒå‡»æ£€æµ‹åˆ°ï¼Œæ¸…é™¤å®šæ—¶å™¨å¹¶æ‰§è¡Œæ’¤å›
                clearTimeout(clickTimer);
                clickCount = 0;
                // æ·»åŠ è§†è§‰åé¦ˆ
                $targetElement.addClass('double-click-active');
                setTimeout(() => {
                    $targetElement.removeClass('double-click-active');
                }, 200);
                // æ·»åŠ è§¦è§‰åé¦ˆï¼ˆç§»åŠ¨ç«¯ï¼‰
                if ('vibrate' in navigator) {
                    navigator.vibrate([30, 50, 30]); // åŒå‡»æŒ¯åŠ¨æ¨¡å¼
                }
                // æ‰§è¡Œæ’¤å›æ“ä½œ
                this.handleDoubleClickRecall(entry);
            }
        });
    }
    // å¤„ç†åŒå‡»æ’¤å›
    async handleDoubleClickRecall(entry) {
        try {
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å¯ä»¥æ’¤å›
            if (this.options.isMessageInQueue && this.options.isMessageInQueue(entry.id)) {
                await this.handleUserMessageRecall(entry);
            }
            else {
                // ä½¿ç”¨jQuery UIçš„æ•ˆæœæ˜¾ç¤ºæ— æ³•æ’¤å›
                const $messageElement = $(`[data-message-id="${entry.id}"]`);
                $messageElement.effect('shake', { times: 2, distance: 5 }, 300);
                const { DialogManager } = await Promise.resolve(/* import() */).then(__webpack_require__.bind(__webpack_require__, 895));
                const dialogManager = DialogManager.getInstance();
                await dialogManager.alert('æ¶ˆæ¯å·²åˆå¹¶å‘é€ï¼Œæ— æ³•æ’¤å›ã€‚', 'æ— æ³•æ’¤å›');
            }
        }
        catch (error) {
            console.error('åŒå‡»æ’¤å›å¤±è´¥:', error);
            // æ˜¾ç¤ºé”™è¯¯åé¦ˆ
            const $messageElement = $(`[data-message-id="${entry.id}"]`);
            $messageElement.effect('shake', { times: 2, distance: 5 }, 300);
        }
    }
    /**
     * æ¸…ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
     */
    cleanup() {
        this.eventManager.cleanup();
    }
}

;// ./src/åŒå±‚æ‰‹æœº/wallpaper-selector.ts
// å£çº¸é€‰æ‹©å™¨æ¨¡å—
// è´Ÿè´£å£çº¸é€‰æ‹©å™¨UIçš„åˆ›å»ºå’Œç®¡ç†
class WallpaperSelector {
    wallpaperManager;
    themeManager; // ä¸»é¢˜ç®¡ç†å™¨å¼•ç”¨
    constructor(wallpaperManager, themeManager) {
        this.wallpaperManager = wallpaperManager;
        this.themeManager = themeManager;
    }
    // æ˜¾ç¤ºå£çº¸é€‰æ‹©å™¨
    showWallpaperSelector(viewType, onApplyWallpaper) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'wallpaper-modal';
        modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    `;
        // åˆ›å»ºå†…å®¹å®¹å™¨
        const container = document.createElement('div');
        container.className = 'wallpaper-container';
        container.style.cssText = `
      background-color: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    `;
        // æ ‡é¢˜
        const title = document.createElement('h2');
        title.textContent = `é€‰æ‹©${viewType === 'chat' ? 'èŠå¤©' : viewType === 'home' ? 'ä¸»å±å¹•' : 'è®¾ç½®'}å£çº¸`;
        title.style.cssText = `
      margin-top: 0;
      color: var(--text-primary);
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 20px;
    `;
        container.appendChild(title);
        // åˆ›å»ºé€‰é¡¹å¡
        const tabs = this.createTabs(container);
        container.appendChild(tabs);
        // åˆ›å»ºå„ä¸ªé€‰é¡¹å¡å†…å®¹
        this.createBuiltinWallpaperTab(container, viewType, modal, onApplyWallpaper);
        this.createSolidColorTab(container, viewType, modal, onApplyWallpaper);
        this.createCustomWallpaperTab(container, viewType, modal, onApplyWallpaper);
        this.createUploadTab(container, viewType, modal, onApplyWallpaper);
        // åˆ›å»ºåº•éƒ¨æŒ‰é’®
        this.createBottomButtons(container, viewType, modal, onApplyWallpaper);
        modal.appendChild(container);
        document.body.appendChild(modal);
    }
    // åˆ›å»ºé€‰é¡¹å¡
    createTabs(container) {
        const tabs = document.createElement('div');
        tabs.style.cssText = `
      display: flex;
      border-bottom: 1px solid ${document.body.classList.contains('dark-mode') ? '#3c3c3c' : '#eee'};
      margin-bottom: 15px;
    `;
        const createTab = (label, id, isActive = false) => {
            const tab = document.createElement('div');
            tab.textContent = label;
            tab.dataset.tabId = id;
            tab.style.cssText = `
        padding: 10px 15px;
        cursor: pointer;
        font-weight: ${isActive ? 'bold' : 'normal'};
        color: ${isActive ? 'var(--primary-blue)' : 'var(--text-secondary)'};
        border-bottom: ${isActive ? '2px solid var(--primary-blue)' : 'none'};
        margin-bottom: -1px;
      `;
            tab.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                tabs.querySelectorAll('div').forEach(t => {
                    t.style.fontWeight = 'normal';
                    t.style.color = 'var(--text-secondary)';
                    t.style.borderBottom = 'none';
                });
                // è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºæ´»åŠ¨çŠ¶æ€
                tab.style.fontWeight = 'bold';
                tab.style.color = 'var(--primary-blue)';
                tab.style.borderBottom = '2px solid var(--primary-blue)';
                // éšè—æ‰€æœ‰å†…å®¹
                container.querySelectorAll('.tab-content').forEach(c => {
                    c.style.display = 'none';
                });
                // æ˜¾ç¤ºé€‰å®šçš„å†…å®¹
                const content = container.querySelector(`.tab-content[data-tab-id="${id}"]`);
                if (content) {
                    content.style.display = 'block';
                }
            });
            return tab;
        };
        tabs.appendChild(createTab('å†…ç½®å£çº¸', 'builtin', true));
        tabs.appendChild(createTab('çº¯è‰²å£çº¸', 'solid'));
        tabs.appendChild(createTab('è‡ªå®šä¹‰å£çº¸', 'custom'));
        tabs.appendChild(createTab('ä¸Šä¼ å£çº¸', 'upload'));
        return tabs;
    }
    // åˆ›å»ºå†…ç½®å£çº¸é€‰é¡¹å¡
    createBuiltinWallpaperTab(container, viewType, modal, onApplyWallpaper) {
        const builtinContent = document.createElement('div');
        builtinContent.className = 'tab-content';
        builtinContent.dataset.tabId = 'builtin';
        builtinContent.style.cssText = 'display: block;';
        // è·å–å†…ç½®å£çº¸
        const builtinWallpapers = this.wallpaperManager.getBuiltInWallpapers().filter(w => w.type === 'image');
        // åˆ›å»ºå£çº¸ç½‘æ ¼
        const builtinGrid = document.createElement('div');
        builtinGrid.style.cssText = `
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    `;
        builtinWallpapers.forEach(wallpaper => {
            const wallpaperItem = this.createWallpaperItem(wallpaper, viewType, false, modal, onApplyWallpaper);
            builtinGrid.appendChild(wallpaperItem);
        });
        builtinContent.appendChild(builtinGrid);
        container.appendChild(builtinContent);
    }
    // åˆ›å»ºçº¯è‰²å£çº¸é€‰é¡¹å¡
    createSolidColorTab(container, viewType, modal, onApplyWallpaper) {
        const solidContent = document.createElement('div');
        solidContent.className = 'tab-content';
        solidContent.dataset.tabId = 'solid';
        solidContent.style.cssText = 'display: none;';
        // è·å–çº¯è‰²å£çº¸
        const solidWallpapers = this.wallpaperManager.getBuiltInWallpapers().filter(w => w.type === 'color');
        // åˆ›å»ºå£çº¸ç½‘æ ¼
        const solidGrid = document.createElement('div');
        solidGrid.style.cssText = `
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    `;
        solidWallpapers.forEach(wallpaper => {
            const wallpaperItem = this.createWallpaperItem(wallpaper, viewType, false, modal, onApplyWallpaper);
            solidGrid.appendChild(wallpaperItem);
        });
        solidContent.appendChild(solidGrid);
        // æ·»åŠ é¢œè‰²é€‰æ‹©å™¨
        this.addColorPicker(solidContent, viewType, modal, onApplyWallpaper);
        container.appendChild(solidContent);
    }
    // åˆ›å»ºè‡ªå®šä¹‰å£çº¸é€‰é¡¹å¡
    createCustomWallpaperTab(container, viewType, modal, onApplyWallpaper) {
        const customContent = document.createElement('div');
        customContent.className = 'tab-content';
        customContent.dataset.tabId = 'custom';
        customContent.style.cssText = 'display: none;';
        // è·å–è‡ªå®šä¹‰å£çº¸
        const customWallpapers = this.wallpaperManager.getCustomWallpapers();
        if (customWallpapers.length === 0) {
            const noCustomWallpapers = document.createElement('p');
            noCustomWallpapers.textContent = 'æ²¡æœ‰è‡ªå®šä¹‰å£çº¸ã€‚è¯·åœ¨"ä¸Šä¼ å£çº¸"é€‰é¡¹å¡ä¸­æ·»åŠ ã€‚';
            noCustomWallpapers.style.cssText = `
        text-align: center;
        color: var(--text-secondary);
        margin: 30px 0;
      `;
            customContent.appendChild(noCustomWallpapers);
        }
        else {
            // åˆ›å»ºå£çº¸ç½‘æ ¼
            const customGrid = document.createElement('div');
            customGrid.style.cssText = `
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      `;
            customWallpapers.forEach(wallpaper => {
                const wallpaperItem = this.createWallpaperItem(wallpaper, viewType, true, modal, onApplyWallpaper);
                customGrid.appendChild(wallpaperItem);
            });
            customContent.appendChild(customGrid);
        }
        container.appendChild(customContent);
    }
    // åˆ›å»ºä¸Šä¼ é€‰é¡¹å¡
    createUploadTab(container, viewType, modal, onApplyWallpaper) {
        const uploadContent = document.createElement('div');
        uploadContent.className = 'tab-content';
        uploadContent.dataset.tabId = 'upload';
        uploadContent.style.cssText = 'display: none; padding: 10px 0;';
        // ä»æœ¬åœ°ä¸Šä¼ éƒ¨åˆ†
        this.createLocalUploadSection(uploadContent, viewType, modal, onApplyWallpaper);
        // ä»URLæ·»åŠ éƒ¨åˆ†
        this.createUrlUploadSection(uploadContent, viewType, modal, onApplyWallpaper);
        container.appendChild(uploadContent);
    }
    // æ·»åŠ é¢œè‰²é€‰æ‹©å™¨
    addColorPicker(solidContent, viewType, modal, onApplyWallpaper) {
        const colorPickerContainer = document.createElement('div');
        colorPickerContainer.style.cssText = `
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid ${document.body.classList.contains('dark-mode') ? '#3c3c3c' : '#eee'};
    `;
        const colorPickerLabel = document.createElement('p');
        colorPickerLabel.textContent = 'è‡ªå®šä¹‰é¢œè‰²:';
        colorPickerLabel.style.cssText = `
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      color: var(--text-primary);
    `;
        const colorPicker = document.createElement('input');
        colorPicker.type = 'color';
        colorPicker.value = '#ffffff';
        colorPicker.style.cssText = `
      width: 100%;
      height: 40px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    `;
        const colorNameInput = document.createElement('input');
        colorNameInput.type = 'text';
        colorNameInput.placeholder = 'é¢œè‰²åç§° (å¯é€‰)';
        colorNameInput.style.cssText = `
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    `;
        const addColorBtn = document.createElement('button');
        addColorBtn.textContent = 'æ·»åŠ æ­¤é¢œè‰²';
        addColorBtn.style.cssText = `
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    `;
        addColorBtn.addEventListener('click', () => {
            const color = colorPicker.value;
            const name = colorNameInput.value.trim() || `é¢œè‰² ${color}`;
            const newWallpaper = this.wallpaperManager.createSolidColorWallpaper(color, name);
            if (newWallpaper) {
                // åº”ç”¨æ–°å£çº¸
                this.wallpaperManager.setWallpaper(viewType, newWallpaper);
                onApplyWallpaper();
                // å…³é—­æ¨¡æ€æ¡†
                document.body.removeChild(modal);
            }
            else {
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                alert('åˆ›å»ºçº¯è‰²å£çº¸å¤±è´¥ï¼Œè¯·ç¡®ä¿é¢œè‰²æ ¼å¼æ­£ç¡®ã€‚');
            }
        });
        colorPickerContainer.appendChild(colorPickerLabel);
        colorPickerContainer.appendChild(colorPicker);
        colorPickerContainer.appendChild(colorNameInput);
        colorPickerContainer.appendChild(addColorBtn);
        solidContent.appendChild(colorPickerContainer);
    }
    // åˆ›å»ºæœ¬åœ°ä¸Šä¼ éƒ¨åˆ†
    createLocalUploadSection(uploadContent, viewType, modal, onApplyWallpaper) {
        const localUploadSection = document.createElement('div');
        localUploadSection.style.cssText = 'margin-bottom: 20px;';
        const localUploadTitle = document.createElement('h3');
        localUploadTitle.textContent = 'ä»æœ¬åœ°ä¸Šä¼ ';
        localUploadTitle.style.cssText = `
      font-size: 1rem;
      color: var(--text-primary);
      margin: 0 0 10px 0;
    `;
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.cssText = `
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    `;
        const uploadBtn = document.createElement('button');
        uploadBtn.textContent = 'ä¸Šä¼ å¹¶åº”ç”¨';
        uploadBtn.style.cssText = `
      width: 100%;
      padding: 10px;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    `;
        uploadBtn.addEventListener('click', async () => {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const newWallpaper = await this.wallpaperManager.createWallpaperFromFile(file);
                if (newWallpaper) {
                    // åº”ç”¨æ–°å£çº¸
                    this.wallpaperManager.setWallpaper(viewType, newWallpaper);
                    onApplyWallpaper();
                    // å…³é—­æ¨¡æ€æ¡†
                    document.body.removeChild(modal);
                }
            }
        });
        localUploadSection.appendChild(localUploadTitle);
        localUploadSection.appendChild(fileInput);
        localUploadSection.appendChild(uploadBtn);
        uploadContent.appendChild(localUploadSection);
    }
    // åˆ›å»ºURLä¸Šä¼ éƒ¨åˆ†
    createUrlUploadSection(uploadContent, viewType, modal, onApplyWallpaper) {
        const urlUploadSection = document.createElement('div');
        urlUploadSection.style.cssText = `
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid ${document.body.classList.contains('dark-mode') ? '#3c3c3c' : '#eee'};
    `;
        const urlUploadTitle = document.createElement('h3');
        urlUploadTitle.textContent = 'ä»URLæ·»åŠ ';
        urlUploadTitle.style.cssText = `
      font-size: 1rem;
      color: var(--text-primary);
      margin: 0 0 10px 0;
    `;
        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.placeholder = 'è¾“å…¥å›¾ç‰‡URL';
        urlInput.style.cssText = `
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    `;
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'å£çº¸åç§° (å¯é€‰)';
        nameInput.style.cssText = `
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    `;
        const addUrlBtn = document.createElement('button');
        addUrlBtn.textContent = 'æ·»åŠ å¹¶åº”ç”¨';
        addUrlBtn.style.cssText = `
      width: 100%;
      padding: 10px;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    `;
        addUrlBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            const name = nameInput.value.trim() || 'URLå£çº¸';
            if (url) {
                const newWallpaper = await this.wallpaperManager.createWallpaperFromUrl(url, name);
                if (newWallpaper) {
                    // åº”ç”¨æ–°å£çº¸
                    this.wallpaperManager.setWallpaper(viewType, newWallpaper);
                    onApplyWallpaper();
                    // å…³é—­æ¨¡æ€æ¡†
                    document.body.removeChild(modal);
                }
                else {
                    alert('æ— æ•ˆçš„URLã€‚è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLã€‚');
                }
            }
        });
        urlUploadSection.appendChild(urlUploadTitle);
        urlUploadSection.appendChild(urlInput);
        urlUploadSection.appendChild(nameInput);
        urlUploadSection.appendChild(addUrlBtn);
        uploadContent.appendChild(urlUploadSection);
    }
    // åˆ›å»ºå£çº¸é¡¹
    createWallpaperItem(wallpaper, viewType, showDeleteButton, modal, onApplyWallpaper) {
        const item = document.createElement('div');
        item.style.cssText = `
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    `;
        // é¢„è§ˆ
        const preview = document.createElement('div');
        preview.style.cssText = `
      width: 100%;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    `;
        if (wallpaper.type === 'color') {
            // ç¡®ä¿çº¯è‰²å£çº¸é¢„è§ˆæ­£ç¡®
            preview.style.backgroundImage = 'none';
            preview.style.backgroundColor = wallpaper.value;
        }
        else {
            preview.style.backgroundImage = `url("${wallpaper.value}")`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        }
        // åç§°
        const name = document.createElement('div');
        name.textContent = wallpaper.name;
        name.style.cssText = `
      padding: 8px;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-primary);
      background-color: ${document.body.classList.contains('dark-mode') ? 'rgba(42, 42, 42, 0.9)' : 'rgba(255, 255, 255, 0.9)'};
    `;
        // åˆ é™¤æŒ‰é’®
        if (showDeleteButton) {
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.style.cssText = `
        position: absolute;
        top: 5px;
        right: 5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: rgba(255, 0, 0, 0.7);
        color: white;
        border: none;
        font-size: 14px;
        line-height: 1;
        cursor: pointer;
        z-index: 1;
      `;
            deleteBtn.addEventListener('click', e => {
                e.stopPropagation();
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå£çº¸å—ï¼Ÿ')) {
                    this.wallpaperManager.deleteCustomWallpaper(wallpaper.id);
                    // å¦‚æœå½“å‰æ­£åœ¨ä½¿ç”¨è¿™ä¸ªå£çº¸ï¼Œåˆ™é‡ç½®ä¸ºé»˜è®¤
                    const currentWallpaper = this.wallpaperManager.getCurrentWallpaper(viewType);
                    if (currentWallpaper && currentWallpaper.id === wallpaper.id) {
                        this.wallpaperManager.setWallpaper(viewType, null);
                        onApplyWallpaper();
                    }
                    // ç§»é™¤å…ƒç´ 
                    item.parentElement?.removeChild(item);
                }
            });
            item.appendChild(deleteBtn);
        }
        // ç‚¹å‡»åº”ç”¨å£çº¸
        item.addEventListener('click', () => {
            // ç¡®ä¿å£çº¸ç®¡ç†å™¨ä½¿ç”¨å½“å‰ä¸»é¢˜åç§°
            const currentTheme = this.themeManager.getCurrentTheme();
            this.wallpaperManager.setCurrentThemeName(currentTheme.name);
            this.wallpaperManager.setWallpaper(viewType, wallpaper);
            onApplyWallpaper();
            // å…³é—­æ¨¡æ€æ¡†
            document.body.removeChild(modal);
        });
        item.appendChild(preview);
        item.appendChild(name);
        return item;
    }
    // åˆ›å»ºåº•éƒ¨æŒ‰é’®
    createBottomButtons(container, viewType, modal, onApplyWallpaper) {
        const buttonsContainer = document.createElement('div');
        buttonsContainer.style.cssText = `
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid ${document.body.classList.contains('dark-mode') ? '#3c3c3c' : '#eee'};
    `;
        const resetBtn = document.createElement('button');
        resetBtn.textContent = 'æ¢å¤é»˜è®¤';
        resetBtn.style.cssText = `
      padding: 10px 15px;
      background: ${document.body.classList.contains('dark-mode') ? '#3c3c3c' : '#f1f5f9'};
      color: var(--text-primary);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    `;
        resetBtn.addEventListener('click', () => {
            // ç§»é™¤è‡ªå®šä¹‰å£çº¸è®¾ç½®ï¼Œå°†ä½¿ç”¨ä¸»é¢˜é»˜è®¤å£çº¸
            this.wallpaperManager.setWallpaper(viewType, null);
            onApplyWallpaper();
            // å…³é—­æ¨¡æ€æ¡†
            document.body.removeChild(modal);
        });
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'å…³é—­';
        closeBtn.style.cssText = `
      padding: 10px 20px;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    `;
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        buttonsContainer.appendChild(resetBtn);
        buttonsContainer.appendChild(closeBtn);
        container.appendChild(buttonsContainer);
    }
}

;// ./src/åŒå±‚æ‰‹æœº/wallpaper-controller.ts
// å£çº¸æ§åˆ¶å™¨æ¨¡å—
// è´Ÿè´£å£çº¸çš„åº”ç”¨å’Œç®¡ç†

class WallpaperController {
    wallpaperManager;
    themeManager;
    wallpaperSelector;
    constructor(themeManager) {
        this.themeManager = themeManager;
        this.wallpaperManager = themeManager.getWallpaperManager();
        this.wallpaperSelector = new WallpaperSelector(this.wallpaperManager, this.themeManager);
    }
    // åº”ç”¨å£çº¸åˆ°æ‰€æœ‰è§†å›¾
    applyWallpapers() {
        const $chatView = $('#wechat-view');
        const $homeScreen = $('#app-homescreen');
        const $settingsView = $('#settings-view');
        const currentTheme = this.themeManager.getCurrentTheme();
        // ç¡®ä¿å£çº¸ç®¡ç†å™¨ä½¿ç”¨å½“å‰ä¸»é¢˜åç§°
        this.wallpaperManager.setCurrentThemeName(currentTheme.name);
        // åº”ç”¨èŠå¤©å£çº¸
        const chatWallpaper = this.wallpaperManager.getCurrentWallpaper('chat');
        this.wallpaperManager.applyWallpaperToElement($chatView[0], chatWallpaper, currentTheme.colors.defaultWallpapers.chat);
        // åº”ç”¨ä¸»å±å¹•å£çº¸
        const homeWallpaper = this.wallpaperManager.getCurrentWallpaper('home');
        this.wallpaperManager.applyWallpaperToElement($homeScreen[0], homeWallpaper, currentTheme.colors.defaultWallpapers.home);
        // åº”ç”¨è®¾ç½®å£çº¸
        const settingsWallpaper = this.wallpaperManager.getCurrentWallpaper('settings');
        this.wallpaperManager.applyWallpaperToElement($settingsView[0], settingsWallpaper, currentTheme.colors.defaultWallpapers.settings);
    }
    // æ›´æ”¹å£çº¸
    changeWallpaper(viewType) {
        // æ˜¾ç¤ºå£çº¸é€‰æ‹©å™¨
        this.wallpaperSelector.showWallpaperSelector(viewType, () => {
            this.applyWallpapers();
        });
    }
    // åˆå§‹åŒ–å£çº¸ï¼ˆåœ¨ä¸»é¢˜åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
    initializeWallpapers(theme) {
        // ç¡®ä¿åº”ç”¨å½“å‰ä¸»é¢˜çš„é»˜è®¤å£çº¸ï¼Œä½†ä¸è¦†ç›–ç”¨æˆ·å·²ä¿å­˜çš„å£çº¸è®¾ç½®
        this.wallpaperManager.applyThemeDefaultWallpapers(theme);
        this.applyWallpapers();
    }
    // è·å–å£çº¸ç®¡ç†å™¨ï¼ˆç”¨äºå…¶ä»–æ¨¡å—è®¿é—®ï¼‰
    getWallpaperManager() {
        return this.wallpaperManager;
    }
}

;// ./src/åŒå±‚æ‰‹æœº/app-controller.ts


 // å¯¼å…¥è°ƒè¯•æ•°æ®









/**
 * åº”ç”¨ä¸»æ§åˆ¶å™¨
 *
 * é‡æ„åçš„ä¸»æ§åˆ¶å™¨ä¸“æ³¨äºï¼š
 * 1. æ¨¡å—åˆå§‹åŒ–å’Œåè°ƒ
 * 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹ç¼–æ’
 * 3. æ¨¡å—é—´é€šä¿¡åè°ƒ
 * 4. å¯¹å¤–æ¥å£ç»Ÿä¸€ç®¡ç†
 *
 * å…·ä½“åŠŸèƒ½å·²æ‹†åˆ†åˆ°å„ä¸“é—¨æ¨¡å—ï¼š
 * - ConfigManager: é…ç½®ç®¡ç†
 * - UIManager: ç•Œé¢ç®¡ç†
 * - MomentsManager: æœ‹å‹åœˆç®¡ç†
 * - AiResponseManager: AIå“åº”å¤„ç†
 * - ThemeEditor: ä¸»é¢˜ç¼–è¾‘
 * - InputHandler: è¾“å…¥å¤„ç†
 * - WallpaperController: å£çº¸ç®¡ç†
 */
class AppController {
    blmxManager;
    uiRenderer;
    eventHandler;
    themeManager;
    wallpaperController;
    configManager;
    momentsManager;
    aiResponseManager;
    themeEditor;
    inputHandler;
    uiManager;
    dialogManager;
    // ç”¨æˆ·æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¨¡æ‹ŸåŸç‰ˆæœºåˆ¶
    userMessageQueue = [];
    // æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€ç®¡ç†
    hasMomentNotifications() {
        return this.momentsManager.hasMomentNotifications();
    }
    setMomentNotification(value) {
        this.momentsManager.setMomentNotification(value);
    }
    constructor() {
        // åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
        this.configManager = new ConfigManager();
    }
    // åˆå§‹åŒ–åº”ç”¨
    async initialize() {
        try {
            window.currentGameDate = new Date();
            // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
            this.themeManager = new ThemeManager();
            this.wallpaperController = new WallpaperController(this.themeManager);
            // ç¡®ä¿åº”ç”¨å½“å‰ä¸»é¢˜çš„é»˜è®¤å£çº¸ï¼Œä½†ä¸è¦†ç›–ç”¨æˆ·å·²ä¿å­˜çš„å£çº¸è®¾ç½®
            const currentTheme = this.themeManager.getCurrentTheme();
            this.wallpaperController.initializeWallpapers(currentTheme);
            const charData = await getTavernHelper().getCharData();
            // ä½¿ç”¨é…ç½®ç®¡ç†å™¨åŠ è½½é…ç½®
            await this.configManager.loadFromStorage(charData);
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è§’è‰²å¤´åƒï¼Œè·å–é»˜è®¤å¤´åƒ
            let config = this.configManager.getConfig();
            if (!config.avatars.char) {
                const charAvatarPath = await getTavernHelper().getCharAvatarPath();
                this.configManager.updateAvatar('char', charAvatarPath);
                config = this.configManager.getConfig(); // é‡æ–°è·å–æ›´æ–°åçš„é…ç½®
            }
            // æ›´æ–°UIå…ƒç´  - ä½¿ç”¨jQuery
            $('.contact-name').text(this.getDisplayName('char'));
            $('#moments-user-name').text(this.getDisplayName('user'));
            $('#moments-user-avatar').attr('src', config.avatars.user);
            // åŠ è½½æœ‹å‹åœˆå°é¢å›¾ç‰‡ - ä½¿ç”¨jQuery
            const savedCoverPhoto = this.configManager.getSavedCoverPhoto();
            if (savedCoverPhoto) {
                $('#moments-cover-photo').attr('src', savedCoverPhoto);
            }
            // åŠ è½½ä¸ªæ€§ç­¾å - ä½¿ç”¨jQuery
            const savedSignature = this.configManager.getSavedSignature();
            $('#user-signature-display').text(savedSignature);
            // åˆå§‹åŒ–BLMXåè®®
            this.blmxManager = new BLMX_Protocol(config.currentCharId);
            await this.blmxManager.initialize();
            // åŠ è½½è°ƒè¯•æ•°æ®ï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼‰
            if (window.BLMX_DEV_MODE) {
                loadDebugData(this.blmxManager);
            }
            // é¦–å…ˆåˆå§‹åŒ–EventHandlerï¼Œå› ä¸ºå…¶ä»–æ¨¡å—å¯èƒ½ä¾èµ–å®ƒ
            const EventHandler = window.EventHandlerClass;
            this.eventHandler = new EventHandler('#wechat-input-field', '#send-btn', '#plus-btn', this.blmxManager, this, null, // uiRenderer ç¨åè®¾ç½®
            {
                getDisplayName: this.getDisplayName.bind(this),
                stageAndDisplayEntry: this.stageAndDisplayEntry.bind(this),
                triggerAiResponse: this.triggerAiResponse.bind(this),
                updateFooterButtonsState: this.updateFooterButtonsState.bind(this),
                renderChatHistory: this.renderChatHistory.bind(this),
                renderMomentsFeed: this.renderMomentsFeed.bind(this),
                togglePanel: this.togglePanel.bind(this),
                findStickerUrlByName: this.findStickerUrlByName.bind(this),
            });
            // åˆå§‹åŒ–UIæ¸²æŸ“å™¨
            this.uiRenderer = new UIRenderer('.wechat-body', config.avatars, {
                getDisplayName: this.getDisplayName.bind(this),
                findStickerUrlByName: this.findStickerUrlByName.bind(this),
                onTransferAccept: this.handleTransferAccept.bind(this),
                onGiftAction: this.handleGiftAction.bind(this),
                onRecallMessage: this.handleMessageRecall.bind(this),
                isMessageInQueue: this.isMessageInQueue.bind(this),
            });
            // æ›´æ–°EventHandlerä¸­çš„uiRendererå¼•ç”¨
            this.eventHandler.setUIRenderer(this.uiRenderer);
            // åˆå§‹åŒ–æœ‹å‹åœˆç®¡ç†å™¨
            this.momentsManager = new MomentsManager(this.blmxManager, this.configManager, this.uiRenderer);
            // åˆå§‹åŒ–AIå“åº”ç®¡ç†å™¨
            this.aiResponseManager = new AiResponseManager(this.blmxManager, this.uiRenderer, this.eventHandler, this.momentsManager);
            // åˆå§‹åŒ–ä¸»é¢˜ç¼–è¾‘å™¨
            this.themeEditor = new ThemeEditor(this.themeManager, () => {
                this.applyWallpapers();
            });
            // åˆå§‹åŒ–è¾“å…¥å¤„ç†å™¨
            this.inputHandler = new InputHandler(this.configManager, this.stageAndDisplayEntry.bind(this), this.updateFooterButtonsState.bind(this));
            // åˆå§‹åŒ–UIç®¡ç†å™¨
            this.uiManager = new UIManager(this.configManager, this.blmxManager.addEntry.bind(this.blmxManager), this.uiRenderer.renderEntry.bind(this.uiRenderer));
            // åˆå§‹åŒ–å¯¹è¯æ¡†ç®¡ç†å™¨
            this.dialogManager = dialog_manager.DialogManager.getInstance();
            // åº”ç”¨å£çº¸
            this.applyWallpapers();
            // æ¸²æŸ“åˆå§‹ç•Œé¢
            this.renderChatHistory();
            this.renderMomentsFeed();
            // è®¾ç½®è¾“å…¥æ¡†æç¤ºæ–‡å­—
            this.uiManager.setupInputPlaceholder(this.getDisplayName('char'));
            // æ›´æ–°åº•éƒ¨æŒ‰é’®çŠ¶æ€
            this.updateFooterButtonsState();
            // åˆå§‹åŒ–UIåè®¾ç½®ä¸»é¢˜é€‰æ‹©å™¨
            this.setupThemeSelector();
            // ç¡®ä¿è‡ªå®šä¹‰ä¸»é¢˜æŒ‰é’®æ˜¾ç¤ºæ­£ç¡®çš„ä¿¡æ¯
            this.themeEditor.updateCustomThemeButton();
            // åˆå§‹åŒ–æ‰‹æœºå°ºå¯¸è°ƒæ•´åŠŸèƒ½
            this.uiManager.setupPhoneSizeAdjustment();
            // åˆå§‹åŒ–è¡¨æƒ…åŒ…å°ºå¯¸æ§åˆ¶
            this.uiManager.setupStickerSizeControl();
            // åˆå§‹åŒ–å­—ä½“è®¾ç½®åŠŸèƒ½
            this.uiManager.setupFontSelection();
            // åˆå§‹åŒ–å…¨å±æ¨¡å¼æ‰‹æœºå¤§å°è®¾ç½®åŠŸèƒ½
            this.uiManager.setupFullscreenSizeAdjustment();
            // æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬
            this.uiManager.displayAppVersion();
            // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºç‰ˆæœ¬æ›´æ–°é€šçŸ¥
            this.uiManager.checkVersionUpdateNotification();
            // åˆå§‹åŒ–æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€
            // é€šçŸ¥çŠ¶æ€ç”± MomentsManager ç®¡ç†
            // äº‹ä»¶ç›‘å¬å™¨ç°åœ¨ç”± AiResponseManager ç®¡ç†
        }
        catch (error) {
            // console.error('[BLMX] Failed to initialize:', error);
        }
    }
    // æ ¸å¿ƒæ•°æ®è®¿é—®æ–¹æ³•
    getDisplayName(type) {
        return this.configManager.getDisplayName(type);
    }
    findStickerUrlByName(name) {
        return this.configManager.findStickerUrlByName(name);
    }
    // å£çº¸ç®¡ç†
    applyWallpapers() {
        this.wallpaperController.applyWallpapers();
    }
    changeWallpaper(viewType) {
        this.wallpaperController.changeWallpaper(viewType);
    }
    // ç•Œé¢æ¸²æŸ“åè°ƒ
    renderChatHistory() {
        this.uiRenderer.clearChat();
        if (!this.blmxManager)
            return;
        // å…ˆæ¸²æŸ“ä¸»æ—¥å¿—ä¸­çš„æ¶ˆæ¯
        this.blmxManager.logEntries.forEach((entry, index) => {
            if (entry.recalled) {
                this.uiRenderer.renderRecallNotice(entry, null, index);
            }
            else {
                this.uiRenderer.renderEntry(entry, index, false);
            }
        });
        // å†æ¸²æŸ“é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ˆæ¨¡æ‹ŸåŸç‰ˆæœºåˆ¶ï¼‰
        this.userMessageQueue.forEach((entry, queueIndex) => {
            // é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ç´¢å¼•åº”è¯¥æ˜¯ä¸»æ—¥å¿—é•¿åº¦ + é˜Ÿåˆ—ç´¢å¼•
            const actualIndex = this.blmxManager.logEntries.length + queueIndex;
            if (entry.recalled) {
                this.uiRenderer.renderRecallNotice(entry, null, actualIndex);
            }
            else {
                this.uiRenderer.renderEntry(entry, actualIndex, false);
            }
        });
        this.uiRenderer.refreshAllTimestamps();
        this.uiManager.scrollToBottom();
    }
    renderMomentsFeed() {
        this.momentsManager.renderMomentsFeed();
    }
    // æš‚å­˜å¹¶æ˜¾ç¤ºæ¡ç›®
    stageAndDisplayEntry(entry) {
        if ('type' in entry) {
            if (entry.type === 'event') {
                // ä¸ºeventç±»å‹çš„æ¡ç›®æ·»åŠ åˆ°æ—¥å¿—ä¸­å¹¶æ¸²æŸ“
                this.blmxManager.addEntry(entry);
                const entryIndex = this.blmxManager.logEntries.length - 1;
                this.uiRenderer.renderEntry(entry, entryIndex, true);
                // å¦‚æœæ˜¯ç”¨æˆ·å‘é€çš„äº‹ä»¶ï¼Œåˆ™æ ‡è®°ä¸ºéœ€è¦AIå“åº”
                if ('sender' in entry && entry.sender === 'me') {
                    this.eventHandler.setHasPendingNotifications(true);
                }
                return;
            }
            else if (entry.type === 'time') {
                // è·³è¿‡timeç±»å‹å¤„ç†
                return;
            }
            if (!entry.id) {
                entry.id = 'msg-' + Date.now() + Math.random();
            }
            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            if (entry.type === 'image' &&
                'content' in entry &&
                entry.content.type === 'url' &&
                typeof entry.content.value === 'string' &&
                entry.content.value.startsWith('data:image')) {
                // ä½¿ç”¨ç±»å‹æ–­è¨€
                entry.content.isNewForAI = true;
            }
            // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œå…ˆæ·»åŠ åˆ°é˜Ÿåˆ—ï¼ˆæ¨¡æ‹ŸåŸç‰ˆæœºåˆ¶ï¼‰
            if ('sender' in entry && entry.sender === 'me') {
                this.userMessageQueue.push(entry);
                this.eventHandler.setHasPendingNotifications(true);
                // æ¸²æŸ“æ¡ç›®ï¼ˆä½¿ç”¨å…¨å±€ç´¢å¼•ï¼šä¸»æ—¥å¿—é•¿åº¦ + é˜Ÿåˆ—ç´¢å¼•ï¼‰
                const queueIndex = this.userMessageQueue.length - 1;
                const globalIndex = this.blmxManager.logEntries.length + queueIndex;
                this.uiRenderer.renderEntry(entry, globalIndex, true);
            }
            else {
                // éç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ·»åŠ åˆ°ä¸»æ—¥å¿—
                this.blmxManager.addEntry(entry);
                const entryIndex = this.blmxManager.logEntries.length - 1;
                this.uiRenderer.renderEntry(entry, entryIndex, true);
            }
            this.updateFooterButtonsState();
        }
    }
    // AIå“åº”åè°ƒ
    async triggerAiResponse(immediate = false) {
        // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯ï¼ˆé˜Ÿåˆ—æœºåˆ¶ï¼‰
        const hasQueuedMessages = this.userMessageQueue.length > 0;
        // å¦‚æœæ²¡æœ‰ç«‹å³è§¦å‘æ ‡å¿—ï¼Œä¸”æ²¡æœ‰é˜Ÿåˆ—æ¶ˆæ¯å’Œé€šçŸ¥ï¼Œåˆ™ä¸è§¦å‘
        if (!immediate && !hasQueuedMessages && !this.eventHandler.hasNotifications) {
            return;
        }
        // åœ¨è§¦å‘AIå“åº”å‰ï¼Œå°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ç§»åˆ°ä¸»æ—¥å¿—ï¼ˆæ¨¡æ‹ŸåŸç‰ˆæœºåˆ¶ï¼‰
        if (hasQueuedMessages) {
            // å¤åˆ¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
            const messagesToProcess = [...this.userMessageQueue];
            // å°†æ¶ˆæ¯æ·»åŠ åˆ°ä¸»æ—¥å¿—
            messagesToProcess.forEach(entry => {
                if (entry.type === 'image' && 'content' in entry && entry.content.isNewForAI) {
                    entry.content.value = `[ç”¨æˆ·å‘é€çš„å›¾ç‰‡]`;
                    delete entry.content.isNewForAI;
                }
                this.blmxManager.addEntry(entry);
            });
            // æ¸…ç©ºé˜Ÿåˆ—ï¼ˆæ¨¡æ‹ŸåŸç‰ˆçš„ userMessageQueue = []ï¼‰
            this.userMessageQueue = [];
        }
        await this.aiResponseManager.triggerAiResponse(immediate);
    }
    // UIæ§åˆ¶åè°ƒ
    updateFooterButtonsState() {
        this.uiManager.updateFooterButtonsState(this.eventHandler.hasNotifications);
    }
    togglePanel(panelToShow) {
        this.uiManager.togglePanel(panelToShow);
    }
    // å¯¼èˆªåˆ°æŒ‡å®šè§†å›¾
    navigateTo(viewName) {
        const views = {
            home: '#app-homescreen',
            wechat: '#wechat-view',
            moments: '#moments-view',
            settings: '#settings-view',
        };
        try {
            // é¦–å…ˆå°è¯•ä½¿ç”¨jQuery
            if (typeof $ !== 'undefined' && typeof jQuery !== 'undefined') {
                // ä½¿ç”¨jQueryéšè—æ‰€æœ‰è§†å›¾å¹¶æ˜¾ç¤ºç›®æ ‡è§†å›¾
                $('.app-view').removeClass('active');
                $(views[viewName]).addClass('active');
            }
            else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨jQueryï¼ˆåº”è¯¥æ€»æ˜¯å¯ç”¨çš„ï¼‰
                $('.app-view').removeClass('active');
                const $targetView = $(views[viewName]);
                if ($targetView.length) {
                    $targetView.addClass('active');
                }
                else {
                    console.error(`[BLMX] æ‰¾ä¸åˆ°ç›®æ ‡è§†å›¾: ${views[viewName]}`);
                }
            }
            // å½“å¯¼èˆªåˆ°æœ‹å‹åœˆè§†å›¾æ—¶ï¼Œæ›´æ–°é€šçŸ¥çŠ¶æ€å¹¶é‡æ–°æ¸²æŸ“
            if (viewName === 'moments') {
                // æ›´æ–°æœ‹å‹åœˆé€šçŸ¥çŠ¶æ€
                this.setMomentNotification(false);
                // é‡æ–°æ¸²æŸ“æœ‹å‹åœˆå†…å®¹
                this.renderMomentsFeed();
            }
        }
        catch (error) {
            console.error(`[BLMX] å¯¼èˆªé”™è¯¯:`, error);
            // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼Œä½¿ç”¨jQuery
            try {
                $('.app-view').removeClass('active');
                const $targetElement = $(views[viewName]);
                if ($targetElement.length) {
                    $targetElement.addClass('active');
                }
            }
            catch (e) {
                console.error(`[BLMX] æœ€ç»ˆå¯¼èˆªå¤±è´¥:`, e);
            }
        }
    }
    async updateAvatar(avatarType) {
        const config = this.configManager.getConfig();
        const currentUrl = config.avatars[avatarType] || '';
        const displayName = this.getDisplayName(avatarType);
        if (avatarType === 'user') {
            // ç”¨æˆ·å¤´åƒï¼šæ˜¾ç¤ºå¤´åƒå’Œä¸ªæ€§ç­¾åè®¾ç½®å¯¹è¯æ¡†
            await this.showUserProfileDialog(currentUrl);
        }
        else {
            // è§’è‰²å¤´åƒï¼šåªè®¾ç½®å¤´åƒ
            const newUrl = await this.dialogManager.showInputDialog('æ›´æ¢å¤´åƒ', `${displayName}å¤´åƒURL`, currentUrl, 'è¯·è¾“å…¥å¤´åƒå›¾ç‰‡é“¾æ¥', 'url');
            if (newUrl) {
                this.configManager.updateAvatar(avatarType, newUrl);
                await this.dialogManager.alert('å¤´åƒå·²æ›´æ–°ï¼', 'æ›´æ–°æˆåŠŸ');
                this.renderChatHistory();
                this.renderMomentsFeed();
            }
        }
    }
    // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™è®¾ç½®å¯¹è¯æ¡†ï¼ˆå¤´åƒ+ä¸ªæ€§ç­¾åï¼‰
    async showUserProfileDialog(currentAvatarUrl) {
        const currentSignature = this.configManager.getSavedSignature();
        return new Promise(resolve => {
            // åˆ›å»ºå¯¹è¯æ¡†HTMLï¼Œä½¿ç”¨ä¸ç°æœ‰å¯¹è¯æ¡†å®Œå…¨ä¸€è‡´çš„æ ·å¼
            const dialogHtml = `
        <div class="custom-dialog-overlay" id="user-profile-dialog-overlay">
          <div class="custom-dialog user-profile-dialog">
            <div class="dialog-header">
              <h3 class="dialog-title">ä¸ªäººèµ„æ–™è®¾ç½®</h3>
            </div>
            <div class="dialog-body">
              <div class="dialog-input-container">
                <input type="url" id="avatar-url-input" value="${currentAvatarUrl}" placeholder="è¯·è¾“å…¥å¤´åƒå›¾ç‰‡é“¾æ¥">
              </div>
              <div class="dialog-input-container">
                <input type="text" id="signature-input" value="${currentSignature}" placeholder="è¯·è¾“å…¥ä¸ªæ€§ç­¾å">
              </div>
            </div>
            <div class="dialog-footer">
              <button class="dialog-button cancel-button" id="user-profile-cancel">å–æ¶ˆ</button>
              <button class="dialog-button primary-button" id="user-profile-confirm">ç¡®å®š</button>
            </div>
          </div>
        </div>
      `;
            // æ·»åŠ åˆ°æ‰‹æœºå±å¹•å®¹å™¨å†…ï¼Œä¸å…¶ä»–å¯¹è¯æ¡†ä¿æŒä¸€è‡´
            const $phoneScreen = $('.phone-screen');
            if ($phoneScreen.length) {
                $phoneScreen.append(dialogHtml);
            }
            else {
                // å¦‚æœæ‰¾ä¸åˆ°æ‰‹æœºå±å¹•å®¹å™¨ï¼Œå›é€€åˆ°body
                $('body').append(dialogHtml);
            }
            const $overlay = $('#user-profile-dialog-overlay');
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            $overlay.show();
            // ç»‘å®šäº‹ä»¶
            $('#user-profile-cancel').on('click', () => {
                $overlay.remove();
                resolve();
            });
            $('#user-profile-confirm').on('click', async () => {
                const newAvatarUrl = $('#avatar-url-input').val().trim();
                const newSignature = $('#signature-input').val().trim();
                let hasChanges = false;
                // æ›´æ–°å¤´åƒ
                if (newAvatarUrl && newAvatarUrl !== currentAvatarUrl) {
                    this.configManager.updateAvatar('user', newAvatarUrl);
                    $('#moments-user-avatar').attr('src', newAvatarUrl);
                    hasChanges = true;
                }
                // æ›´æ–°ä¸ªæ€§ç­¾å
                if (newSignature !== currentSignature) {
                    this.configManager.setSignature(newSignature);
                    $('#user-signature-display').text(newSignature);
                    hasChanges = true;
                    // è¯¢é—®æ˜¯å¦å‘é€æœ‹å‹åœˆé€šçŸ¥
                    if (newSignature !== currentSignature) {
                        const shouldNotify = await this.dialogManager.confirm('æ˜¯å¦è¦å‘é€æœ‹å‹åœˆåŠ¨æ€é€šçŸ¥AIä½ æ›´æ”¹äº†ä¸ªæ€§ç­¾åï¼Ÿ', 'æœ‹å‹åœˆé€šçŸ¥');
                        if (shouldNotify) {
                            this.momentsManager.notifyMomentChange('signature', currentSignature, newSignature);
                            this.eventHandler.setHasPendingNotifications(true);
                        }
                    }
                }
                $overlay.remove();
                if (hasChanges) {
                    this.renderChatHistory();
                    this.renderMomentsFeed();
                    await this.dialogManager.alert('ä¸ªäººèµ„æ–™å·²æ›´æ–°ï¼', 'æ›´æ–°æˆåŠŸ');
                }
                resolve();
            });
            // ESCé”®å…³é—­
            $(document).on('keydown.userProfile', e => {
                if (e.key === 'Escape') {
                    $overlay.remove();
                    $(document).off('keydown.userProfile');
                    resolve();
                }
            });
            // ç‚¹å‡»é®ç½©å…³é—­
            $overlay.on('click', e => {
                if (e.target === $overlay[0]) {
                    $overlay.remove();
                    resolve();
                }
            });
            // èšç„¦åˆ°å¤´åƒè¾“å…¥æ¡†
            setTimeout(() => {
                $('#avatar-url-input').focus();
            }, 100);
        });
    }
    async updateCharRemark() {
        const oldDisplayName = this.getDisplayName('char');
        const config = this.configManager.getConfig();
        const newRemark = await this.dialogManager.prompt('è¯·è¾“å…¥æ–°çš„å¤‡æ³¨:', config.charRemark, 'ä¿®æ”¹å¤‡æ³¨');
        if (newRemark !== null) {
            this.configManager.updateCharRemark(newRemark);
            const newDisplayName = this.getDisplayName('char');
            $('#contact-name-header').text(newDisplayName);
            $('#wechat-input-field').attr('placeholder', this.configManager.getSavedInputPlaceholder() || `ä¸ ${newDisplayName} å¯¹è¯...`);
            $('#moments-feed-list .post-author-name').each(function () {
                if ($(this).text() === oldDisplayName)
                    $(this).text(newDisplayName);
            });
            $('.recall-notice-text').each(function () {
                const text = $(this).text();
                if (text && text.includes(`"${oldDisplayName}"`)) {
                    $(this).text(`"${newDisplayName}" æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯`);
                }
            });
            await this.dialogManager.alert('å¤‡æ³¨å·²æ›´æ–°ï¼', 'æ›´æ–°æˆåŠŸ');
        }
    }
    async updateUserName() {
        const oldName = this.getDisplayName('user');
        const newName = await this.dialogManager.showInputDialog('æ›´æ”¹åå­—', 'è¯·è¾“å…¥ä½ çš„æ–°åå­—', oldName, 'è¾“å…¥æ–°åå­—...');
        if (newName && newName.trim() !== '' && newName !== oldName) {
            this.configManager.updateUserName(newName);
            $('#moments-user-name').text(newName);
            // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦å‘é€æœ‹å‹åœˆé€šçŸ¥AI
            const shouldNotify = await this.dialogManager.confirm('æ˜¯å¦è¦å‘é€æœ‹å‹åœˆåŠ¨æ€é€šçŸ¥AIä½ æ›´æ”¹äº†åå­—ï¼Ÿ', 'æœ‹å‹åœˆé€šçŸ¥');
            if (shouldNotify) {
                this.momentsManager.notifyMomentChange('name', oldName, newName);
                this.eventHandler.setHasPendingNotifications(true);
            }
            await this.dialogManager.alert('åå­—å·²æ›´æ–°ï¼', 'æ›´æ–°æˆåŠŸ');
        }
    }
    // updateSignatureæ–¹æ³•å·²ç§»é™¤ï¼Œä¸ªæ€§ç­¾åè®¾ç½®å·²æ•´åˆåˆ°ç”¨æˆ·å¤´åƒè®¾ç½®å¯¹è¯æ¡†ä¸­
    async updateCoverPhoto() {
        const currentCover = this.configManager.getSavedCoverPhoto() || '';
        const newCover = await this.dialogManager.showInputDialog('æœ‹å‹åœˆå°é¢', 'æœ‹å‹åœˆå°é¢URL', currentCover, 'è¯·è¾“å…¥å°é¢å›¾ç‰‡é“¾æ¥', 'url');
        if (newCover) {
            this.configManager.setCoverPhoto(newCover);
            $('#moments-cover-photo').attr('src', newCover);
        }
    }
    // è¾“å…¥å¤„ç†åè°ƒ
    async handleTransferAccept(data) {
        await this.inputHandler.handleTransferAccept(data);
    }
    async handleGiftAction(data) {
        await this.inputHandler.handleGiftAction(data);
        this.eventHandler.setHasPendingNotifications(true);
    }
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ï¼ˆæ¨¡æ‹ŸåŸç‰ˆé€»è¾‘ï¼‰
    isMessageInQueue(messageId) {
        return this.userMessageQueue.some(entry => entry.id === messageId);
    }
    // ä»ç”¨æˆ·æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤æŒ‡å®šç´¢å¼•çš„æ¶ˆæ¯
    removeFromUserMessageQueue(index) {
        if (index >= 0 && index < this.userMessageQueue.length) {
            this.userMessageQueue.splice(index, 1);
        }
    }
    // å¤„ç†æ¶ˆæ¯æ’¤å›ï¼ˆä»…é™æ–‡å­—æ¶ˆæ¯ï¼‰
    async handleMessageRecall(entry) {
        try {
            // åªå…è®¸æ’¤å›æ–‡å­—æ¶ˆæ¯
            if (entry.type !== 'message') {
                // åªèƒ½æ’¤å›æ–‡å­—æ¶ˆæ¯
                return;
            }
            // æŸ¥æ‰¾æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­çš„ç´¢å¼•
            const queueIndex = this.userMessageQueue.findIndex(queueEntry => queueEntry.id === entry.id);
            if (queueIndex === -1) {
                // æœªæ‰¾åˆ°è¦æ’¤å›çš„æ¶ˆæ¯
                return;
            }
            const targetEntry = this.userMessageQueue[queueIndex];
            // ä¿å­˜åŸå§‹å†…å®¹åˆ°recalled_content
            targetEntry.recalled_content = targetEntry.content;
            // è®¾ç½®æ’¤å›æ—¶é—´æˆ³
            targetEntry.recalled_timestamp = new Date().toISOString();
            // æ ‡è®°æ¶ˆæ¯ä¸ºå·²æ’¤å›
            targetEntry.recalled = true;
            // é‡æ–°æ¸²æŸ“èŠå¤©å†å²
            this.renderChatHistory();
        }
        catch (error) {
            console.error('æ’¤å›æ¶ˆæ¯æ—¶å‡ºé”™:', error);
        }
    }
    // AIå“åº”æ•°æ®è®¿é—®
    getLatestAiRawResponse() {
        return this.aiResponseManager.getLatestAiRawResponse();
    }
    getLatestSentPrompt() {
        return this.aiResponseManager.getLatestSentPrompt();
    }
    getRawAiResponse() {
        return this.aiResponseManager.getRawAiResponse();
    }
    getFullPrompt() {
        return this.aiResponseManager.getFullPrompt();
    }
    // ä¸»é¢˜ç®¡ç†åè°ƒ
    setupThemeSelector() {
        this.themeEditor.setupThemeSelector();
        this.themeEditor.addCustomThemeEditButton();
        this.setupThemeEditorEvents();
    }
    setupThemeEditorEvents() {
        // ä½¿ç”¨jQueryè¿›è¡Œäº‹ä»¶ç»‘å®š
        $('#close-theme-editor').on('click', () => this.themeEditor.closeThemeEditor());
        $('#save-theme-btn').on('click', () => this.themeEditor.saveCustomTheme());
        $('#reset-theme-btn').on('click', () => this.themeEditor.resetThemeEditor());
        $('#custom-theme-btn').on('click', () => this.themeEditor.openThemeEditor());
        $('#import-theme-btn').on('click', () => this.themeEditor.importTheme());
        $('#export-json-btn').on('click', () => this.themeEditor.exportThemeAsJSON());
    }
    openThemeEditor() {
        this.themeEditor.openThemeEditor();
    }
    closeThemeEditor() {
        this.themeEditor.closeThemeEditor();
    }
    // è¾…åŠ©æ–¹æ³•ï¼šHEXè½¬RGBA
    hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    // è°ƒè¯•åŠŸèƒ½åè°ƒ
    addTestEntry(entryType) {
        addTestEntry(this.blmxManager, entryType);
    }
    clearDebugData() {
        clearDebugData(this.blmxManager);
    }
    showTestEntryTypes() {
        showTestEntryTypes();
    }
    showDebugInfo() {
        showDebugInfo(this);
    }
    // å¤„ç†æ¶ˆæ¯æ’¤å›çš„æœ‹å‹åœˆé€šçŸ¥
    notifyRecallViaMoments(sender, targetText) {
        // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦å‘é€æœ‹å‹åœˆé€šçŸ¥AI
        if (confirm('æ˜¯å¦è¦å‘é€æœ‹å‹åœˆåŠ¨æ€é€šçŸ¥AIä½ æ’¤å›äº†æ¶ˆæ¯ï¼Ÿ')) {
            this.momentsManager.notifyRecallViaMoments(sender, targetText);
            this.eventHandler.setHasPendingNotifications(true);
        }
    }
    /**
     * æ¸…ç†æ‰€æœ‰èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
     */
    cleanup() {
        // æ¸…ç†å„ä¸ªç®¡ç†å™¨çš„èµ„æº
        if (this.aiResponseManager && typeof this.aiResponseManager.cleanup === 'function') {
            this.aiResponseManager.cleanup();
        }
        if (this.uiRenderer && typeof this.uiRenderer.cleanup === 'function') {
            this.uiRenderer.cleanup();
        }
    }
}

;// ./src/åŒå±‚æ‰‹æœº/event-handler.ts


// äº‹ä»¶å¤„ç†å™¨ç±»
class EventHandler {
    wechatInput;
    sendBtn;
    plusBtn;
    uiRenderer;
    options;
    blmxManager;
    appController;
    hasPendingNotifications = false;
    dialogManager = dialog_manager.DialogManager.getInstance();
    // æ·»åŠ getteræ–¹æ³•
    get hasNotifications() {
        return this.hasPendingNotifications;
    }
    // è®¾ç½®UIRendererå¼•ç”¨
    setUIRenderer(uiRenderer) {
        this.uiRenderer = uiRenderer;
    }
    constructor(inputSelector, sendBtnSelector, plusBtnSelector, blmxManager, appController, uiRenderer, options) {
        this.wechatInput = $(inputSelector)[0];
        this.sendBtn = $(sendBtnSelector)[0];
        this.plusBtn = $(plusBtnSelector)[0];
        if (!this.wechatInput || !this.sendBtn || !this.plusBtn) {
            throw new Error('One or more required elements not found');
        }
        this.blmxManager = blmxManager;
        this.options = options;
        this.appController = appController;
        this.uiRenderer = uiRenderer;
        this.setupEventListeners();
    }
    // è®¾ç½®æ˜¯å¦æœ‰å¾…å¤„ç†çš„é€šçŸ¥
    setHasPendingNotifications(value) {
        this.hasPendingNotifications = value;
        this.options.updateFooterButtonsState();
    }
    // æ·»åŠ é•¿æŒ‰ç›‘å¬å™¨
    addLongPressListener(element, callback, options = { duration: 600, preventDefault: true }) {
        let timer;
        let startX, startY;
        const onStart = (e) => {
            if (e.type === 'mousedown' && e.button !== 0)
                return;
            startX = e.clientX;
            startY = e.clientY;
            if (options.preventDefault)
                e.preventDefault();
            clearTimeout(timer);
            timer = window.setTimeout(() => {
                timer = 0;
                callback();
            }, options.duration);
        };
        const onMove = (e) => {
            if (!timer)
                return;
            const moveX = e.clientX;
            const moveY = e.clientY;
            if (Math.abs(moveX - startX) > 10 || Math.abs(moveY - startY) > 10) {
                clearTimeout(timer);
            }
        };
        const onEnd = () => clearTimeout(timer);
        element.addEventListener('pointerdown', onStart);
        element.addEventListener('pointermove', onMove);
        element.addEventListener('pointerup', onEnd);
        element.addEventListener('pointerleave', onEnd);
        if (options.preventDefault) {
            element.addEventListener('contextmenu', e => e.preventDefault());
        }
    }
    // æç¤ºç”¨æˆ·è¾“å…¥æ—¥æœŸå’Œæ—¶é—´
    async promptForDateTime(defaultText) {
        const dateTimeInput = await this.dialogManager.prompt('è¯·è¾“å…¥æ—¥æœŸå’Œæ—¶é—´', defaultText, 'æ—¥æœŸæ—¶é—´è®¾ç½®', 'ç¡®å®š', 'å–æ¶ˆ', 'text', 'æ ¼å¼YYYY-MM-DD HH:mm');
        if (!dateTimeInput || !/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(dateTimeInput)) {
            if (dateTimeInput)
                await this.dialogManager.alert('æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥YYYY-MM-DD HH:mm æ ¼å¼ã€‚', 'æ ¼å¼é”™è¯¯');
            return null;
        }
        const [newDate, newTime] = dateTimeInput.split(' ');
        const parsedDate = new Date(dateTimeInput.replace(' ', 'T'));
        if (isNaN(parsedDate.getTime())) {
            await this.dialogManager.alert('æ— æ•ˆçš„æ—¥æœŸæ—¶é—´æ ¼å¼ã€‚', 'æ ¼å¼é”™è¯¯');
            return null;
        }
        // æ›´æ–°ç³»ç»Ÿå½“å‰æ—¥æœŸ
        window.currentGameDate = parsedDate;
        // æ›´æ–°çŠ¶æ€æ æ—¶é—´
        const $timeElement = $('#current-time');
        if ($timeElement.length) {
            const formattedTime = `${window.currentGameDate.getHours().toString().padStart(2, '0')}:${window.currentGameDate
                .getMinutes()
                .toString()
                .padStart(2, '0')}`;
            $timeElement.text(formattedTime);
        }
        // åˆ·æ–°æ‰€æœ‰æ—¶é—´æˆ³çš„æ˜¾ç¤º
        if (this.uiRenderer) {
            this.uiRenderer.refreshAllTimestamps();
        }
        return [newDate, newTime];
    }
    // å¤„ç†æ¶ˆæ¯æ’¤å›
    async handleMessageRecall(messageId) {
        const entryToRecall = this.blmxManager.logEntries.find(e => 'id' in e && e.id === messageId);
        if (entryToRecall) {
            const currentDate = window.currentGameDate || new Date();
            const timeString = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1)
                .toString()
                .padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')} ${currentDate
                .getHours()
                .toString()
                .padStart(2, '0')}:${currentDate.getMinutes().toString().padStart(2, '0')}`;
            const dateTimeResult = await this.promptForDateTime(timeString);
            if (dateTimeResult === null) {
                return;
            }
            const confirmed = await this.dialogManager.confirm('æ˜¯å¦è¦æ’¤å›è¿™æ¡æ¶ˆæ¯ï¼Ÿ', 'ç¡®è®¤æ’¤å›');
            if (confirmed) {
                const [newDate, newTime] = dateTimeResult;
                // æ ‡è®°æ¶ˆæ¯ä¸ºå·²æ’¤å›
                entryToRecall.recalled = true;
                entryToRecall.recalled_timestamp = `${newDate} ${newTime}`;
                entryToRecall.recalled_content = entryToRecall.content;
                // ç«‹å³ä¿å­˜æ›´æ–°åçš„æ—¥å¿—
                this.blmxManager.persistLogToStorage().then(() => {
                    // ä¿å­˜æˆåŠŸåï¼Œç«‹å³ç”¨æœ€æ–°çš„æ•°æ®é‡ç»˜æ•´ä¸ªèŠå¤©ç•Œé¢
                    this.options.renderChatHistory();
                });
                // æ›´æ–°åº•éƒ¨æŒ‰é’®çŠ¶æ€
                this.options.updateFooterButtonsState();
                // å¦‚æœæ˜¯ç”¨æˆ·æ’¤å›çš„æ¶ˆæ¯ï¼Œè¯¢é—®æ˜¯å¦é€šè¿‡æœ‹å‹åœˆé€šçŸ¥AI
                if (entryToRecall.sender === 'me') {
                    // è·å–æ¶ˆæ¯å†…å®¹
                    const messageContent = typeof entryToRecall.content === 'string'
                        ? entryToRecall.content
                        : safeJsonStringify(entryToRecall.content);
                    // è°ƒç”¨AppControllerçš„é€šçŸ¥æ–¹æ³•
                    this.appController.notifyRecallViaMoments('USER', messageContent);
                }
            }
        }
        else {
            await this.dialogManager.alert('æ‰¾ä¸åˆ°è¯¥æ¶ˆæ¯ï¼Œæ— æ³•æ’¤å›ã€‚', 'é”™è¯¯');
        }
    }
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    setupEventListeners() {
        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨jQuery
        $(this.sendBtn).on('click', () => {
            const text = this.wechatInput.value.trim();
            if (text) {
                this.options.stageAndDisplayEntry({
                    id: `msg-${Date.now()}${Math.random()}`,
                    type: 'message',
                    sender: 'me',
                    content: text,
                });
                this.wechatInput.value = '';
                this.options.updateFooterButtonsState();
            }
            else {
                // æ— è®ºæ˜¯å¦æœ‰é€šçŸ¥ï¼Œéƒ½å¼ºåˆ¶è§¦å‘AIå“åº”
                this.hasPendingNotifications = false;
                this.options.triggerAiResponse(true); // æ˜ç¡®ä¼ é€’immediate=true
            }
        });
        $('#smile-btn').on('click', () => {
            this.options.togglePanel('sticker');
            this.renderStickerFeatures();
        });
        // PlusæŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨jQuery
        $(this.plusBtn).on('click', () => {
            this.options.togglePanel('plus');
            this.renderPlusFeatures();
        });
        $('#microphone-btn').on('click', async () => {
            const result = await this.dialogManager.showVoiceDialog();
            if (result) {
                this.options.stageAndDisplayEntry({
                    id: `msg-${Date.now()}${Math.random()}`,
                    type: 'voice',
                    sender: 'me',
                    content: { text: result.text, duration: result.duration },
                });
            }
        });
        // è¾“å…¥æ¡†äº‹ä»¶ - ä½¿ç”¨jQuery
        $(this.wechatInput).on('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                $(this.sendBtn).trigger('click');
            }
        });
        $(this.wechatInput).on('input', () => {
            this.options.updateFooterButtonsState();
        });
        $(this.wechatInput).on('focus', () => {
            this.options.togglePanel(null);
        });
        // å¯¼èˆªäº‹ä»¶
        $('#app-wechat').on('click', () => this.appController.navigateTo('wechat'));
        $('#app-settings').on('click', () => this.appController.navigateTo('settings'));
        $('#wechat-back-btn-dummy').on('click', () => this.appController.navigateTo('home'));
        $('#settings-back-btn').on('click', () => this.appController.navigateTo('home'));
        $('#wechat-options-btn').on('click', () => this.appController.navigateTo('moments'));
        $('#moments-back-btn').on('click', () => this.appController.navigateTo('wechat'));
        // æ¸²æŸ“åŠŸèƒ½é¢æ¿
        this.renderPlusFeatures();
        this.renderStickerFeatures();
        // å„ç§ç‚¹å‡»äº‹ä»¶ç›‘å¬
        this.setupClickListeners();
        // è¾“å…¥æ¡†é•¿æŒ‰äº‹ä»¶ - ä½¿ç”¨jQueryè·å–å…ƒç´ 
        this.addLongPressListener($('#wechat-input-field')[0], async () => {
            // ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†æ¥æ›´æ–°è¾“å…¥æ¡†æç¤ºæ–‡å­—
            const currentPlaceholder = $('#wechat-input-field').attr('placeholder') || '';
            const newPlaceholder = await this.dialogManager.prompt('ä¿®æ”¹è¾“å…¥æ¡†æç¤ºæ–‡å­—:', currentPlaceholder, 'ä¿®æ”¹æç¤ºæ–‡å­—');
            if (newPlaceholder !== null) {
                $('#wechat-input-field').attr('placeholder', newPlaceholder);
                localStorage.setItem(`blmx_input_placeholder_${this.blmxManager.getCharId()}`, newPlaceholder);
            }
        }, { duration: 5000, preventDefault: false });
    }
    async setupClickListeners() {
        $('#hidden-send-trigger').on('click', async () => {
            const confirmed = await this.dialogManager.confirm('æ˜¯å¦è¦ç«‹å³è§¦å‘AIå“åº”ï¼ˆå³ä½¿æ²¡æœ‰æ–°æ¶ˆæ¯ï¼‰ï¼Ÿ', 'è§¦å‘AIå“åº”');
            if (confirmed) {
                this.options.triggerAiResponse(true);
            }
        });
        // æ·»åŠ å¾®ä¿¡é€‰é¡¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - å¯¼èˆªåˆ°æœ‹å‹åœˆ
        $('#wechat-options-btn').on('click', () => {
            this.appController.navigateTo('moments');
        });
        $('#delete-mode-trigger').on('click', async () => {
            const wechatView = $('#wechat-view');
            wechatView?.toggleClass('delete-mode');
            if (wechatView?.hasClass('delete-mode')) {
                await this.dialogManager.alert('å·²è¿›å…¥åˆ é™¤æ¨¡å¼ã€‚ç‚¹å‡»ä»»æ„æ¶ˆæ¯æˆ–æ—¶é—´æˆ³å¯å°†å…¶åˆ é™¤ã€‚å†æ¬¡ç‚¹å‡»å·¦ä¸Šè§’å¯é€€å‡ºã€‚', 'åˆ é™¤æ¨¡å¼');
            }
            else {
                await this.dialogManager.alert('å·²é€€å‡ºåˆ é™¤æ¨¡å¼ã€‚', 'åˆ é™¤æ¨¡å¼');
            }
        });
        $('#post-moment-btn').on('click', async () => {
            const currentDate = window.currentGameDate || new Date();
            const timeString = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1)
                .toString()
                .padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')} ${currentDate
                .getHours()
                .toString()
                .padStart(2, '0')}:${currentDate.getMinutes().toString().padStart(2, '0')}`;
            // ä½¿ç”¨ç»¼åˆå¯¹è¯æ¡†è·å–æ‰€æœ‰æœ‹å‹åœˆä¿¡æ¯
            const momentData = await this.dialogManager.showMomentDialog(timeString);
            if (!momentData)
                return; // ç”¨æˆ·å–æ¶ˆäº†å‘å¸ƒ
            // ä¸ºæœ‹å‹åœˆç”Ÿæˆå”¯ä¸€ID
            const momentId = `moment-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
            const momentEntry = {
                key: 'USER_MOMENT',
                id: momentId,
                data: {
                    text: momentData.text,
                    image: momentData.image,
                    image_type: momentData.image_type,
                    image_desc: momentData.image_desc,
                    date: momentData.date,
                    time: momentData.time,
                },
            };
            // æ·»åŠ åˆ°æ—¥å¿—
            this.blmxManager.addEntry(momentEntry);
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¨è¿›æ—¶é—´
            const momentDateTime = `${momentData.date} ${momentData.time}`;
            const momentDate = new Date(momentDateTime.replace(' ', 'T'));
            const currentGameDate = window.currentGameDate || new Date();
            // å¦‚æœæœ‹å‹åœˆæ—¶é—´æ™šäºå½“å‰æ¸¸æˆæ—¶é—´ï¼Œå»¶è¿Ÿè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æ¨è¿›æ—¶é—´ï¼ˆé¿å…å¯¹è¯æ¡†å†²çªï¼‰
            if (momentDate > currentGameDate) {
                // å»¶è¿Ÿ300msé¿å…ä¸æœ‹å‹åœˆå‘å¸ƒå¯¹è¯æ¡†å†²çª
                setTimeout(async () => {
                    const shouldAdvanceTime = await this.dialogManager.confirm(`æœ‹å‹åœˆå‘å¸ƒæ—¶é—´ï¼ˆ${momentData.date} ${momentData.time}ï¼‰æ™šäºå½“å‰æ¸¸æˆæ—¶é—´ã€‚\næ˜¯å¦è¦å°†æ¸¸æˆæ—¶é—´æ¨è¿›åˆ°æœ‹å‹åœˆå‘å¸ƒæ—¶é—´ï¼Ÿ`, 'æ—¶é—´æ¨è¿›ç¡®è®¤');
                    if (shouldAdvanceTime) {
                        // æ¨è¿›æ—¶é—´åˆ°æœ‹å‹åœˆå‘å¸ƒæ—¶é—´
                        const parsedDate = new Date(momentDateTime.replace(' ', 'T'));
                        if (!isNaN(parsedDate.getTime())) {
                            // æ›´æ–°ç³»ç»Ÿå½“å‰æ—¥æœŸ
                            window.currentGameDate = parsedDate;
                            // æ›´æ–°çŠ¶æ€æ æ—¶é—´
                            const $timeElement = $('#current-time');
                            if ($timeElement.length) {
                                const formattedTime = `${window.currentGameDate
                                    .getHours()
                                    .toString()
                                    .padStart(2, '0')}:${window.currentGameDate.getMinutes().toString().padStart(2, '0')}`;
                                $timeElement.text(formattedTime);
                            }
                            // åˆ·æ–°æ‰€æœ‰æ—¶é—´æˆ³çš„æ˜¾ç¤º
                            if (this.uiRenderer) {
                                this.uiRenderer.refreshAllTimestamps();
                            }
                            // åˆ›å»ºæ—¶é—´æ¨è¿›äº‹ä»¶è®°å½•
                            const timeAdvanceEvent = {
                                type: 'event',
                                content: {
                                    date: momentData.date,
                                    time: momentData.time,
                                    description: `æ—¶é—´æ¥åˆ°äº† ${momentData.date} ${momentData.time}`,
                                },
                                id: `event-${Date.now()}`,
                            };
                            this.blmxManager.addEntry(timeAdvanceEvent);
                            // é‡æ–°æ¸²æŸ“æœ‹å‹åœˆä»¥åæ˜ æ—¶é—´å˜åŒ–
                            this.options.renderMomentsFeed();
                        }
                    }
                }, 300);
            }
            // å…³é”®ä¿®æ”¹ï¼šå…ˆæ¸²æŸ“æœ‹å‹åœˆï¼Œå†å¼‚æ­¥æŒä¹…åŒ–æ•°æ®
            this.options.renderMomentsFeed();
            // è®¾ç½®é€šçŸ¥çŠ¶æ€
            this.setHasPendingNotifications(true);
            this.options.updateFooterButtonsState();
            // åœ¨åå°è¿›è¡Œæ•°æ®æŒä¹…åŒ–ï¼Œä¸é˜»å¡UIæ›´æ–°
            this.blmxManager.persistLogToStorage().then(() => { });
        });
        const momentsFeedList = $('#moments-feed-list');
        momentsFeedList?.on('click', async (e) => {
            const target = $(e.target)[0];
            const postEl = target.closest('.moment-post');
            if (!postEl)
                return;
            // è·å–æœ‹å‹åœˆçš„å”¯ä¸€ID
            const momentId = postEl.dataset.momentId;
            if (!momentId) {
                console.error('[BLMX] æ— æ³•è·å–æœ‹å‹åœˆIDï¼Œdata-moment-idå±æ€§ç¼ºå¤±');
                return;
            }
            // æœ‹å‹åœˆæ“ä½œ
            if (target.closest('.delete-moment-btn')) {
                const confirmed = await this.dialogManager.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æœ‹å‹åœˆå—ï¼Ÿ\næ­¤æ“ä½œä¹Ÿä¼šåˆ é™¤ç›¸å…³çš„ç‚¹èµå’Œè¯„è®ºã€‚', 'åˆ é™¤æœ‹å‹åœˆ');
                if (confirmed) {
                    // momentIdæ˜¯åºåˆ—IDï¼Œéœ€è¦æ‰¾åˆ°å¯¹åº”çš„å®é™…æœ‹å‹åœˆæ¡ç›®
                    const momentPostLogIndices = [];
                    this.blmxManager.logEntries.forEach((entry, index) => {
                        if ('key' in entry && entry.key.includes('_MOMENT')) {
                            momentPostLogIndices.push(index);
                        }
                    });
                    const momentSequenceId = parseInt(momentId, 10);
                    const actualMomentIndex = momentPostLogIndices[momentSequenceId];
                    // åˆ é™¤æœ‹å‹åœˆ
                    if (actualMomentIndex !== undefined && actualMomentIndex >= 0) {
                        // å…ˆæ”¶é›†æ‰€æœ‰éœ€è¦åˆ é™¤çš„æ¡ç›®ç´¢å¼•ï¼ˆä»åå¾€å‰åˆ é™¤é¿å…ç´¢å¼•å˜åŒ–ï¼‰
                        const indicesToDelete = [actualMomentIndex];
                        // æ‰¾åˆ°ç›¸å…³çš„ç‚¹èµå’Œè¯„è®ºç´¢å¼•
                        this.blmxManager.logEntries.forEach((entry, index) => {
                            if ('key' in entry &&
                                (entry.key === 'USER_LIKE' || entry.key === 'USER_COMMENT') &&
                                'data' in entry &&
                                'target_post_id' in entry.data &&
                                entry.data.target_post_id === momentSequenceId) {
                                indicesToDelete.push(index);
                            }
                        });
                        // æŒ‰ç´¢å¼•ä»å¤§åˆ°å°æ’åºï¼Œä»åå¾€å‰åˆ é™¤
                        indicesToDelete.sort((a, b) => b - a);
                        for (const index of indicesToDelete) {
                            this.blmxManager.logEntries.splice(index, 1);
                        }
                        // ä¿å­˜æ›´æ–°åçš„æ—¥å¿—
                        this.blmxManager.persistLogToStorage().then(() => {
                            // é‡ç»˜æœ‹å‹åœˆç•Œé¢
                            this.options.renderMomentsFeed();
                        });
                    }
                }
            }
            else if (target.closest('.comment-button')) {
                // å¤„ç†è¯„è®º/ç‚¹èµæŒ‰é’®
                const result = await this.dialogManager.showCommentDialog();
                if (result) {
                    if (result.type === 'like') {
                        // æ·»åŠ ç‚¹èµ
                        const likeId = `like-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
                        const likeEntry = {
                            key: 'USER_LIKE',
                            id: likeId,
                            data: { target_post_id: parseInt(momentId, 10) },
                        };
                        this.blmxManager.addEntry(likeEntry);
                        // ç”¨æˆ·ç‚¹èµæœ‹å‹åœˆ
                    }
                    else if (result.type === 'comment' && result.content) {
                        // æ·»åŠ è¯„è®º
                        const commentId = `comment-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
                        const commentEntry = {
                            key: 'USER_COMMENT',
                            id: commentId,
                            data: { text: result.content, target_post_id: parseInt(momentId, 10) },
                        };
                        this.blmxManager.addEntry(commentEntry);
                        // ç”¨æˆ·è¯„è®ºæœ‹å‹åœˆ
                    }
                    // æ›´æ–°ç•Œé¢å’ŒçŠ¶æ€
                    this.options.renderMomentsFeed();
                    this.setHasPendingNotifications(true);
                    this.options.updateFooterButtonsState();
                    // æŒä¹…åŒ–æ•°æ®
                    this.blmxManager.persistLogToStorage();
                }
            }
        });
        $(document.body).on('click', e => {
            const target = $(e.target)[0];
            if (target.matches('.message-avatar')) {
                const row = target.closest('.message-row');
                if (row) {
                    const avatarType = row.classList.contains('me') ? 'user' : 'char';
                    this.appController.updateAvatar(avatarType);
                }
            }
        });
        $('#contact-name-header').on('click', () => {
            this.appController.updateCharRemark();
        });
        $('#moments-user-name').on('click', () => {
            this.appController.updateUserName();
        });
        $('#moments-user-avatar').on('click', () => {
            this.appController.updateAvatar('user');
        });
        // ä¸ªæ€§ç­¾åè®¾ç½®å·²æ•´åˆåˆ°ç”¨æˆ·å¤´åƒè®¾ç½®å¯¹è¯æ¡†ä¸­ï¼Œæ— éœ€å•ç‹¬ç‚¹å‡»äº‹ä»¶
        $('#moments-cover-photo').on('click', () => {
            this.appController.updateCoverPhoto();
        });
        const $wechatBody = $('.wechat-body');
        // ä½¿ç”¨jQueryçš„onæ–¹æ³•ï¼Œä¸ä½¿ç”¨captureå‚æ•°
        $wechatBody.on('click', async (e) => {
            const $wechatView = $('#wechat-view');
            if (!$wechatView.hasClass('delete-mode')) {
                return;
            }
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰data-log-indexå±æ€§
            const $targetRow = $(e.target).closest('[data-log-index]');
            if ($targetRow.length) {
                e.preventDefault();
                e.stopPropagation();
                const indexToDelete = parseInt($targetRow.data('logIndex'), 10);
                const previewText = $targetRow.text().trim().replace(/\s+/g, ' ').substring(0, 50);
                const confirmed = await this.dialogManager.confirm(`ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ\n\né¢„è§ˆ: "${previewText}..."`, 'åˆ é™¤è®°å½•');
                if (confirmed) {
                    const mainLogLength = this.blmxManager.logEntries.length;
                    if (indexToDelete < mainLogLength) {
                        // åˆ é™¤ä¸»æ—¥å¿—ä¸­çš„æ¶ˆæ¯
                        this.blmxManager.logEntries.splice(indexToDelete, 1);
                        await this.blmxManager.persistLogToStorage();
                    }
                    else {
                        // åˆ é™¤é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
                        const queueIndex = indexToDelete - mainLogLength;
                        this.appController.removeFromUserMessageQueue(queueIndex);
                    }
                    this.options.renderChatHistory();
                    this.options.renderMomentsFeed();
                }
                return;
            }
            // å¦‚æœæ²¡æœ‰data-log-indexå±æ€§ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰data-message-idå±æ€§
            const $messageRow = $(e.target).closest('[data-message-id]');
            if ($messageRow.length) {
                e.preventDefault();
                e.stopPropagation();
                const messageId = $messageRow.data('messageId');
                const previewText = $messageRow.text().trim().replace(/\s+/g, ' ').substring(0, 50);
                const confirmed = await this.dialogManager.confirm(`ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ\n\né¢„è§ˆ: "${previewText}..."`, 'åˆ é™¤æ¶ˆæ¯');
                if (confirmed) {
                    // é€šè¿‡messageIdæŸ¥æ‰¾å¯¹åº”çš„æ—¥å¿—æ¡ç›®ç´¢å¼•
                    const indexToDelete = this.blmxManager.logEntries.findIndex(entry => 'id' in entry && entry.id === messageId);
                    if (indexToDelete !== -1) {
                        this.blmxManager.logEntries.splice(indexToDelete, 1);
                        this.blmxManager.persistLogToStorage().then(() => {
                            this.options.renderChatHistory();
                            this.options.renderMomentsFeed();
                        });
                    }
                    else {
                        // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„æ—¥å¿—æ¡ç›®ï¼Œç›´æ¥ä»DOMä¸­ç§»é™¤è¯¥å…ƒç´ 
                        $messageRow.remove();
                        await this.dialogManager.alert('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„æ—¥å¿—æ¡ç›®ï¼Œå·²ä»ç•Œé¢ç§»é™¤è¯¥æ¶ˆæ¯', 'é”™è¯¯');
                    }
                }
            }
        });
        $('#change-chat-wallpaper-btn').on('click', e => {
            e.preventDefault();
            this.appController.changeWallpaper('chat');
        });
        $('#change-home-wallpaper-btn').on('click', e => {
            e.preventDefault();
            this.appController.changeWallpaper('home');
        });
        $('#change-settings-wallpaper-btn').on('click', e => {
            e.preventDefault();
            this.appController.changeWallpaper('settings');
        });
        $('#show-last-ai-response-btn').on('click', async (e) => {
            e.preventDefault();
            const response = this.appController.getLatestAiRawResponse();
            await this.dialogManager.showScrollableText(response || 'æš‚æ— AIå›å¤å†…å®¹', 'AIåŸå§‹å›å¤', 'å…³é—­');
        });
        $('#show-last-sent-prompt-btn').on('click', async (e) => {
            e.preventDefault();
            const prompt = this.appController.getLatestSentPrompt();
            await this.dialogManager.showScrollableText(prompt || 'æš‚æ— å‘é€çš„æç¤ºå†…å®¹', 'å‘é€çš„æç¤º', 'å…³é—­');
        });
        // çµåŠ¨å²›å…¨å±åŠŸèƒ½
        $('.dynamic-island').on('click', async () => {
            try {
                // ä½¿ç”¨jQueryæ£€æŸ¥å…¨å±çŠ¶æ€ï¼Œä½†ä»éœ€è¦ä½¿ç”¨åŸç”ŸAPIè¿›è¡Œå…¨å±æ“ä½œ
                if (!document.fullscreenElement) {
                    // è¿›å…¥å…¨å±
                    await document.documentElement.requestFullscreen();
                }
                else {
                    // é€€å‡ºå…¨å±
                    await document.exitFullscreen();
                }
            }
            catch (error) {
                console.warn('[BLMX] å…¨å±åŠŸèƒ½ä¸æ”¯æŒæˆ–è¢«é˜»æ­¢:', error);
                await this.dialogManager.alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå…¨å±åŠŸèƒ½æˆ–è¢«é˜»æ­¢', 'å…¨å±åŠŸèƒ½');
            }
        });
    }
    renderPlusFeatures() {
        const $plusGrid = $('#plus-grid');
        if (!$plusGrid.length)
            return;
        const PLUS_FEATURES = [
            {
                label: 'ç›¸å†Œ',
                icon: 'fas fa-images',
                action: async () => {
                    const desc = await this.dialogManager.prompt('è¯·è¾“å…¥å›¾ç‰‡æè¿°:', '', 'æ·»åŠ å›¾ç‰‡');
                    if (desc) {
                        this.options.stageAndDisplayEntry({
                            type: 'image',
                            sender: 'me',
                            content: { type: 'desc', value: desc },
                            id: `msg-${Date.now()}`,
                        });
                        this.options.togglePanel(null);
                    }
                },
            },
            {
                label: 'æ‹æ‘„',
                icon: 'fas fa-camera',
                action: async () => {
                    const currentDate = window.currentGameDate || new Date();
                    const dateString = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1)
                        .toString()
                        .padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')}`;
                    const timeString = `${currentDate.getHours().toString().padStart(2, '0')}:${currentDate
                        .getMinutes()
                        .toString()
                        .padStart(2, '0')}`;
                    // ä½¿ç”¨ç»¼åˆæ—¶é—´è·³è·ƒå¯¹è¯æ¡†
                    const timeJumpData = await this.dialogManager.showTimeJumpDialog(`${dateString} ${timeString}`);
                    if (!timeJumpData)
                        return;
                    const eventData = {
                        date: timeJumpData.date,
                        time: timeJumpData.time,
                        description: timeJumpData.description,
                    };
                    // æŒ‰ç…§åŸç‰ˆé€»è¾‘ï¼šå‘é€eventlogæ—¶ç«‹å³æ›´æ–°æ¸¸æˆæ—¶é—´
                    const [newDate, newTime] = [timeJumpData.date, timeJumpData.time];
                    window.currentGameDate = new Date(`${newDate} ${newTime}`.replace(' ', 'T'));
                    // æ›´æ–°çŠ¶æ€æ æ—¶é—´æ˜¾ç¤º
                    const $timeElement = $('#current-time');
                    if ($timeElement.length) {
                        const formattedTime = `${window.currentGameDate
                            .getHours()
                            .toString()
                            .padStart(2, '0')}:${window.currentGameDate.getMinutes().toString().padStart(2, '0')}`;
                        $timeElement.text(formattedTime);
                    }
                    this.options.stageAndDisplayEntry({
                        type: 'event',
                        content: eventData,
                        id: `event-${Date.now()}`,
                    });
                    this.options.togglePanel(null);
                },
            },
            {
                label: 'è§†é¢‘é€šè¯',
                icon: 'fas fa-video',
                action: async () => await this.dialogManager.alert('æœ¬åŒå±‚æ‰‹æœºåªã€å…è´¹å‘å¸ƒäºdiscordçš„å°¾å·´é•‡ç¤¾åŒºå’Œæ—…ç¨‹ç¤¾åŒºï¼Œä½œè€…æš´åŠ›ç¾å­¦ï¼Œç‚¹å‡»é“¾æ¥å³å¯å…è´¹è·å–https://discord.com/channels/1379304008157499423/1388180976873766973ã€‚https://discord.com/channels/1291925535324110879/1388182155707814009', 'å…³äºä½œè€…'),
            },
            {
                label: 'ä½ç½®',
                icon: 'fas fa-map-marker-alt',
                action: async () => {
                    const loc = await this.dialogManager.prompt('è¯·è¾“å…¥ä½ç½®:', '', 'å‘é€ä½ç½®');
                    if (loc)
                        this.options.stageAndDisplayEntry({
                            type: 'location',
                            sender: 'me',
                            content: loc,
                            id: `msg-${Date.now()}`,
                        });
                    this.options.togglePanel(null);
                },
            },
            {
                label: 'çº¢åŒ…',
                icon: 'fas fa-envelope',
                action: async () => {
                    const result = await this.dialogManager.showRedPacketDialog();
                    if (result) {
                        const giftData = {
                            name: 'çº¢åŒ…',
                            price: result.amount,
                            note: result.note,
                            status: 'sent',
                        };
                        this.options.stageAndDisplayEntry({
                            type: 'gift',
                            sender: 'me',
                            content: safeJsonStringify(giftData),
                            data: giftData,
                            id: `msg-${Date.now()}`,
                        });
                        this.options.togglePanel(null);
                    }
                },
            },
            {
                label: 'è½¬è´¦',
                icon: 'fas fa-money-bill-wave',
                action: async () => {
                    const result = await this.dialogManager.showTransferDialog();
                    if (result) {
                        const transferData = {
                            amount: result.amount,
                            note: result.note || ' ',
                            status: 'sent',
                        };
                        this.options.stageAndDisplayEntry({
                            type: 'transfer',
                            sender: 'me',
                            content: safeJsonStringify(transferData),
                            data: transferData,
                            id: `msg-${Date.now()}`,
                        });
                        this.options.togglePanel(null);
                    }
                },
            },
            {
                label: 'æ–‡ä»¶',
                icon: 'fas fa-file-alt',
                action: async () => {
                    const fileName = await this.dialogManager.prompt('è¯·è¾“å…¥æ–‡ä»¶å:', '', 'å‘é€æ–‡ä»¶');
                    if (fileName)
                        this.options.stageAndDisplayEntry({
                            type: 'file',
                            sender: 'me',
                            content: fileName,
                            id: `msg-${Date.now()}`,
                        });
                    this.options.togglePanel(null);
                },
            },
            {
                label: 'ç¤¼ç‰©',
                icon: 'fas fa-gift',
                action: async () => {
                    const result = await this.dialogManager.showGiftDialog();
                    if (result) {
                        const giftData = {
                            name: result.name,
                            price: result.price,
                            status: 'sent',
                        };
                        this.options.stageAndDisplayEntry({
                            type: 'gift',
                            sender: 'me',
                            content: safeJsonStringify(giftData),
                            data: giftData,
                            id: `msg-${Date.now()}`,
                        });
                        this.options.togglePanel(null);
                    }
                },
            },
        ];
        // ç¡®ä¿uiRendererå­˜åœ¨ä¸”å·²ç»åˆå§‹åŒ–
        if (this.uiRenderer) {
            // ç›´æ¥ä½¿ç”¨DOMå…ƒç´ è€Œä¸æ˜¯jQueryå¯¹è±¡
            this.uiRenderer.renderFeatureGrid($plusGrid[0], PLUS_FEATURES, {
                onToggleDeleteMode: () => { },
                onAddStickers: () => { },
            });
        }
        else {
            console.error('[BLMX] UIRenderer is not initialized');
        }
    }
    renderStickerFeatures() {
        const $stickerGrid = $('#sticker-grid');
        if (!$stickerGrid.length)
            return;
        // å®šä¹‰é»˜è®¤è¡¨æƒ…åŒ…
        const defaultGlobalStickers = [{ label: 'å¥½çš„', url: 'https://files.catbox.moe/3j0tpc.jpeg' }];
        // è¯»å–å…¨å±€è¡¨æƒ…åŒ… - ä½¿ç”¨ä¸åŸç‰ˆä¸€è‡´çš„å­˜å‚¨é”®
        const GLOBAL_STICKER_STORAGE_KEY = 'blmx_wechat_stickers_global_blmx';
        const customStickers = SafeStorage.getItem(GLOBAL_STICKER_STORAGE_KEY, []) || [];
        const allStickers = [...defaultGlobalStickers, ...customStickers];
        // åˆ›å»ºè¡¨æƒ…åŒ…åŠŸèƒ½
        const features = allStickers.map(s => ({
            label: s.label,
            icon: s.url,
            isDefault: defaultGlobalStickers.some(ds => ds.label === s.label),
            action: () => {
                this.options.stageAndDisplayEntry({
                    type: 'sticker',
                    sender: 'me',
                    content: s.label,
                    id: `msg-${Date.now()}`,
                });
                this.options.togglePanel(null);
            },
        }));
        // æ·»åŠ "è¡¨æƒ…ç®¡ç†"æŒ‰é’®
        features.unshift({
            label: 'è¡¨æƒ…ç®¡ç†',
            icon: 'fas fa-cog', // å°†å›¾æ ‡æ”¹ä¸ºé½¿è½®å›¾æ ‡
            isAddBtn: true,
            isDefault: false, // æ·»åŠ isDefaultå±æ€§
            action: () => {
                this.showStickerManager();
            },
        });
        // ç¡®ä¿uiRendererå­˜åœ¨ä¸”å·²ç»åˆå§‹åŒ–
        if (this.uiRenderer) {
            // ç›´æ¥ä½¿ç”¨DOMå…ƒç´ è€Œä¸æ˜¯jQueryå¯¹è±¡
            this.uiRenderer.renderFeatureGrid($stickerGrid[0], features, {
                onToggleDeleteMode: () => this.showStickerManager(),
                onAddStickers: () => this.showStickerManager(),
            });
        }
        else {
            console.error('[BLMX] UIRenderer is not initialized');
        }
    }
    // è¡¨æƒ…åŒ…ç®¡ç†ç•Œé¢
    showStickerManager() {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'sticker-manager-modal';
        // åˆ›å»ºå†…å®¹å®¹å™¨
        const container = document.createElement('div');
        container.className = 'sticker-manager-container';
        // ä½¿ç”¨innerHTMLåˆ›å»ºå®Œæ•´ç»“æ„ï¼ŒåŒ…å«å¤šæ ‡ç­¾é¡µ
        container.innerHTML = `
      <h2>è¡¨æƒ…åŒ…ç®¡ç†</h2>
      <div class="sticker-manager-tabs">
        <div class="tab-button active" data-tab="add-sticker">æ·»åŠ è¡¨æƒ…</div>
        <div class="tab-button" data-tab="batch-add">æ‰¹é‡æ·»åŠ </div>
        <div class="tab-button" data-tab="delete-manage">åˆ é™¤ç®¡ç†</div>
      </div>
      <div class="sticker-manager-content">
        <!-- æ·»åŠ å•ä¸ªè¡¨æƒ…æ ‡ç­¾é¡µ -->
        <div class="tab-content active" data-tab="add-sticker">
          <div class="add-sticker-section">
            <div class="add-sticker-form">
              <div class="form-group">
                <label for="sticker-label">è¡¨æƒ…åŒ…åç§°</label>
                <input type="text" id="sticker-label" placeholder="è¡¨æƒ…æè¿°/åç§°">
              </div>
              <div class="form-group">
                <label for="sticker-url">è¡¨æƒ…åŒ…URL</label>
                <input type="url" id="sticker-url" placeholder="è¡¨æƒ…å›¾ç‰‡URLé“¾æ¥">
              </div>
              <div class="preview-container">
                <div class="preview-label">é¢„è§ˆ</div>
                <img id="preview-img" class="preview-img" style="display: none;">
              </div>
              <button class="add-sticker-btn">æ·»åŠ è¡¨æƒ…åŒ…</button>
            </div>
          </div>
        </div>

        <!-- æ‰¹é‡æ·»åŠ æ ‡ç­¾é¡µ -->
        <div class="tab-content" data-tab="batch-add">
          <div class="batch-add-section">
            <div class="batch-instructions">
              <p>æ‰¹é‡æ·»åŠ æ ¼å¼è¯´æ˜ï¼š</p>
              <ul>
                <li>æ¯ä¸ªè¡¨æƒ…åŒ…æ ¼å¼ï¼š<strong>è¡¨æƒ…åç§°http://å›¾ç‰‡é“¾æ¥</strong></li>
                <li>å¤šä¸ªè¡¨æƒ…åŒ…ç”¨<strong>è‹±æ–‡é€—å·</strong>åˆ†éš”</li>
                <li>ä¹Ÿæ”¯æŒ <strong>è¡¨æƒ…åç§°=http://å›¾ç‰‡é“¾æ¥</strong> æ ¼å¼</li>
                <li>ç¤ºä¾‹ï¼š<code>ç¬‘è„¸https://example.com/smile.jpg,å“­è„¸https://example.com/cry.jpg</code></li>
              </ul>
            </div>
            <div class="form-group">
              <label for="batch-textarea">æ‰¹é‡è¡¨æƒ…åŒ…æ•°æ®</label>
              <textarea id="batch-textarea" placeholder="è¯·æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å…¥å¤šä¸ªè¡¨æƒ…åŒ…..."></textarea>
            </div>
            <button class="batch-add-btn">æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…</button>
          </div>
        </div>

        <!-- åˆ é™¤ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" data-tab="delete-manage">
          <div class="delete-manage-section">
            <div class="control-bar">
              <div class="selection-controls">
                <button class="select-all-btn">å…¨é€‰</button>
                <button class="deselect-all-btn">å–æ¶ˆé€‰æ‹©</button>
              </div>
              <button class="delete-selected-btn">åˆ é™¤é€‰ä¸­</button>
            </div>
            <div class="sticker-list-container">
              <div class="sticker-grid" id="delete-sticker-grid">
                <!-- è¡¨æƒ…åŒ…åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="sticker-manager-footer">
        <button class="dialog-button">å…³é—­</button>
      </div>
    `;
        // è·å–DOMå…ƒç´ 
        const tabButtons = container.querySelectorAll('.tab-button');
        const tabContents = container.querySelectorAll('.tab-content');
        const closeBtn = container.querySelector('.dialog-button');
        // æ·»åŠ è¡¨æƒ…ç›¸å…³å…ƒç´ 
        const labelInput = container.querySelector('#sticker-label');
        const urlInput = container.querySelector('#sticker-url');
        const previewImg = container.querySelector('#preview-img');
        const addStickerBtn = container.querySelector('.add-sticker-btn');
        // æ‰¹é‡æ·»åŠ ç›¸å…³å…ƒç´ 
        const batchTextarea = container.querySelector('#batch-textarea');
        const batchAddBtn = container.querySelector('.batch-add-btn');
        // åˆ é™¤ç®¡ç†ç›¸å…³å…ƒç´ 
        const selectAllBtn = container.querySelector('.select-all-btn');
        const deselectAllBtn = container.querySelector('.deselect-all-btn');
        const deleteSelectedBtn = container.querySelector('.delete-selected-btn');
        const deleteStickerGrid = container.querySelector('#delete-sticker-grid');
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                // è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºæ´»åŠ¨çŠ¶æ€
                button.classList.add('active');
                const targetContent = container.querySelector(`.tab-content[data-tab="${targetTab}"]`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
                // å¦‚æœåˆ‡æ¢åˆ°åˆ é™¤ç®¡ç†æ ‡ç­¾é¡µï¼Œæ¸²æŸ“è¡¨æƒ…åŒ…åˆ—è¡¨
                if (targetTab === 'delete-manage') {
                    renderDeleteStickerList();
                }
            });
        });
        // URLè¾“å…¥é¢„è§ˆåŠŸèƒ½
        urlInput.addEventListener('input', () => {
            if (urlInput.value.trim()) {
                previewImg.src = urlInput.value.trim();
                previewImg.style.display = 'block';
            }
            else {
                previewImg.style.display = 'none';
            }
        });
        // æ·»åŠ å•ä¸ªè¡¨æƒ…åŒ…
        addStickerBtn.addEventListener('click', () => {
            const label = labelInput.value.trim();
            const url = urlInput.value.trim();
            if (!label || !url) {
                alert('è¯·è¾“å…¥è¡¨æƒ…åç§°å’ŒURL');
                return;
            }
            const GLOBAL_STICKER_STORAGE_KEY = 'blmx_wechat_stickers_global_blmx';
            const existingStickers = SafeStorage.getItem(GLOBAL_STICKER_STORAGE_KEY, []) || [];
            const newSticker = { label, url };
            existingStickers.push(newSticker);
            SafeStorage.setItem(GLOBAL_STICKER_STORAGE_KEY, existingStickers);
            alert('è¡¨æƒ…åŒ…æ·»åŠ æˆåŠŸï¼');
            // æ¸…ç©ºè¾“å…¥æ¡†
            labelInput.value = '';
            urlInput.value = '';
            previewImg.style.display = 'none';
            // åˆ·æ–°è¡¨æƒ…åŒ…èœå•
            this.renderStickerFeatures();
        });
        // æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…
        batchAddBtn.addEventListener('click', () => {
            const input = batchTextarea.value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥è¡¨æƒ…åŒ…æ•°æ®');
                return;
            }
            const GLOBAL_STICKER_STORAGE_KEY = 'blmx_wechat_stickers_global_blmx';
            const pairs = input.split(',');
            const newStickers = [];
            for (const pair of pairs) {
                // æŸ¥æ‰¾URLéƒ¨åˆ†çš„èµ·å§‹ä½ç½® - é€šå¸¸æ˜¯httpæˆ–httpså¼€å¤´
                const urlStartIndex = pair.indexOf('http');
                if (urlStartIndex > 0) {
                    const label = pair.substring(0, urlStartIndex).trim();
                    const url = pair.substring(urlStartIndex).trim();
                    if (label && url) {
                        newStickers.push({ label, url });
                    }
                }
                else if (pair.includes('=')) {
                    // æ”¯æŒlabel=urlæ ¼å¼
                    const [label, url] = pair.split('=').map(part => part.trim());
                    if (label && url) {
                        newStickers.push({ label, url });
                    }
                }
            }
            if (newStickers.length > 0) {
                const existingStickers = SafeStorage.getItem(GLOBAL_STICKER_STORAGE_KEY, []) || [];
                const updatedStickers = [...existingStickers, ...newStickers];
                SafeStorage.setItem(GLOBAL_STICKER_STORAGE_KEY, updatedStickers);
                alert(`${newStickers.length} ä¸ªè¡¨æƒ…åŒ…å·²æ·»åŠ ï¼`);
                batchTextarea.value = '';
                // åˆ·æ–°è¡¨æƒ…åŒ…èœå•
                this.renderStickerFeatures();
            }
            else {
                alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¡¨æƒ…åŒ…æ ¼å¼ã€‚è¯·æŒ‰ç…§ä¸Šæ–¹çš„æ ¼å¼è¯´æ˜è¾“å…¥ã€‚');
            }
        });
        // æ¸²æŸ“åˆ é™¤ç®¡ç†çš„è¡¨æƒ…åŒ…åˆ—è¡¨
        const renderDeleteStickerList = () => {
            const GLOBAL_STICKER_STORAGE_KEY = 'blmx_wechat_stickers_global_blmx';
            const stickers = SafeStorage.getItem(GLOBAL_STICKER_STORAGE_KEY, []) || [];
            deleteStickerGrid.innerHTML = '';
            if (stickers.length === 0) {
                const noStickersMsg = document.createElement('div');
                noStickersMsg.textContent = 'æ²¡æœ‰è¡¨æƒ…åŒ…ï¼Œè¯·ç‚¹å‡»"æ·»åŠ è¡¨æƒ…"æ ‡ç­¾æ·»åŠ ã€‚';
                noStickersMsg.className = 'no-stickers-msg';
                deleteStickerGrid.appendChild(noStickersMsg);
                return;
            }
            stickers.forEach((sticker, index) => {
                const stickerItem = document.createElement('div');
                stickerItem.className = 'sticker-item';
                // åˆ›å»ºéšè—çš„åŸç”Ÿcheckbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'sticker-checkbox';
                checkbox.dataset.index = index.toString();
                // åˆ›å»ºå¯è§çš„checkboxæŒ‰é’®
                const checkboxButton = document.createElement('div');
                checkboxButton.className = 'sticker-checkbox-button';
                // åˆ›å»ºå…¶ä»–å…ƒç´ 
                const stickerImg = document.createElement('img');
                stickerImg.src = sticker.url;
                stickerImg.alt = sticker.label;
                stickerImg.className = 'sticker-preview';
                const stickerLabel = document.createElement('div');
                stickerLabel.className = 'sticker-label';
                stickerLabel.textContent = sticker.label;
                // æ›´æ–°checkboxæŒ‰é’®çŠ¶æ€
                const updateCheckboxState = (checked) => {
                    if (checked) {
                        checkboxButton.classList.add('checked');
                    }
                    else {
                        checkboxButton.classList.remove('checked');
                    }
                };
                // ç‚¹å‡»äº‹ä»¶
                const handleClick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    checkbox.checked = !checkbox.checked;
                    updateCheckboxState(checkbox.checked);
                };
                stickerItem.addEventListener('click', handleClick);
                checkboxButton.addEventListener('click', handleClick);
                // ç»„è£…å…ƒç´ 
                stickerItem.appendChild(checkbox);
                stickerItem.appendChild(checkboxButton);
                stickerItem.appendChild(stickerImg);
                stickerItem.appendChild(stickerLabel);
                deleteStickerGrid.appendChild(stickerItem);
                // è®¾ç½®åˆå§‹çŠ¶æ€
                updateCheckboxState(checkbox.checked);
            });
        };
        // å…¨é€‰åŠŸèƒ½
        selectAllBtn.addEventListener('click', () => {
            const checkboxes = deleteStickerGrid.querySelectorAll('.sticker-checkbox');
            const checkboxButtons = deleteStickerGrid.querySelectorAll('.sticker-checkbox-button');
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = true;
                checkboxButtons[index]?.classList.add('checked');
            });
        });
        // å–æ¶ˆé€‰æ‹©åŠŸèƒ½
        deselectAllBtn.addEventListener('click', () => {
            const checkboxes = deleteStickerGrid.querySelectorAll('.sticker-checkbox');
            const checkboxButtons = deleteStickerGrid.querySelectorAll('.sticker-checkbox-button');
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = false;
                checkboxButtons[index]?.classList.remove('checked');
            });
        });
        // åˆ é™¤é€‰ä¸­åŠŸèƒ½
        deleteSelectedBtn.addEventListener('click', () => {
            const checkboxes = deleteStickerGrid.querySelectorAll('.sticker-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…åŒ…');
                return;
            }
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿ`)) {
                const GLOBAL_STICKER_STORAGE_KEY = 'blmx_wechat_stickers_global_blmx';
                const stickers = SafeStorage.getItem(GLOBAL_STICKER_STORAGE_KEY, []) || [];
                // è·å–è¦åˆ é™¤çš„ç´¢å¼•ï¼ˆä»å¤§åˆ°å°æ’åºï¼Œé¿å…åˆ é™¤æ—¶ç´¢å¼•å˜åŒ–ï¼‰
                const indicesToDelete = window._.chain(checkboxes)
                    .map((checkbox) => parseInt(checkbox.dataset.index))
                    .sortBy()
                    .reverse()
                    .value();
                // åˆ é™¤é€‰ä¸­çš„è¡¨æƒ…åŒ…
                indicesToDelete.forEach((index) => {
                    stickers.splice(index, 1);
                });
                SafeStorage.setItem(GLOBAL_STICKER_STORAGE_KEY, stickers);
                alert(`å·²åˆ é™¤ ${checkboxes.length} ä¸ªè¡¨æƒ…åŒ…`);
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                renderDeleteStickerList();
                // åˆ·æ–°è¡¨æƒ…åŒ…èœå•
                this.renderStickerFeatures();
            }
        });
        // å…³é—­æŒ‰é’®äº‹ä»¶
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        modal.addEventListener('click', e => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
        modal.appendChild(container);
        document.body.appendChild(modal);
    }
}

;// ./src/åŒå±‚æ‰‹æœº/style-manager.ts
/**
 * æ ·å¼ç®¡ç†å™¨
 * è´Ÿè´£å¯¼å…¥å’Œç®¡ç†æ‰€æœ‰SCSSæ ·å¼æ–‡ä»¶
 */
// å¯¼å…¥ä¸»æ ·å¼æ–‡ä»¶

/**
 * æ ·å¼ç®¡ç†å™¨ç±»
 * æä¾›æ ·å¼ç›¸å…³çš„å·¥å…·æ–¹æ³•å’Œç®¡ç†åŠŸèƒ½
 */
class StyleManager {
    static instance;
    loadedStyles = new Set();
    constructor() {
        this.initializeStyles();
    }
    /**
     * è·å–æ ·å¼ç®¡ç†å™¨å•ä¾‹å®ä¾‹
     */
    static getInstance() {
        if (!StyleManager.instance) {
            StyleManager.instance = new StyleManager();
        }
        return StyleManager.instance;
    }
    /**
     * åˆå§‹åŒ–æ ·å¼
     */
    initializeStyles() {
        console.log('[StyleManager] æ­£åœ¨åŠ è½½æ ·å¼æ–‡ä»¶...');
        // æ ‡è®°ä¸»æ ·å¼å·²åŠ è½½
        this.loadedStyles.add('main');
        // æ·»åŠ æ ·å¼åŠ è½½å®Œæˆçš„æ ‡è®°åˆ°body
        document.body.classList.add('styles-loaded');
        console.log('[StyleManager] æ ·å¼æ–‡ä»¶åŠ è½½å®Œæˆ');
    }
    /**
     * æ£€æŸ¥æ ·å¼æ˜¯å¦å·²åŠ è½½
     */
    isStyleLoaded(styleName) {
        return this.loadedStyles.has(styleName);
    }
    /**
     * åŠ¨æ€åˆ‡æ¢ä¸»é¢˜
     */
    toggleTheme(theme) {
        const body = document.body;
        if (theme === 'dark') {
            body.classList.add('dark-mode');
        }
        else {
            body.classList.remove('dark-mode');
        }
        console.log(`[StyleManager] ä¸»é¢˜å·²åˆ‡æ¢åˆ°: ${theme}`);
    }
    /**
     * è·å–å½“å‰ä¸»é¢˜
     */
    getCurrentTheme() {
        return document.body.classList.contains('dark-mode') ? 'dark' : 'light';
    }
    /**
     * åŠ¨æ€è®¾ç½®CSSå˜é‡
     */
    setCSSVariable(name, value) {
        document.documentElement.style.setProperty(name, value);
    }
    /**
     * è·å–CSSå˜é‡å€¼
     */
    getCSSVariable(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
    /**
     * æ‰¹é‡è®¾ç½®CSSå˜é‡
     */
    setCSSVariables(variables) {
        Object.entries(variables).forEach(([name, value]) => {
            this.setCSSVariable(name, value);
        });
    }
    /**
     * é‡ç½®æ‰€æœ‰è‡ªå®šä¹‰CSSå˜é‡
     */
    resetCSSVariables() {
        // ç§»é™¤æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®çš„CSSå˜é‡
        const style = document.documentElement.style;
        const propertiesToRemove = [];
        for (let i = 0; i < style.length; i++) {
            const property = style[i];
            if (property.startsWith('--')) {
                propertiesToRemove.push(property);
            }
        }
        propertiesToRemove.forEach(property => {
            style.removeProperty(property);
        });
    }
    /**
     * æ·»åŠ è‡ªå®šä¹‰æ ·å¼ç±»
     */
    addStyleClass(element, className) {
        element.classList.add(className);
    }
    /**
     * ç§»é™¤æ ·å¼ç±»
     */
    removeStyleClass(element, className) {
        element.classList.remove(className);
    }
    /**
     * åˆ‡æ¢æ ·å¼ç±»
     */
    toggleStyleClass(element, className) {
        return element.classList.toggle(className);
    }
    /**
     * æ£€æŸ¥å…ƒç´ æ˜¯å¦åŒ…å«æŒ‡å®šæ ·å¼ç±»
     */
    hasStyleClass(element, className) {
        return element.classList.contains(className);
    }
    /**
     * è·å–æ ·å¼ç®¡ç†å™¨çŠ¶æ€ä¿¡æ¯
     */
    getStatus() {
        return {
            loadedStyles: Array.from(this.loadedStyles),
            currentTheme: this.getCurrentTheme(),
            stylesLoaded: document.body.classList.contains('styles-loaded'),
        };
    }
}
// å¯¼å‡ºå•ä¾‹å®ä¾‹
const styleManager = StyleManager.getInstance();
// åœ¨æ¨¡å—åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
console.log('[StyleManager] æ ·å¼ç®¡ç†å™¨å·²åˆå§‹åŒ–');

;// ./src/åŒå±‚æ‰‹æœº/index.ts




// å¼€å‘æ¨¡å¼æ ‡å¿— - å‘å¸ƒå‰å°†æ­¤å€¼è®¾ç½®ä¸ºfalse
// ä½¿ç”¨windowå…¨å±€å˜é‡å­˜å‚¨ï¼Œé¿å…å¾ªç¯ä¾èµ–
window.BLMX_DEV_MODE = false;
// è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå°†EventHandlerç±»å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­
window.EventHandlerClass = EventHandler;
// æ·»åŠ å…¨å±€æ ‡å¿—æ¥é˜²æ­¢é‡å¤å¤„ç†AIå“åº”
window.BLMX_PROCESSING_AI_RESPONSE = false;
// ä½¿ç”¨jQueryçš„$(async () => {})è¯­æ³•
$(async () => {
    try {
        // é‡ç½®å…¨å±€æ ‡å¿—ï¼Œç¡®ä¿é¡µé¢åˆ·æ–°æ—¶ä¸ä¼šä¿ç•™æ—§çš„çŠ¶æ€
        window.BLMX_PROCESSING_AI_RESPONSE = false;
        // åˆ›å»ºå¹¶åˆå§‹åŒ–åº”ç”¨æ§åˆ¶å™¨
        const appController = new AppController();
        await appController.initialize();
        // å°†æ§åˆ¶å™¨å®ä¾‹å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­ï¼Œä»¥ä¾¿è°ƒè¯•
        window.blmxApp = appController;
        window.blmxStyleManager = styleManager;
        window.dialogManager = dialog_manager.DialogManager.getInstance();
        if (window.BLMX_DEV_MODE) {
            console.log('[BLMX] å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼Œå·²åŠ è½½æµ‹è¯•æ•°æ®');
            console.log('[BLMX] å¯ç”¨çš„è°ƒè¯•å‘½ä»¤:');
            console.log('  window.blmxApp.showTestEntryTypes() - æ˜¾ç¤ºå¯ç”¨çš„æµ‹è¯•æ•°æ®ç±»å‹');
            console.log('  window.blmxApp.addTestEntry(ç±»å‹) - æ·»åŠ æŒ‡å®šç±»å‹çš„æµ‹è¯•æ•°æ®');
            console.log('  window.blmxApp.clearDebugData() - æ¸…é™¤æ‰€æœ‰æ•°æ®');
        }
    }
    catch (error) {
        console.error('[BLMX] åˆå§‹åŒ–å¤±è´¥:', error);
        // ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†æ›¿ä»£alert
        // ç¡®ä¿æ‰‹æœºå±å¹•å…ƒç´ å·²ç»å­˜åœ¨
        setTimeout(() => {
            const dialogManager = dialog_manager.DialogManager.getInstance();
            dialogManager.alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚', 'é”™è¯¯');
        }, 500); // å»¶è¿Ÿæ˜¾ç¤ºå¯¹è¯æ¡†ï¼Œç¡®ä¿DOMå·²ç»åŠ è½½
    }
});</script><style>@import url(https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap);
@import url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css);
/*! tailwindcss v4.1.13 | MIT License | https://tailwindcss.com */@font-face {font-family:"MyCustomFont";src:url("https://files.catbox.moe/er4wsg.ttf") format("truetype");font-display:swap;font-weight:normal;font-style:normal}:root{--text-color:#ffffff;--primary-blue:#72adf3;--light-blue:#a8cbeb;--ultra-light-blue:#e8f4fd;--blue-gradient-start:#accef2;--blue-gradient-end:#98c2f5;--soft-blue:#b8d4f0;--deep-blue:#2c5282;--wechat-green-icon:var(--primary-blue);--wechat-green-bubble:var(--light-blue);--wechat-bg:var(--ultra-light-blue);--link-color:var(--primary-blue);--footer-height:2.8125rem;--panel-height:14.0625rem;--sticker-size:120px;--bubble-shadow:0 2px 8px rgba(74,144,226,0.15);--text-primary:rgb(139,162,186);--text-secondary:#64748b;--border-color:#cbd5e1;--header-bg:linear-gradient(135deg,#f8faff 0%,#eef4ff 100%);--wechat-bubble-them-bg:#ffffff;--wechat-bubble-me-bg:var(--light-blue);--wechat-bubble-them-text:#333333;--wechat-bubble-me-text:#ffffff;--status-bar-color:#428af2;--checkbox-bg-unchecked:#ffffff;--checkbox-border-unchecked:var(--border-color);--checkbox-border-checked:var(--primary-blue);--checkbox-text-unchecked:var(--text-primary);--checkbox-shadow-unchecked:0 2px 6px var(--shadow-color-rgba);--checkbox-shadow-checked:0 4px 12px var(--shadow-color-rgba);--checkbox-hover-bg:var(--ultra-light-blue);--dynamic-island-color:#a0c4f4;--app-bg-color:#ffffff;--settings-bg-color:#f2f2f7;--settings-card-bg-color:#ffffff;--input-bg:#ffffff;--dialog-border-radius:1rem;--input-border-radius:0.5rem;--button-border-radius:0.5rem;--element-border-radius:0.5rem;--small-border-radius:0.25rem;--shadow-color:#4a90e2;--shadow-color-rgba:rgba(74,144,226,0.3);--settings-icon-color:#999999;--primary-gradient-light:#accef2;--primary-gradient-dark:#98c2f5;--shadow-r:74;--shadow-g:144;--shadow-b:226}@keyframes fadeIn{to{opacity:1}}@keyframes slideInUp{to{transform:translateY(0);opacity:1}}@keyframes slideInDown{to{transform:translateY(0);opacity:1}}@keyframes slideInLeft{to{transform:translateX(0);opacity:1}}@keyframes slideInRight{to{transform:translateX(0);opacity:1}}html{font-size:16px}@media (max-width:360px){html{font-size:4.4444444444vw}}body{margin:0;padding:.25rem;min-height:100vh;display:flex;justify-content:center;align-items:center;box-sizing:border-box;background:rgba(0,0,0,0);font-family:"MyCustomFont","Noto Sans SC",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,sans-serif}body.force-font-refresh{transform:translateZ(0);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}*{box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0);transition-timing-function:ease}.performance-optimized{will-change:transform,opacity;transform:translateZ(0);backface-visibility:hidden}@media (prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}@keyframes slideIn{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}@keyframes messageSlideIn{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}.fade-out{animation:fadeOut .5s forwards}.new-message{animation:slideIn .5s cubic-bezier(0.22,0.61,0.36,1)}.hidden{display:none !important}.invisible{visibility:hidden;opacity:0}.visible{visibility:visible;opacity:1}a,button,div[onclick],span[onclick],.clickable,.btn,.dialog-btn,.app-icon,.message-bubble,.contact-item,.moment-item,.sticker-item,.checkbox-btn{-webkit-tap-highlight-color:rgba(0,0,0,0) !important;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}.phone-frame{max-width:360px;width:100%;padding:.6rem;background:var(--phoneFrame,var(--primary-blue));border-radius:3.125rem;position:relative;box-shadow:0 15px 20px var(--shadow-color-rgba),0 8px 20px var(--shadow-color-rgba),0 3px 8px rgba(0,0,0,.1),inset 0 1px 0 hsla(0,0%,100%,.5),inset 0 -1px 0 hsla(0,0%,100%,.2),0 5px var(--shadow-color-rgba);transition:all .2s ease;transition:box-shadow .3s ease,background .3s ease}.phone-frame::before{content:"";position:absolute;top:-2px;left:-2px;right:-2px;bottom:-2px;border-radius:3.125rem;background:linear-gradient(45deg,var(--primary-blue),var(--blue-gradient-end),var(--blue-gradient-start),var(--primary-blue));background-size:400% 400%;animation:gradientFlow 3s ease infinite;z-index:-1}@keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}@media (max-width:480px),(prefers-reduced-motion:reduce){.phone-frame::before{animation:none !important;background:var(--primary-blue) !important}}.phone-screen{height:48.75rem;border-radius:2.8rem;overflow:hidden;position:relative;display:flex;flex-direction:column;background-color:var(--wechat-bg);box-shadow:inset 0 0 0 1px rgba(0,0,0,.08),inset 0 0 15px rgba(0,0,0,.03)}.phone-screen::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;border-radius:2.25rem;box-shadow:inset 0 1px 0 hsla(0,0%,100%,.2),inset 0 -1px 0 rgba(0,0,0,.1),inset 1px 0 0 hsla(0,0%,100%,.1),inset -1px 0 0 rgba(0,0,0,.1);pointer-events:none;z-index:1000}.dynamic-island{position:absolute;top:.625rem;left:50%;transform:translateX(-50%);width:8.4375rem;height:2rem;background:var(--dynamic-island-color);border-radius:1rem;z-index:100;cursor:pointer;transition:all .2s ease}.dynamic-island:hover{transform:translateX(-50%) scale(1.05);box-shadow:0 2px 8px var(--shadow-color-rgba)}.dynamic-island.generating-active{box-shadow:0 0 15px var(--shadow-color-rgba);animation:pulse-generating 1.5s infinite ease-in-out}.dynamic-island.fullscreen-active{animation:pulse-expand .6s ease-in-out}.dynamic-island.fullscreen-inactive{animation:pulse-contract .6s ease-in-out}@keyframes pulse-generating{0%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.05);box-shadow:0 0 20px var(--shadow-color-rgba)}100%{transform:translateX(-50%) scale(1)}}@keyframes pulse-expand{0%{transform:translateX(-50%) scale(1);box-shadow:0 0 0 rgba(0,0,0,0)}50%{transform:translateX(-50%) scale(1.2);box-shadow:0 0 20px var(--shadow-color-rgba)}100%{transform:translateX(-50%) scale(1);box-shadow:0 0 0 rgba(0,0,0,0)}}@keyframes pulse-contract{0%{transform:translateX(-50%) scale(1);box-shadow:0 0 0 rgba(0,0,0,0)}50%{transform:translateX(-50%) scale(0.8);box-shadow:0 0 20px var(--shadow-color-rgba)}100%{transform:translateX(-50%) scale(1);box-shadow:0 0 0 rgba(0,0,0,0)}}.generating-indicator{display:flex;justify-content:center;align-items:center;height:100%;gap:5px}.generating-dot{width:6px;height:6px;background-color:#fff;border-radius:50%;opacity:.8;animation:generating-dot-pulse 1.4s infinite ease-in-out}.generating-dot:nth-child(1){animation-delay:0s}.generating-dot:nth-child(2){animation-delay:.2s}.generating-dot:nth-child(3){animation-delay:.4s}@keyframes generating-dot-pulse{0%,100%{transform:scale(1);opacity:.6}50%{transform:scale(1.5);opacity:1}}:fullscreen body,:-webkit-full-screen body,:-moz-full-screen body,:-ms-fullscreen body{background:var(--background-color);margin:0;padding:0;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:100vh}@media (min-width:1920px)and (min-height:1080px){:fullscreen .phone-frame,:-webkit-full-screen .phone-frame,:-moz-full-screen .phone-frame,:-ms-fullscreen .phone-frame{width:max(650px,(100vh - 2rem)*.46);max-width:900px}}@media (max-width:360px){:fullscreen .phone-frame,:-webkit-full-screen .phone-frame,:-moz-full-screen .phone-frame,:-ms-fullscreen .phone-frame{margin:0;width:100%;height:100%;max-width:100%;max-height:100%}}:fullscreen .phone-frame::before,:-webkit-full-screen .phone-frame::before,:-moz-full-screen .phone-frame::before,:-ms-fullscreen .phone-frame::before{border-radius:3.125rem}@media (max-width:360px){:fullscreen .phone-frame::before,:-webkit-full-screen .phone-frame::before,:-moz-full-screen .phone-frame::before,:-ms-fullscreen .phone-frame::before{border-radius:1.5rem}}.phone-status-bar{position:absolute;top:.625rem;left:0;right:0;height:2rem;z-index:102;display:flex;justify-content:space-between;align-items:center;padding:0 1.5rem;pointer-events:none}.status-left{display:flex;align-items:center;gap:.4rem;color:var(--status-bar-color);font-size:.9em;font-weight:600}#current-time{display:inline-flex;align-items:center;height:1em;line-height:1}.status-right{display:flex;align-items:center;gap:.4rem;color:var(--status-bar-color);font-size:.9em;font-weight:600}.moon-icon,.signal-bars,.wifi-icon,.battery-icon{font-size:.85em;display:flex;align-items:center;justify-content:center;height:1em;line-height:1}.moon-icon{transform:translateY(0.5px)}#hidden-send-trigger{position:absolute;top:.625rem;right:1rem;width:80px;height:2rem;z-index:103;cursor:pointer}#delete-mode-trigger{position:absolute;top:.625rem;left:1rem;width:60px;height:2rem;z-index:103;cursor:pointer}#wechat-view{background-image:url("https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç™½è‰²_1.jpg");background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;flex-direction:column;height:100%}.wechat-header{flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:var(--header-bg);border-bottom:1px solid var(--border-color);padding-top:2.8125rem;position:relative;z-index:10}.wechat-header .back-btn,.wechat-header .options-btn{font-size:1.2em;color:var(--primary-blue);cursor:pointer;transition:all .2s ease}.wechat-header .back-btn:hover,.wechat-header .options-btn:hover{color:var(--deep-blue)}.wechat-header .options-btn{position:relative;display:inline-block}.wechat-header .contact-name{font-weight:600;background:var(--primary-blue);-webkit-background-clip:text;-webkit-text-fill-color:rgba(0,0,0,0);background-clip:text;font-size:1em;cursor:pointer;left:50%}.notification-dot{position:absolute;top:-4px;right:-4px;width:8px;height:8px;background-color:#ff3b30;border-radius:50%;border:1px solid #fff}.wechat-body{flex:1 1 auto;overflow-y:auto;padding:.9375rem .5rem;overflow-x:hidden;-webkit-overflow-scrolling:touch}.message-row{display:flex;margin-bottom:1.125rem;align-items:flex-start}.message-row.me{justify-content:flex-end}.message-row.new-message{animation:messageSlideIn .5s cubic-bezier(0.22,0.61,0.36,1)}.message-row.fade-out{animation:fadeOut .5s forwards}.message-row.long-press-active{transform:scale(0.95);transition:all .15s ease-out;z-index:100}.message-row.long-press-active .message-bubble{box-shadow:0 0 0 3px var(--primary-blue),0 8px 25px rgba(114,173,243,.4),inset 0 0 20px rgba(114,173,243,.1);background:linear-gradient(135deg,rgba(114,173,243,0.15) 0%,rgba(114,173,243,0.08) 100%);animation:longPressPulse .6s ease-in-out;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-user-drag:none;-khtml-user-drag:none;-moz-user-drag:none;-o-user-drag:none}.message-row.me.long-press-active::after{content:"ğŸ”„ æ¾å¼€æ’¤å›";position:absolute;top:-3rem;right:0;background:linear-gradient(135deg,rgba(0,0,0,0.9) 0%,rgba(0,0,0,0.8) 100%);color:#fff;padding:.5rem .75rem;border-radius:.5rem;font-size:.8rem;font-weight:600;white-space:nowrap;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3);animation:longPressTooltip .3s cubic-bezier(0.68,-0.55,0.265,1.55)}.message-row.me.long-press-active::after::before{content:"";position:absolute;bottom:-0.25rem;right:1rem;width:0;height:0;border-left:.25rem solid rgba(0,0,0,0);border-right:.25rem solid rgba(0,0,0,0);border-top:.25rem solid rgba(0,0,0,.9)}.message-row.double-click-active{transform:scale(1.05);transition:all .1s ease-out;z-index:100}.message-row.double-click-active .message-bubble{box-shadow:0 0 0 2px var(--primary-blue),0 4px 15px rgba(114,173,243,.3);background:linear-gradient(135deg,rgba(114,173,243,0.1) 0%,rgba(114,173,243,0.05) 100%);animation:doubleClickPulse .2s ease-in-out}.message-row.me.double-click-active::after{content:"ğŸ”„ åŒå‡»æ’¤å›";position:absolute;top:-2.5rem;right:0;background:linear-gradient(135deg,rgba(114,173,243,0.95) 0%,rgba(114,173,243,0.85) 100%);color:#fff;padding:.4rem .6rem;border-radius:.4rem;font-size:.75rem;font-weight:600;white-space:nowrap;z-index:1000;box-shadow:0 2px 8px rgba(114,173,243,.4);animation:doubleClickTooltip .2s ease-out}.message-row.me.double-click-active::after::before{content:"";position:absolute;bottom:-0.2rem;right:.8rem;width:0;height:0;border-left:.2rem solid rgba(0,0,0,0);border-right:.2rem solid rgba(0,0,0,0);border-top:.2rem solid rgba(114,173,243,.95)}@keyframes longPressPulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}@keyframes longPressTooltip{0%{opacity:0;transform:translateY(0.5rem) scale(0.8)}100%{opacity:1;transform:translateY(0) scale(1)}}@keyframes messageSlideIn{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}.message-avatar{width:2.25rem;height:2.25rem;border-radius:50%;flex-shrink:0;object-fit:cover;background-color:#ccc;cursor:pointer}.message-row.them .message-avatar{margin-right:.625rem}.message-row.me .message-avatar{margin-left:.625rem}.timestamp-row{text-align:center;margin:.5rem 0}.timestamp-text{display:inline-block;background:linear-gradient(135deg,var(--soft-blue) 0%,var(--light-blue) 100%);color:#fff;font-size:.7em;padding:.3rem .8rem;border-radius:1rem;font-weight:500;box-shadow:0 2px 6px var(--shadow-color-rgba)}.typing-indicator{display:flex;margin-bottom:1.125rem;align-items:flex-start}.typing-indicator .message-avatar{margin-right:.625rem;width:2.25rem;height:2.25rem;border-radius:50%;flex-shrink:0}.typing-indicator .message-bubble{display:flex;align-items:center;justify-content:center;padding:.75rem 1rem;background:linear-gradient(135deg,#ffffff 0%,#f8faff 100%);color:var(--text-primary);border:1px solid var(--border-color);border-bottom-left-radius:.4rem;box-shadow:var(--bubble-shadow)}.typing-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:var(--text-secondary);margin:0 2px;animation:typing-bounce 1.4s infinite ease-in-out both}.typing-dot:nth-child(1){animation-delay:-0.32s}.typing-dot:nth-child(2){animation-delay:-0.16s}.typing-dot:nth-child(3){animation-delay:0s}@keyframes typing-bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}.message-content-container{display:flex;flex-direction:column}.message-row.me .message-content-container{align-items:flex-end}.message-row.them .message-content-container{align-items:flex-start}#wechat-view.delete-mode .wechat-body{padding-left:25px;padding-right:25px}#wechat-view.delete-mode .message-row,#wechat-view.delete-mode .timestamp-row,#wechat-view.delete-mode .event-log-row{cursor:pointer;position:relative}#wechat-view.delete-mode [data-log-index]::before{content:"Ã—";position:absolute;left:-22px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,var(--blue-gradient-start) 0%,var(--primary-blue) 100%);color:#fff;border-radius:50%;width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:normal;box-shadow:0 2px 4px var(--shadow-color-rgba);transition:all .2s ease;z-index:10;text-align:center;font-family:Arial,sans-serif}#wechat-view.delete-mode .message-row.me[data-log-index]::before{left:auto;right:-22px}#wechat-view.delete-mode [data-log-index]:hover::before{transform:translateY(-50%) scale(1.1);box-shadow:0 4px 8px var(--shadow-color-rgba)}.event-log-row{text-align:center;margin:.5rem 0;width:100%}.event-log-container{display:inline-flex;flex-direction:column;align-items:center;max-width:90%;margin:0 auto}.event-time-text{background:linear-gradient(135deg,var(--soft-blue) 0%,var(--light-blue) 100%);color:#fff;font-weight:500;box-shadow:0 2px 6px var(--shadow-color-rgba);display:inline-flex;align-items:center;justify-content:center;font-size:.7em;padding:.3rem .8rem;border-radius:1rem;-webkit-user-select:none;user-select:none;margin-bottom:.25rem;position:relative;z-index:2;transition:none}.event-time-text.has-desc{position:relative;padding-right:1.55em;display:flex;align-items:center}.event-time-text.has-desc::after{content:"ïƒ—";font-family:"Font Awesome 6 Free";font-weight:900;position:absolute;right:.4rem;font-size:.75em;opacity:.9;margin-top:0;transform:translateY(-1px);transition:transform .3s ease}.event-time-text.clickable{cursor:pointer;position:relative}.event-time-text.clickable:hover{box-shadow:0 3px 8px var(--shadow-color-rgba)}.event-time-text.clickable:hover::after{opacity:1}.event-time-text.clickable::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;border-radius:1rem;box-shadow:inset 0 0 3px hsla(0,0%,100%,.35);opacity:.6;transition:opacity .2s ease;pointer-events:none}.event-time-text.clickable:active{transform:scale(0.98);box-shadow:0 1px 4px var(--shadow-color-rgba)}.event-time-text.clickable:active::before{opacity:.9;box-shadow:inset 0 0 5px hsla(0,0%,100%,.7)}.event-time-text.clickable:hover::before{opacity:.75;box-shadow:inset 0 0 4px hsla(0,0%,100%,.5)}.event-time-text.has-desc+.event-description.expanded~.event-time-text.has-desc::after,.event-time-text.has-desc:has(+.event-description.expanded)::after{transform:rotate(180deg) translateY(1px)}.event-description{font-size:.75em;color:var(--text-secondary);background:hsla(0,0%,100%,.9);padding:.5rem .75rem;border-radius:.5rem;margin-top:.25rem;width:auto;min-width:-moz-fit-content;min-width:fit-content;max-width:100%;text-align:center;line-height:1.5;box-shadow:0 1px 3px rgba(0,0,0,.1);display:none;position:relative;z-index:1;white-space:normal;word-wrap:break-word;word-break:break-word;overflow-wrap:break-word;overflow:visible;text-overflow:unset}.event-description.expanded{display:block}body[data-theme=custom] .event-description{background:var(--settings-card-bg-color);color:var(--text-primary);border:1px solid var(--border-color);backdrop-filter:blur(2px);box-shadow:0 2px 8px var(--shadow-color-rgba)}body.dark-mode[data-theme=custom] .event-description{background:var(--settings-card-bg-color);color:var(--text-primary);border:1px solid var(--border-color);backdrop-filter:blur(4px);box-shadow:0 2px 8px var(--shadow-color-rgba)}@keyframes doubleClickPulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}@keyframes doubleClickTooltip{0%{opacity:0;transform:translateY(0.3rem) scale(0.9)}100%{opacity:1;transform:translateY(0) scale(1)}}.message-bubble{position:relative;padding:.75rem 1rem;border-radius:1.2rem;max-width:75%;font-size:.9em;line-height:1.4;word-wrap:normal;overflow-wrap:break-word;-webkit-user-select:none;user-select:none;box-shadow:var(--bubble-shadow);transition:all .2s ease}.message-bubble::after{display:none}.message-bubble img:not(.sticker-img){max-width:10rem;max-height:10rem;display:block;border-radius:.5rem}.message-row.them .message-bubble{background:linear-gradient(315deg,#f8faff 0%,#ffffff 100%);color:var(--wechat-bubble-them-text);border:1px solid var(--border-color);border-bottom-left-radius:.4rem}.message-row.me .message-bubble{background:linear-gradient(315deg,var(--blue-gradient-end) 0%,var(--blue-gradient-start) 100%);color:var(--wechat-bubble-me-text);border-bottom-right-radius:.4rem;box-shadow:0 4px 12px var(--shadow-color-rgba)}.recall-notice-container{display:inline-flex;flex-direction:column;align-items:center}.recall-notice-text{background:linear-gradient(135deg,var(--soft-blue) 0%,var(--light-blue) 100%);color:#fff;font-size:.7em;padding:.3rem .8rem;border-radius:1rem;cursor:pointer;transition:all .2s ease}.recall-notice-text:hover{transform:translateY(-1px);box-shadow:0 4px 8px var(--shadow-color-rgba)}.recall-content{color:#888;font-size:.75em;padding:0;max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out}.recall-content.expanded{max-height:6.25rem;padding:.3125rem 0 0 0}.event-log-row{text-align:center;margin:.5rem 0}.event-log-container{display:inline-flex;flex-direction:column;align-items:center}.event-time-text{background:linear-gradient(135deg,var(--soft-blue) 0%,var(--light-blue) 100%);color:#fff;font-weight:500;box-shadow:0 2px 6px var(--shadow-color-rgba);display:inline-flex;align-items:center;justify-content:center;font-size:.7em;padding:.3rem .8rem;border-radius:1rem;transition:all .2s ease}.event-time-text.blue-theme{box-shadow:0 2px 6px rgba(114,173,243,.4)}.event-time-text.pink-theme{box-shadow:0 2px 6px rgba(243,114,182,.4)}.event-time-text.green-theme{box-shadow:0 2px 6px rgba(72,187,120,.4)}.event-time-text.purple-theme{box-shadow:0 2px 6px rgba(159,122,234,.4)}.event-time-text.orange-theme{box-shadow:0 2px 6px rgba(237,137,54,.4)}.event-time-text.system-message{background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);padding:.5rem 1rem;border-radius:1rem;color:#fff;font-size:.85em;max-width:80%;text-align:center}.event-time-text.has-desc{cursor:pointer}.message-row .message-bubble.sticker-bubble,.message-row .message-bubble.image-desc-bubble,.message-row .message-bubble.image-url-bubble,.message-row .message-bubble.location-bubble,.message-row .message-bubble.transfer-bubble,.message-row .message-bubble.file-bubble{content:none;background:rgba(0,0,0,0) !important;padding:0;border:none;box-shadow:none}.message-row .message-bubble.location-bubble,.message-row .message-bubble.transfer-bubble,.message-row .message-bubble.file-bubble,.message-row .message-bubble.gift-bubble{width:12.5rem;max-width:12.5rem}.message-row .message-bubble.sticker-bubble img{border-radius:1.2rem}.sticker-container{display:inline-flex;justify-content:center;align-items:center;width:auto;height:auto;max-width:var(--sticker-size);max-height:var(--sticker-size)}.sticker-img{display:block;max-width:100%;max-height:100%;object-fit:contain}.message-bubble.voice-bubble{display:flex;align-items:center;cursor:pointer;min-width:5rem;padding:.75rem 1rem}.message-row.them .message-bubble.voice-bubble{background:linear-gradient(315deg,#f8faff 0%,#ffffff 100%) !important;border:1px solid var(--border-color) !important}body.dark-mode .message-row.them .message-bubble.voice-bubble{background:linear-gradient(135deg,#3c3c3c 0%,#2c2c2c 100%) !important;border:1px solid var(--border-color) !important;color:#f0f0f0}body.dark-mode .message-row.them .voice-bubble .voice-icon{color:var(--light-blue)}.voice-bubble .voice-icon{font-size:1.1em;margin:0 .5rem}.message-row.them .voice-bubble .voice-icon{color:var(--primary-blue);transform:rotate(90deg)}.message-row.me .voice-bubble .voice-icon{color:var(--wechat-bubble-me-text);transform:rotate(270deg)}.voice-text-content{display:none;background-color:#fff;padding:.5rem .625rem;border-radius:.3125rem;border:.0625rem solid #e5e5e5;max-width:75%;font-size:.9em;line-height:1.4;color:var(--text-primary);word-wrap:normal;overflow-wrap:break-word;-webkit-user-select:text;user-select:text;margin-top:.3125rem;box-shadow:0 .0625rem .125rem rgba(0,0,0,.1)}.message-row.voice-text-visible .voice-text-content{display:block}.image-desc-content{width:8.4375rem;height:8.4375rem;backdrop-filter:blur(10px);background-color:hsla(0,0%,100%,.5);border:.0625rem solid hsla(0,0%,100%,.2);border-radius:1.2rem;padding:.5rem;color:var(--text-primary);font-weight:normal;overflow-y:auto;box-sizing:border-box;font-size:.9em;display:flex;flex-direction:column;box-shadow:0 4px 12px var(--shadow-color-rgba),0 2px 6px var(--shadow-color-rgba);transition:all .2s ease}.text-wrapper{margin:auto;text-align:center;line-height:1.4;word-wrap:break-word;max-height:100%}.location-bubble .location-card{background-color:#fff;border-radius:1.2rem;overflow:hidden;box-shadow:0 4px 12px var(--shadow-color-rgba),0 2px 6px var(--shadow-color-rgba);transition:all .2s ease}.location-content{padding:.5rem}.location-content .location-title{font-size:1em;color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.location-content .location-subtitle{font-size:.75em;color:#888}.location-map-placeholder{height:5.625rem;position:relative;background-color:#f0f8ff;overflow:hidden}.location-map-placeholder::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-image:repeating-linear-gradient(45deg,#d2e1f2 0,#d2e1f2 4px,transparent 4px,transparent 8px),repeating-linear-gradient(135deg,#9bdaf7 0,#9bdaf7 3px,transparent 3px,transparent 7px),linear-gradient(to bottom,#bad8fb 0%,#bad8fb 100%),linear-gradient(to bottom,#d0daf4 0%,#d0daf4 100%),linear-gradient(to right,#bad8fb 0%,#bad8fb 100%),linear-gradient(to right,#d0daf4 0%,#dbe8f3 100%),radial-gradient(ellipse at 20% 85%,#daf9f3 30%,transparent 31%),radial-gradient(ellipse at 80% 30%,#d0ecf4 40%,transparent 41%);background-size:40% 35%,30% 30%,10px 100%,6px 100%,100% 10px,100% 6px,100% 100%,100% 100%;background-position:-5% 110%,100% 0%,70% center,70% center,center 35%,center 35%,0 0,0 0;background-repeat:no-repeat}.location-map-placeholder::after{content:"ï…";font-family:"Font Awesome 6 Free";font-weight:900;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.8em;color:var(--primary-blue);filter:drop-shadow(0 0 8px rgba(114,173,243,0.6)) drop-shadow(0 0 4px rgba(114,173,243,0.4)) drop-shadow(0 2px 4px rgba(255,255,255,0.8));z-index:10;animation:pinPulse 2s ease-in-out infinite}.location-map-placeholder:hover::before{opacity:.9;transition:opacity .3s ease}@keyframes pinPulse{0%,100%{transform:translate(-50%,-50%) scale(1);filter:drop-shadow(0 0 8px rgba(114,173,243,0.6)) drop-shadow(0 0 4px rgba(114,173,243,0.4)) drop-shadow(0 2px 4px rgba(255,255,255,0.8))}50%{transform:translate(-50%,-50%) scale(1.1);filter:drop-shadow(0 0 12px rgba(114,173,243,0.8)) drop-shadow(0 0 6px rgba(114,173,243,0.6)) drop-shadow(0 3px 6px rgba(255,255,255,0.9))}}.transfer-bubble .transfer-card{border-radius:1.2rem;overflow:hidden;width:100%}.transfer-bubble .transfer-card.transfer-initial{background:linear-gradient(135deg,#fa9e3b 0%,#f8802a 50%,#f76a1c 100%);box-shadow:0 4px 15px rgba(247,106,28,.3),0 2px 8px rgba(247,106,28,.2),inset 0 1px 0 hsla(0,0%,100%,.2);color:#fff}.transfer-bubble .transfer-card.them{cursor:pointer;transition:all .2s ease}.transfer-bubble .transfer-card.them:hover{transform:translateY(-1px);box-shadow:0 6px 12px rgba(247,106,28,.4)}.transfer-bubble .transfer-card.transfer-receipt{background:linear-gradient(135deg,#ffd0a1 0%,#ffbe80 30%,#ffbe80 45%,#ffd0a1 100%);color:#fff;box-shadow:0 4px 16px rgba(247,106,28,.25),0 2px 6px rgba(247,106,28,.15),inset 0 1px 1px hsla(0,0%,100%,.2)}.transfer-content{display:flex;align-items:center;padding:.75rem}.transfer-icon-image{width:2.25rem;height:2.25rem;flex-shrink:0;filter:brightness(0) invert(1)}.transfer-details{margin-left:.75rem;flex-grow:1}.transfer-details .amount{font-size:1.1em;font-weight:bold}.transfer-details .note,.transfer-details .status-text{font-size:.8em;opacity:.9}.transfer-footer{font-size:.75em;padding:.1875rem .75rem;color:hsla(0,0%,100%,.9);border-top:1px solid hsla(0,0%,100%,.15);background:hsla(0,0%,100%,.05)}.transfer-initial .transfer-footer{color:hsla(0,0%,100%,.85);border-top:1px solid hsla(0,0%,100%,.2);background:hsla(0,0%,100%,.05)}.transfer-receipt .transfer-footer{color:#f5faff;border-top:1px solid hsla(0,0%,100%,.2);background:hsla(0,0%,100%,.05)}.message-row .message-bubble.gift-bubble{padding:0;width:12.5rem;max-width:12.5rem;overflow:hidden;border-radius:1.2rem}.gift-bubble .gift-card{border-radius:1.2rem;overflow:hidden;width:100%}.gift-bubble .gift-card.gift-initial{background:linear-gradient(135deg,#fa9e3b 0%,#f8802a 50%,#f76a1c 100%);box-shadow:0 4px 15px rgba(247,106,28,.3),0 2px 8px rgba(247,106,28,.2),inset 0 1px 0 hsla(0,0%,100%,.2);color:#fff;animation:transferGlow 3s ease-in-out infinite alternate}.gift-bubble .gift-card.them{cursor:pointer;transition:all .2s ease}.gift-bubble .gift-card.them:hover{transform:translateY(-1px);box-shadow:0 6px 12px rgba(247,106,28,.4)}.gift-bubble .gift-card.gift-receipt{background:linear-gradient(135deg,#ffd0a1 0%,#ffbe80 30%,#ffbe80 45%,#ffd0a1 100%);color:#fff;box-shadow:0 4px 16px rgba(247,106,28,.25),0 2px 6px rgba(247,106,28,.15),inset 0 1px 1px hsla(0,0%,100%,.2)}.gift-clickable{cursor:pointer}.gift-accepted{background-color:#355a96 !important}.gift-content{padding:.75rem;display:flex;align-items:center;gap:.75rem;color:#fff}.gift-icon-emoji{font-size:2.2em;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2))}.gift-icon-image{width:2.25rem;height:2.25rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2))}.gift-details{flex-grow:1}.gift-details .gift-name{font-weight:500}.gift-details .gift-price,.gift-details .gift-status-text{font-size:.8em;opacity:.9}.gift-footer{color:hsla(0,0%,100%,.9);font-size:.75em;padding:.1875rem .75rem;border-top:1px solid hsla(0,0%,100%,.15);background:hsla(0,0%,100%,.05)}.gift-receipt .gift-footer{color:#f5faff;border-top:1px solid hsla(0,0%,100%,.2);background:hsla(0,0%,100%,.05)}@keyframes transferGlow{from{box-shadow:0 4px 15px rgba(247,106,28,.3),0 2px 8px rgba(247,106,28,.2),inset 0 1px 0 hsla(0,0%,100%,.2)}to{box-shadow:0 6px 20px rgba(247,106,28,.4),0 3px 12px rgba(247,106,28,.3),inset 0 1px 0 hsla(0,0%,100%,.3)}}.file-bubble .file-card{background-color:#fff;border-radius:1.2rem;overflow:hidden;width:100%;box-shadow:0 4px 12px var(--shadow-color-rgba),0 2px 6px var(--shadow-color-rgba);transition:all .2s ease}.file-content{display:flex;align-items:center;padding:.75rem;gap:.75rem}.file-icon{font-size:2.5em;color:var(--primary-blue);flex-shrink:0}.file-details .file-name{font-size:.9em;color:var(--text-primary);font-weight:500;word-break:break-all}.file-footer{background-color:#f7fafc;color:#888;font-size:.75em;padding:.1875rem .75rem;border-top:.0625rem solid #eaeaea}body.dark-mode .message-row.them .voice-bubble .voice-icon{color:var(--light-blue)}body.dark-mode .voice-text-content{background-color:#2c2c2c;border-color:#3c3c3c;color:#f0f0f0;box-shadow:0 .0625rem .125rem rgba(0,0,0,.3)}body.dark-mode .image-desc-content{background-color:rgba(30,30,30,.7);border:.0625rem solid rgba(60,60,60,.4);color:#f0f0f0;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.2)}body.dark-mode .location-bubble .location-card{background-color:#2c2c2c;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}body.dark-mode .location-content .location-title{color:#f0f0f0}body.dark-mode .location-content .location-subtitle{color:#aaa}body.dark-mode .file-bubble .file-card{background-color:#2c2c2c;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}body.dark-mode .file-details .file-name{color:#f0f0f0}body.dark-mode .file-footer{background-color:#232323;color:#aaa;border-top:.0625rem solid #3c3c3c}body.dark-mode .event-description.expanded{background-color:rgba(50,50,50,.9);color:#f0f0f0;box-shadow:0 1px 4px rgba(0,0,0,.3)}.wechat-input-area{flex-shrink:0;background:var(--header-bg);position:relative;z-index:10}.wechat-footer{display:flex;align-items:center;gap:.5rem;padding:.75rem;border-top:1px solid var(--border-color);box-sizing:border-box;flex-shrink:0;background:var(--header-bg);position:relative;z-index:10}.wechat-footer .footer-icon{font-size:1.4em;color:var(--primary-blue) !important;cursor:pointer;transition:all .2s ease;padding:.3rem;border-radius:.5rem;flex-shrink:0}.wechat-footer .footer-icon:hover{background:var(--ultra-light-blue);transform:scale(1.1)}.wechat-footer .text-input{flex-grow:1;border:1px solid var(--border-color);background:#fff;padding:.75rem 1rem;border-radius:1.5rem;font-size:.9em;transition:all .2s ease;color:var(--text-primary);min-width:0}.wechat-footer .text-input:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 3px var(--shadow-color-rgba)}.wechat-footer .text-input::placeholder{color:var(--text-secondary)}.wechat-footer .send-btn{background:var(--primary-blue);color:#fff;border:none;width:2rem;height:2rem;border-radius:50%;font-size:1em;cursor:pointer;box-shadow:0 4px 12px var(--shadow-color-rgba);transition:all .2s ease;display:flex;align-items:center;justify-content:center;padding:0;line-height:1;flex-shrink:0}.wechat-footer .send-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px var(--shadow-color-rgba)}.wechat-footer .send-btn{background:linear-gradient(135deg,#09e675 0%,#07c160 50%,#06ad56 100%)}.single-color-icon .wechat-footer .send-btn{background:linear-gradient(135deg,var(--primary-gradient-light) 0%,var(--primary-blue) 50%,var(--primary-gradient-dark) 100%)}.panel-container{height:0;overflow:hidden;transition:height .3s ease}.panel-container.active{height:var(--panel-height)}.panel-view{display:none;height:100%;overflow-y:auto;padding:1.125rem .75rem;box-sizing:border-box;position:relative}.panel-view.active{display:block}.features-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1.125rem}.feature-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;position:relative}.feature-item:hover .feature-icon{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-color-rgba);border-color:var(--primary-blue)}.feature-icon{width:3.375rem;height:3.375rem;background-color:#fff;border-radius:.5rem;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);box-shadow:0 2px 8px var(--shadow-color-rgba);transition:all .2s ease;margin-bottom:.4375rem}.feature-icon img,.feature-icon .fas,.feature-icon .far,.feature-icon .fab{max-width:100%;max-height:100%;border-radius:.5rem;object-fit:cover;font-size:1.8em}.feature-icon .theme-icon{color:var(--primary-blue);font-size:1.8em}.feature-icon .fa-plus,.feature-icon .fa-trash-alt{color:var(--primary-blue) !important}.feature-label{font-size:.75em;color:#888}.feature-item .sticker-checkbox{position:absolute;opacity:0;width:0;height:0;pointer-events:none}.feature-item .sticker-checkbox-button{position:absolute;top:.25rem;right:.25rem;width:1.5rem;height:1.5rem;border:1px solid var(--checkbox-border-unchecked);border-radius:.375rem;background:var(--checkbox-bg-unchecked);cursor:pointer;transition:all .2s ease;display:none;z-index:10}.feature-item .sticker-checkbox-button.checked{border:2px solid var(--checkbox-border-checked);background:var(--checkbox-bg-unchecked)}.feature-item .sticker-checkbox-button.checked::after{content:"âœ“";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.75rem;font-weight:bold;color:var(--checkbox-border-checked)}@media (hover:hover){.feature-item .sticker-checkbox-button:hover{border-color:var(--checkbox-border-checked);background:var(--checkbox-hover-bg)}}.feature-item:has(.sticker-checkbox:checked) .feature-icon{border:2px solid var(--checkbox-border-checked);box-shadow:0 0 0 2px var(--shadow-color-rgba);transform:scale(0.95);opacity:.8}.feature-item:has(.sticker-checkbox:checked) .feature-label{color:var(--checkbox-border-checked);font-weight:600}#wechat-view.delete-mode .wechat-body{padding-left:25px;padding-right:25px}#wechat-view.delete-mode .message-row,#wechat-view.delete-mode .timestamp-row,#wechat-view.delete-mode .event-log-row{cursor:pointer;position:relative}#wechat-view.delete-mode [data-log-index]::before{content:"Ã—";position:absolute;left:-22px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,var(--blue-gradient-start) 0%,var(--primary-blue) 100%);color:#fff;border-radius:50%;width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:normal;box-shadow:0 2px 6px var(--shadow-color-rgba);transition:all .2s ease;line-height:1;text-align:center;font-family:Arial,sans-serif}#wechat-view.delete-mode .message-row.me[data-log-index]::before{left:auto;right:-22px}#wechat-view.delete-mode [data-log-index]:hover::before{transform:translateY(-50%) scale(1.1);box-shadow:0 4px 8px var(--shadow-color-rgba)}.app-view{position:absolute;top:0;left:0;right:0;bottom:0;z-index:60;border-radius:2.25rem;visibility:hidden;opacity:0;transition:opacity .3s ease,visibility .3s ease;display:flex;flex-direction:column;backface-visibility:hidden}.app-view.active{visibility:visible;opacity:1;z-index:80}.app-screen{padding:3.75rem 1rem 1.375rem 1rem;flex-grow:1;background-image:url("https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç™½è‰²_1.jpg");background-size:cover;background-position:center}.app-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}.app-icon{display:flex;flex-direction:column;align-items:center;text-align:center;text-decoration:none;cursor:pointer}.app-icon:hover .icon-image{transform:scale(1.05)}.app-icon .icon-image{width:4.0625rem;height:4.0625rem;background-color:var(--primary-blue);border-radius:22.5%;margin-bottom:.4375rem;background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;font-size:2.2em;transition:all .2s ease}.app-icon .app-name{color:var(--text-color);font-size:.75em;font-weight:400;text-shadow:0 .0625rem .125rem rgba(0,0,0,.5)}.icon-wechat,.icon-settings{background:linear-gradient(135deg,var(--blue-gradient-start) 0%,var(--blue-gradient-end) 100%);color:#fff;box-shadow:0 4px 12px var(--shadow-color-rgba)}.icon-wechat{background:linear-gradient(135deg,#09e675 0%,#07c160 50%,#06ad56 100%) !important}.icon-settings{background:linear-gradient(135deg,#a8a8a8 0%,#8a8a8a 50%,#777777 100%) !important}.single-color-icon .icon-wechat,.single-color-icon .icon-settings{background:linear-gradient(135deg,var(--primary-gradient-light) 0%,var(--primary-blue) 50%,var(--primary-gradient-dark) 100%) !important}#settings-view{background-color:var(--settings-bg-color)}.settings-header{flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:var(--header-bg);border-bottom:1px solid var(--border-color);padding-top:2.8125rem;position:relative;z-index:10}.settings-header .back-btn{font-size:1.2em;color:var(--primary-blue);cursor:pointer}.settings-header .title{font-weight:600;color:var(--text-primary);font-size:1em;position:absolute;left:50%;transform:translateX(-50%)}.settings-body{flex-grow:1;padding:1.25rem;overflow-y:auto}.settings-card{background-color:var(--settings-card-bg-color);border-radius:var(--element-border-radius);padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.05)}.settings-card p{font-size:.9em;line-height:1.6;color:var(--text-primary);margin:0 0 1rem 0}.settings-card p:last-child{margin-bottom:0}.settings-card .highlight{color:#e6a23c;font-weight:bold}.settings-card a{color:var(--primary-blue)}.settings-card a:hover{text-decoration:underline}.settings-card li{border-bottom-color:var(--border-color)}.settings-card li a{color:var(--text-primary)}#show-last-ai-response-btn,#show-last-sent-prompt-btn{background-color:var(--settings-card-bg-color);color:var(--text-primary)}#custom-theme-btn{transition:all .2s ease;position:relative;z-index:10}#custom-theme-btn:hover{background:var(--deep-blue) !important;transform:translateY(-1px);box-shadow:0 4px 12px var(--shadow-color-rgba)}#custom-theme-btn:active{transform:translateY(0)}body.dark-mode{background-color:rgba(0,0,0,0)}body.dark-mode .app-view{background-color:var(--app-bg-color)}body.dark-mode .settings-card{background-color:var(--settings-card-bg-color)}body.dark-mode .settings-card p,body.dark-mode .settings-card a{color:var(--text-primary)}body.dark-mode .settings-card li{border-bottom-color:var(--border-color)}body.dark-mode .settings-card li a{color:var(--text-primary)}body.dark-mode #show-last-ai-response-btn,body.dark-mode #show-last-sent-prompt-btn{background-color:var(--settings-card-bg-color);color:var(--text-primary)}.phone-size-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background-color:var(--settings-card-bg-color);border:1px solid var(--border-color);border-radius:var(--element-border-radius);padding:.75rem .5rem;cursor:pointer;transition:all .2s ease;gap:.5rem;color:var(--text-primary)}.phone-size-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-color-rgba)}.phone-size-btn.phone-size-active{border-color:var(--primary-blue);background-color:rgba(var(--shadow-r),var(--shadow-g),var(--shadow-b),0.05);box-shadow:0 2px 8px var(--shadow-color-rgba)}body.dark-mode .phone-size-btn{background-color:#3c3c3c;border-color:#505050;color:silver}body.dark-mode .phone-size-btn:hover{background-color:#4a4a4a;border-color:#606060}body.dark-mode .phone-size-btn.phone-size-active{background-color:#505050;border-color:var(--primary-blue);color:#e0e0e0}body[data-theme=custom] .phone-size-btn{background-color:var(--settings-card-bg-color);border-color:var(--border-color);color:var(--text-primary)}body[data-theme=custom] .phone-size-btn:hover{background-color:var(--ultra-light-blue);border-color:var(--primary-blue)}body[data-theme=custom] .phone-size-btn.phone-size-active{background-color:rgba(var(--shadow-r),var(--shadow-g),var(--shadow-b),0.1);border-color:var(--primary-blue);color:var(--primary-blue)}.size-icon{width:1.5rem;background-color:var(--text-secondary);border-radius:.125rem;transition:all .2s ease}body.dark-mode .size-icon{background-color:silver}body.dark-mode .phone-size-active .size-icon{background-color:var(--primary-blue)}body[data-theme=custom] .size-icon{background-color:var(--text-secondary)}body[data-theme=custom] .phone-size-active .size-icon{background-color:var(--primary-blue)}.size-label{font-size:.8em;font-weight:500;text-align:center}.sticker-size-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background-color:var(--settings-card-bg-color);border:1px solid var(--border-color);border-radius:var(--element-border-radius);padding:.75rem .5rem;cursor:pointer;transition:all .2s ease;gap:.5rem;color:var(--text-primary)}.sticker-size-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-color-rgba)}.sticker-size-btn.sticker-size-active{border-color:var(--primary-blue);background-color:rgba(var(--shadow-r),var(--shadow-g),var(--shadow-b),0.05);box-shadow:0 2px 8px var(--shadow-color-rgba)}.sticker-size-icon{width:10px;background-color:var(--primary-blue);border-radius:var(--small-border-radius)}.sticker-size-label{font-size:.8em;color:var(--text-primary);font-weight:500}body.dark-mode .sticker-size-btn{background-color:#3c3c3c;border-color:#505050;color:silver}body.dark-mode .sticker-size-btn:hover{background-color:#4a4a4a;border-color:#606060}body.dark-mode .sticker-size-btn.sticker-size-active{background-color:#505050;border-color:var(--primary-blue);color:#e0e0e0}body.dark-mode .sticker-size-icon{background-color:silver}body.dark-mode .sticker-size-active .sticker-size-icon{background-color:var(--primary-blue)}body[data-theme=custom] .sticker-size-btn{background-color:var(--settings-card-bg-color);border-color:var(--border-color);color:var(--text-primary)}body[data-theme=custom] .sticker-size-btn:hover{background-color:var(--ultra-light-blue);border-color:var(--primary-blue)}body[data-theme=custom] .sticker-size-btn.sticker-size-active{background-color:rgba(var(--shadow-r),var(--shadow-g),var(--shadow-b),0.1);border-color:var(--primary-blue);color:var(--primary-blue)}body[data-theme=custom] .sticker-size-icon{background-color:var(--text-secondary)}body[data-theme=custom] .sticker-size-active .sticker-size-icon{background-color:var(--primary-blue)}.font-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:.5rem;padding:.75rem .5rem;border:2px solid #e0e0e0;border-radius:var(--element-border-radius);background:#f8f9fa;cursor:pointer;transition:all .3s ease;min-height:4rem}.font-btn:hover{border-color:var(--primary-blue);background:#f0f7ff}.font-btn.font-active{border-color:var(--primary-blue);background:#e8f4fd}.font-btn.font-active .font-label{color:var(--primary-blue);font-weight:600}.font-icon{font-size:1.2em;margin-bottom:.25rem}.font-label{font-size:.8em;color:var(--text-primary);font-weight:500;text-align:center}body.dark-mode .font-btn{background:#2a2a2a;border-color:#404040}body.dark-mode .font-btn:hover{background:#333;border-color:var(--primary-blue)}body.dark-mode .font-btn.font-active{background:#1a3a5c;border-color:var(--primary-blue)}.fullscreen-size-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background-color:var(--settings-card-bg-color);border:1px solid var(--border-color);border-radius:var(--element-border-radius);padding:.75rem .5rem;cursor:pointer;transition:all .2s ease;gap:.5rem;color:var(--text-primary)}.fullscreen-size-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-color-rgba)}.fullscreen-size-btn.fullscreen-size-active{border-color:var(--primary-blue);background-color:rgba(var(--shadow-r),var(--shadow-g),var(--shadow-b),0.05);box-shadow:0 2px 8px var(--shadow-color-rgba)}.fullscreen-size-icon{font-size:1.2em;display:block}.fullscreen-size-label{font-size:.8em;font-weight:500;text-align:center}body.dark-mode .fullscreen-size-btn{background-color:#3c3c3c;border-color:#505050;color:silver}body.dark-mode .fullscreen-size-btn:hover{background-color:#4a4a4a;border-color:#606060}body.dark-mode .fullscreen-size-btn.fullscreen-size-active{background-color:#505050;border-color:var(--primary-blue);color:#e0e0e0}body[data-theme=custom] .fullscreen-size-btn{background-color:var(--settings-card-bg-color);border-color:var(--border-color);color:var(--text-primary)}body[data-theme=custom] .fullscreen-size-btn:hover{background-color:var(--ultra-light-blue);border-color:var(--primary-blue)}body[data-theme=custom] .fullscreen-size-btn.fullscreen-size-active{background-color:rgba(var(--shadow-r),var(--shadow-g),var(--shadow-b),0.1);border-color:var(--primary-blue);color:var(--primary-blue)}#fullscreen-size-slider{-webkit-appearance:none;appearance:none;height:.25rem;background:#ddd;border-radius:.125rem;outline:none;flex:1}#fullscreen-size-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:1rem;height:1rem;border-radius:50%;background:var(--primary-blue);cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.2)}#fullscreen-size-slider::-moz-range-thumb{width:1rem;height:1rem;border-radius:50%;background:var(--primary-blue);cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.2)}#fullscreen-size-input{width:4rem;padding:.25rem .5rem;border:1px solid #ddd;border-radius:.25rem;text-align:center;font-size:.85em;background:#fff;color:var(--text-primary)}#fullscreen-size-input:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 2px rgba(114,173,243,.2)}body.dark-mode #fullscreen-size-slider{background:#404040}body.dark-mode #fullscreen-size-slider::-webkit-slider-thumb{border-color:#2a2a2a}body.dark-mode #fullscreen-size-slider::-moz-range-thumb{border-color:#2a2a2a}body.dark-mode #fullscreen-size-input{background:#2a2a2a;border-color:#404040;color:#fff}body.dark-mode #fullscreen-size-input:focus{border-color:var(--primary-blue)}#moments-view{background:linear-gradient(180deg,#ffffff 0%,var(--ultra-light-blue) 100%);color:var(--text-primary)}.moments-header{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:var(--header-bg);border-bottom:1px solid var(--border-color);padding-top:2.8125rem;flex-shrink:0;position:relative}.moments-header .title{font-weight:600;font-size:1em;color:var(--primary-blue);position:absolute;left:50%;transform:translateX(-50%)}.moments-header .back-btn{color:var(--primary-blue);font-size:1.2em;cursor:pointer;z-index:1}.moments-header .header-action{color:var(--primary-blue);font-size:1.2em;cursor:pointer;z-index:1;transition:all .2s ease}.moments-body{flex-grow:1;overflow-y:auto;background-color:#fff}.moments-feed-header{position:relative;margin-bottom:1.5625rem}.moments-cover-photo{width:100%;height:14.0625rem;object-fit:cover;display:block;cursor:pointer}.moments-user-info{position:absolute;bottom:-0.75rem;right:.75rem;display:flex;align-items:flex-end;gap:.5rem}.moments-user-name{color:#fff;font-size:1.1em;font-weight:bold;text-shadow:0 .0625rem .1875rem rgba(0,0,0,.5);position:relative;bottom:1.75rem;cursor:pointer}.moments-user-avatar{width:4.25rem;height:4.25rem;border-radius:.5rem;object-fit:cover;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.2)}.user-signature{position:absolute;bottom:-2.5rem;right:.75rem;width:12rem;text-align:right;word-wrap:break-word;line-height:1.4;color:#8a8a8a;font-size:.8em;cursor:pointer;margin-top:.5rem}.moments-feed-list{padding:0 .75rem;list-style:none}.moment-post{display:flex;gap:.625rem;padding:1.125rem 0;border-bottom:.0625rem solid #f0f0f0}.moment-post:last-child{border-bottom:none}.post-author-avatar{width:2.375rem;height:2.375rem;border-radius:50%;flex-shrink:0;object-fit:cover;cursor:pointer}.post-details{display:flex;flex-direction:column;gap:.4375rem;flex-grow:1}.post-author-name,.likes-section .liker-name,.comment-author,.delete-moment-btn,.post-meta .comment-button{color:var(--primary-blue)}.post-content{font-size:.9em;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;color:var(--text-primary)}.post-media{margin-top:.25rem}.post-media-image{max-width:10rem;max-height:10rem;object-fit:contain;border-radius:.25rem}.post-media .image-desc-content{background-color:rgba(240,250,255,.8);border:1px solid rgba(74,149,237,.1);width:10rem;height:10rem;font-size:.9em;color:var(--text-primary);display:flex;align-items:center;justify-content:center;text-align:center;font-weight:normal}.post-meta{display:flex;justify-content:space-between;align-items:center;color:#888;font-size:.8em}.post-meta .post-time{color:#888}.post-meta .post-actions{display:flex;gap:1rem}.post-meta .like-button,.post-meta .comment-button{background:#f7f7f7;border-radius:.1875rem;padding:.125rem .4375rem;cursor:pointer;font-size:1.1em;transition:all .2s ease}.post-meta .like-button:hover,.post-meta .comment-button:hover{color:var(--primary-blue)}.post-interactions{background:#f8faff;border-radius:.5rem;margin-top:.5rem;font-size:.85em;position:relative;border:1px solid rgba(74,149,237,.08)}.post-interactions::before{content:"";position:absolute;top:-0.375rem;left:.9375rem;width:0;height:0;border-left:.375rem solid rgba(0,0,0,0);border-right:.375rem solid rgba(0,0,0,0);border-bottom:.375rem solid #f8faff}.likes-section{padding:.4375rem .625rem;background:rgba(248,250,255,.6);display:flex;align-items:center;gap:.4375rem;flex-wrap:wrap;font-size:.8em}.likes-section .likes-list{display:flex;flex-wrap:wrap;gap:.25rem}.likes-section .liker-name{cursor:pointer}.likes-section .liker-name:not(:last-child)::after{content:", ";color:#888}.likes-section .fa-heart{color:var(--primary-blue)}.comments-section{padding:0 .625rem .4375rem;list-style:none;border-top:.0625rem solid #eaeaea}.likes-section+.comments-section{margin-top:-0.0625rem}.comments-section li{padding:.1875rem 0}.comment-author{font-weight:500;cursor:pointer}.comment-content{color:var(--text-primary);margin-top:.25rem}.delete-moment-btn{cursor:pointer;font-size:.8em;transition:all .2s ease}.delete-moment-btn:hover{color:var(--deep-blue)}body.dark-mode{background-color:rgba(0,0,0,0);--input-bg:#2a2a2a}body.dark-mode .app-view{background-color:var(--app-bg-color)}body.dark-mode .settings-card{background-color:var(--settings-card-bg-color)}body.dark-mode .settings-card p,body.dark-mode .settings-card a{color:var(--text-primary)}body.dark-mode .settings-card li{border-bottom-color:var(--border-color)}body.dark-mode .settings-card li a{color:var(--text-primary)}body.dark-mode #show-last-ai-response-btn,body.dark-mode #show-last-sent-prompt-btn{background-color:var(--settings-card-bg-color);color:var(--text-primary)}body.dark-mode .message-row.them .message-bubble{background:linear-gradient(315deg,#2a2a2a 0%,#333333 100%);border-color:#3c3c3c}body.dark-mode .voice-text-content{background-color:#2c2c2c;border-color:#3c3c3c;color:#f0f0f0;box-shadow:0 .0625rem .125rem rgba(0,0,0,.3)}body.dark-mode .image-desc-content{background-color:rgba(30,30,30,.7);border:.0625rem solid rgba(60,60,60,.4);color:#f0f0f0;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.2)}body.dark-mode .location-bubble .location-card{background-color:#2c2c2c;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}body.dark-mode .location-content .location-title{color:#f0f0f0}body.dark-mode .location-content .location-subtitle{color:#aaa}body.dark-mode .file-bubble .file-card{background-color:#2c2c2c;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}body.dark-mode .file-details .file-name{color:#f0f0f0}body.dark-mode .file-footer{background-color:#232323;color:#aaa;border-top:.0625rem solid #3c3c3c}body.dark-mode .event-description.expanded{background-color:rgba(50,50,50,.9);color:#f0f0f0;box-shadow:0 1px 4px rgba(0,0,0,.3)}.custom-dialog-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0);display:flex;justify-content:center;align-items:center;z-index:1000;animation:fadeIn .2s ease}.custom-dialog{background:var(--header-bg);border-radius:var(--dialog-border-radius);box-shadow:0 25px 50px rgba(0,0,0,.25),0 15px 30px rgba(0,0,0,.15),0 8px 16px rgba(0,0,0,.1),0 4px 8px rgba(0,0,0,.05);width:85%;max-width:18rem;overflow:hidden;display:flex;flex-direction:column;animation:dialogSlideIn .3s ease;border:1px solid var(--border-color);transform:translateY(0)}.dialog-header{padding:1rem;text-align:center;border-bottom:1px solid var(--border-color);background:var(--header-bg)}.dialog-title{margin:0;font-size:1.1rem;font-weight:500;color:var(--text-primary)}.dialog-body{padding:1.25rem 1rem;color:var(--text-primary);font-size:.9rem;line-height:1.5;text-align:center}.dialog-input-container{margin-top:.75rem}.dialog-input-container input,.dialog-input-container textarea{width:100%;padding:.75rem;border:1px solid var(--border-color);border-radius:var(--input-border-radius);font-size:.9rem;color:var(--text-primary);background-color:var(--input-bg);outline:none}.dialog-input-container input:focus,.dialog-input-container textarea:focus{border-color:var(--primary-blue);box-shadow:0 0 0 2px rgba(114,173,243,.2)}.dialog-footer{display:flex;border-top:1px solid var(--border-color)}.dialog-button{flex:1;padding:.875rem;border:none;background:rgba(0,0,0,0);font-size:.95rem;font-weight:500;cursor:pointer;transition:background-color .2s ease;color:var(--primary-blue)}.dialog-button:not(:last-child){border-right:1px solid var(--border-color)}.dialog-button:hover{background-color:rgba(114,173,243,.1)}.dialog-button:active{background-color:rgba(114,173,243,.2)}.dialog-button.primary-button{color:var(--primary-blue);font-weight:600}.dialog-button.cancel-button{color:var(--text-secondary)}@keyframes dialogSlideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes dialogSlideOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(20px)}}.dialog-closing{animation:dialogSlideOut .2s ease forwards}.overlay-closing{animation:fadeOut .2s ease forwards}.mobile-dialog-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0);display:flex;justify-content:center;align-items:center;z-index:1000;animation:fadeIn .2s ease}body.dark-mode .mobile-dialog,body.dark-mode .custom-dialog,body.dark-mode .sticker-manager-container{box-shadow:0 30px 60px rgba(0,0,0,.5),0 20px 40px rgba(0,0,0,.3),0 10px 20px rgba(0,0,0,.2),0 5px 10px rgba(0,0,0,.15)}body[data-theme=pink] .mobile-dialog,body[data-theme=pink] .custom-dialog,body[data-theme=pink] .sticker-manager-container{box-shadow:0 30px 60px rgba(216,51,132,.3),0 20px 40px rgba(216,51,132,.2),0 10px 20px rgba(0,0,0,.15),0 5px 10px rgba(0,0,0,.1)}body[data-theme=white] .mobile-dialog,body[data-theme=white] .custom-dialog,body[data-theme=white] .sticker-manager-container{box-shadow:0 30px 60px rgba(0,0,0,.2),0 20px 40px rgba(0,0,0,.15),0 10px 20px rgba(0,0,0,.1),0 5px 10px rgba(0,0,0,.05)}.mobile-dialog{background:var(--header-bg);border-radius:var(--dialog-border-radius);box-shadow:0 30px 60px rgba(0,0,0,.3),0 20px 40px rgba(0,0,0,.2),0 10px 20px rgba(0,0,0,.15),0 5px 10px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column;animation:dialogSlideIn .3s ease;border:1px solid var(--border-color);transform:translateY(0);position:relative}.moment-dialog{width:90%;max-width:20rem}.time-jump-dialog{width:85%;max-width:18rem}.mobile-dialog .dialog-header{padding:1.2rem 1rem 1rem;text-align:center;border-bottom:1px solid var(--border-color);background:var(--header-bg)}.mobile-dialog .dialog-header h3{margin:0;font-size:1.1rem;font-weight:600;color:var(--text-primary);letter-spacing:.3px}.mobile-dialog .dialog-body{padding:1.25rem 1rem;color:var(--text-primary);font-size:.9rem;line-height:1.5;max-height:60vh;overflow-y:auto}.mobile-dialog .dialog-footer{display:flex;border-top:1px solid var(--border-color)}.mobile-dialog .form-group{margin-bottom:.75rem}.mobile-dialog .form-group:last-child{margin-bottom:0}.mobile-dialog .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-primary);font-size:.9rem}.mobile-dialog .form-group input[type=text],.mobile-dialog .form-group input[type=url],.mobile-dialog .form-group textarea{width:100%;padding:.75rem;border:1px solid var(--border-color);border-radius:var(--input-border-radius);font-size:.9rem;color:var(--text-primary);background-color:#fff;outline:none;box-sizing:border-box}.mobile-dialog .form-group input[type=text]:focus,.mobile-dialog .form-group input[type=url]:focus,.mobile-dialog .form-group textarea:focus{border-color:var(--primary-blue);box-shadow:0 0 0 2px rgba(114,173,243,.2)}.mobile-dialog .form-group textarea{resize:vertical;min-height:4rem;font-family:inherit}.mobile-dialog .form-group input[type=checkbox]{margin-right:.5rem;transform:scale(1.1)}.mobile-dialog .radio-group{display:flex;margin-top:.5rem;border-radius:var(--element-border-radius);overflow:hidden;border:1px solid var(--border-color)}.mobile-dialog .radio-group label{flex:1;display:flex;align-items:center;justify-content:center;margin-bottom:0;font-weight:500;cursor:pointer;font-size:.85rem;padding:.5rem .75rem;background:#fff;color:var(--text-secondary);transition:all .2s ease;border-right:1px solid var(--border-color);position:relative}.mobile-dialog .radio-group label:last-child{border-right:none}.mobile-dialog .radio-group label input[type=radio]{position:absolute;opacity:0;width:0;height:0}.mobile-dialog .radio-group label:has(input[type=radio]:checked){background:var(--primary-blue);color:#fff;font-weight:600}.mobile-dialog .radio-group label:hover:not(:has(input[type=radio]:checked)){background:var(--ultra-light-blue);color:var(--primary-blue)}.mobile-dialog .image-options{background:var(--ultra-light-blue);padding:.75rem;border-radius:var(--element-border-radius);margin-top:.5rem;border:1px solid var(--border-color)}.mobile-dialog .image-options .form-group{margin-bottom:.5rem}.mobile-dialog .image-options .form-group:last-child{margin-bottom:0}.mobile-dialog .description-group{background:var(--ultra-light-blue);padding:.75rem;border-radius:var(--element-border-radius);margin-top:.5rem;border:1px solid var(--border-color)}.mobile-dialog .description-group .form-group{margin-bottom:0}.mobile-dialog .dialog-btn{flex:1;padding:.875rem;border:none;background:rgba(0,0,0,0);font-size:.95rem;font-weight:500;cursor:pointer;transition:background-color .2s ease;color:var(--primary-blue)}.mobile-dialog .dialog-btn:not(:last-child){border-right:1px solid var(--border-color)}.mobile-dialog .dialog-btn:hover{background-color:var(--ultra-light-blue)}.mobile-dialog .dialog-btn:active{background-color:var(--soft-blue)}.mobile-dialog .dialog-btn.dialog-btn-cancel,.mobile-dialog .dialog-btn.dialog-btn-confirm{border-radius:0}.mobile-dialog .dialog-btn:last-child{border-bottom-right-radius:1rem}.mobile-dialog .dialog-btn:first-child{border-bottom-left-radius:1rem}.mobile-dialog.dialog-closing{animation:dialogSlideOut .3s ease forwards}body.dark-mode .mobile-dialog{background:linear-gradient(135deg,#2c2c2c 0%,#1a1a1a 100%);border-color:#3c3c3c;box-shadow:0 8px 24px rgba(0,0,0,.4),0 4px 12px rgba(0,0,0,.3)}body.dark-mode .mobile-dialog .dialog-header{background:linear-gradient(135deg,#2c2c2c 0%,#1a1a1a 100%);border-bottom-color:#3c3c3c}body.dark-mode .mobile-dialog .dialog-header h3{color:#e0e0e0}body.dark-mode .mobile-dialog .dialog-body{color:silver}body.dark-mode .mobile-dialog .form-group label{color:silver}body.dark-mode .mobile-dialog .form-group input[type=text],body.dark-mode .mobile-dialog .form-group input[type=url],body.dark-mode .mobile-dialog .form-group textarea{background-color:#2a2a2a;border-color:#3c3c3c;color:#e0e0e0}body.dark-mode .mobile-dialog .form-group input[type=text]:focus,body.dark-mode .mobile-dialog .form-group input[type=url]:focus,body.dark-mode .mobile-dialog .form-group textarea:focus{border-color:var(--primary-blue);box-shadow:0 0 0 2px rgba(114,173,243,.3)}body.dark-mode .mobile-dialog .form-group input[type=text]::placeholder,body.dark-mode .mobile-dialog .form-group input[type=url]::placeholder,body.dark-mode .mobile-dialog .form-group textarea::placeholder{color:#888}body.dark-mode .mobile-dialog .image-options,body.dark-mode .mobile-dialog .description-group{background:#1a1a1a;border-color:#3c3c3c}body.dark-mode .mobile-dialog .radio-group{border-color:#3c3c3c}body.dark-mode .mobile-dialog .radio-group label{background:#2a2a2a;color:#a0a0a0;border-right-color:#3c3c3c}body.dark-mode .mobile-dialog .radio-group label:has(input[type=radio]:checked){background:var(--primary-blue);color:#fff}body.dark-mode .mobile-dialog .radio-group label:hover:not(:has(input[type=radio]:checked)){background:#3c3c3c;color:silver}body.dark-mode .mobile-dialog .dialog-btn{color:var(--primary-blue)}body.dark-mode .mobile-dialog .dialog-btn:hover{background-color:#3c3c3c}body.dark-mode .mobile-dialog .dialog-btn:active{background-color:#505050}body[data-theme=pink] .mobile-dialog .dialog-header h3{color:#d63384}body[data-theme=pink] .mobile-dialog .image-options,body[data-theme=pink] .mobile-dialog .description-group{background:#fdf2f8;border-color:#f8bbd9}body[data-theme=pink] .mobile-dialog .dialog-body{color:#333}body[data-theme=pink] .mobile-dialog .radio-group label:has(input[type=radio]:checked){background:#d63384;color:#fff}body[data-theme=pink] .mobile-dialog .btn-primary{background:#d63384;border-color:#d63384}body[data-theme=pink] .mobile-dialog .btn-primary:hover{background:rgb(178.187755102,35.812244898,106.5632653061);border-color:rgb(178.187755102,35.812244898,106.5632653061)}body[data-theme=pink] .mobile-dialog .input-field:focus{border-color:#d63384;box-shadow:0 0 0 2px rgba(214,51,132,.2)}body[data-theme=pink] .mobile-dialog .radio-group label:hover:not(:has(input[type=radio]:checked)){background:#fdf2f8;color:#d63384}body[data-theme=white] .mobile-dialog .dialog-header h3{color:#333}body[data-theme=white] .mobile-dialog .image-options,body[data-theme=white] .mobile-dialog .description-group{background:#f8f8f8;border-color:#e0e0e0}body[data-theme=white] .mobile-dialog .dialog-body{color:#333}body[data-theme=white] .mobile-dialog .radio-group label:has(input[type=radio]:checked){background:#333;color:#fff}body[data-theme=white] .mobile-dialog .btn-primary{background:#333;border-color:#333}body[data-theme=white] .mobile-dialog .btn-primary:hover{background:hsl(0,0%,10%);border-color:hsl(0,0%,10%)}body[data-theme=white] .mobile-dialog .input-field:focus{border-color:#a0e75a;box-shadow:0 0 0 2px rgba(160,231,90,.2)}body[data-theme=white] .mobile-dialog .form-group label{color:#333}body[data-theme=white] .mobile-dialog .form-group input[type=text],body[data-theme=white] .mobile-dialog .form-group input[type=url],body[data-theme=white] .mobile-dialog .form-group textarea{background:#fff;border:1px solid #e0e0e0}body[data-theme=white] .mobile-dialog .form-group input[type=text]:focus,body[data-theme=white] .mobile-dialog .form-group input[type=url]:focus,body[data-theme=white] .mobile-dialog .form-group textarea:focus{border-color:#a0e75a;box-shadow:0 0 0 2px rgba(160,231,90,.2);outline:none}body[data-theme=white] .mobile-dialog .form-group input[type=text]::placeholder,body[data-theme=white] .mobile-dialog .form-group input[type=url]::placeholder,body[data-theme=white] .mobile-dialog .form-group textarea::placeholder{color:#fff}body[data-theme=white] .mobile-dialog .form-group input[type=text],body[data-theme=white] .mobile-dialog .form-group input[type=url],body[data-theme=white] .mobile-dialog .form-group textarea{color:#333}body[data-theme=white] .mobile-dialog .form-group input[type=text]::placeholder,body[data-theme=white] .mobile-dialog .form-group input[type=url]::placeholder,body[data-theme=white] .mobile-dialog .form-group textarea::placeholder{color:#999}body[data-theme=white] .mobile-dialog .radio-group label:has(input[type=radio]:checked){background:#a0e75a;color:#333}body[data-theme=white] .mobile-dialog .radio-group label:hover:not(:has(input[type=radio]:checked)){background:#f8f8f8;color:#666}body[data-theme=custom] .mobile-dialog .image-options,body[data-theme=custom] .mobile-dialog .description-group{background:var(--settings-card-bg-color);border-color:var(--border-color)}body[data-theme=custom] .mobile-dialog .radio-group{border-color:var(--border-color)}body[data-theme=custom] .mobile-dialog .radio-group label{background:var(--settings-card-bg-color);color:var(--text-primary);border-right-color:var(--border-color)}body[data-theme=custom] .mobile-dialog .radio-group label:has(input[type=radio]:checked){background:var(--primary-blue);color:#fff}body[data-theme=custom] .mobile-dialog .radio-group label:hover:not(:has(input[type=radio]:checked)){background:var(--ultra-light-blue);color:var(--primary-blue)}body[data-theme=custom] .mobile-dialog .dialog-btn{color:var(--primary-blue)}body[data-theme=custom] .mobile-dialog .dialog-btn:hover{background-color:var(--ultra-light-blue)}body[data-theme=custom] .mobile-dialog .dialog-btn:active{background-color:var(--light-blue)}body.dark-mode[data-theme=custom] .mobile-dialog .image-options,body.dark-mode[data-theme=custom] .mobile-dialog .description-group{background:var(--settings-card-bg-color);border-color:var(--border-color)}body.dark-mode[data-theme=custom] .mobile-dialog .radio-group{border-color:var(--border-color)}body.dark-mode[data-theme=custom] .mobile-dialog .radio-group label{background:var(--settings-card-bg-color);color:var(--text-primary);border-right-color:var(--border-color)}body.dark-mode[data-theme=custom] .mobile-dialog .radio-group label:has(input[type=radio]:checked){background:var(--primary-blue);color:#fff}body.dark-mode[data-theme=custom] .mobile-dialog .radio-group label:hover:not(:has(input[type=radio]:checked)){background:var(--ultra-light-blue);color:var(--primary-blue)}body.dark-mode[data-theme=custom] .mobile-dialog .dialog-btn{color:var(--primary-blue)}body.dark-mode[data-theme=custom] .mobile-dialog .dialog-btn:hover{background-color:var(--ultra-light-blue)}body.dark-mode[data-theme=custom] .mobile-dialog .dialog-btn:active{background-color:var(--light-blue)}@media (prefers-contrast:high){.mobile-dialog{border-width:2px}.mobile-dialog .dialog-btn{border:1px solid var(--border-color)}.mobile-dialog .dialog-btn:focus{outline:2px solid var(--primary-blue);outline-offset:2px}.mobile-dialog .form-group input[type=text],.mobile-dialog .form-group textarea{border-width:2px}.mobile-dialog .radio-group{border-width:2px}.mobile-dialog .radio-group label{border-right-width:2px}}@media (prefers-reduced-motion:reduce){.mobile-dialog{animation:none}.mobile-dialog .dialog-btn,.mobile-dialog .form-group input,.mobile-dialog .form-group textarea,.mobile-dialog .radio-group label{transition:none}.mobile-dialog.dialog-closing{animation:none}}.mobile-dialog .dialog-header h3{text-shadow:0 1px 2px rgba(0,0,0,.1)}.mobile-dialog .dialog-body{background:hsla(0,0%,100%,.02);backdrop-filter:blur(1px)}.mobile-dialog .dialog-btn{backdrop-filter:blur(2px)}.mobile-dialog .dialog-btn:hover{backdrop-filter:blur(4px)}.mobile-dialog .form-group input[type=text],.mobile-dialog .form-group textarea{backdrop-filter:blur(1px)}.mobile-dialog .form-group input[type=text]:focus,.mobile-dialog .form-group textarea:focus{backdrop-filter:blur(2px)}@media (max-height:600px){.mobile-dialog{max-height:90% !important}.mobile-dialog .dialog-body{padding:12px 16px}.mobile-dialog .form-group{margin-bottom:10px}}.transfer-dialog .form-group,.red-packet-dialog .form-group,.gift-dialog .form-group,.comment-dialog .form-group{position:relative}.transfer-dialog .form-group label,.red-packet-dialog .form-group label,.gift-dialog .form-group label,.comment-dialog .form-group label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--text-primary);font-size:.9rem}.transfer-dialog .form-group input,.transfer-dialog .form-group textarea,.red-packet-dialog .form-group input,.red-packet-dialog .form-group textarea,.gift-dialog .form-group input,.gift-dialog .form-group textarea,.comment-dialog .form-group input,.comment-dialog .form-group textarea{width:100%;padding:.75rem 1rem;border:2px solid var(--border-color);border-radius:var(--input-border-radius);font-size:1rem;color:var(--text-primary);background-color:var(--input-bg);transition:all .2s ease;box-sizing:border-box;font-family:inherit}.transfer-dialog .form-group input:focus,.transfer-dialog .form-group textarea:focus,.red-packet-dialog .form-group input:focus,.red-packet-dialog .form-group textarea:focus,.gift-dialog .form-group input:focus,.gift-dialog .form-group textarea:focus,.comment-dialog .form-group input:focus,.comment-dialog .form-group textarea:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(114,173,243,.1);background-color:#fff}.transfer-dialog .form-group input::placeholder,.transfer-dialog .form-group textarea::placeholder,.red-packet-dialog .form-group input::placeholder,.red-packet-dialog .form-group textarea::placeholder,.gift-dialog .form-group input::placeholder,.gift-dialog .form-group textarea::placeholder,.comment-dialog .form-group input::placeholder,.comment-dialog .form-group textarea::placeholder{color:var(--text-secondary);opacity:.7}.transfer-dialog .form-group input[type=url],.red-packet-dialog .form-group input[type=url],.gift-dialog .form-group input[type=url],.comment-dialog .form-group input[type=url]{font-family:"Consolas","Monaco","Courier New",monospace;font-size:.9rem;background:linear-gradient(135deg,#f8faff 0%,#eef4ff 100%);border:2px solid #e3f2fd}.transfer-dialog .form-group input[type=url]:focus,.red-packet-dialog .form-group input[type=url]:focus,.gift-dialog .form-group input[type=url]:focus,.comment-dialog .form-group input[type=url]:focus{background:#fff;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(114,173,243,.1)}.transfer-dialog .form-group input[type=url]::placeholder,.red-packet-dialog .form-group input[type=url]::placeholder,.gift-dialog .form-group input[type=url]::placeholder,.comment-dialog .form-group input[type=url]::placeholder{color:#90a4ae;font-style:italic}.transfer-dialog .form-group input[type=number],.transfer-dialog .form-group input[type=text],.transfer-dialog .form-group input[type=email],.transfer-dialog .form-group input[type=url],.red-packet-dialog .form-group input[type=number],.red-packet-dialog .form-group input[type=text],.red-packet-dialog .form-group input[type=email],.red-packet-dialog .form-group input[type=url],.gift-dialog .form-group input[type=number],.gift-dialog .form-group input[type=text],.gift-dialog .form-group input[type=email],.gift-dialog .form-group input[type=url],.comment-dialog .form-group input[type=number],.comment-dialog .form-group input[type=text],.comment-dialog .form-group input[type=email],.comment-dialog .form-group input[type=url]{-webkit-appearance:none;appearance:none}.transfer-dialog .form-group input[type=number]::-webkit-outer-spin-button,.transfer-dialog .form-group input[type=number]::-webkit-inner-spin-button,.transfer-dialog .form-group input[type=text]::-webkit-outer-spin-button,.transfer-dialog .form-group input[type=text]::-webkit-inner-spin-button,.transfer-dialog .form-group input[type=email]::-webkit-outer-spin-button,.transfer-dialog .form-group input[type=email]::-webkit-inner-spin-button,.transfer-dialog .form-group input[type=url]::-webkit-outer-spin-button,.transfer-dialog .form-group input[type=url]::-webkit-inner-spin-button,.red-packet-dialog .form-group input[type=number]::-webkit-outer-spin-button,.red-packet-dialog .form-group input[type=number]::-webkit-inner-spin-button,.red-packet-dialog .form-group input[type=text]::-webkit-outer-spin-button,.red-packet-dialog .form-group input[type=text]::-webkit-inner-spin-button,.red-packet-dialog .form-group input[type=email]::-webkit-outer-spin-button,.red-packet-dialog .form-group input[type=email]::-webkit-inner-spin-button,.red-packet-dialog .form-group input[type=url]::-webkit-outer-spin-button,.red-packet-dialog .form-group input[type=url]::-webkit-inner-spin-button,.gift-dialog .form-group input[type=number]::-webkit-outer-spin-button,.gift-dialog .form-group input[type=number]::-webkit-inner-spin-button,.gift-dialog .form-group input[type=text]::-webkit-outer-spin-button,.gift-dialog .form-group input[type=text]::-webkit-inner-spin-button,.gift-dialog .form-group input[type=email]::-webkit-outer-spin-button,.gift-dialog .form-group input[type=email]::-webkit-inner-spin-button,.gift-dialog .form-group input[type=url]::-webkit-outer-spin-button,.gift-dialog .form-group input[type=url]::-webkit-inner-spin-button,.comment-dialog .form-group input[type=number]::-webkit-outer-spin-button,.comment-dialog .form-group input[type=number]::-webkit-inner-spin-button,.comment-dialog .form-group input[type=text]::-webkit-outer-spin-button,.comment-dialog .form-group input[type=text]::-webkit-inner-spin-button,.comment-dialog .form-group input[type=email]::-webkit-outer-spin-button,.comment-dialog .form-group input[type=email]::-webkit-inner-spin-button,.comment-dialog .form-group input[type=url]::-webkit-outer-spin-button,.comment-dialog .form-group input[type=url]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.transfer-dialog .form-group label:has(+input[required])::after,.transfer-dialog .form-group label:has(+textarea[required])::after,.red-packet-dialog .form-group label:has(+input[required])::after,.red-packet-dialog .form-group label:has(+textarea[required])::after,.gift-dialog .form-group label:has(+input[required])::after,.gift-dialog .form-group label:has(+textarea[required])::after,.comment-dialog .form-group label:has(+input[required])::after,.comment-dialog .form-group label:has(+textarea[required])::after{content:" *";color:#e74c3c;font-weight:bold}.transfer-dialog .dialog-body,.red-packet-dialog .dialog-body,.gift-dialog .dialog-body,.comment-dialog .dialog-body{padding:1.5rem 1.25rem}.comment-dialog{width:92%;max-width:22rem}.comment-dialog textarea{min-height:4rem;resize:vertical;font-family:inherit;line-height:1.4}.transfer-dialog{width:90%;max-width:20rem}.transfer-dialog .form-group{margin-bottom:1rem}.transfer-dialog .form-group:last-child{margin-bottom:0}.transfer-dialog input[type=number]{font-size:1.1rem;font-weight:600;text-align:center}.transfer-dialog input[type=number]:focus{color:var(--primary-blue)}.transfer-dialog input[type=text]{font-size:.95rem}.user-profile-dialog .dialog-input-container{margin-bottom:.75rem}.user-profile-dialog .dialog-input-container:last-child{margin-bottom:0}.user-profile-dialog .dialog-input-container input[type=url]{font-family:monospace;font-size:.85rem}.red-packet-dialog{width:90%;max-width:20rem}.red-packet-dialog .dialog-header h3{color:#e74c3c}.red-packet-dialog .form-group{margin-bottom:1rem}.red-packet-dialog .form-group:last-child{margin-bottom:0}.red-packet-dialog input[type=number]{font-size:1.1rem;font-weight:600;text-align:center;color:#e74c3c}.red-packet-dialog input[type=number]:focus{border-color:#e74c3c;box-shadow:0 0 0 2px rgba(231,76,60,.2)}.red-packet-dialog input[type=text]{font-size:.95rem;text-align:center}.gift-dialog{width:90%;max-width:20rem}.gift-dialog .form-group{margin-bottom:1rem}.gift-dialog .form-group:last-child{margin-bottom:0}.gift-dialog input[type=text]{font-size:1rem;font-weight:500}.gift-dialog input[type=number]{font-size:1rem;text-align:center}.comment-dialog .dialog-footer{display:flex;border-top:1px solid var(--border-color)}.comment-dialog .dialog-button{flex:1;padding:.875rem;border:none;background:rgba(0,0,0,0);font-size:.95rem;font-weight:500;cursor:pointer;transition:background-color .2s ease;color:var(--primary-blue)}.comment-dialog .dialog-button:not(:last-child){border-right:1px solid var(--border-color)}.comment-dialog .dialog-button:hover{background-color:var(--ultra-light-blue)}.comment-dialog .dialog-button:active{background-color:var(--soft-blue)}body.dark-mode .transfer-dialog .form-group input,body.dark-mode .transfer-dialog .form-group textarea,body.dark-mode .red-packet-dialog .form-group input,body.dark-mode .red-packet-dialog .form-group textarea,body.dark-mode .gift-dialog .form-group input,body.dark-mode .gift-dialog .form-group textarea,body.dark-mode .comment-dialog .form-group input,body.dark-mode .comment-dialog .form-group textarea{background-color:#2a2a2a;border-color:#3c3c3c;color:#e0e0e0}body.dark-mode .transfer-dialog .form-group input:focus,body.dark-mode .transfer-dialog .form-group textarea:focus,body.dark-mode .red-packet-dialog .form-group input:focus,body.dark-mode .red-packet-dialog .form-group textarea:focus,body.dark-mode .gift-dialog .form-group input:focus,body.dark-mode .gift-dialog .form-group textarea:focus,body.dark-mode .comment-dialog .form-group input:focus,body.dark-mode .comment-dialog .form-group textarea:focus{background-color:#333;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(114,173,243,.2)}body.dark-mode .transfer-dialog .form-group input::placeholder,body.dark-mode .transfer-dialog .form-group textarea::placeholder,body.dark-mode .red-packet-dialog .form-group input::placeholder,body.dark-mode .red-packet-dialog .form-group textarea::placeholder,body.dark-mode .gift-dialog .form-group input::placeholder,body.dark-mode .gift-dialog .form-group textarea::placeholder,body.dark-mode .comment-dialog .form-group input::placeholder,body.dark-mode .comment-dialog .form-group textarea::placeholder{color:#888}body.dark-mode .transfer-dialog .form-group input[type=url],body.dark-mode .red-packet-dialog .form-group input[type=url],body.dark-mode .gift-dialog .form-group input[type=url],body.dark-mode .comment-dialog .form-group input[type=url]{background:#1a1a1a;border-color:#3c3c3c;color:#e0e0e0}body.dark-mode .transfer-dialog .form-group input[type=url]:focus,body.dark-mode .red-packet-dialog .form-group input[type=url]:focus,body.dark-mode .gift-dialog .form-group input[type=url]:focus,body.dark-mode .comment-dialog .form-group input[type=url]:focus{background:#2a2a2a;border-color:var(--primary-blue)}body.dark-mode .transfer-dialog .form-group input[type=url]::placeholder,body.dark-mode .red-packet-dialog .form-group input[type=url]::placeholder,body.dark-mode .gift-dialog .form-group input[type=url]::placeholder,body.dark-mode .comment-dialog .form-group input[type=url]::placeholder{color:#888}body.dark-mode .red-packet-dialog input[type=number]:focus{border-color:#e74c3c;box-shadow:0 0 0 3px rgba(231,76,60,.2)}body[data-theme=pink] .transfer-dialog input[type=number]:focus{color:#d63384;border-color:#d63384;box-shadow:0 0 0 3px rgba(216,51,132,.1)}body[data-theme=pink] .red-packet-dialog .dialog-header h3{color:#d63384}body[data-theme=pink] .input-dialog input[type=url]{background:linear-gradient(135deg,#fdf2f8 0%,#fce7f3 100%);border-color:#f8bbd9}body[data-theme=pink] .input-dialog input[type=url]:focus{border-color:#d63384;box-shadow:0 0 0 3px rgba(216,51,132,.1)}body[data-theme=white] .transfer-dialog input[type=number]:focus{color:#689f38;border-color:#689f38;box-shadow:0 0 0 3px rgba(104,159,56,.1)}body[data-theme=white] .red-packet-dialog .dialog-header h3{color:#f44336}body[data-theme=white] .input-dialog input[type=url]{background:linear-gradient(135deg,#f8f8f8 0%,#f0f0f0 100%);border-color:#e0e0e0;color:#333}body[data-theme=white] .input-dialog input[type=url]:focus{border-color:#689f38;box-shadow:0 0 0 3px rgba(104,159,56,.1)}body[data-theme=white] .input-dialog input[type=url]::placeholder{color:#999}.input-dialog{width:90%;max-width:20rem}.voice-dialog{width:90%;max-width:22rem}.voice-dialog .dialog-header h3{display:flex;align-items:center;justify-content:center;gap:.5rem}.voice-dialog .form-group{margin-bottom:1rem}.voice-dialog .form-group:last-child{margin-bottom:0}.voice-dialog .form-group label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--text-primary);font-size:.9rem}.voice-dialog .form-group textarea{width:100%;min-height:80px;padding:.75rem 1rem;border:2px solid var(--border-color);border-radius:var(--input-border-radius);font-size:1rem;color:var(--text-primary);background-color:var(--input-bg);transition:all .2s ease;box-sizing:border-box;font-family:inherit;resize:vertical}.voice-dialog .form-group textarea:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(114,173,243,.1);background-color:#fff}.voice-dialog .form-group textarea::placeholder{color:var(--text-secondary);opacity:.7}.voice-dialog .form-group input[type=number]{width:100%;padding:.75rem 1rem;border:2px solid var(--border-color);border-radius:var(--input-border-radius);font-size:1rem;color:var(--text-primary);background-color:var(--input-bg);transition:all .2s ease;box-sizing:border-box;font-family:inherit}.voice-dialog .form-group input[type=number]:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(114,173,243,.1);background-color:#fff}.voice-dialog .form-group input[type=number]::placeholder{color:var(--text-secondary);opacity:.7}.voice-dialog .form-group input[type=number]::-webkit-outer-spin-button,.voice-dialog .form-group input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.voice-dialog .form-group input[type=number]{-webkit-appearance:none;appearance:none}.receive-dialog{width:85%;max-width:18rem}.receive-dialog .receive-content{display:flex;align-items:center;gap:1rem;padding:.5rem 0}.receive-dialog .receive-icon{font-size:2.5rem;flex-shrink:0}.receive-dialog .receive-info{flex:1}.receive-dialog .receive-title{font-size:1rem;font-weight:500;color:var(--text-primary);margin-bottom:.25rem}.receive-dialog .receive-price{font-size:1.2rem;font-weight:600;color:var(--primary-blue);margin-bottom:.25rem}.receive-dialog .receive-note{font-size:.85rem;color:var(--text-secondary);font-style:italic}.receive-dialog .dialog-footer{display:flex;border-top:1px solid var(--border-color)}.receive-dialog .dialog-footer .dialog-button{flex:1;padding:.875rem;border:none;background:rgba(0,0,0,0);font-size:.95rem;font-weight:500;cursor:pointer;transition:background-color .2s ease;color:var(--primary-blue)}.receive-dialog .dialog-footer .dialog-button:not(:last-child){border-right:1px solid var(--border-color)}.receive-dialog .dialog-footer .dialog-button:hover{background-color:var(--ultra-light-blue)}.receive-dialog .dialog-footer .dialog-button:active{background-color:var(--soft-blue)}.sticker-manager-modal{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0);display:flex;justify-content:center;align-items:center;z-index:1000;animation:fadeIn .2s ease}.sticker-manager-container{background:var(--header-bg);border-radius:var(--dialog-border-radius);box-shadow:0 35px 70px rgba(0,0,0,.35),0 25px 50px rgba(0,0,0,.25),0 15px 30px rgba(0,0,0,.2),0 8px 16px rgba(0,0,0,.15);width:90%;max-width:28rem;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;animation:dialogSlideIn .3s ease;border:1px solid var(--border-color)}.sticker-manager-container h2{margin:0;padding:1rem;text-align:center;border-bottom:1px solid var(--border-color);background:var(--header-bg);font-size:1.1rem;font-weight:600;color:var(--text-primary)}.sticker-manager-container .sticker-manager-tabs{display:flex;border-bottom:1px solid var(--border-color);background:var(--header-bg)}.sticker-manager-container .sticker-manager-tabs .tab-button{flex:1;padding:.75rem 1rem;text-align:center;cursor:pointer;font-size:.9rem;font-weight:500;color:var(--text-secondary);border-bottom:2px solid rgba(0,0,0,0);transition:all .2s ease}.sticker-manager-container .sticker-manager-tabs .tab-button:hover{background-color:var(--ultra-light-blue);color:var(--text-primary)}.sticker-manager-container .sticker-manager-tabs .tab-button.active{color:var(--primary-blue);border-bottom-color:var(--primary-blue);font-weight:600}.sticker-manager-container .sticker-manager-tabs .tab-button:not(:last-child){border-right:1px solid var(--border-color)}.sticker-manager-container .sticker-manager-content{overflow-y:auto;flex:1}.sticker-manager-container .sticker-manager-content .tab-content{display:none;padding:1.5rem 1.25rem}.sticker-manager-container .sticker-manager-content .tab-content.active{display:block}.sticker-manager-container .sticker-manager-content .form-group{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1rem}.sticker-manager-container .sticker-manager-content .form-group label{font-size:.9rem;font-weight:500;color:var(--text-primary)}.sticker-manager-container .sticker-manager-content .form-group input,.sticker-manager-container .sticker-manager-content .form-group textarea{width:100%;padding:.75rem 1rem;border:2px solid var(--border-color);border-radius:var(--input-border-radius);font-size:1rem;color:var(--text-primary);background-color:var(--input-bg);transition:all .2s ease;box-sizing:border-box}.sticker-manager-container .sticker-manager-content .form-group input:focus,.sticker-manager-container .sticker-manager-content .form-group textarea:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(114,173,243,.1);background-color:#fff}.sticker-manager-container .sticker-manager-content .form-group input::placeholder,.sticker-manager-container .sticker-manager-content .form-group textarea::placeholder{color:var(--text-secondary);opacity:.7}.sticker-manager-container .sticker-manager-content .form-group textarea{min-height:120px;resize:vertical;font-family:inherit}.sticker-manager-container .sticker-manager-content .add-sticker-section .add-sticker-form{display:flex;flex-direction:column;gap:1rem}.sticker-manager-container .sticker-manager-content .add-sticker-section .add-sticker-form .preview-container{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin:1rem 0}.sticker-manager-container .sticker-manager-content .add-sticker-section .add-sticker-form .preview-container .preview-label{font-size:.9rem;color:var(--text-secondary)}.sticker-manager-container .sticker-manager-content .add-sticker-section .add-sticker-form .preview-container .preview-img{max-width:150px;max-height:150px;border:1px dashed var(--border-color);padding:.5rem;border-radius:var(--element-border-radius);background:var(--input-bg)}.sticker-manager-container .sticker-manager-content .add-sticker-section .add-sticker-form .add-sticker-btn{padding:.75rem 1.5rem;background:var(--primary-blue);color:#fff;border:none;border-radius:var(--button-border-radius);font-size:.95rem;font-weight:600;cursor:pointer;transition:all .2s ease}.sticker-manager-container .sticker-manager-content .add-sticker-section .add-sticker-form .add-sticker-btn:hover{background:var(--soft-blue)}.sticker-manager-container .sticker-manager-content .add-sticker-section .add-sticker-form .add-sticker-btn:active{transform:translateY(1px)}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-instructions{margin-bottom:1rem;padding:1rem;background:var(--input-bg);border-radius:var(--element-border-radius);border-left:4px solid var(--primary-blue)}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-instructions p{margin:0 0 .5rem 0;font-size:.9rem;font-weight:600;color:var(--text-primary)}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-instructions ul{margin:0;padding-left:1.5rem}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-instructions ul li{font-size:.85rem;color:var(--text-secondary);line-height:1.4;margin-bottom:.25rem}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-instructions ul li strong{color:var(--text-primary)}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-instructions ul li code{background:rgba(114,173,243,.1);padding:.2rem .4rem;border-radius:var(--small-border-radius);font-family:"Consolas","Monaco","Courier New",monospace;font-size:.8rem}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-add-btn{width:100%;padding:.75rem;background:var(--primary-blue);color:#fff;border:none;border-radius:var(--button-border-radius);font-size:.95rem;font-weight:600;cursor:pointer;transition:all .2s ease}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-add-btn:hover{background:var(--soft-blue)}.sticker-manager-container .sticker-manager-content .batch-add-section .batch-add-btn:active{transform:translateY(1px)}.sticker-manager-container .sticker-manager-content .delete-manage-section .control-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.sticker-manager-container .sticker-manager-content .delete-manage-section .control-bar .selection-controls{display:flex;gap:.5rem}.sticker-manager-container .sticker-manager-content .delete-manage-section .control-bar .selection-controls button{padding:.5rem .75rem;background:var(--input-bg);border:1px solid var(--border-color);border-radius:var(--element-border-radius);font-size:.85rem;cursor:pointer;transition:all .2s ease;color:var(--text-primary)}.sticker-manager-container .sticker-manager-content .delete-manage-section .control-bar .selection-controls button:hover{background:var(--ultra-light-blue);border-color:var(--primary-blue)}.sticker-manager-container .sticker-manager-content .delete-manage-section .control-bar .delete-selected-btn{padding:.5rem .75rem;background:#e74c3c;color:#fff;border:none;border-radius:var(--button-border-radius);font-size:.85rem;cursor:pointer;transition:all .2s ease}.sticker-manager-container .sticker-manager-content .delete-manage-section .control-bar .delete-selected-btn:hover{background:#c0392b}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container{max-height:400px;overflow-y:auto;border:1px solid var(--border-color);border-radius:var(--element-border-radius);padding:1rem;background:var(--input-bg)}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:1rem}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item{display:flex;flex-direction:column;align-items:center;padding:.75rem;border:1px solid var(--border-color);border-radius:var(--element-border-radius);background:#fff;transition:all .2s ease;position:relative}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item:hover{border-color:var(--primary-blue);box-shadow:0 2px 8px rgba(114,173,243,.2)}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item:has(.sticker-checkbox:checked){border:2px solid var(--checkbox-border-checked);box-shadow:0 0 0 2px var(--shadow-color-rgba);background:var(--checkbox-hover-bg)}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item:has(.sticker-checkbox:checked) .sticker-label{color:var(--checkbox-border-checked);font-weight:600}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item:has(.sticker-checkbox:checked) .sticker-preview{opacity:.8}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item .sticker-checkbox{position:absolute;opacity:0;width:0;height:0;pointer-events:none}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item .sticker-checkbox-button{position:absolute;top:.5rem;right:.5rem;width:1.25rem;height:1.25rem;border:1px solid var(--checkbox-border-unchecked);border-radius:var(--small-border-radius);background:var(--checkbox-bg-unchecked);cursor:pointer;transition:all .2s ease;z-index:10}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item .sticker-checkbox-button.checked{border:2px solid var(--checkbox-border-checked)}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item .sticker-checkbox-button.checked::after{content:"âœ“";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.7rem;font-weight:bold;color:var(--checkbox-border-checked)}@media (hover:hover){.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item .sticker-checkbox-button:hover{border-color:var(--checkbox-border-checked);background:var(--checkbox-hover-bg)}}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item .sticker-preview{width:60px;height:60px;object-fit:contain;margin-bottom:.5rem}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .sticker-item .sticker-label{font-size:.8rem;color:var(--text-secondary);text-align:center;word-break:break-all;line-height:1.2}.sticker-manager-container .sticker-manager-content .delete-manage-section .sticker-list-container .sticker-grid .no-stickers-msg{grid-column:1/-1;text-align:center;color:var(--text-secondary);padding:2rem;font-style:italic}.sticker-manager-container .sticker-manager-footer{display:flex;border-top:1px solid var(--border-color)}.sticker-manager-container .sticker-manager-footer .dialog-button{flex:1;padding:.875rem;border:none;background:rgba(0,0,0,0);font-size:.95rem;font-weight:500;cursor:pointer;transition:background-color .2s ease;color:var(--primary-blue)}.sticker-manager-container .sticker-manager-footer .dialog-button:hover{background-color:var(--ultra-light-blue)}.sticker-manager-container .sticker-manager-footer .dialog-button:active{background-color:var(--soft-blue)}.scrollable-text-dialog{width:85%;max-width:18rem;max-height:70vh}.scrollable-text-dialog .dialog-header{padding:1.2rem 1rem 1rem;text-align:center;border-bottom:1px solid var(--border-color);background:var(--header-bg)}.scrollable-text-dialog .dialog-header h3{margin:0;font-size:1.1rem;font-weight:600;color:var(--text-primary);letter-spacing:.3px}.scrollable-text-dialog .dialog-body.scrollable-content{max-height:50vh;overflow-y:auto;padding:1.25rem 1rem;color:var(--text-primary);font-size:.9rem;line-height:1.5;background:rgba(0,0,0,0)}.scrollable-text-dialog .dialog-body.scrollable-content .scrollable-text{margin:0;padding:0;font-family:"Consolas","Monaco","Courier New",monospace;font-size:.8rem;line-height:1.4;white-space:pre-wrap;word-wrap:break-word;color:var(--text-primary);background:rgba(0,0,0,0);border:none}.scrollable-text-dialog .dialog-footer{display:flex;border-top:1px solid var(--border-color)}.scrollable-text-dialog .dialog-footer .dialog-button{flex:1;padding:.875rem;border:none;background:rgba(0,0,0,0);font-size:.95rem;font-weight:500;cursor:pointer;transition:background-color .2s ease;color:var(--primary-blue)}.scrollable-text-dialog .dialog-footer .dialog-button:hover{background:var(--ultra-light-blue)}.scrollable-text-dialog .dialog-footer .dialog-button:active{background:var(--light-blue)}.scrollable-text-dialog .dialog-footer .dialog-button:not(:last-child){border-right:1px solid var(--border-color)}.scrollable-text-dialog .dialog-footer .dialog-button:first-child{border-bottom-left-radius:1rem}.scrollable-text-dialog .dialog-footer .dialog-button:last-child{border-bottom-right-radius:1rem}.scrollable-text-dialog .dialog-footer .dialog-button.copy-btn{color:var(--text-secondary)}.scrollable-text-dialog .dialog-footer .dialog-button.primary-button{color:var(--primary-blue);font-weight:600}input[type=checkbox]{position:absolute;opacity:0;width:0;height:0;pointer-events:none}.checkbox-button{display:inline-flex;align-items:center;justify-content:center;min-height:44px;padding:.75rem 1.25rem;margin:.25rem;border:1px solid var(--checkbox-border-unchecked);border-radius:var(--dialog-border-radius);background:var(--checkbox-bg-unchecked);color:var(--checkbox-text-unchecked);font-size:.9rem;font-weight:500;text-align:center;cursor:pointer;-webkit-user-select:none;user-select:none;transition:all .2s ease;box-shadow:var(--checkbox-shadow-unchecked);position:relative}@media (hover:hover){.checkbox-button:hover{background:var(--checkbox-hover-bg);border-color:var(--primary-blue);transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.15)}}.checkbox-button.checked{background:var(--checkbox-bg-unchecked);border:2px solid var(--checkbox-border-checked);color:var(--checkbox-border-checked);box-shadow:var(--checkbox-shadow-checked);font-weight:600}@media (hover:hover){.checkbox-button.checked:hover{background:var(--checkbox-hover-bg);border-color:var(--checkbox-border-checked);transform:translateY(-1px);box-shadow:0 6px 16px var(--checkbox-shadow-checked)}}.checkbox-button.checked::after{content:"âœ“";position:absolute;right:.5rem;top:50%;transform:translateY(-50%);font-size:.9rem;font-weight:bold;color:var(--checkbox-border-checked);opacity:1}.checkbox-button:disabled,.checkbox-button.disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.checkbox-button:focus-within{outline:2px solid var(--primary-blue);outline-offset:2px}.checkbox-button.size-small{min-height:36px;padding:.5rem 1rem;font-size:.8rem;border-radius:var(--element-border-radius)}.checkbox-button.size-large{min-height:52px;padding:1rem 1.5rem;font-size:1rem;border-radius:var(--dialog-border-radius)}.checkbox-button.full-width{width:100%;margin:.25rem 0}.checkbox-group{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0}.checkbox-group.vertical{flex-direction:column}.checkbox-group.vertical .checkbox-button{margin:.25rem 0}.checkbox-group.horizontal{flex-direction:row}.checkbox-group.horizontal .checkbox-button{flex:1;min-width:0}.checkbox-group.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem}body[data-theme=pink] .checkbox-button{--checkbox-border-checked:#f372ad;--checkbox-text-unchecked:rgb(186,139,162);--checkbox-border-unchecked:#e1cbd5;--checkbox-hover-bg:#fde8f4;--checkbox-shadow-checked:0 4px 12px rgba(226,74,144,0.3)}body[data-theme=white] .checkbox-button{--checkbox-border-checked:#666666;--checkbox-text-unchecked:#333333;--checkbox-border-unchecked:#e0e0e0;--checkbox-hover-bg:#f8f8f8;--checkbox-shadow-checked:0 4px 12px rgba(102,102,102,0.3)}body[data-theme=custom] .checkbox-button{--checkbox-border-checked:var(--primary-blue);--checkbox-text-unchecked:var(--text-primary);--checkbox-border-unchecked:var(--border-color);--checkbox-hover-bg:var(--ultra-light-blue);--checkbox-shadow-checked:0 4px 12px var(--shadow-color-rgba)}body.dark-mode .checkbox-button{--checkbox-bg-unchecked:#374151;--checkbox-border-unchecked:#6b7280;--checkbox-text-unchecked:#d1d5db;--checkbox-hover-bg:#4b5563;--checkbox-shadow-unchecked:0 2px 4px rgba(0,0,0,0.3)}@media (prefers-color-scheme:dark){.checkbox-button{--checkbox-bg-unchecked:#374151;--checkbox-border-unchecked:#6b7280;--checkbox-text-unchecked:#d1d5db;--checkbox-hover-bg:#4b5563;--checkbox-shadow-unchecked:0 2px 4px rgba(0,0,0,0.3)}}body.dark-mode[data-theme=pink] .checkbox-button{--checkbox-bg-unchecked:#4c1d3d;--checkbox-border-unchecked:#8b647a;--checkbox-border-checked:#f372ad;--checkbox-text-unchecked:#f3d5e7;--checkbox-hover-bg:#5d2449}body.dark-mode[data-theme=white] .checkbox-button{--checkbox-bg-unchecked:#2a2a2a;--checkbox-border-unchecked:#3c3c3c;--checkbox-border-checked:#cccccc;--checkbox-text-unchecked:#e0e0e0;--checkbox-hover-bg:#3c3c3c}.sticker-checkbox-button{border:1px solid var(--checkbox-border-unchecked,#e0e0e0);border-radius:var(--element-border-radius);background:var(--checkbox-bg-unchecked,#ffffff);cursor:pointer;transition:all .2s ease;display:inline-block;pointer-events:auto;-webkit-user-select:none;user-select:none}body[data-theme=white] .sticker-checkbox-button{--checkbox-border-checked:#666666;--checkbox-border-unchecked:#e0e0e0;--checkbox-bg-unchecked:#ffffff;--checkbox-hover-bg:#f8f8f8}body[data-theme=pink] .sticker-checkbox-button{--checkbox-border-checked:#f372ad;--checkbox-border-unchecked:#e1cbd5;--checkbox-bg-unchecked:#ffffff;--checkbox-hover-bg:#fde8f4}body[data-theme=custom] .sticker-checkbox-button{--checkbox-border-checked:var(--primary-blue);--checkbox-border-unchecked:var(--border-color);--checkbox-bg-unchecked:#ffffff;--checkbox-hover-bg:var(--ultra-light-blue)}.sticker-checkbox-button.checked{border:2px solid var(--checkbox-border-checked,#007aff);background:var(--checkbox-bg-unchecked,#ffffff)}.sticker-checkbox-button.checked::after{content:"âœ“";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.75rem;font-weight:bold;color:var(--checkbox-border-checked,#007aff)}@media (hover:hover){.sticker-checkbox-button:hover{border-color:var(--checkbox-border-checked);background:var(--checkbox-hover-bg)}}.feature-item:has(.sticker-checkbox:checked),.sticker-item:has(.sticker-checkbox:checked){border-color:var(--checkbox-border-checked);box-shadow:0 0 0 2px var(--shadow-color-rgba);background:var(--checkbox-hover-bg)}.feature-item:has(.sticker-checkbox:checked) .feature-label,.feature-item:has(.sticker-checkbox:checked) .sticker-label,.sticker-item:has(.sticker-checkbox:checked) .feature-label,.sticker-item:has(.sticker-checkbox:checked) .sticker-label{color:var(--checkbox-border-checked)}@media (max-width:768px){.checkbox-button{min-height:48px;padding:.875rem 1.5rem;font-size:.95rem}.checkbox-group.horizontal{flex-direction:column}.checkbox-group.horizontal .checkbox-button{width:100%}.sticker-checkbox-button{width:1.75rem;height:1.75rem;top:.125rem;right:.125rem}}*{box-sizing:border-box}*{transition-timing-function:ease}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:rgba(0,0,0,0)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:2px}::-webkit-scrollbar-thumb:hover{background:var(--text-secondary)}.wechat-body::-webkit-scrollbar,.moments-body::-webkit-scrollbar,.settings-body::-webkit-scrollbar,.panel-view::-webkit-scrollbar,.app-screen::-webkit-scrollbar,.file-content::-webkit-scrollbar,.message-bubble::-webkit-scrollbar,.voice-text-content::-webkit-scrollbar,.image-desc-content::-webkit-scrollbar,.event-description::-webkit-scrollbar,.recall-content::-webkit-scrollbar{display:none}.wechat-body,.moments-body,.settings-body,.panel-view,.app-screen,.file-content,.message-bubble,.voice-text-content,.image-desc-content,.event-description,.recall-content{scrollbar-width:none}::selection{background:var(--primary-blue);color:#fff}::-moz-selection{background:var(--primary-blue);color:#fff}:focus{outline:none}.no-select{-webkit-user-select:none;user-select:none}@media (max-width:360px){body{padding:.5rem}.phone-frame{max-width:100%;width:100%}.wechat-body,.settings-body,.moments-body,.app-screen{-webkit-overflow-scrolling:touch}input,textarea{font-size:16px}}
</style></head><body><div class="phone-frame"><div class="phone-screen"><div id="delete-mode-trigger"></div><div id="hidden-send-trigger"></div><div class="phone-status-bar"><div class="status-left"><span id="current-time">00:00</span> <i class="fas fa-moon moon-icon"></i></div><div class="status-right"><div class="signal-bars"><i class="fas fa-signal"></i></div><i class="fas fa-wifi wifi-icon"></i> <i class="fas fa-battery-three-quarters battery-icon"></i></div></div><div class="dynamic-island"></div><div class="app-view app-screen active" id="app-homescreen"><div class="app-grid"><div class="app-icon" id="app-wechat"><div class="icon-image icon-wechat"><i class="fab fa-weixin"></i></div><span class="app-name">WeChat</span></div><div class="app-icon" id="app-settings"><div class="icon-image icon-settings"><i class="fas fa-cog"></i></div><span class="app-name">è®¾ç½®</span></div></div></div><div class="app-view" id="wechat-view"><div class="wechat-header"><i class="fas fa-chevron-left back-btn" id="wechat-back-btn-dummy"></i> <span class="contact-name" id="contact-name-header">Character</span> <i class="fas fa-ellipsis-h options-btn" id="wechat-options-btn"><div class="notification-dot" id="moments-notification" style="display:none"></div></i></div><div class="wechat-body" id="wechat-body"></div><div class="wechat-input-area"><footer class="wechat-footer"><i id="microphone-btn" class="fas fa-microphone footer-icon"></i> <input id="wechat-input-field" class="text-input" placeholder="å‘é€ä¿¡æ¯" autocomplete="off" autocapitalize="off" spellcheck="false"/> <i id="smile-btn" class="far fa-smile footer-icon"></i> <i id="plus-btn" class="fas fa-plus-circle footer-icon"></i> <button id="send-btn" class="send-btn"><i class="fas fa-paper-plane"></i></button></footer><div id="panel-container" class="panel-container"><div id="sticker-panel" class="panel-view"><div id="sticker-grid" class="features-grid"></div></div><div id="char-sticker-panel" class="panel-view"><div id="char-sticker-grid" class="features-grid"></div></div><div id="plus-panel" class="panel-view"><div id="plus-grid" class="features-grid"></div></div></div></div></div><div id="settings-view" class="app-view"><header class="settings-header"><i class="fas fa-chevron-left back-btn" id="settings-back-btn"></i> <span class="title">å…³äº</span></header><main class="settings-body"><div class="settings-card"><p>æœ¬åŒå±‚æ‰‹æœº<span class="highlight">ã€å…è´¹ã€‘</span>å‘å¸ƒäºdiscordçš„å°¾å·´é•‡ç¤¾åŒºå’Œæ—…ç¨‹ç¤¾åŒºï¼Œä½œè€…ï¼š<span class="highlight">æš´åŠ›ç¾å­¦BLMX</span>ï¼Œç‚¹å‡»å³å¯è·³è½¬åˆ°ç¤¾åŒº <a href="https://discord.com/channels/1379304008157499423/1388180976873766973" target="_blank">https://discord.com/...</a>ã€‚<a href="https://discord.com/channels/1291925535324110879/1388182155707814009" target="_blank">https://discord.com/...</a>ã€‚</p><p>å¦‚æœä½ æ˜¯é€šè¿‡ä»»ä½•<span class="highlight">ä»˜è´¹é€”å¾„</span>è·å–ï¼Œè¯·å¸¦ç€è´­ä¹°è®°å½•æ¥æ‰¾ä½œè€…ï¼Œ<span class="highlight">é‡é‡æœ‰èµ</span>ã€‚æŠµåˆ¶ä»»ä½•çªƒå–åˆ›ä½œè€…åŠ³åŠ¨æˆæœçš„å•†ä¸šåŒ–è¡Œä¸ºï¼Œä»ä½ æˆ‘åšèµ·TvT</p><p><span class="highlight">ç¦æ­¢</span>åœ¨é…’é¦†ä»¥å¤–çš„å¹³å°ä½¿ç”¨ï¼<span class="highlight">ç¦æ­¢</span>æœªç»æˆæƒçš„äºŒä¼ äºŒæ”¹ï¼<span class="highlight">ç¦æ­¢</span>ä»»ä½•è¡Œä¸ºçš„å€’å–å’Œå•†ä¸šåŒ–è¡Œä¸ºï¼</p><p>åç»­æ›´æ–°å†…å®¹ä¹Ÿä¼šå‘åœ¨discordçš„å°¾å·´é•‡ç¤¾åŒºå’Œæ—…ç¨‹ç¤¾åŒºï¼Œæœ‰é—®é¢˜æ¬¢è¿æ¥æé—®å“¦ï¼æœ‰æƒ³ç©çš„åŠŸèƒ½ã€æƒ³æå‡ºçš„å»ºè®®ä¹Ÿå¯ä»¥åœ¨å¸–å­ä¸‹è¯„è®ºã€‚</p></div><div class="settings-card" style="margin-top:1rem;padding:0"><ul style="list-style:none;margin:0;padding:0"><li style="border-bottom:1px solid #efefef"><a href="#" id="change-chat-wallpaper-btn" style="text-decoration:none;color:#8ba2ba;display:flex;justify-content:space-between;align-items:center;padding:1rem"><span>æ›´æ¢èŠå¤©å£çº¸</span> <i class="fas fa-chevron-right"></i></a></li><li style="border-bottom:1px solid #efefef"><a href="#" id="change-home-wallpaper-btn" style="text-decoration:none;color:#8ba2ba;display:flex;justify-content:space-between;align-items:center;padding:1rem"><span>æ›´æ¢ä¸»å±å¹•å£çº¸</span> <i class="fas fa-chevron-right"></i></a></li><li><a href="#" id="change-settings-wallpaper-btn" style="text-decoration:none;color:#8ba2ba;display:flex;justify-content:space-between;align-items:center;padding:1rem"><span>æ›´æ¢è®¾ç½®å£çº¸</span> <i class="fas fa-chevron-right"></i></a></li></ul></div><div class="settings-card" style="margin-top:1rem;padding:0"><div style="padding:1rem;border-bottom:1px solid #efefef"><h3 style="margin:0;font-size:1rem;color:var(--text-primary)">ä¸»é¢˜é…è‰²</h3></div><div class="theme-options" style="padding:1rem;display:flex;flex-wrap:wrap;gap:1rem;justify-content:space-between"></div><div style="padding:1rem;border-top:1px solid #efefef"><button id="custom-theme-btn" style="width:100%;padding:.75rem;background:var(--primary-blue);color:#fff;border:none;border-radius:.5rem;font-weight:500;cursor:pointer">è‡ªå®šä¹‰ä¸»é¢˜</button></div></div><div class="settings-card" style="margin-top:1rem;padding:0"><div style="padding:1rem;border-bottom:1px solid #efefef"><h3 style="margin:0;font-size:1rem;color:var(--text-primary)">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3></div><div style="padding:1rem"><div style="margin-bottom:.75rem"><h4 style="margin:0 0 .5rem 0;font-size:.9rem;color:var(--text-primary);font-weight:600">ğŸ“± æ¶ˆæ¯æ’¤å›åŠŸèƒ½</h4><p style="margin:0;font-size:.85rem;color:var(--text-secondary);line-height:1.4"><strong>é•¿æŒ‰æ’¤å›ï¼š</strong>é•¿æŒ‰è‡ªå·±å‘é€çš„æ¶ˆæ¯æ°”æ³¡600æ¯«ç§’å³å¯æ’¤å›<br/><strong>åŒå‡»æ’¤å›ï¼š</strong>å¿«é€ŸåŒå‡»è‡ªå·±çš„æ¶ˆæ¯æ°”æ³¡ä¹Ÿå¯ä»¥æ’¤å›ï¼ˆå…¨å±æ¨¡å¼æ¨èï¼‰<br/><span style="color:var(--primary-blue)">ğŸ’¡ æç¤ºï¼šå…¨å±æ¨¡å¼ä¸‹é•¿æŒ‰å¯èƒ½å¤±æ•ˆï¼Œå»ºè®®ä½¿ç”¨åŒå‡»æ’¤å›</span></p></div><div style="margin-bottom:.75rem"><h4 style="margin:0 0 .5rem 0;font-size:.9rem;color:var(--text-primary);font-weight:600">ğŸ¨ ä¸»é¢˜è‡ªå®šä¹‰</h4><p style="margin:0;font-size:.85rem;color:var(--text-secondary);line-height:1.4">é€‰æ‹©é¢„è®¾ä¸»é¢˜åç‚¹å‡»"è‡ªå®šä¹‰ä¸»é¢˜"æŒ‰é’®ï¼Œå¯ä»¥åŸºäºå½“å‰ä¸»é¢˜è¿›è¡Œä¸ªæ€§åŒ–è°ƒæ•´</p></div></div></div><div class="settings-card" style="margin-top:1rem;padding:1rem"><p style="font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em">è°ƒè¯•å·¥å…·</p><ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.5rem"><li><a href="#" id="show-last-ai-response-btn" style="text-decoration:none;display:block;text-align:center;background-color:#eef4fd;padding:.6rem 1rem;border-radius:.6rem;color:var(--text-primary);font-weight:500"><span>æ˜¾ç¤ºAIæœ€æ–°åŸå§‹å›å¤</span></a></li><li><a href="#" id="show-last-sent-prompt-btn" style="text-decoration:none;display:block;text-align:center;background-color:#eef4fd;padding:.6rem 1rem;border-radius:.6rem;color:var(--text-primary);font-weight:500"><span>æ˜¾ç¤ºå‘é€ç»™AIçš„æç¤º</span></a></li></ul></div><div class="settings-card" style="margin-top:1rem;padding:1rem"><p style="font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em">æ‰‹æœºå°ºå¯¸è°ƒæ•´</p><div style="display:flex;flex-direction:column;gap:.75rem"><div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem"><button id="phone-size-default" class="phone-size-btn phone-size-active"><span class="size-icon" style="height:24px"></span> <span class="size-label">é»˜è®¤å°ºå¯¸</span></button> <button id="phone-size-medium" class="phone-size-btn"><span class="size-icon" style="height:20px"></span> <span class="size-label">ä¸­ç­‰å°ºå¯¸</span></button> <button id="phone-size-small" class="phone-size-btn"><span class="size-icon" style="height:16px"></span> <span class="size-label">å°å°ºå¯¸</span></button></div><div style="font-size:.8em;color:var(--text-secondary);text-align:center">è°ƒæ•´æ‰‹æœºå±å¹•çš„é«˜åº¦å¤§å°</div></div></div><div class="settings-card" style="margin-top:1rem;padding:1rem"><p style="font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em">å…¨å±æ¨¡å¼æ‰‹æœºå¤§å°</p><div style="display:flex;flex-direction:column;gap:.75rem"><div style="display:flex;flex-direction:column;gap:.5rem"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:.9em;color:var(--text-secondary)">å°</span> <input type="range" id="fullscreen-size-slider" min="50" max="200" step="5" value="100" style="flex-grow:1;margin:0 10px;accent-color:var(--primary-blue)"/> <span style="font-size:.9em;color:var(--text-secondary)">å¤§</span></div><div style="display:flex;justify-content:center;align-items:center;gap:.5rem"><input type="number" id="fullscreen-size-input" value="100" min="50" max="200" step="5" style="width:70px;padding:.25rem .5rem;border:1px solid var(--border-color);border-radius:var(--element-border-radius);text-align:center;font-size:.85em;background:var(--settings-card-bg-color);color:var(--text-primary)"/> <span style="font-size:.85em;color:var(--text-secondary)">%</span></div></div><div style="display:flex;justify-content:space-between;gap:.5rem;margin-top:.5rem"><button id="fullscreen-size-default" class="fullscreen-size-btn fullscreen-size-active"><span class="fullscreen-size-icon">ğŸ“²</span> <span class="fullscreen-size-label">é»˜è®¤ (100%)</span></button> <button id="fullscreen-size-large" class="fullscreen-size-btn"><span class="fullscreen-size-icon">ğŸ“º</span> <span class="fullscreen-size-label">å¤§ (130%)</span></button> <button id="fullscreen-size-xlarge" class="fullscreen-size-btn"><span class="fullscreen-size-icon">ğŸ–¥ï¸</span> <span class="fullscreen-size-label">è¶…å¤§ (160%)</span></button></div><div style="font-size:.8em;color:var(--text-secondary);text-align:center">è°ƒæ•´å…¨å±æ¨¡å¼ä¸‹æ‰‹æœºçš„æ˜¾ç¤ºå¤§å°</div></div></div><div class="settings-card" style="margin-top:1rem;padding:1rem"><p style="font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em">å­—ä½“è®¾ç½®</p><div style="display:flex;flex-direction:column;gap:.75rem"><div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem"><button id="font-default" class="font-btn font-active"><span class="font-icon">ğŸ¨</span> <span class="font-label">è‡ªå®šä¹‰å­—ä½“</span></button> <button id="font-system" class="font-btn"><span class="font-icon">ğŸ“±</span> <span class="font-label">ç³»ç»Ÿå­—ä½“</span></button></div><div style="font-size:.8rem;color:var(--text-secondary);text-align:center;margin-top:.25rem">é€‰æ‹©åº”ç”¨ä½¿ç”¨çš„å­—ä½“æ ·å¼</div></div></div><div class="settings-card" style="margin-top:1rem;padding:1rem"><p style="font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em">è¡¨æƒ…åŒ…å¤§å°è®¾ç½®</p><div style="display:flex;flex-direction:column;gap:.75rem"><div style="display:flex;flex-direction:column;gap:.5rem"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:.9em;color:var(--text-secondary)">å°</span> <input type="range" id="sticker-size-slider" min="40" max="200" value="120" style="flex-grow:1;margin:0 10px;accent-color:var(--primary-blue)"/> <span style="font-size:.9em;color:var(--text-secondary)">å¤§</span></div><div style="display:flex;justify-content:center;align-items:center;gap:.5rem"><input type="number" id="sticker-size-input" value="120" min="40" max="200" style="width:70px;padding:8px;border:1px solid var(--border-color);border-radius:5px;text-align:center"/> <span style="font-size:.9em;color:var(--text-secondary)">åƒç´ </span></div></div><div style="display:flex;justify-content:space-between;gap:.5rem;margin-top:.5rem"><button id="sticker-size-small" class="sticker-size-btn"><span class="sticker-size-icon" style="height:16px"></span> <span class="sticker-size-label">å° (80px)</span></button> <button id="sticker-size-medium" class="sticker-size-btn sticker-size-active"><span class="sticker-size-icon" style="height:20px"></span> <span class="sticker-size-label">ä¸­ (120px)</span></button></div><div style="font-size:.8em;color:var(--text-secondary);text-align:center">è°ƒæ•´èŠå¤©ä¸­è¡¨æƒ…åŒ…çš„æ˜¾ç¤ºå¤§å°</div></div></div></main></div><div id="moments-view" class="app-view"><header class="moments-header"><i class="fas fa-chevron-left header-action" id="moments-back-btn"></i> <span class="title">æœ‹å‹åœˆ</span> <i class="fas fa-camera header-action" id="post-moment-btn"></i></header><main class="moments-body"><div class="moments-feed-header"><img src="https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/wallpaper/ç™½è‰²_1.jpg" alt="æœ‹å‹åœˆå°é¢" class="moments-cover-photo" id="moments-cover-photo"/><div class="moments-user-info"><span class="moments-user-name" id="moments-user-name">ç”¨æˆ·å</span> <img src="https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/ç´ æ/å¤´åƒ/é»˜è®¤å¤´åƒ.jpg" alt="ç”¨æˆ·å¤´åƒ" class="moments-user-avatar" id="moments-user-avatar"/></div><div class="user-signature" id="user-signature-display">è¿™é‡Œæ˜¯ä¸ªæ€§ç­¾å...</div></div><ul class="moments-feed-list" id="moments-feed-list"></ul></main></div></div></div><input type="file" id="image-upload-input" accept="image/*" style="display:none"/><div id="theme-editor-modal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;overflow-y:auto"><div class="modal-content" style="background-color:#fff;margin:10% auto;padding:20px;width:80%;max-width:500px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.2)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px"><h2 style="margin:0;color:var(--text-primary);font-size:1.2rem">è‡ªå®šä¹‰ä¸»é¢˜</h2><button id="close-theme-editor" style="background:0 0;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-secondary)">&times;</button></div><div style="margin-bottom:15px"><label style="display:block;margin-bottom:5px;color:var(--text-primary);font-weight:500">ä¸»é¢˜åç§°</label> <input id="theme-name-input" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:5px;box-sizing:border-box" placeholder="æˆ‘çš„è‡ªå®šä¹‰ä¸»é¢˜"/></div><div style="max-height:400px;overflow-y:auto;padding-right:10px"><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">ä¸»é¢˜è‰²</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">ä¸»è‰²è°ƒ</label> <input type="color" id="primary-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">æ¬¡è¦å¼ºè°ƒè‰²</label> <input type="color" id="light-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div><div style="font-size:.8rem;color:var(--text-secondary);margin-top:5px">ä¸»é¢˜è‰²ç”¨äºæŒ‰é’®ã€å›¾æ ‡ã€é“¾æ¥ç­‰äº¤äº’å…ƒç´ </div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">èƒŒæ™¯è‰²</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">åº”ç”¨èƒŒæ™¯è‰²</label> <input type="color" id="ultra-light-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">å¡ç‰‡èƒŒæ™¯è‰²</label> <input type="color" id="deep-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">æ–‡å­—é¢œè‰²</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">ä¸»è¦æ–‡å­—</label> <input type="color" id="text-primary-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">æ¬¡è¦æ–‡å­—</label> <input type="color" id="text-secondary-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">è¾¹æ¡†ä¸é˜´å½±</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">è¾¹æ¡†é¢œè‰²</label> <input type="color" id="border-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">é˜´å½±é¢œè‰²</label> <input type="color" id="shadow-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">çŠ¶æ€æ ä¸çµåŠ¨å²›</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">çŠ¶æ€æ é¢œè‰²</label> <input type="color" id="status-bar-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">çµåŠ¨å²›é¢œè‰²</label> <input type="color" id="dynamic-island-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">æˆ‘çš„æ¶ˆæ¯æ°”æ³¡</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">èƒŒæ™¯é¢œè‰²</label> <input type="color" id="bubble-me-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">æ–‡å­—é¢œè‰²</label> <input type="color" id="bubble-me-text-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">AIæ¶ˆæ¯æ°”æ³¡</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">èƒŒæ™¯é¢œè‰²</label> <input type="color" id="bubble-them-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div><div><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">æ–‡å­—é¢œè‰²</label> <input type="color" id="bubble-them-text-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">æ‰‹æœºè¾¹æ¡†</h3><div style="display:flex;gap:10px;margin-bottom:10px"><div style="flex:1"><label style="display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)">è¾¹æ¡†é¢œè‰²</label> <input type="color" id="phone-frame-color" style="width:100%;height:40px;border:none;border-radius:5px;cursor:pointer"/></div></div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">ä¸»é¢˜æ¨¡å¼</h3><div style="display:flex;align-items:center;position:relative"><input type="checkbox" id="dark-mode-toggle" class="sticker-checkbox" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none"/><div class="sticker-checkbox-button" id="dark-mode-checkbox-button" style="position:relative;width:18px;height:18px;margin-left:2px;margin-right:12px;display:block;border:1px solid #ccc;background:#fff;cursor:pointer"></div><label for="dark-mode-toggle" style="color:var(--text-primary);font-size:.9rem">å¯ç”¨å¤œé—´æ¨¡å¼</label></div><div style="font-size:.8rem;color:var(--text-secondary);margin-top:5px">å¤œé—´æ¨¡å¼ä¼šå°†åº”ç”¨èƒŒæ™¯ã€è®¾ç½®é¡µé¢å’Œå¡ç‰‡ç­‰å…ƒç´ å˜ä¸ºæ·±è‰²</div></div><div style="margin-bottom:20px"><h3 style="margin:0 0 10px 0;color:var(--text-primary);font-size:1rem">å›¾æ ‡æ ·å¼</h3><div style="display:flex;align-items:center;position:relative"><input type="checkbox" id="single-color-icons-toggle" class="sticker-checkbox" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none"/><div class="sticker-checkbox-button" id="single-color-icons-checkbox-button" style="position:relative;width:18px;height:18px;margin-left:2px;margin-right:12px;display:block;border:1px solid #ccc;background:#fff;cursor:pointer"></div><label for="single-color-icons-toggle" style="color:var(--text-primary);font-size:.9rem">ä½¿ç”¨å•ä¸€é¢œè‰²å›¾æ ‡</label></div><div style="font-size:.8rem;color:var(--text-secondary);margin-top:5px">å¯ç”¨åï¼Œå¾®ä¿¡å›¾æ ‡å’Œè®¾ç½®å›¾æ ‡å°†ä½¿ç”¨ä¸»é¢˜è‰²ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ç»¿è‰²å’Œç°è‰²</div></div></div><div style="display:flex;gap:10px;justify-content:center;margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px"><button id="import-theme-btn" style="padding:10px 20px;background:var(--primary-blue);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:500" title="å¯¼å…¥JSONä¸»é¢˜æ–‡ä»¶">å¯¼å…¥</button> <button id="export-json-btn" style="padding:10px 20px;background:var(--primary-blue);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:500" title="å¯¼å‡ºä¸ºJSONæ ¼å¼">å¯¼å‡º</button></div><div style="display:flex;justify-content:space-between;margin-top:20px"><button id="reset-theme-btn" style="padding:10px 15px;background:#f1f5f9;color:var(--text-primary);border:none;border-radius:5px;cursor:pointer;font-weight:500">é‡ç½®</button> <button id="save-theme-btn" style="padding:10px 20px;background:var(--primary-blue);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:500">ä¿å­˜ä¸»é¢˜</button></div></div></div></body></html>