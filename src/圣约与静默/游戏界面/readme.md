# 修道院箱庭游戏界面设计

## 项目理解

本项目是一个以中世纪修道院为背景的百合恋爱文字冒险游戏。玩家将扮演一位外地来的修女，与三位性格各异的可攻略角色（热情洒脱的大姐姐、温和礼貌的同龄少女、表情波动较少的妹妹角色）展开互动和恋爱故事。游戏风格含有微恐怖、微悬疑和恋爱元素。

## 游戏数据结构

根据提供的JSON示例，游戏数据包含以下主要部分：

### 1. 故事（Story）
```json
"story": {
  "date": "Anno Domini 1250, Martius XII",
  "location": "修道院图书室",
  "scene": "办公室",
  "dialogue": [...],
  "options": [...],
  "currentDialogueIndex": 0,
  "currentChapter": "Chapter 2 - Secrets of the Abbey",
  "currentFunds": 50
}
```
- 日期信息：游戏中的时间设定
- 位置和场景：当前玩家所在场景
- 对话数组：包含对话内容、说话者和样式
- 选项数组：当前可选择的对话选项
- 当前对话索引、章节信息和资金等游戏状态

### 2. 角色（Characters）
```json
"characters": {
  "members": [
    {
      "id": "cecilia",
      "name": "Cecilia修女",
      "status": "online",
      "messages": [],
      "stats": { "piety": 66, "scholasticism": 70, ... },
      "role": "Novice Scribe",
      "tags": ["pious", "diligent", "quiet", "curious"],
      "bio": "一位年轻的见习修女...",
      "interests": "...",
      "relationships": "...",
      "mood": 68,
      "affection": 20,
      "isSelected": true,
      "avatar": "https://..."
    },
    ...
  ]
}
```
- 角色基本信息：ID、名称、状态
- 角色属性：虔诚度、学识等数值属性
- 角色背景：职责、标签、传记、兴趣和人际关系
- 情感状态：心情和好感度
- 界面状态：是否被选中、头像URL

### 3. 修道院信息（MonasteryInfo）
```json
"monasteryInfo": {
  "name": "St. Augustine's Abbey",
  "basicInfo": { "reputation": 62, "knowledgeLevel": 58, "resourcesAccumulated": 120 },
  "achievements": [],
  "schedule": [
    { "time": "Dawn", "activity": "Matins (Morning Prayer)" },
    ...
  ]
}
```
- 修道院基本信息：名称、声誉、知识水平和资源
- 成就列表
- 修道院日程表

### 4. 知识库（Knowledge）
```json
"knowledge": [
  {
    "id": "K001",
    "title": "Scriptorium Rules",
    "category": "Monastery Life",
    "content": "...",
    "discovered": true
  },
  ...
]
```
- 知识条目：ID、标题、分类、内容
- 发现状态：是否已被玩家发现

### 5. 故事总结/记忆（StorySummary）
```json
"storySummary": [
  { "id": 1, "content": "Player arrives at St. Augustine's Abbey..." },
  ...
]
```
- 故事关键节点的简短总结，作为记忆系统的基础
- 包含ID和内容描述

## 界面设计计划

### 核心界面组件

1. **主游戏窗口**
   - 背景图区域（顶部）：根据`story.scene`和`story.location`显示对应场景
   - 角色立绘区域（中部）：显示`characters.members`中`isSelected`为true的角色
   - 对话框区域（底部）：显示`story.dialogue`中的内容，支持不同`style`样式
   - 选择区域（对话框下方）：显示`story.options`中的选项

2. **对话系统**
   - 支持角色名称（`dialogue[].speaker`）与对话内容（`dialogue[].content`）分离显示
   - 根据`dialogue[].style`应用不同的文本样式（normal, whisper, shocked, special等）
   - 打字机效果实现文本逐字显示
   - 自动播放功能，可设定对话间隔时间
   - 对话回放功能，允许返回查看之前的对话

3. **选择系统**
   - 预设选项展示：显示`story.options`中的选项
   - 自定义选项输入框：允许玩家输入自定义行动
   - 实时生成响应的选择结果：通过API调用生成新的游戏状态JSON

4. **场景系统**
   - 多场景背景支持：根据`story.location`和`story.scene`加载不同背景
   - 场景切换淡入淡出效果
   - 位置选择界面：显示可前往的位置列表

5. **角色立绘系统**
   - 左右两侧角色位置：根据对话中的角色显示对应立绘
   - 表情/姿势切换功能：根据`dialogue[].style`切换角色表情
   - 角色入场和离场动画：根据对话内容触发相应动画

6. **历史记录系统**
   - 对话历史记录面板：显示已进行的所有对话
   - 快速查看和导航功能

7. **状态面板**
   - 角色属性面板：显示角色的各项属性值（`characters.members[].stats`）
   - 修道院状态面板：显示修道院的基本信息（`monasteryInfo.basicInfo`）
   - 知识库面板：显示已发现的知识（`knowledge`）

8. **记忆系统（基于storySummary）**
   - 时间轴形式展示`storySummary`中的关键剧情节点
   - 每次对话生成的JSON都自动添加简短总结到`storySummary`中
   - 提供关键剧情的回顾和总结
   - 支持从记忆点直接跳转功能

9. **金色怀表（时间旅行机制）**
   - 主角专属特殊道具，UI中以金色怀表图标表示
   - 允许玩家随时"回到过去"的关键时间点（基于`storySummary`条目）
   - 根据记忆中的总结重建/重新生成对话数据，而非简单加载存档
   - 时间旅行相关的视觉效果和动画
   - 与游戏故事背景相结合的时间旅行机制

### 视觉设计规范

#### 色彩方案
- 主色调：金色 (#8a6d3b) - 与金色怀表相呼应
- 辅助色：紫色 (#8c56d3) - 用于时间旅行和特殊功能效果
- 背景色：深灰 (#2a2a2a)，容器背景为略浅灰 (#333)
- 文字色：浅灰 (#d1d1d1)，次要文本为中灰 (#888)
- 对话样式色彩：
  - normal: 默认文字色
  - whisper: 淡蓝色 (#a8c5e9)
  - shocked: 浅红色 (#e9a8a8)
  - special: 紫金色渐变效果（#8c56d3 -> #8a6d3b）

#### 排版与字体
- 标题字体：Cinzel (衬线字体)
- 正文字体：Lato (无衬线字体)
- 层次化文本设计：
  - 角色名称：Cinzel, 18px, 金色
  - 对话内容：Lato, 16px, 浅灰色
  - 旁白文本：Lato斜体, 16px, 中灰色
  - 选项文本：Lato, 15px, 浅灰色

#### 界面元素
- 半透明效果的对话框和控制面板
- 卡片式布局设计
- 圆角边框设计
- 明确的视觉反馈（悬停效果、活跃状态）
- 平滑的动画过渡
- 全面的响应式设计

## 技术实现计划

### 1. 基础结构设置
- 创建基本HTML结构
- 设置CSS变量和基础样式
- 导入所需字体和图标
- 创建基本的布局组件和页面结构

### 2. 数据模型开发
- 创建游戏状态数据模型，与提供的JSON格式一致
- 设计状态管理系统，处理游戏数据的更新和传递
- 实现数据验证和错误处理机制

### 3. 核心功能实现
- **对话系统**：
  - 开发对话数据处理逻辑
  - 利用SillyTavern的`generate`函数实现对话生成
  - 实现打字机效果（利用`should_stream: true`参数）
  - 创建对话样式渲染系统，支持不同样式（normal, whisper, shocked, special）
  
- **选择系统**：
  - 创建选择UI组件
  - 实现选项点击处理逻辑
  - 开发自定义选项输入和处理功能
  - 集成与LLM的交互，处理选择后的游戏状态更新

- **场景系统**：
  - 实现场景数据与背景图片的映射
  - 开发场景切换动画和效果
  - 创建位置选择界面和导航功能

- **角色立绘系统**：
  - 创建角色立绘显示组件
  - 实现立绘位置管理（左、右侧）
  - 开发表情切换功能，映射dialogue.style到对应表情
  - 实现角色入场和离场动画

### 4. 高级功能开发
- **记忆系统**：
  - 开发自动总结机制，为新对话生成简短记忆描述
  - 创建时间轴UI组件，展示storySummary条目
  - 实现记忆点选择和查看功能
  - 开发记忆搜索和过滤功能

- **金色怀表时间旅行**：
  - 设计金色怀表UI元素
  - 实现时间旅行动画效果
  - 开发基于storySummary的游戏状态重建机制
  - 创建时间点选择界面

- **状态跟踪系统**：
  - 创建角色属性和状态显示组件
  - 实现修道院信息和资源管理界面
  - 开发知识库UI和交互功能

### 5. UI组件开发
- 实现所有UI组件，包括对话框、选择框、历史记录等
- 设计并实现金色怀表界面元素和时间旅行动画效果
- 开发记忆时间轴界面，支持记忆浏览和时间点选择
- 确保所有组件的响应式设计
- 实现必要的动画和过渡效果

### 6. 数据管理
- 使用JSON格式存储游戏状态，与提供的示例保持一致
- 实现存档机制，将数据保存在Lorebook中
- 设计数据结构支持游戏进度和状态跟踪
- 开发自动总结机制，为每次对话生成简短记忆描述
- 实现数据版本控制，确保向后兼容性

### 7. 集成SillyTavern API
- 利用`generate`和`generateRaw`函数实现文本生成
- 监听流式传输事件实现打字机效果
- 实现存档和读档功能
- 开发基于记忆总结的对话重建机制，支持时间旅行功能
- 创建API调用封装，处理错误和异常情况

### 8. 测试与优化
- 测试所有功能和UI组件
- 优化性能和用户体验
- 特别测试时间旅行机制的稳定性和对话重建的准确性
- 修复发现的问题
- 进行用户体验测试，收集反馈并优化

## 数据获取方法

根据用户建议，可以使用以下方法获取游戏数据：
```javascript
// 获取当前消息ID的所有文本内容
function getGameData() {
  const allText = getChatMessages(getCurrentMessageId())[0];
  // 使用正则表达式提取<gametext>标签内的JSON数据
  const regex = /<gametext>([\s\S]*?)<\/gametext>/;
  const match = allText.match(regex);
  
  if (match && match[1]) {
    try {
      // 解析JSON数据
      return JSON.parse(match[1]);
    } catch (error) {
      console.error("JSON解析错误:", error);
      return null;
    }
  }
  return null;
}
```

## 详细行动计划

### 1. 创建基础HTML结构和CSS样式
#### 1.1 基础文件结构
- 创建项目目录结构
- 设置基本HTML文件
- 创建CSS、JavaScript和资源文件夹
- 编写基础HTML模板，包含必要的元信息和链接

#### 1.2 CSS变量和样式系统
- 定义全局CSS变量，包含所有颜色和尺寸
- 创建基础样式表，实现全局样式重置
- 设计响应式布局系统，使用CSS Grid和Flexbox
- 实现主题切换机制（预留功能）

#### 1.3 字体和图标集成
- 整合Cinzel和Lato字体（本地或通过CDN）
- 引入必要的图标库（FontAwesome或自定义SVG）
- 创建字体回退机制，确保不同环境下的一致性
- 优化字体加载性能

#### 1.4 基础UI组件开发
- 开发按钮、输入框、卡片等基础组件
- 创建对话框和弹窗组件模板
- 实现基本动画和过渡效果
- 设计加载状态和错误提示组件

### 2. 开发游戏数据模型和状态管理系统
#### 2.1 数据模型定义
- 定义游戏核心数据结构，对应JSON格式
- 创建Story、Character、MonasteryInfo、Knowledge和StorySummary类
- 实现数据验证和类型检查
- 开发数据模型的序列化和反序列化方法

#### 2.2 状态管理系统
- 设计状态管理架构（发布-订阅模式或类似Redux的单向数据流）
- 实现状态更新机制和事件系统
- 开发状态变更监听器和响应机制
- 创建状态快照和回滚功能（用于时间旅行）

#### 2.3 数据持久化机制
- 设计本地存储方案
- 实现存档和读档功能
- 开发数据导入导出功能
- 创建自动保存机制和备份系统

### 3. 实现核心对话系统
#### 3.1 对话数据处理
- 设计对话数据结构和管理类
- 实现对话队列和显示逻辑
- 开发对话状态追踪系统
- 创建对话筛选和搜索功能

#### 3.2 打字机效果实现
- 与SillyTavern API集成，使用流式传输
- 实现字符逐个显示的动画效果
- 开发打字速度控制和跳过功能
- 处理特殊字符和标点的显示效果

#### 3.3 对话样式系统
- 实现不同样式（normal, whisper, shocked, special）的渲染
- 开发文本格式化工具，处理强调、引用等特殊格式
- 创建角色专属样式系统
- 实现对话气泡和布局适配

#### 3.4 对话控制系统
- 开发自动播放控制功能
- 实现对话前进、后退和跳转
- 创建对话历史浏览器
- 设计对话区域滚动和定位系统

### 4. 实现角色立绘和背景系统
#### 4.1 资源加载系统
- 设计图像预加载机制
- 实现图像缓存和内存管理
- 开发资源加载状态显示
- 创建资源加载错误处理

#### 4.2 背景管理系统
- 实现场景与背景图映射
- 开发背景切换过渡效果
- 创建背景位置和缩放控制
- 设计动态背景效果（光照变化、微动画等）

#### 4.3 角色立绘组件
- 实现角色立绘显示和管理
- 开发表情和姿势切换系统
- 创建角色位置控制（左、中、右）
- 设计多角色同时显示的布局管理

#### 4.4 角色动画系统
- 实现角色入场和离场动画
- 开发表情变化过渡效果
- 创建角色强调动画（说话时）
- 设计情绪表达动画（震惊、喜悦等）

### 5. 开发选择系统
#### 5.1 选项UI组件
- 设计选项按钮和容器样式
- 实现选项高亮和悬停效果
- 开发选项禁用状态显示
- 创建选项群组和布局管理

#### 5.2 选项交互逻辑
- 实现选项点击事件处理
- 开发选项选择后的反馈效果
- 创建选项依赖和条件控制系统
- 设计选项超时和默认选择机制

#### 5.3 自定义输入功能
- 设计自定义输入UI组件
- 实现输入验证和提示系统
- 开发输入历史记录功能
- 创建输入联想和补全功能

#### 5.4 选择结果处理
- 集成LLM生成系统
- 实现选择结果的状态更新
- 开发选择分支记录系统
- 创建选择结果的动态动画效果

### 6. 设计和实现记忆系统和金色怀表时间旅行机制
#### 6.1 记忆数据管理
- 设计记忆点数据结构和存储
- 实现记忆点自动生成机制
- 开发记忆点编辑和管理功能
- 创建记忆点重要性标记系统

#### 6.2 记忆时间轴UI
- 设计时间轴视觉样式和交互方式
- 实现时间点显示和高亮效果
- 开发时间轴缩放和导航控制
- 创建重要事件的视觉区分

#### 6.3 金色怀表UI设计
- 设计怀表图标和动画效果
- 实现怀表交互控制界面
- 开发怀表状态和反馈系统
- 创建怀表特殊效果（光效、粒子等）

#### 6.4 时间旅行机制
- 实现基于记忆点的游戏状态重建
- 开发时间旅行过渡动画和效果
- 创建时间旅行历史记录系统
- 设计时间悖论提示和解决机制
- 实现时间线分支和管理系统

### 7. 开发状态跟踪和知识库界面
#### 7.1 角色属性面板
- 设计角色属性UI组件
- 实现属性值的可视化显示（数值条、图表等）
- 开发属性变化动画和强调效果
- 创建角色关系网络可视化

#### 7.2 修道院状态界面
- 设计修道院信息展示面板
- 实现资源和声誉显示系统
- 开发成就解锁和显示机制
- 创建日程表和活动管理界面

#### 7.3 知识库系统
- 设计知识库UI和导航结构
- 实现知识条目的分类和筛选
- 开发知识解锁和提示机制
- 创建知识搜索和索引功能
- 实现知识关联和推荐系统

### 8. 实现历史记录和存档功能
#### 8.1 对话历史记录
- 设计历史记录UI和布局
- 实现历史浏览和搜索功能
- 开发历史导出和分享功能
- 创建历史记录筛选系统

#### 8.2 存档管理系统
- 设计存档UI和交互方式
- 实现存档创建、读取和删除功能
- 开发存档预览和比较功能
- 创建自动存档和备份机制
- 实现存档云同步功能（预留）

### 9. 完善UI细节和动画效果
#### 9.1 UI细节优化
- 完善所有组件的视觉效果
- 实现一致的色彩和排版体系
- 开发深色/浅色主题切换（预留）
- 创建焦点和导航提示系统

#### 9.2 动画系统增强
- 细化所有过渡和交互动画
- 实现高级视觉效果（粒子、光效等）
- 开发动画时序和协调系统
- 创建性能优化的动画引擎

#### 9.3 反馈系统完善
- 增强视觉和音频反馈
- 实现提示和引导系统
- 开发成就和里程碑通知
- 创建游戏内教程和帮助系统

### 10. 进行全面测试和优化
#### 10.1 功能测试
- 进行全面的功能测试
- 验证所有交互流程
- 测试边缘情况和错误处理
- 验证数据一致性和存储可靠性

#### 10.2 性能优化
- 进行性能分析和瓶颈识别
- 优化资源加载和内存使用
- 提高渲染效率和动画性能
- 减少不必要的网络请求

#### 10.3 用户体验测试
- 收集用户反馈和使用数据
- 分析交互痛点和改进机会
- 评估易用性和学习曲线
- 检查可访问性合规性

#### 10.4 最终调整和发布准备
- 修复发现的所有问题
- 进行最终的视觉调整
- 准备发布文档和指南
- 创建版本发布计划和更新路径

### 关键里程碑
1. **基础框架完成**：基本UI组件和样式系统就绪
2. **核心功能可用**：对话、立绘和选择系统功能完整
3. **高级功能整合**：记忆系统和时间旅行机制可用
4. **完整游戏体验**：所有功能和UI细节完善
5. **发布就绪版本**：经过测试和优化的最终版本


设置中的手机界面选项应当有三个挡位：自适应、手机、电脑

当使用手机或者电脑的时候取消响应式设计，必须强行使用手机或者电脑的界面

请你查看我的文件结构@游戏界面 
使用TypeScript的最佳实践，并且你可以使用jQuery和lodash库。
