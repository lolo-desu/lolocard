å®Œæ•´çš„HTMLä»£ç 
```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿå…‰å°‘å¥³ - åŸ¹å…»å¥³å›¢æ­£å¼æ¸¸æˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
    /* Import Font */
@import url("https://fontsapi.zeoseven.com/382/main/result.css");

/* --- Base Variables --- */
:root {
   --primary-color: #FF69B4;
   --secondary-color: #FFB6C1;
   --accent-color: #FF1493;
   --bg-color: #FFF0F5;
   --text-color: #333;
   --primary-color-rgb: 255, 105, 180;
   --placeholder-image: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; /* Tiny transparent pixel */
}

/* --- Base Layout & Fixed Height --- */
html, body {
   height: 900px; /* Keep fixed height */
   overflow: hidden; /* Prevent body scroll */
   margin: 0; padding: 0;
}
body {
   font-family: "MaokenAssortedSans", sans-serif;
   font-weight: normal;
   background-color: var(--bg-color);
   color: var(--text-color);
   display: flex;
   flex-direction: column;
   height: 100%; /* Fill fixed html height */
   user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
}
/* Allow Text Selection in Specific Elements */
input, textarea, .text-box, .message-text,
.chapter-modal-body .chapter-content p, #customOptionInput
{ user-select: auto; -webkit-user-select: auto; -moz-user-select: auto; -ms-user-select: auto; }

.container-fluid {
   padding: 0;
   flex: 1; /* Fill body */
   display: flex;
   flex-direction: column;
   height: 100%; /* Fill body's flex space */
   overflow: hidden; /* Prevent container scroll */
   min-height: 0; /* Prevent flex blowout */
}

/* --- Navigation Bar --- */
.nav-tabs {
   background-color: var(--primary-color);
   border: none;
   flex-shrink: 0; /* Prevent vertical compression */
   display: flex;
   flex-wrap: wrap; /* Allow wrapping by default on smaller screens */
   padding: 0.2rem 0.5rem;
   overflow: hidden; /* Hide potential overflow when wrapped */
   /* Horizontal scroll for larger screens will be handled by media query */
}

.nav-tabs .nav-link {
   color: white; border: none; padding: 0.7rem 1.2rem;
   transition: all 0.3s ease; white-space: nowrap;
   display: flex; align-items: center; gap: 0.5rem;
   border-radius: 5px;
   margin: 0.2rem;
}
.nav-tabs .nav-link:hover { background-color: var(--accent-color); color: white; }
.nav-tabs .nav-link.active { background-color: var(--secondary-color); color: var(--text-color); font-weight: bold; }

/* --- Content Area (Primary Scroll Container) --- */
.content-area {
   padding: 1.5rem;
   flex-grow: 1; /* Fill remaining vertical space */
   overflow-y: auto; /* ã€å…³é”®ã€‘Allow content to scroll vertically */
   overflow-x: hidden; /* Prevent horizontal scroll */
   min-height: 0; /* Prevent flex blowout */
}

/* --- Page Switching --- */
.page {
    display: none;
    animation: fadeIn 0.5s ease;
    /* ã€ä¿®æ”¹ã€‘ç§»é™¤ height: 100%ï¼Œè®©é¡µé¢é«˜åº¦ç”±å†…å®¹å†³å®š */
    /* height: 100%; */
    overflow-x: hidden; /* Prevent horizontal overflow within page */
    /* ã€æ–°å¢ã€‘ç¡®ä¿é¡µé¢åœ¨ flex å®¹å™¨ä¸­æ­£ç¡®è¡¨ç° */
    flex-shrink: 0; /* é€šå¸¸ä¸éœ€è¦æ”¶ç¼© */
    width: 100%; /* å æ®çˆ¶å®¹å™¨å®½åº¦ */
}
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- General Buttons --- */
.btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
.btn-primary:hover { background-color: var(--accent-color); border-color: var(--accent-color); }
.btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); }
.btn-outline-primary:hover { background-color: var(--primary-color); color: white; }
.btn-outline-light { color: #f8f9fa; border-color: #f8f9fa; }
.btn-outline-light:hover { color: #333; background-color: #f8f9fa; border-color: #f8f9fa; }

/* --- Story Page Layout --- */
.game-container {
           max-width: 1000px; /* ä¿æŒæœ€å¤§å®½åº¦é™åˆ¶ */
           width: 100%;
           margin-left: auto;
           margin-right: auto;
           background: white;
           border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1);
           /* ã€ä¿®æ”¹ã€‘è®© flex æ§åˆ¶é«˜åº¦ï¼Œå¹¶æ·»åŠ  gap */
           /* min-height: 500px; */ /* å¯ä»¥ç§»é™¤æˆ–ä¿ç•™ï¼Œflex ä¼šå¤„ç†é«˜åº¦ */
           display: flex; flex-direction: column;
           overflow: hidden;
           gap: 1rem; /* ã€æ–°å¢ã€‘åœ¨å­å…ƒç´ ä¹‹é—´æ·»åŠ  1rem çš„é—´è· */
           /* ã€æ–°å¢ã€‘ç¡®ä¿ flex å®¹å™¨èƒ½è®¡ç®—é«˜åº¦ï¼Œå³ä½¿å†…å®¹ä¸è¶³ä¹Ÿæ’‘å¼€ */
           min-height: 600px; /* æˆ–æ ¹æ®éœ€è¦è°ƒæ•´ï¼Œä¿è¯åŸºæœ¬å¸ƒå±€ */
           padding-bottom: 1rem; /* ã€æ–°å¢ã€‘ç»™åº•éƒ¨ä¹Ÿç•™ç‚¹ç©ºé—´ */
           box-sizing: border-box; /* ç¡®ä¿ padding ä¸å¢åŠ æ€»é«˜åº¦ */
       }
.info-bar {
   display: flex; justify-content: space-between; align-items: center;
   padding: 0.8rem 1.5rem; background: var(--primary-color); color: white;
   min-height: 50px; flex-shrink: 0;
}
.info-bar .date-location { flex-grow: 1; display: flex; align-items: center; gap: 1rem; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.info-bar .date-location span { white-space: nowrap; }
.info-bar > button { margin-left: 0.5rem; flex-shrink: 0; }

.vn-container {
           position: relative; width: 100%;
           /* ã€ä¿®æ”¹ã€‘æ˜¾è‘—å¢åŠ  VN å®¹å™¨çš„é«˜åº¦æ¯”ä¾‹ */
           height: 70%; /* ç¤ºä¾‹ï¼šå¢åŠ åˆ° 70% */
           min-height: 400px; /* ã€è°ƒæ•´ã€‘å¯ä»¥é€‚å½“å¢åŠ æœ€å°é«˜åº¦ */
           background-color: #000; overflow: hidden; display: flex; flex-direction: column;
           flex-shrink: 0; /* ä¿æŒä¸å‹ç¼© */
       }
.scene-container { position: relative; width: 100%; flex-grow: 1; background-size: cover; background-position: center; background-repeat: no-repeat; }
.effect-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
.effect-overlay.horror { animation: horror 0.5s infinite; background: rgba(255, 0, 0, 0.1); }
.effect-overlay.insane { animation: insane 0.3s infinite; background: rgba(0, 255, 255, 0.1); }
.text-box-container {
           position: absolute; bottom: 0; left: 0; width: 100%;
           padding: 15px; z-index: 1000;
           /* ã€è°ƒæ•´ã€‘å¯ä»¥å¾®è°ƒæ–‡æœ¬æ¡†åŒºåŸŸçš„æœ€å¤§é«˜åº¦ */
           max-height: 40%; /* ç¤ºä¾‹ï¼šç•¥å¾®å‡å°‘ */
           box-sizing: border-box;
       }
       .name-box {
           display: inline-block; /* æˆ–è€… blockï¼Œå–å†³äºä½ æƒ³è¦çš„å®½åº¦ */
           background-color: rgba(0, 0, 0, 0.7);
           color: #fff; padding: 5px 15px; border-radius: 5px; margin-bottom: 5px; font-weight: bold;
           flex-shrink: 0; /* ä¸å‹ç¼© */
           width: fit-content; /* è®©å®½åº¦é€‚åº”å†…å®¹ */
           max-width: 80%; /* é˜²æ­¢åå­—è¿‡é•¿æ—¶æ’‘æ»¡ */
       }
       .text-box {
           background-color: rgba(0, 0, 0, 0.7);
           color: #fff; padding: 10px 15px; /* å¯ä»¥ç¨å¾®è°ƒæ•´ padding */
           border-radius: 5px; font-size: 1em; line-height: 1.6;
           width: 100%; box-sizing: border-box;
           max-height: 150px; /* ä¿æŒæœ€å¤§é«˜åº¦ */
           overflow-y: auto; /* ä¿æŒå†…éƒ¨æ»šåŠ¨ */
           margin-bottom: 8px; /* è°ƒæ•´ä¸æŒ‰é’®çš„é—´è· */
           padding-right: 5px; /* Scrollbar padding */
           /* æ–°å¢ Flexbox å±æ€§ */
           flex-grow: 1; /* å°è¯•å¡«å……ç©ºé—´ï¼Œä½†å— max-height é™åˆ¶ */
           min-height: 0; /* å…è®¸åœ¨ flex å¸ƒå±€ä¸­æ”¶ç¼© */
       }
       .text-box.text-box-horror { background-color: rgba(139, 0, 0, 0.6); /* ... */ }
       .text-box.text-box-insane { background-color: rgba(0, 0, 139, 0.6); /* ... */ }
       .text-controls {
           display: flex; justify-content: flex-end; gap: 10px;
           margin-top: auto; /* å°†æŒ‰é’®æ¨åˆ°åº•éƒ¨ï¼ˆç›¸å¯¹äº text-box-containerï¼‰*/
           padding-top: 5px; /* å¢åŠ ä¸€ç‚¹é¡¶éƒ¨ç©ºé—´ */
           flex-shrink: 0; /* ä¸å‹ç¼© */
       }
.text-btn { background-color: rgba(0, 0, 0, 0.5); border: 1px solid #fff; color: #fff; padding: 5px 15px; cursor: pointer; transition: all 0.2s; }
.text-btn:hover { background-color: rgba(255, 255, 255, 0.2); }
.character-sprite {
           position: absolute;
           bottom: 0;
           height: 75%; /* ã€è°ƒæ•´ã€‘å¯ä»¥ç›¸å¯¹äºæ–°çš„ VN é«˜åº¦å†å¾®è°ƒ */
           max-width: 38%; /* ã€è°ƒæ•´ã€‘å¯ä»¥ç›¸å¯¹äºæ–°çš„ VN å®½åº¦å†å¾®è°ƒ */
           object-fit: contain;
           transition: all 0.3s ease;
           z-index: 2;
           filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.3));
       }
       .character-sprite.left {
           left: 5%; /* ç¤ºä¾‹ï¼šè°ƒæ•´èµ·å§‹ä½ç½® */
           transform: translateX(-30px); opacity: 0; animation: slideInLeft 0.5s forwards;
       }
.character-sprite.right { right: 20px; transform: translateX(30px) scaleX(-1); opacity: 0; animation: slideInRight 0.5s forwards; }
@keyframes slideInLeft { to { transform: translateX(0); opacity: 1; } }
       .character-sprite.right {
            /* æ³¨æ„ï¼šscaleX(-1) ä¼šå½±å“ transform-origin å’Œå®šä½ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ right å€¼ */
           right: 5%; /* ç¤ºä¾‹ï¼šè°ƒæ•´èµ·å§‹ä½ç½® */
           transform: translateX(30px) scaleX(-1); opacity: 0; animation: slideInRight 0.5s forwards;
       }
        @keyframes slideInRight { to { transform: translateX(0) scaleX(-1); opacity: 1; } }
.text-normal { color: #fff; } .text-angry { color: #ff6b6b; } .text-insane { color: #00ffff; text-shadow: 0 0 5px #00ffff; } .text-whisper { color: #aaa; font-style: italic; } .text-horror { color: #ff0000; text-shadow: 0 0 5px #ff0000; } .text-shocked { color: #ffff00; } .text-sad { color: #87ceeb; } .text-despair { color: #800080; } .text-happy { color: #00ff00; } .text-excited { color: #ffd000; }
@keyframes horror { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }
@keyframes insane { 0% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.02) rotate(1deg); } 100% { transform: scale(1) rotate(0deg); } }

.interaction-options {
           border-radius: 16px;
           box-shadow: 0 8px 20px rgba(0,0,0,0.1); background: rgba(255, 255, 255, 0.8);
           backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
           border: 1px solid rgba(255, 255, 255, 0.3); transition: box-shadow 0.3s ease;
           width: 100%; max-width: 100%; flex-shrink: 0;
           /* ã€ä¿®æ”¹ã€‘å‡å°‘æœ€å¤§é«˜åº¦å æ¯” */
           max-height: 28%; /* ç¤ºä¾‹ï¼šå‡å°‘åˆ° 28% */
           overflow: hidden;
           display: flex;
           flex-direction: column;
       }
.options-header {
    padding: 1rem 1.5rem; background: linear-gradient(135deg, var(--primary-color), #8e44ad); color: white; border-top-left-radius: 16px; border-top-right-radius: 16px; flex-shrink: 0;
}
.options-header h4 { margin: 0; font-size: 1.2rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); position: relative; }
.options-header h4:after { content: ''; position: absolute; bottom: -8px; left: 0; width: 40px; height: 3px; background: rgba(255, 255, 255, 0.7); border-radius: 3px; }

.options-list {
    padding: 1rem 1.5rem;
    overflow-y: auto; /* Internal scrolling */
    flex-grow: 1; /* Fill available space */
    padding-right: 5px; /* Scrollbar padding */
}
.btn-option {
    text-align: left; background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 0.8rem 1.2rem; margin-bottom: 0.8rem; transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); width: 100%; box-sizing: border-box; color: var(--text-color); font-size: 0.95em;
}
.btn-option:hover:not(:disabled) { background: rgba(255, 255, 255, 0.9); border-color: var(--primary-color); transform: none; box-shadow: 0 8px 15px rgba(var(--primary-color-rgb), 0.1); }
.btn-option:disabled { opacity: 0.6; cursor: not-allowed; background: rgba(230, 230, 230, 0.7); border-color: rgba(0,0,0,0.05); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.custom-option-input { margin-top: 1rem; padding: 0 1.5rem 1rem; flex-shrink: 0; }

/* --- Contact Page --- */
.contact-container {
    display: grid;
    grid-template-columns: 280px 1fr 300px;
    gap: 1rem;
    /* height: 100%; */ /* Removed */
    max-width: 1200px;
    margin: 0 auto;
    /* Let height be determined by content */
}
.contact-sidebar { background: white; border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; /* Keeps internal structure */ }
.contact-search { padding: 1rem; border-bottom: 1px solid #eee; flex-shrink: 0; }
.contact-list { overflow-y: auto; flex-grow: 1; padding-right: 5px; /* Scrollbar padding */ }
.contact-item { display: flex; align-items: center; padding: 1rem; cursor: pointer; border-bottom: 1px solid #f5f5f5; transition: all 0.3s ease; }
.contact-item:hover, .contact-item.active { background: var(--bg-color); }
.contact-avatar { position: relative; margin-right: 0.8rem; flex-shrink: 0; }
.contact-avatar img { width: 50px; height: 50px; border-radius: 25px; object-fit: cover; }
.status-badge { position: absolute; width: 12px; height: 12px; border-radius: 50%; right: 0; bottom: 0; border: 2px solid white; }
.status-badge.online { background-color: #00C851; } .status-badge.busy { background-color: #ff4444; } .status-badge.away { background-color: #ffbb33; } .status-badge.offline { background-color: #bbb; }
.contact-info { flex-grow: 1; overflow: hidden; }
.contact-name-time { display: flex; justify-content: space-between; margin-bottom: 0.3rem; }
.contact-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.contact-time { font-size: 0.8rem; color: #777; flex-shrink: 0; margin-left: 0.5rem; }
.contact-preview { display: flex; justify-content: space-between; align-items: center; }
.preview-text { color: #666; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.unread-badge { background-color: var(--primary-color); color: white; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 10px; min-width: 18px; text-align: center; flex-shrink: 0; margin-left: 0.5rem; }
.chat-area { background: white; border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; /* Keeps internal structure */ }
.chat-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; min-height: 70px; flex-shrink: 0; }
.chat-title { display: flex; align-items: center; flex-grow: 1; overflow: hidden; }
.chat-title img { width: 40px; height: 40px; border-radius: 20px; margin-right: 0.8rem; object-fit: cover; flex-shrink: 0; }
.chat-title h3 { margin: 0; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
.chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; background-color: #f9f9f9; display: flex; flex-direction: column; padding-right: 5px; /* Scrollbar padding */ min-height: 200px; /* Ensure minimum space */ }
.empty-chat { text-align: center; padding: 3rem 1rem; color: #aaa; font-style: italic; }
.message-date { text-align: center; margin: 1rem 0; position: relative; }
.message-date span { background-color: rgba(0,0,0,0.1); color: #777; font-size: 0.8rem; padding: 0.3rem 1rem; border-radius: 15px; }
.message-system { text-align: center; margin: 0.5rem 0; }
.message-system span { background-color: rgba(0,0,0,0.05); color: #777; font-size: 0.8rem; padding: 0.3rem 1rem; border-radius: 15px; }
.chat-message { display: flex; margin-bottom: 1rem; max-width: 80%; }
.chat-message.received { align-self: flex-start; }
.chat-message.received.ai-typing .message-text { font-style: italic; color: #888; }
.chat-message.sent { align-self: flex-end; flex-direction: row-reverse; }
.message-avatar { width: 36px; height: 36px; border-radius: 18px; margin: 0 0.5rem; align-self: flex-end; object-fit: cover; flex-shrink: 0; }
.message-content { background: white; padding: 0.8rem; border-radius: 0.8rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
.chat-message.received .message-content { border-bottom-left-radius: 0; }
.chat-message.sent .message-content { background-color: var(--primary-color); color: white; border-bottom-right-radius: 0; }
.message-text { word-break: break-word; }
.message-text img { max-width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; cursor: pointer; }
.message-time { font-size: 0.7rem; color: #999; text-align: right; margin-top: 0.3rem; }
.chat-message.sent .message-time { color: rgba(255,255,255,0.8); }
.chat-input { padding: 1rem; border-top: 1px solid #eee; background-color: white; flex-shrink: 0; }
.chat-input .btn { min-width: 40px; }
.member-profile { background: white; border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.1); padding: 1.5rem; overflow-y: auto; display: block; /* height: 100%; */ /* Removed */ padding-right: 5px; /* Scrollbar padding */ }
.profile-header { text-align: center; margin-bottom: 1.5rem; }
.profile-avatar { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 1rem; object-fit: cover; }
.profile-tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; margin-top: 0.8rem; }
.tag { background: var(--secondary-color); color: var(--text-color); padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; }
.profile-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
.stat-item { text-align: center; }
.stat-value { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
.stat-label { font-size: 0.75rem; color: #666; }
.profile-info h4 { color: var(--accent-color); margin: 1rem 0 0.5rem; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 0.3rem; }
.profile-info p { font-size: 0.85rem; line-height: 1.6; color: #555; }
.empty-profile { /* height: 100%; */ /* Removed */ min-height: 300px; /* Ensure it takes some space */ display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; gap: 1rem; text-align: center; }


/* --- Team Page --- */
.team-container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
.team-header { background-color: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 0 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
.team-info h2 { color: var(--accent-color); margin-bottom: 0.5rem; }
.team-stats { display: flex; gap: 1.5rem; flex-wrap: wrap; }
.stat { display: flex; align-items: center; color: #666; font-size: 0.9em; }
.stat i { color: var(--primary-color); margin-right: 0.5rem; }
.team-actions { display: flex; gap: 0.8rem; }
.section-title { padding: 0.8rem 0; margin: 1.5rem 0 1rem; font-size: 1.2rem; color: var(--accent-color); border-bottom: 1px solid #eee; padding-bottom: 0.5rem; display: flex; align-items: center; }
.section-title i { margin-right: 0.5rem; }
.members-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; padding: 0; }
.member-card.horizontal { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; border: 1px solid #eee; }
.member-card.horizontal:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(var(--primary-color-rgb), 0.15); border-color: var(--secondary-color); }
.member-card-content { display: flex; align-items: stretch; }
.member-avatar-container { flex-shrink: 0; width: 120px; position: relative; background-color: var(--bg-color); display: flex; align-items: center; justify-content: center; padding: 15px; }
.member-avatar-large { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); }
.member-role-badge {
    position: absolute;
    bottom: 10px;
    left: 5%; /* è®©å®ƒä»å·¦è¾¹å¼€å§‹ï¼Œè€Œä¸æ˜¯å±…ä¸­ */
    transform: none; /* ç§»é™¤ transform */
    /* æˆ–è€…ï¼Œå¦‚æœä½ ä»æƒ³å±…ä¸­ä½†é™åˆ¶å®½åº¦ï¼š */
    /* left: 50%; */
    /* transform: translateX(-50%); */
    width: 90%; /* é™åˆ¶å®½åº¦ä¸ºçˆ¶å®¹å™¨çš„90% */
    max-width: calc(100% - 20px); /* æ›´ç²¾ç¡®åœ°é™åˆ¶æœ€å¤§å®½åº¦ï¼Œç•™å‡ºè¾¹è· */
    box-sizing: border-box; /* ç¡®ä¿ padding ä¸ä¼šå¢åŠ æ€»å®½åº¦ */

    background-color: var(--primary-color);
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 600;

    /* æ·»åŠ æ–‡æœ¬æº¢å‡ºå¤„ç† */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center; /* æ–‡æœ¬å±…ä¸­æ˜¾ç¤º */
}
.member-details-container { flex-grow: 1; padding: 15px 20px; display: flex; flex-direction: column; justify-content: space-between; }
.member-header { margin-bottom: 12px; }
.member-name { font-size: 1.2em; font-weight: 700; color: var(--text-color); margin: 0 0 4px; }
.member-position { font-size: 0.85em; color: #777; margin: 0; }
.member-stats-horizontal { display: grid; gap: 8px; }
.stat-item-horizontal { display: flex; align-items: center; font-size: 0.85em; }
.stat-item-horizontal .label { flex-basis: 60px; flex-shrink: 0; color: #555; margin-right: 8px; text-align: right; white-space: nowrap; }
.stat-item-horizontal .label i { margin-right: 4px; color: var(--primary-color); width: 1em; text-align: center; }
.stat-item-horizontal .progress { flex-grow: 1; height: 8px; background-color: #eee; border-radius: 4px; overflow: hidden; margin: 0 8px; }
.stat-item-horizontal .progress-bar { background: linear-gradient(to right, var(--secondary-color), var(--primary-color)); height: 100%; border-radius: 4px; transition: width 0.4s ease; }
.stat-item-horizontal .value { flex-basis: 30px; flex-shrink: 0; font-weight: 600; color: var(--primary-color); text-align: right; }
.member-action { display: none; }
.member-card.horizontal:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.2); }
.team-achievements { background-color: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
.achievements-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.2rem; margin-top: 1.5rem; }
.achievement-card { background: linear-gradient(135deg, #fff6f9 0%, #fff 100%); border: 1px solid rgba(255, 105, 180, 0.1); box-shadow: 0 4px 15px rgba(255, 105, 180, 0.05); border-radius: 12px; padding: 1.5rem; text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
.achievement-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(255, 105, 180, 0.1); }
.achievement-card.locked { opacity: 0.7; background-color: #f5f5f5; cursor: not-allowed; transform: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
.achievement-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
.achievement-icon i { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
.achievement-card h4 { margin: 0 0 0.5rem; color: var(--accent-color); font-size: 1rem; }
.achievement-card p { color: #666; margin: 0; font-size: 0.85rem; }
.achievement-card p.description { margin-top: 0.5rem; font-size: 0.9rem; color: #555; }
.team-schedule { background-color: white; border-radius: 15px; padding: 2rem 1.5rem; margin-bottom: 2rem; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06); }
.schedule-timeline { margin-top: 1.5rem; position: relative; padding-left: 85px; }
.schedule-timeline::before { content: ''; position: absolute; left: 45px; top: 10px; bottom: 30px; width: 3px; background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color)); border-radius: 3px; z-index: 1; }
.timeline-item { position: relative; margin-bottom: 2.5rem; padding-left: 40px; display: flex; align-items: flex-start; }
.timeline-item:last-child { margin-bottom: 0; }
.timeline-item:last-child::after { content: ''; position: absolute; left: calc(45px - (3px / 2)); bottom: -2.5rem; width: 3px; height: 2.5rem; background: white; z-index: 1; }
.timeline-item::before { content: ''; position: absolute; left: calc(45px - 8px); top: 8px; width: 16px; height: 16px; background-color: var(--primary-color); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.4); z-index: 2; }
.timeline-item.past-event::before { background-color: #ccc; border-color: #f0f0f0; box-shadow: none; }
.timeline-date { position: absolute; left: 0; top: 5px; width: 70px; text-align: center; flex-shrink: 0; color: var(--primary-color); }
.timeline-month { display: block; font-size: 0.8em; font-weight: 500; color: var(--accent-color); margin-bottom: 3px; text-transform: uppercase; position: relative; padding-right: 8px; }
.timeline-month::after { content: 'â—'; position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 0.5em; color: var(--secondary-color); line-height: 1; }
.timeline-day { display: block; font-size: 1.8em; font-weight: 700; line-height: 1.1; letter-spacing: -1px; }
.timeline-item.past-event .timeline-date { color: #aaa; } .timeline-item.past-event .timeline-month { color: #bbb; } .timeline-item.past-event .timeline-month::after { color: #ddd; }
.timeline-content { background-color: #fff; border-radius: 10px; padding: 18px 20px; flex-grow: 1; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07); transition: transform 0.2s ease, box-shadow 0.2s ease; margin-left: 15px; border: 1px solid #eee; }
.timeline-content:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
.timeline-title { margin: 0 0 10px; font-size: 1.1em; color: var(--text-color); font-weight: 600; }
.timeline-location { font-size: 0.9em; color: #555; margin-bottom: 10px; display: flex; align-items: center; }
.timeline-location i { color: var(--accent-color); margin-right: 8px; font-size: 1.05em; }
.timeline-description { font-size: 0.9em; color: #666; margin: 0; line-height: 1.65; }
.timeline-item.past-event .timeline-content { background-color: #f9f9f9; box-shadow: 0 1px 5px rgba(0,0,0,0.04); border-color: #f0f0f0; opacity: 0.85; }
.timeline-item.past-event .timeline-content:hover { transform: none; box-shadow: 0 1px 5px rgba(0,0,0,0.04); }
.timeline-item.past-event .timeline-title { color: #777; } .timeline-item.past-event .timeline-location { color: #888; } .timeline-item.past-event .timeline-description { color: #999; }

/* --- Plan Page --- */
.plan-container { max-width: 1200px; margin: 0 auto; }
.plan-header { background: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 15px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 1rem; }
.header-content h2 { margin: 0 0 0.5rem; color: var(--accent-color); display: flex; align-items: center; }
.header-content h2 i { margin-right: 0.5rem; }
.header-content p { margin: 0; color: #777; font-size: 0.9em; }
.plan-filters { background: white; padding: 1rem; border-radius: 15px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 15px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 1rem; }
.filter-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.filter-btn { background: none; border: 1px solid #ddd; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; color: #555; font-size: 0.9em; }
.filter-btn:hover { background: #f5f5f5; border-color: #ccc; }
.filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
.filter-search { max-width: 250px; }
.task-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
.task-column { background: #f8f9fa; border-radius: 15px; padding: 1rem; box-shadow: 0 0 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; /* Ensure flex direction */ }
.column-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #eee; margin-bottom: 1rem; flex-shrink: 0; }
.column-header h3 { margin: 0; font-size: 1.1rem; color: var(--text-color); }
.task-count { background: #e9ecef; color: #495057; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem; font-weight: 500; }
.task-list { display: flex; flex-direction: column; gap: 1rem; min-height: 200px; flex-grow: 1; overflow-y: auto; padding: 5px; padding-right: 5px; /* Scrollbar padding */ }
.task-card { background: white; border-radius: 10px; padding: 1rem; border-left: 4px solid transparent; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
.task-card:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.08); }
.task-card.short-term { border-left-color: #4CAF50; } .task-card.long-term { border-left-color: #2196F3; } .task-card.personal-bond { border-left-color: #FF4081; } .task-card.completed { border-left-color: #bbb; opacity: 0.7; } .task-card.hidden-task { display: none; }
.task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
.task-tag { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 5px; font-weight: 500; }
.task-tag.short-term { background: rgba(76, 175, 80, 0.1); color: #4CAF50; } .task-tag.long-term { background: rgba(33, 150, 243, 0.1); color: #2196F3; } .task-tag.personal-bond { background: rgba(255, 64, 129, 0.1); color: #FF4081; }
.task-tag.training { background: rgba(255, 152, 0, 0.1); color: #FF9800; } .task-tag.fan-service { background: rgba(156, 39, 176, 0.1); color: #9C27B0; } .task-tag.performance { background: rgba(244, 67, 54, 0.1); color: #F44336; }
.task-priority { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 5px; font-weight: 500; }
.task-priority.high { background: rgba(244, 67, 54, 0.1); color: #F44336; } .task-priority.medium { background: rgba(255, 152, 0, 0.1); color: #FF9800; } .task-priority.low { background: rgba(158, 158, 158, 0.1); color: #757575; }
.task-title { font-weight: 600; margin-bottom: 0.5rem; color: #333; }
.task-description { font-size: 0.9rem; color: #666; margin-bottom: 1rem; line-height: 1.5; }
.task-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #777; flex-wrap: wrap; gap: 0.5rem; margin-top: auto; padding-top: 0.5rem; border-top: 1px dashed #eee; }
.task-deadline { display: flex; align-items: center; gap: 0.3rem; } .task-deadline i { color: #6c757d; }
.task-members { display: flex; margin-left: auto; }
.member-avatar { width: 28px; height: 28px; border-radius: 50%; overflow: hidden; margin-left: -8px; border: 2px solid white; background: #eee; box-shadow: 0 0 3px rgba(0,0,0,0.1); }
.member-avatar:first-child { margin-left: 0; } .member-avatar img { width: 100%; height: 100%; object-fit: cover; }


/* --- Song Page --- */
.song-container { max-width: 1200px; margin: 0 auto; }
.song-header { background: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 15px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 1rem; }
.header-content h2 { margin: 0 0 0.5rem; color: var(--accent-color); display: flex; align-items: center; }
.header-content h2 i { margin-right: 0.5rem; }
.header-content p { margin: 0; color: #777; font-size: 0.9em; }
.creation-content { background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
.creation-section { background: #f9f9f9; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; }
.member-selection { display: flex; gap: 0.8rem; flex-wrap: wrap; }
.member-select-item { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 0.8rem; display: flex; flex-direction: column; align-items: center; min-width: 90px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
.member-select-item:hover { border-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.05); }
.member-select-item.selected { border-color: var(--primary-color); background: rgba(var(--primary-color-rgb), 0.05); box-shadow: 0 0 0 2px var(--secondary-color); }
.member-select-item img { width: 45px; height: 45px; border-radius: 50%; margin-bottom: 0.5rem; object-fit: cover; background: #eee; }
.member-name { font-size: 0.85rem; font-weight: bold; margin-bottom: 0.2rem; }
.member-skill { font-size: 0.75rem; color: #777; }
.creation-summary { margin-top: 2rem; border-top: 1px solid #eee; padding-top: 2rem; }
.budget-summary, .song-preview {
    /* height: 100%; */ /* Removed */
    display: flex;
    flex-direction: column;
    min-height: 200px; /* Example min height */
}
.budget-items, .preview-items { background: #f9f9f9; border-radius: 10px; padding: 1.2rem; flex-grow: 1; }
.budget-item, .preview-item { display: flex; justify-content: space-between; margin-bottom: 0.6rem; padding-bottom: 0.6rem; border-bottom: 1px dashed #ddd; font-size: 0.9rem; }
.budget-item:last-child, .preview-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.budget-item.total { font-weight: bold; color: var(--accent-color); border-top: 2px solid var(--secondary-color); margin-top: 0.8rem; padding-top: 0.8rem; font-size: 1rem; }
.item-name, .item-label { color: #555; flex-basis: 40%; }
.item-value { font-weight: 500; text-align: right; flex-basis: 55%; }

/* --- Summary Page --- */
.summary-container { padding: 2rem; }
#storySummaryList { /* Renamed from .summary-stack */
    padding: 2rem 0;
    transition: 0.25s ease;
    border: none;
    background-color: transparent;
    max-height: 680px; /* Set max height */
    overflow-y: auto;  /* Enable vertical scroll */
    padding-right: 10px; /* Space for scrollbar */
}
.summary-entry.card {
    background-color: #fff; border: 1px solid #eee; border-radius: 8px; padding: 0;
    position: relative; margin-bottom: 1.5rem; transition: 0.15s ease; cursor: default;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 95%; max-width: 550px;
    margin-left: auto; margin-right: auto; border-bottom: none;
}
/* Disable stacking pseudo-elements for scroll container */
.summary-entry.card:before, .summary-entry.card:after { display: none; }
.card-content-wrapper { padding: 1.2rem 1.5rem; }
.entry-meta { margin-bottom: 0.6rem; font-size: 0.85em; color: var(--accent-color, #FF1493); opacity: 0.8; }
.entry-id { font-weight: 600; }
.entry-content p { margin: 0; line-height: 1.7; color: #444; text-indent: 0; }
.empty-summary-message { text-align: center; color: #aaa; padding: 3rem 1rem; font-style: italic; font-size: 1.1em; }

/* --- Training Page --- */
.training-container { padding: 2rem; background: #fff; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
.training-header { text-align: center; margin-bottom: 2rem; position: relative; }
.training-header h2 { color: var(--primary-color); font-weight: bold; margin-bottom: 1rem; }
.training-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
.stat-card { background: linear-gradient(145deg, #ffffff, #f0f0f0); padding: 1rem; border-radius: 10px; text-align: center; box-shadow: 5px 5px 15px #d9d9d9, -5px -5px 15px #ffffff; transition: transform 0.3s ease; }
.stat-card:hover { transform: translateY(-5px); }
.stat-icon { font-size: 2rem; margin-bottom: 0.5rem; color: var(--accent-color); }
.stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
.stat-label { font-size: 0.9rem; color: #666; }
.training-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
.training-card { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden; border: 1px solid #eee; }
.training-card:hover { transform: translateY(-5px); box-shadow: 0 8px 12px rgba(var(--primary-color-rgb), 0.1); }
.training-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(to right, var(--secondary-color), var(--primary-color)); }
.training-card.locked { opacity: 0.7; filter: grayscale(0.5); }
.training-card.locked::after { content: 'ğŸ”’'; position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; opacity: 0.7; }
.training-card.training-in-progress { border-color: var(--accent-color); box-shadow: 0 0 15px rgba(var(--primary-color-rgb), 0.2); animation: pulse 1.5s infinite ease-in-out; }
.training-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.8rem; }
.training-desc { color: #555; margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.5; }
.training-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; margin: 1rem 0; }
.training-stat { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #555; }
.training-stat i { color: var(--accent-color); width: 1em; text-align: center; }
.training-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed #eee; }
.btn-train { background: var(--primary-color); color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
.btn-train:hover:not(:disabled) { background: var(--accent-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(var(--primary-color-rgb), 0.2); }
.btn-train:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
.training-cost { color: #666; font-size: 0.9rem; font-weight: 500; }
.training-cost i { color: gold; margin-right: 0.3rem; }
@keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 15px rgba(var(--primary-color-rgb), 0.2); } 50% { transform: scale(1.02); box-shadow: 0 0 25px rgba(var(--primary-color-rgb), 0.3); } 100% { transform: scale(1); box-shadow: 0 0 15px rgba(var(--primary-color-rgb), 0.2); } }

/* --- Modals --- */
.chapter-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); padding: 15px; box-sizing: border-box; }
.chapter-modal-content { background-color: white; border-radius: 10px; width: 95%; max-width: 650px; max-height: 90%; height: auto; overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; }
.chapter-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; background-color: #f8f9fa; /* position: sticky; top: 0; */ /* Avoid sticky header in modal */ z-index: 1; min-height: 50px; max-height: 50px; border-top-left-radius: 10px; border-top-right-radius: 10px; flex-shrink: 0; /* Prevent shrinking */ }
.chapter-modal-header h3 { margin: 0; color: var(--accent-color); font-size: 1.1rem; }
.close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #6c757d; padding: 0 5px; line-height: 1; }
.close-btn:hover { color: var(--accent-color); }
.chapter-modal-body { padding: 15px; overflow-y: auto; flex: 1; padding-right: 5px; /* Scrollbar padding */}
.chapter-modal-body .history-item { display: flex; padding: 0.6rem 0; border-bottom: 1px solid #f0f0f0; width: 100%; font-size: 0.9rem; }
.chapter-modal-body .history-item:last-child { border-bottom: none; }
.chapter-modal-body .history-text { flex-grow: 1; color: #444; line-height: 1.6; }
.chapter-modal-body .history-text.narrator { font-style: italic; color: #666; }
.chapter-modal-body .history-text strong { color: var(--primary-color); margin-right: 5px; }
.chapter-title { text-align: center; margin-bottom: 15px; color: var(--accent-color); border-bottom: 1px solid var(--secondary-color); padding-bottom: 10px; font-size: 1.1rem; }
.chapter-list-container { width: 100%; max-height: 250px; overflow-y: auto; padding: 10px 0; border-top: 1px solid #eee; margin-top: 15px; padding-right: 5px; /* Scrollbar padding */}
.chapter-list { list-style: none; padding: 0; margin: 10px 0 0 0; }
.chapter-item { padding: 10px 15px; margin-bottom: 5px; background-color: white; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; border: 1px solid #eee; color: var(--text-color); font-size: 0.95rem; }
.chapter-item:hover { background-color: var(--secondary-color); color: white; transform: translateX(3px); border-color: var(--secondary-color); }
.chapter-item.save-item .text-muted { margin-left: 10px; font-size: 0.8em; }
body.modal-open { overflow: hidden; /* Keep this to prevent body scroll when modal is open */ }

/* --- Loading Indicator --- */
.loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 1.5em; text-align: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #FFF; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- Scrollbar Styling --- */
/* Webkit */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: rgba(var(--primary-color-rgb), 0.1); border-radius: 10px; }
::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.5); }
::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }
/* Firefox */
.content-area, #storySummaryList, .contact-list, .chat-messages, .member-profile, .task-list, .options-list, .text-box, .chapter-modal-body, .chapter-list-container, .nav-tabs /* If scrollable on large screens */
{
    scrollbar-width: thin;
    scrollbar-color: var(--secondary-color) rgba(var(--primary-color-rgb), 0.1);
}

/* --- Responsive Design --- */
@media (min-width: 992px) { /* Larger screens: single-line nav */
    .nav-tabs {
         flex-wrap: nowrap;
         overflow-x: auto; /* Allow horizontal scroll for nav */
         padding-right: 10px; /* Space for potential scrollbar */
    }
}

@media (max-width: 991.98px) { /* Medium devices (tablets) */
   .nav-tabs .nav-link { padding: 0.8rem 1.2rem; font-size: 0.95em; }
   .content-area { padding: 1rem; }

   /* --- ä¿®æ”¹ï¼šä¿æŒä¸‰æ å¸ƒå±€åœ¨ä¸­ç­‰å±å¹• --- */
   .contact-container {
       /* æ¢å¤æˆ–ä¿æŒä¸‰æ å¸ƒå±€ï¼Œå¯ä»¥å¾®è°ƒå®½åº¦ */
       grid-template-columns: 240px 1fr 280px; /* ç¤ºä¾‹ï¼šè°ƒæ•´äº†å®½åº¦ */
       max-width: 1200px; /* ä¿æŒæœ€å¤§å®½åº¦é™åˆ¶ï¼Œæˆ–æ ¹æ®éœ€è¦è°ƒæ•´ */
       /* ç§»é™¤ max-width: 100%; */
   }
   .member-profile {
       display: block; /* ç¡®ä¿æˆå‘˜èµ„æ–™æ æ˜¾ç¤º */
   }
   /* --- ç»“æŸä¿®æ”¹ --- */

   /* ä¿ç•™å…¶ä»–ä¸­ç­‰å±å¹•çš„è°ƒæ•´ */
   .contact-sidebar { border-radius: 15px 0 0 15px; } /* å¯èƒ½éœ€è¦æ ¹æ®ä¸‰æ å¸ƒå±€è°ƒæ•´ */
   .chat-area { border-radius: 0; } /* å¯èƒ½éœ€è¦ç§»é™¤åœ†è§’ */
   .member-profile { border-radius: 0 15px 15px 0; } /* ç»™èµ„æ–™æ æ·»åŠ åœ†è§’ */


   .members-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
   .achievements-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
   .task-board { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
   .training-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
   .info-bar .date-location { font-size: 0.85em; gap: 0.7rem; }
   .info-bar > button { font-size: 0.8em; }
   /* Ensure summary list still scrolls */
   #storySummaryList { max-height: 600px; }
}

@media (max-width: 767.98px) { /* Small devices (landscape phones) */
    /* Nav wraps automatically */
   .nav-tabs .nav-link { padding: 0.7rem 1rem; font-size: 0.9em; }
   .contact-container {
       grid-template-columns: 1fr; /* Single column layout */
       /* ã€ä¿®æ”¹ã€‘ç§»é™¤å›ºå®šé«˜åº¦å’Œå†…éƒ¨ overflow */
       /* height: 100%; */
       /* max-height: none; */
       /* overflow-y: hidden; */
       /* Use flex for vertical layout */
       display: flex;
       flex-direction: column;
   }
   .contact-sidebar {
       /* ã€ä¿®æ”¹ã€‘Use max-height for list, not fixed % */
       /* height: auto; */
       max-height: 40%; /* Example max height */
       border-radius: 15px 15px 0 0;
       flex-shrink: 0; /* Prevent shrinking */
       /* Ensure internal list still scrolls */
       display: flex; flex-direction: column;
   }
   .contact-sidebar .contact-list { flex-grow: 1; overflow-y: auto; }
   .chat-area {
       /* ã€ä¿®æ”¹ã€‘Let chat area grow */
       height: auto;
       flex-grow: 1;
       border-radius: 0 0 15px 15px;
       display: flex; flex-direction: column; /* Ensure internal flex */
       min-height: 300px; /* Ensure it has some visible height */
   }
   .chat-area .chat-messages { flex-grow: 1; overflow-y: auto; min-height: 150px; } /* Ensure messages scroll */
   .member-profile { display: none; }
   .info-bar { flex-wrap: wrap; padding: 0.6rem 1rem; }
   .info-bar .date-location { flex-basis: 100%; order: 2; margin-top: 0.5rem; justify-content: center; font-size: 0.8em; }
   .info-bar > button { order: 1; margin-left: 0; }
   .vn-container { min-height: 300px; height: 55%; /* Adjust height */ }
   .interaction-options { max-height: 45%; /* Adjust options height */ }
   .text-box-container {
           position: absolute; bottom: 0; left: 0; width: 100%;
           padding: 10px 15px; /* å¯ä»¥ç¨å¾®å‡å°‘å‚ç›´ padding */
           z-index: 1000;
           max-height: 40%; /* ä¿æŒæˆ–å¾®è°ƒæœ€å¤§é«˜åº¦ */
           box-sizing: border-box;
           /* æ–°å¢ Flexbox å¸ƒå±€ */
           display: flex;
           flex-direction: column;
       }
   .text-box { max-height: 120px; padding: 10px; font-size: 0.95em; }
   .character-sprite { height: 60%; } .character-sprite.left { left: 10px; } .character-sprite.right { right: 10px; }
   .creation-content .row > * { margin-bottom: 1rem; }
   /* .budget-summary, .song-preview { height: auto; } */ /* Removed */
   .members-grid { grid-template-columns: 1fr; }
   .member-card.horizontal .member-card-content { flex-direction: column; }
   .member-card.horizontal .member-avatar-container { width: 100%; height: 150px; padding: 10px; }
   .member-card.horizontal .member-avatar-large { width: 80px; height: 80px; }
   .member-card.horizontal .member-role-badge { bottom: 5px; font-size: 0.7em; }
   .member-card.horizontal .member-details-container { padding: 15px; }
   .task-board { grid-template-columns: 1fr; }
   .training-grid { grid-template-columns: 1fr; }
   .achievements-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
   .chapter-modal-content { width: 95%; max-height: 95%; }
   .chapter-modal-body { padding: 15px; }
   /* Ensure summary list still scrolls */
   #storySummaryList { max-height: 550px; }
}

@media (max-width: 575.98px) { /* Extra small devices (portrait phones) */
    .content-area { padding: 0.8rem; }
    .nav-tabs .nav-link { padding: 0.6rem 0.8rem; font-size: 0.85em; }
    .info-bar .date-location span { margin-left: 0.5rem !important; }
    .info-bar > button { padding: 0.2rem 0.4rem; font-size: 0.75em;}
    /* contact-container already 1 column */
    .contact-sidebar { max-height: 35%; } /* Further reduce list height */
    .chat-area { flex-grow: 1; }

    /* --- å…³é”®ä¿®æ”¹ï¼šè°ƒæ•´ VN åŒºåŸŸå’Œå°å±å¹•çš„é«˜åº¦åˆ†é… --- */
    .game-container {
        gap: 0.5rem; /* å‡å°å…ƒç´ é—´è· */
        min-height: 500px; /* é™ä½æœ€å°é«˜åº¦è¦æ±‚ */
        padding-bottom: 0.5rem;
    }
    .vn-container {
        /* æ˜¾è‘—å¢åŠ  scene çš„ç›¸å¯¹é«˜åº¦ï¼Œå‡å°‘ vn-container çš„æ•´ä½“å æ¯” */
        /* height: auto; ä¸å†å›ºå®šé«˜åº¦ç™¾åˆ†æ¯”ï¼Œè®©å†…å®¹å†³å®šä¸€éƒ¨åˆ† */
        flex-grow: 1; /* è®© VN åŒºåŸŸå°è¯•å¡«å……ç©ºé—´ */
        min-height: 280px; /* è®¾ç½®ä¸€ä¸ªæ›´å°çš„æœ€å°é«˜åº¦ï¼Œä½†è¦è¶³å¤Ÿæ˜¾ç¤ºå†…å®¹ */
        max-height: 60vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„60% */
    }
    .text-box-container {
        position: relative; /* æ”¹ä¸ºç›¸å¯¹å®šä½ï¼Œæˆä¸º vn-container çš„ flex item */
        bottom: auto; /* ç§»é™¤ bottom å®šä½ */
        left: auto; /* ç§»é™¤ left å®šä½ */
        max-height: none; /* ç§»é™¤ max-height ç™¾åˆ†æ¯” */
        height: auto; /* é«˜åº¦ç”±å†…éƒ¨å…ƒç´ å†³å®š */
        padding: 8px 10px; /* å‡å°å†…è¾¹è· */
        background-color: rgba(0, 0, 0, 0.7); /* ç»™å®¹å™¨åŠ ä¸ªèƒŒæ™¯ï¼Œé¿å…é€æ˜ */
        border-top: 1px solid rgba(255,255,255,0.2); /* å¯é€‰ï¼šåŠ ä¸ªåˆ†å‰²çº¿ */
        flex-shrink: 0; /* é˜²æ­¢è¢«è¿‡åº¦å‹ç¼© */
        z-index: 1; /* ç¡®ä¿åœ¨ scene ä¹‹ä¸Šï¼Œå¦‚æœ scene æ²¡å†…å®¹æ—¶ */
    }
    .name-box {
        margin-bottom: 3px; /* å‡å°é—´è· */
        padding: 3px 10px;
    }
    .text-box {
        font-size: 0.85em; /* å‡å°å­—ä½“ */
        max-height: 70px; /* é™åˆ¶æ–‡æœ¬æ¡†æœ€å¤§é«˜åº¦ (çº¦3-4è¡Œ) */
        padding: 8px 10px; /* å‡å°å†…è¾¹è· */
        margin-bottom: 5px;
    }
    .text-controls {
        margin-top: 3px; /* å‡å°é—´è· */
        gap: 5px; /* å‡å°æŒ‰é’®é—´è· */
    }
    .text-btn {
        padding: 3px 8px; /* å‡å°æŒ‰é’®å¤§å° */
        font-size: 0.8em;
    }
     /* è°ƒæ•´ç«‹ç»˜ä»¥é€‚åº”æ–°çš„å¸ƒå±€ */
     .character-sprite {
          height: 75%; /* ç›¸å¯¹äº scene-container çš„é«˜åº¦ */
          max-width: 45%; /* å¯ä»¥é€‚å½“å¢å¤§å®½åº¦å æ¯” */
          bottom: 5px; /* ç¨å¾®æŠ¬é«˜ä¸€ç‚¹ï¼Œé¿å…è¢« text-box-container é®æŒ¡è¿‡å¤š */
     }
     .character-sprite.left { left: 0; } /* è°ƒæ•´ä½ç½® */
     .character-sprite.right { right: 0; } /* è°ƒæ•´ä½ç½® */

    .interaction-options {
        /* é€‰é¡¹åŒºåŸŸç°åœ¨å¯ä»¥ç¨å¾®é«˜ä¸€ç‚¹ï¼Œå› ä¸ºå®ƒåœ¨ VN ä¸‹æ–¹ */
        max-height: 35vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„ 35% */
        flex-shrink: 0; /* é˜²æ­¢è¢«è¿‡åº¦å‹ç¼© */
        margin-top: 0.5rem;
        margin-bottom: 0; /* ç§»é™¤åº•éƒ¨å¤–è¾¹è· */
    }
    .options-header { padding: 0.6rem 0.8rem; } .options-header h4 { font-size: 1rem; }
    .options-list { padding: 0.6rem 0.8rem; } .btn-option { font-size: 0.85em; padding: 0.6rem 0.8rem; margin-bottom: 0.5rem; }
    .custom-option-input { margin-top: 0.5rem; padding: 0 0.8rem 0.5rem; }
    #customOptionInput { font-size: 0.85em; }


    /* å…¶ä»–å°å±å¹•è°ƒæ•´ */
    .member-card.horizontal .member-avatar-container { height: 120px; }
    .member-card.horizontal .member-avatar-large { width: 70px; height: 70px; }
    /* Ensure summary list still scrolls */
    #storySummaryList { max-height: 500px; }
}
   </style>
</head>
<body>
    <div class="container-fluid">
        <!-- å¯¼èˆªæ  -->
        <ul class="nav nav-tabs" id="mainNav">
            <li class="nav-item">
                <a class="nav-link active" data-page="story"><i class="fas fa-book-open"></i> æ­£æ–‡</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="contact"><i class="fas fa-comments"></i> è”ç³»äºº</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="team"><i class="fas fa-users"></i> å›¢é˜Ÿä¿¡æ¯</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="training"><i class="fas fa-dumbbell"></i> ç‰¹è®­è®¡åˆ’</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="plan"><i class="fas fa-tasks"></i> æœªæ¥è®¡åˆ’</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="song"><i class="fas fa-music"></i> æ‰“é€ æ–°æ­Œ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="summary"><i class="fas fa-list-alt"></i> æ•…äº‹æ€»ç»“</a>
            </li>
        </ul>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <!-- æ­£æ–‡é¡µé¢ -->
            <div id="storyPage" class="page active">
                <div class="game-container">
                    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
                    <div class="info-bar">
                        <div class="date-location">
                            <span id="story-date"><i class="far fa-calendar-alt"></i></span>
                            <span class="ms-3" id="story-location"><i class="fas fa-map-marker-alt"></i></span>
                            <span class="ms-3" id="story-chapter"><i class="fas fa-book"></i></span>
                            <span class="ms-3" id="story-funds"><i class="fas fa-yen-sign"></i></span>
                        </div>
                        <!-- ã€æ–°å¢ã€‘æ•…äº‹è¿›å±•æŒ‰é’® -->
                        <button id="btn-show-history" class="btn btn-sm btn-outline-light ms-3" title="æ•…äº‹è¿›å±•">
                            <i class="fas fa-history"></i> è¿›å±•
                        </button>
                    </div>

                    <!-- è§†è§‰å°è¯´é£æ ¼çš„æ•…äº‹å†…å®¹åŒºåŸŸ -->
                    <div class="vn-container">
                        <!-- åœºæ™¯å’Œç«‹ç»˜å®¹å™¨ -->
                        <div id="scene-container" class="scene-container">
                            <!-- ç‰¹æ•ˆé®ç½©å±‚ -->
                            <div id="effect-overlay" class="effect-overlay"></div>
                        </div>

                        <!-- æ–‡æœ¬æ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="text-box-container">
                            <div id="name-box" class="name-box"></div>
                            <div id="text-box" class="text-box">
                                <div id="story-content" class="story-content"></div> <!-- æ³¨æ„ï¼šæ­¤ div çš„å†…å®¹ç”± JS æ§åˆ¶ï¼Œæœ¬èº«ä¸æ˜¯å†å²è®°å½•å®¹å™¨ -->
                            </div>
                            <!-- æ§åˆ¶æŒ‰é’® -->
                            <div class="text-controls">
                                <button id="btn-auto" class="text-btn">è‡ªåŠ¨</button>
                                <button id="btn-reset" class="text-btn">é‡çœ‹ä¸€é</button>
                                <button id="btn-load-save" class="text-btn" style="color: #dc3545; border-color: #dc3545;">è¯»æ¡£</button>
                                <button id="btn-delete-records" class="text-btn" style="color: #ffffff; background-color: #dc3545; border-color: #dc3545;" title="åˆ é™¤æ‰€æœ‰æ¸¸æˆæ•°æ®">
                                    <i class="fas fa-trash-alt"></i> åˆ é™¤è®°å½•
                                </button>
                            </div>
                        </div>
                    </div>

                     <!-- é€‰é¡¹åŒºåŸŸ -->
                    <div class="interaction-options">
                        <div class="options-header">
                            <h4>ä½ çš„å†³å®šæ˜¯ï¼Ÿ</h4>
                        </div>
                        <div class="options-list" id="story-options">
                            <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <!-- è‡ªå®šä¹‰è¾“å…¥é€‰é¡¹ä¹Ÿç§»åˆ° interaction-options å†…éƒ¨ -->
                        <div class="custom-option-input mt-3" id="customOptionContainer" style="display: none;">
                            <label for="customOptionInput" class="form-label small text-muted">æˆ–è€…ï¼Œä½ æœ‰å…¶ä»–çš„æƒ³æ³•ï¼š</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="customOptionInput" placeholder="ä¾‹å¦‚ï¼šä»Šæ™šè¯·å®¢åƒç«é”…...">
                                <button class="btn btn-outline-primary" type="button" id="submitCustomOptionBtn">ç¡®å®š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è”ç³»äººé¡µé¢ -->
            <div id="contactPage" class="page">
                <div class="contact-container">
                    <div class="contact-sidebar">
                        <div class="contact-search">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="æœç´¢æˆå‘˜..." id="contactSearchInput">
                                <button class="btn btn-outline-secondary" type="button" id="contactSearchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="contact-list" id="contactList">
                            <!-- è”ç³»äººåˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="chat-area">
                        <div class="chat-header">
                             <!-- è°ƒæ•´ï¼šç®€åŒ–èŠå¤©å¤´éƒ¨ç»“æ„ -->
                             <div class="chat-title">
                                <img src="placeholder.png" alt="Avatar" id="chat-header-avatar" style="display: none;" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;">
                                 <h3 id="chat-title-name">é€‰æ‹©è”ç³»äºº</h3> <!-- æ·»åŠ ID -->
                             </div>
                            <div class="chat-actions"> <!-- å°†æŒ‰é’®æ”¾å…¥å®¹å™¨ -->
                                <button class="btn btn-light btn-sm" id="characterInfoBtn" title="è§’è‰²ä¿¡æ¯">
                                    <i class="fas fa-user"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" id="clearChatBtn" title="æ¸…é™¤èŠå¤©è®°å½•"> <i class="fas fa-trash"></i> </button> <!-- ç§»åˆ°è¿™é‡Œ -->
                            </div>
                        </div>

                        <div class="chat-messages" id="chatMessages">
                            <!-- èŠå¤©æ¶ˆæ¯å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                             <div class="message-system"><span>é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©ã€‚</span></div>
                        </div>

                        <div class="chat-input">
                            <div class="input-group">
                                <!-- ã€åˆ é™¤ã€‘è¡¨æƒ…æŒ‰é’® -->
                                <input type="text" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..." id="messageInput" aria-label="Message Input">
                                <button class="btn btn-primary" id="sendMessageBtn" title="å‘é€"><i class="fas fa-paper-plane"></i></button>
                                <!-- ã€åˆ é™¤ã€‘æ¸…é™¤æŒ‰é’®ï¼ˆå·²ç§»åˆ°å¤´éƒ¨ï¼‰ -->
                            </div>
                        </div>
                    </div>

                    <div class="member-profile" id="memberProfile">
                        <!-- è”ç³»äººèµ„æ–™å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                         <div class="empty-profile">
                             <i class="fas fa-user fa-3x"></i>
                             <p>é€‰æ‹©ä¸€ä¸ªè”ç³»äººæŸ¥çœ‹è¯¦ç»†èµ„æ–™</p>
                         </div>
                    </div>
                </div>
            </div>

            <!-- å›¢é˜Ÿä¿¡æ¯é¡µé¢ -->
            <div id="teamPage" class="page">
                <div class="team-container">
                    <div class="team-header">
                        <div class="team-info">
                            <h2 id="team-name">æ˜Ÿå…‰å°‘å¥³å›¢</h2>
                            <div class="team-stats" id="team-stats">
                                <!-- å›¢é˜Ÿç»Ÿè®¡å°†ç”±JSå¡«å…… -->
                            </div>
                        </div>
                        <!-- å¯ä»¥æ·»åŠ å›¢é˜Ÿæ“ä½œæŒ‰é’® -->
                         <div class="team-actions">
                             <button class="btn btn-outline-primary btn-sm" id="dataAnalysisBtn"><i class="fas fa-chart-line"></i> æ•°æ®åˆ†æ</button>
                             <button class="btn btn-outline-secondary btn-sm" id="teamSettingsBtn"><i class="fas fa-cog"></i> å›¢é˜Ÿè®¾ç½®</button>
                         </div>
                    </div>

                    <!-- å›¢é˜Ÿæˆå‘˜å¡ç‰‡ -->
                    <div class="section-title mt-4">
                        <i class="fas fa-users"></i> å›¢é˜Ÿæˆå‘˜
                    </div>
                    <div class="members-grid" id="teamMembers">
                        <!-- æˆå‘˜å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- å›¢é˜Ÿæˆå°± -->
                    <div class="team-achievements">
                        <div class="section-title">
                           <i class="fas fa-trophy"></i> å›¢é˜Ÿæˆå°±
                        </div>
                        <div class="achievements-grid" id="team-achievements">
                             <!-- æˆå°±å°†ç”±JSå¡«å…… -->
                             <div class="empty-message text-center text-muted p-3">æš‚æ— å›¢é˜Ÿæˆå°±è®°å½•</div>
                        </div>
                    </div>

                    <!-- è¿‘æœŸè¡Œç¨‹ -->
                    <div class="team-schedule">
                        <div class="section-title">
                            <i class="fas fa-calendar"></i> è¿‘æœŸè¡Œç¨‹
                        </div>
                        <div class="schedule-timeline" id="team-schedule">
                            <!-- æ—¥ç¨‹å°†ç”±JSå¡«å…… -->
                             <div class="empty-message text-center text-muted p-3">æš‚æ— è¿‘æœŸè¡Œç¨‹å®‰æ’</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœªæ¥è®¡åˆ’é¡µé¢ -->
            <div id="planPage" class="page">
                <div class="plan-container">
                    <!-- é¡µé¢æ ‡é¢˜å’Œæ€»è§ˆ -->
                    <div class="plan-header">
                        <div class="header-content">
                            <h2><i class="fas fa-tasks"></i> æœªæ¥è®¡åˆ’</h2>
                            <p>ç®¡ç†å›¢é˜Ÿçš„çŸ­æœŸå’Œé•¿æœŸç›®æ ‡ï¼Œç¡®ä¿å›¢é˜Ÿå‘å±•æœç€æ­£ç¡®çš„æ–¹å‘å‰è¿›ã€‚</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" id="newTaskBtn"><i class="fas fa-plus"></i> æ–°å»ºä»»åŠ¡</button>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡çœ‹æ¿å’Œè¿‡æ»¤å™¨ -->
                    <div class="plan-filters">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">å…¨éƒ¨ä»»åŠ¡</button>
                            <button class="filter-btn" data-filter="short-term">çŸ­æœŸä»»åŠ¡</button>
                            <button class="filter-btn" data-filter="long-term">é•¿æœŸä»»åŠ¡</button>
                            <button class="filter-btn" data-filter="personal-bond">ä¸ªäººç¾ç»Š</button>
                        </div>
                        <div class="filter-search">
                            <input type="text" class="form-control" id="taskSearchInput" placeholder="æœç´¢ä»»åŠ¡...">
                        </div>
                    </div>

                    <!-- ä»»åŠ¡çœ‹æ¿ -->
                    <div class="task-board" id="taskBoard">
                        <!-- å¾…å¤„ç†ä»»åŠ¡ -->
                        <div class="task-column">
                            <div class="column-header">
                                <h3>å¾…å¤„ç†</h3>
                                <span class="task-count" data-status="todo">0</span>
                            </div>
                            <div class="task-list" data-status="todo">
                                <!-- ä»»åŠ¡å¡ç‰‡å°†ç”±JSå¡«å…… -->
                                <p class="text-center text-muted small p-3">æš‚æ— å¾…å¤„ç†ä»»åŠ¡</p>
                            </div>
                        </div>

                        <!-- è¿›è¡Œä¸­ä»»åŠ¡ -->
                        <div class="task-column">
                            <div class="column-header">
                                <h3>è¿›è¡Œä¸­</h3>
                                <span class="task-count" data-status="inprogress">0</span>
                            </div>
                            <div class="task-list" data-status="inprogress">
                                 <p class="text-center text-muted small p-3">æš‚æ— è¿›è¡Œä¸­ä»»åŠ¡</p>
                            </div>
                        </div>

                        <!-- å·²å®Œæˆä»»åŠ¡ -->
                        <div class="task-column">
                            <div class="column-header">
                                <h3>å·²å®Œæˆ</h3>
                                <span class="task-count" data-status="completed">0</span>
                            </div>
                            <div class="task-list" data-status="completed">
                                <p class="text-center text-muted small p-3">æš‚æ— å·²å®Œæˆä»»åŠ¡</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰“é€ æ–°æ­Œé¡µé¢ -->
            <div id="songPage" class="page">
                <div class="song-container">
                    <!-- é¡µé¢æ ‡é¢˜å’Œè¿›åº¦ -->
                    <div class="song-header">
                        <div class="header-content">
                            <h2><i class="fas fa-music"></i> æ‰“é€ æ–°æ­Œ</h2>
                            <p>åˆ›å»ºä¸€é¦–å…¨æ–°çš„æ­Œæ›²ï¼Œå¡«å†™æ‰€æœ‰å¿…è¦ä¿¡æ¯å®Œæˆåˆ¶ä½œã€‚</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" id="startProductionBtn"><i class="fas fa-play"></i> å¼€å§‹åˆ¶ä½œ</button>
                        </div>
                    </div>

                    <!-- åˆå¹¶åœ¨ä¸€ä¸ªé¡µé¢çš„æ‰€æœ‰é€‰é¡¹ -->
                    <div class="creation-content">
                        <div class="row">
                            <!-- å·¦ä¾§ï¼šåŸºæœ¬ä¿¡æ¯ -->
                            <div class="col-md-6">
                                <!-- ä¸»é¢˜é€‰æ‹© -->
                                <div class="creation-section">
                                    <h3 class="section-title"><i class="fas fa-lightbulb"></i> 1. ä¸»é¢˜å’Œé£æ ¼</h3>

                                    <div class="form-group mb-4">
                                        <label for="songTheme" class="form-label">é€‰æ‹©ä¸»é¢˜</label>
                                        <select class="form-select" id="songTheme">
                                            <option value="">è¯·é€‰æ‹©ä¸»é¢˜...</option>
                                            <option value="love">çˆ±æƒ…</option>
                                            <option value="friendship">å‹æƒ…</option>
                                            <option value="dreams">è¿½æ¢¦</option>
                                            <option value="growth">æˆé•¿</option>
                                            <option value="courage">å‹‡æ°”</option>
                                            <option value="happiness">å¿«ä¹</option>
                                            <option value="nature">è‡ªç„¶</option>
                                            <option value="youth">é’æ˜¥</option>
                                            <option value="hope">å¸Œæœ›</option>
                                            <option value="custom">è‡ªå®šä¹‰</option>
                                        </select>
                                        <div id="customThemeContainer" style="display: none;" class="mt-2">
                                            <input type="text" class="form-control" id="customTheme" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ä¸»é¢˜">
                                        </div>
                                    </div>

                                    <div class="form-group mb-4">
                                        <label class="form-label">é€‰æ‹©æ›²é£</label>
                                        <select class="form-select" id="songStyle">
                                            <option value="">è¯·é€‰æ‹©æ›²é£...</option>
                                            <option value="pop">æµè¡Œ Pop</option>
                                            <option value="dance">èˆæ›² Dance</option>
                                            <option value="ballad">æŠ’æƒ… Ballad</option>
                                            <option value="rnb">R&B</option>
                                            <option value="rock">æ‘‡æ»š Rock</option>
                                            <option value="electronic">ç”µå­ Electronic</option>
                                            <option value="hiphop">å˜»å“ˆ Hip-Hop</option>
                                            <option value="jazz">çˆµå£« Jazz</option>
                                            <option value="acoustic">åŸå£° Acoustic</option>
                                            <option value="fusion">æ··åˆ Fusion</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- é€‰æ‹©æˆå‘˜ -->
                                <div class="creation-section">
                                    <h3 class="section-title"><i class="fas fa-users"></i> 2. é€‰æ‹©å‚ä¸æˆå‘˜</h3>

                                    <div class="mb-3">
                                        <label class="form-label">ä¸»å”± (å•é€‰)</label>
                                        <div class="member-selection" id="mainVocalSelection">
                                             <!-- ä¸»å”±é€‰æ‹©é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                             <p class="text-muted small">è¯·å…ˆåŠ è½½æˆå‘˜æ•°æ®</p>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">å’Œå£°/å‰¯å”± (å¤šé€‰)</label>
                                        <div class="member-selection multiple" id="subVocalSelection">
                                             <!-- å’Œå£°é€‰æ‹©é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                              <p class="text-muted small">è¯·å…ˆåŠ è½½æˆå‘˜æ•°æ®</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å³ä¾§ï¼šåˆ¶ä½œå›¢é˜Ÿå’Œå…¶ä»–è®¾ç½® -->
                            <div class="col-md-6">
                                <!-- åˆ¶ä½œå›¢é˜Ÿ -->
                                <div class="creation-section">
                                    <h3 class="section-title"><i class="fas fa-user-tie"></i> 3. åˆ¶ä½œå›¢é˜Ÿé€‰æ‹©</h3>
                                    <div class="mb-3">
                                        <label for="composer" class="form-label">ä½œæ›²</label>
                                        <select class="form-select" id="composer">
                                            <option value="">è¯·åŠ è½½åˆ¶ä½œå›¢é˜Ÿæ•°æ®...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="lyricist" class="form-label">ä½œè¯</label>
                                        <select class="form-select" id="lyricist">
                                           <option value="">è¯·åŠ è½½åˆ¶ä½œå›¢é˜Ÿæ•°æ®...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="arranger" class="form-label">ç¼–æ›²</label>
                                        <select class="form-select" id="arranger">
                                            <option value="">è¯·åŠ è½½åˆ¶ä½œå›¢é˜Ÿæ•°æ®...</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- MVè®¡åˆ’ -->
                                <div class="creation-section">
                                    <h3 class="section-title"><i class="fas fa-film"></i> 4. MVåˆ¶ä½œè®¡åˆ’</h3>

                                    <div class="mb-3">
                                        <label for="mvDirector" class="form-label">MVå¯¼æ¼”</label>
                                        <select class="form-select" id="mvDirector">
                                            <option value="">è¯·åŠ è½½åˆ¶ä½œå›¢é˜Ÿæ•°æ®...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="mvConcept" class="form-label">MVæ¦‚å¿µ</label>
                                        <input type="text" class="form-control" id="mvConcept" placeholder="ç®€å•æè¿°MVçš„ä¸»è¦æ¦‚å¿µ...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- é¢„ç®—å’Œé¢„è§ˆ -->
                        <div class="creation-summary">
                            <div class="row g-3">
                                <div class="col-lg-7">
                                    <div class="budget-summary">
                                        <h3 class="section-title"><i class="fas fa-wallet"></i> é¢„ç®—æ¦‚è§ˆ</h3>
                                        <div class="budget-items" id="budgetItems">
                                            <p class="text-muted small">è¯·å…ˆé€‰æ‹©åˆ¶ä½œå›¢é˜Ÿ</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="song-preview">
                                        <h3 class="section-title"><i class="fas fa-check-circle"></i> æ­Œæ›²æ¦‚è§ˆ</h3>
                                        <div class="preview-items" id="previewItems">
                                             <p class="text-muted small">è¯·é€‰æ‹©æ­Œæ›²é£æ ¼å’Œä¸»å”±</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•…äº‹æ€»ç»“é¡µé¢ -->
            <div id="summaryPage" class="page">
                <div class="summary-container container py-4">
                    <h2 class="mb-4"><i class="fas fa-list-alt me-2"></i>æ•…äº‹æ€»ç»“å›é¡¾</h2>
                    <div id="storySummaryList" class="summary-stack"> <!-- ä½¿ç”¨æ–°ç±»å -->
                        <!-- æ€»ç»“åˆ—è¡¨å°†ç”± JS åŠ¨æ€å¡«å…… -->
                        <p class="empty-summary-message">æ­£åœ¨åŠ è½½æ€»ç»“...</p>
                    </div>
                </div>
            </div>

            <!-- ç‰¹è®­è®¡åˆ’é¡µé¢ -->
            <div id="trainingPage" class="page">
                <div class="training-container">
                    <div class="training-header">
                        <h2>ç‰¹è®­è®¡åˆ’</h2>
                    </div>
                    <div class="training-grid">
                        <!-- è®­ç»ƒå¡ç‰‡ -->
                        <div class="training-card">
                            <h3 class="training-title">å£°ä¹è®­ç»ƒ</h3>
                            <p class="training-desc">æé«˜å£°ä¹æŠ€å·§ï¼Œå¢å¼ºå£°éŸ³è¡¨ç°åŠ›</p>
                            <div class="training-stats-grid">
                                <div class="training-stat">
                                    <i class="fas fa-microphone"></i>
                                    <span>å½±å“ï¼šéŸ³åŸŸã€éŸ³å‡†</span>
                                </div>
                                <div class="training-stat">
                                     <i class="fas fa-users"></i>
                                     <span>é€‚åˆï¼šä¸»å”±ã€å’Œå£°</span>
                                </div>
                            </div>
                            <!-- ç§»é™¤æ—§çš„è¿›åº¦æ¡ -->
                            <div class="training-actions">
                                <button class="btn-train" data-type="vocal" data-cost="5000">å¼€å§‹è®­ç»ƒ</button>
                                <div class="training-cost"><i class="fas fa-yen-sign"></i> 5000</div>
                            </div>
                        </div>
                         <div class="training-card">
                            <h3 class="training-title">èˆè¹ˆè®­ç»ƒ</h3>
                            <p class="training-desc">æé«˜èˆè¹ˆæŠ€å·§ï¼Œå¢å¼ºèˆå°è¡¨ç°åŠ›</p>
                            <div class="training-stats-grid">
                                <div class="training-stat">
                                    <i class="fas fa-running"></i>
                                    <span>å½±å“ï¼šåè°ƒã€ç²¾å‡†</span>
                                </div>
                                <div class="training-stat">
                                     <i class="fas fa-users"></i>
                                     <span>é€‚åˆï¼šèˆæ‹…ã€å…¨ä½“</span>
                                </div>
                            </div>
                            <div class="training-actions">
                                <button class="btn-train" data-type="dance" data-cost="5000">å¼€å§‹è®­ç»ƒ</button>
                                <div class="training-cost"><i class="fas fa-yen-sign"></i> 5000</div>
                            </div>
                        </div>
                        <div class="training-card">
                            <h3 class="training-title">è¡¨æ¼”è®­ç»ƒ</h3>
                            <p class="training-desc">æå‡èˆå°æ„ŸæŸ“åŠ›å’Œé•œå¤´æ„Ÿ</p>
                            <div class="training-stats-grid">
                                <div class="training-stat">
                                    <i class="fas fa-theater-masks"></i>
                                    <span>å½±å“ï¼šè¡¨æƒ…ã€è¡¨ç°åŠ›</span>
                                </div>
                                 <div class="training-stat">
                                     <i class="fas fa-users"></i>
                                     <span>é€‚åˆï¼šå…¨ä½“æˆå‘˜</span>
                                </div>
                            </div>
                            <div class="training-actions">
                                <button class="btn-train" data-type="performance" data-cost="5000">å¼€å§‹è®­ç»ƒ</button>
                                <div class="training-cost"><i class="fas fa-yen-sign"></i> 5000</div>
                            </div>
                        </div>
                         <div class="training-card">
                            <h3 class="training-title">é­…åŠ›è®­ç»ƒ</h3>
                            <p class="training-desc">å¢å¼ºä¸ªäººå¸å¼•åŠ›å’Œç²‰ä¸äº’åŠ¨èƒ½åŠ›</p>
                            <div class="training-stats-grid">
                                <div class="training-stat">
                                    <i class="fas fa-heart"></i>
                                    <span>å½±å“ï¼šäº²å’Œã€å½¢è±¡</span>
                                </div>
                                <div class="training-stat">
                                     <i class="fas fa-users"></i>
                                     <span>é€‚åˆï¼šé—¨é¢ã€å…¨ä½“</span>
                                </div>
                            </div>
                            <div class="training-actions">
                                <button class="btn-train" data-type="charm" data-cost="5000">å¼€å§‹è®­ç»ƒ</button>
                                <div class="training-cost"><i class="fas fa-yen-sign"></i> 5000</div>
                            </div>
                        </div>
                         <div class="training-card">
                            <h3 class="training-title">ç»¼è‰ºæ„Ÿè®­ç»ƒ</h3>
                            <p class="training-desc">æé«˜åœ¨ç»¼è‰ºèŠ‚ç›®ä¸­çš„åº”å˜å’Œæç¬‘èƒ½åŠ›</p>
                            <div class="training-stats-grid">
                                <div class="training-stat">
                                    <i class="fas fa-tv"></i>
                                    <span>å½±å“ï¼šååº”ã€å¹½é»˜</span>
                                </div>
                                 <div class="training-stat">
                                     <i class="fas fa-users"></i>
                                     <span>é€‚åˆï¼šç»¼è‰ºæ‹…å½“ã€å…¨ä½“</span>
                                </div>
                            </div>
                            <div class="training-actions">
                                <button class="btn-train" data-type="variety" data-cost="5000">å¼€å§‹è®­ç»ƒ</button>
                                <div class="training-cost"><i class="fas fa-yen-sign"></i> 5000</div>
                            </div>
                        </div>
                        <!-- å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šè®­ç»ƒç±»å‹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬å¼•å…¥ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
const PLACEHOLDER_IMG = 'https://files.catbox.moe/alqtva.png'; // Default avatar URL

        // æ¸¸æˆæ–‡æœ¬æ¨¡æ¿å®šä¹‰ï¼ˆä¸å¯å˜ï¼‰
        let gameText = `<gametext>$1</gametext>`;

        // åŸºç¡€æ•°æ®ç»“æ„å®šä¹‰
        const initialGameState = {
            story: {
                date: "",
                location: "",
                scene: "",
                dialogue: [],
                options: [],
                currentChapter: "",
                currentFunds: 0
            },
            characters: { members: [] }, // ç¡®ä¿ characters æœ‰ members æ•°ç»„
            contacts: [],
            team: {
                basicInfo: {},
                members: [],
                achievements: [],
                schedule: []
            },
            plan: [],
            song: {
                themes: [],
                styles: [],
                members: [], // è¿™ä¸ªå¯èƒ½ä¸éœ€è¦äº†ï¼Œæˆå‘˜ä» characters æ¥
                productionTeams: {
                    composers: [],
                    lyricists: [],
                    arrangers: [],
                    mvDirectors: []
                }
            },
            storySummary: []
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = structuredClone(initialGameState); // ä½¿ç”¨æ·±æ‹·è´åˆå§‹åŒ–

        // æ–‡æœ¬ç³»ç»Ÿé…ç½®
        const TextSystem = {
            config: {
                baseSpeed: 50,
                autoPlayDelay: 2000,
                isAutoPlaying: false,
                isTyping: false,
                stopTypingCallback: null
            },
            currentScript: [],
            currentIndex: 0,
            isProcessingChapter: false,
            // ã€ä¿®æ”¹ã€‘æ·»åŠ å†å²è®°å½•ä¸Šé™å’Œå­˜å‚¨æ•°ç»„
            MAX_HISTORY_LENGTH: 300,
            dialogueHistory: [],

            init() {
                this.bindEvents();
                this.showCurrentText();
            },

            bindEvents() {
                const textBox = document.getElementById('text-box');
                const btnAuto = document.getElementById('btn-auto');
                // const btnSkip = document.getElementById('btn-skip'); // Skip æŒ‰é’®ä¼¼ä¹æœªåœ¨ HTML ä¸­å®šä¹‰
                const btnReset = document.getElementById('btn-reset');

                if (textBox) {
                    textBox.addEventListener('click', () => this.handleClick());
                }
                if (btnAuto) {
                    btnAuto.addEventListener('click', () => this.toggleAutoPlay());
                }
                // if (btnSkip) {
                //     btnSkip.addEventListener('click', () => this.skipToEnd());
                // }
                if (btnReset) {
                    btnReset.addEventListener('click', () => this.resetScript());
                }

                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' || e.code === 'Enter') {
                        // é¿å…åœ¨è¾“å…¥æ¡†æ¿€æ´»æ—¶è§¦å‘
                        if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                            this.handleClick();
                        }
                    }
                });
            },

             // ã€ä¿®æ”¹å¼€å§‹ï¼šTextSystem.addToHistoryã€‘
            addToHistory: function(textItem) {
                // *** æ·»åŠ å†å²è®°å½•ä¸Šé™é€»è¾‘ ***
                if (this.dialogueHistory.length >= this.MAX_HISTORY_LENGTH) {
                    const itemsToRemove = this.dialogueHistory.length - this.MAX_HISTORY_LENGTH + 1;
                    this.dialogueHistory.splice(0, itemsToRemove);
                    // console.log(`å†å²è®°å½•å·²æ»¡ï¼Œç§»é™¤äº† ${itemsToRemove} æ¡æ—§è®°å½•ã€‚`);
                }
                // *** å†å²è®°å½•ä¸Šé™é€»è¾‘ç»“æŸ ***

                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„æ–‡æœ¬ï¼Œé˜²æ­¢é‡å¤æ·»åŠ  (é€»è¾‘ä¿æŒä¸å˜)
                const isDuplicate = this.dialogueHistory.some(existingItem => {
                    if (textItem.speaker === 'æ—ç™½') {
                        return existingItem.speaker === 'æ—ç™½' && existingItem.content === textItem.content;
                    } else {
                        return existingItem.speaker === textItem.speaker && existingItem.content === textItem.content;
                    }
                });

                if (isDuplicate) {
                    // console.log('é‡å¤çš„å†å²è®°å½•ï¼Œè·³è¿‡æ·»åŠ :', textItem);
                    return;
                }

                // å°†æ–°çš„å†å²è®°å½•é¡¹ï¼ˆåŸå§‹å¯¹è±¡ï¼‰æ·»åŠ åˆ°æ•°ç»„ä¸­
                this.dialogueHistory.push(textItem);
                // console.log('å·²æ·»åŠ å†å²è®°å½•:', textItem, 'å½“å‰æ€»æ•°:', this.dialogueHistory.length);

                // ä¸å†éœ€è¦æ›´æ–° DOM å…ƒç´ 
            },
             // ã€ä¿®æ”¹ç»“æŸï¼šTextSystem.addToHistoryã€‘


            showCurrentText() {
                if (this.currentIndex >= this.currentScript.length) {
                    console.log("å‰§æœ¬ç»“æŸï¼Œæ˜¾ç¤ºé€‰é¡¹å¹¶å¤„ç†ç« èŠ‚...");
                    this.showOptions();
                    // å¼‚æ­¥å¤„ç†ç« èŠ‚ï¼Œä¸é˜»å¡é€‰é¡¹æ˜¾ç¤º
                    this.processChapterInWorldBook().catch(err => console.error("å¤„ç†ç« èŠ‚æ—¶å‡ºé”™:", err));
                    return;
                }

                const currentText = this.currentScript[this.currentIndex];
                 if (!currentText || typeof currentText.speaker === 'undefined' || typeof currentText.content === 'undefined') {
                     console.error(`å½“å‰å‰§æœ¬ç´¢å¼• ${this.currentIndex} å¤„çš„æ–‡æœ¬æ— æ•ˆ:`, currentText);
                     this.currentIndex++; // è·³è¿‡æ— æ•ˆæ¡ç›®
                     this.showCurrentText(); // å°è¯•ä¸‹ä¸€æ¡
                     return;
                 }

                const nameBox = document.getElementById('name-box');
                const storyContent = document.getElementById('story-content');
                const textBox = document.getElementById('text-box');
                const effectOverlay = document.getElementById('effect-overlay');
                const sceneContainer = document.getElementById('scene-container');

                 if (!nameBox || !storyContent || !textBox || !effectOverlay || !sceneContainer) {
                      console.error("è§†è§‰å°è¯´ UI å…ƒç´ ç¼ºå¤±ï¼");
                      return;
                 }

                // é‡ç½®ç‰¹æ•ˆå’Œç«‹ç»˜
                textBox.className = 'text-box';
                effectOverlay.className = 'effect-overlay';
                sceneContainer.querySelectorAll('.character-sprite').forEach(sprite => sprite.remove());

                // è®¾ç½®è¯´è¯è€…å’Œç«‹ç»˜
                if (currentText.speaker === 'æ—ç™½') {
                    nameBox.style.display = 'none';
                } else {
                    nameBox.style.display = 'block';
                    nameBox.textContent = currentText.speaker;
                    const character = CharacterSystem.getCharacterByName(currentText.speaker); // ä½¿ç”¨æ–°æ–¹æ³•æŒ‰åç§°æŸ¥æ‰¾
                    if (character && character.avatar && character.avatar.trim() !== '') {
                        const sprite = document.createElement('img');
                        sprite.onerror = () => { sprite.remove(); };
                        sprite.src = character.avatar;
                        // TODO: å†³å®šç«‹ç»˜ä½ç½® (å·¦å³æˆ–ä¸­é—´?) - æš‚æ—¶éƒ½æ”¾å·¦è¾¹
                        sprite.className = 'character-sprite left';
                        sprite.alt = character.name;
                        sceneContainer.appendChild(sprite);
                    }
                }

                // é€å­—æ˜¾ç¤º
                const textContainer = document.createElement('div');
                textContainer.className = `text-${currentText.style || 'normal'}`; // æ·»åŠ é»˜è®¤æ ·å¼
                storyContent.innerHTML = '';
                storyContent.appendChild(textContainer);

                let index = 0;
                this.config.isTyping = true;
                let animationFrameId = null;

                const type = (timestamp) => {
                    if (!this.config.isTyping) { // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
                        textContainer.textContent = currentText.content;
                        if (this.config.isAutoPlaying) {
                            setTimeout(() => this.nextText(), this.config.autoPlayDelay);
                        }
                        this.addToHistory(currentText); // å®Œæˆåæ·»åŠ åˆ°å†å²
                        return;
                    }

                    // ä½¿ç”¨ requestAnimationFrame æ§åˆ¶æ‰“å­—é€Ÿåº¦ï¼Œå‡å°‘å¡é¡¿å¯èƒ½
                    // (è¿™é‡Œç®€åŒ–äº†ï¼Œå®é™…é€å­—æ•ˆæœéœ€è¦æ›´å¤æ‚çš„è®¡æ—¶é€»è¾‘ï¼Œæš‚æ—¶ä¿æŒ setTimeout)
                    if (index < currentText.content.length) {
                        textContainer.textContent += currentText.content[index];
                        index++;
                        // ä½¿ç”¨ setTimeout æ¨¡æ‹Ÿæ‰“å­—é€Ÿåº¦
                        setTimeout(() => requestAnimationFrame(type), this.config.baseSpeed);
                    } else {
                        this.config.isTyping = false;
                        this.addToHistory(currentText); // å®Œæˆåæ·»åŠ åˆ°å†å²
                        if (this.config.isAutoPlaying) {
                            setTimeout(() => this.nextText(), this.config.autoPlayDelay);
                        }
                         // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ–‡æœ¬éƒ½æ˜¾ç¤ºå®Œäº†
                         if (this.currentIndex >= this.currentScript.length - 1) {
                              console.log("åˆ°è¾¾å‰§æœ¬æœ€åä¸€æ¡ï¼Œå‡†å¤‡æ˜¾ç¤ºé€‰é¡¹...");
                              this.showOptions(); // æ˜¾ç¤ºé€‰é¡¹
                              this.processChapterInWorldBook().catch(err => console.error("å¤„ç†ç« èŠ‚æ—¶å‡ºé”™:", err)); // å¤„ç†ç« èŠ‚
                         }
                    }
                };

                requestAnimationFrame(type); // å¯åŠ¨æ‰“å­—åŠ¨ç”»
            },

            handleClick() {
                if (this.config.isTyping) {
                    console.log("æ‰“å­—ä¸­ç‚¹å‡»ï¼Œç«‹å³å®Œæˆ");
                    this.config.isTyping = false; // è¿™ä¼šä¸­æ–­ type() ä¸­çš„å¾ªç¯
                    // ç¡®ä¿å†…å®¹å®Œæ•´æ˜¾ç¤º (å¯èƒ½éœ€è¦åœ¨ type å‡½æ•°çš„æ£€æŸ¥ä¸­æ›´å¯é åœ°è®¾ç½®)
                    // æ‰¾åˆ°å½“å‰æ˜¾ç¤ºçš„æ–‡æœ¬å®¹å™¨å¹¶è®¾ç½®å®Œæ•´å†…å®¹
                     const textContainer = document.getElementById('story-content')?.firstChild;
                     if (textContainer && this.currentIndex < this.currentScript.length) {
                         textContainer.textContent = this.currentScript[this.currentIndex].content;
                         // ç¡®ä¿ç«‹å³æ·»åŠ åˆ°å†å²è®°å½•
                         this.addToHistory(this.currentScript[this.currentIndex]);
                     }
                     // å¦‚æœæ˜¯è‡ªåŠ¨æ’­æ”¾ï¼Œå–æ¶ˆå»¶æ—¶
                     if (this.config.isAutoPlaying) {
                          // å¯èƒ½éœ€è¦æ¸…é™¤ä¹‹å‰çš„ setTimeout
                     }
                } else {
                    console.log("æ–‡æœ¬æ˜¾ç¤ºå®Œæ¯•ç‚¹å‡»ï¼Œè¿›å…¥ä¸‹ä¸€æ¡");
                    this.nextText();
                }
            },

            nextText() {
                if (this.currentIndex < this.currentScript.length - 1) {
                     this.currentIndex++;
                     this.showCurrentText();
                } else if (this.currentIndex === this.currentScript.length - 1) {
                    // è¿™æ˜¯æœ€åä¸€æ¡ï¼Œæ˜¾ç¤ºé€‰é¡¹ä½†ä¸å¢åŠ  currentIndex
                     console.log("å·²ç»æ˜¯æœ€åä¸€æ¡ï¼Œæ˜¾ç¤ºé€‰é¡¹ã€‚");
                     this.currentIndex++; // æ‰‹åŠ¨å¢åŠ ç´¢å¼•è¡¨ç¤ºç»“æŸ
                     this.showOptions();
                     this.processChapterInWorldBook().catch(err => console.error("å¤„ç†ç« èŠ‚æ—¶å‡ºé”™:", err));
                } else {
                    console.log("å‰§æœ¬å·²ç»“æŸæˆ–ç´¢å¼•æ— æ•ˆ");
                    // å¯èƒ½éœ€è¦ç¡®ä¿é€‰é¡¹ä»ç„¶å¯è§
                    this.showOptions();
                }
            },

            toggleAutoPlay() {
                this.config.isAutoPlaying = !this.config.isAutoPlaying;
                const btnAuto = document.getElementById('btn-auto');
                 if(btnAuto) btnAuto.textContent = this.config.isAutoPlaying ? 'åœæ­¢' : 'è‡ªåŠ¨';

                if (this.config.isAutoPlaying && !this.config.isTyping) {
                    // å¦‚æœå½“å‰æ–‡æœ¬å·²æ˜¾ç¤ºå®Œï¼Œå¹¶ä¸”å¼€å¯äº†è‡ªåŠ¨æ’­æ”¾ï¼Œåˆ™ç«‹å³è¿›å…¥ä¸‹ä¸€æ¡
                     if (this.currentIndex < this.currentScript.length) {
                          this.nextText();
                     } else {
                          console.log("è‡ªåŠ¨æ’­æ”¾ï¼šå·²åœ¨å‰§æœ¬æœ«å°¾ï¼Œä¸è‡ªåŠ¨å‰è¿›ã€‚");
                     }
                }
            },

            
            resetScript() {
                console.log("é‡ç½®å‰§æœ¬æ˜¾ç¤º...");
                this.currentIndex = 0;
                this.config.isAutoPlaying = false;
                this.config.isTyping = false;
                const btnAuto = document.getElementById('btn-auto');
                if (btnAuto) btnAuto.textContent = 'è‡ªåŠ¨';
                // æ¸…ç©ºå†å²è®°å½•ï¼Ÿæ ¹æ®éœ€æ±‚å†³å®šæ˜¯å¦éœ€è¦æ¸…ç©º this.dialogueHistory
                // this.dialogueHistory = [];
                this.showCurrentText(); // ä»å¤´æ˜¾ç¤º
            },

            showOptions() {
                const activePage = document.querySelector('.page.active');
                if (!activePage || activePage.id !== 'storyPage') {
                    console.log("showOptions: ä¸åœ¨æ•…äº‹é¡µé¢ï¼Œè·³è¿‡é€‰é¡¹æ˜¾ç¤ºã€‚");
                    toggleOptionsPanel(false); // ç¡®ä¿é€‰é¡¹é¢æ¿éšè—
                    return;
                }

                console.log("showOptions: åœ¨æ•…äº‹é¡µé¢ï¼Œå‡†å¤‡æ˜¾ç¤ºé€‰é¡¹ã€‚");
                const optionsContainer = document.querySelector('.interaction-options');
                const optionsList = document.getElementById('story-options');
                const customOptionContainer = document.getElementById('customOptionContainer');

                if (!optionsContainer || !optionsList || !customOptionContainer) {
                    console.error("showOptions é”™è¯¯: ç¼ºå°‘å¿…è¦çš„ HTML å…ƒç´  (.interaction-options, #story-options, or #customOptionContainer)");
                    return;
                }

                optionsList.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
                let optionsToDisplay = [];
                let useDefaultOptions = false;
                const defaultOptions = [
                    "å¸¦å¤§å®¶åˆ°ç»ƒä¹ å®¤æ’ç»ƒæ–°æ­Œ",
                    "å®£å¸ƒæ˜å¤©è¯·å®¢åƒé¥­",
                    "å®å˜±å¤§å®¶æ³¨æ„èº«ä½“"
                ];

                // æ£€æŸ¥ gameState.story.options æ˜¯å¦æœ‰æ•ˆä¸”éç©º
                if (gameState.story && Array.isArray(gameState.story.options) && gameState.story.options.length > 0) {
                     console.log("showOptions: ä½¿ç”¨ LLM æä¾›çš„é€‰é¡¹:", gameState.story.options);
                     optionsToDisplay = gameState.story.options;
                     useDefaultOptions = false;
                 } else {
                      console.log("showOptions: LLM é€‰é¡¹æ— æ•ˆæˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹ã€‚");
                      optionsToDisplay = defaultOptions;
                      useDefaultOptions = true;
                 }


                if (optionsToDisplay.length > 0) {
                    toggleOptionsPanel(true); // æ˜¾ç¤ºé€‰é¡¹å®¹å™¨
                    optionsToDisplay.forEach((option, index) => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-option mb-2 w-100';
                        button.textContent = option;
                        // ç§»é™¤æ—§ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç„¶åæ·»åŠ æ–°ç›‘å¬å™¨
                        const newButton = button.cloneNode(true);
                        newButton.addEventListener('click', () => {
                             console.log(`é€‰é¡¹æŒ‰é’®ç‚¹å‡»: "${option}", ç´¢å¼•: ${index}, isDefault: ${useDefaultOptions}`);
                             selectStoryOption(index + 1, newButton, useDefaultOptions); // ä¼ é€’æŒ‰é’®æœ¬èº«å’Œé»˜è®¤æ ‡è®°
                        });
                        optionsList.appendChild(newButton);
                    });
                    console.log("showOptions: é€‰é¡¹æŒ‰é’®å·²åˆ›å»ºã€‚");
                     // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥åŒºåŸŸ
                     customOptionContainer.style.display = 'block';

                } else {
                     console.warn("showOptions: æ²¡æœ‰å¯æ˜¾ç¤ºçš„é€‰é¡¹ï¼ˆåŒ…æ‹¬é»˜è®¤é€‰é¡¹ï¼‰ã€‚éšè—é€‰é¡¹é¢æ¿å’Œè‡ªå®šä¹‰è¾“å…¥ã€‚");
                     toggleOptionsPanel(false);
                     customOptionContainer.style.display = 'none'; // éšè—è‡ªå®šä¹‰è¾“å…¥
                }

                // ç»‘å®šè‡ªå®šä¹‰è¾“å…¥æŒ‰é’® (ä½¿ç”¨äº‹ä»¶å§”æ‰˜æˆ–å…‹éš†èŠ‚ç‚¹ç§»é™¤æ—§ç›‘å¬å™¨)
                 const submitBtn = document.getElementById('submitCustomOptionBtn');
                 const customInput = document.getElementById('customOptionInput');
                 if (submitBtn && customInput) {
                      const newSubmitBtn = submitBtn.cloneNode(true);
                      submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                      const newCustomInput = customInput.cloneNode(true);
                      customInput.parentNode.replaceChild(newCustomInput, customInput);

                      newSubmitBtn.addEventListener('click', () => {
                           const customText = newCustomInput.value.trim();
                           if (customText) {
                                console.log("è‡ªå®šä¹‰é€‰é¡¹æäº¤:", customText);
                                selectCustomOption(customText, optionsList); // è°ƒç”¨å¤„ç†å‡½æ•°
                                newCustomInput.value = '';
                           } else {
                                alert("è¯·è¾“å…¥ä½ çš„æƒ³æ³•ï¼");
                           }
                      });
                      newCustomInput.addEventListener('keypress', (e) => {
                           if (e.key === 'Enter') {
                                e.preventDefault();
                                newSubmitBtn.click();
                           }
                      });
                       console.log("showOptions: è‡ªå®šä¹‰è¾“å…¥ç›‘å¬å™¨å·²ç»‘å®šã€‚");
                 } else {
                     console.error("showOptions é”™è¯¯: æ‰¾ä¸åˆ°è‡ªå®šä¹‰è¾“å…¥æŒ‰é’®æˆ–å­—æ®µã€‚");
                     customOptionContainer.style.display = 'none'; // æ‰¾ä¸åˆ°å…ƒç´ åˆ™éšè—
                 }
                 console.log("--- showOptions å‡½æ•°ç»“æŸ ---");
            },

             // ã€ä¿®æ”¹å¼€å§‹ï¼šTextSystem.processChapterInWorldBookã€‘
             processChapterInWorldBook: async function() {
                 // é˜²æ­¢é‡å¤æ‰§è¡Œ
                 if (this.isProcessingChapter) {
                      console.log("processChapterInWorldBook: å·²åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡ã€‚");
                      return;
                 }
                  // æ£€æŸ¥ç« èŠ‚åæ˜¯å¦å­˜åœ¨
                 if (!gameState.story || !gameState.story.currentChapter || !gameState.story.currentChapter.trim()) {
                     console.log("processChapterInWorldBook: å½“å‰ç« èŠ‚åæ— æ•ˆæˆ–ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†ã€‚");
                     return;
                 }

                 this.isProcessingChapter = true;
                 console.log(`processChapterInWorldBook: å¼€å§‹å¤„ç†ç« èŠ‚ "${gameState.story.currentChapter}"`);

                 try {
                     // æ£€æŸ¥ API å‡½æ•°æ˜¯å¦å­˜åœ¨ (å¢åŠ å¥å£®æ€§)
                     if (typeof getLorebooks !== 'function' || typeof createLorebook !== 'function' ||
                         typeof getLorebookEntries !== 'function' || typeof createLorebookEntry !== 'function') {
                         console.warn("processChapterInWorldBook: ç¼ºå°‘å¿…è¦çš„é…’é¦† API å‡½æ•°ï¼Œæ— æ³•å¤„ç†ç« èŠ‚ã€‚");
                         this.isProcessingChapter = false;
                         return;
                     }

                     const worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
                     const lorebookList = await getLorebooks();
                     let bookExists = lorebookList.includes(worldBookName);

                     if (!bookExists) {
                         console.log(`åˆ›å»ºä¸–ç•Œä¹¦ "${worldBookName}"...`);
                         await createLorebook(worldBookName);
                         console.log(`ä¸–ç•Œä¹¦ "${worldBookName}" å·²åˆ›å»ºã€‚`);
                         await new Promise(resolve => setTimeout(resolve, 300)); // ç­‰å¾…ç”Ÿæ•ˆ
                     }

                     let chapterName = gameState.story.currentChapter;
                     // è§„èŒƒåŒ–ç« èŠ‚å
                     if (!/ç¬¬\d+ç« /.test(chapterName)) {
                         const numMatch = chapterName.match(/\d+/);
                         const num = numMatch ? numMatch[0] : 'æœªçŸ¥';
                         chapterName = `ç¬¬${num}ç« -${chapterName.replace(/ç¬¬?\d+ç« ?-?/,'').trim()}`;
                     }
                      console.log(`è§„èŒƒåŒ–ç« èŠ‚å: "${chapterName}"`);

                     // è·å–æ¡ç›®å¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨
                     const entries = await getLorebookEntries(worldBookName);
                     const existingChapter = entries.find(entry =>
                         entry.comment === chapterName ||
                         entry.comment === gameState.story.currentChapter // ä¹Ÿæ£€æŸ¥åŸå§‹åç§°
                     );

                     if (!existingChapter) {
                         console.log(`ç« èŠ‚ "${chapterName}" ä¸å­˜åœ¨ï¼Œå‡†å¤‡åˆ›å»º...`);
                         // *** ä» dialogueHistory æ”¶é›†ç« èŠ‚å†…å®¹ ***
                         let chapterContent = '';
                         if (this.dialogueHistory && this.dialogueHistory.length > 0) {
                             chapterContent = this.dialogueHistory
                                 .map(item => {
                                     if (!item || typeof item.speaker === 'undefined' || typeof item.content === 'undefined') return ''; // è·³è¿‡æ— æ•ˆé¡¹
                                     if (item.speaker === 'æ—ç™½') {
                                         return item.content;
                                     } else {
                                         return `${item.speaker}: ${item.content}`;
                                     }
                                 })
                                 .filter(line => line.trim()) // è¿‡æ»¤ç©ºè¡Œ
                                 .join('\n');
                             console.log(`æ”¶é›†åˆ° ${this.dialogueHistory.length} æ¡å¯¹è¯ç”Ÿæˆç« èŠ‚å†…å®¹ (é•¿åº¦: ${chapterContent.length})`);
                         } else {
                             console.warn("æ— æ³•æ”¶é›†ç« èŠ‚å†…å®¹ï¼ŒdialogueHistory ä¸ºç©ºã€‚");
                         }
                         // *** å†…å®¹æ”¶é›†ç»“æŸ ***

                         if (chapterContent.trim()) { // ä»…åœ¨æœ‰å†…å®¹æ—¶åˆ›å»º
                             try {
                                 const newEntry = await createLorebookEntry(worldBookName, {
                                     comment: chapterName,
                                     content: chapterContent,
                                     key: [chapterName, "ç« èŠ‚å›é¡¾"], // æ·»åŠ é€šç”¨ key
                                     enabled: false, // é»˜è®¤ä¸å¯ç”¨
                                     type: 'constant',
                                     position: 'before_character_definition'
                                 });
                                 console.log(`å·²åˆ›å»ºç« èŠ‚ "${chapterName}" æ¡ç›®åˆ°ä¸–ç•Œä¹¦ "${worldBookName}" (uid: ${newEntry?.uid})`);
                                 await new Promise(resolve => setTimeout(resolve, 500)); // ç¨ä½œç­‰å¾…
                             } catch (error) {
                                 console.error(`åˆ›å»ºç« èŠ‚æ¡ç›® "${chapterName}" å¤±è´¥:`, error);
                             }
                         } else {
                              console.warn(`ç« èŠ‚ "${chapterName}" å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œè·³è¿‡åˆ›å»ºä¸–ç•Œä¹¦æ¡ç›®ã€‚`);
                         }

                     } else {
                         console.log(`ç« èŠ‚ "${chapterName}" (uid: ${existingChapter.uid}) å·²å­˜åœ¨äºä¸–ç•Œä¹¦ä¸­ï¼Œæ— éœ€é‡å¤åˆ›å»ºã€‚`);
                         // å¯é€‰ï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´æ–°é€»è¾‘ï¼Œå¦‚æœéœ€è¦è¦†ç›–æ—§å†…å®¹
                     }

                     // ä¸å†åœ¨æ­¤å¤„æ˜¾ç¤ºç« èŠ‚åˆ—è¡¨

                 } catch (error) {
                     console.error('å¤„ç†ä¸–ç•Œä¹¦ç« èŠ‚æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯:', error);
                 } finally {
                     this.isProcessingChapter = false;
                      console.log("processChapterInWorldBook: å¤„ç†ç»“æŸã€‚");
                 }
             },
             // ã€ä¿®æ”¹ç»“æŸï¼šTextSystem.processChapterInWorldBookã€‘

             // ã€ä¿®æ”¹å¼€å§‹ï¼šTextSystem.displayChapterListã€‘
             displayChapterList: async function(worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ", containerElement) {
                 if (!containerElement) {
                     console.error("displayChapterList é”™è¯¯ï¼šæœªæä¾›æœ‰æ•ˆçš„å®¹å™¨å…ƒç´ ã€‚");
                     return;
                 }
                  console.log(`displayChapterList: å¼€å§‹ä¸ºå®¹å™¨ ${containerElement.id || 'æœªå‘½åå®¹å™¨'} åŠ è½½ç« èŠ‚åˆ—è¡¨...`);

                  // æ¸…ç©ºå®¹å™¨ï¼Œå‡†å¤‡é‡æ–°æ¸²æŸ“
                  containerElement.innerHTML = '<p class="text-muted small">æ­£åœ¨åŠ è½½ç« èŠ‚åˆ—è¡¨...</p>';


                 try {
                      // æ£€æŸ¥ API
                      if (typeof getLorebooks !== 'function' || typeof getLorebookEntries !== 'function') {
                          console.warn("displayChapterList: ç¼ºå°‘å¿…è¦çš„é…’é¦† API å‡½æ•°ã€‚");
                          containerElement.innerHTML = '<p class="text-danger small">æ— æ³•åŠ è½½ç« èŠ‚åˆ—è¡¨ (APIç¼ºå¤±)ã€‚</p>';
                          return;
                      }

                     const lorebookList = await getLorebooks();
                     if (!lorebookList.includes(worldBookName)) {
                         console.log(`ä¸–ç•Œä¹¦ "${worldBookName}" ä¸å­˜åœ¨ï¼Œæ— æ³•æ˜¾ç¤ºç« èŠ‚åˆ—è¡¨`);
                         containerElement.innerHTML = `<p class="text-muted small">ä¸–ç•Œä¹¦ "${worldBookName}" ä¸å­˜åœ¨ã€‚</p>`;
                         return;
                     }

                     await new Promise(resolve => setTimeout(resolve, 300)); // ç­‰å¾…æ½œåœ¨çš„æ¡ç›®åˆ›å»ºå®Œæˆ
                     const entries = await getLorebookEntries(worldBookName);
                      if (!entries) {
                          console.warn(`è·å–ä¸–ç•Œä¹¦ "${worldBookName}" æ¡ç›®å¤±è´¥ã€‚`);
                          containerElement.innerHTML = `<p class="text-warning small">æ— æ³•è·å– "${worldBookName}" çš„æ¡ç›®ä¿¡æ¯ã€‚</p>`;
                          return;
                      }

                     // å»é‡å’Œç­›é€‰ç« èŠ‚
                     const uniqueEntries = [];
                     const seenComments = new Set();
                     entries.forEach(entry => {
                         if (entry && entry.comment && !seenComments.has(entry.comment)) { // å¢åŠ  entry å­˜åœ¨æ€§æ£€æŸ¥
                             seenComments.add(entry.comment);
                             uniqueEntries.push(entry);
                         }
                     });

                     const chapterEntries = uniqueEntries.filter(entry =>
                         entry.comment &&
                         entry.comment.includes("ç« ") && // æ ¸å¿ƒç­›é€‰æ¡ä»¶
                         entry.comment.trim() !== ''
                     );
                     console.log(`ç­›é€‰å‡º ${chapterEntries.length} ä¸ªç« èŠ‚æ¡ç›®ã€‚`);

                     // æ’åº
                     chapterEntries.sort((a, b) => {
                         const getChapterNumber = (comment) => {
                             const match = comment.match(/ç¬¬(\d+)ç« /);
                             // å¤„ç†æ— æ³•åŒ¹é…æ•°å­—çš„æƒ…å†µï¼Œç»™ä¸€ä¸ªè¾ƒå¤§çš„é»˜è®¤å€¼
                             return match ? parseInt(match[1]) : Infinity;
                         };
                         return getChapterNumber(a.comment) - getChapterNumber(b.comment);
                     });


                      // æ¸…ç©ºå®¹å™¨çš„åŠ è½½æç¤º
                      containerElement.innerHTML = '';

                     // æ¸²æŸ“åˆ—è¡¨
                     if (chapterEntries.length > 0) {
                         const chapterListContainer = document.createElement('div');
                         chapterListContainer.id = 'chapter-list-container-in-modal'; // ä½¿ç”¨å”¯ä¸€ID
                         chapterListContainer.className = 'chapter-list-container mt-4';

                         const listTitle = document.createElement('h4');
                         listTitle.textContent = 'ç« èŠ‚å›é¡¾';
                         listTitle.className = 'chapter-title'; // å¤ç”¨æ ·å¼
                         chapterListContainer.appendChild(listTitle);

                         const chapterList = document.createElement('ul');
                         chapterList.className = 'chapter-list';

                         chapterEntries.forEach(entry => {
                              if (!entry.uid) { // è·³è¿‡æ²¡æœ‰ UID çš„æ— æ•ˆæ¡ç›®
                                   console.warn("å‘ç°æ²¡æœ‰ UID çš„ç« èŠ‚æ¡ç›®:", entry);
                                   return;
                              }
                             const chapterItem = document.createElement('li');
                             chapterItem.className = 'chapter-item';
                             chapterItem.textContent = entry.comment;
                             chapterItem.dataset.uid = entry.uid;
                             // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè°ƒç”¨ showChapterContent
                             chapterItem.addEventListener('click', () => this.showChapterContent(worldBookName, entry));
                             chapterList.appendChild(chapterItem);
                         });

                         chapterListContainer.appendChild(chapterList);
                         containerElement.appendChild(chapterListContainer);
                          console.log("ç« èŠ‚åˆ—è¡¨æ¸²æŸ“å®Œæˆã€‚");
                     } else {
                          const noChaptersMessage = document.createElement('p');
                          noChaptersMessage.textContent = 'æš‚æ— å·²ä¿å­˜çš„ç« èŠ‚å›é¡¾ã€‚';
                          noChaptersMessage.className = 'text-muted small mt-3';
                          containerElement.appendChild(noChaptersMessage);
                          console.log("æ²¡æœ‰æ‰¾åˆ°ç« èŠ‚æ¡ç›®ã€‚");
                     }
                 } catch (error) {
                     console.error('æ˜¾ç¤ºç« èŠ‚åˆ—è¡¨æ—¶å‡ºé”™:', error);
                     containerElement.innerHTML = `<p class="text-danger small">åŠ è½½ç« èŠ‚åˆ—è¡¨æ—¶å‡ºé”™: ${error.message}</p>`;
                 }
             },
             // ã€ä¿®æ”¹ç»“æŸï¼šTextSystem.displayChapterListã€‘

            showChapterContent: async function(lorebookName, entry) { // ä¿æŒ async
                try {
                    console.log(`æ˜¾ç¤ºç« èŠ‚å†…å®¹: "${entry.comment}" (uid: ${entry.uid})`);
                     // ç§»é™¤æ—§çš„ç« èŠ‚å†…å®¹æ¨¡æ€æ¡†
                     const existingModal = document.getElementById('chapterContentModal');
                     if(existingModal) existingModal.remove();

                    const modal = document.createElement('div');
                    modal.id = 'chapterContentModal'; // ç»™å®šå”¯ä¸€ID
                    modal.className = 'chapter-modal'; // å¤ç”¨æ ·å¼
                    modal.innerHTML = `
                        <div class="chapter-modal-content">
                            <div class="chapter-modal-header">
                                <h3>${entry.comment}</h3>
                                <button class="close-btn close-content-modal">&times;</button>
                            </div>
                            <div class="chapter-modal-body">
                                <p class="text-muted small mb-3">æ¥è‡ªä¸–ç•Œä¹¦ï¼š${lorebookName}</p>
                                <div class="chapter-content">
                                    ${entry.content.split('\n').map(line =>
                                        line.trim() ? `<p>${line}</p>` : ''
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                    // å…³é—­æŒ‰é’®äº‹ä»¶
                     const closeModalFunc = () => {
                          const contentModal = document.getElementById('chapterContentModal');
                          if(contentModal){
                               document.body.classList.remove('modal-open'); // ç§»é™¤é˜²æ­¢æ»šåŠ¨ç±»
                               contentModal.remove();
                               document.removeEventListener('keydown', handleEscKeyFunc); // ç§»é™¤ ESC ç›‘å¬
                               console.log("ç« èŠ‚å†…å®¹æ¨¡æ€æ¡†å·²å…³é—­ã€‚");
                          }
                     };
                    modal.querySelector('.close-content-modal').addEventListener('click', closeModalFunc);
                    // ç‚¹å‡»èƒŒæ™¯å…³é—­
                    modal.addEventListener('click', (e) => { if (e.target === modal) closeModalFunc(); });
                    // é˜»æ­¢å†…å®¹åŒºåŸŸç‚¹å‡»å†’æ³¡
                    modal.querySelector('.chapter-modal-content').addEventListener('click', e => e.stopPropagation());
                     // ESC é”®å…³é—­
                     const handleEscKeyFunc = (e) => { if (e.key === 'Escape') closeModalFunc(); };
                     document.addEventListener('keydown', handleEscKeyFunc);


                    document.body.classList.add('modal-open'); // æ·»åŠ é˜²æ­¢æ»šåŠ¨ç±»
                    document.body.appendChild(modal);
                     // æ»šåŠ¨åˆ°é¡¶éƒ¨
                     modal.querySelector('.chapter-modal-body').scrollTop = 0;

                } catch (error) {
                    console.error('æ˜¾ç¤ºç« èŠ‚å†…å®¹æ—¶å‡ºé”™:', error);
                    alert(`æ˜¾ç¤ºç« èŠ‚å†…å®¹æ—¶å‡ºé”™: ${error.message}`);
                }
            }
        };

        // æ•°æ®å¤„ç†ç³»ç»Ÿ
        const DataSystem = {
            DataExtractor: {
                extractMainText(data) {
                     // å¢åŠ å¥å£®æ€§æ£€æŸ¥
                    return (data && data.story) ? data.story : null;
                },
                extractCharacters(data) {
                    // æ£€æŸ¥ data.characters æ˜¯å¦å­˜åœ¨ä¸”æœ‰ members æ•°ç»„
                     if (data && data.characters) {
                          if (Array.isArray(data.characters.members)) {
                               return data.characters; // è¿”å›åŒ…å« members çš„å¯¹è±¡
                          } else if (typeof data.characters === 'object' && !Array.isArray(data.characters)) {
                                // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆç›´æ¥æ˜¯å¯¹è±¡ï¼‰ï¼Œä¹Ÿæ¥å—ï¼Œä½†æœ€å¥½ç»Ÿä¸€
                                console.warn("Character data is in direct object format, expected { members: [...] }");
                                return { members: Object.values(data.characters) }; // å°è¯•è½¬æ¢ä¸ºæ–°æ ¼å¼
                          }
                     }
                     return null; // æ— æ•ˆæˆ–ç¼ºå¤±æ—¶è¿”å› null
                },
                extractTeamText(data) {
                    return (data && data.team) ? data.team : null;
                },
                extractPlanText(data) {
                    // ç¡®ä¿è¿”å›çš„æ˜¯æ•°ç»„
                     return (data && Array.isArray(data.plan)) ? data.plan : [];
                },
                extractSongText(data) {
                     return (data && data.song) ? data.song : null;
                },
                 extractContactText(data) { // è¿™ä¸ªå‡½æ•°ç°åœ¨ä¼¼ä¹æ²¡è¢«ç›´æ¥ä½¿ç”¨ï¼Œcontacts ç”± CharacterSystem æ„å»º
                     console.warn("DataExtractor.extractContactText è¢«è°ƒç”¨ï¼Œä½† contacts ç°åœ¨ç”± CharacterSystem æ„å»ºã€‚");
                     // ä¿æŒè¿”å› CharacterSystem çš„æ•°æ®
                     return CharacterSystem.getContactsData();
                 }
            },

            UIUpdater: {
                backgroundScenes: { /* ... ä¿æŒä¸å˜ ... */
                    'å¤œæ™šå±…é…’å±‹å¤–': 'https://files.catbox.moe/no55n1.png',
                    'çƒ­é—¹çš„å±…é…’å±‹': 'https://files.catbox.moe/cf55mg.png',
                    'å¤œæ™šæˆ·å¤–': 'https://files.catbox.moe/ysxwsp.png',
                    'ç™½æ—¥è¡—é“': 'https://files.catbox.moe/zkolss.webp',
                    'ç™½æ—¥å…¬å›­': 'https://files.catbox.moe/ot4hgl.jpg',
                    'å§å®¤': 'https://files.catbox.moe/j6868o.jpg',
                    'æ’ç»ƒå®¤': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745022771155.jpg',
                    'å¤œæ™šåœ°é“': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745022518757.jpg',
                    'ç™½æ—¥åœ°é“': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745022511637.jpg',
                    'åå°': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745022497044.jpg',
                    'å¿«é¤åº—': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745018316924.jpg',
                    'é¤å…': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745018308565.jpg',
                    'å…¬å¸': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745023272560.jpg',
                    'èµ°å»Š': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745023260798.jpg',
                    'é…’å§': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745018299983.jpg',
                    'è¶…å¸‚': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745022926433.jpg',
                    'ä¾¿åˆ©åº—': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745022917817.jpg',
                    'é…’åº—': 'https://files.catbox.moe/5n8h7t.jpg',
                    'ç™½æ—¥é¤é¦†': 'https://files.catbox.moe/7izle2.jpg',
                    'ç™½æ—¥æµ·æ»©': 'https://files.catbox.moe/xof2f5.jpg',
                    'å‚æ™šæµ·æ»©': 'https://files.catbox.moe/ha3vp8.jpg',
                    'åŠå…¬å®¤': 'https://files.catbox.moe/ododjk.webp',
                    '{{user}}çš„å®¶': 'https://files.catbox.moe/tvlorq.jpg',
                    'æ¸¸ä¹åœº': 'https://files.catbox.moe/vrawrl.jpg',
                    'ä¹¡ä¸‹': 'https://files.catbox.moe/ofpa2r.jpg',
                    'èµ·å±…å®¤': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1745039019840.jpg',
                    'å¤©å°': 'https://files.catbox.moe/oc9nzs.jpg',
                    'ç™½æ—¥ç¹åçš„å¸‚ä¸­å¿ƒ': 'https://files.catbox.moe/ododjk.webp',
                    'livehouse': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1744643469669.jpg',
                    'å¤§å‹èˆå°': 'https://pub-0f03753252fb439e966a538d805f20ef.r2.dev/docs/1744643572359.jpg'
                 },
                sceneKeywords: { /* ... ä¿æŒä¸å˜ ... */
                    'é…’åº—': ['å¤§é…’åº—', 'å®¾é¦†', 'æ—…åº—', 'æ°‘å®¿', 'æ—…ç¤¾', 'æ—…é¦†'],
                    'å§å®¤': ['æˆ¿é—´', 'å¯å®¤', 'ç¡æˆ¿', 'å®¿èˆ'],
                    'ç™½æ—¥é¤é¦†': ['é¥­åº—', 'é¤å…', 'é£Ÿå ‚', 'é¥­é¦†', 'å°åƒåº—'],
                    'åŠå…¬å®¤': ['å·¥ä½œå®¤', 'å†™å­—æ¥¼', 'åŠå…¬åŒº', 'å·¥ä½œé—´'],
                    'èµ°å»Š': ['èµ°å»Š', 'è¿‡é“', 'é€šé“', 'èµ°é“', 'èµ°å»Šé“', 'è¿‡é“é“', 'é€šé“é“', 'èµ°é“é“', 'èµ°å»Šé“é“', 'è¿‡é“é“é“', 'é€šé“é“é“', 'èµ°é“é“é“'],
                    'å…¬å¸': ['å…¬å¸', 'ä¼ä¸š', 'æœºæ„', 'ç»„ç»‡', 'å•ä½', 'æœºæ„', 'ç»„ç»‡', 'å•ä½', 'å…¬å¸', 'ä¼ä¸š', 'æœºæ„', 'ç»„ç»‡', 'å•ä½', 'å…¬å¸', 'ä¼ä¸š', 'æœºæ„', 'ç»„ç»‡', 'å•ä½'],
                    'ç™½æ—¥åœ°é“': ['åœ°é“', 'åœ°ä¸‹é“', 'åœ°é“ç«™', 'åœ°ä¸‹é“ç«™', 'åœ°é“ç«™å°', 'åœ°ä¸‹é“ç«™å°'],
                    'åå°': ['åå°', 'åå°åŒºåŸŸ', 'ä¼‘æ¯å®¤', 'åå°åŒ–å¦†é—´', 'åå°å‡†å¤‡å®¤', 'åå°ä¼‘æ¯å®¤', 'åŒ–å¦†é—´', 'å‡†å¤‡å®¤', 'ä¼‘æ¯å®¤'],
                    'è¶…å¸‚': ['è¶…å¸‚', 'å•†åœº', 'è´­ç‰©ä¸­å¿ƒ', 'ç™¾è´§å•†åº—', 'å¤§å–åœº'],
                    'å¿«é¤åº—': ['å¿«é¤åº—', 'å¿«é¤é¤å…', 'å¿«é¤è¿é”åº—', 'å¿«é¤å°åƒåº—'],
                    'é¤å…': ['é¤å…', 'é¥­åº—', 'é¤é¦†', 'é¥­é¦†', 'é£Ÿå ‚'],
                    'é…’å§': ['é…’å§', 'å°é…’é¦†', 'é…’è‚†', 'é…’é¦†'],
                    'èµ·å±…å®¤': ['èµ·å±…å®¤', 'å®¢å…', 'ä¼šå®¢å…', 'èµ·å±…é—´', 'èµ·å±…åŒºåŸŸ'],
                    'ä¾¿åˆ©åº—': ['ä¾¿åˆ©åº—', 'å°å–éƒ¨', 'æ‚è´§åº—', 'å°å•†åº—'],
                    'æ’ç»ƒå®¤': ['æ’ç»ƒå®¤', 'ç»ƒä¹ å®¤', 'è®­ç»ƒå®¤', 'æ’ç»ƒæˆ¿'],
                    'ç™½æ—¥è¡—é“': ['é©¬è·¯', 'å¤§è¡—', 'è¡—ä¸Š', 'è¡—å¤´', 'äººè¡Œé“', 'å…¬å…±åŒºåŸŸ'],
                    'ç™½æ—¥å…¬å›­': ['èŠ±å›­', 'ç»¿åœ°', 'æ¸¸å›­', 'è‰åª', 'å…¬å›­', 'å…¬å›­ç»¿åœ°', 'å…¬å›­è‰åª', 'å…¬å›­èŠ±å›­'],
                    'æ¸¸ä¹åœº': ['æ¸¸ä¹å›­', 'ä¸»é¢˜å…¬å›­', 'ä¹å›­', 'æ¸¸å›­ä¼š'],
                    'å±…é…’å±‹': ['é…’å§', 'å°é…’é¦†', 'é…’è‚†', 'é…’é¦†'],
                    'ä¹¡ä¸‹': ['å†œæ‘', 'ç”°é‡', 'å†œåœº', 'ä¹¡æ‘', 'å±±åº„'],
                    'ç™½æ—¥æµ·æ»©': ['æµ·è¾¹', 'æ²™æ»©', 'æµ·å²¸', 'æ²™å²¸'],
                    'livehouse': ['æ¼”å‡ºåœºåœ°', 'å°å‹éŸ³ä¹ä¼šåœº', 'ç°åœºæ¼”å‡º'],
                    'å¤§å‹èˆå°': ['æ¼”å”±ä¼š', 'æ¼”å‡ºä¼šåœº', 'è¡¨æ¼”èˆå°', 'éŸ³ä¹å…', 'å‰§åœº', 'ä½“è‚²é¦†', 'å½•åˆ¶ç°åœº', 'èˆå°', 'è¡¨æ¼”åœºåœ°', 'è¡¨æ¼”ç°åœº', 'è¡¨æ¼”èˆå°', 'è¡¨æ¼”ä¼šåœº', 'è¡¨æ¼”éŸ³ä¹å…', 'è¡¨æ¼”å‰§åœº', 'è¡¨æ¼”ä½“è‚²é¦†', 'è¡¨æ¼”å½•åˆ¶ç°åœº', 'èŠ‚ç›®ç°åœº', 'ä¼šåœº', 'éŸ³ä¹å…', 'å‰§åœº', 'ä½“è‚²é¦†', 'è¡¨æ¼”å½•åˆ¶ç°åœº']
                },

                processSceneBackground(sceneDescription) {
                     if (!sceneDescription) return null;
                     const desc = sceneDescription.trim(); // å»é™¤ç©ºæ ¼
                     if (this.backgroundScenes[desc]) return this.backgroundScenes[desc];
                     for (const [key, url] of Object.entries(this.backgroundScenes)) {
                         if (desc.includes(key)) return url;
                     }
                     for (const [scene, keywords] of Object.entries(this.sceneKeywords)) {
                          if (keywords.some(keyword => desc.includes(keyword))) {
                              return this.backgroundScenes[scene];
                          }
                     }
                      console.warn(`æœªæ‰¾åˆ°åŒ¹é…çš„èƒŒæ™¯å›¾: "${desc}"`);
                     // å¦‚æœå®Œå…¨æ²¡æœ‰åŒ¹é…ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªé»˜è®¤èƒŒæ™¯æˆ– null
                     // return 'default-background.jpg';
                     return null; // æˆ–è€…è¿”å› null è®©èƒŒæ™¯é€æ˜/é»‘è‰²
                },

                updateMainText(mainTextData) {
                    if (!mainTextData) {
                        console.warn("updateMainText: æ”¶åˆ°æ— æ•ˆæ•°æ®");
                        return;
                    }
                     // æ›´æ–° DOMï¼Œå¢åŠ å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
                     const storyDateEl = document.getElementById('story-date');
                     if (storyDateEl) storyDateEl.innerHTML = `<i class="far fa-calendar-alt"></i> ${mainTextData.date || 'æœªçŸ¥æ—¥æœŸ'}`;

                     const storyLocationEl = document.getElementById('story-location');
                     if (storyLocationEl) storyLocationEl.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${mainTextData.location || 'æœªçŸ¥åœ°ç‚¹'}`;

                     const storyChapterEl = document.getElementById('story-chapter');
                     if (storyChapterEl) storyChapterEl.innerHTML = `<i class="fas fa-book"></i> ${mainTextData.currentChapter || 'æœªå‘½åç« èŠ‚'}`;

                     const storyFundsEl = document.getElementById('story-funds');
                     if (storyFundsEl) storyFundsEl.innerHTML = `<i class="fas fa-yen-sign"></i> ${mainTextData.currentFunds !== undefined ? formatCurrency(mainTextData.currentFunds) : '???'}`;

                    const sceneContainer = document.getElementById('scene-container');
                    if (sceneContainer) {
                         if (mainTextData.scene) {
                              const backgroundUrl = this.processSceneBackground(mainTextData.scene);
                              sceneContainer.style.backgroundImage = backgroundUrl ? `url('${backgroundUrl}')` : 'none';
                         } else {
                              sceneContainer.style.backgroundImage = 'none'; // æ¸…é™¤èƒŒæ™¯
                         }
                    }
                    // æ›´æ–°ç‰¹è®­é¡µé¢çš„èµ„é‡‘æ˜¾ç¤ºï¼ˆå¦‚æœè¯¥é¡µé¢å­˜åœ¨ï¼‰
                    const trainingFundsStatEl = document.getElementById('training-funds-stat');
                    if (trainingFundsStatEl) {
                        trainingFundsStatEl.textContent = mainTextData.currentFunds !== undefined ? formatCurrency(mainTextData.currentFunds) : '???';
                    }
                },

                updateContactText() {
                    const contactList = document.getElementById('contactList');
                    if (!contactList) {
                        console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è”ç³»äººåˆ—è¡¨å…ƒç´  #contactList");
                        return;
                    }
                    // ç›´æ¥ä½¿ç”¨ gameState.contactsï¼Œå®ƒåº”è¯¥å·²ç»è¢« CharacterSystem æ›´æ–°
                    const contactsToRender = gameState.contacts || [];
                    console.log(`æ¸²æŸ“è”ç³»äººåˆ—è¡¨ï¼Œå…± ${contactsToRender.length} äºº`);

                    contactList.innerHTML = contactsToRender.map(contact => {
                        if (!contact || !contact.name) {
                            console.warn("æ¸²æŸ“è”ç³»äººåˆ—è¡¨æ—¶é‡åˆ°æ— æ•ˆçš„è”ç³»äººæ•°æ®:", contact);
                            return '';
                        }
                         // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– PLACEHOLDER_IMG
                         const avatarSrc = (contact.avatar && typeof contact.avatar === 'string' && contact.avatar.trim() !== '') ? contact.avatar : PLACEHOLDER_IMG; // ä½¿ç”¨å¸¸é‡
                         const isActive = contact.name === currentContact ? 'active' : '';
                         const unreadBadgeHtml = contact.unread > 0 ? `<span class="unread-badge">${contact.unread}</span>` : '';
                         const statusClass = contact.status === 'online' ? 'online' : (contact.status === 'busy' ? 'busy' : (contact.status === 'away' ? 'away' : 'offline'));

                        return `
                        <div class="contact-item ${isActive}" data-contact="${contact.name}" data-id="${contact.id || ''}">
                            <div class="contact-avatar">
                               <img src="${avatarSrc}" alt="${contact.name}" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;">
                                <span class="status-badge ${statusClass}"></span>
                            </div>
                            <div class="contact-info">
                                <div class="contact-name-time">
                                    <span class="contact-name">${contact.name}</span>
                                    <span class="contact-time">${contact.lastTime || ''}</span>
                                </div>
                                <div class="contact-preview">
                                    <span class="preview-text">${contact.lastMessage || '...'}</span>
                                    ${unreadBadgeHtml}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');

                    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                    contactList.querySelectorAll('.contact-item').forEach(item => {
                         // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ç§»é™¤æ—§ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
                         const newItem = item.cloneNode(true);
                         item.parentNode.replaceChild(newItem, item);
                         newItem.addEventListener('click', () => {
                              const contactName = newItem.getAttribute('data-contact');
                              if (contactName) {
                                   switchContact(contactName);
                              }
                         });
                    });
                },

                updateTeamText(teamData) {
                    if (!teamData) {
                         console.warn("updateTeamText: æ”¶åˆ°æ— æ•ˆæ•°æ®");
                         return;
                    }
                    console.log("æ›´æ–°å›¢é˜Ÿä¿¡æ¯ UI...");

                    // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                    const teamInfo = document.getElementById('team-name');
                    if (teamInfo) teamInfo.textContent = teamData.name || 'æ˜Ÿå…‰å°‘å¥³å›¢';

                    const teamStats = document.getElementById('team-stats');
                    if (teamStats) {
                        const basicInfo = teamData.basicInfo || {};
                        teamStats.innerHTML = `
                            <div class="stat">
                                <i class="fas fa-heart"></i>
                                <span>ç²‰ä¸æ•°ï¼š${basicInfo.fans || '0'}</span>
                            </div>
                            <div class="stat">
                                <i class="fas fa-music"></i>
                                <span>åŸåˆ›æ›²ç›®ï¼š${basicInfo.songs || '0'}é¦–</span>
                            </div>
                            <div class="stat">
                                <i class="fas fa-trophy"></i>
                                <span>æ¼”å‡ºåœºæ¬¡ï¼š${basicInfo.performances || '0'}åœº</span>
                            </div>
                        `;
                        // æ›´æ–°ç‰¹è®­é¡µé¢çš„ç²‰ä¸ç»Ÿè®¡
                         const trainingFansStatEl = document.getElementById('training-fans-stat');
                         if(trainingFansStatEl) trainingFansStatEl.textContent = basicInfo.fans || '0';
                         // å¯ä»¥æ·»åŠ å›¢é˜Ÿäººæ°”çš„æ›´æ–°ï¼Œå¦‚æœ basicInfo ä¸­æœ‰çš„è¯
                         const trainingPopStatEl = document.getElementById('training-popularity-stat');
                          if(trainingPopStatEl) trainingPopStatEl.textContent = basicInfo.popularity || '0'; // å‡è®¾æœ‰ popularity å­—æ®µ
                    }

                    // æ›´æ–°æˆå‘˜ä¿¡æ¯ (ä½¿ç”¨ CharacterSystem çš„æ•°æ®æ›´å¯é )
                    const membersGrid = document.getElementById('teamMembers');
                    if (membersGrid) {
                         const teamMembersData = CharacterSystem.getTeamMembersData(); // ä» CharacterSystem è·å–æœ€æ–°æ•°æ®
                         console.log(`æ¸²æŸ“å›¢é˜Ÿæˆå‘˜åˆ—è¡¨ï¼Œå…± ${teamMembersData.length} äºº`);
                         if (teamMembersData.length > 0) {
                              membersGrid.innerHTML = teamMembersData.map(member => {
                                   const skills = member.stats || {}; // ç¡®ä¿ skills æ˜¯å¯¹è±¡
                                   const getSkillValue = (key) => skills[key] !== undefined && skills[key] !== null ? skills[key] : 0;
                                    // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– PLACEHOLDER_IMG
                                    const avatarSrc = (member.avatar && typeof member.avatar === 'string' && member.avatar.trim() !== '') ? member.avatar : PLACEHOLDER_IMG; // ä½¿ç”¨å¸¸é‡

                                   return `
                                   <div class="member-card horizontal" data-member-id="${member.id || member.name}" onclick="handleMemberCardClick('${member.id || member.name}')"> <!-- æ·»åŠ  onclick -->
                                       <div class="member-card-content">
                                           <div class="member-avatar-container">
                                               <img src="${avatarSrc}" alt="${member.name}" class="member-avatar-large" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;">
                                               <span class="member-role-badge">${member.role || 'æˆå‘˜'}</span>
                                           </div>
                                           <div class="member-details-container">
                                               <div class="member-header">
                                                   <h4 class="member-name">${member.name}</h4>
                                                   ${member.position ? `<p class="member-position">${member.position}</p>` : ''}
                                               </div>
                                               <div class="member-stats-horizontal">
                                                   <div class="stat-item-horizontal">
                                                       <span class="label"><i class="fas fa-microphone-alt"></i> å£°ä¹</span>
                                                       <div class="progress"><div class="progress-bar" style="width: ${getSkillValue('vocal')}%"></div></div>
                                                       <span class="value">${getSkillValue('vocal')}</span>
                                                   </div>
                                                   <div class="stat-item-horizontal">
                                                       <span class="label"><i class="fas fa-running"></i> èˆè¹ˆ</span>
                                                       <div class="progress"><div class="progress-bar" style="width: ${getSkillValue('dance')}%"></div></div>
                                                       <span class="value">${getSkillValue('dance')}</span>
                                                   </div>
                                                   <div class="stat-item-horizontal">
                                                        <span class="label"><i class="fas fa-theater-masks"></i> è¡¨æ¼”</span>
                                                        <div class="progress"><div class="progress-bar" style="width: ${getSkillValue('performance')}%"></div></div>
                                                        <span class="value">${getSkillValue('performance')}</span>
                                                    </div>
                                                    <div class="stat-item-horizontal">
                                                        <span class="label"><i class="fas fa-heart"></i> é­…åŠ›</span>
                                                        <div class="progress"><div class="progress-bar" style="width: ${getSkillValue('charm')}%"></div></div>
                                                        <span class="value">${getSkillValue('charm')}</span>
                                                    </div>
                                                    <div class="stat-item-horizontal">
                                                        <span class="label"><i class="fas fa-tv"></i> ç»¼è‰º</span>
                                                        <div class="progress"><div class="progress-bar" style="width: ${getSkillValue('variety')}%"></div></div>
                                                        <span class="value">${getSkillValue('variety')}</span>
                                                    </div>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                                   `;
                              }).join('');
                         } else {
                              membersGrid.innerHTML = '<p class="text-center text-muted p-3">å›¢é˜Ÿä¸­è¿˜æ²¡æœ‰æˆå‘˜ã€‚</p>';
                         }
                    }

                     // æ›´æ–°æˆå°±ä¿¡æ¯
                     const achievementsGrid = document.getElementById('team-achievements');
                     if (achievementsGrid) { // æ£€æŸ¥ teamData.achievements æ˜¯å¦ä¸ºæ•°ç»„
                          if (teamData.achievements && Array.isArray(teamData.achievements) && teamData.achievements.length > 0) {
                               achievementsGrid.innerHTML = teamData.achievements.map(achievement => {
                                    if (!achievement || !achievement.title) return ''; // è·³è¿‡æ— æ•ˆæˆå°±
                                    return `
                                    <div class="achievement-card">
                                        <div class="achievement-icon">
                                            <i class="fas ${achievement.icon || 'fa-trophy'}"></i>
                                        </div>
                                        <div class="achievement-info">
                                            <h4>${achievement.title}</h4>
                                            <p>${achievement.date || 'æœªçŸ¥æ—¥æœŸ'}</p>
                                            <p class="description">${achievement.description || ''}</p>
                                        </div>
                                    </div>
                                    `;
                               }).join('');
                          } else {
                               achievementsGrid.innerHTML = '<div class="empty-message text-center text-muted p-3">æš‚æ— å›¢é˜Ÿæˆå°±è®°å½•</div>';
                          }
                     }


                    // æ›´æ–°æ—¥ç¨‹ä¿¡æ¯
                    const scheduleTimeline = document.getElementById('team-schedule');
                     if (scheduleTimeline) { // æ£€æŸ¥ teamData.schedule æ˜¯å¦ä¸ºæ•°ç»„
                          if (teamData.schedule && Array.isArray(teamData.schedule) && teamData.schedule.length > 0) {
                               scheduleTimeline.style.position = 'relative'; // ç¡®ä¿æœ‰ç›¸å¯¹å®šä½
                               scheduleTimeline.innerHTML = teamData.schedule.map(item => {
                                    if (!item || !item.title) return ''; // è·³è¿‡æ— æ•ˆæ—¥ç¨‹
                                    return `
                                    <div class="timeline-item ${item.isPast ? 'past-event' : ''}">
                                        <div class="timeline-date">
                                            <span class="timeline-month">${item.month || '??'}</span>
                                            <span class="timeline-day">${item.day || '??'}</span>
                                        </div>
                                        <div class="timeline-content">
                                            <h5 class="timeline-title">${item.title}</h5>
                                            <div class="timeline-location"><i class="fas fa-map-marker-alt"></i> ${item.location || 'æœªçŸ¥åœ°ç‚¹'}</div>
                                            <p class="timeline-description">${item.description || ''}</p>
                                        </div>
                                    </div>
                                    `;
                               }).join('');
                          } else {
                               scheduleTimeline.innerHTML = '<div class="empty-message text-center text-muted p-3">æš‚æ— è¿‘æœŸè¡Œç¨‹å®‰æ’</div>';
                          }
                     }
                      console.log("å›¢é˜Ÿä¿¡æ¯ UI æ›´æ–°å®Œæˆã€‚");
                },

                 // æ›´æ–°è®¡åˆ’ä¿¡æ¯ (ç°åœ¨ç”± renderTaskList å¤„ç†ï¼Œè¿™ä¸ªå¯ä»¥ç®€åŒ–æˆ–ç§»é™¤)
                 updatePlanText(planData) {
                      if (!planData) {
                           console.warn("updatePlanText: æ”¶åˆ°æ— æ•ˆæ•°æ®");
                           return; // ç›´æ¥è¿”å›
                      }
                       console.log("updatePlanText: è°ƒç”¨ renderTaskList æ¸²æŸ“è®¡åˆ’...");
                       renderTaskList(); // è°ƒç”¨æ¸²æŸ“å‡½æ•°
                 },

                updateSongText(songData) {
                     if (!songData) {
                          console.warn("updateSongText: æ”¶åˆ°æ— æ•ˆæ•°æ®");
                          return; // ç›´æ¥è¿”å›
                     }
                      console.log("updateSongText: è°ƒç”¨ renderSongOptions å’Œ updateSongSummary...");
                     renderSongOptions(); // è°ƒç”¨æ¸²æŸ“å‡½æ•°
                     updateSongSummary(); // æ›´æ–°æ‘˜è¦
                }
            },

             // ã€åˆ é™¤ã€‘ä¸å†éœ€è¦ handleExternalDataï¼Œç›´æ¥ä½¿ç”¨ updateGameState
            // handleExternalData(data) { ... }

            init() {
                 // ã€åˆ é™¤ã€‘ç§»é™¤ DOM è§‚å¯Ÿå™¨é€»è¾‘
                // this.setupDOMObserver();

                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                this.bindEvents();
                // å‘é€å°±ç»ªäº‹ä»¶
                this.dispatchReadyEvent();
                 console.log("DataSystem åˆå§‹åŒ–å®Œæˆ (æ—  DOM è§‚å¯Ÿå™¨)ã€‚");
            },

            // ã€åˆ é™¤ã€‘ç§»é™¤ setupDOMObserver
            // setupDOMObserver() { ... }

            bindEvents() {
                // ç›‘å¬çª—å£å¤§å°å˜åŒ– (å¯é€‰ï¼Œå¦‚æœéœ€è¦å“åº”å¼è°ƒæ•´)
                // window.addEventListener('resize', () => {
                //     this.handleResize();
                // });
                 // ä¸éœ€è¦ç›‘å¬é¡µé¢åˆ‡æ¢äº†ï¼Œç”±å…¨å±€ switchPage å¤„ç†
            },

             // ã€åˆ é™¤ã€‘ç§»é™¤ handlePageChange
             // handlePageChange(page) { ... }

            // ã€åˆ é™¤ã€‘ç§»é™¤ handleResize å’Œ updateLayout (å¦‚æœä¸éœ€è¦å“åº”å¼)
            // handleResize() { ... }
            // updateLayout() { ... }

            dispatchReadyEvent() {
                const readyEvent = new CustomEvent('gameSystemReady');
                window.dispatchEvent(readyEvent);
                 console.log("gameSystemReady äº‹ä»¶å·²åˆ†å‘ã€‚");
            },
        };
/**
 * æ›´æ–°æŒ‡å®šè§’è‰²åœ¨ä¸–ç•Œä¹¦ "æ˜æ˜Ÿçš„è¯ç”Ÿ" ä¸­çš„æ¡ç›®å†…å®¹ã€‚
 * ä¼šæŸ¥æ‰¾å¤‡æ³¨ä¸º "æˆå‘˜[è§’è‰²å]çš„è¯¦ç»†ä¿¡æ¯" çš„æ¡ç›®ï¼Œ
 * å¹¶æ›´æ–°æˆ–æ·»åŠ  å£°ä¹ã€èˆè¹ˆã€è¡¨æ¼”ã€é­…åŠ›ã€ç»¼è‰ºæ„Ÿã€å½“å‰å¿ƒæƒ…ã€å½“ä¸‹å¥½æ„Ÿåº¦ çš„æ•°å€¼ã€‚
 * @param {string} characterName è¦æ›´æ–°çš„è§’è‰²åå­—
 * @param {object} characterData åŒ…å«æœ€æ–°è§’è‰²æ•°æ®çš„å¯¹è±¡ (åº”åŒ…å« stats, mood, affection)
 */
 async function updateCharacterLorebookEntry(characterName, characterData) {
    if (!characterName || !characterData) {
        console.warn("updateCharacterLorebookEntry: ç¼ºå°‘è§’è‰²åæˆ–è§’è‰²æ•°æ®ï¼Œè·³è¿‡æ›´æ–°ã€‚");
        return;
    }

    console.log(`å°è¯•æ›´æ–°è§’è‰² "${characterName}" çš„ä¸–ç•Œä¹¦æ¡ç›®...`);
    const worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
    // æ ‡å‡†åŒ–æ¡ç›®å¤‡æ³¨ï¼Œç§»é™¤ç©ºæ ¼å¹¶è½¬å°å†™ä»¥ä¾¿åŒ¹é…
    const targetCommentBase = `æˆå‘˜${characterName}çš„è¯¦ç»†ä¿¡æ¯`;
    const targetCommentNormalized = targetCommentBase.replace(/\s+/g, '').toLowerCase();

    try {
        // æ£€æŸ¥å¿…è¦çš„ API å‡½æ•°
        if (typeof getLorebookEntries !== 'function' || typeof setLorebookEntries !== 'function') {
            console.warn(`ä¸–ç•Œä¹¦ API å‡½æ•° (get/set) ä¸å¯ç”¨ï¼Œæ— æ³•æ›´æ–°è§’è‰² "${characterName}" çš„æ¡ç›®ã€‚`);
            return;
        }

        // è·å–æ‰€æœ‰æ¡ç›®
        const allEntries = await getLorebookEntries(worldBookName);
        if (!allEntries) {
            console.warn(`æ— æ³•è·å–ä¸–ç•Œä¹¦ "${worldBookName}" çš„æ¡ç›®åˆ—è¡¨ï¼Œæ— æ³•æ›´æ–°è§’è‰² "${characterName}"ã€‚`);
            return;
        }

        // æŸ¥æ‰¾å¯¹åº”çš„æ¡ç›®
        const entryToUpdate = allEntries.find(entry =>
            entry && entry.comment && entry.uid != null &&
            entry.comment.replace(/\s+/g, '').toLowerCase() === targetCommentNormalized
        );

        if (!entryToUpdate) {
            console.warn(`åœ¨ä¸–ç•Œä¹¦ "${worldBookName}" ä¸­æœªæ‰¾åˆ°è§’è‰² "${characterName}" çš„è¯¦ç»†ä¿¡æ¯æ¡ç›® (é¢„æœŸå¤‡æ³¨: "${targetCommentBase}")ã€‚`);
            return;
        }

        console.log(`æ‰¾åˆ°è§’è‰² "${characterName}" çš„æ¡ç›® (UID: ${entryToUpdate.uid})ï¼Œå‡†å¤‡æ›´æ–°å†…å®¹ã€‚`);

        let currentContent = entryToUpdate.content || "";
        let newContent = currentContent;
        let changed = false;

        // å®šä¹‰è¦æ›´æ–°çš„å­—æ®µåŠå…¶åœ¨ä¸–ç•Œä¹¦ä¸­çš„æ ‡ç­¾
        const fieldsToUpdate = {
            'å£°ä¹': characterData.stats?.vocal,
            'èˆè¹ˆ': characterData.stats?.dance,
            'è¡¨æ¼”': characterData.stats?.performance,
            'é­…åŠ›': characterData.stats?.charm,
            'ç»¼è‰ºæ„Ÿ': characterData.stats?.variety,
            'å½“å‰å¿ƒæƒ…': characterData.mood,
            'å½“ä¸‹å¥½æ„Ÿåº¦': characterData.affection
        };

        // éå†å­—æ®µè¿›è¡Œæ›´æ–°æˆ–æ·»åŠ 
        for (const [label, value] of Object.entries(fieldsToUpdate)) {
            if (value === undefined || value === null) {
                // console.log(`  - è§’è‰² "${characterName}" æ•°æ®ä¸­ç¼ºå°‘å­—æ®µ "${label}"ï¼Œè·³è¿‡æ­¤å­—æ®µæ›´æ–°ã€‚`);
                continue; // å¦‚æœæ–°æ•°æ®ä¸­æ²¡æœ‰è¿™ä¸ªå€¼ï¼Œåˆ™ä¸æ›´æ–°
            }

            const numericValue = parseInt(value); // ç¡®ä¿æ˜¯æ•°å­—
            if (isNaN(numericValue)) {
                console.warn(`  - è§’è‰² "${characterName}" çš„å­—æ®µ "${label}" å€¼ "${value}" ä¸æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œè·³è¿‡ã€‚`);
                continue;
            }

            // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œï¼šä»¥ "- " å¼€å¤´ï¼Œæ ‡ç­¾åï¼Œä¸­æ–‡æˆ–è‹±æ–‡å†’å·ï¼Œå¯é€‰ç©ºæ ¼ï¼Œæ•°å­—
            // \s* åŒ¹é…0æˆ–å¤šä¸ªç©ºæ ¼ï¼Œ[ï¼š:] åŒ¹é…ä¸­æ–‡æˆ–è‹±æ–‡å†’å·
            const regex = new RegExp(`^- ${label}\\s*[ï¼š:]\\s*\\d+`, 'm');
            const newLine = `- ${label}ï¼š ${numericValue}`; // æ³¨æ„ä½¿ç”¨ä¸­æ–‡å†’å·ä¿æŒä¸€è‡´

            if (regex.test(newContent)) {
                // å¦‚æœæ‰¾åˆ°åŒ¹é…è¡Œï¼Œæ›¿æ¢æ•´è¡Œ
                const oldLineMatch = newContent.match(regex);
                if (oldLineMatch && oldLineMatch[0] !== newLine) { // åªæœ‰åœ¨å€¼ä¸åŒæ—¶æ‰æ›¿æ¢
                    console.log(`  - æ›´æ–° "${characterName}" çš„ "${label}" ä» "${oldLineMatch[0]}" ä¸º "${newLine}"`);
                    newContent = newContent.replace(regex, newLine);
                    changed = true;
                }
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…è¡Œï¼Œåœ¨æœ«å°¾æ·»åŠ æ–°è¡Œ
                console.log(`  - ä¸º "${characterName}" æ·»åŠ æ–°å­—æ®µ "${label}": ${numericValue}`);
                // ç¡®ä¿æ·»åŠ å‰æœ‰æ¢è¡Œç¬¦ï¼ˆå¦‚æœå†…å®¹éç©ºï¼‰
                if (newContent.trim() !== '' && !newContent.endsWith('\n')) {
                   newContent += '\n';
                }
                newContent += newLine + '\n'; // æ·»åŠ æ–°è¡Œå¹¶åŠ ä¸€ä¸ªæ¢è¡Œç¬¦
                changed = true;
            }
        }

        // å¦‚æœå†…å®¹æœ‰å˜åŒ–ï¼Œåˆ™è°ƒç”¨ API æ›´æ–°
        if (changed) {
            console.log(`å†…å®¹å·²æ›´æ”¹ï¼Œè°ƒç”¨ setLorebookEntries æ›´æ–°è§’è‰² "${characterName}" (UID: ${entryToUpdate.uid})...`);
            // setLorebookEntries é€šå¸¸éœ€è¦ä¸€ä¸ªæ•°ç»„
            await setLorebookEntries(worldBookName, [{
                uid: entryToUpdate.uid,
                content: newContent.trim() // å»é™¤æœ«å°¾å¯èƒ½å¤šä½™çš„æ¢è¡Œç¬¦
                // å¯ä»¥é€‰æ‹©æ€§åœ°æ›´æ–°å…¶ä»–å­—æ®µï¼Œå¦‚ 'enabled', 'key' ç­‰ï¼Œå¦‚æœéœ€è¦çš„è¯
                // key: entryToUpdate.key,
                // enabled: entryToUpdate.enabled,
                // comment: entryToUpdate.comment // ä¿æŒå¤‡æ³¨ä¸å˜
            }]);
            console.log(`è§’è‰² "${characterName}" çš„ä¸–ç•Œä¹¦æ¡ç›®æ›´æ–°æˆåŠŸã€‚`);
        } else {
            console.log(`è§’è‰² "${characterName}" çš„ä¸–ç•Œä¹¦æ¡ç›®å†…å®¹æ— éœ€æ›´æ–°ã€‚`);
        }

    } catch (error) {
        console.error(`æ›´æ–°è§’è‰² "${characterName}" çš„ä¸–ç•Œä¹¦æ¡ç›®æ—¶å‡ºé”™:`, error);
    }
}
        // --- è§’è‰²ç®¡ç†ç³»ç»Ÿ ---
        const CharacterSystem = {
            characters: {}, // å­˜å‚¨è§’è‰²æ•°æ® { id: characterObject }

            init(membersData) {
                 if (!membersData || !Array.isArray(membersData)) {
                      console.warn("CharacterSystem.init: æ”¶åˆ°æ— æ•ˆçš„æˆå‘˜æ•°æ®ï¼Œåº”ä¸ºæ•°ç»„ã€‚");
                      this.characters = {}; // æ¸…ç©ºæˆ–ä¿æŒæ—§æ•°æ®ï¼Ÿæ¸…ç©ºæ›´å®‰å…¨
                      return;
                 }
                 console.log(`CharacterSystem.init: åˆå§‹åŒ–/æ›´æ–° ${membersData.length} ä¸ªæˆå‘˜...`);
                  // ä¿ç•™æœ¬åœ°å­˜å‚¨çš„å¤´åƒä¿¡æ¯
                  const currentAvatars = {};
                  Object.values(this.characters).forEach(char => {
                      if (char.avatar && char.avatar.startsWith('data:image')) {
                          currentAvatars[char.id] = char.avatar;
                      }
                  });

                  this.characters = membersData.reduce((acc, char) => {
                     if (char && char.id != null) { // ç¡®ä¿æœ‰ ID
                          // åˆå¹¶çŠ¶æ€ï¼šä¼˜å…ˆæœ¬åœ°å­˜å‚¨ï¼Œå…¶æ¬¡æ˜¯ä¼ å…¥æ•°æ®ï¼Œæœ€åæ˜¯é»˜è®¤
                           const existingAvatar = currentAvatars[char.id]; // æœ¬åœ°å­˜å‚¨ (Base64)
                           let finalAvatar = PLACEHOLDER_IMG; // é»˜è®¤å€¼

                           if (existingAvatar) {
                                finalAvatar = existingAvatar; // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„å¤´åƒ
                           } else if (char.avatar && typeof char.avatar === 'string' && char.avatar.trim() !== '') {
                                finalAvatar = char.avatar; // å…¶æ¬¡ä½¿ç”¨ä¼ å…¥æ•°æ®ä¸­çš„æœ‰æ•ˆå¤´åƒ
                           }
                           // å¦‚æœç»å†äº†ä»¥ä¸Šæ­¥éª¤ finalAvatar ä»ç„¶æ— æ•ˆ (å¦‚ä¼ å…¥çš„ avatar æ˜¯ null æˆ–ç©º)ï¼Œåˆ™ä¼šä¿æŒ PLACEHOLDER_IMG

                           acc[char.id] = {
                               ...char, // åŸºç¡€æ˜¯æ–°æ•°æ®
                               avatar: finalAvatar // ç¡®ä¿ avatar æ€»æœ‰ä¸€ä¸ªæœ‰æ•ˆå€¼
                           };
                     } else {
                         console.warn("CharacterSystem.init: å‘ç°æ— æ•ˆæˆ–ç¼ºå°‘ ID çš„æˆå‘˜æ•°æ®:", char);
                     }
                     return acc;
                 }, {});
                 console.log("CharacterSystem åˆå§‹åŒ–/æ›´æ–°å®Œæˆ:", Object.keys(this.characters).length, "ä¸ªæœ‰æ•ˆæˆå‘˜");
            },

            getCharacter(id) {
                return this.characters[id];
            },

            getCharacterByName(name) { // æ–°å¢ï¼šæŒ‰åç§°æŸ¥æ‰¾
                return Object.values(this.characters).find(char => char.name === name);
            },

            getAllMembers() {
                return Object.values(this.characters);
            },

            getContactsData() {
                console.log("getContactsData: å¼€å§‹æ„å»ºè”ç³»äººæ•°æ®...");
                return Object.values(this.characters).map(char => {
                    if (!char || !char.id || !char.name) {
                         console.warn("getContactsData: å‘ç°æ— æ•ˆè§’è‰²æ•°æ®ï¼Œè·³è¿‡:", char);
                         return null; // è¿”å› nullï¼Œç¨åè¿‡æ»¤
                    }
                    // ä» localStorage åŠ è½½è¯¥è”ç³»äººçš„èŠå¤©è®°å½•
                    const savedMessages = loadChatHistory(char.name);
                    // ç¡®ä¿ messages æ˜¯æ•°ç»„
                    const messages = Array.isArray(savedMessages) ? savedMessages : (Array.isArray(char.messages) ? char.messages : []);

                    let lastMessage = '';
                    let lastTime = '';
                    if (messages.length > 0) {
                         // æŸ¥æ‰¾æœ€åä¸€æ¡éç³»ç»Ÿ/æ—¥æœŸæ¶ˆæ¯
                         for (let i = messages.length - 1; i >= 0; i--) {
                              const lastMsg = messages[i];
                              if (lastMsg && lastMsg.content && lastMsg.type !== 'system' && lastMsg.type !== 'date') {
                                   lastMessage = lastMsg.type === 'sent' ? `ä½ : ${lastMsg.content}` : lastMsg.content;
                                   lastTime = lastMsg.time || formatMessageTime(); // ç¡®ä¿æœ‰æ—¶é—´æˆ³
                                   break; // æ‰¾åˆ°åé€€å‡ºå¾ªç¯
                              }
                         }
                    }

                    // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– placeholder
                    const avatarSrc = (char.avatar && typeof char.avatar === 'string' && char.avatar.length > 5) ? char.avatar : 'placeholder.png';

                    // è¿”å›å®Œæ•´çš„è”ç³»äººæ•°æ®ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
                    return {
                        id: char.id,
                        name: char.name,
                        avatar: avatarSrc, // ä½¿ç”¨å¤„ç†è¿‡çš„å¤´åƒ
                        status: char.status || 'offline', // é»˜è®¤ offline
                        statusClass: char.status === 'online' ? 'online' : (char.status === 'busy' ? 'busy' : (char.status === 'away' ? 'away' : 'offline')),
                        lastMessage: lastMessage,
                        lastTime: lastTime,
                        unread: char.unread || 0,
                        messages: messages, // ä½¿ç”¨åˆå¹¶/åŠ è½½åçš„æ¶ˆæ¯
                        // ä¿ç•™å…¶ä»–å¯èƒ½éœ€è¦çš„å±æ€§
                        stats: char.stats || {},
                        tags: Array.isArray(char.tags) ? char.tags : [],
                        bio: char.bio || '',
                        role: char.role || 'æˆå‘˜',
                        mood: char.mood !== undefined ? char.mood : 50, // é»˜è®¤å€¼
                        affection: char.affection !== undefined ? char.affection : 0, // é»˜è®¤å€¼
                        fullName: char.fullName || char.name,
                        interests: char.interests || '',
                        relationships: char.relationships || '',
                        recentStatus: char.recentStatus || '',
                         isGroup: char.isGroup || false // æ˜¯å¦ä¸ºç¾¤ç»„
                    };
                }).filter(Boolean); // è¿‡æ»¤æ‰ null å€¼
                 console.log("getContactsData: è”ç³»äººæ•°æ®æ„å»ºå®Œæˆã€‚");
            },


            getTeamMembersData() {
                 return Object.values(this.characters).map(char => {
                     if (!char || !char.id || !char.name) return null; // è·³è¿‡æ— æ•ˆæ•°æ®
                      // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– placeholder
                     const avatarSrc = (char.avatar && typeof char.avatar === 'string' && char.avatar.length > 5) ? char.avatar : 'placeholder.png';
                     const stats = char.stats || {}; // ç¡®ä¿ stats æ˜¯å¯¹è±¡

                      return {
                          id: char.id,
                          name: char.name,
                          avatar: avatarSrc,
                          role: char.role || 'æˆå‘˜',
                          position: char.position || '', // æ·»åŠ  position
                          stats: { // ç¡®ä¿æ‰€æœ‰æŠ€èƒ½å€¼å­˜åœ¨ï¼Œé»˜è®¤ä¸º 0
                              vocal: stats.vocal !== undefined ? stats.vocal : 0,
                              dance: stats.dance !== undefined ? stats.dance : 0,
                              performance: stats.performance !== undefined ? stats.performance : 0,
                              charm: stats.charm !== undefined ? stats.charm : 0,
                              variety: stats.variety !== undefined ? stats.variety : 0
                          }
                      };
                 }).filter(Boolean); // è¿‡æ»¤æ— æ•ˆæ•°æ®
            },

             getSongMembersData() {
                 return Object.values(this.characters).map(char => {
                      if (!char || !char.id || !char.name) return null; // è·³è¿‡æ— æ•ˆæ•°æ®
                       // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– placeholder
                     const avatarSrc = (char.avatar && typeof char.avatar === 'string' && char.avatar.length > 5) ? char.avatar : 'placeholder.png';
                      const vocalSkill = (char.stats && char.stats.vocal !== undefined) ? char.stats.vocal : 0; // è·å–å£°ä¹æŠ€èƒ½ï¼Œé»˜è®¤ä¸º 0

                      return {
                          id: char.id, // æ·»åŠ  ID
                          name: char.name,
                          avatar: avatarSrc,
                          skill: vocalSkill
                      };
                 }).filter(Boolean);
            }
        };


        // --- State ---
        let currentContact = "";
        let currentFilter = 'all';

        // --- Utility Functions ---
        function formatCurrency(amount) {
             // ç¡®ä¿ amount æ˜¯æ•°å­—
             const num = Number(amount);
             if (isNaN(num)) {
                  return '???'; // æˆ–è€…è¿”å›å…¶ä»–é”™è¯¯æç¤º
             }
            return `${num.toLocaleString('zh-CN')}`;
        }

        function formatMessageTime(date = new Date()) {
            // ç¡®ä¿ date æ˜¯ Date å¯¹è±¡
             if (!(date instanceof Date) || isNaN(date.getTime())) {
                  date = new Date(); // å¦‚æœæ— æ•ˆï¼Œä½¿ç”¨å½“å‰æ—¶é—´
             }
             try {
                  return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
             } catch (e) {
                  console.error("formatMessageTime é”™è¯¯:", e, "è¾“å…¥:", date);
                  return "??:??";
             }
        }
        function formatNumber(num) {
             const number = Number(num);
             if (isNaN(number)) return '0'; // å¤„ç†æ— æ•ˆæ•°å­—
             if (number >= 1000000) return (number / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
             if (number >= 1000) return (number / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
             return number.toString();
        }

        // --- Local Storage Functions ---
        function saveChatHistory(contactName, messages) {
            if (!contactName || !Array.isArray(messages)) return;
            try {
                const MAX_CHAT_HISTORY = 50; // ä¿å­˜æœ€è¿‘ 50 æ¡
                const messagesToSave = messages.slice(-MAX_CHAT_HISTORY);
                const storageKey = `chatHistory_${contactName}`;
                localStorage.setItem(storageKey, JSON.stringify(messagesToSave));
            } catch (error) {
                console.error(`ä¿å­˜ ${contactName} èŠå¤©è®°å½•å¤±è´¥:`, error);
                if (error.name === 'QuotaExceededError') {
                     console.warn("LocalStorage å·²æ»¡ï¼Œå°è¯•æ¸…ç†æ—§èŠå¤©è®°å½•...");
                     cleanupOldChatHistories(); // å°è¯•æ¸…ç†
                     // å¯ä»¥é€‰æ‹©å†æ¬¡å°è¯•ä¿å­˜ï¼Œæˆ–æç¤ºç”¨æˆ·
                }
            }
        }

        function loadChatHistory(contactName) {
            if (!contactName) return null;
            try {
                const storageKey = `chatHistory_${contactName}`;
                const savedMessages = localStorage.getItem(storageKey);
                return savedMessages ? JSON.parse(savedMessages) : null;
            } catch (error) {
                console.error(`åŠ è½½ ${contactName} èŠå¤©è®°å½•å¤±è´¥:`, error);
                // å¦‚æœè§£æå¤±è´¥ï¼Œå¯èƒ½æ•°æ®å·²æŸåï¼Œè€ƒè™‘åˆ é™¤
                // localStorage.removeItem(`chatHistory_${contactName}`);
                return null;
            }
        }

        function cleanupOldChatHistories() {
             console.log("å°è¯•æ¸…ç†æ—§çš„èŠå¤©è®°å½•...");
             let removedCount = 0;
             try {
                 const keysToRemove = [];
                 for (let i = 0; i < localStorage.length; i++) {
                     const key = localStorage.key(i);
                     if (key && key.startsWith('chatHistory_')) {
                         // å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æˆ–ç®€å•åœ°éšæœºåˆ é™¤ä¸€éƒ¨åˆ†
                         // è¿™é‡Œç®€å•åœ°åˆ é™¤å‰å‡ ä¸ªæ‰¾åˆ°çš„
                         keysToRemove.push(key);
                         if (keysToRemove.length >= 5) break; // ä¾‹å¦‚ï¼Œä¸€æ¬¡æœ€å¤šåˆ é™¤ 5 ä¸ªæ—§è®°å½•
                     }
                 }
                 keysToRemove.forEach(key => {
                     localStorage.removeItem(key);
                     removedCount++;
                     console.log(`å·²ç§»é™¤æ—§èŠå¤©è®°å½•: ${key}`);
                 });
             } catch (error) {
                 console.error("æ¸…ç†èŠå¤©è®°å½•æ—¶å‡ºé”™:", error);
             }
             return removedCount;
        }

        function storeImageLocally(identifier, dataUrl) {
             if (!identifier || !dataUrl || !dataUrl.startsWith('data:image')) return;
            try {
                const key = `stored_image_${identifier}`;
                localStorage.setItem(key, dataUrl);
                // æ›´æ–°å›¾ç‰‡ç´¢å¼•
                let imageIndex = JSON.parse(localStorage.getItem('image_index') || '[]');
                if (!imageIndex.includes(key)) {
                    imageIndex.push(key);
                    // é™åˆ¶ç´¢å¼•å¤§å°ï¼Œé˜²æ­¢æ— é™å¢é•¿
                     const MAX_INDEX_SIZE = 50; // ä¾‹å¦‚ï¼Œæœ€å¤šè®°å½• 50 ä¸ªå¤´åƒ
                     if (imageIndex.length > MAX_INDEX_SIZE) {
                          const keysToRemove = imageIndex.splice(0, imageIndex.length - MAX_INDEX_SIZE);
                          // ç†è®ºä¸Šä¹Ÿåº”è¯¥åˆ é™¤å¯¹åº”çš„ localStorage æ¡ç›®ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªç»´æŠ¤ç´¢å¼•
                          console.warn(`å›¾ç‰‡ç´¢å¼•è¶…è¿‡ ${MAX_INDEX_SIZE}ï¼Œå·²ç§»é™¤æ—§ç´¢å¼•:`, keysToRemove);
                     }
                    localStorage.setItem('image_index', JSON.stringify(imageIndex));
                }
            } catch (error) {
                console.error('ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨æ—¶å‡ºé”™:', error);
                if (error.name === 'QuotaExceededError') {
                    console.warn("LocalStorage å·²æ»¡ï¼Œå°è¯•æ¸…ç†æ—§å›¾ç‰‡...");
                    cleanupOldImages();
                    // å¯ä»¥å†æ¬¡å°è¯•ä¿å­˜ï¼Œä½†å¯èƒ½å†æ¬¡å¤±è´¥
                }
            }
        }

        function loadImageFromLocalStorage(identifier) {
            if (!identifier) return null;
            const key = `stored_image_${identifier}`;
            return localStorage.getItem(key);
        }

        function cleanupOldImages() {
             console.log("å°è¯•æ¸…ç†æ—§çš„å›¾ç‰‡æ•°æ®...");
             let removedCount = 0;
            try {
                const imageIndex = JSON.parse(localStorage.getItem('image_index') || '[]');
                const KEYS_TO_KEEP = 20; // ä¿ç•™æœ€è¿‘ 20 å¼ 
                if (imageIndex.length > KEYS_TO_KEEP) {
                    const keysToRemove = imageIndex.slice(0, imageIndex.length - KEYS_TO_KEEP);
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                        removedCount++;
                        console.log(`å·²ç§»é™¤æ—§å›¾ç‰‡: ${key}`);
                    });
                    const newIndex = imageIndex.slice(imageIndex.length - KEYS_TO_KEEP);
                    localStorage.setItem('image_index', JSON.stringify(newIndex));
                }
            } catch (error) {
                console.error('æ¸…ç†æ—§å›¾ç‰‡æ—¶å‡ºé”™:', error);
            }
             return removedCount;
        }

        function loadStoredImages() {
            let avatarsLoaded = false;
            try {
                 const characters = CharacterSystem.getAllMembers();
                 if (!characters || characters.length === 0) return false;

                 characters.forEach(character => {
                      if (!character || character.id == null) return; // è·³è¿‡æ— æ•ˆè§’è‰²
                      const storedImage = loadImageFromLocalStorage(character.id);
                      if (storedImage) {
                           character.avatar = storedImage; // ç›´æ¥æ›´æ–° CharacterSystem ä¸­çš„å¯¹è±¡
                           avatarsLoaded = true;
                      }
                 });
                  if (avatarsLoaded) console.log("éƒ¨åˆ†æˆ–å…¨éƒ¨å¤´åƒå·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½ã€‚");
            } catch (error) {
                 console.error("åŠ è½½æœ¬åœ°å­˜å‚¨å¤´åƒæ—¶å‡ºé”™:", error);
            }
            return avatarsLoaded;
        }

        // --- LLM Interaction & State Update ---
        async function loadGameDataFromChat() {
             // é˜²æ­¢é‡å¤åŠ è½½
             if (window.gameDataLoading) {
                 console.log('æ¸¸æˆæ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤åŠ è½½è¯·æ±‚');
                 return;
             }
              if (window.gameDataLoaded && gameState && gameState.story && gameState.story.date) { // æ›´å¯é çš„æ£€æŸ¥
                  console.log('æ¸¸æˆæ•°æ®ä¼¼ä¹å·²åŠ è½½ï¼Œè·³è¿‡é‡å¤åŠ è½½è¿‡ç¨‹');
                  return;
              }

             window.gameDataLoading = true;
             showLoadingIndicator("åŠ è½½æ¸¸æˆæ•°æ®..."); // æ˜¾ç¤ºåŠ è½½æç¤º

             try {
                 // æ£€æŸ¥å¿…è¦çš„ API å‡½æ•°
                 if (typeof getChatMessages !== 'function' || typeof setChatMessage !== 'function') {
                     console.warn('é…’é¦† API å‡½æ•° (getChatMessages/setChatMessage) ä¸å­˜åœ¨ï¼Œå°è¯•å¤‡ç”¨åŠ è½½...');
                      // ä½¿ç”¨å¤‡ç”¨æ•°æ® (å¦‚æœæä¾›)
                     if (window.externalData) {
                          updateGameState(window.externalData);
                          window.gameDataLoaded = true; // æ ‡è®°åŠ è½½å®Œæˆ
                          console.log('å·²ä»é¢„è®¾ externalData åŠ è½½æ¸¸æˆçŠ¶æ€');
                     } else {
                          console.error("é…’é¦† API å’Œ externalData å‡ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½åˆå§‹æ•°æ®ã€‚");
                          alert("æ— æ³•åŠ è½½æ¸¸æˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚å¯èƒ½éœ€è¦åˆ·æ–°æˆ–æ£€æŸ¥å‰ç«¯åŠ©æ‰‹ã€‚");
                     }
                     return; // æ— è®ºå¤‡ç”¨æ˜¯å¦æˆåŠŸï¼Œéƒ½ç»“æŸ
                 }

                 // è·å–æ¥¼å±‚ 0 æ¶ˆæ¯
                 const messages = await getChatMessages(0);
                 if (!messages || messages.length === 0 || !messages[0].message) {
                     console.error('æ— æ³•è·å–æ¥¼å±‚ 0 æ•°æ®æˆ–æ¶ˆæ¯ä¸ºç©º');
                     if (window.externalData) {
                          console.warn('å°è¯•ä½¿ç”¨ externalData ä½œä¸ºåå¤‡ã€‚');
                          updateGameState(window.externalData);
                          window.gameDataLoaded = true;
                     } else {
                          alert("æ— æ³•åŠ è½½å­˜æ¡£æ•°æ®ã€‚è¯·ç¡®ä¿æ¥¼å±‚ 0 æœ‰å†…å®¹æˆ–æä¾› externalDataã€‚");
                     }
                     return;
                 }

                 const message = messages[0].message;
                 const gameTextMatch = message.match(/<gametext>([\s\S]*?)<\/gametext>/i);

                 if (!gameTextMatch || gameTextMatch.length < 2) {
                      console.warn('æ¥¼å±‚ 0 æœªæ‰¾åˆ° <gametext> æ ‡ç­¾ã€‚å†…å®¹:', message);
                      if (window.externalData) {
                           console.warn('å°è¯•ä½¿ç”¨ externalData ä½œä¸ºåå¤‡ã€‚');
                           updateGameState(window.externalData);
                           window.gameDataLoaded = true;
                      } else {
                           alert("å­˜æ¡£æ ¼å¼é”™è¯¯ï¼šæœªæ‰¾åˆ° <gametext> æ ‡ç­¾ã€‚");
                      }
                 } else {
                      try {
                           const gameDataJSON = gameTextMatch[1].trim();
                           // æ¸…ç†æ½œåœ¨çš„ Markdown ä»£ç å—æ ‡è®°
                           let cleanedJsonString = gameDataJSON.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                           cleanedJsonString = cleanedJsonString.trim();

                           // åŸºæœ¬çš„ JSON æ ¼å¼æ£€æŸ¥
                            if (!cleanedJsonString.startsWith('{') || !cleanedJsonString.endsWith('}')) {
                                throw new Error("æå–çš„ gametext å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON å¯¹è±¡æ ¼å¼ã€‚");
                            }

                           const gameData = JSON.parse(cleanedJsonString);
                           console.log("æˆåŠŸè§£ææ¥¼å±‚ 0 æ•°æ®ï¼Œå‡†å¤‡æ›´æ–°æ¸¸æˆçŠ¶æ€...");
                           updateGameState(gameData); // æ›´æ–°çŠ¶æ€
                           console.log('æ¸¸æˆæ•°æ®åŠ è½½æˆåŠŸ (æ¥è‡ª loadGameDataFromChat)');
                           window.gameDataLoaded = true; // æ ‡è®°åŠ è½½å®Œæˆ
                      } catch (e) {
                           console.error('è§£ææ¥¼å±‚ 0 æ¸¸æˆæ•°æ®å¤±è´¥:', e);
                           console.error('å°è¯•è§£æçš„æ–‡æœ¬:', gameTextMatch[1].trim());
                           if (window.externalData) {
                                console.warn('è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ externalData ä½œä¸ºåå¤‡ã€‚');
                                updateGameState(window.externalData);
                                window.gameDataLoaded = true;
                           } else {
                                alert(`è§£æå­˜æ¡£æ•°æ®å¤±è´¥: ${e.message}\nè¯·æ£€æŸ¥æ¥¼å±‚ 0 çš„ <gametext> å†…å®¹æˆ–æä¾› externalDataã€‚`);
                           }
                      }
                 }
             } catch (error) {
                 console.error('åŠ è½½æ¸¸æˆæ•°æ®æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯:', error);
                 if (window.externalData) {
                      console.warn('é¡¶å±‚é”™è¯¯ï¼Œå°è¯•ä½¿ç”¨ externalData ä½œä¸ºåå¤‡ã€‚');
                     updateGameState(window.externalData);
                     window.gameDataLoaded = true;
                 } else {
                     alert(`åŠ è½½æ¸¸æˆæ•°æ®æ—¶å‡ºé”™: ${error.message}`);
                 }
             } finally {
                 window.gameDataLoading = false;
                 hideLoadingIndicator(); // éšè—åŠ è½½æç¤º
                 console.log("loadGameDataFromChat: åŠ è½½æµç¨‹ç»“æŸã€‚");
             }
        }

        async function deleteGameRecords() {
            const confirmation1 = confirm("ã€è­¦å‘Šã€‘è¿™å°†åˆ é™¤ä¸–ç•Œä¹¦ã€Œæ˜æ˜Ÿçš„è¯ç”Ÿã€ä¸­å‡ ä¹æ‰€æœ‰æ¸¸æˆæ•°æ®ï¼\n\nè¿™åŒ…æ‹¬ï¼š\n- æ‰€æœ‰ç« èŠ‚å›é¡¾\n- æ‰€æœ‰è§’è‰²è¯¦ç»†ä¿¡æ¯æ¡ç›®\n- æ‰€æœ‰æ¸¸æˆå­˜æ¡£\n\næ­¤æ“ä½œä¸å¯é€†ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ");

            if (!confirmation1) {
                console.log("åˆ é™¤è®°å½•æ“ä½œå·²å–æ¶ˆ (ç¬¬ä¸€æ¬¡ç¡®è®¤)ã€‚");
                return;
            }

            const confirmation2 = confirm("ã€æœ€ç»ˆç¡®è®¤ã€‘çœŸçš„è¦åˆ é™¤ã€Œæ˜æ˜Ÿçš„è¯ç”Ÿã€ä¸–ç•Œä¹¦å†…é™¤ç³»ç»Ÿä¿ç•™æ¡ç›®å¤–çš„æ•°æ®å—ï¼Ÿ\n\nè¯·å†æ¬¡ç¡®è®¤ï¼Œè¿™å°†æ¸…ç©ºä½ çš„æ¸¸æˆè¿›åº¦ï¼");

            if (!confirmation2) {
                console.log("åˆ é™¤è®°å½•æ“ä½œå·²å–æ¶ˆ (ç¬¬äºŒæ¬¡ç¡®è®¤)ã€‚");
                return;
            }

            console.log("å¼€å§‹åˆ é™¤æ¸¸æˆè®°å½•...");
            showLoadingIndicator("æ­£åœ¨åˆ é™¤è®°å½•...");
            disableInteractions(); // ç¦ç”¨äº¤äº’é˜²æ­¢æ„å¤–æ“ä½œ

            const worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
            const uidsToKeep = [0, 1, 2]; // æŒ‡å®šè¦ä¿ç•™çš„ UID

            try {
                // æ£€æŸ¥ API
                if (typeof getLorebookEntries !== 'function' || typeof deleteLorebookEntry !== 'function') {
                    throw new Error("ä¸–ç•Œä¹¦ API å‡½æ•° (getLorebookEntries æˆ– deleteLorebookEntry) ä¸å¯ç”¨ã€‚");
                }

                // è·å–æ‰€æœ‰æ¡ç›®
                const allEntries = await getLorebookEntries(worldBookName);
                if (!allEntries) {
                    // å¦‚æœè·å–å¤±è´¥ï¼Œä¹Ÿå¯èƒ½æ„å‘³ç€ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œå¯ä»¥è®¤ä¸ºæ²¡æœ‰éœ€è¦åˆ é™¤çš„
                    console.warn(`æ— æ³•è·å–ä¸–ç•Œä¹¦ "${worldBookName}" çš„æ¡ç›®ï¼Œå¯èƒ½æ— éœ€åˆ é™¤ã€‚`);
                    // ã€ä¿®æ”¹ã€‘åœ¨ finally ä¹‹å‰ return æ—¶ï¼Œéœ€è¦ç¡®ä¿ UI æ¢å¤
                    hideLoadingIndicator();
                    enableInteractions();
                    alert("æ— æ³•è·å–ä¸–ç•Œä¹¦ä¿¡æ¯ï¼Œåˆ é™¤æ“ä½œæœªæ‰§è¡Œã€‚");
                    return; // ç›´æ¥é€€å‡º
                }

                // ç­›é€‰å‡ºéœ€è¦åˆ é™¤çš„æ¡ç›®
                const entriesToDelete = allEntries.filter(entry => entry && entry.uid != null && !uidsToKeep.includes(entry.uid));

                if (entriesToDelete.length === 0) {
                    console.log("æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ¡ç›®ã€‚");
                    // ã€ä¿®æ”¹ã€‘åœ¨ finally ä¹‹å‰ return æ—¶ï¼Œéœ€è¦ç¡®ä¿ UI æ¢å¤
                    hideLoadingIndicator();
                    enableInteractions();
                    alert("æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆ é™¤çš„æ¸¸æˆè®°å½•ã€‚");
                    return; // æå‰é€€å‡º
                }

                console.log(`å‡†å¤‡åˆ é™¤ ${entriesToDelete.length} ä¸ªæ¡ç›®...`);

                // é€ä¸ªåˆ é™¤æ¡ç›® (æ³¨æ„: é¢‘ç¹è°ƒç”¨ API å¯èƒ½è¾ƒæ…¢)
                let deletedCount = 0;
                let failedCount = 0;
                for (const entry of entriesToDelete) {
                    try {
                        const success = await deleteLorebookEntry(worldBookName, entry.uid);
                        if (success) {
                            deletedCount++;
                            console.log(`  - å·²åˆ é™¤æ¡ç›® UID: ${entry.uid}, Comment: "${entry.comment}"`);
                        } else {
                            failedCount++;
                            console.warn(`  - åˆ é™¤æ¡ç›® UID: ${entry.uid} å¤±è´¥ã€‚`);
                        }
                        // await new Promise(resolve => setTimeout(resolve, 50)); // å¯é€‰å»¶è¿Ÿ
                    } catch (deleteError) {
                        failedCount++;
                        console.error(`  - åˆ é™¤æ¡ç›® UID: ${entry.uid} æ—¶å‘ç”Ÿé”™è¯¯:`, deleteError);
                    }
                }

                console.log(`åˆ é™¤æ“ä½œå®Œæˆã€‚æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªæ¡ç›®ï¼Œå¤±è´¥ ${failedCount} ä¸ªã€‚`);
                alert(`æ¸¸æˆè®°å½•åˆ é™¤å®Œæˆï¼\næˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªæ¡ç›®ã€‚\n${failedCount > 0 ? `æœ‰ ${failedCount} ä¸ªæ¡ç›®åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚` : ''}`);

                // å¯é€‰ï¼šåˆ é™¤åæç¤ºç”¨æˆ·
                alert("è®°å½•å·²åˆ é™¤ã€‚å»ºè®®åˆ·æ–°é¡µé¢æˆ–é‡æ–°åŠ è½½èŠå¤©ä»¥ç¡®ä¿æ›´æ”¹ç”Ÿæ•ˆã€‚");

            } catch (error) {
                console.error("åˆ é™¤æ¸¸æˆè®°å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", error);
                alert(`åˆ é™¤æ¸¸æˆè®°å½•æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            } finally {
                hideLoadingIndicator();
                enableInteractions(); // é‡æ–°å¯ç”¨äº¤äº’
                 console.log("deleteGameRecords finally block executed."); // æ·»åŠ æ—¥å¿—ç¡®è®¤æ‰§è¡Œ
            }
            // ã€ä¿®å¤ã€‘ç§»é™¤äº†è¿™é‡Œå¤šä½™çš„å³èŠ±æ‹¬å·
        }
        function updateCharacterAvatar(characterId, avatarDataUrl) {
    console.log(`å°è¯•ä¸º ID: ${characterId} æ›´æ–°å¤´åƒ`);
    // 1. æ›´æ–° CharacterSystem ä¸­çš„æ•°æ®
    const character = CharacterSystem.getCharacter(characterId); // å‡è®¾ CharacterSystem æœ‰æ­¤æ–¹æ³•
    if (character) {
        character.avatar = avatarDataUrl; // æ›´æ–°å†…å­˜ä¸­çš„å¤´åƒæ•°æ®
        console.log(`è§’è‰² ${character.name} çš„å¤´åƒæ•°æ®å·²åœ¨å†…å­˜ä¸­æ›´æ–°ã€‚`);

        // 2. ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        storeImageLocally(characterId, avatarDataUrl); // è°ƒç”¨ä¿å­˜å‡½æ•°

        // 3. å¯é€‰ï¼šæ ‡è®°æ¸¸æˆçŠ¶æ€å·²æ”¹å˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä¿å­˜
        window.gameStateChanged = true;

        // 4. å¯é€‰ï¼šå¦‚æœå…¶ä»–åœ°æ–¹ï¼ˆå¦‚è”ç³»äººåˆ—è¡¨ã€å›¢é˜Ÿé¡µé¢ï¼‰ä¹Ÿæ˜¾ç¤ºå¤´åƒï¼Œå¯èƒ½éœ€è¦è§¦å‘å®ƒä»¬çš„æ›´æ–°
        DataSystem.UIUpdater.updateContactText(); // ä¾‹å¦‚ï¼šæ›´æ–°è”ç³»äººåˆ—è¡¨
        // renderTeamPage(); // å¦‚æœå›¢é˜Ÿé¡µé¢æ˜¾ç¤ºå¤´åƒä¸”å½“å‰æ˜¯æ´»åŠ¨é¡µé¢

    } else {
        console.error(`updateCharacterAvatar: æœªæ‰¾åˆ° ID ä¸º ${characterId} çš„è§’è‰²ã€‚`);
        alert("æ›´æ–°å¤´åƒå¤±è´¥ï¼šæ‰¾ä¸åˆ°å¯¹åº”çš„è§’è‰²æ•°æ®ã€‚");
    }
}
        async function updateGameState(data) { // ã€ä¿®æ”¹ã€‘æ·»åŠ  async å…³é”®å­—
            console.log('%c--- updateGameState START ---', 'color: blue; font-weight: bold;');
            console.time("updateGameStateDuration");

            if (!data || typeof data !== 'object') { // å¢åŠ ç±»å‹æ£€æŸ¥
                console.warn("updateGameState æ¥æ”¶åˆ°çš„æ•°æ®æ— æ•ˆ (éå¯¹è±¡æˆ– null)ï¼Œé€€å‡ºã€‚");
                console.timeEnd("updateGameStateDuration");
                console.log('%c--- updateGameState END (æ— æ•ˆæ•°æ®) ---', 'color: blue; font-weight: bold;');
                return;
            }
             console.log('æ”¶åˆ°ç”¨äºæ›´æ–°çš„æ•°æ®ç»“æ„é¢„è§ˆ:', Object.keys(data)); // æ‰“å°é¡¶å±‚é”®

             // --- çŠ¶æ€æ›´æ–° ---
            // 1. æ›´æ–°éè§’è‰²éƒ¨åˆ†
            console.time("updateNonCharacterState");
             // ä½¿ç”¨ structuredClone ç¡®ä¿æ·±æ‹·è´å’Œéš”ç¦»ï¼Œé¿å…å¼•ç”¨é—®é¢˜
             // åˆå¹¶æ—¶ä»¥ initialGameState ä¸ºåŸºç¡€ï¼Œç”¨ data è¦†ç›–ï¼Œç¡®ä¿åŸºç¡€ç»“æ„å­˜åœ¨
             gameState.story = { ...initialGameState.story, ...(data.story || {}) };
             gameState.team = {
                 // åˆå¹¶ basicInfoï¼Œç¡®ä¿åŸºç¡€ç»“æ„
                 basicInfo: { ...initialGameState.team.basicInfo, ...(data.team?.basicInfo || {}) },
                 // åˆå¹¶ members, achievements, scheduleï¼Œç¡®ä¿æ˜¯æ•°ç»„
                 members: Array.isArray(data.team?.members) ? data.team.members : initialGameState.team.members,
                 achievements: Array.isArray(data.team?.achievements) ? data.team.achievements : initialGameState.team.achievements,
                 schedule: Array.isArray(data.team?.schedule) ? data.team.schedule : initialGameState.team.schedule
             };
             gameState.plan = Array.isArray(data.plan) ? data.plan : initialGameState.plan;
             gameState.song = {
                 ...initialGameState.song,
                 ...(data.song || {}),
                 // ç¡®ä¿ productionTeams ç»“æ„å®Œæ•´
                 productionTeams: {
                      ...initialGameState.song.productionTeams,
                      ...(data.song?.productionTeams || {}),
                      composers: Array.isArray(data.song?.productionTeams?.composers) ? data.song.productionTeams.composers : initialGameState.song.productionTeams.composers,
                      lyricists: Array.isArray(data.song?.productionTeams?.lyricists) ? data.song.productionTeams.lyricists : initialGameState.song.productionTeams.lyricists,
                      arrangers: Array.isArray(data.song?.productionTeams?.arrangers) ? data.song.productionTeams.arrangers : initialGameState.song.productionTeams.arrangers,
                      mvDirectors: Array.isArray(data.song?.productionTeams?.mvDirectors) ? data.song.productionTeams.mvDirectors : initialGameState.song.productionTeams.mvDirectors
                 }
             };
             console.timeEnd("updateNonCharacterState");


             // 2. æ›´æ–°æ•…äº‹æ€»ç»“ (ä¿æŒè¯¦ç»†æ—¥å¿—å’Œå¥å£®æ€§)
             console.time("updateStorySummaryState");
             console.log("å¤„ç†å‰ gameState.storySummary:", JSON.stringify(gameState.storySummary));
             let existingSummaries = Array.isArray(gameState.storySummary) ? [...gameState.storySummary] : [];
             let newSummariesInData = (data.storySummary && Array.isArray(data.storySummary)) ? data.storySummary : [];
             let summariesChanged = false;
             if (newSummariesInData.length > 0) {
                  const existingIds = new Set(existingSummaries.map(s => s.id));
                  newSummariesInData.forEach(newItem => {
                       if (newItem && typeof newItem.id === 'number' && typeof newItem.content === 'string' && newItem.content.trim()) {
                            if (!existingIds.has(newItem.id)) {
                                 existingSummaries.push(newItem);
                                 existingIds.add(newItem.id);
                                 summariesChanged = true;
                            } else {
                                 const idx = existingSummaries.findIndex(s => s.id === newItem.id);
                                 if (idx !== -1 && existingSummaries[idx].content !== newItem.content) {
                                      existingSummaries[idx].content = newItem.content;
                                      summariesChanged = true;
                                 }
                            }
                       }
                  });
                  if (summariesChanged) {
                       existingSummaries.sort((a, b) => a.id - b.id);
                       gameState.storySummary = existingSummaries; // æ›´æ–°å…¨å±€çŠ¶æ€
                       console.log(`storySummary æ›´æ–°å®Œæˆï¼Œæœ€ç»ˆ ${gameState.storySummary.length} æ¡ã€‚`);
                  } else {
                       console.log("æ”¶åˆ°çš„ storySummary æœªå¯¼è‡´å˜åŒ–ã€‚");
                  }
             } else if (existingSummaries.length === 0) {
                  gameState.storySummary = []; // ç¡®ä¿æ˜¯ç©ºæ•°ç»„
             }
             console.log("å¤„ç†å gameState.storySummary:", JSON.stringify(gameState.storySummary));
             console.timeEnd("updateStorySummaryState");


             // 3. æ›´æ–°è§’è‰²ç³»ç»Ÿ (ä½¿ç”¨æå–å™¨è·å–æ•°æ®)
             console.time("updateCharacterSystem");
             const charactersData = DataSystem.DataExtractor.extractCharacters(data); // ä½¿ç”¨æå–å™¨
             let charactersToUpdateInLorebook = []; // ã€ä¿®æ”¹ã€‘ç”¨äºå­˜å‚¨éœ€è¦æ›´æ–°ä¸–ç•Œä¹¦çš„è§’è‰²æ•°æ®

             if (charactersData && Array.isArray(charactersData.members)) { // ã€ä¿®æ”¹ã€‘ç¡®ä¿ members æ˜¯æ•°ç»„
                 CharacterSystem.init(charactersData.members); // æ›´æ–°å†…å­˜ä¸­çš„è§’è‰²çŠ¶æ€
                 charactersToUpdateInLorebook = charactersData.members; // ã€ä¿®æ”¹ã€‘æ ‡è®°è¿™äº›æ”¶åˆ°çš„è§’è‰²éœ€è¦æ›´æ–°ä¸–ç•Œä¹¦
                 loadStoredImages(); // åŠ è½½æœ¬åœ°å¤´åƒè¦†ç›–
             } else {
                 console.warn("è­¦å‘Šï¼šæ•°æ®ä¸­ç¼ºå°‘æœ‰æ•ˆçš„ characters.membersï¼Œè§’è‰²ç³»ç»Ÿå¯èƒ½æœªæ›´æ–°ã€‚");
             }
             console.timeEnd("updateCharacterSystem");

             // ========================================================
             // ã€æ–°å¢ã€‘æ›´æ–°ä¸–ç•Œä¹¦è§’è‰²æ¡ç›®
             // ========================================================
             console.time("updateLorebookEntries");
             if (charactersToUpdateInLorebook.length > 0) {
                 console.log(`æ£€æµ‹åˆ° ${charactersToUpdateInLorebook.length} ä¸ªè§’è‰²æ•°æ®éœ€è¦åŒæ­¥åˆ°ä¸–ç•Œä¹¦...`);
                 // ä½¿ç”¨ Promise.all ç­‰å¾…æ‰€æœ‰æ›´æ–°å®Œæˆï¼ˆå¹¶å‘æ‰§è¡Œï¼Œå¯èƒ½æ›´å¿«ï¼‰
                 await Promise.all(charactersToUpdateInLorebook.map(charData => {
                     if (charData && charData.name) {
                         // ä» *æ›´æ–°å* çš„ CharacterSystem è·å–æœ€æ–°çš„å®Œæ•´æ•°æ®ï¼ˆåŒ…å«å¯èƒ½åˆå¹¶çš„æœ¬åœ°å¤´åƒç­‰ï¼‰
                         // æˆ–è€…ç›´æ¥ä½¿ç”¨ charDataï¼Œå‡è®¾å®ƒå°±æ˜¯æœ€æ–°çš„ï¼ˆå–å†³äºä½ çš„é€»è¾‘å“ªä¸ªæ›´æƒå¨ï¼‰
                         // è¿™é‡Œæˆ‘ä»¬ç”¨ charDataï¼Œå› ä¸ºå®ƒç›´æ¥æ¥è‡ªè§¦å‘æ›´æ–°çš„æ•°æ®æº
                         return updateCharacterLorebookEntry(charData.name, charData);
                     }
                     return Promise.resolve(); // å¯¹äºæ— æ•ˆæ•°æ®ï¼Œè¿”å›ä¸€ä¸ªå·²è§£å†³çš„ Promise
                 })).catch(err => {
                     // æ•æ‰å¹¶è¡Œæ›´æ–°ä¸­å¯èƒ½å‘ç”Ÿçš„ä»»ä½•é”™è¯¯
                     console.error("å¹¶è¡Œæ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®æ—¶å‘ç”Ÿé”™è¯¯:", err);
                 });
                 console.log("ä¸–ç•Œä¹¦è§’è‰²æ¡ç›®åŒæ­¥å°è¯•å®Œæˆã€‚");
             } else {
                 console.log("æœ¬æ¬¡æ›´æ–°æ•°æ®ä¸­ä¸åŒ…å«è§’è‰²ä¿¡æ¯ï¼Œè·³è¿‡ä¸–ç•Œä¹¦åŒæ­¥ã€‚");
             }
             console.timeEnd("updateLorebookEntries");
             // ========================================================
             // ã€æ–°å¢ç»“æŸã€‘
             // ========================================================

             // 4. é‡å»ºè”ç³»äººæ•°æ® (è¿™ä¸ªåº”è¯¥åœ¨è§’è‰²ç³»ç»Ÿå’Œä¸–ç•Œä¹¦æ›´æ–° *ä¹‹å*)
             console.time("rebuildContacts");
             try {
                 gameState.contacts = CharacterSystem.getContactsData(); // ä»æ›´æ–°åçš„ CharacterSystem è·å–
                 console.log(`è”ç³»äººæ•°æ®å·²é‡å»ºï¼Œå…± ${gameState.contacts.length} ä¸ªã€‚`);
             } catch (charError) {
                  console.error("é‡å»º gameState.contacts æ—¶å‡ºé”™:", charError);
                  gameState.contacts = [];
             }
             console.timeEnd("rebuildContacts");

             // 5. æ›´æ–° UI (ä½¿ç”¨æ›´æ–°åçš„ gameState æ•°æ®)
             console.time("updateUI");
             console.log('å¼€å§‹æ›´æ–°ç•Œé¢...');
             try {
                 // ä¼ é€’æ›´æ–°åçš„ gameState éƒ¨åˆ†ç»™ UI æ›´æ–°å™¨
                 DataSystem.UIUpdater.updateMainText(gameState.story);
                 DataSystem.UIUpdater.updateContactText(); // è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè¯»å– gameState.contacts
                 DataSystem.UIUpdater.updateTeamText(gameState.team);
                 DataSystem.UIUpdater.updatePlanText(gameState.plan); // è¿™ä¸ªä¼šè°ƒç”¨ renderTaskList
                 DataSystem.UIUpdater.updateSongText(gameState.song); // è¿™ä¸ªä¼šè°ƒç”¨ renderSongOptions

                 // å¦‚æœæ€»ç»“é¡µé¢å½“å‰æ´»åŠ¨ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
                 const summaryPageElement = document.getElementById('summaryPage');
                 if (summaryPageElement?.classList.contains('active')) {
                     console.log("æ€»ç»“é¡µé¢æ´»åŠ¨ï¼Œè§¦å‘æ¸²æŸ“...");
                     renderStorySummaryPage();
                 }
                 // ã€æ–°å¢ã€‘å¦‚æœè”ç³»äººé¡µé¢æ´»åŠ¨ï¼Œå¼ºåˆ¶åˆ·æ–°èŠå¤©å’Œèµ„æ–™
                 const contactPageElement = document.getElementById('contactPage');
                 if(contactPageElement?.classList.contains('active') && currentContact){
                    console.log("è”ç³»äººé¡µé¢æ´»åŠ¨ï¼Œåˆ·æ–°èŠå¤©å’Œèµ„æ–™...");
                    renderChatContent(currentContact);
                    renderProfile(currentContact);
                 }
                 // ã€æ–°å¢ã€‘å¦‚æœå›¢é˜Ÿé¡µé¢æ´»åŠ¨ï¼Œå¼ºåˆ¶åˆ·æ–°
                 const teamPageElement = document.getElementById('teamPage');
                 if(teamPageElement?.classList.contains('active')){
                    console.log("å›¢é˜Ÿé¡µé¢æ´»åŠ¨ï¼Œåˆ·æ–°...");
                    renderTeamPage();
                 }
                 // ã€æ–°å¢ã€‘å¦‚æœè®­ç»ƒé¡µé¢æ´»åŠ¨ï¼Œå¼ºåˆ¶åˆ·æ–°
                 const trainingPageElement = document.getElementById('trainingPage');
                  if(trainingPageElement?.classList.contains('active')){
                     console.log("è®­ç»ƒé¡µé¢æ´»åŠ¨ï¼Œåˆ·æ–°ç»Ÿè®¡...");
                     initTrainingPage(); // æ›´æ–°ç»Ÿè®¡æ•°æ®
                  }


             } catch (uiError) { console.error("æ›´æ–° UI æ—¶å‡ºé”™:", uiError); }
             console.log('ç•Œé¢æ›´æ–°å®Œæˆã€‚');
             console.timeEnd("updateUI");

             // 6. æ›´æ–°æ–‡æœ¬ç³»ç»Ÿ
             console.time("updateTextSystem");
             if (gameState.story && Array.isArray(gameState.story.dialogue)) { // æ£€æŸ¥ gameState.story.dialogue
                 TextSystem.currentScript = gameState.story.dialogue;
                 TextSystem.currentIndex = 0; // é‡ç½®ç´¢å¼•
                 console.log(`æ–‡æœ¬ç³»ç»Ÿå‰§æœ¬å·²æ›´æ–°ï¼Œå…± ${TextSystem.currentScript.length} æ¡`);
                 const storyPageElement = document.getElementById('storyPage');
                 if (storyPageElement?.classList.contains('active')) {
                      // ä½¿ç”¨ setTimeout ç¡®ä¿ UI æ›´æ–°å®Œæˆåå†æ˜¾ç¤ºæ–‡æœ¬
                      setTimeout(() => {
                           console.log("æ•…äº‹é¡µé¢æ¿€æ´»ï¼Œæ˜¾ç¤ºæ–°å‰§æœ¬...");
                           TextSystem.showCurrentText(); // æ˜¾ç¤ºç¬¬ä¸€æ¡
                           // æ£€æŸ¥æ–°å‰§æœ¬æ˜¯å¦ç›´æ¥ç»“æŸ
                           if (TextSystem.currentIndex >= TextSystem.currentScript.length) {
                                console.log("æ–°å‰§æœ¬ä¸ºç©ºæˆ–å·²åœ¨ç»“å°¾ï¼Œæ˜¾ç¤ºé€‰é¡¹ã€‚");
                                TextSystem.showOptions();
                           }
                      }, 0);
                 }
             } else {
                  console.warn("æ–°çŠ¶æ€ä¸­ story.dialogue æ— æ•ˆæˆ–ä¸ºç©ºï¼Œæ–‡æœ¬ç³»ç»Ÿæœªæ›´æ–°å‰§æœ¬");
                  TextSystem.currentScript = [];
                  TextSystem.currentIndex = 0;
                  const storyPageElement = document.getElementById('storyPage');
                  if (storyPageElement?.classList.contains('active')) {
                       const storyContentEl = document.getElementById('story-content');
                       if (storyContentEl) storyContentEl.innerHTML = '<div class="text-normal">æ— æ•…äº‹å†…å®¹ã€‚</div>';
                       toggleOptionsPanel(false); // éšè—é€‰é¡¹
                  }
             }
             console.timeEnd("updateTextSystem");

             console.log('æ¸¸æˆçŠ¶æ€æ›´æ–°å®Œæˆ');
             window.gameDataLoaded = true;
             console.timeEnd("updateGameStateDuration");
             console.log('%c--- updateGameState END ---', 'color: blue; font-weight: bold;');
        }
        // ä¿å­˜æ¸¸æˆçŠ¶æ€
        let saveInProgress = false; // å¯é€‰ï¼šä¿ç•™é˜²æŠ–/èŠ‚æµé€»è¾‘
        let lastSaveTime = 0;
        async function saveGameState() {
            // å¯é€‰ï¼šå–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨é˜²æŠ–/èŠ‚æµ
            // if (!window.gameDataLoaded) { console.log('Game data not loaded, skipping save.'); return; }
            // if (saveInProgress) { console.log('Save already in progress, skipping.'); return; }
            // const now = Date.now();
            // if (now - lastSaveTime < 5000) { console.log('Saving too frequently, skipping.'); return; }
            // saveInProgress = true;
            // lastSaveTime = now;
            console.log("saveGameState: å¼€å§‹æ‰§è¡Œä¿å­˜...");

            try {
                // --- 1. åˆ›å»ºçŠ¶æ€å‰¯æœ¬ ---
                console.log("åˆ›å»º gameState å‰¯æœ¬ç”¨äºä¿å­˜...");
                let stateToSave;
                try {
                    stateToSave = structuredClone(gameState); // åˆ›å»ºæ·±æ‹·è´
                } catch (cloneError) {
                    console.error("åˆ›å»º gameState å‰¯æœ¬å¤±è´¥ (structuredClone):", cloneError);
                    alert("ä¿å­˜å¤±è´¥ï¼šæ— æ³•å¤åˆ¶æ¸¸æˆçŠ¶æ€ã€‚");
                    return; // é€€å‡ºä¿å­˜æµç¨‹
                }

                // --- 2. ä»å‰¯æœ¬ä¸­ç§»é™¤ Base64 å¤´åƒ ---
                console.log("ä»å‰¯æœ¬ä¸­ç§»é™¤ Base64 å¤´åƒ...");
                // ç¡®ä¿ removeBase64Avatars å‡½æ•°å­˜åœ¨
                if (typeof removeBase64Avatars === 'function') {
                    removeBase64Avatars(stateToSave); // ä»å‰¯æœ¬ä¸­ç§»é™¤å¤´åƒ
                    console.log("Base64 å¤´åƒæ•°æ®å·²å°è¯•ä»å‰¯æœ¬ç§»é™¤ã€‚");
                } else {
                    console.warn("removeBase64Avatars å‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•ç§»é™¤å¤´åƒã€‚å°†ä¿å­˜åŒ…å«å¤´åƒçš„æ•°æ®ã€‚");
                    // å¯ä»¥é€‰æ‹©ä¸­æ­¢ä¿å­˜æˆ–ç»§ç»­ä¿å­˜å¸¦å¤´åƒçš„æ•°æ®
                }

                // --- 3. å‡†å¤‡è¦ä¿å­˜çš„å­—ç¬¦ä¸² ---
                let gameStateStr;
                try {
                    gameStateStr = JSON.stringify(stateToSave); // Stringify ä¿®æ”¹åçš„å‰¯æœ¬
                } catch (stringifyError) {
                    console.error("å°†æ¸¸æˆçŠ¶æ€è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²æ—¶å¤±è´¥:", stringifyError);
                    alert("ä¿å­˜å¤±è´¥ï¼šæ— æ³•åºåˆ—åŒ–æ¸¸æˆçŠ¶æ€ã€‚");
                    return; // é€€å‡ºä¿å­˜æµç¨‹
                }
                const formattedMessage = `<gametext>${gameStateStr}</gametext>`;
                console.log(`å‡†å¤‡ä¿å­˜çš„æ•°æ®å¤§å°çº¦: ${Math.round(formattedMessage.length / 1024)} KB`);

                // --- 4. æ£€æŸ¥ setChatMessage å‡½æ•° ---
                if (typeof setChatMessage === 'function') {
                    // --- è°ƒç”¨ setChatMessage ---
                    console.log("è°ƒç”¨ setChatMessage (refresh: 'none') ä¿å­˜çŠ¶æ€...");
                    await setChatMessage({ message: formattedMessage }, 0, { refresh: 'none' });
                    console.log('æ¸¸æˆçŠ¶æ€å·²é€šè¿‡ setChatMessage ä¿å­˜ã€‚');
                } else {
                    // --- å¦‚æœ setChatMessage ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨ ---
                    console.warn('setChatMessage å‡½æ•°ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä¿å­˜');
                    try {
                        localStorage.setItem('gameState', formattedMessage); // ä¿å­˜åŒ…å« gametext æ ‡ç­¾çš„å­—ç¬¦ä¸²
                        console.log('æ¸¸æˆçŠ¶æ€å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                    } catch (lsError) {
                        console.error("ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:", lsError);
                        alert("ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç©ºé—´ä¸è¶³ã€‚");
                    }
                }

            } catch (error) {
                // æ•è· setChatMessage æˆ–å…¶ä»–æ„å¤–é”™è¯¯
                console.error('ä¿å­˜æ¸¸æˆçŠ¶æ€æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯:', error);
                alert(`ä¿å­˜æ¸¸æˆçŠ¶æ€æ—¶å‡ºé”™: ${error.message}`);
                // --- 5. å°è¯•æœ¬åœ°å¤‡ä»½ï¼ˆå¯é€‰ï¼‰ ---
                try {
                    console.warn('ä¿å­˜æ—¶å‡ºé”™ï¼Œå°è¯•å¤‡ä»½åˆ°æœ¬åœ°å­˜å‚¨...');
                    const backupState = structuredClone(gameState); // é‡æ–°å…‹éš†åŸå§‹çŠ¶æ€
                    if (typeof removeBase64Avatars === 'function') {
                        removeBase64Avatars(backupState); // åŒæ ·ç§»é™¤å¤´åƒ
                    }
                    localStorage.setItem('gameStateBackup', JSON.stringify(backupState)); // å¤‡ä»½çº¯å‡€ JSON
                    console.log('ç§»é™¤å¤´åƒåçš„æ¸¸æˆçŠ¶æ€å·²å°è¯•å¤‡ä»½åˆ°æœ¬åœ°å­˜å‚¨');
                } catch (backupError) {
                    console.error('å¤‡ä»½æ¸¸æˆçŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨æ—¶å‡ºé”™:', backupError);
                }
            } finally {
                 // å¯é€‰ï¼šé‡ç½®é˜²æŠ–æ ‡å¿—
                 // saveInProgress = false;
                 console.log("saveGameState: ä¿å­˜æµç¨‹ç»“æŸã€‚");
            }
        }


        // --- Loading Indicator & Interaction Lock ---
        function showLoadingIndicator(message = "å¤„ç†ä¸­...") {
            hideLoadingIndicator(); // ç¡®ä¿ç§»é™¤æ—§çš„
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `<div><div class="loading-spinner"></div><p>${message}</p></div>`;
            document.body.appendChild(overlay);
        }
        function hideLoadingIndicator() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }
        function disableInteractions() {
            console.log("ç¦ç”¨äº¤äº’...");
            document.querySelectorAll('button, input, select, .nav-link, .contact-item, .member-card, .style-mini-card, .member-select-item, .filter-btn, .chapter-item, .text-box').forEach(el => {
                 if (el.id !== 'loadingOverlay' && !el.closest('#loadingOverlay')) { // é¿å…ç¦ç”¨åŠ è½½æŒ‡ç¤ºå™¨æœ¬èº«
                      el.disabled = true;
                      el.style.pointerEvents = 'none'; // å¯¹é“¾æ¥ç­‰å…ƒç´ ä¹Ÿç”Ÿæ•ˆ
                      el.style.cursor = 'wait';
                 }
            });
             document.body.style.cursor = 'wait';
        }
        function enableInteractions() {
            console.log("å¯ç”¨äº¤äº’...");
            document.querySelectorAll('button, input, select, .nav-link, .contact-item, .member-card, .style-mini-card, .member-select-item, .filter-btn, .chapter-item, .text-box').forEach(el => {
                 el.disabled = false;
                 el.style.pointerEvents = 'auto';
                 el.style.cursor = ''; // æ¢å¤é»˜è®¤å…‰æ ‡
            });
             document.body.style.cursor = 'default';
             // æ¢å¤ç‰¹å®šæŒ‰é’®çš„æ–‡æœ¬/å›¾æ ‡ (å¦‚æœéœ€è¦)
            const submitCustomOptionBtn = document.getElementById('submitCustomOptionBtn');
            if (submitCustomOptionBtn) submitCustomOptionBtn.innerHTML = 'ç¡®å®š';
            const startProductionBtn = document.getElementById('startProductionBtn');
            if (startProductionBtn) startProductionBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹åˆ¶ä½œ';
        }

        // --- Text Extraction ---
        function extractGameText(responseText) {
            if (!responseText) return null;

            const gameTextTagLower = '<gametext>';
            const storyKeySequence = '"story":'; // è¦æŸ¥æ‰¾çš„å…³é”®åºåˆ—ï¼ˆä¸åŒ…å«'{'ï¼Œå› ä¸º'{'è¦å…ˆæ‰¾åˆ°ï¼‰
            let currentSearchIndex = 0; // ä»å­—ç¬¦ä¸²å¼€å¤´å¼€å§‹æœç´¢

            while (currentSearchIndex < responseText.length) {
                // 1. æŸ¥æ‰¾ä¸‹ä¸€ä¸ª <gametext> æ ‡ç­¾
                const startIndex = responseText.toLowerCase().indexOf(gameTextTagLower, currentSearchIndex);
                if (startIndex === -1) {
                    console.warn("extractGameText: æœªèƒ½åœ¨å‰©ä½™æ–‡æœ¬ä¸­æ‰¾åˆ° <gametext> æ ‡ç­¾ã€‚");
                    return null; // æœç´¢ç»“æŸï¼Œæœªæ‰¾åˆ°
                }

                // 2. æ‰¾åˆ° <gametext> æ ‡ç­¾ç»“æŸåçš„ä½ç½®
                const tagEndIndex = startIndex + gameTextTagLower.length;

                // 3. ä»æ ‡ç­¾ç»“æŸåæŸ¥æ‰¾ç¬¬ä¸€ä¸ª '{'ï¼Œè·³è¿‡ç©ºç™½å’Œä»£ç å—æ ‡è®°
                let jsonStartIndex = -1;
                const maxScanLengthAfterTag = 100; // é™åˆ¶æ‰«æèŒƒå›´
                const scanEndIndex = Math.min(tagEndIndex + maxScanLengthAfterTag, responseText.length);

                for (let i = tagEndIndex; i < scanEndIndex; i++) {
                    const char = responseText[i];
                    if (char === '{') {
                        jsonStartIndex = i;
                        console.log(`[æå–é˜¶æ®µ] åœ¨ç´¢å¼• ${startIndex} æ‰¾åˆ° <gametext>ï¼Œå¹¶åœ¨ç´¢å¼• ${jsonStartIndex} å¤„æ‰¾åˆ°èµ·å§‹ '{'`);
                        break;
                    } else if (!/\s/.test(char) && char !== '`' && !(char === 'j' && responseText.substring(i, i+4).toLowerCase() === 'json')) {
                        console.log(`[æå–é˜¶æ®µ] åœ¨ç´¢å¼• ${startIndex} çš„ <gametext> ä¹‹åé‡åˆ°æ„å¤–å­—ç¬¦ '${char}'ï¼Œç»§ç»­æœç´¢ä¸‹ä¸€ä¸ª <gametext>`);
                        jsonStartIndex = -2; // ç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤ºä¸ç¬¦åˆï¼Œéœ€è¦ç»§ç»­å¤–å±‚å¾ªç¯
                        break;
                    }
                }

                if (jsonStartIndex === -1) { // åœ¨æ‰«æèŒƒå›´å†…æœªæ‰¾åˆ° '{'
                    console.log(`[æå–é˜¶æ®µ] åœ¨ç´¢å¼• ${startIndex} çš„ <gametext> ä¹‹åæœªæ‰¾åˆ° '{'ï¼Œç»§ç»­æœç´¢ä¸‹ä¸€ä¸ª <gametext>`);
                    currentSearchIndex = tagEndIndex; // ä»æ ‡ç­¾åç»§ç»­æœç´¢
                    continue; // ç»§ç»­å¤–å±‚ while å¾ªç¯
                }
                 if (jsonStartIndex === -2) { // é‡åˆ°æ„å¤–å­—ç¬¦
                      currentSearchIndex = tagEndIndex; // ä»æ ‡ç­¾åç»§ç»­æœç´¢
                      continue; // ç»§ç»­å¤–å±‚ while å¾ªç¯
                 }


                // 4. ã€æ–°å¢ã€‘æ£€æŸ¥ '{' åé¢æ˜¯å¦ç´§è·Ÿç€ "story": { ï¼ˆå…è®¸ç©ºç™½ï¼‰
                let storyKeyIndex = -1;
                const maxScanLengthAfterBrace = 50; // é™åˆ¶æ‰«æèŒƒå›´
                const scanEndIndexForStory = Math.min(jsonStartIndex + 1 + maxScanLengthAfterBrace, responseText.length);

                for (let i = jsonStartIndex + 1; i < scanEndIndexForStory; i++) {
                    if (!/\s/.test(responseText[i])) { // æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦
                        // æ£€æŸ¥æ˜¯å¦ä»¥ "story": å¼€å¤´
                        if (responseText.substring(i).startsWith(storyKeySequence)) {
                            // å†æ£€æŸ¥ "story": åé¢æ˜¯å¦ç´§è·Ÿç€ { (å…è®¸ç©ºç™½)
                             let secondBraceIndex = -1;
                             const storyKeyEndIndex = i + storyKeySequence.length;
                             for (let j = storyKeyEndIndex; j < scanEndIndexForStory; j++){
                                  if(!/\s/.test(responseText[j])){
                                       if(responseText[j] === '{'){
                                            secondBraceIndex = j;
                                            storyKeyIndex = i; // ç¡®è®¤æ‰¾åˆ° "story": { æ¨¡å¼
                                            console.log(`[æå–é˜¶æ®µ] åœ¨ç´¢å¼• ${jsonStartIndex} çš„ '{' ä¹‹åï¼Œäºç´¢å¼• ${storyKeyIndex} æ‰¾åˆ° "${storyKeySequence}" å¹¶åœ¨ç´¢å¼• ${secondBraceIndex} æ‰¾åˆ° '{'`);
                                       } else {
                                            console.log(`[æå–é˜¶æ®µ] åœ¨ç´¢å¼• ${startIndex} çš„ <gametext>{...} ä¸­ï¼Œ"${storyKeySequence}" ä¹‹åä¸æ˜¯ '{' (è€Œæ˜¯ '${responseText[j]}')ï¼Œç»§ç»­æœç´¢ä¸‹ä¸€ä¸ª <gametext>`);
                                       }
                                       break; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºç™½å°±è·³å‡ºå†…å±‚ j å¾ªç¯
                                  }
                             }
                        } else {
                             console.log(`[æå–é˜¶æ®µ] åœ¨ç´¢å¼• ${startIndex} çš„ <gametext>{...} ä¸­ï¼Œ'{' åçš„ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦ä¸æ˜¯ä»¥ "${storyKeySequence}" å¼€å¤´ï¼Œç»§ç»­æœç´¢ä¸‹ä¸€ä¸ª <gametext>`);
                        }
                        break; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºç™½å°±è·³å‡ºå¤–å±‚ i å¾ªç¯
                    }
                }
                // --- ã€æ–°å¢ç»“æŸã€‘---

                if (storyKeyIndex === -1) { // å¦‚æœæ²¡æœ‰æ‰¾åˆ° "story": { æ¨¡å¼
                    currentSearchIndex = jsonStartIndex + 1; // ä» '{' ä¹‹åç»§ç»­æœç´¢ä¸‹ä¸€ä¸ª <gametext>
                    continue; // ç»§ç»­å¤–å±‚ while å¾ªç¯
                }

                // 5. å¦‚æœæ‰¾åˆ°äº† <gametext>...{"story": { æ¨¡å¼ï¼Œåˆ™è¿›è¡Œæ‹¬å·åŒ¹é…æŸ¥æ‰¾ç»“å°¾ '}'
                // (æ‹¬å·åŒ¹é…é€»è¾‘ä¿æŒä¸å˜)
                let braceLevel = 0;
                let jsonEndIndex = -1;
                let inString = false;
                let escapeNext = false;

                for (let i = jsonStartIndex; i < responseText.length; i++) {
                    const char = responseText[i];
                    if (escapeNext) { escapeNext = false; continue; }
                    if (char === '\\') { escapeNext = true; continue; }
                    if (char === '"' && !escapeNext) { inString = !inString; }

                    if (!inString) {
                        if (char === '{') {
                            braceLevel++;
                        } else if (char === '}') {
                            braceLevel--;
                            if (braceLevel === 0) {
                                jsonEndIndex = i;
                                console.log(`[æå–é˜¶æ®µ] åœ¨ç´¢å¼• ${jsonEndIndex} å¤„æ‰¾åˆ°åŒ¹é…çš„ '}'`);
                                break;
                            }
                        }
                    }
                     if (braceLevel < 0) {
                          console.warn("extractGameText: æ£€æµ‹åˆ°æ— æ•ˆçš„æ‹¬å·å±‚çº§ï¼ŒJSON å¯èƒ½å·²æŸåã€‚");
                          return null; // ç»“æ„é”™è¯¯ï¼Œç›´æ¥å¤±è´¥
                     }
                }

                if (jsonEndIndex === -1) {
                    console.warn("extractGameText: ä»æ‰¾åˆ°çš„ '<gametext>...{\"story\": {' å¼€å§‹æœªèƒ½æ‰¾åˆ°åŒ¹é…çš„ç»“æŸ '}'ã€‚");
                    // è¿™é‡Œä¸å†ç»§ç»­æœç´¢ï¼Œå› ä¸ºå·²ç»æ‰¾åˆ°äº†ç¬¦åˆå¼€å¤´çš„å—ä½†ç»“æ„ä¸å®Œæ•´
                    return null;
                }

                // 6. æå– JSON å­—ç¬¦ä¸²
                const potentialJson = responseText.substring(jsonStartIndex, jsonEndIndex + 1).trim();

                if (potentialJson.startsWith('{') && potentialJson.endsWith('}')) {
                    console.log("[æå–é˜¶æ®µ] æˆåŠŸæå–ç¬¦åˆ '<gametext>...{\"story\": {' æ¨¡å¼çš„ JSON å—:", potentialJson);
                    return potentialJson; // æ‰¾åˆ°äº†ç¬¦åˆæ‰€æœ‰æ¡ä»¶çš„å—ï¼Œè¿”å›ç»“æœ
                } else {
                    console.error("extractGameText: æå–é€»è¾‘å¼‚å¸¸ï¼Œæœ€ç»ˆç»“æœé {} åŒ…è£¹ã€‚");
                    // ç†è®ºä¸Šä¸åº”å‘ç”Ÿï¼Œä½†ä¹Ÿè¿”å› null
                    return null;
                }
            } // ç»“æŸ while å¾ªç¯

            // å¦‚æœå¾ªç¯ç»“æŸä»æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å—
            console.warn("extractGameText: éå†å®Œæˆï¼Œæœªèƒ½æ‰¾åˆ°ç¬¦åˆ '<gametext>...{\"story\": {' æ¨¡å¼çš„æœ‰æ•ˆå—ã€‚");
            return null;
        }
        function extractReplyContent(text) {
             if (!text) return "";
             const match = text.match(/<message1>([\s\S]*?)<\/message1>/i);
             return match ? match[1].trim() : text.trim();
        }
        function parseEntryContent(content) { // (ä¿æŒä¸å˜)
            if (!content) return "";
            const details = [];
            const lines = content.split('\n');
            const fieldsToExtract = { /* ... */ }; // ä¿æŒåŸæ ·
            let isInInfoSection = false;
            const simpleInfoRegex = /^\s*-\s*(\S+)\s*[:ï¼š]\s*(.+)/;
            lines.forEach(line => { /* ... */ }); // ä¿æŒåŸæ ·
            return details.length > 0 ? `è§’è‰²${details.find(d => d.startsWith("å§“å:"))?.split(':')[1]?.trim() || ''}çš„ç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š\n- ${details.join('\n- ')}\n\nè¯·å‚è€ƒä»¥ä¸Šä¿¡æ¯è¿›è¡Œå›å¤ã€‚\n\n---\n\n` : "";
        }

        // --- World Book & Saving ---
        async function toggleWorldBookEntries(entriesToEnable = [], entriesToDisable = []) {
            const worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
             console.log(`åˆ‡æ¢ä¸–ç•Œä¹¦ "${worldBookName}" æ¡ç›®: å¯ç”¨[${entriesToEnable.join('/') || 'æ— '}], ç¦ç”¨[${entriesToDisable.join('/') || 'æ— '}]`);
            try {
                if (typeof getLorebookEntries !== 'function' || typeof setLorebookEntries !== 'function') {
                    console.warn("ä¸–ç•Œä¹¦ API å‡½æ•°ä¸å¯ç”¨ï¼Œè·³è¿‡åˆ‡æ¢ã€‚");
                    return;
                }
                const allEntries = await getLorebookEntries(worldBookName);
                if (!allEntries) {
                     console.warn(`æ— æ³•è·å– "${worldBookName}" æ¡ç›®ï¼Œè·³è¿‡ã€‚`);
                     return;
                }

                let changed = false;
                const entriesToUpdate = [];

                allEntries.forEach(entry => {
                     if (!entry || typeof entry.comment !== 'string' || entry.uid == null) return; // è·³è¿‡æ— æ•ˆæ¡ç›®

                    const entryComment = entry.comment;
                    let currentEnabledStatus = entry.enabled;
                    let targetEnabledStatus = currentEnabledStatus; // å‡è®¾ä¸å˜

                    if (entriesToEnable.includes(entryComment)) {
                        targetEnabledStatus = true; // ç›®æ ‡æ˜¯å¯ç”¨
                    } else if (entriesToDisable.includes(entryComment)) {
                        targetEnabledStatus = false; // ç›®æ ‡æ˜¯ç¦ç”¨
                    }

                     // å¦‚æœç›®æ ‡çŠ¶æ€ä¸å½“å‰çŠ¶æ€ä¸åŒï¼Œåˆ™æ ‡è®°æ›´æ”¹å¹¶å‡†å¤‡æ›´æ–°
                     if (targetEnabledStatus !== currentEnabledStatus) {
                          changed = true;
                          entriesToUpdate.push({ uid: entry.uid, enabled: targetEnabledStatus });
                           console.log(`  - ${targetEnabledStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}æ¡ç›®: "${entryComment}" (uid: ${entry.uid})`);
                     }
                });

                if (changed) {
                    console.log(`æ£€æµ‹åˆ° ${entriesToUpdate.length} ä¸ªæ¡ç›®çŠ¶æ€å˜æ›´ï¼Œè°ƒç”¨ setLorebookEntries...`);
                    await setLorebookEntries(worldBookName, entriesToUpdate);
                    console.log(`ä¸–ç•Œä¹¦ "${worldBookName}" æ¡ç›®çŠ¶æ€æ›´æ–°æˆåŠŸã€‚`);
                } else {
                    console.log(`æ‰€æœ‰ç›®æ ‡æ¡ç›®çŠ¶æ€å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°ä¸–ç•Œä¹¦ã€‚`);
                }
            } catch (error) {
                console.error(`åˆ‡æ¢ä¸–ç•Œä¹¦æ¡ç›®çŠ¶æ€æ—¶å‡ºé”™:`, error);
            }
        }
        async function autoSaveToWorldBook() {
            const worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
            const baseEntryComment = "å­˜æ¡£";
            const entrySuffix = "ï¼ˆä¸è¦åˆ ï¼Œä¸ç”¨æ‰“å¼€ï¼‰";
            console.log("autoSaveToWorldBook: å¼€å§‹è‡ªåŠ¨å­˜æ¡£...");

            try {
                 // --- 1. æ£€æŸ¥ API ---
                 if (typeof getLorebooks !== 'function' || typeof createLorebook !== 'function' ||
                     typeof getLorebookEntries !== 'function' || typeof createLorebookEntry !== 'function') {
                     console.warn("ä¸–ç•Œä¹¦ API å‡½æ•°ä¸å®Œæ•´ï¼Œæ— æ³•æ‰§è¡Œè‡ªåŠ¨å­˜æ¡£ã€‚");
                     return;
                 }

                 // --- 2. æ£€æŸ¥å¹¶åˆ›å»ºä¸–ç•Œä¹¦ ---
                 const lorebookList = await getLorebooks();
                 if (!lorebookList.includes(worldBookName)) {
                     console.log(`ä¸–ç•Œä¹¦ "${worldBookName}" ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...`);
                     await createLorebook(worldBookName);
                     await new Promise(resolve => setTimeout(resolve, 300)); // ç­‰å¾…ç”Ÿæ•ˆ
                     console.log(`ä¸–ç•Œä¹¦ "${worldBookName}" å·²åˆ›å»ºã€‚`);
                 }

                 // --- 3. æŸ¥æ‰¾æœ€å¤§å­˜æ¡£åºå· ---
                 let maxSaveNum = 0;
                 const saveRegex = new RegExp(`^${baseEntryComment}(\\d+)${entrySuffix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}$`);
                 try {
                     const allEntries = await getLorebookEntries(worldBookName);
                     if (allEntries) {
                         allEntries.forEach(entry => {
                             if (entry && entry.comment) {
                                 const match = entry.comment.match(saveRegex);
                                 if (match && match[1]) {
                                     const num = parseInt(match[1], 10);
                                     if (!isNaN(num) && num > maxSaveNum) maxSaveNum = num;
                                 }
                             }
                         });
                     }
                 } catch (findError) {
                     console.error("æŸ¥æ‰¾ç°æœ‰å­˜æ¡£æ—¶å‡ºé”™:", findError);
                     // å³ä½¿æŸ¥æ‰¾å‡ºé”™ï¼Œä»ç„¶å¯ä»¥å°è¯•åˆ›å»ºå­˜æ¡£ 1
                 }
                 const nextSaveNum = maxSaveNum + 1;
                 const newEntryComment = `${baseEntryComment}${nextSaveNum}${entrySuffix}`;
                 console.log(`ä¸‹ä¸€ä¸ªå­˜æ¡£åºå·: ${nextSaveNum}, åç§°: "${newEntryComment}"`);

                 // --- 4. åˆ›å»ºçŠ¶æ€å‰¯æœ¬å¹¶ç§»é™¤ Base64 å¤´åƒ ---
                 console.log("åˆ›å»º gameState å‰¯æœ¬ç”¨äºä¸–ç•Œä¹¦å­˜æ¡£...");
                 let stateToSaveForWorldBook;
                 try {
                     stateToSaveForWorldBook = structuredClone(gameState);
                 } catch (cloneError) {
                     console.error("åˆ›å»º gameState å‰¯æœ¬å¤±è´¥ (structuredClone):", cloneError);
                     alert("è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼šæ— æ³•å¤åˆ¶æ¸¸æˆçŠ¶æ€ã€‚");
                     return;
                 }
                 console.log("ä»å‰¯æœ¬ä¸­ç§»é™¤ Base64 å¤´åƒ...");
                 if (typeof removeBase64Avatars === 'function') {
                     removeBase64Avatars(stateToSaveForWorldBook);
                     console.log("Base64 å¤´åƒæ•°æ®å·²å°è¯•ä»å‰¯æœ¬ç§»é™¤ã€‚");
                 } else {
                     console.warn("removeBase64Avatars å‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•ç§»é™¤å¤´åƒã€‚å°†ä¿å­˜åŒ…å«å¤´åƒçš„æ•°æ®åˆ°ä¸–ç•Œä¹¦ã€‚");
                 }

                 // --- 5. å‡†å¤‡è¦ä¿å­˜çš„ JSON å­—ç¬¦ä¸² ---
                 let currentStateJSON;
                 try {
                     currentStateJSON = JSON.stringify(stateToSaveForWorldBook); // Stringify ä¿®æ”¹åçš„å‰¯æœ¬
                 } catch (stringifyError) {
                     console.error("å°†æ¸¸æˆçŠ¶æ€è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²æ—¶å¤±è´¥:", stringifyError);
                     alert("è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼šæ— æ³•åºåˆ—åŒ–æ¸¸æˆçŠ¶æ€ã€‚");
                     return;
                 }
                 console.log(`å‡†å¤‡ä¿å­˜åˆ°ä¸–ç•Œä¹¦çš„æ•°æ®å¤§å°çº¦: ${Math.round(currentStateJSON.length / 1024)} KB`);

                 // --- 6. åˆ›å»ºæ–°å­˜æ¡£æ¡ç›® ---
                 console.log(`æ­£åœ¨åˆ›å»ºæ–°å­˜æ¡£æ¡ç›®: "${newEntryComment}"`);
                 await createLorebookEntry(worldBookName, {
                     comment: newEntryComment,
                     content: currentStateJSON, // ä¿å­˜çº¯å‡€çš„ JSON å­—ç¬¦ä¸²
                     enabled: false,
                     key: ["æ¸¸æˆå­˜æ¡£", `å­˜æ¡£${nextSaveNum}`, "GameStateBackup"],
                     type: 'constant',
                     position: 'before_character_definition'
                 });
                 console.log(`æ–°çš„å­˜æ¡£æ¡ç›® "${newEntryComment}" å·²åˆ›å»ºã€‚`);

            } catch (error) {
                // æ•è·APIæ£€æŸ¥ã€ä¸–ç•Œä¹¦æ“ä½œç­‰é”™è¯¯
                console.error("è‡ªåŠ¨å­˜æ¡£åˆ°ä¸–ç•Œä¹¦æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯:", error);
                // å¯ä»¥é€‰æ‹©æ€§åœ° alert ç”¨æˆ·ï¼Œä½†è‡ªåŠ¨ä¿å­˜å¤±è´¥é€šå¸¸ä¸éœ€è¦æ‰“æ–­ç”¨æˆ·
                // alert(`è‡ªåŠ¨å­˜æ¡£å¤±è´¥: ${error.message}`);
            } finally {
                 console.log("autoSaveToWorldBook: å­˜æ¡£æµç¨‹ç»“æŸã€‚");
            }
        }
        async function openLoadSaveModal() {
            const worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
            const baseEntryComment = "å­˜æ¡£";
            const entrySuffix = "ï¼ˆä¸è¦åˆ ï¼Œä¸ç”¨æ‰“å¼€ï¼‰";
            const saveRegex = new RegExp(`^${baseEntryComment}(\\d+)${entrySuffix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}$`);

            console.log("å°è¯•æ‰“å¼€è¯»æ¡£å¼¹çª—...");
             showLoadingIndicator("åŠ è½½å­˜æ¡£åˆ—è¡¨..."); // æ˜¾ç¤ºåŠ è½½æç¤º

            try {
                if (typeof getLorebookEntries !== 'function') {
                     throw new Error("ä¸–ç•Œä¹¦ API å‡½æ•° (getLorebookEntries) ä¸å¯ç”¨ã€‚");
                }

                // è·å–æ‰€æœ‰æ¡ç›®
                const allEntries = await getLorebookEntries(worldBookName);
                 if (!allEntries) {
                      throw new Error(`æ— æ³•è·å–ä¸–ç•Œä¹¦ "${worldBookName}" çš„æ¡ç›®ã€‚`);
                 }

                // ç­›é€‰ã€æ·»åŠ åºå·ã€æ’åº
                const saveEntries = allEntries
                    .filter(entry => entry && entry.comment && entry.uid != null && saveRegex.test(entry.comment)) // å¢åŠ æœ‰æ•ˆæ€§æ£€æŸ¥
                    .map(entry => {
                        const match = entry.comment.match(saveRegex);
                        entry.saveNumber = match ? parseInt(match[1], 10) : 0;
                        return entry;
                    })
                    .sort((a, b) => b.saveNumber - a.saveNumber); // æŒ‰åºå·é™åºæ’åº (æœ€æ–°çš„åœ¨å‰é¢)

                 console.log(`æ‰¾åˆ° ${saveEntries.length} ä¸ªæœ‰æ•ˆå­˜æ¡£æ¡ç›®å¹¶æ’åºã€‚`);


                 // åˆ›å»ºå¼¹çª— HTML
                 const modal = document.createElement('div');
                 modal.className = 'chapter-modal load-save-modal';
                 modal.id = 'loadSaveModal';

                 let saveListHtml = '';
                 if (saveEntries.length > 0) {
                      saveListHtml = saveEntries.map(entry => `
                          <li class="chapter-item save-item" data-entry-uid="${entry.uid}" data-entry-comment="${entry.comment}">
                             å­˜æ¡£ ${entry.saveNumber} <span class="text-muted small">(${entry.comment.replace(entrySuffix,'').replace(baseEntryComment,'')})</span>
                          </li>
                      `).join('');
                 } else {
                      saveListHtml = '<li class="text-muted p-3 text-center">æ²¡æœ‰å¯åŠ è½½çš„å­˜æ¡£ã€‚</li>';
                 }

                 modal.innerHTML = `
                     <div class="chapter-modal-content">
                         <div class="chapter-modal-header">
                             <h3>é€‰æ‹©è¦è¯»å–çš„å­˜æ¡£</h3>
                             <button class="close-btn close-load-modal-btn">Ã—</button>
                         </div>
                         <div class="chapter-modal-body">
                             <ul class="chapter-list">
                                 ${saveListHtml}
                             </ul>
                         </div>
                         <div class="chapter-modal-footer" style="padding: 15px 20px; text-align: right; border-top: 1px solid #eee;">
                              <button class="btn btn-secondary close-load-modal-btn">å–æ¶ˆ</button>
                         </div>
                     </div>
                 `;

                 // æ·»åŠ å…³é—­äº‹ä»¶
                 const closeModal = () => { /* ... ä¿æŒä¸å˜ ... */
                    const existingModal = document.getElementById('loadSaveModal');
                    if (existingModal) {
                        document.body.classList.remove('modal-open');
                        existingModal.remove();
                        document.removeEventListener('keydown', handleEscKey); // ç§»é™¤ ESC ç›‘å¬
                        console.log("è¯»æ¡£å¼¹çª—å·²å…³é—­ã€‚");
                    }
                };
                 modal.querySelectorAll('.close-load-modal-btn').forEach(btn => btn.addEventListener('click', closeModal));
                 modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
                 modal.querySelector('.chapter-modal-content').addEventListener('click', e => e.stopPropagation());
                 // ESC é”®å…³é—­
                 const handleEscKey = (e) => { if (e.key === 'Escape') closeModal(); };
                 document.addEventListener('keydown', handleEscKey);

                 // æ·»åŠ å­˜æ¡£æ¡ç›®ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
                 const saveListElement = modal.querySelector('.chapter-list');
                 if (saveListElement) {
                     saveListElement.addEventListener('click', async (e) => {
                          const saveItem = e.target.closest('.save-item');
                          if (saveItem && saveItem.dataset.entryUid) {
                               const uidToLoad = parseInt(saveItem.dataset.entryUid, 10);
                               const commentToLoad = saveItem.dataset.entryComment;
                                if (!isNaN(uidToLoad)) { // ç¡®ä¿ UID æœ‰æ•ˆ
                                     console.log(`å°è¯•åŠ è½½å­˜æ¡£: ${commentToLoad} (uid: ${uidToLoad})`);
                                     closeModal(); // å…ˆå…³é—­å¼¹çª—
                                     await loadGameStateFromEntry(worldBookName, uidToLoad); // è°ƒç”¨åŠ è½½å‡½æ•°
                                } else {
                                     console.error("æ— æ•ˆçš„å­˜æ¡£ UID:", saveItem.dataset.entryUid);
                                     alert("åŠ è½½å¤±è´¥ï¼šå­˜æ¡£æ ‡è¯†æ— æ•ˆã€‚");
                                }
                          }
                     });
                 }

                 // æ˜¾ç¤ºå¼¹çª—
                 document.body.classList.add('modal-open');
                 document.body.appendChild(modal);
                 console.log("è¯»æ¡£å¼¹çª—å·²æ˜¾ç¤ºã€‚");

            } catch (error) {
                console.error("æ‰“å¼€è¯»æ¡£å¼¹çª—æ—¶å‡ºé”™:", error);
                alert(`åŠ è½½å­˜æ¡£åˆ—è¡¨å¤±è´¥: ${error.message}`);
            } finally {
                 hideLoadingIndicator(); // æ— è®ºæˆåŠŸå¤±è´¥éƒ½éšè—åŠ è½½æç¤º
            }
        }
        async function loadGameStateFromEntry(lorebookName, entryUid) {
             console.log(`å¼€å§‹ä»ä¸–ç•Œä¹¦ "${lorebookName}" åŠ è½½ UID: ${entryUid} çš„å­˜æ¡£...`);
             showLoadingIndicator("è¯»å–å­˜æ¡£ä¸­..."); // æ˜¾ç¤ºåŠ è½½

             try {
                  if (typeof getLorebookEntries !== 'function') {
                       throw new Error("ä¸–ç•Œä¹¦ API å‡½æ•° (getLorebookEntries) ä¸å¯ç”¨ã€‚");
                  }

                 // è·å–ç‰¹å®šæ¡ç›® (ç¡®ä¿ filter æ ¼å¼æ­£ç¡®ï¼Œæˆ–è€…è·å–å…¨éƒ¨å†è¿‡æ»¤)
                 // å°è¯•ç›´æ¥è·å–æ‰€æœ‰æ¡ç›®ç„¶åæŸ¥æ‰¾ï¼Œæ›´å¯é 
                 const allEntries = await getLorebookEntries(lorebookName);
                 if (!allEntries) throw new Error("æ— æ³•è·å–ä¸–ç•Œä¹¦æ¡ç›®ã€‚");
                 const entryToLoad = allEntries.find(e => e && e.uid === entryUid); // æŸ¥æ‰¾åŒ¹é…çš„ UID

                 if (!entryToLoad) {
                      throw new Error(`åœ¨ "${lorebookName}" ä¸­æœªæ‰¾åˆ° UID ä¸º ${entryUid} çš„å­˜æ¡£æ¡ç›®ã€‚`);
                 }
                 console.log("æˆåŠŸè·å–åˆ°å­˜æ¡£æ¡ç›®ä¿¡æ¯ã€‚");

                 const entryContent = entryToLoad.content;
                 if (!entryContent || !entryContent.trim()) {
                      throw new Error(`å­˜æ¡£æ¡ç›® (uid: ${entryUid}) å†…å®¹ä¸ºç©ºã€‚`);
                 }

                 // æå– gametext å†…å®¹
                 let extractedGameText = extractGameText(entryContent);
                 if (!extractedGameText) {
                     console.warn("å­˜æ¡£å†…å®¹ä¸­æœªæ‰¾åˆ° <gametext> æ ‡ç­¾ï¼Œå°è¯•ç›´æ¥è§£æ...");
                     extractedGameText = entryContent.trim();
                     // å†æ¬¡æ£€æŸ¥æ˜¯å¦æ˜¯ JSON
                     if (!extractedGameText.startsWith('{') || !extractedGameText.endsWith('}')) {
                          throw new Error("å­˜æ¡£æ ¼å¼æ— æ•ˆï¼ˆç¼ºå°‘gametextæˆ–å†…å®¹éJSONï¼‰ã€‚");
                     }
                 }

                 // æ¸…ç†å¹¶è§£æ JSON
                 let cleanedText = extractedGameText.trim();
                  // --- å¤ç”¨æ¸…ç†é€»è¾‘ ---
                 cleanedText = cleanedText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                 cleanedText = cleanedText.replace(/^```\s*/, '').replace(/\s*```$/, '');
                  // ç§»é™¤å¯èƒ½çš„å¹²æ‰°æ ‡ç­¾ (æ ¹æ®å®é™…æƒ…å†µæ·»åŠ )
                 // while (/<thinking>[\s\S]*?<\/thinking>/i.test(cleanedText)) { cleanedText = cleanedText.replace(/<thinking>[\s\S]*?<\/thinking>/i, ''); }
                 const firstBraceIndex = cleanedText.indexOf('{');
                 const lastBraceIndex = cleanedText.lastIndexOf('}');
                 if (firstBraceIndex === -1 || lastBraceIndex === -1 || lastBraceIndex < firstBraceIndex) {
                     throw new Error("æ¸…ç†åçš„å­˜æ¡£æ–‡æœ¬ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ JSON å¯¹è±¡è¾¹ç•Œ '{}'");
                 }
                 cleanedText = cleanedText.substring(firstBraceIndex, lastBraceIndex + 1);
                 cleanedText = cleanedText.trim();
                  // --- æ¸…ç†ç»“æŸ ---

                 if (!cleanedText.startsWith('{') || !cleanedText.endsWith('}')) {
                      throw new Error("æœ€ç»ˆæ¸…ç†åçš„å­˜æ¡£æ–‡æœ¬ä¸æ˜¯æœ‰æ•ˆçš„ JSON å¯¹è±¡æ ¼å¼ã€‚");
                 }

                 const loadedGameData = JSON.parse(cleanedText);
                 console.log("æˆåŠŸè§£æå­˜æ¡£æ•°æ®ã€‚");

                 // æ›´æ–°æ¸¸æˆçŠ¶æ€ (ä¼šè§¦å‘ UI æ›´æ–°å’Œå¤´åƒåŠ è½½)
                 console.log("ä½¿ç”¨åŠ è½½çš„å­˜æ¡£æ•°æ®æ›´æ–°æ¸¸æˆçŠ¶æ€...");
                 updateGameState(loadedGameData);
                 console.log("æ¸¸æˆçŠ¶æ€å·²ä»å­˜æ¡£åŠ è½½å¹¶æ›´æ–°ã€‚");

                 // å¦‚æœå½“å‰åœ¨æ•…äº‹é¡µé¢ï¼Œé‡ç½®æ–‡æœ¬æ˜¾ç¤º
                  if (document.getElementById('storyPage').classList.contains('active')) {
                      console.log("é‡ç½®æ•…äº‹æ–‡æœ¬æ˜¾ç¤º...");
                      TextSystem.resetScript(); // æ˜¾ç¤ºæ–°åŠ è½½å¯¹è¯çš„å¼€å¤´
                  } else {
                      // å¦‚æœä¸åœ¨æ•…äº‹é¡µï¼Œåˆ‡æ¢è¿‡å»ï¼Ÿæˆ–è€…ä¸‹æ¬¡åˆ‡æ¢æ—¶ä¼šè‡ªåŠ¨æ˜¾ç¤º
                       console.log("å½“å‰ä¸åœ¨æ•…äº‹é¡µé¢ï¼Œåˆ‡æ¢æ—¶å°†æ˜¾ç¤ºæ–°åŠ è½½çš„å‰§æœ¬ã€‚");
                  }

                 alert(`å­˜æ¡£ "${entryToLoad.comment}" åŠ è½½æˆåŠŸï¼`);

             } catch (error) {
                 console.error(`ä»å­˜æ¡£ (uid: ${entryUid}) åŠ è½½æ¸¸æˆçŠ¶æ€æ—¶å‡ºé”™:`, error);
                 alert(`åŠ è½½å­˜æ¡£å¤±è´¥: ${error.message}`);
             } finally {
                  hideLoadingIndicator(); // éšè—åŠ è½½æç¤º
             }
        }
        /**
         * Recursively removes avatar properties that contain Base64 data URLs
         * from a given object or array (operates in place on the input).
         * IMPORTANT: Always call this on a DEEP COPY of the game state, not the original.
         * @param {object|array} objOrArray The object or array to process.
         */
         function removeBase64Avatars(objOrArray) {
            if (!objOrArray || typeof objOrArray !== 'object') {
                return; // Ignore non-objects/arrays and null
            }

            if (Array.isArray(objOrArray)) {
                // If it's an array, iterate through its elements
                objOrArray.forEach(item => removeBase64Avatars(item));
            } else {
                // If it's an object, check for the avatar property
                if (objOrArray.hasOwnProperty('avatar') && typeof objOrArray.avatar === 'string' && objOrArray.avatar.startsWith('data:image')) {
                    // Remove the Base64 avatar property
                    delete objOrArray.avatar;
                    // console.log("Removed Base64 avatar for:", objOrArray.name || objOrArray.id || 'unknown object');
                }

                // Recursively process nested objects and arrays within this object
                for (const key in objOrArray) {
                    if (objOrArray.hasOwnProperty(key)) {
                        removeBase64Avatars(objOrArray[key]);
                    }
                }
            }
        }
        function findMatchingBrace(str, startIndex) {
            if (!str || startIndex < 0 || str[startIndex] !== '{') { // Added null check for str
                return -1;
            }
            let braceCount = 1;
            for (let i = startIndex + 1; i < str.length; i++) {
                if (str[i] === '{') {
                    braceCount++;
                } else if (str[i] === '}') {
                    braceCount--;
                    if (braceCount === 0) {
                        return i; // Found the matching closing brace
                    }
                }
            }
            return -1; // No matching brace found
        }
        // --- Page Navigation & Initialization ---
        function switchPage(targetPageId) {
            console.log(`åˆ‡æ¢åˆ°é¡µé¢: ${targetPageId}`);
            const currentActiveLink = document.querySelector('.nav-link.active');
            if (currentActiveLink && currentActiveLink.dataset.page === targetPageId) {
                console.log('å·²ç»åœ¨å½“å‰é¡µé¢ï¼Œè·³è¿‡åˆ‡æ¢');
                return;
            }

            // Deactivate all
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            // Activate target
            const targetLink = document.querySelector(`.nav-link[data-page="${targetPageId}"]`);
            const targetPage = document.getElementById(targetPageId + 'Page');

            if (targetLink) targetLink.classList.add('active');
            if (targetPage) {
                targetPage.classList.add('active');
                console.log(`é¡µé¢ ${targetPageId}Page å·²æ¿€æ´»`);

                // --- è°ƒç”¨é¡µé¢æ¸²æŸ“/æ›´æ–°é€»è¾‘ ---
                 console.log(`ä¸ºé¡µé¢ ${targetPageId} è°ƒç”¨æ¸²æŸ“/æ›´æ–°å‡½æ•°...`);
                 try { // æ·»åŠ  try-catch ä¿æŠ¤é¡µé¢æ¸²æŸ“é€»è¾‘
                      if (targetPageId === 'story') {
                           initStoryPage(); // ç¡®ä¿æ•…äº‹é¡µé¢åˆå§‹åŒ–æˆ–åˆ·æ–°æ˜¾ç¤º
                      } else if (targetPageId === 'contact') {
                           initContactPage(); // ç¡®ä¿è”ç³»äººåˆ—è¡¨å’Œå½“å‰èŠå¤©/èµ„æ–™æ˜¯æœ€æ–°çš„
                      } else if (targetPageId === 'team') {
                           renderTeamPage(); // æ€»æ˜¯é‡æ–°æ¸²æŸ“å›¢é˜Ÿæ•°æ®
                      } else if (targetPageId === 'plan') {
                           renderTaskList(); // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                           filterTasks(currentFilter); // åº”ç”¨è¿‡æ»¤å™¨
                           updateTaskCounts(); // æ›´æ–°è®¡æ•°
                      } else if (targetPageId === 'song') {
                           renderSongOptions(); // é‡æ–°æ¸²æŸ“æ­Œæ›²é€‰é¡¹
                           updateSongSummary(); // æ›´æ–°æ‘˜è¦
                      } else if (targetPageId === 'summary') {
                           renderStorySummaryPage(); // æ¸²æŸ“æ•…äº‹æ€»ç»“
                      } else if (targetPageId === 'training') {
                          initTrainingPage(); // æ›´æ–°ç‰¹è®­é¡µé¢çš„ç»Ÿè®¡æ•°æ®
                      }
                 } catch (renderError) {
                      console.error(`æ¸²æŸ“é¡µé¢ ${targetPageId} æ—¶å‡ºé”™:`, renderError);
                      // å¯ä»¥è€ƒè™‘æ˜¾ç¤ºä¸€ä¸ªé€šç”¨çš„é”™è¯¯æç¤º
                 }

            } else {
                 console.error(`é”™è¯¯ï¼šæ‰¾ä¸åˆ° ID ä¸º ${targetPageId}Page çš„é¡µé¢å…ƒç´ ï¼`);
                 // Fallback: æ¿€æ´»ç¬¬ä¸€ä¸ªé¡µé¢
                 const firstPage = document.querySelector('.page');
                 if (firstPage) firstPage.classList.add('active');
                 const firstLink = document.querySelector('.nav-link');
                 if (firstLink) firstLink.classList.add('active');
            }
             console.log(`é¡µé¢åˆ‡æ¢è‡³ ${targetPageId} å®Œæˆã€‚`);
        }

        function initStoryPage() {
             console.log('åˆå§‹åŒ–/åˆ·æ–°æ•…äº‹é¡µé¢æ˜¾ç¤º');
             if (TextSystem.currentScript && TextSystem.currentScript.length > 0) {
                  TextSystem.showCurrentText(); // æ˜¾ç¤ºå½“å‰æˆ–ç¬¬ä¸€æ¡æ–‡æœ¬
                  if (TextSystem.currentIndex >= TextSystem.currentScript.length) {
                       TextSystem.showOptions(); // å¦‚æœå·²ç»“æŸï¼Œæ˜¾ç¤ºé€‰é¡¹
                  }
             } else {
                  const storyContent = document.getElementById('story-content');
                  if (storyContent) storyContent.innerHTML = '<div class="text-normal">æš‚æ— æ•…äº‹å†…å®¹ã€‚</div>';
                  toggleOptionsPanel(false); // éšè—é€‰é¡¹
             }
        }

        function initContactPage() {
             console.log('åˆå§‹åŒ–/åˆ·æ–°è”ç³»äººé¡µé¢');
             DataSystem.UIUpdater.updateContactText(); // æ›´æ–°åˆ—è¡¨

             // ç¡®ä¿å½“å‰é€‰æ‹©çš„è”ç³»äººä¿¡æ¯è¢«æ¸²æŸ“
             const contactExists = gameState.contacts.some(c => c.name === currentContact);
             if (currentContact && contactExists) {
                  // ç¡®ä¿å¯¹åº”çš„åˆ—è¡¨é¡¹æ˜¯ active
                  document.querySelectorAll('.contact-item').forEach(item => {
                       item.classList.toggle('active', item.dataset.contact === currentContact);
                  });
                  renderChatContent(currentContact);
                  renderProfile(currentContact);
             } else {
                   // å¦‚æœå½“å‰è”ç³»äººæ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæˆ–æ¸…ç©º
                  currentContact = gameState.contacts.length > 0 ? gameState.contacts[0].name : "";
                   if (currentContact) {
                        switchContact(currentContact); // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
                   } else {
                        renderChatContent(null); // æ¸…ç©ºèŠå¤©åŒº
                        renderProfile(null); // æ¸…ç©ºèµ„æ–™åŒº
                         // æ›´æ–°èŠå¤©å¤´éƒ¨
                         const chatTitleNameEl = document.getElementById('chat-title-name');
                         const chatHeaderAvatarEl = document.getElementById('chat-header-avatar');
                         if(chatTitleNameEl) chatTitleNameEl.textContent = 'é€‰æ‹©è”ç³»äºº';
                         if(chatHeaderAvatarEl) chatHeaderAvatarEl.style.display = 'none';
                   }
             }
        }

        function renderTeamPage() {
             console.log('æ¸²æŸ“å›¢é˜Ÿé¡µé¢');
             DataSystem.UIUpdater.updateTeamText(gameState.team); // ä½¿ç”¨æœ€æ–°çŠ¶æ€æ¸²æŸ“
        }

        // Plan Page: renderTaskList, filterTasks, updateTaskCounts å·²å­˜åœ¨

        // Song Page: renderSongOptions, updateSongSummary å·²å­˜åœ¨

        // Summary Page: renderStorySummaryPage å·²å­˜åœ¨
        function renderStorySummaryPage() {
            console.log("å¼€å§‹æ¸²æŸ“æ•…äº‹æ€»ç»“é¡µé¢ (å †å å¡ç‰‡é£æ ¼)...");
            const summaryListContainer = document.getElementById('storySummaryList');
            if (!summaryListContainer) {
                 console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ•…äº‹æ€»ç»“åˆ—è¡¨å®¹å™¨ #storySummaryList");
                 return;
            }
             summaryListContainer.classList.remove('list-group');
             summaryListContainer.classList.add('summary-stack');
             summaryListContainer.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

             const summaries = Array.isArray(gameState.storySummary) ? gameState.storySummary : [];
             console.log(`å‡†å¤‡æ¸²æŸ“æ•…äº‹æ€»ç»“ï¼Œå…± ${summaries.length} æ¡`);

             if (summaries.length > 0) {
                  // ä¸éœ€è¦é‡æ–°æ’åºï¼Œå‡è®¾ updateGameState ä¸­å·²æ’åº
                  summaries.forEach(item => {
                       if (item && typeof item.id === 'number' && typeof item.content === 'string' && item.content.trim() !== '') {
                           summaryListContainer.innerHTML += `
                               <div class="summary-entry card">
                                   <div class="card-content-wrapper">
                                     <div class="entry-meta">
                                       <span class="entry-id">è®°å½• #${item.id}</span>
                                     </div>
                                     <div class="entry-content">
                                       <p>${item.content.replace(/\n/g, '<br>')}</p> <!-- æ›¿æ¢æ¢è¡Œä¸ºbr -->
                                     </div>
                                   </div>
                               </div>
                           `;
                       } else {
                           console.warn("æ¸²æŸ“æ€»ç»“æ—¶å‘ç°æ— æ•ˆæˆ–ç©ºçš„æ¡ç›®:", item);
                       }
                  });
             } else {
                  summaryListContainer.innerHTML = '<p class="empty-summary-message">è¿˜æ²¡æœ‰å€¼å¾—å›é¡¾çš„æ•…äº‹ç‰‡æ®µå‘¢ã€‚</p>';
             }
              console.log("æ•…äº‹æ€»ç»“åˆ—è¡¨æ¸²æŸ“å®Œæˆã€‚");
        }


        function initTrainingPage() {
             console.log('æ›´æ–°ç‰¹è®­è®¡åˆ’é¡µé¢ç»Ÿè®¡æ•°æ®');
             updateTrainingStats(); // æ›´æ–°ç»Ÿè®¡æ•°æ®
             // ä¸éœ€è¦åˆå§‹åŒ–è¿›åº¦æ¡åŠ¨ç”»ï¼Œå› ä¸ºç§»é™¤äº†è¿›åº¦æ¡æ˜¾ç¤º
             // initProgressBars();
        }


        // --- Story Actions ---
        async function selectStoryOption(optionNumber, buttonElement, isDefault = false) {
            const optionIndex = optionNumber - 1;
            let optionsSource = isDefault ? [
                 "å¸¦å¤§å®¶åˆ°ç»ƒä¹ å®¤æ’ç»ƒæ–°æ­Œ",
                 "å®£å¸ƒæ˜å¤©è¯·å®¢åƒé¥­",
                 "å®å˜±å¤§å®¶æ³¨æ„èº«ä½“"
            ] : (gameState.story?.options || []);
            let selectedOptionText = (optionIndex >= 0 && optionIndex < optionsSource.length) ? optionsSource[optionIndex] : null;

            if (!selectedOptionText) {
                 console.error("é€‰æ‹©çš„é€‰é¡¹æ— æ•ˆ:", optionNumber, "isDefault:", isDefault, "Source:", optionsSource);
                 alert("é€‰æ‹©çš„é€‰é¡¹æ— æ•ˆï¼");
                 // enableInteractions(); // finally ä¸­ä¼šå¤„ç†
                 return;
            }
             console.log(`ç©å®¶é€‰æ‹©äº†é€‰é¡¹ ${optionNumber}: ${selectedOptionText}`);

            showLoadingIndicator("å¤„ç†é€‰é¡¹ä¸­...");
            disableInteractions();
             if(buttonElement) buttonElement.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.2)';

            try {
                 await toggleWorldBookEntries(['COT', 'æ ¼å¼è¦æ±‚'], ['COTï¼ˆchatï¼‰']);
                 await autoSaveToWorldBook();

                 // è·å–æ•…äº‹æ€»ç»“ä¸Šä¸‹æ–‡
                 let summaryContext = "ã€æœ€è¿‘çš„æ•…äº‹æ€»ç»“å›é¡¾ã€‘\n";
                 const summaries = Array.isArray(gameState.storySummary) ? gameState.storySummary : [];
                 if (summaries.length > 0) {
                      const recentSummaries = summaries.slice(-3);
                      summaryContext += recentSummaries.length > 0
                           ? recentSummaries.map(s => `${s.id}. ${s.content}`).join('\n')
                           : "æš‚æ— æ€»ç»“ã€‚";
                 } else { summaryContext += "æš‚æ— æ€»ç»“ã€‚"; }
                 summaryContext += "\n";

                // æ„å»ºæ³¨å…¥çš„ç³»ç»ŸæŒ‡ä»¤
                const systemInstruction = `--- CORE ACTION THIS TURN ---\n` +
                                         `**Player Character Action:** {{user}} chose the following option:\n` +
                                         `**Action Text:** "${selectedOptionText}"\n` +
                                         `**Instruction:** This decision is the **ABSOLUTE FOCUS** for this turn's response. You **MUST** generate the narrative and game state update based *directly* on this specific action being taken *now*. Do **NOT** generate alternative plot progressions or ignore this action.\n\n` +
                                         `--- Execution Context & Guidelines ---\n` +
                                         `${summaryContext}\n` + // å°†æ€»ç»“æ”¾å…¥æŒ‡ä»¤ä¸­
                                         `ã€<å›å¤æ ¼å¼> æŒ‡ä»¤ã€‘\n` + // å¼•ç”¨å¤–éƒ¨çš„ CoT/å›å¤æ ¼å¼
                                         `Please strictly follow the rules defined in \`<å›å¤æ ¼å¼>\` (your CoT, Thinking Format v3.0). Specifically:\n` +
                                         `1. Narrative MUST show the Action Text above being acted upon immediately.\n` +
                                         `2. Depict realistic NPC reactions to *this specific decision*.\n` +
                                         `3. Calculate state changes (mood, affection, funds if applicable, chapter, next options) directly resulting from *this decision*.\n` +
                                         `4. Output ONLY the \`<gametext>\` containing the *complete* updated game state reflecting the consequences of this action.\n`;

                console.log("System Instruction for generate:", systemInstruction);

                // è°ƒç”¨ generateï¼Œå°†ç©å®¶é€‰é¡¹æ–‡æœ¬æ”¾å…¥ user_inputï¼ŒæŒ‡ä»¤æ”¾å…¥ injects
                const rawLLMResponse = await generate({
                    user_input: selectedOptionText, // ç”¨æˆ·çš„é€‰æ‹©ä½œä¸º user_input
                    should_stream: false,
                    injects: [ // å…¶ä»–ä¸Šä¸‹æ–‡å’ŒæŒ‡ä»¤æ”¾å…¥ injects
                        {
                            role: 'system',
                            content: systemInstruction,
                            position: 'before_prompt', // æ”¾åœ¨æœ€å‰é¢å¼ºè°ƒ
                            depth: 0, // ä¸»æŒ‡ä»¤é€šå¸¸æ·±åº¦ä¸º0
                            should_scan: false // æŒ‡ä»¤ä¸éœ€è¦æ‰«æä¸–ç•Œä¹¦
                        }
                    ],
                    // max_chat_history: 'all' // æˆ–è€…æ ¹æ®éœ€è¦é™åˆ¶
                });

                console.log("æ”¶åˆ° LLM åŸå§‹å“åº” (å‰§æƒ…é€‰é¡¹):", rawLLMResponse);

                // --- (åç»­è§£æ gametext å’Œæ›´æ–°çŠ¶æ€çš„é€»è¾‘ä¸å˜) ---
                let newGameData = null;
                let messageToSave = rawLLMResponse;
                const extractedJsonString = extractGameText(rawLLMResponse);

                if (extractedJsonString) {
                    console.log("[è§£æé˜¶æ®µ] å‡†å¤‡è§£æ:", extractedJsonString);
                    try {
                        newGameData = JSON.parse(extractedJsonString);
                        messageToSave = `<gametext>${extractedJsonString}</gametext>`;
                        console.log("[è§£æé˜¶æ®µ] JSON è§£ææˆåŠŸã€‚");
                    } catch (parseError) {
                        console.error("[è§£æé˜¶æ®µ] JSON è§£æå¤±è´¥:", parseError);
                        console.error("å¤±è´¥æ—¶å°è¯•è§£æçš„å­—ç¬¦ä¸²:", extractedJsonString);
                        alert(`è§£ææ¸¸æˆçŠ¶æ€æ—¶å‡ºé”™: ${parseError.message}. LLM å¯èƒ½è¿”å›äº†æ— æ•ˆçš„æ ¼å¼ã€‚`);
                        newGameData = null;
                    }
                } else {
                    console.error("æœªèƒ½ä» LLM å“åº”ä¸­æå–æœ‰æ•ˆçš„ <gametext>{...}</gametext> å—ã€‚");
                    if (rawLLMResponse && !rawLLMResponse.includes('<gametext>') && !rawLLMResponse.includes('{') && rawLLMResponse.trim().length > 5) {
                         console.warn("å“åº”ä¸­æ—  gametext æˆ– JSONï¼Œå°è¯•ä½œä¸ºæ—ç™½å¤„ç†ã€‚");
                         newGameData = structuredClone(gameState);
                         newGameData.story.dialogue = newGameData.story.dialogue || [];
                         newGameData.story.dialogue.push({ speaker: "æ—ç™½", content: rawLLMResponse.trim(), style: "normal" });
                         newGameData.story.options = [];
                         messageToSave = `<gametext>${JSON.stringify(newGameData)}</gametext>`;
                    } else {
                        alert("å¤„ç†å¤±è´¥ï¼šæ— æ³•ä»å›å¤ä¸­è·å–æœ‰æ•ˆçš„æ¸¸æˆçŠ¶æ€æ•°æ®ã€‚");
                        newGameData = null;
                    }
                }

                if (newGameData) {
                    updateGameState(newGameData);
                    console.log("æ¸¸æˆçŠ¶æ€å’ŒUIå·²æ›´æ–°ã€‚å‡†å¤‡é™é»˜ä¿å­˜...");
                    if (typeof setChatMessage === 'function') {
                        await setChatMessage({ message: messageToSave }, 0, { refresh: 'none' });
                        console.log("é™é»˜ä¿å­˜å®Œæˆã€‚");
                    } else {
                        console.warn("setChatMessage å‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•é™é»˜ä¿å­˜ã€‚");
                    }
                } else {
                    console.error("ç”±äºæå–æˆ–è§£æå¤±è´¥ï¼Œæœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„ newGameDataï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°å’Œä¿å­˜ã€‚");
                }
                // --- (ç»“æŸ) ---

            } catch (error) {
                 console.error("å¤„ç†å‰§æƒ…é€‰é¡¹æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯:", error);
                 alert(`å¤„ç†é€‰é¡¹æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}\nè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚`);
            } finally {
                 hideLoadingIndicator();
                 enableInteractions();
                 if (buttonElement) buttonElement.style.backgroundColor = '';
                 console.log("selectStoryOption finally block executed.");
            }
        }
        
        async function selectCustomOption(customText, optionsListElement) {
            console.log(`ç©å®¶è¾“å…¥äº†è‡ªå®šä¹‰é€‰é¡¹: ${customText}`);

            showLoadingIndicator("å¤„ç†æ‚¨çš„æƒ³æ³•ä¸­...");
            disableInteractions();

            try {
                await toggleWorldBookEntries(['COT', 'æ ¼å¼è¦æ±‚'], ['COTï¼ˆchatï¼‰']);
                await autoSaveToWorldBook();

                // è·å–æ•…äº‹æ€»ç»“ä¸Šä¸‹æ–‡
                let summaryContext = "ã€æœ€è¿‘çš„æ•…äº‹æ€»ç»“å›é¡¾ã€‘\n";
                const summaries = Array.isArray(gameState.storySummary) ? gameState.storySummary : [];
                if (summaries.length > 0) {
                    const recentSummaries = summaries.slice(-3);
                    summaryContext += recentSummaries.length > 0
                        ? recentSummaries.map(s => `${s.id}. ${s.content}`).join('\n')
                        : "æš‚æ— æ€»ç»“ã€‚";
                } else { summaryContext += "æš‚æ— æ€»ç»“ã€‚"; }
                summaryContext += "\n";

                // æ„å»ºæ³¨å…¥çš„ç³»ç»ŸæŒ‡ä»¤
                const systemInstruction = `--- CORE ACTION THIS TURN ---\n` +
                                         `**Player Character Action:** {{user}} decided based on their own thought:\n` +
                                         `**Action Text/Thought:** "${customText}"\n` +
                                         `**Instruction:** This decision/thought is the ABSOLUTE FOCUS for this turn's response. You MUST generate the narrative and game state update based *directly* on this specific action being taken *now*. Do NOT generate alternative plot progressions or ignore this action.\n\n` +
                                         `--- Execution Context & Guidelines ---\n` +
                                         `${summaryContext}\n` +
                                         `ã€<å›å¤æ ¼å¼> æŒ‡ä»¤ã€‘\n` + // å¼•ç”¨å¤–éƒ¨çš„ CoT/å›å¤æ ¼å¼
                                         `Please strictly follow the rules defined in \`<å›å¤æ ¼å¼>\` (your CoT, Thinking Format v3.0). Specifically:\n` +
                                         `1. Narrative MUST show the Action Text/Thought above being acted upon immediately (or internal reaction if it's just a thought).\n`+
                                         `2. Depict realistic NPC reactions to *this specific decision*.\n` +
                                         `3. Calculate state changes (mood, affection, funds if applicable, chapter, next options) directly resulting from *this decision*.\n` +
                                         `4. Output ONLY the \`<gametext>\` containing the *complete* updated game state reflecting the consequences of this action.\n`;

                console.log("System Instruction for generate:", systemInstruction);

                // è°ƒç”¨ generateï¼Œå°†ç©å®¶è‡ªå®šä¹‰æ–‡æœ¬æ”¾å…¥ user_inputï¼ŒæŒ‡ä»¤æ”¾å…¥ injects
                const rawLLMResponse = await generate({
                    user_input: customText, // ç©å®¶çš„è‡ªå®šä¹‰è¾“å…¥ä½œä¸º user_input
                    should_stream: false,
                    injects: [ // å…¶ä»–ä¸Šä¸‹æ–‡å’ŒæŒ‡ä»¤æ”¾å…¥ injects
                        {
                            role: 'system',
                            content: systemInstruction,
                            position: 'before_prompt',
                            depth: 0,
                            should_scan: false
                        }
                    ]
                    // max_chat_history: 'all'
                });

                console.log("æ”¶åˆ° LLM åŸå§‹å“åº” (è‡ªå®šä¹‰é€‰é¡¹):", rawLLMResponse);

                // --- (åç»­è§£æ gametext å’Œæ›´æ–°çŠ¶æ€çš„é€»è¾‘ä¸å˜) ---
                let newGameData = null;
                let messageToSave = rawLLMResponse;
                const extractedJsonString = extractGameText(rawLLMResponse);

                if (extractedJsonString) {
                    console.log("[è§£æé˜¶æ®µ] å‡†å¤‡è§£æ:", extractedJsonString);
                    try {
                        newGameData = JSON.parse(extractedJsonString);
                        messageToSave = `<gametext>${extractedJsonString}</gametext>`;
                        console.log("[è§£æé˜¶æ®µ] JSON è§£ææˆåŠŸã€‚");
                    } catch (parseError) {
                        console.error("[è§£æé˜¶æ®µ] JSON è§£æå¤±è´¥:", parseError);
                        console.error("å¤±è´¥æ—¶å°è¯•è§£æçš„å­—ç¬¦ä¸²:", extractedJsonString);
                        alert(`è§£ææ¸¸æˆçŠ¶æ€æ—¶å‡ºé”™: ${parseError.message}. LLM å¯èƒ½è¿”å›äº†æ— æ•ˆçš„æ ¼å¼ã€‚`);
                        newGameData = null;
                    }
                } else {
                    console.error("æœªèƒ½ä» LLM å“åº”ä¸­æå–æœ‰æ•ˆçš„ <gametext>{...}</gametext> å—ã€‚");
                    if (rawLLMResponse && !rawLLMResponse.includes('<gametext>') && !rawLLMResponse.includes('{') && rawLLMResponse.trim().length > 5) {
                         console.warn("å“åº”ä¸­æ—  gametext æˆ– JSONï¼Œå°è¯•ä½œä¸ºæ—ç™½å¤„ç†ã€‚");
                         newGameData = structuredClone(gameState);
                         newGameData.story.dialogue = newGameData.story.dialogue || [];
                         newGameData.story.dialogue.push({ speaker: "æ—ç™½", content: rawLLMResponse.trim(), style: "normal" });
                         newGameData.story.options = [];
                         messageToSave = `<gametext>${JSON.stringify(newGameData)}</gametext>`;
                    } else {
                        alert("å¤„ç†å¤±è´¥ï¼šæ— æ³•ä»å›å¤ä¸­è·å–æœ‰æ•ˆçš„æ¸¸æˆçŠ¶æ€æ•°æ®ã€‚");
                        newGameData = null;
                    }
                }

                if (newGameData) {
                    updateGameState(newGameData);
                    console.log("æ¸¸æˆçŠ¶æ€å’ŒUIå·²æ›´æ–°ã€‚å‡†å¤‡é™é»˜ä¿å­˜...");
                    if (typeof setChatMessage === 'function') {
                         await setChatMessage({ message: messageToSave }, 0, { refresh: 'none' });
                         console.log("é™é»˜ä¿å­˜å®Œæˆã€‚");
                    } else {
                         console.warn("setChatMessage å‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•é™é»˜ä¿å­˜ã€‚");
                    }
                } else {
                    console.error("ç”±äºæå–æˆ–è§£æå¤±è´¥ï¼Œæœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„ newGameDataï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°å’Œä¿å­˜ã€‚");
                }
                // --- (ç»“æŸ) ---

            } catch (error) {
                 console.error("å¤„ç†è‡ªå®šä¹‰é€‰é¡¹æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯:", error);
                 alert(`å¤„ç†ä½ çš„æƒ³æ³•æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}\nè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚`);
            } finally {
                 hideLoadingIndicator();
                 enableInteractions();
                 const submitBtn = document.getElementById('submitCustomOptionBtn');
                 if (submitBtn) submitBtn.innerHTML = 'ç¡®å®š';
                 const customInput = document.getElementById('customOptionInput');
                 if (customInput) customInput.value = '';
                 console.log("selectCustomOption finally block executed.");
            }
        }
        function toggleOptionsPanel(show) {
            const optionsContainer = document.querySelector('.interaction-options');
            if (optionsContainer) {
                optionsContainer.style.display = show ? 'block' : 'none';
            }
        }

        // ã€æ–°å¢ã€‘æ˜¾ç¤ºå†å²è®°å½•æ¨¡æ€æ¡†çš„å‡½æ•°
        async function showHistoryModal() {
            console.log('æ‰“å¼€æ•…äº‹è¿›å±•æ¨¡æ€æ¡†...');
            showLoadingIndicator("åŠ è½½å†å²è®°å½•..."); // æ˜¾ç¤ºåŠ è½½æç¤º

            // ç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„æ—§æ¨¡æ€æ¡†
            const existingModal = document.getElementById('historyModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'historyModal';
            modal.className = 'chapter-modal';

            const modalContent = document.createElement('div');
            modalContent.className = 'chapter-modal-content';

            const modalHeader = document.createElement('div');
            modalHeader.className = 'chapter-modal-header';
            modalHeader.innerHTML = `
                <h3>æ•…äº‹è¿›å±•</h3>
                <button class="close-btn close-history-modal">Ã—</button>
            `;

            const modalBody = document.createElement('div');
            modalBody.className = 'chapter-modal-body';

            // --- å¡«å……æ¨¡æ€æ¡†å†…å®¹ ---
             // 1. æ·»åŠ å½“å‰ç« èŠ‚æ ‡é¢˜
             if (gameState.story && gameState.story.currentChapter) {
                  const chapterTitleEl = document.createElement('div');
                  chapterTitleEl.className = 'chapter-title mb-3';
                  chapterTitleEl.innerHTML = `<h4>å½“å‰ç« èŠ‚: ${gameState.story.currentChapter}</h4>`;
                  modalBody.appendChild(chapterTitleEl);
             }

            // 2. æ·»åŠ å¯¹è¯å†å²è®°å½•
            const dialogueHistoryContainer = document.createElement('div');
            dialogueHistoryContainer.id = 'modal-dialogue-history';
            dialogueHistoryContainer.style.marginBottom = '2rem';
            dialogueHistoryContainer.style.maxHeight = '40vh'; // é™åˆ¶å¯¹è¯å†å²é«˜åº¦
            dialogueHistoryContainer.style.overflowY = 'auto'; // æ·»åŠ æ»šåŠ¨æ¡

            if (TextSystem.dialogueHistory && TextSystem.dialogueHistory.length > 0) {
                 // åªæ˜¾ç¤ºæœ€è¿‘ N æ¡ï¼Œä¾‹å¦‚ 50 æ¡ï¼Œé¿å…æ¨¡æ€æ¡†è¿‡é•¿
                 const recentHistory = TextSystem.dialogueHistory.slice(-50);
                recentHistory.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    if (item.speaker === 'æ—ç™½') {
                        historyItem.innerHTML = `<div class="history-text narrator">${item.content}</div>`;
                    } else {
                        historyItem.innerHTML = `<div class="history-text"><strong>${item.speaker}:</strong> ${item.content}</div>`;
                    }
                    dialogueHistoryContainer.appendChild(historyItem);
                });
            } else {
                dialogueHistoryContainer.innerHTML = '<p class="text-muted">æš‚æ— å¯¹è¯è®°å½•ã€‚</p>';
            }
            modalBody.appendChild(dialogueHistoryContainer);

             // 3. æ·»åŠ ç« èŠ‚åˆ—è¡¨å®¹å™¨ï¼ˆç¨åç”± displayChapterList å¡«å……ï¼‰
             const chapterListPlaceholder = document.createElement('div');
             chapterListPlaceholder.id = 'modal-chapter-list-placeholder';
             modalBody.appendChild(chapterListPlaceholder);


            // --- ç»„è£…æ¨¡æ€æ¡† ---
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modal.appendChild(modalContent);

            // --- æ·»åŠ å…³é—­äº‹ä»¶ ---
            const closeModal = () => { /* ... ä¿æŒä¸å˜ ... */
                const modalToClose = document.getElementById('historyModal');
                if (modalToClose) {
                    document.body.classList.remove('modal-open');
                    modalToClose.remove();
                     document.removeEventListener('keydown', handleEscKey); // ç§»é™¤ ESC ç›‘å¬
                }
            };
            modal.querySelectorAll('.close-history-modal').forEach(btn => btn.addEventListener('click', closeModal));
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            modalContent.addEventListener('click', e => e.stopPropagation());
            const handleEscKey = (e) => { if (e.key === 'Escape') closeModal(); };
            document.addEventListener('keydown', handleEscKey);

            // --- æ˜¾ç¤ºæ¨¡æ€æ¡† ---
            document.body.classList.add('modal-open');
            document.body.appendChild(modal);

            // --- å¼‚æ­¥åŠ è½½ç« èŠ‚åˆ—è¡¨ ---
            try {
                 if (typeof TextSystem.displayChapterList === 'function') {
                     console.log('æ­£åœ¨åŠ è½½ç« èŠ‚åˆ—è¡¨åˆ°æ¨¡æ€æ¡†...');
                      await TextSystem.displayChapterList("æ˜æ˜Ÿçš„è¯ç”Ÿ", chapterListPlaceholder); // ä¼ å…¥å ä½ç¬¦å®¹å™¨
                 } else {
                      console.error("TextSystem.displayChapterList å‡½æ•°æœªå®šä¹‰ï¼");
                      chapterListPlaceholder.innerHTML = '<p class="text-danger">æ— æ³•åŠ è½½ç« èŠ‚åˆ—è¡¨ã€‚</p>';
                 }
            } catch (error) {
                 console.error("åŠ è½½ç« èŠ‚åˆ—è¡¨æ—¶å‡ºé”™:", error);
                 chapterListPlaceholder.innerHTML = `<p class="text-danger">åŠ è½½ç« èŠ‚åˆ—è¡¨å¤±è´¥: ${error.message}</p>`;
            } finally {
                 hideLoadingIndicator(); // éšè—åŠ è½½æç¤º
                  // å¯¹è¯å†å²æ»šåŠ¨åˆ°åº•éƒ¨ (å¦‚æœå†…å®¹å¤šçš„è¯)
                 dialogueHistoryContainer.scrollTop = dialogueHistoryContainer.scrollHeight;
            }
        }


        // --- Contact Page Functions ---
        function clearCurrentChat() {
            if (!currentContact) return;
            if (!confirm(`ç¡®å®šè¦æ¸…é™¤ä¸ ${currentContact} çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;

            const contact = gameState.contacts.find(c => c.name === currentContact);
            if (!contact) return;

            contact.messages = [];
            contact.lastMessage = '';
            contact.lastTime = '';
            localStorage.removeItem(`chatHistory_${currentContact}`); // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            window.gameStateChanged = true;

            renderChatContent(currentContact);
            DataSystem.UIUpdater.updateContactText(); // æ›´æ–°åˆ—è¡¨é¢„è§ˆ
            console.log(`${currentContact} çš„èŠå¤©è®°å½•å·²æ¸…é™¤ã€‚`);
        }

        function switchContact(contactName) {
            console.log("åˆ‡æ¢è”ç³»äººè‡³:", contactName);
            if (!contactName) { // å¤„ç†åˆ‡æ¢åˆ°ç©ºè”ç³»äººçš„æƒ…å†µ
                 currentContact = "";
                 // æ¸…ç©ºèŠå¤©åŒºå’Œèµ„æ–™åŒº
                 renderChatContent(null);
                 renderProfile(null);
                  // æ›´æ–°èŠå¤©å¤´éƒ¨
                 const chatTitleNameEl = document.getElementById('chat-title-name');
                 const chatHeaderAvatarEl = document.getElementById('chat-header-avatar');
                 if(chatTitleNameEl) chatTitleNameEl.textContent = 'é€‰æ‹©è”ç³»äºº';
                 if(chatHeaderAvatarEl) chatHeaderAvatarEl.style.display = 'none';
                  // æ›´æ–°åˆ—è¡¨ active çŠ¶æ€
                 document.querySelectorAll('.contact-item').forEach(item => item.classList.remove('active'));
                 return;
            }

            const contact = gameState.contacts.find(c => c.name === contactName);
            if (!contact) {
                 console.error(`é”™è¯¯ï¼šæ‰¾ä¸åˆ°è”ç³»äºº ${contactName}`);
                 return;
            }

            currentContact = contactName;

            // æ›´æ–°åˆ—è¡¨ active çŠ¶æ€
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.toggle('active', item.dataset.contact === contactName);
            });

            // æ¸…é™¤æœªè¯»æ ‡è®° (å¦‚æœéœ€è¦ç«‹å³ç”Ÿæ•ˆ)
            if (contact.unread > 0) {
                 contact.unread = 0;
                 window.gameStateChanged = true; // æ ‡è®°çŠ¶æ€æ”¹å˜
                 DataSystem.UIUpdater.updateContactText(); // ç«‹å³æ›´æ–°åˆ—è¡¨ UI
            }

            // æ›´æ–°èŠå¤©ç•Œé¢æ ‡é¢˜å’Œå¤´åƒ
            const chatTitleNameEl = document.getElementById('chat-title-name');
             const chatHeaderAvatarEl = document.getElementById('chat-header-avatar');
             if(chatTitleNameEl) chatTitleNameEl.textContent = contactName;
             if(chatHeaderAvatarEl){
                  chatHeaderAvatarEl.src = contact.avatar || 'placeholder.png';
                  chatHeaderAvatarEl.alt = contactName;
                  chatHeaderAvatarEl.style.display = 'inline-block'; // æ˜¾ç¤ºå¤´åƒ
                   chatHeaderAvatarEl.onerror = () => { chatHeaderAvatarEl.src = 'placeholder.png'; }; // é”™è¯¯å¤„ç†
             }

            // æ¸²æŸ“èŠå¤©è®°å½•å’Œèµ„æ–™å¡
            renderChatContent(contactName);
            renderProfile(contactName);
        }

        function renderChatContent(contactName) {
            const chatMessagesEl = document.getElementById('chatMessages');
            if (!chatMessagesEl) return;

             // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
             chatMessagesEl.innerHTML = '';

             if (!contactName) { // æ²¡æœ‰é€‰æ‹©è”ç³»äºº
                  chatMessagesEl.innerHTML = '<div class="message-system"><span>é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©ã€‚</span></div>';
                  return;
             }

            const contact = gameState.contacts.find(c => c.name === contactName);
             if (!contact) {
                  chatMessagesEl.innerHTML = `<div class="message-system"><span>æ— æ³•åŠ è½½ ${contactName} çš„èŠå¤©è®°å½•ã€‚</span></div>`;
                  return;
             }


            const messages = contact.messages || [];
            if (messages.length === 0) {
                chatMessagesEl.innerHTML = `<div class="message-system"><span>ä¸ ${contactName} å¼€å§‹æ–°çš„å¯¹è¯å§ï¼</span></div>`;
            } else {
                // æ·»åŠ æ—¥æœŸåˆ†éš”ç¬¦é€»è¾‘ (ç®€åŒ–)
                let lastDateStr = '';
                messages.forEach(message => {
                     let messageDate = new Date(); // é»˜è®¤ä»Šå¤©
                     // å°è¯•ä» message.time è§£ææ—¥æœŸï¼Œå¦‚æœå¤±è´¥åˆ™å¿½ç•¥æ—¥æœŸåˆ†éš”
                     // (æ›´å¯é çš„æ–¹å¼æ˜¯åœ¨ä¿å­˜æ¶ˆæ¯æ—¶å­˜å‚¨å®Œæ•´æ—¶é—´æˆ³)
                     const currentDateStr = messageDate.toLocaleDateString();
                     if (currentDateStr !== lastDateStr) {
                          chatMessagesEl.innerHTML += `<div class="message-date"><span>${currentDateStr}</span></div>`;
                          lastDateStr = currentDateStr;
                     }

                     let messageHtml = '';
                     const timeStr = message.time || formatMessageTime(); // ç¡®ä¿æœ‰æ—¶é—´
                      // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– placeholder
                      const avatarSrc = (contact.avatar && typeof contact.avatar === 'string' && contact.avatar.length > 5) ? contact.avatar : 'placeholder.png';

                      switch (message.type) {
                          case 'system':
                               messageHtml = `<div class="message-system"><span>${message.content || ''}</span></div>`;
                               break;
                          case 'sent':
                               messageHtml = `
                                   <div class="chat-message sent">
                                       <div class="message-content">
                                           <div class="message-text">${message.content || ''}</div>
                                           <div class="message-time">${timeStr}</div>
                                       </div>
                                   </div>`;
                               break;
                          case 'received':
                          default:
                               // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– PLACEHOLDER_IMG (åœ¨è¿™é‡Œå†æ¬¡ç¡®è®¤)
                               const messageAvatarSrc = (avatarSrc && typeof avatarSrc === 'string' && avatarSrc.trim() !== '') ? avatarSrc : PLACEHOLDER_IMG; // ä½¿ç”¨å¸¸é‡
                               messageHtml = `
                                   <div class="chat-message received">
                                       <img src="${messageAvatarSrc}" alt="${contact.name}" class="message-avatar" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;">
                                       <div class="message-content">
                                           <div class="message-text">${message.content || ''}</div>
                                           <div class="message-time">${timeStr}</div>
                                       </div>
                                   </div>`;
                               break;
                     }
                     chatMessagesEl.innerHTML += messageHtml;
                });
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
             requestAnimationFrame(() => { // å»¶è¿Ÿæ»šåŠ¨ç¡®ä¿ DOM æ›´æ–°
                  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
             });
        }

        function renderProfile(contactName) { // (ä¿æŒä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå·²åŒ…å«å¥å£®æ€§æ£€æŸ¥)
            const memberProfileEl = document.getElementById('memberProfile');
            if (!memberProfileEl) return;

            if (!contactName) { // å¤„ç†æœªé€‰æ‹©è”ç³»äººçš„æƒ…å†µ
                 memberProfileEl.innerHTML = `<div class="empty-profile"><i class="fas fa-user fa-3x"></i><p>é€‰æ‹©ä¸€ä¸ªè”ç³»äººæŸ¥çœ‹è¯¦ç»†èµ„æ–™</p></div>`;
                 return;
            }

            const contact = gameState.contacts.find(c => c.name === contactName);
            if (!contact || contact.isGroup) {
                 memberProfileEl.innerHTML = `<div class="empty-profile"><i class="fas ${contact?.isGroup ? 'fa-users' : 'fa-user'} fa-3x"></i><p>${contact?.isGroup ? 'ç¾¤èŠä¿¡æ¯' : 'æ— æ³•åŠ è½½è¯¥è”ç³»äººèµ„æ–™'}</p></div>`;
                 return;
            }

            // è·å–è§’è‰²æ•°æ® (ä¼˜å…ˆ CharacterSystem, å† gameState.team.members, æœ€å gameState.contacts)
            const character = CharacterSystem.getCharacter(contact.id);
            const teamMember = gameState.team?.members?.find(m => m.id === contact.id || m.name === contactName); // å¢åŠ  name åŒ¹é…
            const profileData = character || teamMember || contact; // åˆå¹¶æ•°æ®æº

            // å¤„ç†æŠ€èƒ½ stats (ç¡®ä¿å­˜åœ¨ä¸”ä¸ºæ•°å­—)
            const skills = profileData.stats || profileData.skills || {};
            const getSkill = (key) => (skills[key] !== undefined && !isNaN(Number(skills[key]))) ? Number(skills[key]) : 'N/A';

            const tags = Array.isArray(profileData.tags) ? profileData.tags : [];
            const mood = profileData.mood !== undefined ? profileData.mood : 50;
            const affection = profileData.affection !== undefined ? profileData.affection : 0;
             // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– PLACEHOLDER_IMG
             const avatarSrc = (profileData.avatar && typeof profileData.avatar === 'string' && profileData.avatar.trim() !== '') ? profileData.avatar : PLACEHOLDER_IMG; // ä½¿ç”¨å¸¸é‡


            memberProfileEl.innerHTML = `
                <div class="profile-header">
                    <div class="avatar-container position-relative">
                       <img src="${avatarSrc}" alt="${contactName}" class="profile-avatar" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;">
                        <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0" id="changeAvatarBtn" style="border-radius: 50%; width: 32px; height: 32px; padding: 0; margin: 0 5px 5px 0;"><i class="fas fa-camera"></i></button>
                        <input type="file" id="avatarFileInput" style="display:none" accept="image/*">
                    </div>
                    <h3>${profileData.fullName || contactName}</h3>
                    <p class="text-muted">${profileData.role || 'æˆå‘˜'}</p>
                    <div class="profile-tags">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>
                </div>
                <div class="profile-stats">
                    <div class="stat-item"><div class="stat-value">${getSkill('vocal')}</div><div class="stat-label">å£°ä¹</div></div>
                    <div class="stat-item"><div class="stat-value">${getSkill('dance')}</div><div class="stat-label">èˆè¹ˆ</div></div>
                    <div class="stat-item"><div class="stat-value">${getSkill('performance')}</div><div class="stat-label">è¡¨æ¼”</div></div>
                    <div class="stat-item"><div class="stat-value">${getSkill('charm')}</div><div class="stat-label">é­…åŠ›</div></div>
                    <div class="stat-item"><div class="stat-value">${getSkill('variety')}</div><div class="stat-label">ç»¼è‰ºæ„Ÿ</div></div>
                </div>
                <div class="profile-stats mt-3">
                    <div class="stat-item"><div class="stat-value" style="color: #ff6b6b;">${mood}</div><div class="stat-label">å¿ƒæƒ…å€¼</div></div>
                    <div class="stat-item"><div class="stat-value" style="color: #ff4081;">${affection}</div><div class="stat-label">å¥½æ„Ÿåº¦</div></div>
                </div>
                <div class="profile-info">
                    ${profileData.bio ? `<h4>ä¸ªäººç®€ä»‹</h4><p>${profileData.bio}</p>` : ''}
                    ${profileData.profile ? `<h4>è¯¦ç»†èµ„æ–™</h4><p>${profileData.profile.replace(/\n/g, '<br>')}</p>` : ''}
                    ${profileData.interests ? `<h4>å…´è¶£çˆ±å¥½</h4><p>${profileData.interests}</p>` : ''}
                    ${profileData.relationships ? `<h4>å…³ç³»</h4><p>${profileData.relationships}</p>` : ''}
                    ${profileData.recentStatus ? `<h4>æœ€è¿‘çŠ¶æ€</h4><p>${profileData.recentStatus}</p>` : ''}
                </div>
            `;

             // ç»‘å®šå¤´åƒä¸Šä¼ äº‹ä»¶ (ä¿æŒä¸å˜)
            const changeAvatarBtn = document.getElementById('changeAvatarBtn');
            const avatarFileInput = document.getElementById('avatarFileInput');
             if (changeAvatarBtn && avatarFileInput) { /* ... äº‹ä»¶ç»‘å®šé€»è¾‘ ... */
                 changeAvatarBtn.addEventListener('click', () => avatarFileInput.click());
                 avatarFileInput.addEventListener('change', (e) => {
                      if (e.target.files && e.target.files[0]) {
                           const file = e.target.files[0];
                           const reader = new FileReader();
                           reader.onload = (event) => {
                                const avatarDataUrl = event.target.result;
                                updateCharacterAvatar(contact.id, avatarDataUrl); // æ›´æ–°æ•°æ®å’Œå­˜å‚¨
                                const profileAvatar = memberProfileEl.querySelector('.profile-avatar');
                                if (profileAvatar) profileAvatar.src = avatarDataUrl; // æ›´æ–°å½“å‰æ˜¾ç¤º
                                alert('å¤´åƒæ›´æ–°æˆåŠŸï¼');
                           };
                           reader.readAsDataURL(file);
                           avatarFileInput.value = ''; // æ¸…ç©ºï¼Œå…è®¸å†æ¬¡é€‰æ‹©åŒä¸ªæ–‡ä»¶
                      }
                 });
             }
        }

           // ã€æ³¨æ„ã€‘è¿™æ˜¯å®Œæ•´çš„ sendMessage å‡½æ•°ï¼Œè¯·æ›¿æ¢æ‰ä½ åŸæ¥çš„æ•´ä¸ªå‡½æ•°
             // ã€æœ€ç»ˆä¿®æ­£ç‰ˆ v3 - sendMessage - ä¿®æ­£ generate è°ƒç”¨å‰çš„æ£€æŸ¥ã€‘
                    // ã€æœ€ç»ˆä¿®æ­£ç‰ˆ v5 - sendMessage - ç²¾ç¡®ä½¿ç”¨ Overrides å’Œ Injectsã€‘
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim(); // ç©å®¶çš„è¾“å…¥
            const contactName = currentContact;

            if (!content || !contactName) return;

            const contact = gameState.contacts.find(c => c.name === contactName);
            if (!contact || contact.isGroup) {
                alert(contact?.isGroup ? "æš‚ä¸æ”¯æŒå‘ç¾¤ç»„å‘é€æ¶ˆæ¯ã€‚" : "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äººã€‚");
                return;
            }

            // === ç”¨æˆ·æ¶ˆæ¯å¤„ç†å’ŒUIæ›´æ–° (ä¸å˜) ===
            const timeStr = formatMessageTime();
            const userMessage = { type: 'sent', content: content, time: timeStr };
            if (!contact.messages) { contact.messages = []; }
            contact.messages.push(userMessage);
            contact.lastMessage = `ä½ : ${content}`;
            contact.lastTime = timeStr;
            window.gameStateChanged = true;
            saveChatHistory(contactName, contact.messages);
            renderChatContent(contactName); // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            DataSystem.UIUpdater.updateContactText();
            messageInput.value = '';
            // === ç»“æŸ ===

            showLoadingIndicator("ç­‰å¾…å›å¤ä¸­...");
            disableInteractions();
            const placeholderId = `ai-response-${Date.now()}`;
            const chatMessagesEl = document.getElementById('chatMessages');
            let streamListener = null;
            let endListener = null;
            let accumulatedResponse = "";

            try {
                // åˆ‡æ¢ä¸–ç•Œä¹¦ï¼ˆå¦‚æœéœ€è¦ï¼ŒèŠå¤© CoT å¯èƒ½é€šè¿‡ WI è®¾ç½®æ›´ä½³ï¼‰
                // await toggleWorldBookEntries(['COTï¼ˆchatï¼‰'], ['COT', 'æ ¼å¼è¦æ±‚']);

                // === æ„å»º generate å‡½æ•°çš„é…ç½® ===

                // 1. å‡†å¤‡ Overrides (è¦†ç›–é»˜è®¤æç¤ºè¯å†…å®¹)
                const overrides = {};
                //   a. è·å–è§’è‰²è¯¦æƒ… (å¯é€‰ï¼Œæ”¾å…¥ char_description æˆ– personality?)
                let charDescOverride = ""; // å¯ä»¥å°è¯•å°†è§’è‰²è¯¦æƒ…æ”¾å…¥æè¿°
                let charPersonalityOverride = contact.personality || ""; // æ˜ç¡®æ€§æ ¼
                try {
                    const lorebookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
                    const targetCommentBase = `æˆå‘˜${contactName}çš„è¯¦ç»†ä¿¡æ¯`;
                    const targetCommentNormalized = targetCommentBase.replace(/\s+/g, '').toLowerCase();
                    if (typeof getLorebookEntries === 'function') {
                        const allEntries = await getLorebookEntries(lorebookName);
                        const foundEntry = allEntries?.find(entry => entry?.comment?.replace(/\s+/g, '').toLowerCase() === targetCommentNormalized);
                        if (foundEntry?.content) {
                            // å¯ä»¥å°†æå–çš„è¯¦æƒ…æ”¾å…¥æè¿°ï¼Œæˆ–è€…åªç”¨æ€§æ ¼å­—æ®µ
                            // charDescOverride = parseEntryContent(foundEntry.content); // å¯èƒ½å¤ªé•¿ï¼Œæ”¾å…¥æè¿°ä¸åˆé€‚
                            console.log("è·å–åˆ°è§’è‰²è¯¦æƒ…ï¼Œå°†ç”¨äºå¯èƒ½çš„è¦†ç›–ã€‚");
                            // å¯ä»¥åœ¨è¿™é‡Œæå–æ›´ç²¾ç®€çš„ä¿¡æ¯è¦†ç›–æ€§æ ¼ç­‰
                        }
                    }
                } catch (loreError) { console.error(`è·å–è§’è‰²è¯¦æƒ… (${contactName}) å‡ºé”™:`, loreError); }
                if (charPersonalityOverride) {
                    overrides.char_personality = charPersonalityOverride; // è¦†ç›–æ€§æ ¼
                }
                // if (charDescOverride) { overrides.char_description = charDescOverride; } // è°¨æ…ä½¿ç”¨

                //   b. è·å–å›¢é˜Ÿä¿¡æ¯ (å¯é€‰ï¼Œæ”¾å…¥ scenario?)
                let npcNationality = contact.nationality || 'æœªçŸ¥';
                let eraInfo = 'æœªçŸ¥';
                try {
                    const worldBookName = "æ˜æ˜Ÿçš„è¯ç”Ÿ";
                    const teamInfoRegex = /å›¢é˜Ÿ.*è¯¦ç»†ä¿¡æ¯/i;
                    if (typeof getLorebookEntries === 'function') {
                        const allEntries = await getLorebookEntries(worldBookName);
                        const teamEntry = allEntries?.find(entry => entry?.comment && teamInfoRegex.test(entry.comment));
                        if (teamEntry?.content) {
                            // ... æå– npcNationality å’Œ eraInfo ...
                            // å¯ä»¥è€ƒè™‘å°†æ—¶ä»£èƒŒæ™¯æ”¾å…¥åœºæ™¯æè¿°
                            // overrides.scenario = `å½“å‰åœºæ™¯è®¾å®šåœ¨ ${eraInfo} å¹´çš„ ${npcNationality}ã€‚${gameState.story.location || ''}`;
                        }
                    }
                } catch (teamLoreError) { console.error("è·å–å›¢é˜Ÿä¿¡æ¯å‡ºé”™:", teamLoreError); }

                //   c. æ„å»ºèŠå¤©å†å² (å¯èƒ½ä¸éœ€è¦è¦†ç›–ï¼Œé™¤éè¦å®Œå…¨è‡ªå®šä¹‰)
                // const historyLimit = 3;
                // const recentMessages = ...;
                // const historyPrompts = recentMessages.map(msg => ({
                //     role: msg.type === 'sent' ? 'user' : 'assistant',
                //     content: msg.content
                // }));
                // overrides.chat_history = { prompts: historyPrompts }; // å¦‚æœè¦å®Œå…¨è¦†ç›–å†å²è®°å½•

                // 2. å‡†å¤‡ Injects (æ³¨å…¥é¢å¤–çš„ç³»ç»ŸæŒ‡ä»¤å’ŒçŠ¶æ€)
                const injections = [];

                //   a. æ³¨å…¥ NPC å½“å‰çŠ¶æ€
                let npcStateText = "ã€NPC å½“å‰çŠ¶æ€ã€‘\n";
                const currentMood = contact.mood;
                const currentAffection = contact.affection;
                npcStateText += `- å¿ƒæƒ…: ${currentMood !== undefined && currentMood !== null ? currentMood : 'æœªçŸ¥'}\n`;
                npcStateText += `- å¥½æ„Ÿåº¦: ${currentAffection !== undefined && currentAffection !== null ? currentAffection : 'æœªçŸ¥'}\n`;
                // å°†å›½ç±å’Œæ—¶ä»£ä½œä¸ºçŠ¶æ€æ³¨å…¥
                npcStateText += `- å›½ç±èƒŒæ™¯: ${npcNationality}\n`;
                npcStateText += `- æ‰€å¤„æ—¶ä»£: ${eraInfo}\n`;
                injections.push({
                    role: 'system',
                    content: npcStateText,
                    position: 'in_chat', // å°è¯•æ³¨å…¥åˆ°èŠå¤©è®°å½•ä¸­ï¼ˆæˆ– before_promptï¼‰
                    depth: 0, // æˆ–è€…ä¸€ä¸ªè¾ƒé«˜çš„æ·±åº¦ï¼Œè®©å®ƒé è¿‘ç”¨æˆ·è¾“å…¥
                    should_scan: false
                });

                //   b. æ³¨å…¥æ ¸å¿ƒå›å¤æŒ‡ä»¤ (å¼•ç”¨å¤–éƒ¨ CoT)
                const coreInstructionText = `--- Instruction ---\n`+
                                           `You MUST generate a relevant reply for "${contactName}" based on the LAST user message in the chat history.\n`+
                                           `Consider the NPC's status (Mood, Affection, Background, Era) provided above.\n`+
                                           `Strictly follow the rules defined in the external \`<å›å¤æ ¼å¼>\` prompt.\n`+ // æ˜ç¡®å¼•ç”¨å¤–éƒ¨æ ¼å¼
                                           `Output ONLY the NPC's reply text enclosed within \`<message1>\` tags.`;
                injections.push({
                    role: 'system',
                    content: coreInstructionText,
                    position: 'before_prompt', // æ”¾åœ¨æœ€å‰é¢å¼ºè°ƒ
                    depth: 0,
                    should_scan: false
                });

                // === ç»“æŸæ„å»ºé…ç½® ===

                // æ·»åŠ å ä½ç¬¦ (ä¸å˜)
                const avatarSrc = (contact.avatar && typeof contact.avatar === 'string' && contact.avatar.length > 5) ? contact.avatar : 'placeholder.png';
                const placeholderHtml = `<div id="${placeholderId}" class="chat-message received ai-typing"><img src="${avatarSrc}" alt="${contactName}" class="message-avatar" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;"><div class="message-content"><div class="message-text"><i>${contactName} æ­£åœ¨è¾“å…¥...</i></div><div class="message-time"></div></div></div>`;
                if (chatMessagesEl) {
                     chatMessagesEl.insertAdjacentHTML('beforeend', placeholderHtml);
                     chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
                } else { throw new Error("èŠå¤©æ¶ˆæ¯å®¹å™¨ä¸å­˜åœ¨ã€‚"); }

                // å¤„ç†æµå¼å“åº” (ç›‘å¬å™¨å®šä¹‰ä¸å˜)
                accumulatedResponse = "";
                streamListener = (incrementalText) => { /* ... */ };
                endListener = (finalText) => { /* ... */ };

                // æ³¨å†Œç›‘å¬å™¨å¹¶è°ƒç”¨ generate
                if (typeof eventOn !== 'function' || typeof eventOnce !== 'function' || typeof iframe_events !== 'object' || typeof generate !== 'function' || typeof eventRemoveListener !== 'function') {
                     throw new Error("èŠå¤©æ‰€éœ€çš„éƒ¨åˆ† API å‡½æ•°æœªå®šä¹‰æˆ–ä¸å¯ç”¨ã€‚");
                }
                eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, streamListener);
                eventOnce(iframe_events.GENERATION_ENDED, endListener);

                 console.log("Calling generate with config:", {
                     user_input: content,
                     should_stream: true,
                     overrides: overrides, // ä¼ å…¥è¦†ç›–å¯¹è±¡
                     injects: injections,   // ä¼ å…¥æ³¨å…¥å¯¹è±¡
                     // max_chat_history: 3 // å¯ä»¥è®¾ç½®å†å²è®°å½•é•¿åº¦ï¼Œè®© generate è‡ªåŠ¨å¤„ç†
                 });

                // ã€ä¿®æ”¹ã€‘è°ƒç”¨ generate æ—¶ä¼ å…¥ overrides å’Œ injects
                await generate({
                    user_input: content,        // ç©å®¶çš„èŠå¤©æ¶ˆæ¯
                    should_stream: true,
                    overrides: overrides,       // ä½¿ç”¨ overrides è¦†ç›–æ ‡å‡†å­—æ®µ
                    injects: injections,        // ä½¿ç”¨ injects æ³¨å…¥é¢å¤–æŒ‡ä»¤å’ŒçŠ¶æ€
                    max_chat_history: 3         // è®© generate è‡ªåŠ¨å¤„ç†æœ€è¿‘3æ¡å†å²è®°å½•
                                               // ï¼ˆè¿™æ ·å°±ä¸éœ€è¦åœ¨ injects é‡Œæ‰‹åŠ¨åŠ  chatHistoryText äº†ï¼‰
                });
                console.log("generate å‡½æ•°è°ƒç”¨å·²å‘èµ· (èŠå¤©)ã€‚");

            } catch (error) {
                console.error("è°ƒç”¨ LLM æˆ–å¤„ç†å›å¤æ—¶å‡ºé”™ (èŠå¤©):", error);
                // ... (é”™è¯¯å¤„ç†å’Œæ¸…ç†é€»è¾‘ä¸å˜) ...
                 const placeholderElement = document.getElementById(placeholderId);
                 if (placeholderElement) { placeholderElement.remove(); }
                 const errorMsgHtml = `<div class="message-system"><span>æŠ±æ­‰ï¼Œ${contactName} ç°åœ¨æ— æ³•å›å¤ã€‚(é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'})</span></div>`;
                 if (chatMessagesEl) { chatMessagesEl.insertAdjacentHTML('beforeend', errorMsgHtml); chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; }
                 if (streamListener && typeof eventRemoveListener === 'function') { eventRemoveListener(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, streamListener); }
                 hideLoadingIndicator();
                 enableInteractions();
            } finally {
                 // æ³¨æ„ï¼šendListener çš„ finally å—è´Ÿè´£å¤§éƒ¨åˆ†æ¸…ç†å·¥ä½œ
                 console.log("sendMessage try-catch-finally finished.");
            }
        }

        function searchContacts() {
            const contactSearchInput = document.getElementById('contactSearchInput');
             if (!contactSearchInput) return;
             const query = contactSearchInput.value.trim().toLowerCase();
             const contactListEl = document.getElementById('contactList');
             if (!contactListEl) return;
             const contactItems = contactListEl.querySelectorAll('.contact-item');

             contactItems.forEach(item => {
                  const nameElement = item.querySelector('.contact-name');
                  const name = nameElement ? nameElement.textContent.toLowerCase() : '';
                  item.style.display = name.includes(query) ? 'flex' : 'none';
             });
        }

        function toggleProfileDisplay() {
             const memberProfileEl = document.getElementById('memberProfile');
             if (memberProfileEl) {
                  const isHidden = memberProfileEl.style.display === 'none';
                  memberProfileEl.style.display = isHidden ? 'block' : 'none';
                  if (isHidden) {
                       renderProfile(currentContact); // æ˜¾ç¤ºæ—¶åˆ·æ–°å†…å®¹
                  }
             }
        }

        // --- Team Page Functions ---
        function handleMemberCardClick(memberIdOrName) {
            console.log(`ç‚¹å‡»äº†æˆå‘˜å¡ç‰‡: ${memberIdOrName}`);
             // æŸ¥æ‰¾æˆå‘˜æ•°æ®
             const member = CharacterSystem.getCharacter(memberIdOrName) || CharacterSystem.getCharacterByName(memberIdOrName);
             if (member) {
                 // åˆ‡æ¢åˆ°è”ç³»äººé¡µé¢å¹¶é€‰ä¸­è¯¥æˆå‘˜
                 switchPage('contact'); // ç¡®ä¿è°ƒç”¨å…¨å±€åˆ‡æ¢å‡½æ•°
                 // éœ€è¦ä¸€ç‚¹å»¶è¿Ÿç¡®ä¿è”ç³»äººåˆ—è¡¨æ¸²æŸ“å®Œæˆ
                  setTimeout(() => {
                      switchContact(member.name); // åˆ‡æ¢åˆ°å¯¹åº”è”ç³»äºº
                  }, 100); // 100ms å»¶è¿Ÿåº”è¯¥è¶³å¤Ÿ
             } else {
                  alert("æ‰¾ä¸åˆ°è¯¥æˆå‘˜çš„è¯¦ç»†ä¿¡æ¯ã€‚");
             }
        }

        // --- Plan Page Functions ---
        const taskTagLabels = { 'short-term': 'çŸ­æœŸ', 'long-term': 'é•¿æœŸ', 'personal-bond': 'ç¾ç»Š', 'training': 'åŸ¹è®­', 'song':'å£°ä¹','dance': 'èˆè¹ˆ', 'vocal': 'å£°ä¹', 'fan-service': 'ç²‰ä¸è¥ä¸š', 'performance': 'è¡¨æ¼”', 'other': 'å…¶ä»–' };
        const priorityLabels = { 'high': 'é«˜', 'medium': 'ä¸­', 'low': 'ä½' };
        const statusLabels = { 'todo': 'å¾…å¤„ç†', 'inprogress': 'è¿›è¡Œä¸­', 'completed': 'å·²å®Œæˆ' };

        function filterTasks(filterType) {
             currentFilter = filterType;
             const filterButtonsContainer = document.querySelector('.filter-buttons');
             if (filterButtonsContainer) {
                  filterButtonsContainer.querySelectorAll('.filter-btn').forEach(btn => {
                       btn.classList.toggle('active', btn.dataset.filter === filterType);
                  });
             }
             searchTasks(); // åº”ç”¨è¿‡æ»¤å’Œæœç´¢
        }

        function renderTaskList() {
             const taskBoard = document.getElementById('taskBoard');
             if (!taskBoard) return;
              console.log("æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨...");

             const planData = gameState.plan || [];
             // æŒ‰çŠ¶æ€åˆ†ç»„
             const groupedTasks = planData.reduce((acc, task) => {
                  const status = task.status || 'todo'; // é»˜è®¤å¾…å¤„ç†
                  if (!acc[status]) acc[status] = [];
                   // è·å–æˆå‘˜ä¿¡æ¯
                   const members = Array.isArray(task.memberIds)
                        ? task.memberIds.map(id => CharacterSystem.getCharacter(id)).filter(Boolean)
                        : [];
                  acc[status].push({ ...task, members });
                  return acc;
             }, { todo: [], inprogress: [], completed: [] }); // åˆå§‹åŒ–æ‰€æœ‰çŠ¶æ€

             // æ¸²æŸ“æ¯ä¸ªçŠ¶æ€åˆ—è¡¨
             Object.keys(groupedTasks).forEach(status => {
                  const taskList = taskBoard.querySelector(`.task-list[data-status="${status}"]`);
                  if (taskList) {
                       if (groupedTasks[status].length > 0) {
                            taskList.innerHTML = groupedTasks[status].map(task => {
                                  if (!task || !task.title) return ''; // è·³è¿‡æ— æ•ˆä»»åŠ¡
                                   const tags = Array.isArray(task.tags) ? task.tags : [];
                                   const priority = task.priority || 'medium';
                                   const deadline = task.deadline || 'æ— æœŸé™';
                                    // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– PLACEHOLDER_IMG
                                   const memberAvatarsHtml = (task.members || []).map(member => {
                                        const avatarSrc = (member?.avatar && typeof member.avatar === 'string' && member.avatar.trim() !== '') ? member.avatar : PLACEHOLDER_IMG; // ä½¿ç”¨å¸¸é‡
                                        return `<span class="member-avatar" title="${member?.name || 'æœªçŸ¥æˆå‘˜'}"><img src="${avatarSrc}" alt="${member?.name || ''}" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;"></span>`;
                                    }).join('');


                                  return `
                                  <div class="task-card ${tags.join(' ')} ${task.status || 'todo'}">
                                      <div class="task-header">
                                          ${tags.map(tag => `<span class="task-tag ${tag}">${taskTagLabels[tag] || tag}</span>`).join('')}
                                          <div class="task-priority ${priority}">${priorityLabels[priority] || priority}</div>
                                      </div>
                                      <div class="task-title">${task.title}</div>
                                      <div class="task-description">${task.description || ''}</div>
                                      <div class="task-footer">
                                          <div class="task-deadline"><i class="far fa-calendar-alt"></i> ${deadline}</div>
                                          <div class="task-members">${memberAvatarsHtml}</div>
                                      </div>
                                  </div>
                                  `;
                             }).join('');
                       } else {
                            taskList.innerHTML = `<p class="text-center text-muted small p-3">æš‚æ— ${statusLabels[status] || status}ä»»åŠ¡</p>`;
                       }
                  }
             });
              updateTaskCounts(); // æ›´æ–°è®¡æ•°
              filterTasks(currentFilter); // åº”ç”¨å½“å‰è¿‡æ»¤å™¨
              console.log("ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“å®Œæˆã€‚");
        }

        function updateTaskCounts() {
            const taskBoardEl = document.getElementById('taskBoard');
            if (!taskBoardEl) return;
            const statuses = ['todo', 'inprogress', 'completed'];
            statuses.forEach(status => {
                const countElement = taskBoardEl.querySelector(`.task-column .task-count[data-status="${status}"]`);
                const taskList = taskBoardEl.querySelector(`.task-list[data-status="${status}"]`);
                 if (countElement && taskList) {
                      const visibleTasks = taskList.querySelectorAll('.task-card:not(.hidden-task)');
                      countElement.textContent = visibleTasks.length;
                 }
            });
        }

        function searchTasks() {
             const taskBoardEl = document.getElementById('taskBoard');
             if (!taskBoardEl) return;
             const taskSearchInput = document.getElementById('taskSearchInput');
              if (!taskSearchInput) return;
             const query = taskSearchInput.value.trim().toLowerCase();
             const taskCards = taskBoardEl.querySelectorAll('.task-card');

             taskCards.forEach(card => {
                  const title = card.querySelector('.task-title')?.textContent.toLowerCase() || '';
                  const description = card.querySelector('.task-description')?.textContent.toLowerCase() || '';
                   const tags = Array.from(card.classList).filter(cls => cls !== 'task-card' && cls !== 'hidden-task').map(tag => (taskTagLabels[tag] || tag).toLowerCase());
                   const priority = (priorityLabels[card.querySelector('.task-priority')?.classList[1]] || '').toLowerCase();

                   const matchesSearch = title.includes(query) || description.includes(query) || tags.some(t => t.includes(query)) || priority.includes(query);
                  let matchesFilter = (currentFilter === 'all');
                  if (!matchesFilter) {
                       matchesFilter = card.classList.contains(currentFilter);
                  }

                  card.classList.toggle('hidden-task', !(matchesSearch && matchesFilter));
             });
             updateTaskCounts(); // æœç´¢åæ›´æ–°è®¡æ•°
        }


        // --- Song Page Functions ---
        function renderSongOptions() {
             const mainVocalSelection = document.getElementById('mainVocalSelection');
             const subVocalSelection = document.getElementById('subVocalSelection');
             const songMembers = CharacterSystem.getSongMembersData(); // è·å–æ­Œæ‰‹æ•°æ®

             if (mainVocalSelection) {
                 mainVocalSelection.innerHTML = songMembers.length > 0 ? songMembers.map(member => {
                      if (!member || !member.name) return '';
                       // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– PLACEHOLDER_IMG
                       const avatarSrc = (member.avatar && typeof member.avatar === 'string' && member.avatar.trim() !== '') ? member.avatar : PLACEHOLDER_IMG; // ä½¿ç”¨å¸¸é‡
                      return `
                      <div class="member-select-item" data-member="${member.name}" data-id="${member.id}">
                          <img src="${avatarSrc}" alt="${member.name}" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;">
                          <span class="member-name">${member.name}</span>
                          <div class="member-skill">å£°ä¹: ${member.skill}%</div>
                      </div>`;
                 }).join('') : '<p class="text-muted small">æš‚æ— å¯ç”¨æˆå‘˜</p>';
             }
             if (subVocalSelection) {
                  subVocalSelection.innerHTML = songMembers.length > 0 ? songMembers.map(member => {
                      if (!member || !member.name) return '';
                       // ç¡®ä¿ avatar æ˜¯æœ‰æ•ˆçš„ URL æˆ– PLACEHOLDER_IMG
                       const avatarSrc = (member.avatar && typeof member.avatar === 'string' && member.avatar.trim() !== '') ? member.avatar : PLACEHOLDER_IMG; // ä½¿ç”¨å¸¸é‡
                      return `
                       <div class="member-select-item" data-member="${member.name}" data-id="${member.id}">
                           <img src="${avatarSrc}" alt="${member.name}" onerror="this.onerror=null; this.src=PLACEHOLDER_IMG;">
                           <span class="member-name">${member.name}</span>
                           <div class="member-skill">å£°ä¹: ${member.skill}%</div>
                       </div>`;
                  }).join('') : '<p class="text-muted small">æš‚æ— å¯ç”¨æˆå‘˜</p>';
             }

             // æ›´æ–°åˆ¶ä½œå›¢é˜Ÿé€‰æ‹©
             const productionTeams = gameState.song?.productionTeams || {};
             const renderTeamSelect = (selectId, teamArray) => {
                  const select = document.getElementById(selectId);
                  if (select) {
                       if (teamArray && Array.isArray(teamArray) && teamArray.length > 0) {
                            select.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>' + teamArray.map(item => {
                                 if (!item || !item.name) return '';
                                  const cost = item.cost !== undefined ? parseInt(item.cost) || 0 : 0;
                                 return `<option value="${item.name}" data-cost="${cost}">${item.name} - ${formatCurrency(cost)} (${item.experience || 'ç»éªŒæœªçŸ¥'})</option>`;
                            }).join('');
                       } else {
                            select.innerHTML = '<option value="">æ— å¯ç”¨é€‰é¡¹</option>';
                       }
                  }
             };
             renderTeamSelect('composer', productionTeams.composers);
             renderTeamSelect('lyricist', productionTeams.lyricists);
             renderTeamSelect('arranger', productionTeams.arrangers);
             renderTeamSelect('mvDirector', productionTeams.mvDirectors);
        }

        function selectSongStyle(clickedCard) { // è¿™ä¸ªå‡½æ•°ä¼¼ä¹æ²¡è¢«ä½¿ç”¨ï¼Œå› ä¸ºæ”¹æˆäº† select
             // å¦‚æœéœ€è¦ç”¨å¡ç‰‡é€‰æ‹©ï¼Œé€»è¾‘åº”ç±»ä¼¼ selectSongMember
             console.warn("selectSongStyle è¢«è°ƒç”¨ï¼Œä½†å¯èƒ½å·²åºŸå¼ƒã€‚");
        }

        function selectSongMember(clickedItem) {
            if (!clickedItem) return;
            const container = clickedItem.closest('.member-selection');
            if (!container) return;
            if (container.classList.contains('multiple')) {
                clickedItem.classList.toggle('selected');
            } else {
                container.querySelectorAll('.member-select-item').forEach(item => item.classList.remove('selected'));
                clickedItem.classList.add('selected');
            }
            updateSongSummary(); // é€‰æ‹©åæ›´æ–°æ‘˜è¦
        }

        function updateSongSummary() {
            console.log("æ›´æ–°æ­Œæ›²æ‘˜è¦...");
            let totalCost = 0;
            const summary = { theme: 'N/A', style: 'N/A', mainVocal: 'N/A', profit: 'â˜…â˜…â˜…â˜†â˜†', duration: '4-6å‘¨' };
            const budgetData = {};
             const budgetLabels = { composer: "ä½œæ›²", lyricist: "ä½œè¯", arranger: "ç¼–æ›²", recording: "å½•éŸ³", mv: "MVåˆ¶ä½œ", total: "æ€»è®¡" };

             // è·å–å¹¶è®¡ç®—æˆæœ¬
             const getSelectedCost = (selectId) => {
                  const select = document.getElementById(selectId);
                   const selectedOption = select ? select.options[select.selectedIndex] : null;
                   const cost = selectedOption ? parseInt(selectedOption.dataset.cost || 0) : 0;
                   const name = selectedOption ? selectedOption.text.split('-')[0].trim() : 'æœªé€‰æ‹©';
                   return { cost, name };
             };

             const composerInfo = getSelectedCost('composer');
             budgetData.composer = `${formatCurrency(composerInfo.cost)} (${composerInfo.name})`;
             totalCost += composerInfo.cost;

             const lyricistInfo = getSelectedCost('lyricist');
             budgetData.lyricist = `${formatCurrency(lyricistInfo.cost)} (${lyricistInfo.name})`;
             totalCost += lyricistInfo.cost;

             const arrangerInfo = getSelectedCost('arranger');
             budgetData.arranger = `${formatCurrency(arrangerInfo.cost)} (${arrangerInfo.name})`;
             totalCost += arrangerInfo.cost;

             const recordingCost = 8000; // å›ºå®šæˆæœ¬
             budgetData.recording = formatCurrency(recordingCost);
             totalCost += recordingCost;

             const mvInfo = getSelectedCost('mvDirector');
             budgetData.mv = `${formatCurrency(mvInfo.cost)} (${mvInfo.name})`;
             totalCost += mvInfo.cost;

             budgetData.total = formatCurrency(totalCost);

            // æ›´æ–°é¢„ç®—è¡¨
            const budgetItemsEl = document.getElementById('budgetItems');
            if(budgetItemsEl) {
                 if (totalCost > 0 || composerInfo.cost > 0 || lyricistInfo.cost > 0 || arrangerInfo.cost > 0 || mvInfo.cost > 0) {
                     budgetItemsEl.innerHTML = Object.entries(budgetData).map(([key, value])=>`
                         <div class="budget-item ${key === 'total' ? 'total' : ''}">
                             <div class="item-name">${budgetLabels[key] || key}</div>
                             <div class="item-value" data-budget="${key}">${value}</div>
                         </div>`).join('');
                 } else {
                      budgetItemsEl.innerHTML = '<p class="text-muted small p-2">è¯·é€‰æ‹©åˆ¶ä½œå›¢é˜Ÿä»¥è®¡ç®—é¢„ç®—</p>';
                 }
            }

            // æ›´æ–°é¢„è§ˆä¿¡æ¯
             const themeSelect = document.getElementById('songTheme');
             summary.theme = themeSelect ? (themeSelect.value === 'custom' ? (document.getElementById('customTheme')?.value || 'è‡ªå®šä¹‰') : (themeSelect.options[themeSelect.selectedIndex]?.text || 'N/A')) : 'N/A';

            const styleSelect = document.getElementById('songStyle'); // ä½¿ç”¨ Select
            summary.style = styleSelect ? (styleSelect.options[styleSelect.selectedIndex]?.text || 'N/A') : 'N/A';

            const mainVocalSelection = document.getElementById('mainVocalSelection');
            const selectedMainVocal = mainVocalSelection?.querySelector('.member-select-item.selected');
            summary.mainVocal = selectedMainVocal ? selectedMainVocal.dataset.member : 'æœªé€‰æ‹©';

            // ç®€å•ä¼°ç®—é€»è¾‘ (ä¿æŒä¸å˜)
            let profitScore = 3;
            if (composerInfo.cost > 20000 || lyricistInfo.cost > 10000 || arrangerInfo.cost > 15000) profitScore++;
            if (mvInfo.cost > 100000) profitScore++;
            // if (summary.style === 'ç”µå­æµè¡Œ' || summary.style === 'R&Bæµè¡Œ') profitScore++; // åŸºäºæ–‡æœ¬åˆ¤æ–­å¯èƒ½ä¸å‡†
            // if (['é’æ˜¥å¥‹æ–—', 'æ¢¦æƒ³è¿½é€'].includes(summary.theme)) profitScore++;
            profitScore = Math.max(1, Math.min(5, profitScore)); // ç¡®ä¿åœ¨ 1-5 æ˜Ÿ
            summary.profit = 'â˜…'.repeat(profitScore) + 'â˜†'.repeat(5 - profitScore);

            let durationWeeks = 4;
            if (composerInfo.cost > 0) durationWeeks += 1;
            if (lyricistInfo.cost > 0) durationWeeks += 0.5;
            if (arrangerInfo.cost > 0) durationWeeks += 1;
            if (mvInfo.cost > 0) durationWeeks += 2;
            summary.duration = `${Math.ceil(durationWeeks)}-${Math.ceil(durationWeeks + 2)}å‘¨`;

            // é¢„è§ˆé¡¹ç›®æ ‡ç­¾ä¸­æ–‡åŒ–
            const previewLabels = { theme: "ä¸»é¢˜", style: "é£æ ¼", mainVocal: "ä¸»å”±", profit: "æ”¶ç›Šé¢„æµ‹", duration: "åˆ¶ä½œå‘¨æœŸ" };

            // æ›´æ–°é¢„è§ˆè¡¨
            const previewItemsEl = document.getElementById('previewItems');
            if (previewItemsEl) {
                 if (summary.style !== 'N/A' && summary.mainVocal !== 'æœªé€‰æ‹©') {
                     previewItemsEl.innerHTML = Object.entries(summary).map(([key, value]) => `
                         <div class="preview-item">
                             <div class="item-label">${previewLabels[key] || key}:</div>
                             <div class="item-value" data-preview="${key}">${value}</div>
                         </div>`).join('');
                 } else {
                      previewItemsEl.innerHTML = '<p class="text-muted small p-2">è¯·é€‰æ‹©é£æ ¼å’Œä¸»å”±ä»¥ç”Ÿæˆé¢„è§ˆ</p>';
                 }
            }
             console.log("æ­Œæ›²æ‘˜è¦æ›´æ–°å®Œæˆã€‚");
        }

        // --- Training Page Functions ---
        function updateTrainingStats() {
             const trainingFansStatEl = document.getElementById('training-fans-stat');
             const trainingFundsStatEl = document.getElementById('training-funds-stat');
             const trainingPopStatEl = document.getElementById('training-popularity-stat');

             if (trainingFansStatEl) trainingFansStatEl.textContent = formatNumber(gameState.team?.basicInfo?.fans || 0);
             if (trainingFundsStatEl) trainingFundsStatEl.textContent = formatCurrency(gameState.story?.currentFunds || 0);
             if (trainingPopStatEl) trainingPopStatEl.textContent = formatNumber(gameState.team?.basicInfo?.popularity || 0); // å‡è®¾æœ‰ popularity
        }

        async function startTraining(buttonElement) {
            const btn = buttonElement;
            if (!btn || btn.disabled) return;

            const cost = parseInt(btn.dataset.cost || 0);
            const trainingType = btn.dataset.type;
            const card = btn.closest('.training-card');
            const trainingTitle = card?.querySelector('.training-title')?.textContent || trainingType || 'æœªçŸ¥è®­ç»ƒ';
            const costText = formatCurrency(cost); // ç”¨äº Prompt

            console.log(`ç©å®¶è§¦å‘äº† ${trainingTitle} (é¢„æœŸèŠ±è´¹ ${costText})`);

            showLoadingIndicator("å¤„ç†è®­ç»ƒä¸­...");
            disableInteractions();
            if(card) card.classList.add('training-in-progress');

            try {
                await toggleWorldBookEntries(['COT', 'æ ¼å¼è¦æ±‚'], ['COTï¼ˆchatï¼‰']);
                await autoSaveToWorldBook();

                // è·å–æ•…äº‹æ€»ç»“ä¸Šä¸‹æ–‡
                let summaryContext = "\n\nã€æœ€è¿‘çš„æ•…äº‹æ€»ç»“å›é¡¾ã€‘\n";
                const summaries = Array.isArray(gameState.storySummary) ? gameState.storySummary : [];
                if (summaries.length > 0) {
                    const recentSummaries = summaries.slice(-3);
                    summaryContext += recentSummaries.length > 0 ? recentSummaries.map(s => `${s.id}. ${s.content}`).join('\n') : "æš‚æ— æ€»ç»“ã€‚";
                } else { summaryContext += "æš‚æ— æ€»ç»“ã€‚"; }
                summaryContext += "\n";

                // ã€ä¿®æ”¹ã€‘æ„å»ºæ³¨å…¥çš„ç³»ç»ŸæŒ‡ä»¤
                const systemInstruction = `--- CORE ACTION THIS TURN ---\n` +
                                        `**Player Character Action:** {{user}} initiated a training session:\n` +
                                        `**Action Detail:** ${trainingTitle} (Expected Cost: ${costText})\n` + // æ¸…æ™°æè¿°åŠ¨ä½œ
                                        `**Instruction:** This training initiation is the ABSOLUTE FOCUS. You MUST process this request:\n` +
                                        `1. Check if conditions are met (e.g., sufficient funds: ${cost}).\n` +
                                        `2. If met, update the game state (deduct funds, increase relevant stats moderately for the team/relevant members based on '${trainingType}', potentially adjust mood).\n` +
                                        `3. Generate narrative describing the *start* or *immediate effect* of the training.\n` +
                                        `4. Output ONLY the \`<gametext>\` containing the *complete* updated game state (or reflecting the failure if conditions unmet).\n\n` +
                                        `--- Execution Context & Guidelines ---\n` +
                                        `${summaryContext}\n` +
                                        `ã€<å›å¤æ ¼å¼> æŒ‡ä»¤ã€‘\n` + // å¼•ç”¨å¤–éƒ¨çš„ CoT/å›å¤æ ¼å¼
                                        `Please strictly follow the rules defined in \`<å›å¤æ ¼å¼>\` (your CoT, Thinking Format v3.0).\n`;

                console.log("System Instruction for generate:", systemInstruction);

                // ã€ä¿®æ”¹ã€‘è°ƒç”¨ generate
                const rawLLMResponse = await generate({
                    user_input: `å¼€å§‹è¿›è¡Œ ${trainingTitle}`, // <--- ç®€åŒ–çš„ç”¨æˆ·æ„å›¾ä½œä¸º user_input
                    should_stream: false,
                    injects: [
                        {
                            role: 'system',
                            content: systemInstruction,
                            position: 'before_prompt',
                            depth: 0,
                            should_scan: false
                        }
                    ]
                    // max_chat_history: 0 // è®­ç»ƒé€šå¸¸ä¸éœ€è¦èŠå¤©å†å²
                });

                console.log("æ”¶åˆ° LLM åŸå§‹å“åº” (è®­ç»ƒäº‹ä»¶):", rawLLMResponse);

                // --- (åç»­è§£æ gametext å’Œæ›´æ–°çŠ¶æ€çš„é€»è¾‘ä¸å˜) ---
                let newGameData = null;
                let messageToSave = rawLLMResponse;
                const extractedJsonString = extractGameText(rawLLMResponse);

                if (extractedJsonString) {
                    console.log("[è§£æé˜¶æ®µ] å‡†å¤‡è§£æ:", extractedJsonString);
                    try {
                        newGameData = JSON.parse(extractedJsonString);
                        messageToSave = `<gametext>${extractedJsonString}</gametext>`;
                        console.log("[è§£æé˜¶æ®µ] JSON è§£ææˆåŠŸã€‚");
                        // æ£€æŸ¥æ˜¯å¦æœ‰æç¤ºä¿¡æ¯ (å¦‚èµ„é‡‘ä¸è¶³)
                        const newDialogue = newGameData.story?.dialogue;
                        if (Array.isArray(newDialogue) && newDialogue.length > 0) {
                             const lastMessage = newDialogue[newDialogue.length - 1];
                             if (lastMessage && lastMessage.speaker === 'æ—ç™½' && lastMessage.content && (lastMessage.content.includes('ä¸è¶³') || lastMessage.content.includes('å¤±è´¥'))) {
                                  alert(`è®­ç»ƒæç¤º: ${lastMessage.content}`); // ç›´æ¥ alert æç¤º
                             } else if (lastMessage && lastMessage.speaker === 'æ—ç™½') {
                                 console.log(`è®­ç»ƒç»“æœ/æç¤º: ${lastMessage.content}`); // åœ¨æ§åˆ¶å°è®°å½•æˆåŠŸä¿¡æ¯
                             }
                        }
                    } catch (parseError) {
                        console.error("[è§£æé˜¶æ®µ] JSON è§£æå¤±è´¥:", parseError);
                        console.error("å¤±è´¥æ—¶å°è¯•è§£æçš„å­—ç¬¦ä¸²:", extractedJsonString);
                        alert(`è§£æè®­ç»ƒç»“æœæ—¶å‡ºé”™: ${parseError.message}.`);
                        newGameData = null;
                    }
                } else {
                    console.error("æœªèƒ½ä» LLM å“åº”ä¸­æå–æœ‰æ•ˆçš„ <gametext>{...}</gametext> å— (è®­ç»ƒ)ã€‚");
                     if (rawLLMResponse && !rawLLMResponse.includes('<gametext>') && !rawLLMResponse.includes('{') && rawLLMResponse.trim().length > 5) {
                         alert(`è®­ç»ƒæç¤º: ${rawLLMResponse.trim()}`); // å°†çº¯æ–‡æœ¬å›å¤è§†ä¸ºæç¤º
                    } else {
                        alert("å¤„ç†è®­ç»ƒè¯·æ±‚å¤±è´¥ï¼šæ— æ³•ä»å›å¤ä¸­è·å–æœ‰æ•ˆçš„æ¸¸æˆçŠ¶æ€æ•°æ®ã€‚");
                    }
                    newGameData = null;
                }

                if (newGameData) {
                    // å¦‚æœè§£ææˆåŠŸä¸” newGameData æœ‰å€¼ï¼ˆå³ä½¿æ˜¯è¡¨ç¤ºå¤±è´¥çš„çŠ¶æ€ï¼‰
                    updateGameState(newGameData);
                    console.log("æ¸¸æˆçŠ¶æ€å’ŒUIå·²æ›´æ–° (è®­ç»ƒ)ã€‚å‡†å¤‡é™é»˜ä¿å­˜...");
                    if (typeof setChatMessage === 'function') {
                        await setChatMessage({ message: messageToSave }, 0, { refresh: 'none' });
                        console.log("é™é»˜ä¿å­˜å®Œæˆ (è®­ç»ƒ)ã€‚");
                    }
                } else {
                    console.error("ç”±äºæå–æˆ–è§£æå¤±è´¥ï¼Œæœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„ newGameDataï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°å’Œä¿å­˜ (è®­ç»ƒ)ã€‚");
                }
                 // --- (ç»“æŸ) ---

            } catch (error) {
                console.error("å¤„ç†è®­ç»ƒäº‹ä»¶æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯:", error);
                alert(`å¤„ç†è®­ç»ƒæ—¶å‘ç”Ÿé”™è¯¯: ${error.message}\nè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚`);
            } finally {
                hideLoadingIndicator();
                enableInteractions();
                if (card) card.classList.remove('training-in-progress');
                console.log("startTraining finally block executed.");
            }
        }
        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded - å¼€å§‹åˆå§‹åŒ–åº”ç”¨ç¨‹åº");

             // åˆå§‹åŒ–æ ¸å¿ƒç³»ç»Ÿ
             DataSystem.init();
             TextSystem.init(); // TextSystem ä¹Ÿéœ€è¦åˆå§‹åŒ–æ¥ç»‘å®šåŸºç¡€äº‹ä»¶
             console.log("DataSystem å’Œ TextSystem å·²åˆå§‹åŒ–");

             // åŠ è½½æ¸¸æˆæ•°æ®
             loadGameDataFromChat().then(() => {
                  console.log("loadGameDataFromChat Promise å·²è§£å†³");
                  // æ³¨å†Œ beforeunload ä¿å­˜äº‹ä»¶ (ç®€åŒ–ä¿å­˜é€»è¾‘)
                   window.addEventListener('beforeunload', () => {
                        console.log("é¡µé¢å³å°†å…³é—­ï¼Œæ‰§è¡Œæœ€ç»ˆä¿å­˜...");
                        saveGameState(); // ç›´æ¥è°ƒç”¨ä¿å­˜
                   });
                   console.log("beforeunload ä¿å­˜äº‹ä»¶å·²æ³¨å†Œã€‚");

                   // --- è®¾ç½®åˆå§‹é¡µé¢ ---
                  const pages = document.querySelectorAll('.page');
                  const mainNav = document.getElementById('mainNav');
                   let initialPageId = 'story'; // é»˜è®¤åˆå§‹é¡µé¢
                  if (pages.length > 0 && !document.querySelector('.page.active')) {
                       pages[0].classList.add('active'); // ç¡®ä¿æœ‰æ´»åŠ¨é¡µ
                  }
                   // æ¿€æ´»å¯¼èˆªé“¾æ¥å¹¶è·å–åˆå§‹é¡µé¢ ID
                   if(mainNav){
                        const initialPageLink = mainNav.querySelector('.nav-link.active') || mainNav.querySelector('.nav-link[data-page="story"]'); // é»˜è®¤ story
                        if (initialPageLink) {
                             initialPageId = initialPageLink.dataset.page;
                             // ç¡®ä¿é“¾æ¥æ˜¯ active çŠ¶æ€
                              mainNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                              initialPageLink.classList.add('active');
                              // ç¡®ä¿å¯¹åº”é¡µé¢æ˜¯ active çŠ¶æ€
                              document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                              const initialPageEl = document.getElementById(initialPageId + 'Page');
                              if(initialPageEl) initialPageEl.classList.add('active');
                        }
                   }
                    console.log("ç¡®å®šåˆå§‹æ´»åŠ¨é¡µé¢ ID:", initialPageId);
                    // è°ƒç”¨ switchPage æ¥å¤„ç†åˆå§‹é¡µé¢çš„æ¸²æŸ“
                    switchPage(initialPageId);

             }).catch(error => {
                  console.error("åˆå§‹åŒ–åŠ è½½æ¸¸æˆæ•°æ®æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:", error);
                  alert("åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚");
                   // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºä¸€ä¸ªé»˜è®¤é¡µé¢
                   switchPage('story'); // å°è¯•æ˜¾ç¤ºæ•…äº‹é¡µï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
             });

            // --- å…¨å±€äº‹ä»¶ç›‘å¬ ---
            // å¯¼èˆªæ 
            const mainNavElement = document.getElementById('mainNav');
            if (mainNavElement) {
                mainNavElement.addEventListener('click', (e) => {
                    const link = e.target.closest('.nav-link');
                    if (link && link.dataset.page) {
                        e.preventDefault();
                        switchPage(link.dataset.page);
                    }
                });
            }

            // --- é¡µé¢ç‰¹å®šäº‹ä»¶ç›‘å¬ ---
            // è”ç³»äººé¡µ
             const contactListEl = document.getElementById('contactList');
             if (contactListEl) { // ä½¿ç”¨äº‹ä»¶å§”æ‰˜
                 contactListEl.addEventListener('click', (e) => {
                      const targetItem = e.target.closest('.contact-item');
                      if (targetItem && targetItem.dataset.contact) {
                           switchContact(targetItem.dataset.contact);
                      }
                 });
             }
            document.getElementById('sendMessageBtn')?.addEventListener('click', sendMessage);
            document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
             });
            document.getElementById('contactSearchBtn')?.addEventListener('click', searchContacts);
            document.getElementById('contactSearchInput')?.addEventListener('input', searchContacts);
            document.getElementById('clearChatBtn')?.addEventListener('click', clearCurrentChat);
            document.getElementById('characterInfoBtn')?.addEventListener('click', toggleProfileDisplay);

            // æ•…äº‹é¡µ
             document.getElementById('btn-show-history')?.addEventListener('click', showHistoryModal);
             document.getElementById('btn-load-save')?.addEventListener('click', openLoadSaveModal);

            // å›¢é˜Ÿé¡µ
            document.getElementById('teamMembers')?.addEventListener('click', (e) => {
                 const targetCard = e.target.closest('.member-card.horizontal'); // é€‰æ‹©æ¨ªå‘å¡ç‰‡
                 if (targetCard && (targetCard.dataset.memberId || targetCard.dataset.member)) {
                      handleMemberCardClick(targetCard.dataset.memberId || targetCard.dataset.member); // å…¼å®¹æ—§ data-*
                 }
             });
             document.getElementById('dataAnalysisBtn')?.addEventListener('click', () => alert('æ•°æ®åˆ†æåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...'));
             document.getElementById('teamSettingsBtn')?.addEventListener('click', () => alert('å›¢é˜Ÿè®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...'));

             // è®¡åˆ’é¡µ
              const filterButtonsContainer = document.querySelector('.filter-buttons');
              if (filterButtonsContainer) {
                   filterButtonsContainer.addEventListener('click', (e) => {
                        if (e.target.classList.contains('filter-btn') && e.target.dataset.filter) {
                            filterTasks(e.target.dataset.filter);
                        }
                   });
              }
              document.getElementById('taskSearchInput')?.addEventListener('input', searchTasks);
              document.getElementById('newTaskBtn')?.addEventListener('click', () => alert('æ–°å»ºä»»åŠ¡åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...'));

              const deleteRecordsBtn = document.getElementById('btn-delete-records');
            if (deleteRecordsBtn) {
                deleteRecordsBtn.addEventListener('click', deleteGameRecords);
                console.log("åˆ é™¤è®°å½•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²é™„åŠ ã€‚");
            } else {
                console.warn("æœªæ‰¾åˆ°åˆ é™¤è®°å½•æŒ‰é’® #btn-delete-recordsã€‚");
            }

             // æ–°æ­Œé¡µ
             document.getElementById('songTheme')?.addEventListener('change', (e) => {
                  const customContainer = document.getElementById('customThemeContainer');
                  if(customContainer) customContainer.style.display = e.target.value === 'custom' ? 'block' : 'none';
                  updateSongSummary();
             });
              document.getElementById('customTheme')?.addEventListener('input', updateSongSummary); // è‡ªå®šä¹‰è¾“å…¥æ—¶ä¹Ÿæ›´æ–°
             document.getElementById('songStyle')?.addEventListener('change', updateSongSummary);
              // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šæˆå‘˜é€‰æ‹©
              document.getElementById('mainVocalSelection')?.addEventListener('click', (e) => {
                   const targetItem = e.target.closest('.member-select-item');
                   if(targetItem) selectSongMember(targetItem);
              });
              document.getElementById('subVocalSelection')?.addEventListener('click', (e) => {
                    const targetItem = e.target.closest('.member-select-item');
                    if(targetItem) selectSongMember(targetItem);
               });
              // åˆ¶ä½œå›¢é˜Ÿé€‰æ‹©
              ['composer', 'lyricist', 'arranger', 'mvDirector'].forEach(id => {
                   document.getElementById(id)?.addEventListener('change', updateSongSummary);
              });
               document.getElementById('mvConcept')?.addEventListener('input', updateSongSummary); // MV æ¦‚å¿µå˜åŒ–ä¹Ÿæ›´æ–°æ‘˜è¦
               document.getElementById('startProductionBtn')?.addEventListener('click', async () => {
                console.log("å¼€å§‹åˆ¶ä½œæŒ‰é’®è¢«ç‚¹å‡»");
                // --- æ”¶é›†ä¿¡æ¯ (ä¿æŒä¸å˜ï¼Œç¡®ä¿å¥å£®æ€§) ---
                const songConfig = {
                    theme: '', style: '', mainVocal: '', subVocals: [],
                    productionTeam: { composer: '', lyricist: '', arranger: '' },
                    mv: { director: '', concept: '' }
                };
                let estimatedTotalCost = 0;
                let totalCostTextForPrompt = 'æ— æ³•è·å–';
                try {
                    const themeSelect = document.getElementById('songTheme');
                    if (themeSelect) {
                        songConfig.theme = themeSelect.value;
                        if (songConfig.theme === 'custom') {
                            const customInput = document.getElementById('customTheme');
                            songConfig.theme = customInput?.value.trim() || 'è‡ªå®šä¹‰(æœªè¾“å…¥)';
                        }
                    }
                    const styleSelect = document.getElementById('songStyle');
                    if (styleSelect) songConfig.style = styleSelect.options[styleSelect.selectedIndex]?.text || styleSelect.value; // è·å–æ–‡æœ¬æˆ–å€¼
                    const mainVocalEl = document.getElementById('mainVocalSelection')?.querySelector('.member-select-item.selected');
                    if (mainVocalEl) songConfig.mainVocal = mainVocalEl.dataset.member;
                    const subVocalEls = document.getElementById('subVocalSelection')?.querySelectorAll('.member-select-item.selected');
                    if (subVocalEls) songConfig.subVocals = Array.from(subVocalEls).map(item => item.dataset.member);
                    const getTeamMemberName = (id) => document.getElementById(id)?.value || ''; // ç®€åŒ–è·å–
                    songConfig.productionTeam.composer = getTeamMemberName('composer');
                    songConfig.productionTeam.lyricist = getTeamMemberName('lyricist');
                    songConfig.productionTeam.arranger = getTeamMemberName('arranger');
                    songConfig.mv.director = getTeamMemberName('mvDirector');
                    songConfig.mv.concept = document.getElementById('mvConcept')?.value.trim() || '';
                    // è·å–æˆæœ¬
                    const budgetTotalEl = document.querySelector('#budgetItems .item-value[data-budget="total"]');
                    if (budgetTotalEl) {
                        totalCostTextForPrompt = budgetTotalEl.textContent || "0";
                        const costMatch = totalCostTextForPrompt.match(/[\d,]+/);
                        if (costMatch) estimatedTotalCost = parseInt(costMatch[0].replace(/,/g, ''), 10) || 0;
                    } else {
                         console.warn("æ— æ³•åœ¨æ‘˜è¦ä¸­æ‰¾åˆ°æ€»æˆæœ¬å…ƒç´ ã€‚å°†ä½¿ç”¨ 0 ä½œä¸ºä¼°ç®—ã€‚");
                         estimatedTotalCost = 0;
                         totalCostTextForPrompt = "0 (è·å–å¤±è´¥)";
                    }
                    console.log("æ”¶é›†åˆ°çš„æ­Œæ›²é…ç½®:", songConfig, "ä¼°ç®—æˆæœ¬:", estimatedTotalCost);
                    // åŸºæœ¬éªŒè¯
                    if (!songConfig.theme || !songConfig.style || !songConfig.mainVocal ||
                        !songConfig.productionTeam.composer || !songConfig.productionTeam.lyricist || !songConfig.productionTeam.arranger) {
                        alert("è¯·ç¡®ä¿ä¸»é¢˜ã€æ›²é£ã€ä¸»å”±å’Œæ ¸å¿ƒåˆ¶ä½œå›¢é˜Ÿï¼ˆä½œæ›²ã€ä½œè¯ã€ç¼–æ›²ï¼‰éƒ½å·²é€‰æ‹©ï¼");
                        return;
                    }
                } catch (collectionError) {
                    console.error("æ”¶é›†æ­Œæ›²é…ç½®æ—¶å‡ºé”™:", collectionError);
                    alert("æ”¶é›†æ­Œæ›²ä¿¡æ¯æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥é¡µé¢å…ƒç´ ã€‚");
                    return;
                }

                // --- UI åé¦ˆä¸ç¦ç”¨ ---
                showLoadingIndicator("å¼€å§‹åˆ¶ä½œæ­Œæ›²...");
           disableInteractions();
           const startBtn = document.getElementById('startProductionBtn');
           if(startBtn) startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...';

           try {
               await toggleWorldBookEntries(['COT', 'æ ¼å¼è¦æ±‚'], ['COTï¼ˆchatï¼‰']);
               await autoSaveToWorldBook();

               // è·å–æ•…äº‹æ€»ç»“ä¸Šä¸‹æ–‡
               let summaryContext = "\n\nã€æœ€è¿‘çš„æ•…äº‹æ€»ç»“å›é¡¾ã€‘\n";
               // ... (è·å– summaries çš„é€»è¾‘ä¸å˜) ...
               summaryContext += summaries.length > 0 ? summaries.map(s => `${s.id}. ${s.content}`).join('\n') : "æš‚æ— æ€»ç»“ã€‚";
               summaryContext += "\n";

               // æ„å»ºé…ç½®æ–‡æœ¬
               let configText = `ä¸»é¢˜: ${songConfig.theme}, æ›²é£: ${songConfig.style}, ä¸»å”±: ${songConfig.mainVocal}`;
               if (songConfig.subVocals.length > 0) configText += `, å’Œå£°: ${songConfig.subVocals.join(', ')}`;
               configText += `\nåˆ¶ä½œå›¢é˜Ÿ: ä½œæ›²-${songConfig.productionTeam.composer}, ä½œè¯-${songConfig.productionTeam.lyricist}, ç¼–æ›²-${songConfig.productionTeam.arranger}`;
               if (songConfig.mv.director) configText += `\nMVè®¡åˆ’: å¯¼æ¼”-${songConfig.mv.director}, æ¦‚å¿µ-${songConfig.mv.concept || 'æœªå¡«å†™'}`;
               configText += `\nä¼°ç®—æ€»æˆæœ¬: ${totalCostTextForPrompt}`; // totalCostTextForPrompt åœ¨å‰é¢å·²è·å–

               // ã€ä¿®æ”¹ã€‘æ„å»ºæ³¨å…¥çš„ç³»ç»ŸæŒ‡ä»¤
               const systemInstruction = `--- CORE ACTION THIS TURN ---\n` +
                                        `**Player Character Action:** {{user}} initiated the production of a new song with the following configuration:\n` +
                                        `**Action Detail:**\n${configText}\n` + // åŒ…å«è¯¦ç»†é…ç½®
                                        `**Instruction:** This song production initiation is the ABSOLUTE FOCUS. You MUST process this request:\n` +
                                        `1. Check if conditions are met (e.g., sufficient funds: ${estimatedTotalCost}).\n` +
                                        `2. If met, update the game state (deduct funds, add a new task to \`plan\` with status 'inprogress' to track production, potentially adjust mood/schedule).\n` +
                                        `3. Generate narrative describing the *initiation* of the production (e.g., meeting, reactions).\n` +
                                        `4. Output ONLY the \`<gametext>\` containing the *complete* updated game state (or reflecting failure).\n\n` +
                                        `--- Execution Context & Guidelines ---\n` +
                                        `${summaryContext}\n` +
                                        `ã€<å›å¤æ ¼å¼> æŒ‡ä»¤ã€‘\n` + // å¼•ç”¨å¤–éƒ¨çš„ CoT/å›å¤æ ¼å¼
                                        `Please strictly follow the rules defined in \`<å›å¤æ ¼å¼>\` (your CoT, Thinking Format v3.0).\n`;

               console.log("System Instruction for generate:", systemInstruction);

               // ã€ä¿®æ”¹ã€‘è°ƒç”¨ generate
               const rawLLMResponse = await generate({
                   user_input: `å¼€å§‹åˆ¶ä½œæ–°æ­Œï¼š${songConfig.theme} - ${songConfig.style}`, // <--- ç®€åŒ–çš„ç”¨æˆ·æ„å›¾
                   should_stream: false,
                   injects: [
                       {
                           role: 'system',
                           content: systemInstruction,
                           position: 'before_prompt',
                           depth: 0,
                           should_scan: false
                       }
                   ]
                   // max_chat_history: 0 // é€šå¸¸ä¸éœ€è¦èŠå¤©å†å²
               });



                    // --- JSON Processing Logic Start --- (ä¸ selectStoryOption å®Œå…¨ç›¸åŒ)

                    // 1. æå–å®Œæ•´çš„ <gametext>...</gametext> å—
                    const fullGameTextBlock = extractGameText(rawLLMResponse);
                    console.log("[è°ƒè¯•] 1. Extracted fullGameTextBlock:", fullGameTextBlock);

                    let newGameData = null;
                    let messageToSave = rawLLMResponse;

                    if (fullGameTextBlock) {
                        // 2. å°è¯•ä»å®Œæ•´å—ä¸­æå– JSON å†…å®¹è¿›è¡Œè§£æ
                        const contentMatch = fullGameTextBlock.match(/<gametext>([\s\S]*?)<\/gametext>/i);
                        const contentToParse = contentMatch?.[1]?.trim() ?? null;
                        console.log("[è°ƒè¯•] 2. Content extracted for parsing:", contentToParse);

                        if (contentToParse) {
                            // 3. æ¸…ç†æ½œåœ¨çš„ Markdown æ ‡è®°
                            let cleanedContentForParse = contentToParse.replace(/^```json\s*/, '').replace(/\s*```$/, '').trim();
                            console.log("[è°ƒè¯•] 3. Cleaned content for parsing:", cleanedContentForParse);

                            // 4. å°è¯•è§£æ JSON
                            try {
                                console.log("[è°ƒè¯•] 4. Attempting JSON.parse...");
                                newGameData = JSON.parse(cleanedContentForParse);
                                messageToSave = fullGameTextBlock; // ä¿å­˜å®Œæ•´å—
                                console.log("æˆåŠŸè§£æ gametext å†…å®¹ã€‚ messageToSave å°†æ˜¯å®Œæ•´å—ã€‚"); // æ—¥å¿— 5
                                // è§£ææˆåŠŸï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ—ç™½æç¤ºï¼ˆå¦‚èµ„é‡‘ä¸è¶³ï¼‰
                                const lastDialogue = newGameData?.story?.dialogue?.slice(-1)[0];
                                if (lastDialogue?.speaker === 'æ—ç™½' && lastDialogue?.content?.includes('ä¸è¶³')) {
                                     alert(`æ­Œæ›²åˆ¶ä½œæç¤º: ${lastDialogue.content}`); // å¦‚æœæœ‰æ˜ç¡®æç¤ºï¼Œæ˜¾ç¤ºå®ƒ
                                } else {
                                     alert("æ­Œæ›²åˆ¶ä½œè¯·æ±‚å·²å‘é€å¤„ç†ï¼"); // é€šç”¨æˆåŠŸæç¤º
                                }
                            } catch (parseError) {
                                // 5. è§£æå¤±è´¥å¤„ç†
                                console.error("[è°ƒè¯•] 6. JSON.parse FAILED:", parseError);
                                console.error("è§£æ gametext å†…å®¹å¤±è´¥:", parseError, "å°è¯•è§£æçš„å†…å®¹:", cleanedContentForParse);
                                console.warn("è§£æå¤±è´¥ï¼Œå°†å®Œæ•´ <gametext> å—ä½œä¸ºæ—ç™½/é”™è¯¯æç¤ºå¤„ç†ã€‚");
                                newGameData = structuredClone(gameState);
                                newGameData.story.dialogue = newGameData.story.dialogue || [];
                                if (fullGameTextBlock.trim()) {
                                    newGameData.story.dialogue.push({
                                        speaker: "æ—ç™½",
                                        content: `(ç³»ç»Ÿæç¤ºï¼šæ”¶åˆ°æ— æ³•è§£æçš„æ•°æ®å—ï¼Œé”™è¯¯: ${parseError.message})`,
                                        style: "normal"
                                    });
                                }
                                newGameData.story.options = [];
                                messageToSave = fullGameTextBlock; // ä¿å­˜åŸå§‹å—
                                alert(`æ­Œæ›²åˆ¶ä½œå¤±è´¥ï¼šæ— æ³•å¤„ç†è¿”å›çš„æ•°æ®ã€‚`); // æ˜ç¡®çš„å¤±è´¥æç¤º
                                console.log("å·²å°†æ— æ³•è§£æçš„å“åº”å—æ·»åŠ ä¸ºé”™è¯¯æç¤ºã€‚ messageToSave ä»æ˜¯å®Œæ•´å—ã€‚");
                            }
                        } else {
                            // 6. <gametext> å—å†…éƒ¨å†…å®¹æå–å¤±è´¥
                            console.error("[è°ƒè¯•] 7. <gametext> å—å†…éƒ¨å†…å®¹æå–å¤±è´¥ã€‚");
                            newGameData = structuredClone(gameState);
                            newGameData.story.dialogue = newGameData.story.dialogue || [];
                            newGameData.story.dialogue.push({
                                speaker: "æ—ç™½",
                                content: `(ç³»ç»Ÿæç¤ºï¼šæ”¶åˆ°çš„ <gametext> æ ‡ç­¾å†…éƒ¨ä¸ºç©ºæˆ–æ— æ³•æå–å†…å®¹)`,
                                style: "normal"
                            });
                            newGameData.story.options = [];
                            messageToSave = fullGameTextBlock; // ä¿å­˜æœ‰é—®é¢˜çš„å—
                             alert(`æ­Œæ›²åˆ¶ä½œå¤±è´¥ï¼šè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚`);
                            console.log("å·²å°†ç©ºçš„æˆ–æ— æ³•æå–çš„ <gametext> å—æ·»åŠ ä¸ºæç¤ºã€‚");
                        }
                    } else {
                        // 7. æœªæ‰¾åˆ° <gametext> æ ‡ç­¾
                        console.error("LLMå“åº”ä¸­æœªæ‰¾åˆ° <gametext> æ ‡ç­¾:", rawLLMResponse);
                        const trimmedResponse = rawLLMResponse ? rawLLMResponse.trim() : "";
                        if (trimmedResponse && !trimmedResponse.includes('{')) {
                            console.warn("æ—  <gametext> æ ‡ç­¾ï¼Œå°è¯•å°†æ•´ä¸ªå“åº”ä½œä¸ºæ—ç™½å¤„ç†ã€‚");
                            newGameData = structuredClone(gameState);
                            newGameData.story.dialogue = newGameData.story.dialogue || [];
                            newGameData.story.dialogue.push({ speaker: "æ—ç™½", content: trimmedResponse, style: "normal" });
                            newGameData.story.options = [];
                            messageToSave = `<gametext>${JSON.stringify(newGameData)}</gametext>`; // æ„å»º gametext ä¿å­˜
                            alert(`æ­Œæ›²åˆ¶ä½œæç¤º: ${trimmedResponse}`); // æ˜¾ç¤ºçº¯æ–‡æœ¬æç¤º
                            console.log("å·²å°†çº¯æ–‡æœ¬å“åº”å¤„ç†ä¸ºæ—ç™½å¹¶æ„å»º gametext ä¿å­˜ã€‚");
                        } else {
                             alert(`æ­Œæ›²åˆ¶ä½œå¤±è´¥ï¼šAI æœªæŒ‰é¢„æœŸæ ¼å¼è¿”å›ã€‚`);
                            throw new Error("LLMå“åº”æ— æ•ˆï¼Œç¼ºå°‘ <gametext> æ ‡ç­¾ä¸”éçº¯æ–‡æœ¬ã€‚");
                        }
                    }

                    // 8. æ›´æ–°çŠ¶æ€å¹¶ä¿å­˜ (ä»…å½“ newGameData è¢«æˆåŠŸèµ‹å€¼æ—¶)
                    if (newGameData) {
                        updateGameState(newGameData);
                        console.log("æ¸¸æˆçŠ¶æ€å’ŒUIå·²æ›´æ–°ã€‚å‡†å¤‡é™é»˜ä¿å­˜ messageToSave...");
                        console.log("[è°ƒè¯•] 8. messageToSave çš„å†…å®¹:", messageToSave);
                        if (typeof setChatMessage === 'function') {
                             await setChatMessage({ message: messageToSave }, 0, { refresh: 'none' }); // ä¿å­˜ messageToSave
                             console.log("é™é»˜ä¿å­˜å®Œæˆã€‚");
                        } else {
                             console.warn("setChatMessage å‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•é™é»˜ä¿å­˜ã€‚");
                        }
                    } else {
                        console.error("æœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„ newGameDataï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°å’Œä¿å­˜ã€‚");
                        // é”™è¯¯å·²ç»åœ¨ä¸Šé¢å¤„ç†å¹¶ alert äº†ï¼Œè¿™é‡Œä¸å†æŠ›å‡ºï¼Œé¿å…é‡å¤æç¤º
                        // throw new Error("æœªèƒ½å¤„ç†LLMå“åº”ä»¥æ›´æ–°æ¸¸æˆçŠ¶æ€ã€‚");
                    }

                    // --- JSON Processing Logic End ---

                } catch (error) {
                    console.error("å¤„ç†æ­Œæ›²åˆ¶ä½œæ—¶å‘ç”Ÿé”™è¯¯:", error);
                    // é¿å…é‡å¤ alert
                    // alert(`å¼€å§‹åˆ¶ä½œæ­Œæ›²æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}\nè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚`);
                } finally {
                    hideLoadingIndicator();
                    enableInteractions();
                    if (startBtn) startBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹åˆ¶ä½œ'; // æ¢å¤æŒ‰é’®
                    console.log("æ­Œæ›²åˆ¶ä½œå¤„ç†æµç¨‹ç»“æŸ (finally)ã€‚");
                }
            });


             // ç‰¹è®­é¡µ
              const trainingGrid = document.getElementById('trainingPage')?.querySelector('.training-grid');
              if (trainingGrid) {
                   trainingGrid.addEventListener('click', (e) => {
                        const trainButton = e.target.closest('.btn-train');
                        if (trainButton) {
                             console.log("è®­ç»ƒæŒ‰é’®è¢«ç‚¹å‡» (äº‹ä»¶å§”æ‰˜)");
                             startTraining(trainButton);
                        }
                   });
              }

            console.log("DOMContentLoaded - äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ");
        });

        // --- Cleaned Up Code Ends ---

    </script>
</body>
</html>
```