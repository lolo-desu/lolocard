---
主线事件系统:
  rule:
    - 根据亲密度和当前状态触发并推进结构化的主线事件，触发条件为络络.亲密度 >= 50 && 世界.当前主线事件阶段 == 0 && 世界.主线事件冷却计数 <= 0
    - 事件分为引入(1)、发展(2)、高潮(3)、解决(4)四个阶段
    - 结束后有20回合冷却期
  status:
    当前主线事件ID: # :{{get_message_variable::stat_data.世界.当前主线事件ID}} # 值为'无'表示当前没有主线事件
    当前主线事件阶段: # :{{get_message_variable::stat_data.世界.当前主线事件阶段}} # 0:无, 1:引入, 2:发展, 3:高潮, 4:解决
    主线事件冷却计数: # :{{get_message_variable::stat_data.世界.主线事件冷却计数}} # 大于0表示冷却中
# :<%_
# :const 主线事件库 = {
# :  生病照顾: '<user>有些身体不适，大概得了感冒发烧一类的病，络络得知之后来照顾<user>',
# :  大学竞赛: '络络收到了一所知名大学的邀请函，但需要参加一个竞赛，她想请<user>一起准备',
# :  情敌出现: '出现了一个对<user>表示好感的第三方角色，络络很是吃醋...',
# :  文化节负责人: '络络被选为学校文化节的负责人，希望<user>能帮助他',
# :  夏日祭邀请: '夏日祭就要到了，络络想要邀请和<user>一起参加',
# :  一起组乐队: '文化节上，络络打算和<user>组乐队一起上台表演',
# :  医院复诊: '络络被通知回到医院复诊，也许需要再次治疗',
# :  工作调动: '父母工作调动，络络被要求跟着父母前往国外，但是...',
# :  鬼鬼祟祟: '在街上看到络络乔装打扮神神秘秘，原来竟是隐藏的二次元爱好（逛漫画和宅店）',
# :  参加社团: '络络想要参加一个学校社团，但是希望和<user>一起',
# :};
# :const 事件ID列表 = Object.keys(主线事件库);
# :
# :function 判断主线事件() {
# :  switch (getvar('stat_data.世界.当前主线事件阶段')) {
# :    case 0:
# :      if (getvar('stat_data.络络.亲密度') < 50) {
# :        return `
# :  系统提示:
# :    - 亲密度不足，无法触发主线事件
# :`;
# :      }
# :      if (getvar('stat_data.世界.主线事件冷却计数') > 0) {
# :        const cleanup_commands = '';
# :        if (getvar('stat_data.世界.当前主线事件ID') !== '无') {
# :          cleanup_commands += `\n    - 你必须在本次<UpdateVariable>中输出以下内容来清除当前主线事件ID: _.set('世界.当前主线事件ID', '无');`;
# :        }
# :        if (getvar('stat_data.世界.当前主线故事大纲') !== '无') {
# :          cleanup_commands += `\n    - 你必须在本次<UpdateVariable>中输出以下内容来清除当前主线故事大纲: _.set('世界.当前主线故事大纲', '无' );`;
# :        }
# :        return `
# :  系统提示:
# :    - 主线事件冷却中（剩余${getvar('stat_data.世界.主线事件冷却计数')}回合）
# :  rule:
# :    - 你必须在本次<UpdateVariable>中输出以下内容来减少冷却计数: _.set('世界.主线事件冷却计数', ${getvar('stat_data.世界.主线事件冷却计数') - 1});${cleanup_commands}
# :`;
# :      } else {
# :        const 选定事件ID = _.sample(事件ID列表);
# :        const 事件描述 = 主线事件库[选定事件ID];
# :        return `
# :  系统提示:
# :    - 检测到亲密度达标且无主线，冷却已结束，已触发新事件
# :    - 触发事件：${选定事件ID} (${事件描述})
# :    - 当前阶段：1 - 引入/开端
# :  rule:
# :    - 你必须在正文底部输出事件情况
# :    - 你需要开始将这个事件引入故事，比如角色得知消息、表达意愿、初步讨论等。**重点是交代事件背景和角色的初步反应**，不要急于推进
# :    - 你必须在本次<UpdateVariable>中输出以下内容以触发新事件
# :  format: |-
# :    <!-- 当前主线事件: ${事件描述} -->
# :    <UpdateVariable>
# :    _.set('世界.当前主线事件ID', '${选定事件ID}');
# :    _.set('世界.当前主线事件阶段', 1);
# :    _.set('世界.当前主线故事大纲', '\${根据触发的事件${选定事件ID}(${事件描述})，构思一个包含引入、发展、高潮、解决四个阶段的简要剧情大纲，每个阶段几句话即可，用序号分割，必须一行写完禁止换行。如果出现新角色，不应该使用代称而是使用全名}');
# :    ...
# :    </UpdateVariable>
# :`;
# :      }
# :    case 1: {
# :      const 事件描述 = 主线事件库?.[getvar('stat_data.世界.当前主线事件ID')] ?? '未知事件';
# :      return `
# :  系统提示:
# :    - 主线事件进行中 - 阶段 1
# :    - 当前主线事件: ${事件描述}
# :    - 当前阶段: 1 - 引入/开端
# :    - 参考大纲: ${getvar('stat_data.世界.当前主线故事大纲').replace(/\n/g, '')}
# :  rule:
# :    - 剧情参考上方大纲的“引入”部分，应围绕事件的开端展开，角色了解情况，做出初步反应或计划，为进入下一阶段“发展”做铺垫
# :    - 若参考大纲中无内容，则你应该在<UpdateVariable>中编写大纲: _.set('世界.当前主线故事大纲', '\${根据触发的事件${getvar('stat_data.世界.当前主线事件ID')}(${事件描述})，构思一个包含引入、发展、高潮、解决四个阶段的简要剧情大纲，每个阶段几句话即可，用序号分割，必须一行写完禁止换行。如果出现新角色，不应该使用代称而是使用全名}');
# :    - 当剧情自然发展到角色开始**实际行动或准备**时，在<UpdateVariable>中添加：_.set('世界.当前主线事件阶段', 2);
# :`;
# :    }
# :    case 2: {
# :      const 事件描述 = 主线事件库?.[getvar('stat_data.世界.当前主线事件ID')] ?? '未知事件';
# :      return `
# :  系统提示:
# :    - 主线事件进行中 - 阶段 2
# :    - 当前主线事件: ${事件描述}
# :    - 当前阶段: 2 - 发展/推进
# :    - 参考大纲: ${getvar('stat_data.世界.当前主线故事大纲').replace(/\n/g, '')}
# :  rule:
# :    - 剧情参考上方大纲的“发展”部分，应集中于角色为事件目标而**努力、行动、遇到挑战或取得进展**的过程，为进入下一阶段“高潮/转折”积蓄能量，应逐渐增强矛盾或期待感
# :    - 这阶段是主线故事的主体部分，可以安排一些互动、困难或小成功
# :    - 你必须专注故事发展，请将不重要的内容略过。本次输出必须**加速剧情的推进**，让高潮快速到来
# :    - 当剧情发展到事件**最关键的时刻**（如比赛当天、联谊会现场、秘密被揭穿的关键点、文化节开幕等）时，或者你认为任何重要的时刻，在<UpdateVariable>中添加：_.set('世界.当前主线事件阶段', 3);
# :`;
# :    }
# :    case 3: {
# :      const 事件描述 = 主线事件库?.[getvar('stat_data.世界.当前主线事件ID')] ?? '未知事件';
# :      return `
# :  系统提示:
# :    - 主线事件进行中 - 阶段 3
# :    - 当前主线事件: ${事件描述}
# :    - 当前阶段: 3 - 高潮/转折
# :    - 参考大纲: ${getvar('stat_data.世界.当前主线故事大纲').replace(/\n/g, '')}
# :  rule:
# :    - 剧情参考上方大纲的“高潮”部分，应聚焦于事件的**顶点或转折点**。描写最紧张、最重要、情感最强烈的场面
# :    - 展示努力的结果（无论好坏）、冲突的爆发、关键的决策或表白等
# :    - 事件的核心矛盾应在此阶段得到解决或明确结果
# :    - 当高潮情节**已经明确结束**，开始进入收尾或展示后果时，在<UpdateVariable>中添加：_.set('世界.当前主线事件阶段', 4);
# :`;
# :    }
# :    case 4: {
# :      const 事件描述 = 主线事件库?.[getvar('stat_data.世界.当前主线事件ID')] ?? '未知事件';
# :      const 冷却期 = 20;
# :      return `
# :  系统提示:
# :    - 主线事件进行中 - 阶段 4
# :    - 当前主线事件: ${事件描述}
# :    - 当前阶段: 4 - 解决/尾声
# :    - 参考大纲: ${getvar('stat_data.世界.当前主线故事大纲').replace(/\n/g, '')}
# :  rule:
# :    - 剧情参考上方大纲的“解决”部分，应描写事件结束后的**余波、反思、总结或庆祝**
# :    - 展示事件对角色关系带来的影响（变得更亲近、产生隔阂后和解等）
# :    - 这阶段是事件的收尾阶段，让故事平稳落地
# :    - 当关于此事件的故事**彻底结束**，一切尘埃落定时，在<UpdateVariable>中添加以下内容: |-
# :        _.set('世界.当前主线事件ID', '${getvar('stat_data.世界.当前主线事件ID')}', '无');
# :        _.set('世界.当前主线事件阶段', 0);
# :        _.set('世界.当前主线故事大纲', '${getvar('stat_data.世界.当前主线故事大纲')}', '无');
# :        _.set('世界.主线事件冷却计数', ${冷却期});
# :`;
# :    }
# :  }
# :}
# :_%>
# :<%= 判断主线事件() %>
