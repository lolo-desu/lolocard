{
    "id": "bc91615d-f2b2-4603-bbe1-7083f6e2c30b",
    "scriptName": "(typescript)同层手机仅免费发布于discord。原作者：暴力美学BLMX 美化作者：jingyuyidao 络络改版",
    "findRegex": "===BLMX_LOG_BEGIN===\\s*([\\s\\S]*?)\\s*===BLMX_LOG_END===",
    "replaceString": "```html\n<!doctype html><html lang=\"zh-CN\"><head><meta charset=\"UTF-8\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1,user-scalable=no\"/><title>暴力美学BLMX同层手机</title><style>@font-face{font-family:MyCustomFont;src:url('https://files.catbox.moe/er4wsg.ttf')}html{font-size:16px}@media (max-width:360px){html{font-size:calc(100vw / 360 * 16)}}:root{--text-color:#ffffff;--primary-blue:#72adf3;--light-blue:#a8cbeb;--ultra-light-blue:#e8f4fd;--blue-gradient-start:#accef2;--blue-gradient-end:#98c2f5;--soft-blue:#b8d4f0;--deep-blue:#2c5282;--wechat-green-icon:var(--primary-blue);--wechat-green-bubble:var(--light-blue);--wechat-bg:var(--ultra-light-blue);--link-color:var(--primary-blue);--footer-height:2.8125rem;--panel-height:14.0625rem;--bubble-shadow:0 2px 8px rgba(74, 144, 226, 0.15);--text-primary:rgb(139, 162, 186);--text-secondary:#64748b;--border-color:#cbd5e1;--header-bg:linear-gradient(135deg, #f8faff 0%, #eef4ff 100%);--wechat-bubble-them-bg:#ffffff;--wechat-bubble-me-bg:var(--light-blue);--status-bar-color:#428af2;--dynamic-island-color:#a0c4f4;--app-bg-color:#ffffff;--settings-bg-color:#f2f2f7;--settings-card-bg-color:#ffffff;--shadow-color:#4a90e2;--shadow-color-rgba:rgba(74, 144, 226, 0.3);--sticker-size:120px}body.dark-mode{background-color:transparent}body.dark-mode .app-view{background-color:var(--app-bg-color)}body.dark-mode .settings-card{background-color:var(--settings-card-bg-color)}body.dark-mode .settings-card a,body.dark-mode .settings-card p{color:var(--text-primary)}body.dark-mode .settings-card li{border-bottom-color:var(--border-color)}body.dark-mode .settings-card li a{color:var(--text-primary)}body.dark-mode #show-last-ai-response-btn,body.dark-mode #show-last-sent-prompt-btn{background-color:var(--settings-card-bg-color);color:var(--text-primary)}body{margin:0;padding:.25rem;min-height:100vh;display:flex;justify-content:center;align-items:center;box-sizing:border-box;background:0 0;font-family:MyCustomFont,sans-serif}.phone-frame{max-width:360px;width:100%;padding:.6rem;background:var(--phoneFrame,var(--primary-blue));border-radius:3.125rem;position:relative;box-shadow:0 15px 20px var(--shadow-color-rgba),0 8px 20px var(--shadow-color-rgba),0 3px 8px rgba(0,0,0,.1),inset 0 1px 0 rgba(255,255,255,.5),inset 0 -1px 0 rgba(255,255,255,.2),0 5px var(--shadow-color-rgba);transition:box-shadow .3s ease,background .3s ease}.phone-frame::before{content:'';position:absolute;top:-2px;left:-2px;right:-2px;bottom:-2px;border-radius:3.125rem;background:linear-gradient(45deg,var(--primary-blue),var(--blue-gradient-end),var(--blue-gradient-start),var(--primary-blue));background-size:400% 400%;animation:gradientFlow 3s ease infinite;z-index:-1}@keyframes gradientFlow{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}.phone-screen{height:48.75rem;border-radius:2.8rem;overflow:hidden;position:relative;display:flex;flex-direction:column;background-color:var(--wechat-bg);box-shadow:inset 0 0 0 1px rgba(0,0,0,.08),inset 0 0 15px rgba(0,0,0,.03)}.phone-screen::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;border-radius:2.25rem;box-shadow:inset 0 1px 0 rgba(255,255,255,.2),inset 0 -1px 0 rgba(0,0,0,.1),inset 1px 0 0 rgba(255,255,255,.1),inset -1px 0 0 rgba(0,0,0,.1);pointer-events:none;z-index:1000}.dynamic-island{position:absolute;top:.625rem;left:50%;transform:translateX(-50%);width:8.4375rem;height:2rem;background:var(--dynamic-island-color);border-radius:1rem;z-index:100}.phone-status-bar{position:absolute;top:.625rem;left:0;right:0;height:2rem;z-index:102;display:flex;justify-content:space-between;align-items:center;padding:0 1.5rem;pointer-events:none}.status-left{display:flex;align-items:center;gap:.4rem;color:var(--status-bar-color);font-size:.95em;font-weight:600}.status-right{display:flex;align-items:center;gap:.35rem;color:var(--status-bar-color);font-size:.9em;font-weight:600}.moon-icon{font-size:.8em;opacity:.9}.battery-icon,.signal-bars,.wifi-icon{font-size:.85em}#hidden-send-trigger{position:absolute;top:.625rem;right:1rem;width:80px;height:2rem;z-index:103;cursor:pointer}#delete-mode-trigger{position:absolute;top:.625rem;left:1rem;width:60px;height:2rem;z-index:103;cursor:pointer}#wechat-view.delete-mode .wechat-body{padding-left:25px;padding-right:25px}#wechat-view.delete-mode .event-log-row,#wechat-view.delete-mode .message-row,#wechat-view.delete-mode .timestamp-row{cursor:pointer;position:relative}#wechat-view.delete-mode [data-log-index]::before{content:'×';position:absolute;left:-22px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,var(--blue-gradient-start) 0,var(--primary-blue) 100%);color:#fff;border-radius:50%;width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:400;box-shadow:0 2px 6px var(--shadow-color-rgba);transition:all .2s ease;line-height:1;text-align:center;font-family:Arial,sans-serif}#wechat-view.delete-mode .message-row.me[data-log-index]::before{left:auto;right:-22px}#wechat-view.delete-mode [data-log-index]:hover::before{transform:translateY(-50%) scale(1.1);box-shadow:0 4px 8px var(--shadow-color-rgba)}.feature-item .sticker-checkbox{position:absolute;top:2px;right:2px;width:1rem;height:1rem;accent-color:var(--primary-blue);cursor:pointer;border-radius:3px;transition:all .2s ease;display:none}.feature-item:has(.sticker-checkbox:checked) .feature-icon{border:2px solid var(--primary-blue);box-shadow:0 0 0 2px var(--shadow-color-rgba);transform:scale(.95)}.message-row .message-bubble.sticker-bubble img{border-radius:1.2rem}.app-view{position:absolute;top:0;left:0;right:0;bottom:0;z-index:60;border-radius:2.25rem;visibility:hidden;opacity:0;transition:opacity .3s ease,visibility .3s ease;display:flex;flex-direction:column;backface-visibility:hidden}.app-view.active{visibility:visible;opacity:1;z-index:80}.app-screen{padding:3.75rem 1rem 1.375rem 1rem;flex-grow:1;background-image:url('https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/白色_1.jpg');background-size:cover;background-position:center}.app-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}.app-icon{display:flex;flex-direction:column;align-items:center;text-align:center;text-decoration:none;cursor:pointer}.app-icon .icon-image{width:4.0625rem;height:4.0625rem;background-color:var(--primary-blue);border-radius:22.5%;margin-bottom:.4375rem;background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;font-size:2.2em;transition:transform .2s ease}.app-icon:hover .icon-image{transform:scale(1.05)}.app-icon .app-name{color:var(--text-color);font-size:.75em;font-weight:400;text-shadow:0 .0625rem .125rem rgba(0,0,0,.5)}.icon-settings,.icon-wechat{background:linear-gradient(135deg,var(--blue-gradient-start) 0,var(--blue-gradient-end) 100%);color:#fff;box-shadow:0 4px 12px var(--shadow-color-rgba)}#settings-view{background-color:var(--settings-bg-color)}.settings-header{flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:var(--header-bg);border-bottom:1px solid var(--border-color);padding-top:2.8125rem;position:relative;z-index:10}.settings-header .back-btn{font-size:1.2em;color:var(--primary-blue);cursor:pointer}.settings-header .title{font-weight:600;color:var(--text-primary);font-size:1em;position:absolute;left:50%;transform:translateX(-50%)}.settings-body{flex-grow:1;padding:1.25rem;overflow-y:auto}.settings-card{background-color:var(--settings-card-bg-color);border-radius:.75rem;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.05)}.settings-card p{font-size:.9em;line-height:1.6;color:var(--text-primary);margin:0 0 1rem 0}.settings-card p:last-child{margin-bottom:0}.settings-card .highlight{color:#e6a23c;font-weight:700}.settings-card a{color:var(--primary-blue)}.settings-card a:hover{text-decoration:underline}#wechat-view{background-image:url('https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/白色_1.jpg');background-size:cover;background-position:center;background-repeat:no-repeat}.wechat-header{flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:var(--header-bg);border-bottom:1px solid var(--border-color);padding-top:2.8125rem;position:relative;z-index:10}.moments-header .header-action,.wechat-header .back-btn,.wechat-header .options-btn{font-size:1.2em;color:var(--primary-blue);cursor:pointer;transition:color .2s ease}.wechat-header .back-btn:hover,.wechat-header .options-btn:hover{color:var(--deep-blue)}.wechat-header .contact-name{font-weight:600;background:var(--primary-blue);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:1em;cursor:pointer;left:50%}.wechat-body{flex:1 1 auto;overflow-y:auto;padding:.9375rem .5rem;overflow-x:hidden}.message-row.new-message{animation:messageSlideIn .5s cubic-bezier(.22,.61,.36,1)}.message-row{display:flex;margin-bottom:1.125rem;align-items:flex-start}@keyframes messageSlideIn{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}.typing-indicator{display:flex;margin-bottom:1.125rem;align-items:flex-start}.typing-indicator .message-avatar{margin-right:.625rem;width:2.25rem;height:2.25rem;border-radius:50%;flex-shrink:0}.typing-indicator .message-bubble{display:flex;align-items:center;justify-content:center;padding:.75rem 1rem;background:linear-gradient(135deg,#fff 0,#f8faff 100%);color:var(--text-primary);border:1px solid var(--border-color);border-bottom-left-radius:.4rem;box-shadow:var(--bubble-shadow)}.typing-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:var(--text-secondary);margin:0 2px;animation:typing-bounce 1.4s infinite ease-in-out both}.typing-dot:first-child{animation-delay:-.32s}.typing-dot:nth-child(2){animation-delay:-.16s}.typing-dot:nth-child(3){animation-delay:0s}@keyframes typing-bounce{0%,100%,80%{transform:scale(0)}40%{transform:scale(1)}}.message-row.me{justify-content:flex-end}.timestamp-row{text-align:center;margin:.5rem 0}.timestamp-text{display:inline-block;background:linear-gradient(135deg,var(--soft-blue) 0,var(--light-blue) 100%);color:#fff;font-size:.7em;padding:.3rem .8rem;border-radius:1rem;font-weight:500;box-shadow:0 2px 6px var(--shadow-color-rgba)}.recall-notice-container{display:inline-flex;flex-direction:column;align-items:center}.recall-notice-text{background:linear-gradient(135deg,var(--soft-blue) 0,var(--light-blue) 100%);color:#fff;font-size:.7em;padding:.3rem .8rem;border-radius:1rem;cursor:pointer;transition:all .2s ease}.recall-notice-text:hover{transform:translateY(-1px);box-shadow:0 4px 8px var(--shadow-color-rgba)}.recall-content{color:#888;font-size:.75em;padding:0;max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out}.recall-content.expanded{max-height:6.25rem;padding:.3125rem 0 0 0}.message-avatar{width:2.25rem;height:2.25rem;border-radius:50%;flex-shrink:0;object-fit:cover;background-color:#ccc;cursor:pointer}.message-row.them .message-avatar{margin-right:.625rem}.message-row.me .message-avatar{margin-left:.625rem}.message-bubble{position:relative;padding:.75rem 1rem;border-radius:1.2rem;max-width:65%;font-size:.9em;line-height:1.4;word-wrap:break-word;user-select:none;box-shadow:var(--bubble-shadow);transition:all .2s ease}.message-bubble img:not(.sticker-img){max-width:10rem;max-height:10rem;display:block;border-radius:.5rem}.message-row.them .message-bubble{background:linear-gradient(135deg,#fff 0,#f8faff 100%);color:var(--text-primary);border:1px solid var(--border-color);border-bottom-left-radius:.4rem}.message-row.me .message-bubble{background:linear-gradient(135deg,var(--blue-gradient-start) 0,var(--blue-gradient-end) 100%);color:#fff;border-bottom-right-radius:.4rem;box-shadow:0 4px 12px var(--shadow-color-rgba)}.message-bubble::after{display:none}.message-row .message-bubble.file-bubble,.message-row .message-bubble.image-desc-bubble,.message-row .message-bubble.image-url-bubble,.message-row .message-bubble.location-bubble,.message-row .message-bubble.sticker-bubble,.message-row .message-bubble.transfer-bubble{content:none;background:0 0!important;padding:0;border:none;box-shadow:none}.message-row .message-bubble.file-bubble,.message-row .message-bubble.gift-bubble,.message-row .message-bubble.location-bubble,.message-row .message-bubble.transfer-bubble{width:12.5rem;max-width:12.5rem}.event-log-row{text-align:center;margin:.5rem 0}.event-log-container{display:inline-flex;flex-direction:column;align-items:center}.event-time-text{background:linear-gradient(135deg,var(--soft-blue) 0,var(--light-blue) 100%);color:#fff;font-weight:500;box-shadow:0 2px 6px var(--shadow-color-rgba);display:inline-flex;align-items:center;justify-content:center;font-size:.75em;padding:.1875rem .4375rem;border-radius:.25rem}.event-time-text.has-desc{cursor:pointer}.event-description{color:#888;font-size:.75em;padding:0;max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out}.event-description.expanded{max-height:6.25rem;padding:.3125rem 0 0 0}.message-bubble.voice-bubble{display:flex;align-items:center;cursor:pointer;min-width:5rem;padding:.75rem 1rem}.message-row.them .message-bubble.voice-bubble{background:linear-gradient(135deg,#fff 0,#f8faff 100%)!important;border:1px solid var(--border-color)!important}.message-row.me .message-bubble.voice-bubble{background:linear-gradient(135deg,var(--blue-gradient-start) 0,var(--blue-gradient-end) 100%)!important}.voice-bubble .voice-icon{font-size:1.1em;margin:0 .5rem}.message-row.them .voice-bubble .voice-icon{color:var(--primary-blue);transform:rotate(90deg)}.message-row.me .voice-bubble .voice-icon{color:#fff;transform:rotate(270deg)}.voice-text-content{display:none;background-color:#fff;padding:.5rem .625rem;border-radius:.3125rem;border:.0625rem solid #e5e5e5;max-width:65%;font-size:.9em;line-height:1.4;color:var(--text-primary);word-wrap:break-word;user-select:text;margin-top:.3125rem;box-shadow:0 .0625rem .125rem rgba(0,0,0,.1)}body.dark-mode .voice-text-content{background-color:#2c2c2c;border-color:#3c3c3c;color:#f0f0f0;box-shadow:0 .0625rem .125rem rgba(0,0,0,.3)}.message-row.voice-text-visible .voice-text-content{display:block}.message-content-container{display:flex;flex-direction:column}.message-row.me .message-content-container{align-items:flex-end}.message-row.them .message-content-container{align-items:flex-start}.image-desc-content{width:8.4375rem;height:8.4375rem;backdrop-filter:blur(10px);background-color:rgba(255,255,255,.5);border:.0625rem solid rgba(255,255,255,.2);border-radius:1.2rem;padding:.5rem;color:var(--text-primary);font-weight:400;overflow-y:auto;box-sizing:border-box;font-size:.9em;display:flex;flex-direction:column;box-shadow:0 4px 12px rgba(74,144,226,.1),0 2px 6px rgba(74,144,226,.2);transition:all .2s ease}body.dark-mode .image-desc-content{background-color:rgba(30,30,30,.7);border:.0625rem solid rgba(60,60,60,.4);color:#f0f0f0;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.2)}.text-wrapper{margin:auto;text-align:center;line-height:1.4;word-wrap:break-word;max-height:100%}.location-bubble .location-card{background-color:#fff;border-radius:1.2rem;overflow:hidden;box-shadow:0 4px 12px rgba(74,144,226,.15),0 2px 6px rgba(74,144,226,.1);transition:all .2s ease}body.dark-mode .location-bubble .location-card{background-color:#2c2c2c;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}.location-content{padding:.5rem}.location-content .location-title{font-size:1em;color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}body.dark-mode .location-content .location-title{color:#f0f0f0}.location-content .location-subtitle{font-size:.75em;color:#888}body.dark-mode .location-content .location-subtitle{color:#aaa}.location-map-placeholder{height:5.625rem;position:relative;background-color:#f0f8ff;overflow:hidden}.location-map-placeholder::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background-image:repeating-linear-gradient(45deg,#d2e1f2 0,#d2e1f2 4px,transparent 4px,transparent 8px),repeating-linear-gradient(135deg,#9bdaf7 0,#9bdaf7 3px,transparent 3px,transparent 7px),linear-gradient(to bottom,#bad8fb 0,#bad8fb 100%),linear-gradient(to bottom,#d0daf4 0,#d0daf4 100%),linear-gradient(to right,#bad8fb 0,#bad8fb 100%),linear-gradient(to right,#d0daf4 0,#dbe8f3 100%),radial-gradient(ellipse at 20% 85%,#daf9f3 30%,transparent 31%),radial-gradient(ellipse at 80% 30%,#d0ecf4 40%,transparent 41%);background-size:40% 35%,30% 30%,10px 100%,6px 100%,100% 10px,100% 6px,100% 100%,100% 100%;background-position:-5% 110%,100% 0,70% center,70% center,center 35%,center 35%,0 0,0 0;background-repeat:no-repeat}.location-map-placeholder::after{content:'\\f3c5';font-family:'Font Awesome 6 Free';font-weight:900;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.8em;color:var(--primary-blue);filter:drop-shadow(0 0 8px rgba(114, 173, 243, .6)) drop-shadow(0 0 4px rgba(114, 173, 243, .4)) drop-shadow(0 2px 4px rgba(255, 255, 255, .8));z-index:10;animation:pinPulse 2s ease-in-out infinite}@keyframes pinPulse{0%,100%{transform:translate(-50%,-50%) scale(1);filter:drop-shadow(0 0 8px rgba(114, 173, 243, .6)) drop-shadow(0 0 4px rgba(114, 173, 243, .4)) drop-shadow(0 2px 4px rgba(255, 255, 255, .8))}50%{transform:translate(-50%,-50%) scale(1.1);filter:drop-shadow(0 0 12px rgba(114, 173, 243, .8)) drop-shadow(0 0 6px rgba(114, 173, 243, .6)) drop-shadow(0 3px 6px rgba(255, 255, 255, .9))}}.location-map-placeholder:hover::before{opacity:.9;transition:opacity .3s ease}.transfer-bubble .transfer-card{border-radius:1.2rem;overflow:hidden;width:100%}.transfer-card.transfer-initial{background:linear-gradient(135deg,#fa9e3b 0,#f8802a 50%,#f76a1c 100%);box-shadow:0 4px 15px rgba(247,106,28,.3),0 2px 8px rgba(247,106,28,.2),inset 0 1px 0 rgba(255,255,255,.2);color:#fff}.transfer-card.them{cursor:pointer;transition:all .2s ease}.transfer-card.them:hover{transform:translateY(-1px);box-shadow:0 6px 12px rgba(247,106,28,.4)}.transfer-card.transfer-receipt{background:linear-gradient(135deg,#ffd0a1 0,#ffbe80 30%,#ffbe80 45%,#ffd0a1 100%);color:#fff;box-shadow:0 4px 16px rgba(247,106,28,.25),0 2px 6px rgba(247,106,28,.15),inset 0 1px 1px rgba(255,255,255,.2)}.transfer-initial .transfer-footer{color:rgba(255,255,255,.85);border-top:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05)}.transfer-receipt .transfer-footer{color:#f5faff;border-top:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05)}.transfer-content{display:flex;align-items:center;padding:.75rem}.transfer-icon-image{width:2.25rem;height:2.25rem;flex-shrink:0;filter:brightness(0) invert(1)}.transfer-details{margin-left:.75rem;flex-grow:1}.transfer-details .amount{font-size:1.1em;font-weight:700}.transfer-details .note,.transfer-details .status-text{font-size:.8em;opacity:.9}.transfer-footer{font-size:.75em;padding:.1875rem .75rem}.file-bubble .file-card{background-color:#fff;border-radius:1.2rem;overflow:hidden;width:100%;box-shadow:0 4px 12px var(--shadow-color-rgba),0 2px 6px var(--shadow-color-rgba);transition:all .2s ease}body.dark-mode .file-bubble .file-card{background-color:#2c2c2c;box-shadow:0 4px 12px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}.file-content{display:flex;align-items:center;padding:.75rem;gap:.75rem}.file-icon{font-size:2.5em;color:var(--primary-blue);flex-shrink:0}.file-details .file-name{font-size:.9em;color:var(--text-primary);font-weight:500;word-break:break-all}body.dark-mode .file-details .file-name{color:#f0f0f0}.file-footer{background-color:#f7fafc;color:#888;font-size:.75em;padding:.1875rem .75rem;border-top:.0625rem solid #eaeaea}body.dark-mode .file-footer{background-color:#232323;color:#aaa;border-top:.0625rem solid #3c3c3c}.wechat-input-area{flex-shrink:0;background:var(--header-bg);position:relative;z-index:10}.wechat-footer .footer-icon{font-size:1.4em;color:var(--primary-blue)!important;cursor:pointer;transition:all .2s ease;padding:.3rem;border-radius:.5rem;flex-shrink:0}.wechat-footer .footer-icon:hover{background:var(--ultra-light-blue);transform:scale(1.1)}.wechat-footer{display:flex;align-items:center;gap:.5rem;padding:.75rem;border-top:1px solid var(--border-color);box-sizing:border-box}.wechat-footer .text-input{flex-grow:1;border:1px solid var(--border-color);background:#fff;padding:.75rem 1rem;border-radius:1.5rem;font-size:.9em;transition:all .2s ease;color:var(--text-primary);min-width:0}.wechat-footer .text-input:focus{outline:0;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(74,144,226,.1)}.wechat-footer .text-input::placeholder{color:var(--text-secondary)}.wechat-footer .send-btn{background:var(--primary-blue);color:#fff;border:none;width:2rem;height:2rem;border-radius:50%;font-size:1em;cursor:pointer;box-shadow:0 4px 12px var(--shadow-color-rgba);transition:all .2s ease;display:flex;align-items:center;justify-content:center;padding:0;line-height:1;flex-shrink:0}.wechat-footer .send-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px var(--shadow-color-rgba)}.panel-container{height:0;overflow:hidden;transition:height .3s ease}.panel-container.active{height:var(--panel-height)}.panel-view{display:none;height:100%;overflow-y:auto;padding:1.125rem .75rem;box-sizing:border-box;position:relative}.panel-view.active{display:block}.features-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1.125rem}.feature-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;position:relative}.feature-icon{width:3.375rem;height:3.375rem;background-color:#fff;border-radius:.5rem;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(74,144,226,.1);transition:all .2s ease;margin-bottom:.4375rem}.feature-item:hover .feature-icon{transform:translateY(-2px);box-shadow:0 4px 12px rgba(74,144,226,.2);border-color:var(--primary-blue)}.feature-icon .fab,.feature-icon .far,.feature-icon .fas,.feature-icon img{max-width:100%;max-height:100%;border-radius:.5rem;object-fit:cover;font-size:1.8em}.feature-icon .theme-icon{color:var(--primary-blue);font-size:1.8em}.feature-icon .fa-plus,.feature-icon .fa-trash-alt{color:var(--primary-blue)!important}.feature-label{font-size:.75em;color:#888}.message-row .message-bubble.gift-bubble{padding:0;width:12.5rem;max-width:12.5rem;overflow:hidden;background:linear-gradient(135deg,#fa9e3b 0,#f8802a 50%,#f76a1c 100%)!important;box-shadow:0 4px 15px rgba(247,106,28,.3),0 2px 8px rgba(247,106,28,.2),inset 0 1px 0 rgba(255,255,255,.2);border-radius:1.2rem;animation:transferGlow 3s ease-in-out infinite alternate}@keyframes transferGlow{from{box-shadow:0 4px 15px rgba(247,106,28,.3),0 2px 8px rgba(247,106,28,.2),inset 0 1px 0 rgba(255,255,255,.2)}to{box-shadow:0 6px 20px rgba(247,106,28,.4),0 3px 12px rgba(247,106,28,.3),inset 0 1px 0 rgba(255,255,255,.3)}}.gift-content{padding:.75rem;display:flex;align-items:center;gap:.75rem;color:#fff}.gift-icon{font-size:2.2em;color:#f0f8ff;filter:drop-shadow(0 2px 4px rgba(0, 0, 0, .2))}.gift-icon-image{width:2.25rem;height:2.25rem;filter:drop-shadow(0 2px 4px rgba(0, 0, 0, .2))}.gift-icon-emoji{font-size:2.2em;filter:drop-shadow(0 2px 4px rgba(0, 0, 0, .2))}.gift-footer{color:rgba(255,255,255,.9);font-size:.75em;padding:.1875rem .75rem;border-top:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05)}.gift-details .gift-price,.gift-details .gift-status-text{font-size:.8em;opacity:.9}#moments-view{background:linear-gradient(180deg,#fff 0,var(--ultra-light-blue) 100%);color:var(--text-primary)}.moments-header{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:var(--header-bg);border-bottom:1px solid var(--border-color);padding-top:2.8125rem;flex-shrink:0;position:relative}.moments-header .title{font-weight:600;font-size:1em;color:var(--primary-blue);position:absolute;left:50%;transform:translateX(-50%)}.moments-header .back-btn{color:var(--primary-blue);font-size:1.2em;cursor:pointer;z-index:1}.moments-header .header-action{color:var(--primary-blue);font-size:1.2em;cursor:pointer;z-index:1}.moments-body{flex-grow:1;overflow-y:auto;background-color:#fff}.moments-feed-header{position:relative;margin-bottom:1.5625rem}.moments-cover-photo{width:100%;height:14.0625rem;object-fit:cover;display:block;cursor:pointer}.moments-user-info{position:absolute;bottom:-.75rem;right:.75rem;display:flex;align-items:flex-end;gap:.75rem}.moments-user-name{color:#fff;font-size:1.1em;font-weight:700;text-shadow:0 .0625rem .1875rem rgba(0,0,0,.5);position:relative;bottom:1.375rem;cursor:pointer}.moments-user-avatar{width:3.9375rem;height:3.9375rem;border-radius:.5rem;object-fit:cover;cursor:pointer}.user-signature{position:absolute;top:4.25rem;right:0;width:14.0625rem;text-align:right;word-wrap:break-word;line-height:1.4;color:#8a8a8a;font-size:.8em}.moments-feed-list{padding:0 .75rem;list-style:none}.moment-post{display:flex;gap:.625rem;padding:1.125rem 0;border-bottom:.0625rem solid #f0f0f0}.moment-post:last-child{border-bottom:none}.post-author-avatar{width:2.375rem;height:2.375rem;border-radius:50%;flex-shrink:0;object-fit:cover;cursor:pointer}.post-details{display:flex;flex-direction:column;gap:.4375rem;flex-grow:1}.comment-author,.delete-moment-btn,.likes-section .liker-name,.post-author-name,.post-meta .comment-button{color:var(--primary-blue)}.post-content{font-size:.9em;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;color:var(--text-primary)}.post-media{margin-top:.25rem}.post-media-image{width:10rem;height:10rem;object-fit:cover;border-radius:.25rem}.post-media .image-desc-content{background-color:rgba(240,250,255,.8);border:1px solid rgba(74,149,237,.1);width:10rem;height:10rem;font-size:.9em;color:var(--text-primary);display:flex;align-items:center;justify-content:center;text-align:center;font-weight:400;padding:.8rem;box-sizing:border-box}.post-meta{display:flex;justify-content:space-between;align-items:center;color:#888;font-size:.8em}.post-meta-left{display:flex;align-items:center}.post-actions{display:flex;align-items:center;gap:.75rem}.post-meta .comment-button{background:#f7f7f7;border-radius:.1875rem;padding:.125rem .4375rem;cursor:pointer;font-size:1.1em}.post-interactions{background:#f8faff;border-radius:.5rem;margin-top:.5rem;font-size:.85em;position:relative;border:1px solid rgba(74,149,237,.08)}.post-interactions::before{content:'';position:absolute;top:-.375rem;left:.9375rem;width:0;height:0;border-left:.375rem solid transparent;border-right:.375rem solid transparent;border-bottom:.375rem solid #f8faff}.likes-section{padding:.4375rem .625rem;background:rgba(248,250,255,.6);display:flex;align-items:center;gap:.4375rem;flex-wrap:wrap}.likes-section .fa-heart{color:var(--primary-blue)}.comments-section{padding:0 .625rem .4375rem;list-style:none;border-top:.0625rem solid #eaeaea}.likes-section+.comments-section{margin-top:-.0625rem}.comments-section li{padding:.1875rem 0}.app-screen,.event-description,.file-content,.image-desc-content,.message-bubble,.moments-body,.panel-view,.recall-content,.settings-body,.voice-text-content,.wechat-body{-ms-overflow-style:none;scrollbar-width:none}.app-screen::-webkit-scrollbar,.event-description::-webkit-scrollbar,.file-content::-webkit-scrollbar,.image-desc-content::-webkit-scrollbar,.message-bubble::-webkit-scrollbar,.moments-body::-webkit-scrollbar,.panel-view::-webkit-scrollbar,.recall-content::-webkit-scrollbar,.settings-body::-webkit-scrollbar,.voice-text-content::-webkit-scrollbar,.wechat-body::-webkit-scrollbar{display:none}body.dark-mode .message-row.them .message-bubble.voice-bubble{background:linear-gradient(135deg,#3c3c3c 0,#2c2c2c 100%)!important;border:1px solid var(--border-color)!important;color:#f0f0f0}body.dark-mode .message-row.them .voice-bubble .voice-icon{color:var(--light-blue)}.phone-size-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background-color:var(--settings-card-bg-color);border:1px solid var(--border-color);border-radius:.75rem;padding:.75rem .5rem;cursor:pointer;transition:all .2s ease;gap:.5rem}.phone-size-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-color-rgba)}.phone-size-active{border-color:var(--primary-blue);background-color:rgba(var(--shadow-r),var(--shadow-g),var(--shadow-b),.05);box-shadow:0 2px 8px var(--shadow-color-rgba)}.size-icon{width:10px;background-color:var(--primary-blue);border-radius:2px}.size-label{font-size:.8em;color:var(--text-primary);font-weight:500}.phone-size-active .size-label{color:var(--primary-blue)}.sticker-container{display:inline-flex;justify-content:center;align-items:center;width:auto;height:auto;max-width:var(--sticker-size);max-height:var(--sticker-size)}.sticker-img{display:block;max-width:100%;max-height:100%;object-fit:contain}.sticker-small{width:80px;height:80px}.sticker-medium{width:120px;height:120px}.sticker-large{width:160px;height:160px}.sticker-placeholder{padding:8px 12px;background-color:rgba(200,200,200,.3);border-radius:6px;font-size:14px;color:#666}</style></head><body><div class=\"phone-frame\"><div class=\"phone-screen\"><div id=\"delete-mode-trigger\"></div><div id=\"hidden-send-trigger\"></div><div class=\"phone-status-bar\"><div class=\"status-left\"><span id=\"current-time\">00:00</span> <i class=\"fas fa-moon moon-icon\"></i></div><div class=\"status-right\"><div class=\"signal-bars\"><i class=\"fas fa-signal\"></i></div><i class=\"fas fa-wifi wifi-icon\"></i> <i class=\"fas fa-battery-three-quarters battery-icon\"></i></div></div><div class=\"dynamic-island\"></div><div class=\"app-view app-screen active\" id=\"app-homescreen\"><div class=\"app-grid\"><div class=\"app-icon\" id=\"app-wechat\"><div class=\"icon-image icon-wechat\"><i class=\"fab fa-weixin\"></i></div><span class=\"app-name\">WeChat</span></div><div class=\"app-icon\" id=\"app-settings\"><div class=\"icon-image icon-settings\"><i class=\"fas fa-cog\"></i></div><span class=\"app-name\">设置</span></div></div></div><div id=\"wechat-view\" class=\"app-view\"><header class=\"wechat-header\"><i class=\"fas fa-chevron-left back-btn\" id=\"wechat-back-btn-dummy\"></i> <span class=\"contact-name\" id=\"contact-name-header\">Character</span> <i class=\"fas fa-ellipsis-h options-btn\" id=\"wechat-options-btn\"></i></header><main class=\"wechat-body\"></main><div class=\"wechat-input-area\"><footer class=\"wechat-footer\"><i id=\"microphone-btn\" class=\"fas fa-microphone footer-icon\"></i> <input id=\"wechat-input-field\" class=\"text-input\" placeholder=\"发送信息\" autocomplete=\"off\" autocapitalize=\"off\" spellcheck=\"false\"/> <i id=\"smile-btn\" class=\"far fa-smile footer-icon\"></i> <i id=\"plus-btn\" class=\"fas fa-plus-circle footer-icon\"></i> <button id=\"send-btn\" class=\"send-btn\"><i class=\"fas fa-paper-plane\"></i></button></footer><div id=\"panel-container\" class=\"panel-container\"><div id=\"sticker-panel\" class=\"panel-view\"><div id=\"sticker-grid\" class=\"features-grid\"></div></div><div id=\"char-sticker-panel\" class=\"panel-view\"><div id=\"char-sticker-grid\" class=\"features-grid\"></div></div><div id=\"plus-panel\" class=\"panel-view\"><div id=\"plus-grid\" class=\"features-grid\"></div></div></div></div></div><div id=\"moments-view\" class=\"app-view\"><header class=\"moments-header\"><i class=\"fas fa-chevron-left header-action\" id=\"moments-back-btn\"></i> <span class=\"title\">朋友圈</span> <i class=\"fas fa-camera header-action\" id=\"post-moment-btn\"></i></header><main class=\"moments-body\"><div class=\"moments-feed-header\"><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=\" id=\"moments-cover-photo\" class=\"moments-cover-photo\" alt=\"Cover Photo\"/><div class=\"moments-user-info\"><span class=\"moments-user-name\" id=\"moments-user-name\">User</span> <img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=\" id=\"moments-user-avatar\" class=\"moments-user-avatar\" alt=\"User Avatar\"/><div class=\"user-signature\" id=\"user-signature-display\"></div></div></div><ul class=\"moments-feed-list\" id=\"moments-feed-list\"></ul></main></div><div id=\"settings-view\" class=\"app-view\"><header class=\"settings-header\"><i class=\"fas fa-chevron-left back-btn\" id=\"settings-back-btn\"></i> <span class=\"title\">关于</span></header><main class=\"settings-body\"><div class=\"settings-card\"><p>本同层手机<span class=\"highlight\">【免费】</span>发布于discord的尾巴镇社区和旅程社区，作者：<span class=\"highlight\">暴力美学BLMX</span>，点击即可跳转到社区 <a href=\"https://discord.com/channels/1379304008157499423/1388180976873766973\" target=\"_blank\">https://discord.com/...</a>。<a href=\"https://discord.com/channels/1291925535324110879/1388182155707814009\" target=\"_blank\">https://discord.com/...</a>。</p><p>如果你是通过任何<span class=\"highlight\">付费途径</span>获取，请带着购买记录来找作者，<span class=\"highlight\">重重有赏</span>。抵制任何窃取创作者劳动成果的商业化行为，从你我做起TvT</p><p><span class=\"highlight\">禁止</span>在酒馆以外的平台使用！<span class=\"highlight\">禁止</span>未经授权的二传二改！<span class=\"highlight\">禁止</span>任何行为的倒卖和商业化行为！</p><p>后续更新内容也会发在discord的尾巴镇社区和旅程社区，有问题欢迎来提问哦！有想玩的功能、想提出的建议也可以在帖子下评论。</p></div><div class=\"settings-card\" style=\"margin-top:1rem;padding:0\"><ul style=\"list-style:none;margin:0;padding:0\"><li style=\"border-bottom:1px solid #efefef\"><a href=\"#\" id=\"change-chat-wallpaper-btn\" style=\"text-decoration:none;color:#8ba2ba;display:flex;justify-content:space-between;align-items:center;padding:1rem\"><span>更换聊天壁纸</span> <i class=\"fas fa-chevron-right\"></i></a></li><li style=\"border-bottom:1px solid #efefef\"><a href=\"#\" id=\"change-home-wallpaper-btn\" style=\"text-decoration:none;color:#8ba2ba;display:flex;justify-content:space-between;align-items:center;padding:1rem\"><span>更换主屏幕壁纸</span> <i class=\"fas fa-chevron-right\"></i></a></li><li><a href=\"#\" id=\"change-settings-wallpaper-btn\" style=\"text-decoration:none;color:#8ba2ba;display:flex;justify-content:space-between;align-items:center;padding:1rem\"><span>更换设置壁纸</span> <i class=\"fas fa-chevron-right\"></i></a></li></ul></div><div class=\"settings-card\" style=\"margin-top:1rem;padding:0\"><div style=\"padding:1rem;border-bottom:1px solid #efefef\"><h3 style=\"margin:0;font-size:1rem;color:var(--text-primary)\">主题配色</h3></div><div class=\"theme-options\" style=\"padding:1rem;display:flex;flex-wrap:wrap;gap:1rem;justify-content:space-between\"></div><div style=\"padding:1rem;border-top:1px solid #efefef\"><button id=\"custom-theme-btn\" style=\"width:100%;padding:.75rem;background:var(--primary-blue);color:#fff;border:none;border-radius:.5rem;font-weight:500;cursor:pointer\">自定义主题</button></div></div><div class=\"settings-card\" style=\"margin-top:1rem;padding:1rem\"><p style=\"font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em\">调试工具</p><ul style=\"list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.5rem\"><li><a href=\"#\" id=\"show-last-ai-response-btn\" style=\"text-decoration:none;display:block;text-align:center;background-color:#eef4fd;padding:.6rem 1rem;border-radius:.6rem;color:var(--text-primary);font-weight:500\"><span>显示AI最新原始回复</span></a></li><li><a href=\"#\" id=\"show-last-sent-prompt-btn\" style=\"text-decoration:none;display:block;text-align:center;background-color:#eef4fd;padding:.6rem 1rem;border-radius:.6rem;color:var(--text-primary);font-weight:500\"><span>显示发送给AI的提示</span></a></li></ul></div><div class=\"settings-card\" style=\"margin-top:1rem;padding:1rem\"><p style=\"font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em\">手机尺寸调整</p><div style=\"display:flex;flex-direction:column;gap:.75rem\"><div style=\"display:flex;justify-content:space-between;align-items:center;gap:.5rem\"><button id=\"phone-size-default\" class=\"phone-size-btn phone-size-active\"><span class=\"size-icon\" style=\"height:24px\"></span> <span class=\"size-label\">默认尺寸</span></button> <button id=\"phone-size-medium\" class=\"phone-size-btn\"><span class=\"size-icon\" style=\"height:20px\"></span> <span class=\"size-label\">中等尺寸</span></button> <button id=\"phone-size-small\" class=\"phone-size-btn\"><span class=\"size-icon\" style=\"height:16px\"></span> <span class=\"size-label\">小尺寸</span></button></div><div style=\"font-size:.8em;color:var(--text-secondary);text-align:center\">选择适合您屏幕的手机尺寸</div></div></div><div class=\"settings-card\" style=\"margin-top:1rem;padding:1rem\"><p style=\"font-weight:500;margin:0 0 .75rem .25rem;color:var(--text-primary);font-size:.9em\">表情包大小设置</p><div style=\"display:flex;flex-direction:column;gap:.75rem\"><div style=\"display:flex;flex-direction:column;gap:.5rem\"><div style=\"display:flex;justify-content:space-between;align-items:center\"><span style=\"font-size:.9em;color:var(--text-secondary)\">小</span> <input type=\"range\" id=\"sticker-size-slider\" min=\"40\" max=\"200\" value=\"120\" style=\"flex-grow:1;margin:0 10px;accent-color:var(--primary-blue)\"/> <span style=\"font-size:.9em;color:var(--text-secondary)\">大</span></div><div style=\"display:flex;justify-content:center;align-items:center;gap:.5rem\"><input type=\"number\" id=\"sticker-size-input\" value=\"120\" min=\"40\" max=\"200\" style=\"width:70px;padding:8px;border:1px solid var(--border-color);border-radius:5px;text-align:center\"/> <span style=\"font-size:.9em;color:var(--text-secondary)\">像素</span></div></div><div style=\"display:flex;justify-content:space-between;gap:.5rem;margin-top:.5rem\"><button id=\"sticker-size-small\" class=\"phone-size-btn\"><span class=\"size-icon\" style=\"height:16px\"></span> <span class=\"size-label\">小 (80px)</span></button> <button id=\"sticker-size-medium\" class=\"phone-size-btn phone-size-active\"><span class=\"size-icon\" style=\"height:20px\"></span> <span class=\"size-label\">中 (120px)</span></button></div><div style=\"font-size:.8em;color:var(--text-secondary);text-align:center\">调整聊天中表情包的显示大小</div></div></div></main></div></div></div><input type=\"file\" id=\"image-upload-input\" accept=\"image/*\" style=\"display:none\"/><div id=\"theme-editor-modal\" class=\"modal\" style=\"display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;overflow-y:auto\"><div class=\"modal-content\" style=\"background-color:#fff;margin:10% auto;padding:20px;width:80%;max-width:500px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.2)\"><div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:15px\"><h2 style=\"margin:0;color:var(--text-primary);font-size:1.2rem\">自定义主题</h2><button id=\"close-theme-editor\" style=\"background:0 0;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-secondary)\">&times;</button></div><div style=\"margin-bottom:15px\"><label style=\"display:block;margin-bottom:5px;color:var(--text-primary);font-weight:500\">主题名称</label> <input id=\"theme-name-input\" style=\"width:100%;padding:8px;border:1px solid var(--border-color);border-radius:5px;box-sizing:border-box\" placeholder=\"我的自定义主题\"/></div><div style=\"max-height:400px;overflow-y:auto;padding-right:10px\"><div style=\"margin-bottom:20px\"><h3 style=\"margin:0 0 10px 0;color:var(--text-primary);font-size:1rem\">手机边框</h3><div style=\"display:flex;gap:10px;margin-bottom:10px\"><div style=\"flex:1\"><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">边框颜色</label> <input type=\"color\" id=\"phone-frame-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div></div></div><div style=\"margin-bottom:20px\"><h3 style=\"margin:0 0 10px 0;color:var(--text-primary);font-size:1rem\">主要颜色</h3><div style=\"display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px\"><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">主色调</label> <input type=\"color\" id=\"primary-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">浅色调</label> <input type=\"color\" id=\"light-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">极浅色调</label> <input type=\"color\" id=\"ultra-light-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">深色调</label> <input type=\"color\" id=\"deep-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div></div></div><div style=\"margin-bottom:20px\"><h3 style=\"margin:0 0 10px 0;color:var(--text-primary);font-size:1rem\">文字颜色</h3><div style=\"display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px\"><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">主要文字</label> <input type=\"color\" id=\"text-primary-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">次要文字</label> <input type=\"color\" id=\"text-secondary-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div></div></div><div style=\"margin-bottom:20px\"><h3 style=\"margin:0 0 10px 0;color:var(--text-primary);font-size:1rem\">气泡颜色</h3><div style=\"display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px\"><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">我的气泡</label> <input type=\"color\" id=\"bubble-me-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div><div><label style=\"display:block;margin-bottom:5px;font-size:.9rem;color:var(--text-secondary)\">对方气泡</label> <input type=\"color\" id=\"bubble-them-color\" style=\"width:100%;height:40px;border:none;border-radius:5px;cursor:pointer\"/></div></div></div><div style=\"margin-bottom:20px\"><h3 style=\"margin:0 0 10px 0;color:var(--text-primary);font-size:1rem\">主题模式</h3><div style=\"display:flex;align-items:center\"><input type=\"checkbox\" id=\"dark-mode-toggle\" style=\"margin-right:10px;width:18px;height:18px\"/> <label for=\"dark-mode-toggle\" style=\"color:var(--text-primary);font-size:.9rem\">启用夜间模式</label></div><div style=\"font-size:.8rem;color:var(--text-secondary);margin-top:5px\">夜间模式会将应用背景、设置页面和卡片等元素变为深色</div></div></div><div style=\"display:flex;justify-content:space-between;margin-top:20px\"><button id=\"reset-theme-btn\" style=\"padding:10px 15px;background:#f1f5f9;color:var(--text-primary);border:none;border-radius:5px;cursor:pointer;font-weight:500\">重置</button> <button id=\"save-theme-btn\" style=\"padding:10px 20px;background:var(--primary-blue);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:500\">保存主题</button></div></div></div><script>class e{get hasNotifications(){return this.hasPendingNotifications}constructor(e,t,n,a,s,o,r){if(this.userMessageQueue=[],this.hasPendingNotifications=!1,this.wechatInput=document.querySelector(e),this.sendBtn=document.querySelector(t),this.plusBtn=document.querySelector(n),!this.wechatInput||!this.sendBtn||!this.plusBtn)throw new Error(\"One or more required elements not found\");this.blmxManager=a,this.options=r,this.appController=s,this.uiRenderer=o,this.setupEventListeners()}getUserMessageQueue(){return this.userMessageQueue}clearUserMessageQueue(){this.userMessageQueue=[],this.options.updateFooterButtonsState()}setHasPendingNotifications(e){this.hasPendingNotifications=e,this.options.updateFooterButtonsState()}addToUserMessageQueue(e){this.userMessageQueue.push(e),this.options.updateFooterButtonsState()}addLongPressListener(e,t,n={duration:600,preventDefault:!0}){let a,s,o;const r=()=>clearTimeout(a);e.addEventListener(\"pointerdown\",(e=>{\"mousedown\"===e.type&&0!==e.button||(s=e.clientX,o=e.clientY,n.preventDefault&&e.preventDefault(),clearTimeout(a),a=window.setTimeout((()=>{a=0,t()}),n.duration))})),e.addEventListener(\"pointermove\",(e=>{if(!a)return;const t=e.clientX,n=e.clientY;(Math.abs(t-s)>10||Math.abs(n-o)>10)&&clearTimeout(a)})),e.addEventListener(\"pointerup\",r),e.addEventListener(\"pointerleave\",r),n.preventDefault&&e.addEventListener(\"contextmenu\",(e=>e.preventDefault()))}promptForDateTime(e){const t=prompt(\"请输入日期和时间 (格式YYYY-MM-DD HH:mm)\",e);if(!t||!/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}$/.test(t))return t&&alert(\"格式错误，请输入YYYY-MM-DD HH:mm 格式。\"),null;const[n,a]=t.split(\" \"),s=new Date(t.replace(\" \",\"T\"));if(isNaN(s.getTime()))return alert(\"无效的日期时间格式。\"),null;window.currentGameDate=s;const o=document.getElementById(\"current-time\");if(o){const e=`${window.currentGameDate.getHours().toString().padStart(2,\"0\")}:${window.currentGameDate.getMinutes().toString().padStart(2,\"0\")}`;o.textContent=e}return this.uiRenderer.refreshAllTimestamps(),[n,a]}handleMessageRecall(e){const t=this.userMessageQueue.find((t=>t.id===e));if(t){const e=window.currentGameDate||new Date,n=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,\"0\")}-${e.getDate().toString().padStart(2,\"0\")} ${e.getHours().toString().padStart(2,\"0\")}:${e.getMinutes().toString().padStart(2,\"0\")}`,a=this.promptForDateTime(n);if(a&&confirm(\"是否要撤回这条消息？\")){const[e,n]=a;t.recalled=!0,t.recalled_timestamp=`${e} ${n}`,t.recalled_content=t.content,this.blmxManager.logEntries.push(...this.userMessageQueue),this.userMessageQueue=[],this.blmxManager.persistLogToStorage().then((()=>{this.options.renderChatHistory()})),this.options.updateFooterButtonsState()}}else alert(\"消息已合并发送，无法撤回。\")}setupEventListeners(){this.sendBtn.addEventListener(\"click\",(()=>{const e=this.wechatInput.value.trim();e?(this.options.stageAndDisplayEntry({id:`msg-${Date.now()}${Math.random()}`,type:\"message\",sender:\"me\",content:e}),this.wechatInput.value=\"\",this.options.updateFooterButtonsState()):(this.userMessageQueue.length>0||this.hasPendingNotifications)&&(this.hasPendingNotifications=!1,this.options.triggerAiResponse(!0))})),document.getElementById(\"smile-btn\")?.addEventListener(\"click\",(()=>this.options.togglePanel(\"sticker\"))),this.plusBtn.addEventListener(\"click\",(()=>this.options.togglePanel(\"plus\"))),document.getElementById(\"microphone-btn\")?.addEventListener(\"click\",(()=>{const e=prompt(\"请输入语音内容:\");if(e){const t=prompt(\"请输入语音秒数 (只输入数字):\");if(t){const n=parseInt(t,10);!isNaN(n)&&n>0?this.options.stageAndDisplayEntry({id:`msg-${Date.now()}${Math.random()}`,type:\"voice\",sender:\"me\",content:{text:e,duration:n}}):alert(\"请输入有效的秒数。\")}}})),this.wechatInput.addEventListener(\"keydown\",(e=>{\"Enter\"!==e.key||e.shiftKey||(e.preventDefault(),this.sendBtn.click())})),this.wechatInput.addEventListener(\"input\",(()=>{this.options.updateFooterButtonsState()})),this.wechatInput.addEventListener(\"focus\",(()=>{this.options.togglePanel(null)})),document.getElementById(\"app-wechat\")?.addEventListener(\"click\",(()=>this.appController.navigateTo(\"wechat\"))),document.getElementById(\"app-settings\")?.addEventListener(\"click\",(()=>this.appController.navigateTo(\"settings\"))),document.getElementById(\"wechat-back-btn-dummy\")?.addEventListener(\"click\",(()=>this.appController.navigateTo(\"home\"))),document.getElementById(\"settings-back-btn\")?.addEventListener(\"click\",(()=>this.appController.navigateTo(\"home\"))),document.getElementById(\"wechat-options-btn\")?.addEventListener(\"click\",(()=>this.appController.navigateTo(\"moments\"))),document.getElementById(\"moments-back-btn\")?.addEventListener(\"click\",(()=>this.appController.navigateTo(\"wechat\"))),this.renderPlusFeatures(),this.renderStickerFeatures(),this.setupClickListeners(),this.addLongPressListener(this.wechatInput,(()=>{const e=this.blmxManager.getCharId(),t=localStorage.getItem(`blmx_input_placeholder_${e}`)||`与 ${this.options.getDisplayName(\"char\")} 对话...`,n=prompt(\"请输入新的输入框提示文字:\",t);null!==n&&(localStorage.setItem(`blmx_input_placeholder_${e}`,n),this.wechatInput.placeholder=n,alert(\"提示文字已更新！\"))}),{duration:5e3,preventDefault:!1})}setupClickListeners(){document.getElementById(\"hidden-send-trigger\")?.addEventListener(\"click\",(()=>{confirm(\"是否要立即触发AI响应（即使没有新消息）？\")&&this.options.triggerAiResponse(!0)})),document.getElementById(\"delete-mode-trigger\")?.addEventListener(\"click\",(()=>{const e=document.getElementById(\"wechat-view\");e?.classList.toggle(\"delete-mode\"),e?.classList.contains(\"delete-mode\")?alert(\"已进入删除模式。点击任意消息或时间戳可将其删除。再次点击左上角可退出。\"):alert(\"已退出删除模式。\")})),document.getElementById(\"post-moment-btn\")?.addEventListener(\"click\",(()=>{const e=prompt(\"这一刻的想法...\");if(null===e)return;let t=\"\",n=\"none\",a=\"\";if(confirm(\"是否要附带图片？\")){const e=confirm(\"图片是链接吗？(点击“确定”输入链接，点击“取消”输入描述)\");if(n=e?\"url\":\"desc\",t=prompt(e?\"请输入图片链接:\":\"请输入图片描述:\")||\"\",\"\"===t.trim())n=\"none\";else if(\"url\"===n){const e=prompt(\"请输入图片的文本描述（仅供AI识别，不会显示在朋友圈）:\");e&&(a=e)}}if(!(e&&\"\"!==e.trim()||t&&\"\"!==t.trim()))return void alert(\"不能发布空的朋友圈内容。\");const s=window.currentGameDate||new Date,o=`${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,\"0\")}-${s.getDate().toString().padStart(2,\"0\")} ${s.getHours().toString().padStart(2,\"0\")}:${s.getMinutes().toString().padStart(2,\"0\")}`,r=this.promptForDateTime(o);if(!r)return;const[i,l]=r;this.blmxManager.addEntry({key:\"USER_MOMENT\",data:{text:e,image:t,image_type:n,image_desc:a,date:i,time:l}}),this.options.renderMomentsFeed(),this.setHasPendingNotifications(!0)}));const e=document.getElementById(\"moments-feed-list\");e?.addEventListener(\"click\",(e=>{const t=e.target,n=t.closest(\".moment-post\");if(!n)return;parseInt(n.dataset.postId,10);const a=parseInt(n.dataset.momentSequenceId,10);if(t.closest(\".delete-moment-btn\"));else if(t.closest(\".comment-button\")){const e=prompt(\"输入 '赞' 来点赞，或者直接输入评论内容:\");e&&(\"赞\"===e.trim().toLowerCase()||\"like\"===e.trim().toLowerCase()?this.blmxManager.addEntry({key:\"USER_LIKE\",data:{target_post_id:a}}):this.blmxManager.addEntry({key:\"USER_COMMENT\",data:{text:e,target_post_id:a}}),this.options.renderMomentsFeed(),this.setHasPendingNotifications(!0))}})),document.body.addEventListener(\"click\",(e=>{const t=e.target;if(t.matches(\".message-avatar\")){const e=t.closest(\".message-row\");if(e){const t=e.classList.contains(\"me\")?\"user\":\"char\";this.appController.updateAvatar(t)}}})),document.getElementById(\"contact-name-header\")?.addEventListener(\"click\",(()=>{this.appController.updateCharRemark()})),document.getElementById(\"moments-user-name\")?.addEventListener(\"click\",(()=>{this.appController.updateUserName()})),document.getElementById(\"moments-user-avatar\")?.addEventListener(\"click\",(()=>{this.appController.updateSignature()})),document.getElementById(\"moments-cover-photo\")?.addEventListener(\"click\",(()=>{this.appController.updateCoverPhoto()}));const t=document.querySelector(\".wechat-body\");t?.addEventListener(\"click\",(e=>{const t=document.getElementById(\"wechat-view\");if(!t?.classList.contains(\"delete-mode\"))return;const n=e.target.closest(\"[data-log-index]\");if(n){e.preventDefault(),e.stopPropagation();const t=parseInt(n.dataset.logIndex,10),a=n.textContent?.trim().replace(/\\s+/g,\" \").substring(0,50);confirm(`确定要删除这条记录吗？\\n\\n预览: \"${a}...\"`)&&(this.blmxManager.logEntries.splice(t,1),this.blmxManager.persistLogToStorage(),this.options.renderChatHistory(),this.options.renderMomentsFeed())}}),!0),document.getElementById(\"change-chat-wallpaper-btn\")?.addEventListener(\"click\",(e=>{e.preventDefault(),this.appController.changeWallpaper(\"chat\")})),document.getElementById(\"change-home-wallpaper-btn\")?.addEventListener(\"click\",(e=>{e.preventDefault(),this.appController.changeWallpaper(\"home\")})),document.getElementById(\"change-settings-wallpaper-btn\")?.addEventListener(\"click\",(e=>{e.preventDefault(),this.appController.changeWallpaper(\"settings\")})),document.getElementById(\"show-last-ai-response-btn\")?.addEventListener(\"click\",(e=>{e.preventDefault(),alert(`AI 最新原始回复:\\n\\n${this.appController.getLatestAiRawResponse()}`)})),document.getElementById(\"show-last-sent-prompt-btn\")?.addEventListener(\"click\",(e=>{e.preventDefault(),alert(`发送给 AI 的提示:\\n\\n${this.appController.getLatestSentPrompt()}`)}))}renderPlusFeatures(){const e=document.getElementById(\"plus-grid\");if(!e)return;const t=[{label:\"相册\",icon:\"fas fa-images\",action:()=>{const e=prompt(\"请输入图片描述:\");e&&(this.options.stageAndDisplayEntry({type:\"image\",sender:\"me\",content:{type:\"desc\",value:e},id:`msg-${Date.now()}`}),this.options.togglePanel(null))}},{label:\"拍摄\",icon:\"fas fa-camera\",action:()=>{const e=window.currentGameDate||new Date,t=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,\"0\")}-${e.getDate().toString().padStart(2,\"0\")}`,n=`${e.getHours().toString().padStart(2,\"0\")}:${e.getMinutes().toString().padStart(2,\"0\")}`,a=prompt(\"请输入剧情日期和时间 (格式YYYY-MM-DD HH:mm)\",`${t} ${n}`);if(!a||!/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}$/.test(a))return void(a&&alert(\"格式错误，请输入YYYY-MM-DD HH:mm 格式。\"));const s=confirm(\"是否要记录这段时间发生了什么？\")?prompt(\"请输入事件描述：\"):\"\",[o,r]=a.split(\" \"),i=new Date(a.replace(\" \",\"T\"));if(isNaN(i.getTime()))return void alert(\"无效的日期时间格式。\");window.currentGameDate=i;const l=document.getElementById(\"current-time\");if(l){const e=`${window.currentGameDate.getHours().toString().padStart(2,\"0\")}:${window.currentGameDate.getMinutes().toString().padStart(2,\"0\")}`;l.textContent=e}this.uiRenderer.refreshAllTimestamps();const c={date:o,time:r,description:s||\"\"};this.options.stageAndDisplayEntry({type:\"event\",sender:\"me\",content:c,id:`event-${Date.now()}`}),this.options.togglePanel(null)}},{label:\"视频通话\",icon:\"fas fa-video\",action:()=>alert(\"本同层手机只【免费发布于discord的尾巴镇社区和旅程社区，作者暴力美学，点击链接即可免费获取https://discord.com/channels/1379304008157499423/1388180976873766973。https://discord.com/channels/1291925535324110879/1388182155707814009\")},{label:\"位置\",icon:\"fas fa-map-marker-alt\",action:()=>{const e=prompt(\"请输入位置:\");e&&this.options.stageAndDisplayEntry({type:\"location\",sender:\"me\",content:e,id:`msg-${Date.now()}`}),this.options.togglePanel(null)}},{label:\"红包\",icon:\"fas fa-envelope\",action:()=>{const e=prompt(\"请输入红包金额:\"),t=parseFloat(e);if(!isNaN(t)&&t>0){const e=prompt(\"请输入红包祝福语(可选):\"),n={name:\"红包\",price:t.toFixed(2),note:e||\"恭喜发财，大吉大利！\",status:\"sent\"};this.options.stageAndDisplayEntry({type:\"gift\",sender:\"me\",content:JSON.stringify(n),data:n,id:`msg-${Date.now()}`}),this.options.togglePanel(null)}else e&&alert(\"请输入有效金额\")}},{label:\"转账\",icon:\"fas fa-money-bill-wave\",action:()=>{const e=prompt(\"请输入转账金额:\"),t=parseFloat(e);if(!isNaN(t)&&t>0){const e=prompt(\"请输入转账备注(可选):\"),n={amount:t.toFixed(2),note:e||\" \",status:\"sent\"};this.options.stageAndDisplayEntry({type:\"transfer\",sender:\"me\",content:JSON.stringify(n),data:n,id:`msg-${Date.now()}`}),this.options.togglePanel(null)}else e&&alert(\"请输入有效金额\")}},{label:\"文件\",icon:\"fas fa-file-alt\",action:()=>{const e=prompt(\"请输入文件名:\");e&&this.options.stageAndDisplayEntry({type:\"file\",sender:\"me\",content:e,id:`msg-${Date.now()}`}),this.options.togglePanel(null)}},{label:\"礼物\",icon:\"fas fa-gift\",action:()=>{const e=prompt(\"请输入礼物名称:\");if(!e)return;const t={name:e,price:(confirm(\"是否输入价格？\")?prompt(\"请输入价格:\"):\"\")||void 0,status:\"sent\"};this.options.stageAndDisplayEntry({type:\"gift\",sender:\"me\",content:JSON.stringify(t),data:t,id:`msg-${Date.now()}`}),this.options.togglePanel(null)}}];this.uiRenderer.renderFeatureGrid(e,t,{onToggleDeleteMode:()=>{},onAddStickers:()=>{}})}renderStickerFeatures(){const e=document.getElementById(\"sticker-grid\");if(!e)return;const t=[{label:\"好的\",url:\"https://files.catbox.moe/3j0tpc.jpeg\"}],n=JSON.parse(localStorage.getItem(\"blmx_wechat_stickers_global\")||\"[]\"),a=[...t,...n].map((e=>({label:e.label,icon:e.url,isDefault:t.some((t=>t.label===e.label)),action:()=>{this.options.stageAndDisplayEntry({type:\"sticker\",sender:\"me\",content:e.label,id:`msg-${Date.now()}`}),this.options.togglePanel(null)}})));a.unshift({label:\"表情管理\",icon:\"fas fa-cog\",isAddBtn:!0,action:()=>{this.showStickerManager()}}),this.uiRenderer.renderFeatureGrid(e,a,{onToggleDeleteMode:()=>this.showStickerManager(),onAddStickers:()=>this.showStickerManager()})}parseAndAddStickers(e,t){if(!e)return;const n=e.split(\",\"),a=[];for(const e of n){const t=e.indexOf(\"http\");if(t>0){const n=e.substring(0,t).trim(),s=e.substring(t).trim();n&&s&&a.push({label:n,url:s})}else if(e.includes(\"=\")){const[t,n]=e.split(\"=\").map((e=>e.trim()));t&&n&&a.push({label:t,url:n})}}if(a.length>0){const e=[...JSON.parse(localStorage.getItem(t)||\"[]\"),...a];localStorage.setItem(t,JSON.stringify(e)),alert(`${a.length} 个表情包已添加！`)}else alert(\"未找到有效的表情包格式。请使用 '描述http://url' 格式，多个表情包请用英文逗号分隔。\")}toggleStickerDeleteMode(e,t){this.showStickerManager()}showStickerManager(){const e=document.createElement(\"div\");e.className=\"sticker-manager-modal\",e.style.cssText=\"\\n      position: fixed;\\n      top: 0;\\n      left: 0;\\n      right: 0;\\n      bottom: 0;\\n      background-color: rgba(0, 0, 0, 0.7);\\n      display: flex;\\n      justify-content: center;\\n      align-items: center;\\n      z-index: 1000;\\n    \";const t=document.createElement(\"div\");t.className=\"sticker-manager-container\",t.style.cssText=\"\\n      background-color: white;\\n      border-radius: 12px;\\n      width: 90%;\\n      max-width: 500px;\\n      max-height: 80vh;\\n      overflow-y: auto;\\n      padding: 20px;\\n      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);\\n    \";const n=document.createElement(\"h2\");n.textContent=\"表情包管理\",n.style.cssText=\"\\n      margin-top: 0;\\n      color: var(--text-primary);\\n      font-size: 1.2rem;\\n      text-align: center;\\n      margin-bottom: 20px;\\n    \",t.appendChild(n);const a=document.createElement(\"div\");a.style.cssText=`\\n      display: flex;\\n      border-bottom: 1px solid ${document.body.classList.contains(\"dark-mode\")?\"#3c3c3c\":\"#eee\"};\\n      margin-bottom: 15px;\\n    `;const s=(e,n,s=!1)=>{const o=document.createElement(\"div\");return o.textContent=e,o.dataset.tabId=n,o.style.cssText=`\\n        padding: 10px 15px;\\n        cursor: pointer;\\n        font-weight: ${s?\"bold\":\"normal\"};\\n        color: ${s?\"var(--primary-blue)\":\"var(--text-secondary)\"};\\n        border-bottom: ${s?\"2px solid var(--primary-blue)\":\"none\"};\\n        margin-bottom: -1px;\\n      `,o.addEventListener(\"click\",(()=>{a.querySelectorAll(\"div\").forEach((e=>{e.style.fontWeight=\"normal\",e.style.color=\"var(--text-secondary)\",e.style.borderBottom=\"none\"})),o.style.fontWeight=\"bold\",o.style.color=\"var(--primary-blue)\",o.style.borderBottom=\"2px solid var(--primary-blue)\",t.querySelectorAll(\".tab-content\").forEach((e=>{e.style.display=\"none\"}));const e=t.querySelector(`.tab-content[data-tab-id=\"${n}\"]`);e&&(e.style.display=\"block\")})),o};a.appendChild(s(\"添加表情\",\"add-sticker\",!0)),a.appendChild(s(\"批量添加\",\"batch-add\")),a.appendChild(s(\"删除管理\",\"delete-manage\")),t.appendChild(a);const o=document.createElement(\"div\");o.className=\"tab-content\",o.dataset.tabId=\"add-sticker\",o.style.cssText=\"\\n      display: block;\\n      padding: 15px 0;\\n    \";const r=document.createElement(\"div\");r.style.cssText=\"\\n      display: flex;\\n      flex-direction: column;\\n      gap: 15px;\\n    \";const i=document.createElement(\"input\");i.type=\"text\",i.placeholder=\"表情描述/名称\",i.style.cssText=\"\\n      padding: 10px;\\n      border: 1px solid #ddd;\\n      border-radius: 8px;\\n    \";const l=document.createElement(\"input\");l.type=\"text\",l.placeholder=\"表情图片URL链接\",l.style.cssText=\"\\n      padding: 10px;\\n      border: 1px solid #ddd;\\n      border-radius: 8px;\\n    \";const c=document.createElement(\"div\");c.style.cssText=\"\\n      display: flex;\\n      flex-direction: column;\\n      align-items: center;\\n      margin-top: 10px;\\n      gap: 10px;\\n    \";const d=document.createElement(\"div\");d.textContent=\"预览\",d.style.cssText=\"\\n      font-size: 0.9rem;\\n      color: var(--text-secondary);\\n    \";const p=document.createElement(\"img\");p.style.cssText=\"\\n      max-width: 150px;\\n      max-height: 150px;\\n      border: 1px dashed #ccc;\\n      padding: 10px;\\n      border-radius: 8px;\\n      display: none;\\n    \",l.addEventListener(\"input\",(()=>{l.value.trim()?(p.src=l.value.trim(),p.style.display=\"block\"):p.style.display=\"none\"})),c.appendChild(d),c.appendChild(p);const m=document.createElement(\"button\");m.textContent=\"添加表情包\",m.style.cssText=\"\\n      padding: 12px;\\n      background-color: var(--primary-blue);\\n      color: white;\\n      border: none;\\n      border-radius: 8px;\\n      cursor: pointer;\\n      margin-top: 15px;\\n    \",m.addEventListener(\"click\",(()=>{const e=i.value.trim(),t=l.value.trim();if(!e||!t)return void alert(\"请输入表情名称和URL\");const n=\"blmx_wechat_stickers_global\",a=JSON.parse(localStorage.getItem(n)||\"[]\"),s={label:e,url:t};a.push(s),localStorage.setItem(n,JSON.stringify(a)),alert(\"表情包添加成功！\"),i.value=\"\",l.value=\"\",p.style.display=\"none\"})),r.appendChild(i),r.appendChild(l),r.appendChild(c),r.appendChild(m),o.appendChild(r),t.appendChild(o);const g=document.createElement(\"div\");g.className=\"tab-content\",g.dataset.tabId=\"batch-add\",g.style.cssText=\"\\n      display: none;\\n      padding: 15px 0;\\n    \";const h=document.createElement(\"div\");h.style.cssText=\"\\n      margin-bottom: 15px;\\n      padding: 10px;\\n      background-color: #f8f9fa;\\n      border-radius: 8px;\\n      border-left: 4px solid var(--primary-blue);\\n    \";const u=document.createElement(\"p\");u.innerHTML=\"\\n      批量添加格式说明：<br>\\n      - 每个表情包格式：<strong>表情名称http://图片链接</strong><br>\\n      - 多个表情包用<strong>英文逗号</strong>分隔<br>\\n      - 也支持 <strong>表情名称=http://图片链接</strong> 格式<br>\\n      - 示例：<code>笑脸https://example.com/smile.jpg,哭脸https://example.com/cry.jpg</code>\\n    \",u.style.cssText=\"\\n      font-size: 0.9rem;\\n      color: var(--text-primary);\\n      margin: 0;\\n      line-height: 1.5;\\n    \",h.appendChild(u);const y=document.createElement(\"textarea\");y.placeholder=\"请按照上述格式输入多个表情包...\",y.style.cssText=\"\\n      width: 100%;\\n      min-height: 120px;\\n      padding: 10px;\\n      border: 1px solid #ddd;\\n      border-radius: 8px;\\n      margin-bottom: 15px;\\n      resize: vertical;\\n    \";const f=document.createElement(\"button\");f.textContent=\"批量添加表情包\",f.style.cssText=\"\\n      padding: 12px;\\n      background-color: var(--primary-blue);\\n      color: white;\\n      border: none;\\n      border-radius: 8px;\\n      cursor: pointer;\\n      width: 100%;\\n    \",f.addEventListener(\"click\",(()=>{const e=y.value.trim();if(!e)return void alert(\"请输入表情包数据\");const t=\"blmx_wechat_stickers_global\",n=e.split(\",\"),a=[];for(const e of n){const t=e.indexOf(\"http\");if(t>0){const n=e.substring(0,t).trim(),s=e.substring(t).trim();n&&s&&a.push({label:n,url:s})}else if(e.includes(\"=\")){const[t,n]=e.split(\"=\").map((e=>e.trim()));t&&n&&a.push({label:t,url:n})}}if(a.length>0){const e=[...JSON.parse(localStorage.getItem(t)||\"[]\"),...a];localStorage.setItem(t,JSON.stringify(e)),alert(`${a.length} 个表情包已添加！`),y.value=\"\"}else alert(\"未找到有效的表情包格式。请按照上方的格式说明输入。\")})),g.appendChild(h),g.appendChild(y),g.appendChild(f),t.appendChild(g);const b=document.createElement(\"div\");b.className=\"tab-content\",b.dataset.tabId=\"delete-manage\",b.style.cssText=\"\\n      display: none;\\n      padding: 15px 0;\\n    \";const v=document.createElement(\"div\");v.style.cssText=\"\\n      display: flex;\\n      justify-content: space-between;\\n      align-items: center;\\n      margin-bottom: 15px;\\n    \";const x=document.createElement(\"div\");x.style.cssText=\"\\n      display: flex;\\n      gap: 10px;\\n    \";const E=document.createElement(\"button\");E.textContent=\"全选\",E.style.cssText=\"\\n      padding: 8px 12px;\\n      background-color: #f1f5f9;\\n      border: none;\\n      border-radius: 4px;\\n      cursor: pointer;\\n      font-size: 0.9rem;\\n    \";const w=document.createElement(\"button\");w.textContent=\"取消选择\",w.style.cssText=\"\\n      padding: 8px 12px;\\n      background-color: #f1f5f9;\\n      border: none;\\n      border-radius: 4px;\\n      cursor: pointer;\\n      font-size: 0.9rem;\\n    \";const C=document.createElement(\"button\");C.textContent=\"删除选中\",C.style.cssText=\"\\n      padding: 8px 12px;\\n      background-color: #ef4444;\\n      color: white;\\n      border: none;\\n      border-radius: 4px;\\n      cursor: pointer;\\n      font-size: 0.9rem;\\n    \",x.appendChild(E),x.appendChild(w),v.appendChild(x),v.appendChild(C);const S=document.createElement(\"div\");S.style.cssText=\"\\n      max-height: 400px;\\n      overflow-y: auto;\\n      border: 1px solid #eee;\\n      border-radius: 8px;\\n      padding: 10px;\\n    \";const k=document.createElement(\"div\");k.style.cssText=\"\\n      display: grid;\\n      grid-template-columns: repeat(3, 1fr);\\n      gap: 10px;\\n    \";const T=()=>{const e=JSON.parse(localStorage.getItem(\"blmx_wechat_stickers_global\")||\"[]\");k.innerHTML=\"\";const t=[...e];if(0===t.length){const e=document.createElement(\"div\");e.textContent=\"没有可删除的表情包\",e.style.cssText=\"\\n          grid-column: 1 / -1;\\n          text-align: center;\\n          padding: 20px;\\n          color: var(--text-secondary);\\n        \",k.appendChild(e)}else t.forEach(((e,t)=>{const n=document.createElement(\"div\");n.className=\"sticker-item\",n.style.cssText=\"\\n            border: 1px solid #eee;\\n            border-radius: 8px;\\n            padding: 10px;\\n            display: flex;\\n            flex-direction: column;\\n            align-items: center;\\n            position: relative;\\n          \";const a=document.createElement(\"input\");a.type=\"checkbox\",a.dataset.index=t.toString(),a.style.cssText=\"\\n            position: absolute;\\n            top: 5px;\\n            right: 5px;\\n            width: 18px;\\n            height: 18px;\\n            cursor: pointer;\\n          \";const s=document.createElement(\"img\");s.src=e.url,s.alt=e.label,s.style.cssText=\"\\n            width: 60px;\\n            height: 60px;\\n            object-fit: contain;\\n            margin-bottom: 8px;\\n          \";const o=document.createElement(\"div\");o.textContent=e.label,o.style.cssText=\"\\n            font-size: 0.8rem;\\n            text-align: center;\\n            color: var(--text-primary);\\n            word-break: break-word;\\n          \",s.onerror=()=>{s.src='data:image/svg+xml;charset=UTF-8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"%23ccc\" d=\"M21.9 21.9l-20.8-20.8M2.1 21.9l20.8-20.8M21 12c0 5-4 9-9 9s-9-4-9-9 4-9 9-9 9 4 9 9z\"/></svg>',s.style.padding=\"10px\"},n.appendChild(a),n.appendChild(s),n.appendChild(o),k.appendChild(n)}))};E.addEventListener(\"click\",(()=>{k.querySelectorAll('input[type=\"checkbox\"]').forEach((e=>{e.checked=!0}))})),w.addEventListener(\"click\",(()=>{k.querySelectorAll('input[type=\"checkbox\"]').forEach((e=>{e.checked=!1}))})),C.addEventListener(\"click\",(()=>{const e=Array.from(k.querySelectorAll('input[type=\"checkbox\"]:checked'));if(0!==e.length){if(confirm(`确定要删除选中的 ${e.length} 个表情包吗？`)){const t=\"blmx_wechat_stickers_global\",n=JSON.parse(localStorage.getItem(t)||\"[]\");e.map((e=>parseInt(e.dataset.index||\"-1\",10))).filter((e=>e>=0)).sort(((e,t)=>t-e)).forEach((e=>{e>=0&&e<n.length&&n.splice(e,1)})),localStorage.setItem(t,JSON.stringify(n)),alert(\"选中的表情包已删除\"),T()}}else alert(\"请至少选择一个表情包\")})),S.appendChild(k),b.appendChild(v),b.appendChild(S),t.appendChild(b),T();const I=document.createElement(\"div\");I.style.cssText=`\\n      display: flex;\\n      justify-content: flex-end;\\n      margin-top: 20px;\\n      padding-top: 15px;\\n      border-top: 1px solid ${document.body.classList.contains(\"dark-mode\")?\"#3c3c3c\":\"#eee\"};\\n    `;const _=document.createElement(\"button\");_.textContent=\"关闭\",_.style.cssText=\"\\n      padding: 10px 20px;\\n      background: var(--primary-blue);\\n      color: white;\\n      border: none;\\n      border-radius: 5px;\\n      cursor: pointer;\\n      font-weight: 500;\\n    \",_.addEventListener(\"click\",(()=>{document.body.removeChild(e),this.renderStickerFeatures()})),I.appendChild(_),t.appendChild(I),e.appendChild(t),document.body.appendChild(e)}}function t(){return window.parent.TavernHelper}class n{constructor(e){this.logEntries=[],this.messageId=null,this.LOG_START_TAG=\"===BLMX_LOG_BEGIN===\",this.LOG_END_TAG=\"===BLMX_LOG_END===\",this.charId=e}getCharId(){return this.charId}async initialize(){console.log(\"[BLMX] Initializing and scanning for chat history...\");const e=await t().getLastMessageId();if(null===e)return console.warn(\"[BLMX] No messages found. Starting fresh at message ID 0.\"),this.messageId=0,this.logEntries=[],await this.persistLogToStorage(),!0;let n=null;const a=[];for(let s=e;s>=0;s--)try{const e=(await t().getChatMessages(s))[0];e&&e.message&&e.message.includes(this.LOG_START_TAG)&&(n?a.push({id:s,content:e.message}):n={id:s,content:e.message})}catch(e){}if(!n)return console.log(\"[BLMX] No UI log found. Creating a new one in the latest message.\"),this.messageId=e,this.logEntries=[],await this.persistLogToStorage(),!0;console.log(`[BLMX] Found latest UI log in message ${n.id}. Consolidating...`),this.messageId=n.id;let s=[];const o=n.content.indexOf(this.LOG_START_TAG),r=n.content.indexOf(this.LOG_END_TAG);if(-1!==o&&-1!==r){const e=n.content.slice(o+this.LOG_START_TAG.length,r).trim();e&&s.push(e)}for(const e of a){const n=e.content.indexOf(this.LOG_START_TAG),a=e.content.indexOf(this.LOG_END_TAG);if(-1!==n&&-1!==a){const o=e.content.slice(n+this.LOG_START_TAG.length,a).trim();o&&s.unshift(o);const r=e.content.substring(0,n)+e.content.substring(a+this.LOG_END_TAG.length);await t().setChatMessage(r.trim(),e.id,{refresh:\"none\"}),console.log(`[BLMX] Cleaned and moved UI log from message ${e.id}.`)}}const i=s.join(\"\\n\");return this._parseLogFromString(i),await this.persistLogToStorage(),console.log(`[BLMX] Consolidated log saved to message ${this.messageId}.`),!0}async persistLogToStorage(){if(null!==this.messageId)try{const e=this._renderLogToString(),n=(await t().getChatMessages(this.messageId))[0];let a=n?n.message:\"\";const s=a.indexOf(this.LOG_START_TAG),o=a.indexOf(this.LOG_END_TAG),r=`${this.LOG_START_TAG}\\n${e}\\n${this.LOG_END_TAG}`;let i;i=-1!==s&&-1!==o?a.substring(0,s)+r+a.substring(o+this.LOG_END_TAG.length):a+\"\\n\"+r,await t().setChatMessage(i.trim(),this.messageId,{refresh:\"none\"})}catch(e){console.error(\"[BLMX] Failed to save narrative log to text box:\",e)}else console.warn(\"[BLMX] Cannot save log, message_id not initialized.\")}_parseLogFromString(e){this.logEntries=[];e.split(\"\\n\").filter((e=>\"\"!==e.trim())).forEach((e=>{const t=e.indexOf(\":\");if(-1===t)return;const n=e.substring(0,t).trim(),a=e.substring(t+1).trim();try{switch(n){case\"USER_MOMENT\":case\"CHAR_MOMENT\":case\"USER_COMMENT\":case\"CHAR_COMMENT\":case\"USER_LIKE\":case\"CHAR_LIKE\":this.logEntries.push({key:n,data:JSON.parse(a)});break;case\"TIME\":case\"EVENT_LOG\":if(a){const e=JSON.parse(a),t=\"TIME\"===n?\"time\":\"event\";this.logEntries.push({type:t,content:e});const s=new Date(`${e.date} ${e.time}`);if(!isNaN(s.getTime())){window.currentGameDate=s;const e=document.getElementById(\"current-time\");if(e){const t=`${window.currentGameDate.getHours().toString().padStart(2,\"0\")}:${window.currentGameDate.getMinutes().toString().padStart(2,\"0\")}`;e.textContent=t}}}break;case\"RECALL\":{const e=JSON.parse(a),t=\"USER\"===e.sender?\"me\":\"them\",n=this.logEntries.slice().reverse().find((n=>\"sender\"in n&&n.sender===t&&\"content\"in n&&n.content===e.target_text));n&&(n.recalled=!0,n.recalled_content=n.content,n.recalled_timestamp=e.timestamp);break}case\"USER\":case\"CHAR\":{const e=\"USER\"===n?\"me\":\"them\",t=`msg-${Date.now()}${Math.random()}-${e}`,s=a.match(/^\\[语音:\\s*({.*})\\]/);if(s)try{return void this.logEntries.push({id:t,type:\"voice\",sender:e,content:JSON.parse(s[1])})}catch(e){console.error(\"Failed to parse voice data:\",s[1],e)}const o=a.match(/^\\[表情:\\s*(.*)\\]/);if(o)return void this.logEntries.push({id:t,type:\"sticker\",sender:e,content:o[1]});const r=a.match(/^\\[图片:\\s*(.*)\\]/);if(r){try{const n=JSON.parse(r[1]);this.logEntries.push({id:t,type:\"image\",sender:e,content:n})}catch(n){this.logEntries.push({id:t,type:\"image\",sender:e,content:{type:\"desc\",value:r[1]}})}return}const i=a.match(/^\\[位置:\\s*(.*)\\]/);if(i)return void this.logEntries.push({id:t,type:\"location\",sender:e,content:i[1]});const l=a.match(/^\\[转账:\\s*(.*)\\]/);if(l)return void this.logEntries.push({id:t,type:\"transfer\",sender:e,content:l[1],data:JSON.parse(l[1])});const c=a.match(/^\\[文件:\\s*(.*)\\]/);if(c)return void this.logEntries.push({id:t,type:\"file\",sender:e,content:c[1]});const d=a.match(/^\\[礼物:\\s*(.*)\\]/);if(d)return void this.logEntries.push({id:t,type:\"gift\",sender:e,content:d[1],data:JSON.parse(d[1])});this.logEntries.push({id:t,type:\"message\",sender:e,content:a});break}}}catch(t){console.error(\"Failed to parse log line:\",e,t)}}))}_renderLogToString(){const e=[];return[this.logEntries.map((t=>{if(t.recalled){const n={sender:\"sender\"in t&&\"me\"===t.sender?\"USER\":\"CHAR\",target_text:\"object\"==typeof t.recalled_content&&null!==t.recalled_content?t.recalled_content.text:t.recalled_content,timestamp:t.recalled_timestamp};n.target_text&&e.push(`RECALL: ${JSON.stringify(n)}`)}if(\"key\"in t)return`${t.key}: ${JSON.stringify(t.data)}`;if(\"type\"in t){if(\"time\"===t.type||\"event\"===t.type){return`${\"time\"===t.type?\"TIME\":\"EVENT_LOG\"}: ${JSON.stringify(t.content)}`}const e=\"me\"===t.sender?\"USER\":\"CHAR\";let n=t.content;switch(t.type){case\"sticker\":n=`[表情: ${t.content}]`;break;case\"voice\":n=`[语音: ${JSON.stringify(t.content)}]`;break;case\"image\":n=`[图片: ${JSON.stringify(t.content)}]`;break;case\"location\":n=`[位置: ${t.content}]`;break;case\"file\":n=`[文件: ${t.content}]`;break;case\"gift\":n=`[礼物: ${t.content}]`;break;case\"transfer\":n=`[转账: ${t.content}]`}return`${e}: ${n}`}return\"\"})).join(\"\\n\"),...e].filter(Boolean).join(\"\\n\")}addEntry(e){if(e){if(\"key\"in e&&(e.key.includes(\"_MOMENT\")||e.key.includes(\"_COMMENT\")||e.key.includes(\"_LIKE\"))){if(this.logEntries.some((t=>{if(\"key\"in t&&t.key===e.key){if(e.key.includes(\"_MOMENT\")){const n=e.data,a=t.data;return a.text===n.text&&a.date===n.date&&a.time===n.time}if(e.key.includes(\"_COMMENT\")){const n=e.data,a=t.data;return a.text===n.text&&a.target_post_id===n.target_post_id}if(e.key.includes(\"_LIKE\")){const n=e.data;return t.data.target_post_id===n.target_post_id}}return!1})))return void console.log(\"[BLMX] 跳过添加重复的朋友圈条目:\",e)}if(this.logEntries.push(e),\"type\"in e&&(\"time\"===e.type||\"event\"===e.type)){const t=e.content,n=new Date(`${t.date} ${t.time}`);if(!isNaN(n.getTime())){window.currentGameDate=n;const e=document.getElementById(\"current-time\");if(e){const t=`${window.currentGameDate.getHours().toString().padStart(2,\"0\")}:${window.currentGameDate.getMinutes().toString().padStart(2,\"0\")}`;e.textContent=t}}}}}getContextForAI(){return this._renderLogToString()}}const a=\"1.1.0\",s={blue:{name:\"blue\",displayName:\"蓝色主题\",colors:{phoneFrame:\"#b4d0fa\",phoneFrameGradient:[\"#4a95ed\",\"#98c2f5\",\"#accef2\",\"#4a95ed\"],primary:\"#72adf3\",light:\"#a8cbeb\",ultraLight:\"#e8f4fd\",soft:\"#b8d4f0\",deep:\"#2c5282\",gradientStart:\"#accef2\",gradientEnd:\"#98c2f5\",textColor:\"#ffffff\",textPrimary:\"rgb(139, 162, 186)\",textSecondary:\"#64748b\",borderColor:\"#cbd5e1\",bubbleShadow:\"0 2px 8px rgba(74, 144, 226, 0.15)\",bubbleThemBg:\"#ffffff\",bubbleMeBg:\"#a8cbeb\",headerBg:\"linear-gradient(135deg, #f8faff 0%, #eef4ff 100%)\",statusBarColor:\"#428af2\",dynamicIslandColor:\"#a0c4f4\",appBgColor:\"#ffffff\",settingsBgColor:\"#f2f2f7\",settingsCardBgColor:\"#ffffff\",shadowColor:\"#4a90e2\",shadowColorRgba:\"rgba(74, 144, 226, 0.3)\",isDarkMode:!1,defaultWallpapers:{chat:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/蓝色_3.jpg\",home:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/蓝色_2.jpg\",settings:\"#f2f7fd\"}}},pink:{name:\"pink\",displayName:\"粉色主题\",colors:{phoneFrame:\"#fad0e8\",phoneFrameGradient:[\"#ed4a9e\",\"#f598c8\",\"#f2acce\",\"#ed4a9e\"],primary:\"#f372ad\",light:\"#eba8cb\",ultraLight:\"#fde8f4\",soft:\"#f0b8d4\",deep:\"#822c5c\",gradientStart:\"#f2acce\",gradientEnd:\"#f598c8\",textColor:\"#ffffff\",textPrimary:\"rgb(186, 139, 162)\",textSecondary:\"#8b647a\",borderColor:\"#e1cbd5\",bubbleShadow:\"0 2px 8px rgba(226, 74, 144, 0.15)\",bubbleThemBg:\"#ffffff\",bubbleMeBg:\"#eba8cb\",headerBg:\"linear-gradient(135deg, #fff8fa 0%, #ffeeef 100%)\",statusBarColor:\"#ed72ad\",dynamicIslandColor:\"#f4a0c4\",appBgColor:\"#ffffff\",settingsBgColor:\"#fff2f7\",settingsCardBgColor:\"#ffffff\",shadowColor:\"#e24a90\",shadowColorRgba:\"rgba(226, 74, 144, 0.3)\",isDarkMode:!1,defaultWallpapers:{chat:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/粉色星星_1.jpg\",home:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/粉色格子_3.jpg\",settings:\"#fdf2f7\"}}},white:{name:\"white\",displayName:\"白色主题\",colors:{phoneFrame:\"#e0e0e0\",phoneFrameGradient:[\"#c0c0c0\",\"#e0e0e0\",\"#f0f0f0\",\"#c0c0c0\"],primary:\"#a0a0a0\",light:\"#d0d0d0\",ultraLight:\"#f8f8f8\",soft:\"#e0e0e0\",deep:\"#505050\",gradientStart:\"#e8e8e8\",gradientEnd:\"#d8d8d8\",textColor:\"#ffffff\",textPrimary:\"#505050\",textSecondary:\"#909090\",borderColor:\"#e0e0e0\",bubbleShadow:\"0 2px 8px rgba(0, 0, 0, 0.08)\",bubbleThemBg:\"#ffffff\",bubbleMeBg:\"#e0e0e0\",headerBg:\"linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%)\",statusBarColor:\"#a0a0a0\",dynamicIslandColor:\"#d0d0d0\",appBgColor:\"#ffffff\",settingsBgColor:\"#f5f5f5\",settingsCardBgColor:\"#ffffff\",shadowColor:\"#a0a0a0\",shadowColorRgba:\"rgba(0, 0, 0, 0.1)\",isDarkMode:!1,defaultWallpapers:{chat:\"#f8f8f8\",home:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/白色_1.jpg\",settings:\"#f5f5f5\"}}},dark:{name:\"dark\",displayName:\"夜间模式\",colors:{phoneFrame:\"#2c2c2c\",phoneFrameGradient:[\"#1a1a1a\",\"#2c2c2c\",\"#3c3c3c\",\"#1a1a1a\"],primary:\"#505050\",light:\"#3c3c3c\",ultraLight:\"#1a1a1a\",soft:\"#2c2c2c\",deep:\"#c0c0c0\",gradientStart:\"#2c2c2c\",gradientEnd:\"#3c3c3c\",textColor:\"#e0e0e0\",textPrimary:\"#c0c0c0\",textSecondary:\"#a0a0a0\",borderColor:\"#3c3c3c\",bubbleShadow:\"0 2px 8px rgba(0, 0, 0, 0.3)\",bubbleThemBg:\"#2a2a2a\",bubbleMeBg:\"#505050\",headerBg:\"linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%)\",statusBarColor:\"#888888\",dynamicIslandColor:\"#3c3c3c\",appBgColor:\"#1a1a1a\",settingsBgColor:\"#1a1a1a\",settingsCardBgColor:\"#2c2c2c\",shadowColor:\"#000000\",shadowColorRgba:\"rgba(0, 0, 0, 0.5)\",isDarkMode:!0,defaultWallpapers:{chat:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/深色星星_1.jpg\",home:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/深色星星_1.jpg\",settings:\"#1a1a1a\"}}}};class o{constructor(){this.checkVersion();const e=localStorage.getItem(o.THEME_STORAGE_KEY)||\"blue\";if(\"custom\"===e)try{const e=localStorage.getItem(o.CUSTOM_THEME_STORAGE_KEY);this.currentTheme=e?JSON.parse(e):s.blue}catch(e){console.error(\"Failed to load custom theme:\",e),this.currentTheme=s.blue}else this.currentTheme=s[e]||s.blue;this.wallpaperManager=new r,this.applyTheme(this.currentTheme)}checkVersion(){const e=localStorage.getItem(o.VERSION_STORAGE_KEY);e&&e===a||(console.log(`版本更新: ${e||\"初次安装\"} -> ${a}, 清理过时数据...`),this.cleanOutdatedData(),localStorage.setItem(o.VERSION_STORAGE_KEY,a))}cleanOutdatedData(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&(n.startsWith(\"blmx_user_name_\")||n.startsWith(\"blmx_user_avatar_\")||n.startsWith(\"blmx_char_avatar_\")||n.startsWith(\"blmx_remark_\")||n.startsWith(\"blmx_signature_\")||n.startsWith(\"blmx_cover_photo_\")||n.startsWith(\"blmx_input_placeholder_\"))&&e.push(n)}const t={};e.forEach((e=>{const n=localStorage.getItem(e);n&&(t[e]=n)}));for(let e=localStorage.length-1;e>=0;e--){const t=localStorage.key(e);t&&t.startsWith(\"blmx_\")&&localStorage.removeItem(t)}Object.entries(t).forEach((([e,t])=>{localStorage.setItem(e,t)})),console.log(\"数据清理完成，保留了用户个人设置\")}getCurrentTheme(){return this.currentTheme}getThemes(){return s}getWallpaperManager(){return this.wallpaperManager}switchTheme(e){if(\"custom\"===e)try{const e=localStorage.getItem(o.CUSTOM_THEME_STORAGE_KEY);e&&(this.currentTheme=JSON.parse(e),localStorage.setItem(o.THEME_STORAGE_KEY,\"custom\"),this.applyTheme(this.currentTheme),this.wallpaperManager.applyThemeDefaultWallpapers(this.currentTheme))}catch(e){console.error(\"Failed to load custom theme:\",e)}else s[e]&&(this.currentTheme=s[e],localStorage.setItem(o.THEME_STORAGE_KEY,e),this.applyTheme(this.currentTheme),this.wallpaperManager.applyThemeDefaultWallpapers(this.currentTheme))}saveCustomTheme(e){this.currentTheme=e,localStorage.setItem(o.CUSTOM_THEME_STORAGE_KEY,JSON.stringify(e)),localStorage.setItem(o.THEME_STORAGE_KEY,\"custom\"),this.applyTheme(e),this.wallpaperManager.applyThemeDefaultWallpapers(e)}applyTheme(e){const t=document.documentElement,{colors:n}=e;t.style.setProperty(\"--text-color\",n.textColor),t.style.setProperty(\"--primary-blue\",n.primary),t.style.setProperty(\"--light-blue\",n.light),t.style.setProperty(\"--ultra-light-blue\",n.ultraLight),t.style.setProperty(\"--blue-gradient-start\",n.gradientStart),t.style.setProperty(\"--blue-gradient-end\",n.gradientEnd),t.style.setProperty(\"--soft-blue\",n.soft),t.style.setProperty(\"--deep-blue\",n.deep),t.style.setProperty(\"--wechat-green-icon\",n.primary),t.style.setProperty(\"--wechat-green-bubble\",n.light),t.style.setProperty(\"--wechat-bg\",n.ultraLight),t.style.setProperty(\"--link-color\",n.primary),t.style.setProperty(\"--bubble-shadow\",n.bubbleShadow),t.style.setProperty(\"--text-primary\",n.textPrimary),t.style.setProperty(\"--text-secondary\",n.textSecondary),t.style.setProperty(\"--border-color\",n.borderColor),t.style.setProperty(\"--header-bg\",n.headerBg),t.style.setProperty(\"--wechat-bubble-them-bg\",n.bubbleThemBg),t.style.setProperty(\"--wechat-bubble-me-bg\",n.bubbleMeBg),t.style.setProperty(\"--status-bar-color\",n.statusBarColor),t.style.setProperty(\"--dynamic-island-color\",n.dynamicIslandColor),t.style.setProperty(\"--app-bg-color\",n.appBgColor),t.style.setProperty(\"--settings-bg-color\",n.settingsBgColor),t.style.setProperty(\"--settings-card-bg-color\",n.settingsCardBgColor),t.style.setProperty(\"--shadow-color\",n.shadowColor),t.style.setProperty(\"--shadow-color-rgba\",n.shadowColorRgba),t.style.setProperty(\"--phoneFrame\",n.phoneFrame);const a=this.extractRgbComponents(n.shadowColor);t.style.setProperty(\"--shadow-r\",a.r.toString()),t.style.setProperty(\"--shadow-g\",a.g.toString()),t.style.setProperty(\"--shadow-b\",a.b.toString()),n.isDarkMode?document.body.classList.add(\"dark-mode\"):document.body.classList.remove(\"dark-mode\");const s=document.querySelector(\".phone-frame\");if(s){s.style.background=n.phoneFrame;const e=n.phoneFrameGradient.join(\", \"),t=document.createElement(\"style\");t.textContent=`\\n        .phone-frame::before {\\n          background: linear-gradient(45deg, ${e});\\n          background-size: 400% 400%;\\n        }\\n      `;const a=document.getElementById(\"phone-frame-style\");a&&a.remove(),t.id=\"phone-frame-style\",document.head.appendChild(t)}const o=document.querySelector(\".dynamic-island\");o&&(o.style.background=n.dynamicIslandColor);const r=document.querySelector(\".status-left\"),i=document.querySelector(\".status-right\");r&&i&&(r.style.color=n.statusBarColor,i.style.color=n.statusBarColor);const l=document.getElementById(\"settings-view\");l&&(l.style.backgroundColor=n.settingsBgColor);document.querySelectorAll(\".settings-card\").forEach((e=>{e.style.backgroundColor=n.settingsCardBgColor})),s&&(s.style.boxShadow=`\\n        0 15px 20px ${this.hexToRgba(n.shadowColor,.25)},\\n        0 8px 20px ${this.hexToRgba(n.shadowColor,.15)},\\n        0 3px 8px rgba(0, 0, 0, 0.1),\\n        inset 0 1px 0 rgba(255, 255, 255, 0.5),\\n        inset 0 -1px 0 rgba(255, 255, 255, 0.2),\\n        0 5px ${this.hexToRgba(n.shadowColor,.08)}\\n      `);const c=document.createElement(\"style\");c.id=\"theme-dynamic-styles\",c.textContent=`\\n      .message-row.me .message-bubble {\\n        box-shadow: 0 4px 12px ${this.hexToRgba(n.shadowColor,.3)};\\n      }\\n      \\n      .wechat-footer .send-btn {\\n        box-shadow: 0 4px 12px ${this.hexToRgba(n.shadowColor,.3)};\\n      }\\n      \\n      .wechat-footer .send-btn:hover {\\n        box-shadow: 0 6px 16px ${this.hexToRgba(n.shadowColor,.4)};\\n      }\\n      \\n      /* 夜间模式特殊处理 */\\n      ${n.isDarkMode?'\\n        .settings-card p, \\n        .settings-card a,\\n        .settings-card li a,\\n        .post-content,\\n        .post-meta,\\n        .theme-editor-modal .modal-content {\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .settings-card,\\n        .theme-editor-modal .modal-content {\\n          background-color: #2a2a2a !important;\\n        }\\n        \\n        /* 修改夜间模式下CHAR消息气泡样式，使其与USER一致 */\\n        .message-row.them .message-bubble {\\n          background: linear-gradient(135deg, var(--blue-gradient-start) 0%, var(--blue-gradient-end) 100%) !important;\\n          color: #ffffff !important;\\n          border: none !important;\\n        }\\n        \\n        /* 修改夜间模式下正在输入指示器样式 */\\n        .typing-indicator .message-bubble {\\n          background: linear-gradient(135deg, var(--blue-gradient-start) 0%, var(--blue-gradient-end) 100%) !important;\\n          color: #ffffff !important;\\n          border: none !important;\\n        }\\n        \\n        .typing-dot {\\n          background-color: rgba(255, 255, 255, 0.6) !important;\\n        }\\n        \\n        .settings-card li {\\n          border-bottom-color: #3c3c3c !important;\\n        }\\n        \\n        .settings-card li a {\\n          color: #a0a0a0 !important;\\n        }\\n        \\n        #show-last-ai-response-btn,\\n        #show-last-sent-prompt-btn {\\n          background-color: #2c2c2c !important;\\n          color: #a0a0a0 !important;\\n        }\\n\\n        /* 朋友圈暗色模式 */\\n        #moments-view {\\n          background: linear-gradient(180deg, #1a1a1a 0%, #252525 100%) !important;\\n        }\\n        \\n        .moments-body {\\n          background-color: #1a1a1a !important;\\n        }\\n        \\n        .moment-post {\\n          border-bottom-color: #2c2c2c !important;\\n        }\\n        \\n        .post-interactions {\\n          background: #2a2a2a !important;\\n          border-color: #3c3c3c !important;\\n        }\\n        \\n        .post-interactions::before {\\n          border-bottom-color: #2a2a2a !important;\\n        }\\n        \\n        .likes-section {\\n          background: rgba(42, 42, 42, 0.8) !important;\\n        }\\n        \\n        .comments-section {\\n          border-top-color: #3c3c3c !important;\\n        }\\n        \\n        .post-meta .comment-button {\\n          background: #2c2c2c !important;\\n        }\\n\\n        /* 更多夜间模式样式 */\\n        .post-author-name, \\n        .liker-name, \\n        .comment-author {\\n          color: #a0c0e0 !important;\\n        }\\n        \\n        .moments-header,\\n        .wechat-header {\\n          background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%) !important;\\n          border-bottom-color: #3c3c3c !important;\\n        }\\n        \\n        .wechat-footer {\\n          background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%) !important;\\n          border-top-color: #3c3c3c !important;\\n        }\\n        \\n        .wechat-footer .text-input {\\n          background-color: #2a2a2a !important;\\n          border-color: #3c3c3c !important;\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .wechat-footer .text-input::placeholder {\\n          color: #808080 !important;\\n        }\\n        \\n        .timestamp-text,\\n        .event-time-text {\\n          background: linear-gradient(135deg, #3c3c3c 0%, #505050 100%) !important;\\n        }\\n        \\n        .recall-notice-text {\\n          background: linear-gradient(135deg, #3c3c3c 0%, #505050 100%) !important;\\n        }\\n        \\n        .message-row.them .voice-bubble .voice-icon {\\n          color: #a0c0e0 !important;\\n        }\\n        \\n        .voice-text-content {\\n          background-color: #2a2a2a !important;\\n          border-color: #3c3c3c !important;\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .location-card,\\n        .file-card {\\n          background-color: #2a2a2a !important;\\n        }\\n        \\n        .location-content .location-title {\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .file-details .file-name {\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .file-footer {\\n          background-color: #252525 !important;\\n          border-top-color: #3c3c3c !important;\\n        }\\n        \\n        .panel-container {\\n          background-color: #1a1a1a !important;\\n        }\\n        \\n        .feature-icon {\\n          background-color: #2a2a2a !important;\\n          border-color: #3c3c3c !important;\\n        }\\n        \\n        .feature-label {\\n          color: #a0a0a0 !important;\\n        }\\n        \\n        /* Theme-colored icons in dark mode */\\n        .feature-icon .theme-icon {\\n          color: var(--primary-blue) !important;\\n        }\\n        \\n        /* 壁纸选择器暗色模式 */\\n        .wallpaper-container {\\n          background-color: #2a2a2a !important;\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .wallpaper-container h2,\\n        .wallpaper-container h3,\\n        .wallpaper-container p {\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .wallpaper-container input[type=\"text\"],\\n        .wallpaper-container input[type=\"file\"] {\\n          background-color: #1a1a1a !important;\\n          border-color: #3c3c3c !important;\\n          color: #e0e0e0 !important;\\n        }\\n        \\n        .wallpaper-item .name {\\n          background-color: rgba(42, 42, 42, 0.9) !important;\\n          color: #e0e0e0 !important;\\n        }\\n      ':\"\"}\\n    `;const d=document.getElementById(\"theme-dynamic-styles\");d&&d.remove(),document.head.appendChild(c)}hexToRgba(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}extractRgbComponents(e){return{r:parseInt(e.slice(1,3),16),g:parseInt(e.slice(3,5),16),b:parseInt(e.slice(5,7),16)}}}o.THEME_STORAGE_KEY=\"blmx_theme\",o.CUSTOM_THEME_STORAGE_KEY=\"blmx_custom_theme\",o.VERSION_STORAGE_KEY=\"blmx_app_version\";class r{constructor(){this.builtInWallpapers=[{id:\"blue_solid\",type:\"color\",value:\"#e8f4fd\",name:\"蓝色纯色\"},{id:\"pink_solid\",type:\"color\",value:\"#fde8f4\",name:\"粉色纯色\"},{id:\"white_solid\",type:\"color\",value:\"#f8f8f8\",name:\"白色纯色\"},{id:\"dark_solid\",type:\"color\",value:\"#1a1a1a\",name:\"黑色纯色\"},{id:\"default_image\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/白色_1.jpg\",name:\"白色壁纸\"},{id:\"dark_image\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/深色星星_1.jpg\",name:\"深色星星壁纸\"},{id:\"blue_theme\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/蓝色星星_1.jpg\",name:\"蓝色星星壁纸\"},{id:\"pink_theme\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/粉色星星_1.jpg\",name:\"粉色星星壁纸\"},{id:\"kitty_theme\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/粉色小猫_1.jpg\",name:\"粉色小猫壁纸\"},{id:\"deep_stars_2\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/深色星星_2.jpg\",name:\"深色星星壁纸2\"},{id:\"deep_stars_3\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/深色星星_3.jpg\",name:\"深色星星壁纸3\"},{id:\"white_stars\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/白色星星_1.jpg\",name:\"白色星星壁纸\"},{id:\"pink_stars_2\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/粉色星星_2.jpg\",name:\"粉色星星壁纸2\"},{id:\"pink_grid_2\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/粉色格子_2.jpg\",name:\"粉色格子壁纸2\"},{id:\"pink_grid_4\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/粉色格子_4.jpg\",name:\"粉色格子壁纸4\"},{id:\"blue_1\",type:\"image\",value:\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/素材/wallpaper/蓝色_1.jpg\",name:\"蓝色壁纸1\"}],this.customWallpapers=[],this.loadCustomWallpapers()}getAllWallpapers(){return[...this.builtInWallpapers,...this.customWallpapers]}getBuiltInWallpapers(){return this.builtInWallpapers}getCustomWallpapers(){return this.customWallpapers}addCustomWallpaper(e){const t={...e,id:`custom_${Date.now()}`};return this.customWallpapers.push(t),this.saveCustomWallpapers(),t}deleteCustomWallpaper(e){const t=this.customWallpapers.length;return this.customWallpapers=this.customWallpapers.filter((t=>t.id!==e)),this.customWallpapers.length!==t&&(this.saveCustomWallpapers(),!0)}setWallpaper(e,t){const n=`${r.WALLPAPER_STORAGE_KEY_PREFIX}${e}`;t?localStorage.setItem(n,JSON.stringify(t)):localStorage.removeItem(n)}getCurrentWallpaper(e){const t=`${r.WALLPAPER_STORAGE_KEY_PREFIX}${e}`,n=localStorage.getItem(t);if(n)try{return JSON.parse(n)}catch(e){return console.error(\"Failed to parse wallpaper:\",e),null}return null}applyThemeDefaultWallpapers(e){[\"chat\",\"home\",\"settings\"].forEach((t=>{if(this.getCurrentWallpaper(t))return;const n=e.colors.defaultWallpapers[t],a={id:`theme_default_${t}`,type:n.startsWith(\"#\")?\"color\":\"image\",value:n,name:`${e.displayName}默认${\"chat\"===t?\"聊天\":\"home\"===t?\"主屏幕\":\"设置\"}壁纸`};this.setWallpaper(t,a)}))}applyWallpaperToElement(e,t,n){e&&(e.style.backgroundImage=\"none\",e.style.backgroundColor=\"\",e.style.backgroundSize=\"\",e.style.backgroundPosition=\"\",e.style.backgroundRepeat=\"\",t?\"color\"===t.type?(e.style.backgroundImage=\"none\",e.style.backgroundColor=t.value):(e.style.backgroundImage=`url(\"${t.value}\")`,e.style.backgroundSize=\"cover\",e.style.backgroundPosition=\"center\",e.style.backgroundRepeat=\"no-repeat\"):n&&(n.startsWith(\"#\")?(e.style.backgroundImage=\"none\",e.style.backgroundColor=n):(e.style.backgroundImage=`url(\"${n}\")`,e.style.backgroundSize=\"cover\",e.style.backgroundPosition=\"center\",e.style.backgroundRepeat=\"no-repeat\")))}async createWallpaperFromUrl(e,t){try{return new URL(e),this.addCustomWallpaper({type:\"url\",value:e,name:t||`URL壁纸 ${(new Date).toLocaleString()}`})}catch(e){return console.error(\"Invalid URL:\",e),null}}async createWallpaperFromFile(e){return new Promise((t=>{if(!e.type.startsWith(\"image/\"))return void t(null);const n=new FileReader;n.onload=n=>{if(n.target?.result){const a=this.addCustomWallpaper({type:\"image\",value:n.target.result,name:e.name||`上传的壁纸 ${(new Date).toLocaleString()}`});t(a)}else t(null)},n.onerror=()=>t(null),n.readAsDataURL(e)}))}createSolidColorWallpaper(e,t){if(!e.match(/^#([0-9A-Fa-f]{3}){1,2}$/))return console.error(\"Invalid color format:\",e),null;let n=e;if(4===e.length){const t=e[1],a=e[2],s=e[3];n=`#${t}${t}${a}${a}${s}${s}`}return this.addCustomWallpaper({type:\"color\",value:n,name:t||`纯色壁纸 ${n}`})}loadCustomWallpapers(){const e=localStorage.getItem(r.CUSTOM_WALLPAPERS_KEY);if(e)try{this.customWallpapers=JSON.parse(e)}catch(e){console.error(\"Failed to load custom wallpapers:\",e),this.customWallpapers=[]}}saveCustomWallpapers(){localStorage.setItem(r.CUSTOM_WALLPAPERS_KEY,JSON.stringify(this.customWallpapers))}}r.WALLPAPER_STORAGE_KEY_PREFIX=\"blmx_wallpaper_\",r.CUSTOM_WALLPAPERS_KEY=\"blmx_custom_wallpapers\";class i{constructor(e,t,n){if(this.lastDisplayedTimeInMinutes=-1/0,this.wechatBody=document.querySelector(e),!this.wechatBody)throw new Error(`Element with selector \"${e}\" not found`);this.avatars=t,this.options=n}clearChat(){this.wechatBody.innerHTML=\"\",this.lastDisplayedTimeInMinutes=-1/0}renderEntry(e,t,n=!1){if(e&&\"type\"in e)switch(e.type){case\"message\":e.isSystemMessage?this.renderSystemMessage(e,n):this.addMessageToWeChat(e,t,n);break;case\"time\":this.addTimestampToWeChat(e.content.date,e.content.time,!0,t);break;case\"event\":this.addEventLogToWeChat(e.content,t);break;default:this.addMessageToWeChat(e,t,n)}}renderRecallNotice(e,t=null,n){const a=this.options.getDisplayName(\"sender\"in e&&\"me\"===e.sender?\"user\":\"char\"),s=document.createElement(\"div\");s.className=\"timestamp-row\",void 0!==n&&(s.dataset.logIndex=n.toString());const o=\"object\"==typeof e.recalled_content&&null!==e.recalled_content?e.recalled_content.text:e.recalled_content;s.innerHTML=`\\n      <div class=\"recall-notice-container\">\\n        <div class=\"recall-notice-text\">\"${a}\" 撤回了一条消息</div>\\n        <div class=\"recall-content\">${o||(\"content\"in e?e.content:\"\")}</div>\\n      </div>\\n    `;const r=s.querySelector(\".recall-notice-text\"),i=s.querySelector(\".recall-content\");r&&i&&r.addEventListener(\"click\",(()=>{i.classList.toggle(\"expanded\")})),t?t.replaceWith(s):this.wechatBody.appendChild(s),this.scrollToBottom()}renderMomentsFeed(e,t,n){const a=document.getElementById(\"moments-feed-list\");if(!a)return;a.innerHTML=\"\";const s={},o=[];e.forEach(((e,t)=>{\"key\"in e&&e.key.includes(\"_MOMENT\")&&o.push(t)})),o.forEach((t=>{const n=e[t];s[t]={...n,likes:[],comments:[],id:t}})),e.forEach(((e,n)=>{if(\"key\"in e&&(e.key.includes(\"_LIKE\")||e.key.includes(\"_COMMENT\"))){const a=o[parseInt(e.data.target_post_id,10)],r=s[a];if(r)if(e.key.includes(\"_LIKE\")){const a=e.key.startsWith(\"USER\")?t(\"user\"):t(\"char\");r.likes.some((e=>e.name===a))||r.likes.push({key:e.key,name:a,originalLogIndex:n})}else r.comments.push({...e,originalLogIndex:n});else console.warn(`[BLMX] Could not find target post for interaction. target_post_id: ${e.data.target_post_id}`,e)}})),Object.values(s).reverse().forEach((e=>{const s=e.key.startsWith(\"USER\"),r=t(s?\"user\":\"char\"),i=s?n.user:n.char,l=document.createElement(\"li\");l.className=\"moment-post\",l.dataset.postId=e.id;const c=o.indexOf(e.id);l.dataset.momentSequenceId=String(c);let d=\"\";\"url\"===e.data.image_type&&e.data.image?d=`<img src=\"${e.data.image}\" class=\"post-media-image\">`:\"desc\"===e.data.image_type&&e.data.image&&(d=`<div class=\"image-desc-content\"><div class=\"text-wrapper\">${e.data.image}</div></div>`);let p=\"\";if(e.likes.length>0||e.comments.length>0){p=`<div class=\"post-interactions\">${e.likes.length>0?`<div class=\"likes-section\"><i class=\"fas fa-heart\"></i> ${e.likes.map((e=>`<span class=\"liker-name\">${e.name}</span>`)).join(\", \")}</div>`:\"\"}${e.comments.length>0?`<ul class=\"comments-section\">${e.comments.map((e=>`<li><span class=\"comment-author\">${e.key.startsWith(\"USER\")?t(\"user\"):t(\"char\")}</span>: ${e.data.text}</li>`)).join(\"\")}</ul>`:\"\"}</div>`}const m=this.formatMomentTimestamp(e.data.date,e.data.time),g=s?'<span class=\"delete-moment-btn\" title=\"删除\">删除</span>':\"\";l.innerHTML=`<img src=\"${i}\" alt=\"Avatar\" class=\"post-author-avatar\">\\n                         <div class=\"post-details\">\\n                             <span class=\"post-author-name\">${r}</span>\\n                             <p class=\"post-content\">${e.data.text||\"\"}</p>\\n                             <div class=\"post-media\">${d}</div>\\n                             <div class=\"post-meta\">\\n                                 <div class=\"post-meta-left\">\\n                                     <span class=\"timestamp\">${m}</span>\\n                                     ${g}\\n                                 </div>\\n                                 <div class=\"post-actions\">\\n                                     <span class=\"comment-button\" title=\"评论/点赞\"><i class=\"fas fa-comment-dots\"></i></span>\\n                                 </div>\\n                             </div>\\n                             ${p}\\n                         </div>`,a.appendChild(l)}))}showTypingIndicator(){this.hideTypingIndicator();const e=document.createElement(\"div\");e.className=\"typing-indicator\",e.id=\"typing-indicator-id\";const t=this.avatars.char;e.innerHTML=`\\n      <img src=\"${t}\" class=\"message-avatar\">\\n      <div class=\"message-bubble\">\\n        <span class=\"typing-dot\"></span>\\n        <span class=\"typing-dot\"></span>\\n        <span class=\"typing-dot\"></span>\\n      </div>\\n    `,this.wechatBody.appendChild(e),this.scrollToBottom()}hideTypingIndicator(){const e=document.getElementById(\"typing-indicator-id\");e&&e.remove()}calculateTypingDelay(e){if(\"string\"!=typeof e||\"\"===e.trim())return 800+700*Math.random();let t=500+40*e.length+800*Math.random();return Math.min(t,3e3)}addMessageToWeChat(e,t,n=!1){const{id:a,sender:s,type:o,content:r}=e,i=document.createElement(\"div\");i.className=\"message-row\",void 0!==t&&(i.dataset.logIndex=t.toString()),i.dataset.messageId=a;const l=s;i.classList.add(l);const c=`<img src=\"${\"me\"===s?this.avatars.user:this.avatars.char}\" class=\"message-avatar\">`;if(\"voice\"===o)this.renderVoiceMessage(i,e,c);else{let t=\"\";switch(o){case\"sticker\":t=this.renderStickerContent(e);break;case\"image\":t=this.renderImageContent(e);break;case\"location\":t=this.renderLocationContent(e);break;case\"transfer\":t=this.renderTransferContent(e);break;case\"file\":t=this.renderFileContent(e);break;case\"gift\":const n=e;t=n.data.name.includes(\"红包\")||n.data.name.includes(\"压岁钱\")||n.data.name.includes(\"红利\")?this.renderRedEnvelopeContent(n):this.renderGiftContent(n);break;default:t=e.content.replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\")}i.innerHTML=\"me\"===s?`<div class=\"message-bubble\">${t}</div>${c}`:`${c}<div class=\"message-bubble\">${t}</div>`;const n=i.querySelector(\".message-bubble\");n&&(this.applyBubbleStyles(n,o,e),this.setupBubbleInteractions(n,o,e))}n&&i.classList.add(\"new-message\"),this.wechatBody.appendChild(i),this.scrollToBottom()}renderVoiceMessage(e,t,n){const a=document.createElement(\"div\");a.className=\"message-content-container\";const s=document.createElement(\"div\");s.className=\"message-bubble voice-bubble\",s.innerHTML=`<span class=\"duration\">${t.content.duration}\"</span><i class=\"fas fa-wifi voice-icon\"></i>`;const o=document.createElement(\"div\");o.className=\"voice-text-content\",o.textContent=t.content.text,a.appendChild(s),a.appendChild(o),\"me\"===t.sender?(e.appendChild(a),e.insertAdjacentHTML(\"beforeend\",n)):(e.insertAdjacentHTML(\"afterbegin\",n),e.appendChild(a));let r=!1;let i;s.addEventListener(\"pointerdown\",(t=>{\"mouse\"===t.pointerType&&0!==t.button||(r=!1,i=window.setTimeout((()=>{e.classList.add(\"voice-text-visible\"),r=!0}),500))})),s.addEventListener(\"pointerup\",(()=>{clearTimeout(i),r||e.classList.contains(\"voice-text-visible\")&&e.classList.remove(\"voice-text-visible\")})),s.addEventListener(\"pointerleave\",(()=>clearTimeout(i))),s.addEventListener(\"contextmenu\",(e=>e.preventDefault()))}renderStickerContent(e){const t=this.options.findStickerUrlByName(e.content);return t?`<div class=\"sticker-container\"><img src=\"${t}\" alt=\"${e.content}\" class=\"sticker-img\" onerror=\"this.onerror=null; this.src='data:image/svg+xml;charset=UTF-8,<svg xmlns=\\\\'http://www.w3.org/2000/svg\\\\' width=\\\\'24\\\\' height=\\\\'24\\\\' viewBox=\\\\'0 0 24 24\\\\'><path fill=\\\\\"%23ccc\\\\\" d=\\\\'M21.9 21.9l-20.8-20.8M2.1 21.9l20.8-20.8M21 12c0 5-4 9-9 9s-9-4-9-9 4-9 9-9 9 4 9 9z\\\\'/></svg>';\" /></div>`:`<div class=\"sticker-placeholder\">[表情: ${e.content}]</div>`}renderImageContent(e){if(\"url\"===e.content.type){let t=e.content.value;if(t.startsWith(\"blmx-img-\")){const e=sessionStorage.getItem(t);if(!e)return'<div class=\"image-desc-content\"><div class=\"text-wrapper\">[图片已过期]</div></div>';t=e}return`<img src=\"${t}\" alt=\"图片\">`}{const t=e.content.value;return`<div class=\"image-desc-content\"><div class=\"text-wrapper\">${String(t).replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\")}</div></div>`}}renderLocationContent(e){return`<div class=\"location-card\">\\n      <div class=\"location-content\">\\n        <div class=\"location-title\">${e.content}</div>\\n        <div class=\"location-subtitle\">共享实时位置</div>\\n      </div>\\n      <div class=\"location-map-placeholder\"></div>\\n    </div>`}renderTransferContent(e){const t=\"sent\"!==e.data.status,n=t?`<div class=\"status-text\">${\"accepted\"===e.data.status?\"已接收\":\"已退还\"}</div>`:`<div class=\"note\">${e.data.note||\" \"}</div>`;return`<div class=\"transfer-card ${t?\"transfer-receipt\":\"transfer-initial\"}\">\\n      <div class=\"transfer-content\">\\n        <img src=\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E7%B4%A0%E6%9D%90/arrows.png\" class=\"transfer-icon-image\">\\n        <div class=\"transfer-details\">\\n          <div class=\"amount\">¥${e.data.amount}</div>\\n          ${n}\\n        </div>\\n      </div>\\n      <div class=\"transfer-footer\">转账</div>\\n    </div>`}renderFileContent(e){return`<div class=\"file-card\">\\n      <div class=\"file-content\">\\n        <i class=\"fas fa-file-alt file-icon\"></i>\\n        <div class=\"file-details\">\\n          <div class=\"file-name\">${e.content.replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\")}</div>\\n        </div>\\n      </div>\\n      <div class=\"file-footer\">文件</div>\\n    </div>`}renderGiftContent(e){let t=\"\";return t=\"sent\"===e.data.status?e.data.price?`<div class=\"gift-price\">¥ ${e.data.price}</div>`:\"\":`<div class=\"gift-status-text\">${\"accepted\"===e.data.status?\"已收下\":\"已拒收\"}</div>`,`<div class=\"gift-content\">\\n      <span class=\"gift-icon-emoji\">🎁</span>\\n      <div class=\"gift-details\">\\n        <div class=\"gift-name\">${e.data.name}</div>\\n        ${t}\\n      </div>\\n    </div>\\n    <div class=\"gift-footer\">礼物</div>`}renderRedEnvelopeContent(e){let t=\"\";return t=\"sent\"===e.data.status?e.data.price?`<div class=\"gift-price\">¥ ${e.data.price}</div>`:\"\":`<div class=\"gift-status-text\">${\"accepted\"===e.data.status?\"已领取\":\"已拒收\"}</div>`,`<div class=\"gift-content\">\\n      <img src=\"https://gitgud.io/lolodesu/lolobabytutorial/-/raw/master/lologame/%E7%B4%A0%E6%9D%90/red-envelope.png\" class=\"gift-icon-image\">\\n      <div class=\"gift-details\">\\n        <div class=\"gift-name\">${e.data.name}</div>\\n        ${t}\\n      </div>\\n    </div>\\n    <div class=\"gift-footer\">红包</div>`}applyBubbleStyles(e,t,n){if(\"image\"===t)\"url\"===n.content.type?e.classList.add(\"image-url-bubble\"):e.classList.add(\"image-desc-bubble\");else{const n={sticker:\"sticker-bubble\",location:\"location-bubble\",transfer:\"transfer-bubble\",file:\"file-bubble\",gift:\"gift-bubble\"};n[t]&&e.classList.add(n[t])}}setupBubbleInteractions(e,t,n){if(\"transfer\"===t){const t=e.querySelector(\".transfer-card\");if(!t)return;const a=n;\"sent\"!==a.data.status||\"them\"!==n.sender||(t.classList.add(\"them\"),t.addEventListener(\"click\",(()=>{const e=confirm(`接收来自 ${this.options.getDisplayName(\"char\")} 的转账？\\n(选择\"取消\"将视为退还)`)?\"accepted\":\"rejected\";this.options.onTransferAccept&&this.options.onTransferAccept({...a.data,status:e})}),{once:!0}))}if(\"gift\"===t){const t=e,a=n;\"them\"===n.sender&&\"sent\"===a.data.status&&(t.style.cursor=\"pointer\",t.addEventListener(\"click\",(()=>{const e=confirm(`接收来自 ${this.options.getDisplayName(\"char\")} 的礼物 \"${a.data.name}\" 吗？\\n(选择\"取消\"将视为拒收)`)?\"accepted\":\"rejected\";this.options.onGiftAction&&this.options.onGiftAction(a.data,e),t.style.cursor=\"default\"}),{once:!0})),\"me\"===n.sender&&\"sent\"!==a.data.status&&(t.style.backgroundColor=\"#355a96\")}}addTimestampToWeChat(e,t,n,a){const s=this.formatMomentTimestamp(e,t);if(n){if(s===t){const e=this.parseTimeToMinutes(s);if(null!==e&&e-this.lastDisplayedTimeInMinutes<10)return;null!==e&&(this.lastDisplayedTimeInMinutes=e)}else this.lastDisplayedTimeInMinutes=-1/0}const o=document.createElement(\"div\");o.className=\"timestamp-row\",void 0!==a&&(o.dataset.logIndex=a.toString()),o.dataset.originalDate=e,o.dataset.originalTime=t,o.innerHTML=`<span class=\"timestamp-text\">${s}</span>`,this.wechatBody.appendChild(o),this.scrollToBottom()}addEventLogToWeChat(e,t){const n=this.formatMomentTimestamp(e.date,e.time),a=document.createElement(\"div\");if(a.className=\"event-log-row\",void 0!==t&&(a.dataset.logIndex=t.toString()),a.dataset.originalDate=e.date,a.dataset.originalTime=e.time,a.innerHTML=`\\n      <div class=\"event-log-container\">\\n        <div class=\"event-time-text\">${n}</div>\\n        <div class=\"event-description\">${e.description||\"\"}</div>\\n      </div>\\n    `,e.description){const e=a.querySelector(\".event-time-text\"),t=a.querySelector(\".event-description\");e&&t&&(e.classList.add(\"has-desc\"),e.addEventListener(\"click\",(()=>{t.classList.toggle(\"expanded\")})))}this.wechatBody.appendChild(a),this.scrollToBottom()}renderSystemMessage(e,t=!1){const n=this.wechatBody;if(!n)return;const a=document.createElement(\"div\");a.className=\"event-log-row\",t&&a.classList.add(\"new-message\"),e.id&&(a.dataset.messageId=e.id);const s=document.createElement(\"div\");s.className=\"event-log-container\";const o=document.createElement(\"div\");o.className=\"event-time-text\",o.style.cssText=\"\\n      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);\\n      padding: 0.5rem 1rem;\\n      border-radius: 1rem;\\n      color: white;\\n      font-size: 0.85em;\\n      max-width: 80%;\\n      text-align: center;\\n    \",o.textContent=e.content,s.appendChild(o),a.appendChild(s),n.appendChild(a),this.scrollToBottom()}parseTimeToMinutes(e){const t=e.match(/(\\d{1,2}):(\\d{2})/);return t?60*parseInt(t[1],10)+parseInt(t[2],10):null}formatMomentTimestamp(e,t){if(!e||!t)return\" \";try{const n=new Date(e),a=window.currentGameDate?new Date(window.currentGameDate):new Date,s=n.getFullYear(),o=n.getMonth(),r=n.getDate(),i=a.getFullYear(),l=a.getMonth(),c=a.getDate();if(s===i&&o===l&&r===c)return t;const d=new Date(a);d.setDate(a.getDate()-1);const p=d.getFullYear(),m=d.getMonth(),g=d.getDate();return s===p&&o===m&&r===g?`昨天 ${t}`:s===i?`${o+1}月${r}日 ${t}`:`${s}年${o+1}月${r}日 ${t}`}catch(e){return console.error(\"Error formatting timestamp:\",e),t}}refreshAllTimestamps(){const e=this.wechatBody.querySelectorAll(\".timestamp-row\"),t=this.wechatBody.querySelectorAll(\".event-log-row\");e.forEach((e=>{const t=e.querySelector(\".timestamp-text\");if(t){const n=e.dataset.originalDate,a=e.dataset.originalTime;n&&a&&(t.textContent=this.formatMomentTimestamp(n,a))}})),t.forEach((e=>{const t=e.querySelector(\".event-time-text\");if(t){const n=e.dataset.originalDate,a=e.dataset.originalTime;n&&a&&(t.textContent=this.formatMomentTimestamp(n,a))}}))}renderFeatureGrid(e,t,n){e.innerHTML=\"\";const a=e.classList.contains(\"sticker-delete-mode\");t.forEach((t=>{const s=document.createElement(\"div\");s.className=\"feature-item\";let o=\"\";o=t.isAddBtn?\"表情管理\"===t.label?'<div class=\"feature-icon\"><i class=\"fas fa-cog\"></i></div>':`<div class=\"feature-icon\"><i class=\"fas fa-${\"添加\"===t.label?\"plus\":\"trash-alt\"}\"></i></div>`:t.icon.startsWith(\"http\")?`<div class=\"feature-icon\"><img src=\"${t.icon}\" alt=\"${t.label}\"></div>`:t.icon.startsWith(\"fas \")||t.icon.startsWith(\"far \")||t.icon.startsWith(\"fab \")?`<div class=\"feature-icon\"><i class=\"${t.icon} theme-icon\"></i></div>`:`<div class=\"feature-icon\"><i class=\"${t.icon}\"></i></div>`,s.innerHTML=`${o}<span class=\"feature-label\">${t.label}</span>`;const r=s.querySelector(\".feature-icon\");if(!a||t.isAddBtn||t.isDefault)\"添加\"===t.label?s.addEventListener(\"click\",n.onAddStickers):\"删除\"===t.label||\"表情管理\"===t.label?s.addEventListener(\"click\",n.onToggleDeleteMode):s.addEventListener(\"click\",t.action);else{const e=document.createElement(\"input\");e.type=\"checkbox\",e.className=\"sticker-checkbox\",e.style.display=\"block\",e.dataset.stickerLabel=t.label,s.appendChild(e),s.addEventListener(\"click\",(t=>{t.preventDefault(),t.stopPropagation(),e.checked=!e.checked,r?.classList.toggle(\"selected-for-delete\",e.checked)}))}e.appendChild(s)}))}scrollToBottom(){this.wechatBody.scrollTop=this.wechatBody.scrollHeight}}const l=\"blmx_phone_size\",c=\"blmx_sticker_size\",d={default:\"48.75rem\",medium:\"42rem\",small:\"36rem\"};class p{constructor(){this.isGenerating=!1,this.latestAiRawResponse=\"还没有收到AI的回复。\",this.latestSentPrompt=\"还没有发送任何内容给AI。\",this.defaultGlobalStickers=[{label:\"好的\",url:\"https://files.catbox.moe/3j0tpc.jpeg\"}],this.config={avatars:{user:\"\",char:\"\"},names:{user:\"User\",char:\"Character\"},charRemark:\"\",currentCharId:\"\"}}async initialize(){try{console.log(\"[BLMX] Fetching SillyTavern info...\"),window.currentGameDate=new Date,this.themeManager=new o,this.wallpaperManager=this.themeManager.getWallpaperManager();const a=this.themeManager.getCurrentTheme();this.wallpaperManager.applyThemeDefaultWallpapers(a);const s=await t().getCharData();this.config.currentCharId=s.name,this.config.names.char=s.name,this.config.charRemark=localStorage.getItem(`blmx_remark_${this.config.currentCharId}`)||\"\",this.config.names.user=localStorage.getItem(`blmx_user_name_${this.config.currentCharId}`)||\"User\",this.config.avatars.user=localStorage.getItem(`blmx_user_avatar_${this.config.currentCharId}`)||\"\";const r=localStorage.getItem(`blmx_char_avatar_${this.config.currentCharId}`);this.config.avatars.char=r||await t().getCharAvatarPath(),document.querySelector(\".contact-name\").textContent=this.getDisplayName(\"char\"),document.getElementById(\"moments-user-name\").textContent=this.getDisplayName(\"user\"),document.getElementById(\"moments-user-avatar\").setAttribute(\"src\",this.config.avatars.user);const l=localStorage.getItem(`blmx_cover_photo_${this.config.currentCharId}`);l&&(document.getElementById(\"moments-cover-photo\").src=l);const c=localStorage.getItem(`blmx_signature_${this.config.currentCharId}`)||\"\";document.getElementById(\"user-signature-display\").textContent=c,this.blmxManager=new n(this.config.currentCharId),await this.blmxManager.initialize(),this.uiRenderer=new i(\".wechat-body\",this.config.avatars,{getDisplayName:this.getDisplayName.bind(this),findStickerUrlByName:this.findStickerUrlByName.bind(this),onTransferAccept:this.handleTransferAccept.bind(this),onGiftAction:this.handleGiftAction.bind(this)}),this.eventHandler=new e(\"#wechat-input-field\",\"#send-btn\",\"#plus-btn\",this.blmxManager,this,this.uiRenderer,{getDisplayName:this.getDisplayName.bind(this),stageAndDisplayEntry:this.stageAndDisplayEntry.bind(this),triggerAiResponse:this.triggerAiResponse.bind(this),updateFooterButtonsState:this.updateFooterButtonsState.bind(this),renderChatHistory:this.renderChatHistory.bind(this),renderMomentsFeed:this.renderMomentsFeed.bind(this),togglePanel:this.togglePanel.bind(this),findStickerUrlByName:this.findStickerUrlByName.bind(this)}),this.applyWallpapers(),this.renderChatHistory(),this.renderMomentsFeed();const d=localStorage.getItem(`blmx_input_placeholder_${this.config.currentCharId}`),p=document.getElementById(\"wechat-input-field\");p.placeholder=d||`与 ${this.getDisplayName(\"char\")} 对话...`,p.disabled=!1,this.updateFooterButtonsState(),this.setupThemeSelector(),this.setupPhoneSizeAdjustment(),this.setupStickerSizeControl(),this.displayAppVersion(),this.checkVersionUpdateNotification(),console.log(\"[BLMX] Initialization complete!\")}catch(e){console.error(\"[BLMX] Failed to initialize:\",e)}}displayAppVersion(){const e=document.getElementById(\"app-version-display\");e&&(e.textContent=`v${a}`)}checkVersionUpdateNotification(){localStorage.getItem(\"blmx_last_notified_version\")!==a&&(this.showVersionUpdateNotification(),localStorage.setItem(\"blmx_last_notified_version\",a))}showVersionUpdateNotification(){const e={type:\"message\",sender:\"them\",content:`系统消息：应用已更新到 v${a}，已自动清理过时数据以确保功能正常运行。您无需手动清除浏览器缓存。`,id:`system-${Date.now()}`,isSystemMessage:!0};this.blmxManager.addEntry(e),this.uiRenderer.renderEntry(e,void 0,!0)}getDisplayName(e){return\"char\"===e?this.config.charRemark||this.config.names.char:this.config.names.user}findStickerUrlByName(e){const t=[...this.defaultGlobalStickers,...JSON.parse(localStorage.getItem(\"blmx_wechat_stickers_global\")||\"[]\")],n=JSON.parse(localStorage.getItem(`blmx_char_stickers_${this.config.currentCharId}`)||\"[]\");return[...t,...n].find((t=>t.label===e))?.url}applyWallpapers(){const e=document.getElementById(\"wechat-view\"),t=document.getElementById(\"app-homescreen\"),n=document.getElementById(\"settings-view\"),a=this.themeManager.getCurrentTheme(),s=this.wallpaperManager.getCurrentWallpaper(\"chat\");this.wallpaperManager.applyWallpaperToElement(e,s,a.colors.defaultWallpapers.chat);const o=this.wallpaperManager.getCurrentWallpaper(\"home\");this.wallpaperManager.applyWallpaperToElement(t,o,a.colors.defaultWallpapers.home);const r=this.wallpaperManager.getCurrentWallpaper(\"settings\");this.wallpaperManager.applyWallpaperToElement(n,r,a.colors.defaultWallpapers.settings)}changeWallpaper(e){this.showWallpaperSelector(e)}showWallpaperSelector(e){const t=document.createElement(\"div\");t.className=\"wallpaper-modal\",t.style.cssText=\"\\n      position: fixed;\\n      top: 0;\\n      left: 0;\\n      right: 0;\\n      bottom: 0;\\n      background-color: rgba(0, 0, 0, 0.7);\\n      display: flex;\\n      justify-content: center;\\n      align-items: center;\\n      z-index: 1000;\\n    \";const n=document.createElement(\"div\");n.className=\"wallpaper-container\",n.style.cssText=\"\\n      background-color: white;\\n      border-radius: 12px;\\n      width: 90%;\\n      max-width: 500px;\\n      max-height: 80vh;\\n      overflow-y: auto;\\n      padding: 20px;\\n      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);\\n    \";const a=document.createElement(\"h2\");a.textContent=`选择${\"chat\"===e?\"聊天\":\"home\"===e?\"主屏幕\":\"设置\"}壁纸`,a.style.cssText=\"\\n      margin-top: 0;\\n      color: var(--text-primary);\\n      font-size: 1.2rem;\\n      text-align: center;\\n      margin-bottom: 20px;\\n    \",n.appendChild(a);const s=document.createElement(\"div\");s.style.cssText=`\\n      display: flex;\\n      border-bottom: 1px solid ${document.body.classList.contains(\"dark-mode\")?\"#3c3c3c\":\"#eee\"};\\n      margin-bottom: 15px;\\n    `;const o=(e,t,a=!1)=>{const o=document.createElement(\"div\");return o.textContent=e,o.dataset.tabId=t,o.style.cssText=`\\n        padding: 10px 15px;\\n        cursor: pointer;\\n        font-weight: ${a?\"bold\":\"normal\"};\\n        color: ${a?\"var(--primary-blue)\":\"var(--text-secondary)\"};\\n        border-bottom: ${a?\"2px solid var(--primary-blue)\":\"none\"};\\n        margin-bottom: -1px;\\n      `,o.addEventListener(\"click\",(()=>{s.querySelectorAll(\"div\").forEach((e=>{e.style.fontWeight=\"normal\",e.style.color=\"var(--text-secondary)\",e.style.borderBottom=\"none\"})),o.style.fontWeight=\"bold\",o.style.color=\"var(--primary-blue)\",o.style.borderBottom=\"2px solid var(--primary-blue)\",n.querySelectorAll(\".tab-content\").forEach((e=>{e.style.display=\"none\"}));const e=n.querySelector(`.tab-content[data-tab-id=\"${t}\"]`);e&&(e.style.display=\"block\")})),o};s.appendChild(o(\"内置壁纸\",\"builtin\",!0)),s.appendChild(o(\"纯色壁纸\",\"solid\")),s.appendChild(o(\"自定义壁纸\",\"custom\")),s.appendChild(o(\"上传壁纸\",\"upload\")),n.appendChild(s);const r=document.createElement(\"div\");r.className=\"tab-content\",r.dataset.tabId=\"builtin\",r.style.cssText=\"\\n      display: block;\\n    \";const i=this.wallpaperManager.getBuiltInWallpapers().filter((e=>\"image\"===e.type)),l=document.createElement(\"div\");l.style.cssText=\"\\n      display: grid;\\n      grid-template-columns: repeat(2, 1fr);\\n      gap: 10px;\\n    \",i.forEach((t=>{const n=this.createWallpaperItem(t,e);l.appendChild(n)})),r.appendChild(l),n.appendChild(r);const c=document.createElement(\"div\");c.className=\"tab-content\",c.dataset.tabId=\"solid\",c.style.cssText=\"\\n      display: none;\\n    \";const d=this.wallpaperManager.getBuiltInWallpapers().filter((e=>\"color\"===e.type)),p=document.createElement(\"div\");p.style.cssText=\"\\n      display: grid;\\n      grid-template-columns: repeat(4, 1fr);\\n      gap: 10px;\\n    \",d.forEach((t=>{const n=this.createWallpaperItem(t,e);p.appendChild(n)}));const m=document.createElement(\"div\");m.style.cssText=`\\n      margin-top: 20px;\\n      padding-top: 15px;\\n      border-top: 1px solid ${document.body.classList.contains(\"dark-mode\")?\"#3c3c3c\":\"#eee\"};\\n    `;const g=document.createElement(\"p\");g.textContent=\"自定义颜色:\",g.style.cssText=\"\\n      margin: 0 0 10px 0;\\n      font-size: 0.9rem;\\n      color: var(--text-primary);\\n    \";const h=document.createElement(\"input\");h.type=\"color\",h.value=\"#ffffff\",h.style.cssText=\"\\n      width: 100%;\\n      height: 40px;\\n      border: none;\\n      border-radius: 5px;\\n      cursor: pointer;\\n    \";const u=document.createElement(\"input\");u.type=\"text\",u.placeholder=\"颜色名称 (可选)\",u.style.cssText=\"\\n      width: 100%;\\n      padding: 8px;\\n      margin-top: 10px;\\n      border: 1px solid #ddd;\\n      border-radius: 5px;\\n      box-sizing: border-box;\\n    \";const y=document.createElement(\"button\");y.textContent=\"添加此颜色\",y.style.cssText=\"\\n      width: 100%;\\n      padding: 10px;\\n      margin-top: 10px;\\n      background: var(--primary-blue);\\n      color: white;\\n      border: none;\\n      border-radius: 5px;\\n      cursor: pointer;\\n      font-weight: 500;\\n    \",y.addEventListener(\"click\",(()=>{const n=h.value,a=u.value.trim()||`颜色 ${n}`,s=this.wallpaperManager.createSolidColorWallpaper(n,a);s?(this.wallpaperManager.setWallpaper(e,s),this.applyWallpapers(),document.body.removeChild(t)):alert(\"创建纯色壁纸失败，请确保颜色格式正确。\")})),m.appendChild(g),m.appendChild(h),m.appendChild(u),m.appendChild(y),c.appendChild(p),c.appendChild(m),n.appendChild(c);const f=document.createElement(\"div\");f.className=\"tab-content\",f.dataset.tabId=\"custom\",f.style.cssText=\"\\n      display: none;\\n    \";const b=this.wallpaperManager.getCustomWallpapers();if(0===b.length){const e=document.createElement(\"p\");e.textContent='没有自定义壁纸。请在\"上传壁纸\"选项卡中添加。',e.style.cssText=\"\\n        text-align: center;\\n        color: var(--text-secondary);\\n        margin: 30px 0;\\n      \",f.appendChild(e)}else{const t=document.createElement(\"div\");t.style.cssText=\"\\n        display: grid;\\n        grid-template-columns: repeat(2, 1fr);\\n        gap: 10px;\\n      \",b.forEach((n=>{const a=this.createWallpaperItem(n,e,!0);t.appendChild(a)})),f.appendChild(t)}n.appendChild(f);const v=document.createElement(\"div\");v.className=\"tab-content\",v.dataset.tabId=\"upload\",v.style.cssText=\"\\n      display: none;\\n      padding: 10px 0;\\n    \";const x=document.createElement(\"div\");x.style.cssText=\"\\n      margin-bottom: 20px;\\n    \";const E=document.createElement(\"h3\");E.textContent=\"从本地上传\",E.style.cssText=\"\\n      font-size: 1rem;\\n      color: var(--text-primary);\\n      margin: 0 0 10px 0;\\n    \";const w=document.createElement(\"input\");w.type=\"file\",w.accept=\"image/*\",w.style.cssText=\"\\n      width: 100%;\\n      padding: 10px;\\n      margin-bottom: 10px;\\n      border: 1px solid #ddd;\\n      border-radius: 5px;\\n      box-sizing: border-box;\\n    \";const C=document.createElement(\"button\");C.textContent=\"上传并应用\",C.style.cssText=\"\\n      width: 100%;\\n      padding: 10px;\\n      background: var(--primary-blue);\\n      color: white;\\n      border: none;\\n      border-radius: 5px;\\n      cursor: pointer;\\n      font-weight: 500;\\n    \",C.addEventListener(\"click\",(async()=>{if(w.files&&w.files[0]){const n=w.files[0],a=await this.wallpaperManager.createWallpaperFromFile(n);a&&(this.wallpaperManager.setWallpaper(e,a),this.applyWallpapers(),document.body.removeChild(t))}})),x.appendChild(E),x.appendChild(w),x.appendChild(C),v.appendChild(x);const S=document.createElement(\"div\");S.style.cssText=`\\n      margin-top: 30px;\\n      padding-top: 20px;\\n      border-top: 1px solid ${document.body.classList.contains(\"dark-mode\")?\"#3c3c3c\":\"#eee\"};\\n    `;const k=document.createElement(\"h3\");k.textContent=\"从URL添加\",k.style.cssText=\"\\n      font-size: 1rem;\\n      color: var(--text-primary);\\n      margin: 0 0 10px 0;\\n    \";const T=document.createElement(\"input\");T.type=\"text\",T.placeholder=\"输入图片URL\",T.style.cssText=\"\\n      width: 100%;\\n      padding: 10px;\\n      margin-bottom: 10px;\\n      border: 1px solid #ddd;\\n      border-radius: 5px;\\n      box-sizing: border-box;\\n    \";const I=document.createElement(\"input\");I.type=\"text\",I.placeholder=\"壁纸名称 (可选)\",I.style.cssText=\"\\n      width: 100%;\\n      padding: 10px;\\n      margin-bottom: 10px;\\n      border: 1px solid #ddd;\\n      border-radius: 5px;\\n      box-sizing: border-box;\\n    \";const _=document.createElement(\"button\");_.textContent=\"添加并应用\",_.style.cssText=\"\\n      width: 100%;\\n      padding: 10px;\\n      background: var(--primary-blue);\\n      color: white;\\n      border: none;\\n      border-radius: 5px;\\n      cursor: pointer;\\n      font-weight: 500;\\n    \",_.addEventListener(\"click\",(async()=>{const n=T.value.trim(),a=I.value.trim()||\"URL壁纸\";if(n){const s=await this.wallpaperManager.createWallpaperFromUrl(n,a);s?(this.wallpaperManager.setWallpaper(e,s),this.applyWallpapers(),document.body.removeChild(t)):alert(\"无效的URL。请输入有效的图片URL。\")}})),S.appendChild(k),S.appendChild(T),S.appendChild(I),S.appendChild(_),v.appendChild(S),n.appendChild(v);const L=document.createElement(\"div\");L.style.cssText=`\\n      display: flex;\\n      justify-content: space-between;\\n      margin-top: 20px;\\n      padding-top: 15px;\\n      border-top: 1px solid ${document.body.classList.contains(\"dark-mode\")?\"#3c3c3c\":\"#eee\"};\\n    `;const M=document.createElement(\"button\");M.textContent=\"恢复默认\",M.style.cssText=`\\n      padding: 10px 15px;\\n      background: ${document.body.classList.contains(\"dark-mode\")?\"#3c3c3c\":\"#f1f5f9\"};\\n      color: var(--text-primary);\\n      border: none;\\n      border-radius: 5px;\\n      cursor: pointer;\\n      font-weight: 500;\\n    `,M.addEventListener(\"click\",(()=>{this.wallpaperManager.setWallpaper(e,null),this.applyWallpapers(),document.body.removeChild(t)}));const $=document.createElement(\"button\");$.textContent=\"关闭\",$.style.cssText=\"\\n      padding: 10px 20px;\\n      background: var(--primary-blue);\\n      color: white;\\n      border: none;\\n      border-radius: 5px;\\n      cursor: pointer;\\n      font-weight: 500;\\n    \",$.addEventListener(\"click\",(()=>{document.body.removeChild(t)})),L.appendChild(M),L.appendChild($),n.appendChild(L),t.appendChild(n),document.body.appendChild(t)}createWallpaperItem(e,t,n=!1){const a=document.createElement(\"div\");a.style.cssText=\"\\n      border-radius: 8px;\\n      overflow: hidden;\\n      position: relative;\\n      cursor: pointer;\\n      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);\\n      transition: transform 0.2s ease, box-shadow 0.2s ease;\\n    \";const s=document.createElement(\"div\");s.style.cssText=\"\\n      width: 100%;\\n      height: 100px;\\n      display: flex;\\n      align-items: center;\\n      justify-content: center;\\n    \",\"color\"===e.type?(s.style.backgroundImage=\"none\",s.style.backgroundColor=e.value):(s.style.backgroundImage=`url(\"${e.value}\")`,s.style.backgroundSize=\"cover\",s.style.backgroundPosition=\"center\");const o=document.createElement(\"div\");if(o.textContent=e.name,o.style.cssText=`\\n      padding: 8px;\\n      text-align: center;\\n      font-size: 0.8rem;\\n      color: var(--text-primary);\\n      background-color: ${document.body.classList.contains(\"dark-mode\")?\"rgba(42, 42, 42, 0.9)\":\"rgba(255, 255, 255, 0.9)\"};\\n    `,n){const n=document.createElement(\"button\");n.innerHTML=\"&times;\",n.style.cssText=\"\\n        position: absolute;\\n        top: 5px;\\n        right: 5px;\\n        width: 20px;\\n        height: 20px;\\n        border-radius: 50%;\\n        background-color: rgba(255, 0, 0, 0.7);\\n        color: white;\\n        border: none;\\n        font-size: 14px;\\n        line-height: 1;\\n        cursor: pointer;\\n        z-index: 1;\\n      \",n.addEventListener(\"click\",(n=>{if(n.stopPropagation(),confirm(\"确定要删除这个壁纸吗？\")){this.wallpaperManager.deleteCustomWallpaper(e.id);const n=this.wallpaperManager.getCurrentWallpaper(t);n&&n.id===e.id&&(this.wallpaperManager.setWallpaper(t,null),this.applyWallpapers()),a.parentElement?.removeChild(a)}})),a.appendChild(n)}return a.addEventListener(\"click\",(()=>{this.wallpaperManager.setWallpaper(t,e),this.applyWallpapers();const n=document.querySelector(\".wallpaper-modal\");n&&document.body.removeChild(n)})),a.appendChild(s),a.appendChild(o),a}renderChatHistory(){this.uiRenderer.clearChat(),this.blmxManager&&(this.blmxManager.logEntries.forEach(((e,t)=>{e.recalled?this.uiRenderer.renderRecallNotice(e,null,t):this.uiRenderer.renderEntry(e,t,!1)})),this.uiRenderer.refreshAllTimestamps())}renderMomentsFeed(){if(!this.blmxManager||!this.uiRenderer)return;const e=localStorage.getItem(`blmx_cover_photo_${this.config.currentCharId}`);e&&(document.getElementById(\"moments-cover-photo\").src=e),this.uiRenderer.renderMomentsFeed(this.blmxManager.logEntries,this.getDisplayName.bind(this),this.config.avatars)}stageAndDisplayEntry(e){if(\"type\"in e){if(\"event\"===e.type)return this.blmxManager.addEntry(e),this.uiRenderer.renderEntry(e,void 0,!0),void(\"sender\"in e&&\"me\"===e.sender&&this.eventHandler.setHasPendingNotifications(!0));if(\"time\"===e.type)return;e.id||(e.id=\"msg-\"+Date.now()+Math.random()),\"image\"===e.type&&\"content\"in e&&\"url\"===e.content.type&&\"string\"==typeof e.content.value&&e.content.value.startsWith(\"data:image\")&&(e.content.isNewForAI=!0),this.eventHandler.addToUserMessageQueue(e),this.uiRenderer.renderEntry(e,void 0,!0),this.updateFooterButtonsState()}}async triggerAiResponse(e=!1){if(this.isGenerating||!this.blmxManager)return;const n=this.eventHandler.getUserMessageQueue();if(!e&&0===n.length)return;this.isGenerating=!0;let a=this.blmxManager.getContextForAI();const s=[];n.forEach((e=>{const t=\"me\"===e.sender?\"USER\":\"CHAR\";if(\"image\"===e.type&&\"content\"in e&&e.content.isNewForAI)s.push(`${t}: [图片: ${e.content.value}]`);else{let n=e.content;switch(e.type){case\"sticker\":n=`[表情: ${e.content}]`;break;case\"voice\":n=`[语音: ${JSON.stringify(e.content)}]`;break;case\"image\":n=`[图片: ${JSON.stringify(e.content)}]`;break;case\"location\":n=`[位置: ${e.content}]`;break;case\"file\":n=`[文件: ${e.content}]`;break;case\"gift\":n=`[礼物: ${JSON.stringify(e.data)}]`;break;case\"transfer\":n=`[转账: ${JSON.stringify(e.data)}]`}s.push(`${t}: ${n}`)}})),s.length>0&&(a+=\"\\n\"+s.join(\"\\n\")),a+=\"\\n以上内容为过往聊天记录与最新用户输入(`<user_input>`)\\n【本次响应必须遵循线上规则】\",this.latestSentPrompt=a,n.forEach((e=>{\"image\"===e.type&&\"content\"in e&&e.content.isNewForAI&&(e.content.value=\"[用户发送的图片]\",delete e.content.isNewForAI)})),this.blmxManager.logEntries.push(...n),this.eventHandler.clearUserMessageQueue(),this.updateFooterButtonsState();let o=0,r=!1;for(;o<=2&&!r;){o>0&&(console.log(`[BLMX] AI response was empty. Retrying, attempt ${o+1}/3...`),await new Promise((e=>setTimeout(e,1e3*o))));try{this.uiRenderer.showTypingIndicator();const e=await t().generate({user_input:a,should_stream:!0});let n=\"\";for await(const t of e)n+=t;this.uiRenderer.hideTypingIndicator(),this.latestAiRawResponse=n.trim();let s=n.trim();const o=s.length;if(o>0&&o%2==0){const e=s.substring(0,o/2);e===s.substring(o/2)&&\"\"!==e.trim()&&(console.warn(\"[BLMX] Detected fully duplicated AI response, trimming automatically.\"),s=e)}const i=s.split(\"\\n\").filter((e=>\"\"!==e.trim()));if(i.length>0){const e=[];i.forEach((t=>{const n=t.indexOf(\":\");if(-1===n)return;const a=t.substring(0,n).trim(),s=t.substring(n+1).trim();if(a&&s)try{let t=null;switch(a){case\"CHAR_MOMENT\":case\"CHAR_COMMENT\":case\"CHAR_LIKE\":t={key:a,data:JSON.parse(s)},this.blmxManager.addEntry(t),t&&e.push(t);break;case\"RECALL\":{const t=JSON.parse(s),n=\"USER\"===t.sender?\"me\":\"them\",a=this.blmxManager.logEntries.slice().reverse().find((e=>\"sender\"in e&&e.sender===n&&\"content\"in e&&e.content===t.target_text));a&&e.push({type:\"recall_instruction\",content:{originalEntry:a,recallTimestamp:t.timestamp}});break}case\"CHAR\":{const e=\"msg-\"+Date.now()+Math.random(),n=s.match(/^\\[语音:\\s*({.*})\\]/),a=s.match(/^\\[表情:\\s*(.*)\\]/),o=s.match(/^\\[图片:\\s*(.*)\\]/),r=s.match(/^\\[位置:\\s*(.*)\\]/),i=s.match(/^\\[转账:\\s*(.*)\\]/),l=s.match(/^\\[文件:\\s*(.*)\\]/),c=s.match(/^\\[礼物:\\s*(.*)\\]/);if(n)try{t={id:e,type:\"voice\",sender:\"them\",content:JSON.parse(n[1])}}catch(e){console.error(\"Failed to parse voice data:\",n[1],e)}else if(a)t={id:e,type:\"sticker\",sender:\"them\",content:a[1]};else if(o)try{t={id:e,type:\"image\",sender:\"them\",content:JSON.parse(o[1])}}catch(n){t={id:e,type:\"image\",sender:\"them\",content:{type:\"desc\",value:o[1]}}}else t=r?{id:e,type:\"location\",sender:\"them\",content:r[1]}:i?{id:e,type:\"transfer\",sender:\"them\",content:i[1],data:JSON.parse(i[1])}:l?{id:e,type:\"file\",sender:\"them\",content:l[1]}:c?{id:e,type:\"gift\",sender:\"them\",content:c[1],data:JSON.parse(c[1])}:{id:e,type:\"message\",sender:\"them\",content:s};break}case\"TIME\":case\"EVENT_LOG\":t={type:\"TIME\"===a?\"time\":\"event\",content:JSON.parse(s)}}t&&(this.blmxManager.addEntry(t),\"type\"in t&&e.push(t))}catch(e){console.error(\"Failed to parse AI response:\",t,e)}})),e.length>0&&await this.displayAiEntriesSequentially(e),this.renderMomentsFeed(),r=!0}}catch(e){console.error(`[BLMX] Error on attempt ${o}:`,e),this.uiRenderer.hideTypingIndicator(),o>=2&&this.stageAndDisplayEntry({id:\"error\",type:\"message\",sender:\"them\",content:\"AI代理出错 (详情见F12控制台)\"})}o++}!r&&o>2&&(console.error(\"[BLMX] AI generation failed after 3 attempts (empty response).\"),this.stageAndDisplayEntry({id:\"error\",type:\"message\",sender:\"them\",content:\"(AI响应为空，请稍后再试或手动触发)\"}),this.latestAiRawResponse=\"[AI响应为空]\"),await this.blmxManager.persistLogToStorage(),this.uiRenderer.refreshAllTimestamps(),this.isGenerating=!1}async displayAiEntriesSequentially(e){const t=[\"message\",\"sticker\",\"voice\",\"image\",\"location\",\"transfer\",\"file\",\"gift\"];for(const n of e){if(\"type\"in n&&t.includes(n.type)){this.uiRenderer.showTypingIndicator();const e=\"message\"===n.type?n.content:\"voice\"===n.type?n.content.text:\"\",t=this.uiRenderer.calculateTypingDelay(e);await new Promise((e=>setTimeout(e,t))),this.uiRenderer.hideTypingIndicator(),this.uiRenderer.renderEntry(n,void 0,!0)}else if(\"type\"in n&&\"recall_instruction\"===n.type){const{originalEntry:e,recallTimestamp:t}=n.content,a=this.blmxManager.logEntries.find((t=>\"id\"in t&&t.id===e.id));if(a){a.recalled=!0,a.recalled_content=e.content,a.recalled_timestamp=t;const n=document.querySelector(`[data-message-id=\"${e.id}\"]`);n&&(await new Promise((e=>setTimeout(e,500))),this.uiRenderer.renderRecallNotice(a,n))}}else this.uiRenderer.renderEntry(n,void 0,!0);await new Promise((e=>setTimeout(e,800)))}this.uiRenderer.refreshAllTimestamps()}updateFooterButtonsState(){const e=document.getElementById(\"wechat-input-field\"),t=document.getElementById(\"send-btn\"),n=document.getElementById(\"plus-btn\"),a=\"\"!==e.value.trim(),s=this.eventHandler.getUserMessageQueue().length>0,o=this.eventHandler.hasNotifications;t.style.display=a||s||o?\"flex\":\"none\",n.style.display=a?\"none\":\"inline-block\"}togglePanel(e){const t=document.getElementById(\"panel-container\"),n=document.querySelector(\".panel-view.active\"),a=t.classList.contains(\"active\");a&&n&&n.id.startsWith(e||\"\")?(t.classList.remove(\"active\"),n.classList.remove(\"active\")):e?(n&&n.classList.remove(\"active\"),document.getElementById(`${e}-panel`).classList.add(\"active\"),a||t.classList.add(\"active\")):(a&&t.classList.remove(\"active\"),n&&n.classList.remove(\"active\"))}navigateTo(e){const t={home:document.getElementById(\"app-homescreen\"),wechat:document.getElementById(\"wechat-view\"),moments:document.getElementById(\"moments-view\"),settings:document.getElementById(\"settings-view\")};Object.values(t).forEach((e=>e?.classList.remove(\"active\")));const n=t[e];if(n&&(n.classList.add(\"active\"),\"moments\"===e)){const e=localStorage.getItem(`blmx_cover_photo_${this.config.currentCharId}`);e&&(document.getElementById(\"moments-cover-photo\").src=e);const t=localStorage.getItem(`blmx_signature_${this.config.currentCharId}`)||\"\";document.getElementById(\"user-signature-display\").textContent=t}}updateAvatar(e){const t=this.config.avatars[e]||\"\",n=prompt(`请输入新的${this.getDisplayName(e)}头像URL:`,t);if(n){this.config.avatars[e]=n;const t=\"user\"===e?`blmx_user_avatar_${this.config.currentCharId}`:`blmx_char_avatar_${this.config.currentCharId}`;localStorage.setItem(t,n),alert(\"头像已更新！\"),this.renderChatHistory(),this.renderMomentsFeed(),\"user\"===e&&(document.getElementById(\"moments-user-avatar\").src=n)}}updateCharRemark(){const e=this.getDisplayName(\"char\"),t=prompt(\"请输入新的备注:\",this.config.charRemark);if(null!==t){this.config.charRemark=t,localStorage.setItem(`blmx_remark_${this.config.currentCharId}`,t);const n=this.getDisplayName(\"char\");document.getElementById(\"contact-name-header\").textContent=n,document.getElementById(\"wechat-input-field\").placeholder=localStorage.getItem(`blmx_input_placeholder_${this.config.currentCharId}`)||`与 ${n} 对话...`,document.querySelectorAll(\"#moments-feed-list .post-author-name\").forEach((t=>{t.textContent===e&&(t.textContent=n)})),document.querySelectorAll(\".recall-notice-text\").forEach((t=>{t.textContent?.includes(`\"${e}\"`)&&(t.textContent=`\"${n}\" 撤回了一条消息`)})),alert(\"备注已更新！\")}}updateUserName(){const e=this.getDisplayName(\"user\"),t=prompt(\"请输入你的新名字:\",e);t&&\"\"!==t.trim()&&t!==e&&(localStorage.setItem(`blmx_user_name_${this.config.currentCharId}`,t),this.config.names.user=t,document.getElementById(\"moments-user-name\").textContent=t,alert(\"名字已更新！\"))}updateSignature(){const e=localStorage.getItem(`blmx_signature_${this.config.currentCharId}`)||\"\",t=prompt(\"请输入你的个性签名:\",e);null!==t&&(localStorage.setItem(`blmx_signature_${this.config.currentCharId}`,t),document.getElementById(\"user-signature-display\").textContent=t)}updateCoverPhoto(){const e=localStorage.getItem(`blmx_cover_photo_${this.config.currentCharId}`)||\"\",t=prompt(\"请输入新的朋友圈封面URL:\",e);t&&(localStorage.setItem(`blmx_cover_photo_${this.config.currentCharId}`,t),document.getElementById(\"moments-cover-photo\").src=t)}handleTransferAccept(e){this.stageAndDisplayEntry({type:\"transfer\",sender:\"me\",content:JSON.stringify(e),data:e,id:`transfer-${Date.now()}`})}handleGiftAction(e,t){const n={name:e.name,status:t};this.stageAndDisplayEntry({type:\"gift\",sender:\"me\",content:JSON.stringify(n),data:n,id:`gift-${Date.now()}`}),this.eventHandler.setHasPendingNotifications(!0)}getLatestAiRawResponse(){return this.latestAiRawResponse}getLatestSentPrompt(){return this.latestSentPrompt}setupThemeSelector(){const e=document.querySelector(\".theme-options\");if(!e)return;e.innerHTML=\"\";const t=this.themeManager.getThemes();Object.values(t).forEach((t=>{const n=document.createElement(\"div\");n.className=\"theme-option\",n.style.cssText=`\\n        width: calc(50% - 0.5rem);\\n        aspect-ratio: 1/1;\\n        border-radius: 8px;\\n        background-color: ${t.colors.primary};\\n        display: flex;\\n        flex-direction: column;\\n        align-items: center;\\n        justify-content: center;\\n        cursor: pointer;\\n        position: relative;\\n        overflow: hidden;\\n        box-shadow: 0 2px 8px rgba(0,0,0,0.1);\\n      `;const a=document.createElement(\"div\");a.style.cssText=`\\n        position: absolute;\\n        top: 0;\\n        left: 0;\\n        width: 100%;\\n        height: 100%;\\n        background: linear-gradient(135deg, ${t.colors.gradientStart}, ${t.colors.gradientEnd});\\n      `;const s=document.createElement(\"div\");s.style.cssText=\"\\n        position: relative;\\n        width: 70%;\\n        height: 60%;\\n        display: flex;\\n        flex-direction: column;\\n        justify-content: space-between;\\n        z-index: 1;\\n      \";const o=document.createElement(\"div\");o.style.cssText=`\\n        align-self: flex-start;\\n        width: 60%;\\n        height: 40%;\\n        background-color: ${t.colors.bubbleThemBg};\\n        border-radius: 8px;\\n      `;const r=document.createElement(\"div\");r.style.cssText=`\\n        align-self: flex-end;\\n        width: 60%;\\n        height: 40%;\\n        background-color: ${t.colors.bubbleMeBg};\\n        border-radius: 8px;\\n      `,s.appendChild(o),s.appendChild(r);const i=document.createElement(\"div\");i.textContent=t.displayName,i.style.cssText=\"\\n        position: relative;\\n        color: white;\\n        font-size: 0.8rem;\\n        font-weight: 500;\\n        margin-top: 5px;\\n        text-shadow: 0 1px 2px rgba(0,0,0,0.3);\\n        z-index: 1;\\n      \",n.appendChild(a),n.appendChild(s),n.appendChild(i),n.addEventListener(\"click\",(()=>{this.themeManager.switchTheme(t.name),this.applyWallpapers()})),e.appendChild(n)}));const n=document.getElementById(\"custom-theme-btn\");n&&n.addEventListener(\"click\",(()=>{this.openThemeEditor()}));const a=document.getElementById(\"close-theme-editor\");a&&a.addEventListener(\"click\",(()=>{this.closeThemeEditor()}));const s=document.getElementById(\"save-theme-btn\");s&&s.addEventListener(\"click\",(()=>{this.saveCustomTheme()}));const o=document.getElementById(\"reset-theme-btn\");o&&o.addEventListener(\"click\",(()=>{this.resetThemeEditor()}))}openThemeEditor(){const e=document.getElementById(\"theme-editor-modal\");if(!e)return;const t=this.themeManager.getCurrentTheme();this.fillThemeEditor(t),e.style.display=\"block\"}closeThemeEditor(){const e=document.getElementById(\"theme-editor-modal\");e&&(e.style.display=\"none\")}fillThemeEditor(e){const t=document.getElementById(\"theme-name-input\"),n=document.getElementById(\"phone-frame-color\"),a=document.getElementById(\"primary-color\"),s=document.getElementById(\"light-color\"),o=document.getElementById(\"ultra-light-color\"),r=document.getElementById(\"deep-color\"),i=document.getElementById(\"text-primary-color\"),l=document.getElementById(\"text-secondary-color\"),c=document.getElementById(\"bubble-me-color\"),d=document.getElementById(\"bubble-them-color\"),p=document.getElementById(\"dark-mode-toggle\");t&&(t.value=\"custom\"===e.name?\"我的自定义主题\":`自定义 ${e.displayName}`),n&&(n.value=e.colors.phoneFrame),a&&(a.value=e.colors.primary),s&&(s.value=e.colors.light),o&&(o.value=e.colors.ultraLight),r&&(r.value=e.colors.deep),i&&(i.value=e.colors.textPrimary),l&&(l.value=e.colors.textSecondary),c&&(c.value=e.colors.bubbleMeBg),d&&(d.value=e.colors.bubbleThemBg),p&&(p.checked=e.colors.isDarkMode)}resetThemeEditor(){const e=this.themeManager.getThemes().blue;this.fillThemeEditor(e)}saveCustomTheme(){const e=document.getElementById(\"theme-name-input\"),t=document.getElementById(\"phone-frame-color\"),n=document.getElementById(\"primary-color\"),a=document.getElementById(\"light-color\"),s=document.getElementById(\"ultra-light-color\"),o=document.getElementById(\"deep-color\"),r=document.getElementById(\"text-primary-color\"),i=document.getElementById(\"text-secondary-color\"),l=document.getElementById(\"bubble-me-color\"),c=document.getElementById(\"bubble-them-color\"),d=document.getElementById(\"dark-mode-toggle\"),p=n?.value||\"#72adf3\",m=a?.value||\"#a8cbeb\",g=s?.value||\"#e8f4fd\",h=o?.value||\"#2c5282\",u=t?.value||\"#b4d0fa\",y=d?.checked||!1,f=y?\"#000000\":p,b=parseInt(f.slice(1,3),16),v=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),E=y?\"rgba(0, 0, 0, 0.5)\":`rgba(${b}, ${v}, ${x}, 0.3)`,w=`0 2px 8px rgba(${b}, ${v}, ${x}, 0.15)`,C={name:\"custom\",displayName:e?.value||\"自定义主题\",colors:{phoneFrame:u,phoneFrameGradient:[this.lightenDarkenColor(u,-40),u,this.lightenDarkenColor(u,20),this.lightenDarkenColor(u,-40)],primary:p,light:m,ultraLight:g,soft:this.lightenDarkenColor(p,20),deep:h,gradientStart:this.lightenDarkenColor(p,20),gradientEnd:this.lightenDarkenColor(p,-10),textColor:\"#ffffff\",textPrimary:r?.value||\"rgb(139, 162, 186)\",textSecondary:i?.value||\"#64748b\",borderColor:y?\"#3c3c3c\":this.lightenDarkenColor(g,-20),bubbleShadow:w,bubbleThemBg:y?\"#3c3c3c\":c?.value||\"#ffffff\",bubbleMeBg:l?.value||\"#a8cbeb\",headerBg:y?\"linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%)\":`linear-gradient(135deg, ${this.lightenDarkenColor(g,10)} 0%, ${g} 100%)`,statusBarColor:y?\"#888888\":p,dynamicIslandColor:y?\"#3c3c3c\":this.lightenDarkenColor(p,20),appBgColor:y?\"#1a1a1a\":\"#ffffff\",settingsBgColor:y?\"#1a1a1a\":this.lightenDarkenColor(g,-5),settingsCardBgColor:y?\"#2c2c2c\":\"#ffffff\",shadowColor:f,shadowColorRgba:E,isDarkMode:y,defaultWallpapers:{chat:y?\"https://files.catbox.moe/pdaqj2.jpg\":g,home:y?\"https://files.catbox.moe/pdaqj2.jpg\":\"https://files.catbox.moe/5brt1b.jpeg\",settings:y?\"#1a1a1a\":this.lightenDarkenColor(g,-5)}}};this.themeManager.saveCustomTheme(C),this.closeThemeEditor()}lightenDarkenColor(e,t){let n=!1;\"#\"===e[0]&&(e=e.slice(1),n=!0);const a=parseInt(e,16);let s=(a>>16)+t,o=(a>>8&255)+t,r=(255&a)+t;return s=Math.min(255,Math.max(0,s)),o=Math.min(255,Math.max(0,o)),r=Math.min(255,Math.max(0,r)),(n?\"#\":\"\")+(s<<16|o<<8|r).toString(16).padStart(6,\"0\")}hexToRgba(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}setupPhoneSizeAdjustment(){const e=document.getElementById(\"phone-size-default\"),t=document.getElementById(\"phone-size-medium\"),n=document.getElementById(\"phone-size-small\"),a=document.querySelector(\".phone-screen\");if(!(e&&t&&n&&a))return void console.error(\"[BLMX] Phone size adjustment elements not found\");const s=localStorage.getItem(l)||\"default\",o=\"medium\"===s?\"medium\":\"small\"===s?\"small\":\"default\";this.applyPhoneSize(o,a,[e,t,n]),e.addEventListener(\"click\",(()=>{this.applyPhoneSize(\"default\",a,[e,t,n])})),t.addEventListener(\"click\",(()=>{this.applyPhoneSize(\"medium\",a,[e,t,n])})),n.addEventListener(\"click\",(()=>{this.applyPhoneSize(\"small\",a,[e,t,n])}))}setupStickerSizeControl(){const e=document.getElementById(\"sticker-size-slider\"),t=document.getElementById(\"sticker-size-input\"),n=document.getElementById(\"sticker-size-small\"),a=document.getElementById(\"sticker-size-medium\");if(!(e&&t&&n&&a))return void console.error(\"[BLMX] Sticker size control elements not found\");const s=localStorage.getItem(c)||\"120\";e.value=s,t.value=s,\"80\"===s?(n.classList.add(\"phone-size-active\"),a.classList.remove(\"phone-size-active\")):\"120\"===s?(n.classList.remove(\"phone-size-active\"),a.classList.add(\"phone-size-active\")):(n.classList.remove(\"phone-size-active\"),a.classList.remove(\"phone-size-active\")),this.applyStickerSize(parseInt(s)),e.addEventListener(\"input\",(()=>{const s=e.value;t.value=s,localStorage.setItem(c,s),this.applyStickerSize(parseInt(s)),\"80\"===s?(n.classList.add(\"phone-size-active\"),a.classList.remove(\"phone-size-active\")):\"120\"===s?(n.classList.remove(\"phone-size-active\"),a.classList.add(\"phone-size-active\")):(n.classList.remove(\"phone-size-active\"),a.classList.remove(\"phone-size-active\"))})),t.addEventListener(\"change\",(()=>{let s=parseInt(t.value);s<40&&(s=40),s>200&&(s=200);const o=s.toString();t.value=o,e.value=o,localStorage.setItem(c,o),this.applyStickerSize(s),\"80\"===o?(n.classList.add(\"phone-size-active\"),a.classList.remove(\"phone-size-active\")):\"120\"===o?(n.classList.remove(\"phone-size-active\"),a.classList.add(\"phone-size-active\")):(n.classList.remove(\"phone-size-active\"),a.classList.remove(\"phone-size-active\"))})),n.addEventListener(\"click\",(()=>{e.value=\"80\",t.value=\"80\",localStorage.setItem(c,\"80\"),this.applyStickerSize(80),n.classList.add(\"phone-size-active\"),a.classList.remove(\"phone-size-active\")})),a.addEventListener(\"click\",(()=>{e.value=\"120\",t.value=\"120\",localStorage.setItem(c,\"120\"),this.applyStickerSize(120),n.classList.remove(\"phone-size-active\"),a.classList.add(\"phone-size-active\")}))}applyPhoneSize(e,t,n){t.style.height=d[e],localStorage.setItem(l,e),n.forEach((e=>e.classList.remove(\"phone-size-active\"))),\"default\"===e?n[0].classList.add(\"phone-size-active\"):\"medium\"===e?n[1].classList.add(\"phone-size-active\"):\"small\"===e&&n[2].classList.add(\"phone-size-active\")}applyStickerSize(e){document.documentElement.style.setProperty(\"--sticker-size\",`${e}px`)}}document.addEventListener(\"DOMContentLoaded\",(async()=>{try{console.log(\"[BLMX] 初始化微信模拟器...\");const e=new p;await e.initialize(),window.blmxApp=e,console.log(\"[BLMX] 微信模拟器初始化完成！\")}catch(e){console.error(\"[BLMX] 初始化失败:\",e),alert(\"初始化失败，请查看控制台获取详细信息。\")}}));</script></body></html>\n```",
    "trimStrings": [],
    "placement": [
        2
    ],
    "disabled": false,
    "markdownOnly": true,
    "promptOnly": false,
    "runOnEdit": true,
    "substituteRegex": 0,
    "minDepth": null,
    "maxDepth": null
}